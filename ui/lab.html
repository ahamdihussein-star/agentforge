<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentForge Lab - Test Data Generator</title>
    <link rel="icon" type="image/png" href="/AgentForge_Logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent-purple: #8b5cf6;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --border-color: #2d2d3a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* Gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-blue) 100%);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: var(--accent-purple);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.1);
        }
        
        /* Generator Cards */
        .generator-card {
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .generator-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .generator-card:hover::before {
            opacity: 1;
        }
        
        .generator-card.api::before {
            background: linear-gradient(90deg, #10b981, #3b82f6);
        }
        
        .generator-card.document::before {
            background: linear-gradient(90deg, #f59e0b, #ef4444);
        }
        
        .generator-card.image::before {
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
        }
        
        .generator-card.active {
            border-color: var(--accent-purple);
            background: rgba(139, 92, 246, 0.1);
        }
        
        /* Input fields */
        .input-field {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }
        
        .input-field::placeholder {
            color: var(--text-secondary);
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-blue) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            border-color: var(--accent-purple);
            background: rgba(139, 92, 246, 0.1);
        }
        
        /* Tabs */
        .tab-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .tab-btn.active {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }
        
        .tab-btn:not(.active):hover {
            background: var(--bg-secondary);
        }
        
        /* History items */
        .history-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            border-color: var(--accent-purple);
            transform: translateX(4px);
        }
        
        /* Loading spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-purple);
        }
        
        /* Format badges */
        .format-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .format-badge:hover {
            transform: scale(1.05);
        }
        
        .format-badge.selected {
            border-color: white;
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            border-color: var(--accent-green);
        }
        
        .toast.error {
            border-color: #ef4444;
        }
        
        /* Preview area */
        .preview-area {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .preview-area.has-content {
            border-style: solid;
            border-color: var(--accent-purple);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .generator-cards {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="border-b border-gray-800 bg-opacity-90 backdrop-blur-lg sticky top-0 z-50" style="background: var(--bg-primary);">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/ui/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                    <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-10 h-10 rounded-xl">
                    <div>
                        <h1 class="text-xl font-bold gradient-text">AgentForge Lab</h1>
                        <p class="text-xs text-gray-500">Test Data Generator</p>
                    </div>
                </a>
            </div>
            
            <div class="flex items-center gap-4">
                <a href="/ui/" class="btn-secondary text-sm">
                    ‚Üê Back to Admin
                </a>
                <div id="user-info" class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center font-bold" id="user-avatar">?</div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Hero Section -->
        <div class="text-center mb-12">
            <h2 class="text-4xl font-bold mb-4">Create Realistic Test Data</h2>
            <p class="text-gray-400 text-lg max-w-2xl mx-auto">
                Generate professional APIs, documents, and images for testing your agents. 
                Powered by AI to create realistic, production-quality data.
            </p>
        </div>
        
        <!-- Generator Type Selection -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12 generator-cards">
            <!-- API Generator -->
            <div class="card generator-card api p-6" onclick="selectGenerator('api')">
                <div class="text-4xl mb-4">üîå</div>
                <h3 class="text-xl font-bold mb-2">API Generator</h3>
                <p class="text-gray-400 text-sm mb-4">
                    Create mock APIs that return realistic data. Perfect for testing integrations.
                </p>
                <div class="flex flex-wrap gap-2">
                    <span class="px-2 py-1 rounded-full text-xs bg-green-500/20 text-green-400">REST</span>
                    <span class="px-2 py-1 rounded-full text-xs bg-blue-500/20 text-blue-400">JSON</span>
                    <span class="px-2 py-1 rounded-full text-xs bg-purple-500/20 text-purple-400">AI-Powered</span>
                </div>
            </div>
            
            <!-- Document Generator -->
            <div class="card generator-card document p-6" onclick="selectGenerator('document')">
                <div class="text-4xl mb-4">üìÑ</div>
                <h3 class="text-xl font-bold mb-2">Document Generator</h3>
                <p class="text-gray-400 text-sm mb-4">
                    Generate professional documents with proper formatting and structure.
                </p>
                <div class="flex flex-wrap gap-2">
                    <span class="px-2 py-1 rounded-full text-xs bg-blue-500/20 text-blue-400">Word</span>
                    <span class="px-2 py-1 rounded-full text-xs bg-red-500/20 text-red-400">PDF</span>
                    <span class="px-2 py-1 rounded-full text-xs bg-green-500/20 text-green-400">Excel</span>
                    <span class="px-2 py-1 rounded-full text-xs bg-orange-500/20 text-orange-400">PPT</span>
                </div>
            </div>
            
            <!-- Image Generator -->
            <div class="card generator-card image p-6" onclick="selectGenerator('image')">
                <div class="text-4xl mb-4">üñºÔ∏è</div>
                <h3 class="text-xl font-bold mb-2">Image Generator</h3>
                <p class="text-gray-400 text-sm mb-4">
                    Create document images for OCR testing. Forms, receipts, IDs, and more.
                </p>
                <div class="flex flex-wrap gap-2">
                    <span class="px-2 py-1 rounded-full text-xs bg-purple-500/20 text-purple-400">OCR Ready</span>
                    <span class="px-2 py-1 rounded-full text-xs bg-pink-500/20 text-pink-400">Forms</span>
                    <span class="px-2 py-1 rounded-full text-xs bg-yellow-500/20 text-yellow-400">Invoices</span>
                </div>
            </div>
        </div>
        
        <!-- Generator Panels -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left: Input Panel -->
            <div class="lg:col-span-2">
                <!-- API Generator Panel -->
                <div id="panel-api" class="card p-6 hidden">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-blue-500 flex items-center justify-center text-2xl">üîå</div>
                        <div>
                            <h3 class="text-xl font-bold">Create API</h3>
                            <p class="text-sm text-gray-400">Describe the data you need</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- API Name -->
                        <div>
                            <label class="block text-sm font-medium mb-2">API Name</label>
                            <input type="text" id="api-name" class="input-field w-full px-4 py-3 rounded-xl" placeholder="e.g., Customer Data API">
                        </div>
                        
                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-medium mb-2">What data should this API return?</label>
                            <textarea id="api-description" class="input-field w-full px-4 py-3 rounded-xl h-32 resize-none" placeholder="Describe the data you need. For example:

Return a list of customers with:
- Full name
- Email address
- Phone number
- Company name
- Registration date"></textarea>
                        </div>
                        
                        <!-- Number of Records -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Number of Records</label>
                            <div class="flex items-center gap-4">
                                <input type="range" id="api-records" min="1" max="100" value="10" class="flex-1 accent-purple-500" oninput="updateRecordsLabel(this.value)">
                                <span id="api-records-label" class="text-lg font-bold text-purple-400 w-12 text-center">10</span>
                            </div>
                        </div>
                        
                        <!-- Generate Button -->
                        <button onclick="generateAPI()" class="btn-primary w-full flex items-center justify-center gap-2">
                            <span>‚ú®</span>
                            <span>Generate API</span>
                        </button>
                    </div>
                </div>
                
                <!-- Document Generator Panel -->
                <div id="panel-document" class="card p-6 hidden">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-2xl">üìÑ</div>
                        <div>
                            <h3 class="text-xl font-bold">Create Document</h3>
                            <p class="text-sm text-gray-400">Generate professional documents</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Document Name -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Document Name</label>
                            <input type="text" id="doc-name" class="input-field w-full px-4 py-3 rounded-xl" placeholder="e.g., Quarterly Report">
                        </div>
                        
                        <!-- Format Selection -->
                        <div>
                            <label class="block text-sm font-medium mb-3">Format</label>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="selectDocFormat('docx')" class="format-badge bg-blue-500/20 text-blue-400 selected" data-format="docx">
                                    üìù Word (.docx)
                                </button>
                                <button onclick="selectDocFormat('pdf')" class="format-badge bg-red-500/20 text-red-400" data-format="pdf">
                                    üìï PDF
                                </button>
                                <button onclick="selectDocFormat('xlsx')" class="format-badge bg-green-500/20 text-green-400" data-format="xlsx">
                                    üìä Excel (.xlsx)
                                </button>
                                <button onclick="selectDocFormat('pptx')" class="format-badge bg-orange-500/20 text-orange-400" data-format="pptx">
                                    üìΩÔ∏è PowerPoint (.pptx)
                                </button>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Document Content</label>
                            <textarea id="doc-description" class="input-field w-full px-4 py-3 rounded-xl h-32 resize-none" placeholder="Describe the document you need. For example:

Create a professional quarterly sales report for Q4 2024:
- Executive summary
- Sales by region (table)
- Top performing products
- Growth trends with charts
- Recommendations"></textarea>
                        </div>
                        
                        <!-- Generate Button -->
                        <button onclick="generateDocument()" class="btn-primary w-full flex items-center justify-center gap-2">
                            <span>‚ú®</span>
                            <span>Generate Document</span>
                        </button>
                    </div>
                </div>
                
                <!-- Image Generator Panel -->
                <div id="panel-image" class="card p-6 hidden">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-2xl">üñºÔ∏è</div>
                        <div>
                            <h3 class="text-xl font-bold">Create Image</h3>
                            <p class="text-sm text-gray-400">Generate document images for OCR</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Image Name -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Image Name</label>
                            <input type="text" id="img-name" class="input-field w-full px-4 py-3 rounded-xl" placeholder="e.g., Invoice Sample">
                        </div>
                        
                        <!-- Image Type -->
                        <div>
                            <label class="block text-sm font-medium mb-3">Document Type</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <button onclick="selectImageType('invoice')" class="format-badge bg-blue-500/20 text-blue-400 text-center py-3 selected" data-type="invoice">
                                    üßæ Invoice
                                </button>
                                <button onclick="selectImageType('receipt')" class="format-badge bg-green-500/20 text-green-400 text-center py-3" data-type="receipt">
                                    üßæ Receipt
                                </button>
                                <button onclick="selectImageType('form')" class="format-badge bg-purple-500/20 text-purple-400 text-center py-3" data-type="form">
                                    üìã Form
                                </button>
                                <button onclick="selectImageType('id')" class="format-badge bg-orange-500/20 text-orange-400 text-center py-3" data-type="id">
                                    ü™™ ID Card
                                </button>
                                <button onclick="selectImageType('contract')" class="format-badge bg-red-500/20 text-red-400 text-center py-3" data-type="contract">
                                    üìú Contract
                                </button>
                                <button onclick="selectImageType('letter')" class="format-badge bg-cyan-500/20 text-cyan-400 text-center py-3" data-type="letter">
                                    ‚úâÔ∏è Letter
                                </button>
                                <button onclick="selectImageType('table')" class="format-badge bg-pink-500/20 text-pink-400 text-center py-3" data-type="table">
                                    üìä Table
                                </button>
                                <button onclick="selectImageType('custom')" class="format-badge bg-gray-500/20 text-gray-400 text-center py-3" data-type="custom">
                                    ‚öôÔ∏è Custom
                                </button>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Image Details</label>
                            <textarea id="img-description" class="input-field w-full px-4 py-3 rounded-xl h-32 resize-none" placeholder="Describe the document image you need. For example:

Create an invoice image with:
- Company logo at top
- Invoice number and date
- Customer billing information
- List of items with prices
- Total amount
- Payment terms"></textarea>
                        </div>
                        
                        <!-- Format -->
                        <div>
                            <label class="block text-sm font-medium mb-3">Output Format</label>
                            <div class="flex gap-3">
                                <button onclick="selectImgFormat('png')" class="format-badge bg-purple-500/20 text-purple-400 selected" data-imgformat="png">
                                    PNG
                                </button>
                                <button onclick="selectImgFormat('jpg')" class="format-badge bg-blue-500/20 text-blue-400" data-imgformat="jpg">
                                    JPG
                                </button>
                            </div>
                        </div>
                        
                        <!-- Generate Button -->
                        <button onclick="generateImage()" class="btn-primary w-full flex items-center justify-center gap-2">
                            <span>‚ú®</span>
                            <span>Generate Image</span>
                        </button>
                    </div>
                </div>
                
                <!-- Preview Area -->
                <div id="preview-section" class="mt-8 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">Preview</h3>
                        <button onclick="downloadResult()" class="btn-secondary text-sm flex items-center gap-2">
                            <span>‚¨áÔ∏è</span>
                            <span>Download</span>
                        </button>
                    </div>
                    <div id="preview-area" class="preview-area">
                        <div class="text-center text-gray-500">
                            <div class="text-4xl mb-2">‚ú®</div>
                            <p>Your generated content will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right: History Panel -->
            <div class="lg:col-span-1">
                <div class="card p-6 sticky top-24">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold">Recent Creations</h3>
                        <button onclick="clearHistory()" class="text-sm text-gray-400 hover:text-red-400 transition-colors">
                            Clear
                        </button>
                    </div>
                    
                    <div id="history-list" class="space-y-3 max-h-[60vh] overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-3xl mb-2">üì≠</div>
                            <p class="text-sm">No items yet</p>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="mt-6 pt-6 border-t border-gray-700">
                        <h4 class="text-sm font-medium text-gray-400 mb-3">Quick Actions</h4>
                        <div class="space-y-2">
                            <button onclick="openToolsLibrary()" class="w-full btn-secondary text-sm text-left flex items-center gap-2">
                                <span>üîß</span>
                                <span>View in Tools Library</span>
                            </button>
                            <button onclick="exportAll()" class="w-full btn-secondary text-sm text-left flex items-center gap-2">
                                <span>üì¶</span>
                                <span>Export All</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="spinner mx-auto mb-4" style="width: 48px; height: 48px; border-width: 4px;"></div>
            <p class="text-lg font-medium" id="loading-text">Generating...</p>
            <p class="text-sm text-gray-400 mt-2" id="loading-subtext">This may take a moment</p>
        </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="toast">
        <div class="flex items-center gap-3">
            <span id="toast-icon">‚úÖ</span>
            <span id="toast-message">Success!</span>
        </div>
    </div>
    
    <script>
        // State
        let currentGenerator = null;
        let selectedDocFormat = 'docx';
        let selectedImageType = 'invoice';
        let selectedImgFormat = 'png';
        let generatedResult = null;
        let history = [];
        
        // Get token from localStorage or sessionStorage (same as admin portal)
        let authToken = localStorage.getItem('agentforge_token') || sessionStorage.getItem('agentforge_token');
        let currentUser = null;
        try {
            currentUser = JSON.parse(localStorage.getItem('agentforge_user') || sessionStorage.getItem('agentforge_user') || 'null');
        } catch(e) {
            currentUser = null;
        }
        
        // Initialize (history from API, no localStorage)
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadHistory(); // async: fetches from API
            
            // Select API generator by default
            selectGenerator('api');
        });
        
        // Auth
        function checkAuth() {
            // Re-check tokens in case they were set after initial load
            authToken = localStorage.getItem('agentforge_token') || sessionStorage.getItem('agentforge_token');
            
            if (!authToken) {
                // Not logged in - redirect to admin portal to login
                window.location.href = '/ui/';
                return;
            }
            
            // Try to get user info
            if (!currentUser) {
                try {
                    currentUser = JSON.parse(localStorage.getItem('agentforge_user') || sessionStorage.getItem('agentforge_user') || 'null');
                } catch(e) {}
            }
            
            if (currentUser) {
                const initials = (currentUser.name || currentUser.email || '?').substring(0, 2).toUpperCase();
                document.getElementById('user-avatar').textContent = initials;
            }
        }
        
        function getAuthHeaders() {
            return authToken ? { 'Authorization': 'Bearer ' + authToken } : {};
        }
        
        // Generator Selection
        function selectGenerator(type) {
            currentGenerator = type;
            
            // Update cards
            document.querySelectorAll('.generator-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`.generator-card.${type}`).classList.add('active');
            
            // Show panel
            document.querySelectorAll('[id^="panel-"]').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.getElementById(`panel-${type}`).classList.remove('hidden');
            
            // Hide preview
            document.getElementById('preview-section').classList.add('hidden');
        }
        
        // Format Selection
        function selectDocFormat(format) {
            selectedDocFormat = format;
            document.querySelectorAll('[data-format]').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-format="${format}"]`).classList.add('selected');
        }
        
        function selectImageType(type) {
            selectedImageType = type;
            document.querySelectorAll('[data-type]').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
        }
        
        function selectImgFormat(format) {
            selectedImgFormat = format;
            document.querySelectorAll('[data-imgformat]').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-imgformat="${format}"]`).classList.add('selected');
        }
        
        function updateRecordsLabel(value) {
            document.getElementById('api-records-label').textContent = value;
        }
        
        // Generators
        async function generateAPI() {
            const name = document.getElementById('api-name').value.trim();
            const description = document.getElementById('api-description').value.trim();
            const records = parseInt(document.getElementById('api-records').value);
            
            if (!name || !description) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            showLoading('Generating API...', 'AI is creating realistic data');
            
            try {
                const response = await fetch('/api/lab/generate/api', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        record_count: records
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to generate API');
                }
                
                const result = await response.json();
                generatedResult = result;
                
                // Show preview
                showAPIPreview(result);
                await addToHistory('api', name, result);
                showToast('API generated successfully!', 'success');
                
            } catch (e) {
                console.error('Error:', e);
                showToast('Failed to generate API: ' + e.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function generateDocument() {
            const name = document.getElementById('doc-name').value.trim();
            const description = document.getElementById('doc-description').value.trim();
            
            if (!name || !description) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            showLoading('Generating Document...', `Creating ${selectedDocFormat.toUpperCase()} file`);
            
            try {
                const response = await fetch('/api/lab/generate/document', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        format: selectedDocFormat
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to generate document');
                }
                
                const result = await response.json();
                generatedResult = result;
                
                // Show preview
                showDocumentPreview(result);
                await addToHistory('document', name, result);
                showToast('Document generated successfully!', 'success');
                
            } catch (e) {
                console.error('Error:', e);
                showToast('Failed to generate document: ' + e.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function generateImage() {
            const name = document.getElementById('img-name').value.trim();
            const description = document.getElementById('img-description').value.trim();
            
            if (!name || !description) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            showLoading('Generating Image...', 'Creating document image for OCR');
            
            try {
                const response = await fetch('/api/lab/generate/image', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        document_type: selectedImageType,
                        format: selectedImgFormat
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to generate image');
                }
                
                const result = await response.json();
                generatedResult = result;
                
                // Show preview
                showImagePreview(result);
                await addToHistory('image', name, result);
                showToast('Image generated successfully!', 'success');
                
            } catch (e) {
                console.error('Error:', e);
                showToast('Failed to generate image: ' + e.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Previews (result must include id/slug from backend; we do not mutate to hide missing data)
        function showAPIPreview(result) {
            lastGeneratedAPIResult = result;
            const previewSection = document.getElementById('preview-section');
            const previewArea = document.getElementById('preview-area');
            
            previewSection.classList.remove('hidden');
            previewArea.classList.add('has-content');
            
            const params = result.parameters && Array.isArray(result.parameters) ? result.parameters : [];
            const isParametrized = params.length > 0;
            const apiIdOrSlug = getApiIdOrSlugFromResult(result);
            const fullEndpoint = window.location.origin + (result.endpoint || '/api/lab/mock/' + apiIdOrSlug);
            const jsonContent = JSON.stringify(result.data || result, null, 2);
            
            const paramsConfigHtml = isParametrized
                ? `
                <div class="mt-3 pt-3 border-t border-amber-500/20">
                    <p class="text-xs font-semibold text-amber-400/90 uppercase tracking-wider mb-2">Parameters (query)</p>
                    <div class="flex flex-wrap gap-2">
                        ${params.map(p => {
                            const req = p.required ? '<span class="text-red-400 text-xs ml-0.5">*</span>' : '';
                            const typeTag = (p.data_type || 'string').toLowerCase();
                            const typeColor = typeTag === 'number' ? 'bg-blue-500/20 text-blue-300' : typeTag === 'boolean' ? 'bg-purple-500/20 text-purple-300' : 'bg-gray-500/20 text-gray-300';
                            return `
                            <div class="inline-flex flex-col gap-0.5 rounded-xl bg-black/25 border border-amber-500/20 px-3 py-2 min-w-[140px]">
                                <span class="font-mono text-sm font-semibold text-amber-200">${escapeHtml(p.name || '')}${req}</span>
                                ${p.description ? `<span class="text-xs text-gray-400 leading-tight">${escapeHtml(p.description)}</span>` : ''}
                                <span class="text-xs px-1.5 py-0.5 rounded ${typeColor} w-fit">${escapeHtml(typeTag)}</span>
                            </div>`;
                        }).join('')}
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Add as query: <code class="text-amber-400/80">?${params[0]?.name || 'param'}=value</code></p>
                </div>
                `
                : `
                <div class="mt-3 pt-3 border-t border-green-500/20">
                    <p class="text-xs font-semibold text-green-400/90 uppercase tracking-wider">Parameters</p>
                    <p class="text-sm text-gray-400 mt-1">None ‚Äî returns full list</p>
                </div>
                `;
            
            previewArea.innerHTML = `
                <div class="w-full p-4 space-y-4">
                    <!-- API Endpoint Info -->
                    <div class="p-4 rounded-xl bg-green-500/10 border border-green-500/30 shadow-lg shadow-green-500/5">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-green-400 text-xl">üîå</span>
                                <span class="font-bold text-lg">API Ready!</span>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-green-500 text-white">GET</span>
                        </div>
                        <div class="flex items-center gap-2 mb-3">
                            <code class="flex-1 text-sm text-green-400 bg-black/30 px-3 py-2 rounded-lg font-mono overflow-x-auto break-all">${escapeHtml(fullEndpoint)}</code>
                            <button onclick="copyToClipboard('${String(fullEndpoint).replace(/'/g, "\\'")}')" class="btn-secondary text-sm px-3 py-2 flex-shrink-0">üìã Copy</button>
                        </div>
                        <button onclick="testAPI('${(apiIdOrSlug ? String(apiIdOrSlug).replace(/'/g, "\\'") : '')}')" class="btn-primary w-full flex items-center justify-center gap-2">
                            <span>‚ñ∂Ô∏è</span>
                            <span>${isParametrized ? 'Test API (set parameters)' : 'Test API'}</span>
                        </button>
                        <div id="api-last-request-url" class="mt-3 pt-3 border-t border-green-500/20 text-xs font-mono text-green-300/90 break-all min-h-[2rem]">Request URL will appear here after you run Test.</div>
                    </div>
                    
                    <!-- Configuration: Method, Endpoint, Parameters -->
                    <div class="p-4 rounded-xl bg-amber-500/10 border border-amber-500/30 shadow-lg shadow-amber-500/5">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-amber-400 text-xl">‚öôÔ∏è</span>
                            <span class="font-bold text-lg">Configuration</span>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                            <div class="rounded-lg bg-black/25 px-3 py-2">
                                <span class="text-gray-500 block text-xs uppercase tracking-wider">Method</span>
                                <span class="font-mono font-semibold text-amber-200">GET</span>
                            </div>
                            <div class="rounded-lg bg-black/25 px-3 py-2 sm:col-span-1">
                                <span class="text-gray-500 block text-xs uppercase tracking-wider">Endpoint</span>
                                <span class="font-mono text-amber-200 break-all text-xs">${escapeHtml(result.endpoint || '/api/lab/mock/' + (result.slug || result.id))}</span>
                            </div>
                        </div>
                        ${paramsConfigHtml}
                    </div>
                    
                    <!-- Test Result (hidden initially) -->
                    <div id="api-test-result" class="hidden p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-blue-400">üì°</span>
                            <span class="font-medium">Test Response</span>
                            <span id="api-test-status" class="ml-auto text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400">200 OK</span>
                        </div>
                        <div id="api-test-request-url" class="mb-2 text-xs font-mono text-gray-400 break-all border-b border-blue-500/20 pb-2"></div>
                        <pre id="api-test-response" class="bg-black/50 rounded-lg p-3 overflow-auto max-h-48 text-xs"><code class="text-gray-300">Loading...</code></pre>
                    </div>
                    
                    <!-- Integration Guide -->
                    <div class="p-4 rounded-lg bg-purple-500/10 border border-purple-500/30">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-purple-400 text-xl">üîß</span>
                            <span class="font-bold">Add as Tool in AgentForge</span>
                        </div>
                        <div class="space-y-3 text-sm">
                            <div class="flex items-start gap-3">
                                <span class="w-6 h-6 rounded-full bg-purple-500 text-white text-xs flex items-center justify-center flex-shrink-0">1</span>
                                <div>
                                    <p class="font-medium">Go to Tools page</p>
                                    <p class="text-gray-400 text-xs">Admin Portal ‚Üí Tools ‚Üí Create New Tool</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="w-6 h-6 rounded-full bg-purple-500 text-white text-xs flex items-center justify-center flex-shrink-0">2</span>
                                <div>
                                    <p class="font-medium">Select "API" as tool type</p>
                                    <p class="text-gray-400 text-xs">Choose REST API integration</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="w-6 h-6 rounded-full bg-purple-500 text-white text-xs flex items-center justify-center flex-shrink-0">3</span>
                                <div>
                                    <p class="font-medium">Configure the endpoint</p>
                                    <div class="mt-1 p-2 rounded bg-black/30 text-xs font-mono">
                                        <p><span class="text-gray-500">URL:</span> <span class="text-green-400">${fullEndpoint}</span></p>
                                        <p><span class="text-gray-500">Method:</span> <span class="text-blue-400">GET</span></p>
                                        <p><span class="text-gray-500">Auth:</span> <span class="text-yellow-400">None required</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="w-6 h-6 rounded-full bg-purple-500 text-white text-xs flex items-center justify-center flex-shrink-0">4</span>
                                <div>
                                    <p class="font-medium">Add to your Agent</p>
                                    <p class="text-gray-400 text-xs">In Agent Wizard ‚Üí Step 5: Tools ‚Üí Select this API tool</p>
                                </div>
                            </div>
                        </div>
                        <button onclick="createToolFromAPI('${result.id}', '${result.name}')" class="btn-secondary w-full mt-4 flex items-center justify-center gap-2">
                            <span>‚ö°</span>
                            <span>Quick: Create Tool Automatically</span>
                        </button>
                    </div>
                    
                    <!-- Data Preview -->
                    <div class="p-4 rounded-lg bg-gray-800/50 border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400">üìä</span>
                                <span class="font-medium">Data Preview</span>
                            </div>
                            <span class="text-xs text-gray-500">${result.record_count || (result.data?.length || 0)} records</span>
                        </div>
                        <pre class="bg-black/50 rounded-lg p-3 overflow-auto max-h-64 text-xs"><code class="text-gray-300">${escapeHtml(jsonContent)}</code></pre>
                    </div>
                </div>
            `;
        }
        
        // Business-friendly display: table for arrays, structured for objects
        function renderBusinessFriendlyResponse(data) {
            if (!data) return '<p class="text-gray-400 text-sm">No data returned</p>';
            
            // Array of objects ‚Üí Table
            if (Array.isArray(data) && data.length > 0 && typeof data[0] === 'object') {
                const keys = Object.keys(data[0]);
                let html = `<div class="overflow-x-auto"><table class="w-full text-sm border-collapse">
                    <thead><tr class="bg-blue-900/30 border-b border-blue-700">`;
                keys.forEach(k => {
                    html += `<th class="px-3 py-2 text-left font-semibold text-blue-200">${k}</th>`;
                });
                html += `</tr></thead><tbody>`;
                data.forEach((row, idx) => {
                    html += `<tr class="${idx % 2 === 0 ? 'bg-gray-800/40' : 'bg-gray-800/20'} border-b border-gray-700/50">`;
                    keys.forEach(k => {
                        const val = row[k];
                        const display = val != null ? String(val) : '-';
                        html += `<td class="px-3 py-2 text-gray-200">${display}</td>`;
                    });
                    html += `</tr>`;
                });
                html += `</tbody></table></div>`;
                html += `<p class="text-xs text-gray-400 mt-2">${data.length} record${data.length !== 1 ? 's' : ''}</p>`;
                return html;
            }
            
            // Single object ‚Üí Structured view
            if (typeof data === 'object' && !Array.isArray(data)) {
                let html = '<div class="space-y-2">';
                Object.entries(data).forEach(([k, v]) => {
                    const display = v != null ? (typeof v === 'object' ? JSON.stringify(v, null, 2) : String(v)) : '-';
                    html += `<div class="flex items-start gap-3 border-b border-gray-700/30 pb-2">
                        <span class="font-semibold text-blue-300 min-w-[120px]">${k}:</span>
                        <span class="text-gray-200 break-all">${display}</span>
                    </div>`;
                });
                html += '</div>';
                return html;
            }
            
            // Fallback: simple value or JSON
            return `<pre class="text-gray-200 text-sm whitespace-pre-wrap break-words">${typeof data === 'object' ? JSON.stringify(data, null, 2) : String(data)}</pre>`;
        }

        // Test API endpoint - check if parameterized and show modal if needed
        let currentTestItemId = null;
        let currentTestSlug = null;
        
        async function testAPI(itemId) {
            var rawId = (itemId != null && itemId !== 'null' && itemId !== 'undefined' && itemId !== '') ? String(itemId).trim() : '';
            if (!rawId && lastGeneratedAPIResult) rawId = getApiIdOrSlugFromResult(lastGeneratedAPIResult);
            console.log('[Lab Test API] button itemId:', itemId, '| derived rawId:', rawId, '| result has endpoint:', lastGeneratedAPIResult ? !!lastGeneratedAPIResult.endpoint : false);
            if (!rawId || rawId === 'null' || rawId === 'undefined') {
                showToast('Cannot run test: API identifier (id/slug) is missing in this item. Check that history was saved correctly or generate the API again.', 'error');
                return;
            }
            const effectiveId = String(rawId);
            const result = lastGeneratedAPIResult && (lastGeneratedAPIResult.id === effectiveId || lastGeneratedAPIResult.slug === effectiveId) ? lastGeneratedAPIResult : null;
            const hasParams = result && result.parameters && result.parameters.length > 0;
            const slug = result?.slug;
            const slugOrId = (slug != null && slug !== 'null' && slug !== 'undefined') ? String(slug) : effectiveId;
            
            if (hasParams) {
                currentTestItemId = effectiveId;
                currentTestSlug = slugOrId;
                openTestParamsModal(result.parameters);
            } else {
                await runTest(slugOrId, {});
            }
        }
        
        function openTestParamsModal(parameters) {
            const modal = document.getElementById('test-params-modal');
            const inputsContainer = document.getElementById('test-params-inputs');
            
            // Build parameter inputs
            let html = '';
            parameters.forEach((param, idx) => {
                const required = param.required ? '<span class="text-red-400">*</span>' : '';
                html += `
                    <div>
                        <label class="block text-sm font-medium mb-1">
                            ${param.name} ${required}
                            ${param.description ? `<span class="text-gray-500 text-xs ml-1">(${param.description})</span>` : ''}
                        </label>
                        <input 
                            type="text" 
                            id="test-param-${idx}" 
                            data-param-name="${param.name}"
                            placeholder="Enter ${param.name}"
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-purple-500 focus:outline-none"
                            ${param.required ? 'required' : ''}
                        />
                    </div>
                `;
            });
            inputsContainer.innerHTML = html;
            
            modal.style.display = 'flex';
        }
        
        function closeTestParamsModal() {
            document.getElementById('test-params-modal').style.display = 'none';
            currentTestItemId = null;
            currentTestSlug = null;
        }
        
        async function runTestWithParams() {
            if (!currentTestItemId) return;
            
            // Collect parameter values
            const params = {};
            const inputs = document.querySelectorAll('[data-param-name]');
            inputs.forEach(input => {
                const paramName = input.dataset.paramName;
                const value = input.value.trim();
                if (value) {
                    params[paramName] = value;
                }
            });
            
            // Close modal
            closeTestParamsModal();
            
            // Run test with parameters
            await runTest(currentTestSlug || currentTestItemId, params);
        }
        
        async function runTest(slugOrId, params = {}) {
            const safeSlugOrId = (slugOrId != null && slugOrId !== 'null' && slugOrId !== 'undefined') ? String(slugOrId).trim() : '';
            if (!safeSlugOrId) {
                showToast('Cannot run test: API identifier is missing.', 'error');
                return;
            }
            const resultDiv = document.getElementById('api-test-result');
            const responseCode = document.getElementById('api-test-response');
            const statusBadge = document.getElementById('api-test-status');
            
            resultDiv.classList.remove('hidden');
            responseCode.innerHTML = '<code class="text-gray-400">‚è≥ Sending request...</code>';
            statusBadge.textContent = '...';
            statusBadge.className = 'ml-auto text-xs px-2 py-1 rounded-full bg-gray-500/20 text-gray-400';
            
            try {
                const startTime = Date.now();
                // URL format (must match backend): /api/lab/mock/{slug}?param1=value1&param2=value2
                // Example: /api/lab/mock/supplier-details-by-id?supplier_id=S001
                // - Path: /api/lab/mock/ + slug (no trailing slash, no extra segments)
                // - Query: only if API has parameters; one ? then key=value pairs with & (dynamic by API name + params)
                const hasParams = params && typeof params === 'object' && Object.keys(params).length > 0;
                const queryString = hasParams
                    ? '?' + Object.entries(params).map(([k, v]) => encodeURIComponent(k) + '=' + encodeURIComponent(v)).join('&')
                    : '';
                const url = '/api/lab/mock/' + encodeURIComponent(safeSlugOrId) + queryString;
                const requestText = 'GET ' + url + (hasParams ? '  |  params: ' + JSON.stringify(params) : '  |  params: (none)');
                var urlEl = document.getElementById('api-test-request-url');
                if (urlEl) urlEl.textContent = 'Request: ' + requestText;
                var lastReqEl = document.getElementById('api-last-request-url');
                if (lastReqEl) lastReqEl.textContent = 'Request: ' + requestText;
                console.log('[Lab Test API] URL:', url, '| params:', hasParams ? params : '(none)');
                
                const response = await fetch(url);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                const data = await response.json();
                
                if (response.ok) {
                    statusBadge.textContent = `${response.status} OK (${duration}ms)`;
                    statusBadge.className = 'ml-auto text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400';
                    // Business-friendly display
                    responseCode.innerHTML = renderBusinessFriendlyResponse(data);
                } else {
                    statusBadge.textContent = `${response.status} Error`;
                    statusBadge.className = 'ml-auto text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-400';
                    responseCode.innerHTML = `<p class="text-red-400 text-sm">‚ùå ${escapeHtml(JSON.stringify(data, null, 2))}</p>`;
                }
                
            } catch (e) {
                statusBadge.textContent = 'Error';
                statusBadge.className = 'ml-auto text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-400';
                responseCode.innerHTML = `<p class="text-red-400 text-sm">‚ùå ${e.message}</p>`;
            }
        }
        
        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }
        
        // Last generated API result (from backend); used so we don't hardcode description/params.
        let lastGeneratedAPIResult = null;
        
        function sanitizeAgentDescription(text) {
            if (!text || typeof text !== 'string') return '';
            return text.replace(/\b(mock|demo|test(ing)?)\b/gi, '').replace(/\s+/g, ' ').trim();
        }
        
        function normalizeParameters(params) {
            if (!Array.isArray(params)) return [];
            return params.map(p => ({
                name: p.name || 'param',
                description: p.description || '',
                data_type: p.data_type || 'string',
                required: !!p.required,
                location: p.location === 'path' ? 'path' : 'query'
            }));
        }
        
        // Create tool from generated API using backend-provided description and parameters (no hardcoding).
        async function createToolFromAPI(apiId, apiName) {
            showLoading('Creating Tool...', 'Adding API to Tools library');
            
            try {
                const result = lastGeneratedAPIResult && lastGeneratedAPIResult.id === apiId ? lastGeneratedAPIResult : null;
                const slug = (result && result.slug) ? result.slug : ((apiName || 'api').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || apiId);
                const endpointPath = `/api/lab/mock/${slug}`;
                const baseUrl = window.location.origin;
                
                const rawDesc = (result && result.agent_description) ? result.agent_description : null;
                const desc = rawDesc ? sanitizeAgentDescription(rawDesc) : (apiName ? `Returns ${apiName}. Use when the user asks for this data.` : 'Returns data. Use when the user asks for this information.');
                const input_parameters = (result && result.parameters && result.parameters.length) ? normalizeParameters(result.parameters) : [];
                
                const response = await fetch('/api/tools', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: apiName || 'Generated API',
                        description: desc,
                        type: 'api',
                        api_config: {
                            base_url: baseUrl,
                            http_method: 'GET',
                            endpoint_path: endpointPath,
                            auth_type: 'none',
                            auth_value: '',
                            api_key_name: '',
                            api_key_location: 'header',
                            headers: {},
                            input_parameters
                        }
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.detail || 'Failed to create tool');
                }
                
                const tool = await response.json();
                showToast(`Tool "${apiName}" created successfully! Go to Tools page to see it.`, 'success');
                
            } catch (e) {
                console.error('Error creating tool:', e);
                showToast('Failed to create tool: ' + e.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        function showDocumentPreview(result) {
            const previewSection = document.getElementById('preview-section');
            const previewArea = document.getElementById('preview-area');
            
            previewSection.classList.remove('hidden');
            previewArea.classList.add('has-content');
            
            previewArea.innerHTML = `
                <div class="w-full p-6 text-center">
                    <div class="w-24 h-32 mx-auto mb-4 rounded-lg bg-gradient-to-b from-gray-700 to-gray-800 flex items-center justify-center text-4xl shadow-lg">
                        ${getDocIcon(result.format)}
                    </div>
                    <h4 class="text-lg font-bold mb-2">${result.name || 'Document'}.${result.format}</h4>
                    <p class="text-sm text-gray-400 mb-4">${formatFileSize(result.size || 0)}</p>
                    <button onclick="downloadResult()" class="btn-primary">
                        ‚¨áÔ∏è Download ${result.format?.toUpperCase()}
                    </button>
                </div>
            `;
        }
        
        function showImagePreview(result) {
            const previewSection = document.getElementById('preview-section');
            const previewArea = document.getElementById('preview-area');
            
            previewSection.classList.remove('hidden');
            previewArea.classList.add('has-content');
            
            if (result.image_url || result.base64) {
                const imgSrc = result.image_url || `data:image/${result.format || 'png'};base64,${result.base64}`;
                previewArea.innerHTML = `
                    <div class="w-full p-4">
                        <img src="${imgSrc}" alt="${result.name}" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg border border-gray-700">
                    </div>
                `;
            } else {
                previewArea.innerHTML = `
                    <div class="w-full p-6 text-center">
                        <div class="w-24 h-24 mx-auto mb-4 rounded-lg bg-gradient-to-b from-purple-700 to-pink-800 flex items-center justify-center text-4xl shadow-lg">
                            üñºÔ∏è
                        </div>
                        <h4 class="text-lg font-bold mb-2">${result.name || 'Image'}.${result.format}</h4>
                        <button onclick="downloadResult()" class="btn-primary">
                            ‚¨áÔ∏è Download Image
                        </button>
                    </div>
                `;
            }
        }
        
        // History (API only; no localStorage)
        async function addToHistory(type, name, result) {
            try {
                const response = await fetch('/api/lab/history', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type, name, result })
                });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.detail || response.statusText || 'Failed to save to history');
                }
                const item = await response.json();
                history.unshift(item);
                if (history.length > 20) history.pop();
                renderHistory();
            } catch (e) {
                console.error('Lab history add failed:', e);
                showToast('Could not save to history: ' + e.message, 'error');
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/lab/history', { headers: getAuthHeaders() });
                if (!response.ok) {
                    if (response.status === 401) {
                        history = [];
                    } else {
                        throw new Error(response.statusText);
                    }
                } else {
                    const data = await response.json();
                    history = data.items || [];
                }
            } catch (e) {
                console.error('Lab history load failed:', e);
                history = [];
            }
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('history-list');
            if (!container) return;

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-3xl mb-2">üì≠</div>
                        <p class="text-sm">No items yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = history.map(item => {
                const created = item.created_at || item.createdAt || '';
                const safeId = String(item.id).replace(/'/g, "\\'");
                return `
                <div class="history-item" onclick="loadHistoryItem('${safeId}')">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${getTypeIcon(item.type)}</span>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium truncate">${item.name}</div>
                            <div class="text-xs text-gray-400">${formatDate(created)}</div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function getApiIdOrSlugFromResult(result) {
            if (!result || typeof result !== 'object') return '';
            const id = result.id != null && result.id !== '' ? String(result.id) : '';
            const slug = result.slug != null && result.slug !== '' ? String(result.slug) : '';
            if (id) return id;
            if (slug) return slug;
            const ep = result.endpoint || result.Endpoint || '';
            const m = typeof ep === 'string' ? ep.match(/\/mock\/?([^/?]+)/) : null;
            return m ? m[1] : '';
        }

        function loadHistoryItem(id) {
            const item = history.find(h => h.id === id);
            if (!item) return;

            selectGenerator(item.type);
            generatedResult = item.result;

            if (item.type === 'api') {
                if (item.result && typeof item.result === 'object') {
                    var r = item.result;
                    var derived = getApiIdOrSlugFromResult(r);
                    if (derived && (r.id == null || r.id === '') && (r.slug == null || r.slug === '')) {
                        r.slug = r.slug || derived;
                        r.id = r.id || derived;
                    }
                }
                showAPIPreview(item.result);
            } else if (item.type === 'document') {
                showDocumentPreview(item.result);
            } else if (item.type === 'image') {
                showImagePreview(item.result);
            }
        }

        async function clearHistory() {
            if (!confirm('Clear all history?')) return;
            try {
                const response = await fetch('/api/lab/history', {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error(response.statusText || 'Failed to clear history');
                history = [];
                renderHistory();
                showToast('History cleared', 'success');
            } catch (e) {
                console.error('Clear history failed:', e);
                showToast('Could not clear history: ' + e.message, 'error');
            }
        }
        
        // Download
        async function downloadResult() {
            if (!generatedResult) {
                showToast('Nothing to download', 'error');
                return;
            }
            
            try {
                if (generatedResult.download_url) {
                    window.open(generatedResult.download_url, '_blank');
                } else if (generatedResult.base64) {
                    const link = document.createElement('a');
                    link.href = `data:application/octet-stream;base64,${generatedResult.base64}`;
                    link.download = `${generatedResult.name || 'download'}.${generatedResult.format || 'bin'}`;
                    link.click();
                } else if (generatedResult.data) {
                    const blob = new Blob([JSON.stringify(generatedResult.data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${generatedResult.name || 'api-data'}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                }
            } catch (e) {
                showToast('Download failed: ' + e.message, 'error');
            }
        }
        
        // Quick Actions
        function openToolsLibrary() {
            window.location.href = '/ui/#tools';
        }
        
        function exportAll() {
            if (history.length === 0) {
                showToast('No items to export', 'error');
                return;
            }
            
            const blob = new Blob([JSON.stringify(history, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'lab-export.json';
            link.click();
            URL.revokeObjectURL(url);
            
            showToast('Export complete!', 'success');
        }
        
        // Utilities
        function showLoading(text, subtext) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-subtext').textContent = subtext;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        // ========== MODERN NOTIFICATION SYSTEM ==========
        const NotificationSystem = {
            container: null,
            notifications: [],
            maxVisible: 5,
            
            init() {
                if (this.container) return;
                this.container = document.createElement('div');
                this.container.id = 'notification-container';
                this.container.className = 'fixed top-4 right-4 z-[9999] flex flex-col gap-3 max-w-md w-full pointer-events-none';
                this.container.style.cssText = 'max-height: calc(100vh - 2rem); overflow: hidden;';
                document.body.appendChild(this.container);
            },
            
            getConfig(type) {
                const configs = {
                    success: {
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`,
                        bgClass: 'bg-gradient-to-r from-emerald-500/95 to-green-600/95',
                        borderClass: 'border-emerald-400/30',
                        iconBg: 'bg-emerald-400/20',
                        title: 'Success',
                        duration: 4000
                    },
                    error: {
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`,
                        bgClass: 'bg-gradient-to-r from-red-500/95 to-rose-600/95',
                        borderClass: 'border-red-400/30',
                        iconBg: 'bg-red-400/20',
                        title: 'Error',
                        duration: 8000
                    },
                    warning: {
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`,
                        bgClass: 'bg-gradient-to-r from-amber-500/95 to-orange-600/95',
                        borderClass: 'border-amber-400/30',
                        iconBg: 'bg-amber-400/20',
                        title: 'Warning',
                        duration: 6000
                    },
                    info: {
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                        bgClass: 'bg-gradient-to-r from-blue-500/95 to-indigo-600/95',
                        borderClass: 'border-blue-400/30',
                        iconBg: 'bg-blue-400/20',
                        title: 'Info',
                        duration: 4000
                    }
                };
                return configs[type] || configs.info;
            },
            
            show(message, type = 'info', options = {}) {
                this.init();
                const config = this.getConfig(type);
                const id = 'notif-' + Date.now() + Math.random().toString(36).substr(2, 9);
                const duration = options.duration || config.duration;
                const showProgress = options.showProgress !== false;
                
                const cleanMessage = message.replace(/^[‚úÖ‚ùå‚ö†Ô∏è‚ÑπÔ∏è‚ú®üéâüí°üîî]\s*/, '');
                
                const notification = document.createElement('div');
                notification.id = id;
                notification.className = `
                    ${config.bgClass} ${config.borderClass}
                    backdrop-blur-xl border rounded-xl shadow-2xl
                    transform translate-x-full opacity-0
                    transition-all duration-300 ease-out
                    pointer-events-auto overflow-hidden
                `;
                notification.style.cssText = 'box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);';
                
                notification.innerHTML = `
                    <div class="p-4">
                        <div class="flex items-start gap-3">
                            <div class="${config.iconBg} rounded-full p-2 flex-shrink-0">
                                ${config.icon}
                            </div>
                            <div class="flex-1 min-w-0 pt-0.5">
                                <p class="text-sm font-semibold text-white/90">${config.title}</p>
                                <p class="text-sm text-white/80 mt-0.5 break-words">${this.escapeHtml(cleanMessage)}</p>
                            </div>
                            <button onclick="NotificationSystem.dismiss('${id}')" 
                                class="flex-shrink-0 p-1 rounded-lg hover:bg-white/20 transition-colors text-white/60 hover:text-white">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    ${showProgress ? `<div class="h-1 bg-white/20"><div class="notif-progress h-full bg-white/40 rounded-full" style="width: 100%; transition: width ${duration}ms linear;"></div></div>` : ''}
                `;
                
                this.container.insertBefore(notification, this.container.firstChild);
                this.notifications.push({ id, element: notification, timeout: null });
                
                requestAnimationFrame(() => {
                    notification.classList.remove('translate-x-full', 'opacity-0');
                    notification.classList.add('translate-x-0', 'opacity-100');
                    
                    if (showProgress) {
                        const progressBar = notification.querySelector('.notif-progress');
                        if (progressBar) {
                            requestAnimationFrame(() => progressBar.style.width = '0%');
                        }
                    }
                });
                
                const timeout = setTimeout(() => this.dismiss(id), duration);
                const notifRecord = this.notifications.find(n => n.id === id);
                if (notifRecord) notifRecord.timeout = timeout;
                
                this.enforceLimit();
                return id;
            },
            
            dismiss(id) {
                const index = this.notifications.findIndex(n => n.id === id);
                if (index === -1) return;
                
                const { element, timeout } = this.notifications[index];
                if (timeout) clearTimeout(timeout);
                
                element.classList.add('translate-x-full', 'opacity-0');
                element.style.marginTop = `-${element.offsetHeight + 12}px`;
                
                setTimeout(() => {
                    element.remove();
                    this.notifications.splice(index, 1);
                }, 300);
            },
            
            dismissAll() {
                [...this.notifications].forEach(n => this.dismiss(n.id));
            },
            
            enforceLimit() {
                while (this.notifications.length > this.maxVisible) {
                    const oldest = this.notifications[this.notifications.length - 1];
                    this.dismiss(oldest.id);
                }
            },
            
            escapeHtml(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            
            success(message, options = {}) { return this.show(message, 'success', options); },
            error(message, options = {}) { return this.show(message, 'error', options); },
            warning(message, options = {}) { return this.show(message, 'warning', options); },
            info(message, options = {}) { return this.show(message, 'info', options); }
        };
        
        // Global notify shorthand
        const notify = {
            success: (msg, opts) => NotificationSystem.success(msg, opts),
            error: (msg, opts) => NotificationSystem.error(msg, opts),
            warning: (msg, opts) => NotificationSystem.warning(msg, opts),
            info: (msg, opts) => NotificationSystem.info(msg, opts),
            dismiss: (id) => NotificationSystem.dismiss(id),
            dismissAll: () => NotificationSystem.dismissAll()
        };
        
        // Backward compatible showToast
        function showToast(message, type = 'success', options = {}) {
            return NotificationSystem.show(message, type, options);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getTypeIcon(type) {
            switch(type) {
                case 'api': return 'üîå';
                case 'document': return 'üìÑ';
                case 'image': return 'üñºÔ∏è';
                default: return 'üì¶';
            }
        }
        
        function getDocIcon(format) {
            switch(format) {
                case 'docx': return 'üìù';
                case 'pdf': return 'üìï';
                case 'xlsx': return 'üìä';
                case 'pptx': return 'üìΩÔ∏è';
                default: return 'üìÑ';
            }
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown size';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            return date.toLocaleDateString();
        }
    </script>
    
    <!-- Test API Parameters Modal -->
    <div id="test-params-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50" style="display: none;">
        <div class="bg-gray-900 rounded-2xl w-full max-w-md mx-4 border border-gray-700 shadow-2xl">
            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                <h3 class="font-bold text-lg">üß™ Test API with Parameters</h3>
                <button onclick="closeTestParamsModal()" class="p-2 hover:bg-gray-800 rounded-lg transition">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-gray-400 mb-4">Enter values for the parameters below:</p>
                <div id="test-params-inputs" class="space-y-3">
                    <!-- Parameters will be rendered here -->
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-end gap-3">
                <button onclick="closeTestParamsModal()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition">Cancel</button>
                <button onclick="runTestWithParams()" class="px-6 py-2 rounded-lg bg-green-600 hover:bg-green-500 flex items-center gap-2 transition">
                    <span>‚ñ∂</span>
                    <span>Send Request</span>
                </button>
            </div>
        </div>
    </div>
</body>
</html>

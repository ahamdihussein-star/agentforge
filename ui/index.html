<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentForge - AI Agent Builder</title>
    <link rel="icon" type="image/png" href="/AgentForge_Logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        /* === THEME SYSTEM === */
        :root {
            /* Default Dark Theme */
            --bg-primary: #0f0f17;
            --bg-secondary: #16161e;
            --bg-card: #1e1e2e;
            --bg-input: #2d2d3d;
            --border-color: #2d2d3d;
            --border-hover: #3d3d4d;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #6b7280;
            --accent-primary: #8b5cf6;
            --accent-secondary: #667eea;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --sidebar-bg: #16161e;
            --sidebar-active: rgba(139, 92, 246, 0.3);
        }
        
        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-card: #ffffff;
            --bg-input: #e2e8f0;
            --border-color: #cbd5e1;
            --border-hover: #94a3b8;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --accent-primary: #7c3aed;
            --accent-secondary: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --sidebar-bg: #ffffff;
            --sidebar-active: rgba(124, 58, 237, 0.15);
        }
        
        /* Ocean Theme (Like the uploaded image) */
        [data-theme="ocean"] {
            --bg-primary: #e8f4f8;
            --bg-secondary: #dbeafe;
            --bg-card: #ffffff;
            --bg-input: #e0f2fe;
            --border-color: #bae6fd;
            --border-hover: #7dd3fc;
            --text-primary: #0c4a6e;
            --text-secondary: #0369a1;
            --text-muted: #0284c7;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --sidebar-bg: #dbeafe;
            --sidebar-active: rgba(99, 102, 241, 0.2);
        }
        
        /* Sunset Theme */
        [data-theme="sunset"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #1f2937;
            --bg-input: #374151;
            --border-color: #4b5563;
            --border-hover: #6b7280;
            --text-primary: #fef3c7;
            --text-secondary: #fcd34d;
            --text-muted: #f59e0b;
            --accent-primary: #f97316;
            --accent-secondary: #ef4444;
            --accent-gradient: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
            --sidebar-bg: #16213e;
            --sidebar-active: rgba(249, 115, 22, 0.3);
        }
        
        /* Forest Theme */
        [data-theme="forest"] {
            --bg-primary: #0f1f13;
            --bg-secondary: #14291a;
            --bg-card: #1a3320;
            --bg-input: #234429;
            --border-color: #2d5a35;
            --border-hover: #3d7a45;
            --text-primary: #dcfce7;
            --text-secondary: #86efac;
            --text-muted: #4ade80;
            --accent-primary: #22c55e;
            --accent-secondary: #16a34a;
            --accent-gradient: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            --sidebar-bg: #14291a;
            --sidebar-active: rgba(34, 197, 94, 0.3);
        }
        
        /* Midnight Theme */
        [data-theme="midnight"] {
            --bg-primary: #020617;
            --bg-secondary: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --border-color: #475569;
            --border-hover: #64748b;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-secondary: #2563eb;
            --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            --sidebar-bg: #0f172a;
            --sidebar-active: rgba(59, 130, 246, 0.3);
        }
        
        *{font-family:'Inter',sans-serif;box-sizing:border-box}
        html,body{height:100%;margin:0;padding:0;overflow:hidden;max-width:100vw;background:var(--bg-primary);color:var(--text-primary)}
        .gradient-bg{background:var(--accent-gradient)}
        .gradient-text{background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .sidebar-item.active{background:var(--sidebar-active);border-left:3px solid var(--accent-primary)}
        .card{background:var(--bg-card);border:1px solid var(--border-color);overflow:hidden;box-sizing:border-box}
        .input-field{background:var(--bg-input);border:1px solid var(--border-color);color:var(--text-primary)}
        .input-field:focus{border-color:var(--accent-primary);outline:none}
        .input-field::placeholder{color:var(--text-muted)}
        .btn-primary{background:var(--accent-gradient);color:#ffffff}
        .btn-secondary{background:var(--bg-input);color:var(--text-primary)}
        .btn-success{background:var(--success);color:#ffffff}
        .btn-danger{background:var(--danger);color:#ffffff}
        .step-active{background:var(--accent-primary);color:white}
        .step-done{background:var(--success);color:white}
        .step-pending{background:var(--bg-input);color:var(--text-muted)}
        .drop-zone{border:2px dashed var(--border-color);transition:all 0.3s}
        .drop-zone.dragover{border-color:var(--accent-primary);background:rgba(139,92,246,0.1)}
        .modal-backdrop{background:rgba(0,0,0,0.8);backdrop-filter:blur(4px)}
        .status-ready{color:var(--success)}
        .status-processing{color:var(--warning)}
        .status-error{color:var(--danger)}
        .status-pending{color:var(--warning)}
        .status-processed{color:var(--success)}
        .status-draft{background:var(--warning);color:#000}
        .status-published{background:var(--success);color:#000}
        .chat-content h1,.chat-content h2,.chat-content h3{font-weight:600;margin:1rem 0 0.5rem 0;color:var(--text-primary)}
        .chat-content h1{font-size:1.25rem}
        .chat-content h2{font-size:1.125rem}
        .chat-content h3{font-size:1rem;color:var(--accent-primary)}
        .chat-content p{margin:0.5rem 0;line-height:1.6}
        .chat-content ul,.chat-content ol{margin:0.5rem 0;padding-left:1.5rem}
        .chat-content li{margin:0.25rem 0}
        .chat-content strong{color:var(--accent-primary);font-weight:600}
        .chat-content code{background:var(--bg-secondary);padding:0.125rem 0.375rem;border-radius:0.25rem;font-family:monospace;color:var(--success);font-size:0.875rem}
        .chat-content pre{background:var(--bg-secondary);padding:1rem;border-radius:0.5rem;overflow-x:auto;margin:0.5rem 0}
        .chat-content pre code{background:none;padding:0}
        .chat-content blockquote{border-left:3px solid var(--accent-primary);padding-left:1rem;margin:0.5rem 0;color:var(--text-secondary)}
        .chat-content table{width:100%;border-collapse:collapse;margin:0.5rem 0;font-size:0.875rem}
        .chat-content th{background:var(--bg-input);padding:0.5rem;text-align:left;border:1px solid var(--border-color)}
        .chat-content td{padding:0.5rem;border:1px solid var(--border-color)}
        .chat-content tr:nth-child(even){background:rgba(45,45,61,0.3)}
        .source-badge{background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.4)}
        .animate-fade-in{animation:fadeIn 0.3s ease-out}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .toggle-switch{width:44px;height:24px;background:var(--bg-input);border-radius:12px;position:relative;cursor:pointer;transition:0.3s}
        .toggle-switch.on{background:var(--accent-primary)}
        .toggle-switch::after{content:'';position:absolute;width:20px;height:20px;background:white;border-radius:50%;top:2px;left:2px;transition:0.3s}
        .toggle-switch.on::after{left:22px}
        
        /* Theme-aware backgrounds */
        .bg-theme-primary{background:var(--bg-primary)}
        .bg-theme-secondary{background:var(--bg-secondary)}
        .bg-theme-card{background:var(--bg-card)}
        .text-theme-primary{color:var(--text-primary)}
        .text-theme-secondary{color:var(--text-secondary)}
        .text-theme-muted{color:var(--text-muted)}
        .border-theme{border-color:var(--border-color)}
        
        /* Sidebar theming */
        .desktop-sidebar{background:var(--sidebar-bg) !important}
        .sidebar-item{color:var(--text-secondary)}
        .sidebar-item:hover{background:var(--bg-input)}
        
        /* Sidebar for light themes */
        [data-theme="light"] .sidebar-item,
        [data-theme="ocean"] .sidebar-item {
            color: var(--text-secondary);
        }
        
        [data-theme="light"] .sidebar-item.active,
        [data-theme="ocean"] .sidebar-item.active {
            background: var(--sidebar-active);
            color: var(--accent-primary);
            border-left: 3px solid var(--accent-primary);
        }
        
        [data-theme="light"] .sidebar-item:hover,
        [data-theme="ocean"] .sidebar-item:hover {
            background: rgba(0,0,0,0.05);
        }
        
        /* Theme selector buttons */
        .theme-btn {
            background: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .theme-btn:hover {
            border-color: var(--accent-primary);
        }
        
        /* Tab Buttons */
        .tab-btn {
            color: var(--text-muted);
            transition: all 0.2s;
        }
        
        .tab-btn:hover {
            color: var(--text-secondary);
        }
        
        .tab-btn.active {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        
        /* Navigation Icons */
        .nav-icon {
            opacity: 0.9;
        }
        
        .sidebar-item.active .nav-icon {
            opacity: 1;
        }
        
        /* In light themes, icons need to stay visible (they have dark background) */
        [data-theme="light"] .nav-icon,
        [data-theme="ocean"] .nav-icon {
            opacity: 0.9;
            border-radius: 4px;
        }
        
        [data-theme="light"] .sidebar-item.active .nav-icon,
        [data-theme="ocean"] .sidebar-item.active .nav-icon {
            opacity: 1;
        }
        
        /* === TAILWIND GRAY OVERRIDES FOR LIGHT THEMES === */
        /* These override Tailwind's gray classes to work with themes */
        
        /* Text colors - override gray text for light themes */
        [data-theme="light"] .text-gray-300,
        [data-theme="light"] .text-gray-400,
        [data-theme="ocean"] .text-gray-300,
        [data-theme="ocean"] .text-gray-400 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="light"] .text-gray-500,
        [data-theme="light"] .text-gray-600,
        [data-theme="ocean"] .text-gray-500,
        [data-theme="ocean"] .text-gray-600 {
            color: var(--text-muted) !important;
        }
        
        /* Background colors - override gray backgrounds for light themes */
        [data-theme="light"] .bg-gray-800,
        [data-theme="light"] .bg-gray-900,
        [data-theme="light"] .bg-gray-800\/50,
        [data-theme="light"] .bg-gray-800\/30,
        [data-theme="ocean"] .bg-gray-800,
        [data-theme="ocean"] .bg-gray-900,
        [data-theme="ocean"] .bg-gray-800\/50,
        [data-theme="ocean"] .bg-gray-800\/30 {
            background: var(--bg-input) !important;
        }
        
        [data-theme="light"] .bg-gray-700,
        [data-theme="ocean"] .bg-gray-700 {
            background: var(--border-color) !important;
        }
        
        /* Border colors */
        [data-theme="light"] .border-gray-700,
        [data-theme="light"] .border-gray-800,
        [data-theme="ocean"] .border-gray-700,
        [data-theme="ocean"] .border-gray-800 {
            border-color: var(--border-color) !important;
        }
        
        /* Hover states */
        [data-theme="light"] .hover\:bg-gray-800:hover,
        [data-theme="ocean"] .hover\:bg-gray-800:hover {
            background: rgba(203, 213, 225, 0.5) !important;
        }
        
        [data-theme="light"] .hover\:bg-gray-700:hover,
        [data-theme="ocean"] .hover\:bg-gray-700:hover {
            background: rgba(203, 213, 225, 0.8) !important;
        }
        
        /* Hover text colors for action buttons */
        [data-theme="light"] .hover\:text-green-400:hover,
        [data-theme="ocean"] .hover\:text-green-400:hover {
            color: #16a34a !important;
        }
        
        [data-theme="light"] .hover\:text-blue-400:hover,
        [data-theme="ocean"] .hover\:text-blue-400:hover {
            color: #2563eb !important;
        }
        
        [data-theme="light"] .hover\:text-red-400:hover,
        [data-theme="ocean"] .hover\:text-red-400:hover {
            color: #dc2626 !important;
        }
        
        [data-theme="light"] .hover\:text-purple-300:hover,
        [data-theme="ocean"] .hover\:text-purple-300:hover {
            color: #7c3aed !important;
        }
        
        [data-theme="light"] .hover\:text-white:hover,
        [data-theme="ocean"] .hover\:text-white:hover {
            color: var(--text-primary) !important;
        }
        
        /* Placeholder text */
        [data-theme="light"] input::placeholder,
        [data-theme="light"] textarea::placeholder,
        [data-theme="ocean"] input::placeholder,
        [data-theme="ocean"] textarea::placeholder {
            color: var(--text-muted) !important;
        }
        
        /* Select dropdowns */
        [data-theme="light"] select,
        [data-theme="ocean"] select {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Provider cards and special backgrounds */
        [data-theme="light"] .bg-green-500\/10,
        [data-theme="ocean"] .bg-green-500\/10 {
            background: rgba(34, 197, 94, 0.15) !important;
        }
        
        [data-theme="light"] .bg-purple-500\/10,
        [data-theme="light"] .bg-purple-500\/20,
        [data-theme="ocean"] .bg-purple-500\/10,
        [data-theme="ocean"] .bg-purple-500\/20 {
            background: rgba(139, 92, 246, 0.15) !important;
        }
        
        /* Provider card background */
        [data-theme="light"] .bg-gray-800\/50,
        [data-theme="ocean"] .bg-gray-800\/50 {
            background: var(--bg-input) !important;
        }
        
        [data-theme="light"] .bg-gray-800\/30,
        [data-theme="ocean"] .bg-gray-800\/30 {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color);
        }
        
        /* bg-gray-900/50 for quote boxes */
        
        /* === MODAL & WIZARD FIXES FOR LIGHT THEMES === */
        /* Wizard steps bar - override hardcoded dark bg */
        [data-theme="light"] #wizard-steps-bar,
        [data-theme="ocean"] #wizard-steps-bar {
            background: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Step indicators */
        [data-theme="light"] .wizard-step .step-label,
        [data-theme="ocean"] .wizard-step .step-label {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="light"] .wizard-step .step-num,
        [data-theme="ocean"] .wizard-step .step-num {
            color: white !important;
        }
        
        [data-theme="light"] .step-connector,
        [data-theme="ocean"] .step-connector {
            background: var(--border-color) !important;
        }
        
        /* Modal cards */
        [data-theme="light"] #modal-tool .card,
        [data-theme="light"] #modal-tool > div,
        [data-theme="ocean"] #modal-tool .card,
        [data-theme="ocean"] #modal-tool > div {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }
        
        /* Step header boxes */
        [data-theme="light"] [id^="wiz-step-"] > .flex.items-center.gap-3,
        [data-theme="ocean"] [id^="wiz-step-"] > .flex.items-center.gap-3 {
            background: var(--bg-input) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="light"] [id^="wiz-step-"] h4,
        [data-theme="light"] [id^="wiz-step-"] .font-semibold,
        [data-theme="light"] [id^="wiz-step-"] .font-medium,
        [data-theme="ocean"] [id^="wiz-step-"] h4,
        [data-theme="ocean"] [id^="wiz-step-"] .font-semibold,
        [data-theme="ocean"] [id^="wiz-step-"] .font-medium {
            color: var(--text-primary) !important;
        }
        
        /* Form labels */
        [data-theme="light"] label,
        [data-theme="ocean"] label {
            color: var(--text-secondary) !important;
        }
        
        /* Hardcoded dark backgrounds */
        [data-theme="light"] .bg-\[\#1a1a2e\],
        [data-theme="light"] .bg-\[\#0d0d1a\],
        [data-theme="light"] .bg-\[\#1a1a2e\]\/50,
        [data-theme="ocean"] .bg-\[\#1a1a2e\],
        [data-theme="ocean"] .bg-\[\#0d0d1a\],
        [data-theme="ocean"] .bg-\[\#1a1a2e\]\/50 {
            background: var(--bg-card) !important;
        }
        
        /* Tool type selection cards */
        [data-theme="light"] #wiz-step-0 button.card,
        [data-theme="ocean"] #wiz-step-0 button.card {
            background: var(--bg-input) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="light"] #wiz-step-0 button.card:hover,
        [data-theme="ocean"] #wiz-step-0 button.card:hover {
            border-color: var(--accent-primary) !important;
            background: var(--bg-card) !important;
        }
        
        [data-theme="light"] #wiz-step-0 button.card span.font-medium,
        [data-theme="ocean"] #wiz-step-0 button.card span.font-medium {
            color: var(--text-primary) !important;
        }
        
        /* Modal header text */
        [data-theme="light"] #wizard-title,
        [data-theme="light"] #wizard-subtitle,
        [data-theme="ocean"] #wizard-title,
        [data-theme="ocean"] #wizard-subtitle {
            color: var(--text-primary) !important;
        }
        
        [data-theme="light"] #wizard-subtitle,
        [data-theme="ocean"] #wizard-subtitle {
            color: var(--text-secondary) !important;
        }
        
        /* Modal close button */
        [data-theme="light"] #modal-tool button[onclick="closeWizard()"],
        [data-theme="ocean"] #modal-tool button[onclick="closeWizard()"] {
            color: var(--text-muted) !important;
        }
        
        [data-theme="light"] #modal-tool button[onclick="closeWizard()"]:hover,
        [data-theme="ocean"] #modal-tool button[onclick="closeWizard()"]:hover {
            color: var(--text-primary) !important;
        }
        
        /* Config section cards */
        [data-theme="light"] [id^="cfg-"] .card,
        [data-theme="ocean"] [id^="cfg-"] .card {
            background: var(--bg-input) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        /* All modals - ensure proper theming */
        [data-theme="light"] .modal-backdrop > div,
        [data-theme="ocean"] .modal-backdrop > div {
            background: var(--bg-card) !important;
        }
        
        /* Section headers in modals */
        [data-theme="light"] h4.text-xs.uppercase,
        [data-theme="ocean"] h4.text-xs.uppercase {
            color: var(--text-muted) !important;
        }
        
        /* File upload areas */
        [data-theme="light"] .border-dashed,
        [data-theme="ocean"] .border-dashed {
            border-color: var(--border-color) !important;
            background: var(--bg-input) !important;
        }
        
        /* Step header boxes */
        .step-header-box {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }
        
        .step-header-box h4,
        .step-header-box .font-semibold {
            color: var(--text-primary);
        }
        
        .step-header-box p {
            color: var(--text-secondary);
        }
        
        .step-header-box p.text-gray-400 {
            color: var(--text-muted) !important;
        }
        
        /* Modal content boxes */
        .modal-content-box {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .modal-content-box h3,
        .modal-content-box h4,
        .modal-content-box .font-bold,
        .modal-content-box .font-medium {
            color: var(--text-primary);
        }
        
        .modal-content-box p,
        .modal-content-box label {
            color: var(--text-secondary);
        }
        
        /* Modal buttons and borders in light themes */
        [data-theme="light"] .modal-content-box,
        [data-theme="ocean"] .modal-content-box {
            background: var(--bg-card) !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        [data-theme="light"] .modal-content-box .border-gray-700,
        [data-theme="ocean"] .modal-content-box .border-gray-700 {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="light"] .modal-content-box .bg-gray-700,
        [data-theme="ocean"] .modal-content-box .bg-gray-700 {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="light"] .modal-content-box .bg-gray-700:hover,
        [data-theme="ocean"] .modal-content-box .bg-gray-700:hover {
            background: var(--border-color) !important;
        }
        
        [data-theme="light"] .modal-content-box .hover\:bg-gray-600:hover,
        [data-theme="ocean"] .modal-content-box .hover\:bg-gray-600:hover {
            background: var(--border-color) !important;
        }
        
        [data-theme="light"] .modal-content-box .hover\:bg-gray-700:hover,
        [data-theme="ocean"] .modal-content-box .hover\:bg-gray-700:hover {
            background: var(--bg-input) !important;
        }
        
        /* All gray-700 borders in light themes */
        [data-theme="light"] .border-gray-700,
        [data-theme="ocean"] .border-gray-700 {
            border-color: var(--border-color) !important;
        }
        
        /* All gray-700/gray-600 backgrounds in light themes */
        [data-theme="light"] .bg-gray-700,
        [data-theme="ocean"] .bg-gray-700 {
            background: var(--bg-input) !important;
        }
        
        [data-theme="light"] .bg-gray-600,
        [data-theme="ocean"] .bg-gray-600 {
            background: var(--border-color) !important;
        }
        
        /* Hover states for modal buttons */
        [data-theme="light"] .hover\:bg-gray-600:hover,
        [data-theme="ocean"] .hover\:bg-gray-600:hover {
            background: #d1d5db !important;
        }
        
        /* Text colors in modals */
        [data-theme="light"] .text-purple-300,
        [data-theme="ocean"] .text-purple-300 {
            color: #7c3aed !important;
        }
        
        [data-theme="light"] .text-green-300,
        [data-theme="ocean"] .text-green-300 {
            color: #16a34a !important;
        }
        
        [data-theme="light"] .text-blue-300,
        [data-theme="ocean"] .text-blue-300 {
            color: #2563eb !important;
        }
        
        /* Upload box hover */
        .upload-box:hover {
            border-color: var(--accent-primary) !important;
        }
        
        /* OAuth cards */
        .oauth-card {
            transition: all 0.2s ease;
        }
        
        .oauth-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .oauth-card.border-green-500 {
            border-color: #22c55e !important;
        }
        
        /* === COMPREHENSIVE TEXT FIXES FOR LIGHT THEMES === */
        /* Ensure all text in modals and cards is visible */
        [data-theme="light"] .font-semibold,
        [data-theme="light"] .font-medium,
        [data-theme="light"] .font-bold,
        [data-theme="ocean"] .font-semibold,
        [data-theme="ocean"] .font-medium,
        [data-theme="ocean"] .font-bold {
            color: var(--text-primary);
        }
        
        /* Specific fixes for wizard steps */
        [data-theme="light"] #wiz-step-0 .font-medium,
        [data-theme="light"] #wiz-step-1 .font-semibold,
        [data-theme="light"] #wiz-step-2 .font-semibold,
        [data-theme="light"] #wiz-step-3 .font-semibold,
        [data-theme="light"] #wiz-step-4 .font-semibold,
        [data-theme="ocean"] #wiz-step-0 .font-medium,
        [data-theme="ocean"] #wiz-step-1 .font-semibold,
        [data-theme="ocean"] #wiz-step-2 .font-semibold,
        [data-theme="ocean"] #wiz-step-3 .font-semibold,
        [data-theme="ocean"] #wiz-step-4 .font-semibold {
            color: var(--text-primary) !important;
        }
        
        /* Input number fields in light themes */
        [data-theme="light"] input[type="number"],
        [data-theme="ocean"] input[type="number"] {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Range sliders */
        [data-theme="light"] input[type="range"],
        [data-theme="ocean"] input[type="range"] {
            background: var(--bg-input);
        }
        
        /* Checkboxes */
        [data-theme="light"] input[type="checkbox"],
        [data-theme="ocean"] input[type="checkbox"] {
            accent-color: var(--accent-primary);
        }
        
        /* Card titles and descriptions */
        [data-theme="light"] .card h3,
        [data-theme="light"] .card h4,
        [data-theme="light"] .card h5,
        [data-theme="ocean"] .card h3,
        [data-theme="ocean"] .card h4,
        [data-theme="ocean"] .card h5 {
            color: var(--text-primary) !important;
        }
        
        /* Small text */
        [data-theme="light"] .text-xs,
        [data-theme="light"] .text-\[10px\],
        [data-theme="light"] .text-\[11px\],
        [data-theme="ocean"] .text-xs,
        [data-theme="ocean"] .text-\[10px\],
        [data-theme="ocean"] .text-\[11px\] {
            color: var(--text-secondary);
        }
        
        /* Exception: keep colored small text */
        [data-theme="light"] .text-xs.text-purple-400,
        [data-theme="light"] .text-xs.text-green-400,
        [data-theme="light"] .text-xs.text-blue-400,
        [data-theme="ocean"] .text-xs.text-purple-400,
        [data-theme="ocean"] .text-xs.text-green-400,
        [data-theme="ocean"] .text-xs.text-blue-400 {
            color: inherit;
        }
        [data-theme="light"] .bg-gray-900\/50,
        [data-theme="ocean"] .bg-gray-900\/50 {
            background: var(--bg-input) !important;
        }
        
        /* Labels and headers */
        [data-theme="light"] h1, [data-theme="light"] h2, [data-theme="light"] h3, [data-theme="light"] h4,
        [data-theme="ocean"] h1, [data-theme="ocean"] h2, [data-theme="ocean"] h3, [data-theme="ocean"] h4 {
            color: var(--text-primary);
        }
        
        [data-theme="light"] label,
        [data-theme="ocean"] label {
            color: var(--text-secondary);
        }
        
        /* Cards and sections */
        [data-theme="light"] .card,
        [data-theme="ocean"] .card {
            background: var(--bg-card) !important;
            border-color: var(--border-color) !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Provider badges */
        [data-theme="light"] .bg-green-900\/50,
        [data-theme="ocean"] .bg-green-900\/50 {
            background: rgba(34, 197, 94, 0.2) !important;
        }
        
        [data-theme="light"] .bg-blue-900\/30,
        [data-theme="ocean"] .bg-blue-900\/30 {
            background: rgba(59, 130, 246, 0.15) !important;
        }
        
        [data-theme="light"] .bg-purple-900\/30,
        [data-theme="ocean"] .bg-purple-900\/30 {
            background: rgba(139, 92, 246, 0.15) !important;
        }
        
        /* Buttons for light themes */
        [data-theme="light"] .btn-secondary,
        [data-theme="ocean"] .btn-secondary {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color);
        }
        
        /* Primary buttons - ALWAYS white text on gradient */
        .btn-primary {
            color: #ffffff !important;
        }
        
        /* Success/Danger buttons - ALWAYS white text */
        .btn-success, .btn-danger {
            color: #ffffff !important;
        }
        
        /* Any element with gradient background should have white text */
        [data-theme="light"] .gradient-bg,
        [data-theme="ocean"] .gradient-bg {
            color: #ffffff !important;
        }
        
        /* Status badges should keep their colors */
        .status-draft, .status-published {
            color: #000000 !important;
        }
        
        /* Step indicators */
        .step-active, .step-done {
            color: #ffffff !important;
        }
        
        /* Tag badges */
        [data-theme="light"] .text-purple-300,
        [data-theme="light"] .text-purple-400,
        [data-theme="ocean"] .text-purple-300,
        [data-theme="ocean"] .text-purple-400 {
            color: #7c3aed !important;
        }
        
        [data-theme="light"] .text-green-400,
        [data-theme="ocean"] .text-green-400 {
            color: #16a34a !important;
        }
        
        [data-theme="light"] .text-blue-400,
        [data-theme="ocean"] .text-blue-400 {
            color: #2563eb !important;
        }
        
        [data-theme="light"] .text-yellow-400,
        [data-theme="ocean"] .text-yellow-400 {
            color: #ca8a04 !important;
        }
        
        /* Model tags - better contrast for light themes */
        [data-theme="light"] .bg-gray-700,
        [data-theme="ocean"] .bg-gray-700 {
            background: #e2e8f0 !important;
            color: #475569 !important;
        }
        
        [data-theme="light"] .text-gray-300,
        [data-theme="ocean"] .text-gray-300 {
            color: var(--text-secondary) !important;
        }
        
        /* Dividers */
        [data-theme="light"] .divide-gray-700 > * + *,
        [data-theme="ocean"] .divide-gray-700 > * + * {
            border-color: var(--border-color) !important;
        }
        
        /* Main content area */
        [data-theme="light"] main,
        [data-theme="ocean"] main {
            background: var(--bg-primary);
        }
        
        /* Progress bars - keep vibrant */
        [data-theme="light"] .bg-green-500,
        [data-theme="ocean"] .bg-green-500 {
            background: #22c55e !important;
        }
        
        /* Fix gradient text for light themes */
        [data-theme="light"] .gradient-text,
        [data-theme="ocean"] .gradient-text {
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Modal overlays - darken for light themes */
        [data-theme="light"] .modal-backdrop,
        [data-theme="ocean"] .modal-backdrop {
            background: rgba(0,0,0,0.5);
        }
        
        /* Info/Alert boxes */
        [data-theme="light"] .bg-blue-500\/10,
        [data-theme="ocean"] .bg-blue-500\/10 {
            background: rgba(59, 130, 246, 0.1) !important;
        }
        
        [data-theme="light"] .bg-yellow-500\/10,
        [data-theme="ocean"] .bg-yellow-500\/10 {
            background: rgba(234, 179, 8, 0.1) !important;
        }
        
        [data-theme="light"] .bg-red-500\/10,
        [data-theme="ocean"] .bg-red-500\/10 {
            background: rgba(239, 68, 68, 0.1) !important;
        }
        
        /* Tool cards */
        [data-theme="light"] .tool-card,
        [data-theme="ocean"] .tool-card {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        /* Tool Card Styles */
        .tool-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }
        
        .tool-title {
            color: var(--text-primary);
        }
        
        .tool-type {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .tool-desc {
            color: var(--text-muted);
        }
        
        .tool-demo-badge {
            font-size: 0.65rem;
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 500;
        }
        
        [data-theme="light"] .tool-demo-badge,
        [data-theme="ocean"] .tool-demo-badge {
            background: rgba(124, 58, 237, 0.1);
            color: #7c3aed;
        }
        
        /* Demo Lab Sidebar */
        .demo-sidebar {
            background: var(--bg-secondary);
        }
        
        [data-theme="light"] .demo-sidebar,
        [data-theme="ocean"] .demo-sidebar {
            background: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Agent cards */
        [data-theme="light"] .agent-card,
        [data-theme="ocean"] .agent-card {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        /* Agent Card Styles */
        .agent-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }
        
        .agent-title {
            color: var(--text-primary);
        }
        
        .agent-desc {
            color: var(--text-secondary);
        }
        
        .agent-stats {
            color: var(--text-muted);
        }
        
        /* Agent Status Badges */
        .agent-status-badge {
            font-size: 0.7rem;
            padding: 2px 10px;
            border-radius: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .agent-status-badge.published {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .agent-status-badge.draft {
            background: rgba(234, 179, 8, 0.15);
            color: #ca8a04;
            border: 1px solid rgba(234, 179, 8, 0.3);
        }
        
        /* Agent Action Buttons - Icon only, clean style */
        .agent-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .agent-btn.publish {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .agent-btn.publish:hover {
            background: #22c55e;
            color: white;
            border-color: #22c55e;
        }
        
        .agent-btn.edit {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        .agent-btn.edit:hover {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .agent-btn.delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .agent-btn.delete:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        
        /* Demo badge */
        [data-theme="light"] .bg-purple-500,
        [data-theme="ocean"] .bg-purple-500 {
            background: #8b5cf6 !important;
            color: #ffffff !important;
        }
        
        /* Text on colored backgrounds should be white */
        [data-theme="light"] .bg-green-500 span,
        [data-theme="light"] .bg-purple-500 span,
        [data-theme="light"] .bg-blue-500 span,
        [data-theme="light"] .bg-red-500 span,
        [data-theme="ocean"] .bg-green-500 span,
        [data-theme="ocean"] .bg-purple-500 span,
        [data-theme="ocean"] .bg-blue-500 span,
        [data-theme="ocean"] .bg-red-500 span {
            color: #ffffff !important;
        }
        
        /* Mobile Bottom Nav */
        .mobile-nav{display:none}
        @media(max-width:768px){
            .desktop-sidebar{display:none}
            .mobile-nav{display:flex;position:fixed;bottom:0;left:0;right:0;background:var(--sidebar-bg);border-top:1px solid var(--border-color);z-index:100;padding:0.5rem;justify-content:space-around}
            .mobile-nav button{flex:1;display:flex;flex-direction:column;align-items:center;padding:0.5rem;color:var(--text-muted);font-size:0.625rem;gap:0.25rem}
            .mobile-nav button.active{color:var(--accent-primary)}
            .mobile-nav button span:first-child{font-size:1.25rem}
            main{padding-bottom:70px}
        }
        /* Scrollbar */
        ::-webkit-scrollbar{width:6px;height:6px}
        ::-webkit-scrollbar-track{background:var(--bg-secondary)}
        ::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}
        ::-webkit-scrollbar-thumb:hover{background:var(--border-hover)}
        /* Line clamp */
        /* Login page scroll fix */
        #page-login { position:fixed; top:0; left:0; right:0; bottom:0; overflow-y:auto !important; z-index:100; background:var(--bg-primary); display:none; }
        #page-login.visible { display:block; }
        #loading-screen { position:fixed; top:0; left:0; right:0; bottom:0; z-index:200; background:var(--bg-primary); display:flex; align-items:center; justify-content:center; flex-direction:column; }
        #loading-screen.hidden { display:none; }
        .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis}
        .line-clamp-1{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis}
        /* Grid fix for text overflow */
        .grid > * {min-width:0}
        .agent-card, .tool-card {max-width:100%;overflow:hidden}
        .agent-card *, .tool-card * {max-width:100%}
        /* Line clamp */
        .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .line-clamp-3{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
        /* Page sections height */
        main > section { flex:1; display:flex; flex-direction:column; min-height:0; overflow-y:auto; overflow-x:hidden; }
        main > section.hidden { display:none !important; }
        #page-chat { height:100%; max-height:100%; overflow:hidden; }
        #page-create { overflow-y:auto !important; }
        #chat-messages { 
            flex:1; 
            overflow-y:auto !important; 
            min-height:0; 
            max-height:100%;
            -webkit-overflow-scrolling: touch;
        }
        /* Fix for webkit browsers */
        #page-chat {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        main {
            display: flex;
            flex-direction: column;
        }
        /* Mobile header spacing */
        @media (max-width: 767px) {
            #main-content { padding-top: 3.5rem; height: calc(100% - 4rem); }
            main > section { padding-bottom: 70px; }
        }
        @media (min-width: 768px) {
            #main-content { padding-top: 0; height: 100%; }
        }
        /* Wizard scroll */
        #page-create {
            -webkit-overflow-scrolling: touch;
        }
        [id^="wizard-step-"] {
            max-height: none;
            overflow: visible;
        }
        /* Demo Lab styles */
        .demo-sidebar-tab-active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));
            border-bottom: 2px solid #8b5cf6;
        }
        .demo-quick-btn {
            transition: all 0.2s ease;
        }
        .demo-quick-btn:hover {
            transform: translateY(-1px);
        }
        #demo-sidebar-items::-webkit-scrollbar {
            width: 4px;
        }
        #demo-sidebar-items::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        #demo-edit-modal {
            backdrop-filter: blur(4px);
        }
        
        /* Personality Sliders */
        .personality-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-input);
            outline: none;
            cursor: pointer;
        }
        [data-theme="light"] .personality-slider,
        [data-theme="ocean"] .personality-slider {
            background: #cbd5e1;
        }
        .personality-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .personality-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.6);
        }
        .personality-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
        }
        .personality-slider-group {
            padding: 8px 12px;
            background: rgba(31, 41, 55, 0.3);
            border-radius: 8px;
            transition: background 0.2s;
        }
        .personality-slider-group:hover {
            background: rgba(31, 41, 55, 0.5);
        }

        /* Tool Dropdown Menu - Theme Independent */
        .tool-dropdown-menu {
            position: absolute;
            right: 0;
            top: 2rem;
            width: 160px;
            background: #1f2937 !important;
            border: 1px solid #374151 !important;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 9999;
            padding: 4px 0;
        }
        .tool-dropdown-menu button {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 10px !important;
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            font-size: 14px;
            color: #e5e7eb !important;
            background: transparent !important;
            border: none !important;
            cursor: pointer;
            white-space: nowrap;
        }
        .tool-dropdown-menu button:hover {
            background: #374151 !important;
        }
        .tool-dropdown-menu button svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            stroke: #9ca3af;
        }
        .tool-dropdown-menu button.text-red-400 {
            color: #f87171 !important;
        }
        .tool-dropdown-menu button.text-red-400 svg {
            stroke: #f87171;
        }
        .tool-dropdown-menu .menu-divider {
            border-top: 1px solid #374151;
            margin: 4px 0;
        }

        /* Tools Action Bar - Theme Independent */
        #tools-action-bar {
            background: #1e293b !important;
            border-bottom: 1px solid #334155 !important;
        }
        #tools-action-bar button {
            color: #e2e8f0 !important;
        }
        #tools-action-bar .action-btn-view {
            background: #475569 !important;
        }
        #tools-action-bar .action-btn-view:hover {
            background: #64748b !important;
        }
        #tools-action-bar .action-btn-edit {
            background: #7c3aed !important;
        }
        #tools-action-bar .action-btn-edit:hover {
            background: #8b5cf6 !important;
        }
        #tools-action-bar .action-btn-duplicate {
            background: #475569 !important;
        }
        #tools-action-bar .action-btn-duplicate:hover {
            background: #64748b !important;
        }
        #tools-action-bar .action-btn-delete {
            background: #dc2626 !important;
        }
        #tools-action-bar .action-btn-delete:hover {
            background: #ef4444 !important;
        }
        #tools-action-bar span {
            color: #f1f5f9 !important;
        }
    </style>
</head>
<body class="text-white" style="height:100vh;overflow:hidden;margin:0;background:var(--bg-primary);color:var(--text-primary);">

<!-- Tools Action Bar -->
<div id="tools-action-bar" class="hidden fixed top-0 left-0 right-0 shadow-lg z-50 px-4 py-3">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
            <button onclick="clearToolSelection()" class="p-2 rounded-lg hover:opacity-80">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <span id="selected-tool-name" class="font-medium">Tool Selected</span>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="viewSelectedTool()" class="action-btn-view flex items-center gap-2 px-4 py-2 rounded-lg transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                <span>View</span>
            </button>
            <button data-permission="tools:edit" onclick="editSelectedTool()" class="action-btn-edit flex items-center gap-2 px-4 py-2 rounded-lg transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                <span>Edit</span>
            </button>
            <button data-permission="tools:create" onclick="duplicateSelectedTool()" class="action-btn-duplicate flex items-center gap-2 px-4 py-2 rounded-lg transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                <span>Duplicate</span>
            </button>
            <button data-permission="tools:delete" onclick="deleteSelectedTool()" class="action-btn-delete flex items-center gap-2 px-4 py-2 rounded-lg transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                <span>Delete</span>
            </button>
        </div>
    </div>
</div>
</div>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-20 h-20 rounded-xl mb-4 animate-pulse">
        <p class="text-gray-400">Loading...</p>
    </div>
    <!-- Login Page - Shown when not authenticated -->
    <section id="page-login" class="min-h-screen py-8 px-4 overflow-y-auto">
        <div id="auth-container" class="w-full max-w-md mx-auto">
            <!-- Logo -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-3 mb-4">
                    <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                    <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
                </div>
                <p class="text-gray-400">Enterprise AI Agent Platform</p>
            </div>
            
            <!-- Login Form -->
            <div class="card rounded-2xl p-8">
                <h2 class="text-xl font-bold mb-6">Welcome Back</h2>
                
                <!-- OAuth Buttons -->
                <div class="space-y-3 mb-6">
                    <button onclick="oauthLogin('google')" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg border border-gray-600 hover:bg-gray-700 transition">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        <span>Continue with Google</span>
                    </button>
                    <button onclick="oauthLogin('microsoft')" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg border border-gray-600 hover:bg-gray-700 transition">
                        <svg width="20" height="20" viewBox="0 0 23 23"><path fill="#f35325" d="M1 1h10v10H1z"/><path fill="#81bc06" d="M12 1h10v10H12z"/><path fill="#05a6f0" d="M1 12h10v10H1z"/><path fill="#ffba08" d="M12 12h10v10H12z"/></svg>
                        <span>Continue with Microsoft</span>
                    </button>
                </div>
                
                <!-- Divider -->
                <div class="flex items-center gap-4 mb-6">
                    <div class="flex-1 h-px bg-gray-600"></div>
                    <span class="text-sm text-gray-400">or sign in with email</span>
                    <div class="flex-1 h-px bg-gray-600"></div>
                </div>
                
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Email</label>
                            <input type="email" id="login-email" required
                                   class="input-field w-full px-4 py-3 rounded-lg"
                                   placeholder="you@company.com">
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Password</label>
                            <div class="relative">
                                <input type="password" id="login-password" required
                                       class="input-field w-full px-4 py-3 pr-12 rounded-lg"
                                       placeholder="">
                                <button type="button" onclick="togglePassword('login-password', this)" 
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1">
                                    <span class="eye-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="login-remember" class="rounded">
                                <span class="text-sm text-gray-400">Remember me</span>
                            </label>
                            <button type="button" onclick="showForgotPassword()"
                                    class="text-sm text-purple-400 hover:text-purple-300">
                                Forgot password?
                            </button>
                        </div>
                        
                        <button type="submit" id="login-btn"
                                class="btn-primary w-full py-3 rounded-lg font-semibold">
                            Sign In
                        </button>
                    </div>
                </form>
                
                <!-- Register Link -->
                <p class="text-center text-gray-400 text-sm mt-6" id="register-link">
                    Don't have an account? 
                    <button onclick="showRegister()" class="text-purple-400 hover:text-purple-300">
                        Sign up
                    </button>
                </p>
            </div>
            
            <!-- Footer -->
            <p class="text-center text-gray-500 text-xs mt-8">
                AgentForge Enterprise v3.2
            </p>
        </div>
    </section>

    <!-- Main Application - Hidden until authenticated -->
    <div id="app" class="flex hidden" style="height:100vh;max-width:100vw;overflow:hidden;">
        <!-- Desktop Sidebar -->
        <aside class="desktop-sidebar w-64 border-r border-gray-800 flex-col hidden md:flex" style="background:var(--sidebar-bg);">
            <div class="p-4 border-b border-gray-800">
                <div class="flex items-center gap-3">
                    <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-10 h-10 rounded-lg">
                    <div>
                        <h1 class="text-lg font-bold gradient-text">AgentForge</h1>
                        <p class="text-xs text-gray-500">AI Agent Builder</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-3 space-y-1">
                <button onclick="navigate('chat')" id="nav-chat" data-permission="chat:use" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <span></span><span>Chat</span>
                </button>
                <button onclick="navigate('agents')" id="nav-agents" data-permission="agents:view" class="sidebar-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAUXUlEQVR42m1aaZRdVZXee59731CVqkqqUgkJkSGBEAQiCS0GMcqghoCNMoggLAcUAZHGhQOKChq6RWy6bSKK0VawRRoVBUQQ0calAssVMGEwCQbJnMqckHo1vffuOV//OOOtskjCq/fuu/ecffb+9re/vbmST2Fmij/2NfwLIna/MTEA4vRSJiL7dcTvEhGDS/cI77O9kJgAIhCB4L6N8JF9yXExTIzwZrgtAKKMiEHpw+3n7B+HuCb7jnuMXb39bviobAJOt+QeDYp3CLdhlE0GbzG/GBA504FAsM+zd8nCnfwNUqNh4p6SExG7n7DSxIBEJERgEtiFAIhLZCIQMzMDRATYzQNufwwu7Qf2lMHE0aBuh5nzA2ee1GJhw8TW2tHeHHfjnILJOyIA71b2LyO1gFs/MxP8yp33WHMwkfFWY45nYX9hLjkM/Akg8elxPkvuKc5PMO6cQMTRLkzELDTOb8Je/F7B3jDlo3Yuyi6GvOMTUue0BvFvZeOXHCIW452YmJE4OgcjkTBHB/QBby3lwpR9wKO8GgAE7x3228wghj1IH9HRNZBsFbAxEA1DqbG8A7g7u9Vz2CISP/FL57AvZ1175hwQpmwRayMmhsAfsffl4JL2NEy6bmaGB4ks+vuEH2828U7v78hsl+ts5FxMkhgl7/3kg5i97xNZOE78yoYyCQNgcIxQ7wYEsTHOzo0j6Gbjlhxs7A0g4OSI3AUMt2n2sc4hcFG6ld0qPAJw+RQESf5AYnWKsO9vj5BD3KUhD/wDDA3nX4pw4giEYfXBrxxaOcRyHsoJyDk0stEV3AMEDjYCQGzPzB4a3G2JQcZeZ9wxgpnZbYA9UnnPhAgl9uZgzhjNRCTOYP5/ZCGIhQjWZxKYATMDhgxKDstCAMMHJzOTgTHsbQSX+cA+wCSJJxCy5Ei9M4R1h3wcchm7oOJo/tRbmETs9/zzrL8aIgaMBRufvUwC3WAPMCCxXucDxbkzQo5xDxTAsA/iMnD7lXtPAuIZMJGwPwR21zARkQgzkzCzIlEkopQAbAAhaK3JaMAQyP5LzGR0gu4BMK2bMdiwC9txecAldntdVspHgZ4Re+rB1tDOowN7i87jj0KERIgFLJzlJNIYGaNajVDQWKveUSdTsAHBAIaMIRgS8dwIkQ06RgAX4vYCi0eM6A5w72XWhA6anN8ySjlhwnLja3sUYokNs5AoUgoiulL73HUfO/kNr2emP/559Td/8L+VQpHR0Jp1QUxgImMJLpgJhjilk2HtzI6buOWYhNQCANeqUykiekBGCaELFvYMIvgM2ygXIlZuh8zEipWSSmWM5J47/7Xdai+/+2cqyz59xSWN4ZErP7WsQ9gUbegCumBLpwHAEMAAjOVAhpjIWC8Bh+xr6SAQqRKMXUIpCbA3s/cacQeCeBosQkQkTKJImKzhJWOlVF4ZHmudvfT0qT3dH77y8y++9PKq59dcfNXn5hw28/Qz3zLSakuWkcpYMogCMbGwKGKBezITi0/lnGQSKhk3+C1Iov2ImcXa3oWwXai9MbNdK7OQCCmBfRgJibBkJEKiOMtgaP68o/64eo3q7JjSO7m3d4pI/qdVa058/TEGJHlGIqwUiyJRYCFiFiYWeARzwMDWekQsxILou8wcQUYoZQSeI5BL+naJMXqJGSL2jixCzKyULQxYZaQyQ8y12kuvbl38T2/Qkh0szP5m02Tq1JNOeH79RqlVYU0uipUSlbEoG/puS9Yo4Q8Fy5I/pZBp3SJVpjpCBrXJ3IWCxO+TsMtQzCTCLMTKeg6ziMrIPj7LSGW58Lp1ryx965vOPvv0VwZ2Te/v+8YXr925Y9c377qns1oxLKwkJES2wIWIbgn35ZT1xURF5RqxVu0HS0rIPMxLREyLMCFPSaaynEVIFOxZiZDKqGgjyyuz56rZx7YO7r9yweEXnH0Gi9z7i8fu/suG2iGHtl9Z2960no3hvIp2i2DEVm66gNa6KMgUFmQZtoYznhrApzXD8VcQjFJZZ3C7YH5LJRxoisuy7rglU1k+NNpsjTZbba3zvFqvgwVjo+ro46qLl8iUqdi1XfbsePKR377uqCO27Np369e/09VZgTb5kXOz1y+kZtPsHqBqVSnVbLVHG8OtZqulTbVasQDPFJYbaT4DEQZ9kcPMmXdwn7YS8B9fmwmzUqzyoWbzzLPOOGPxyaNjzZ8++uT6v23omtRJZ76bpvS3nv099uziLM86OrIpk2uVvF6rZn29NDJc7Hyx/ddV3D+jtug0OfIY/cwTjaGR2UcefvG575jc3bly9ZoHHnq8pnKxOcrSZ2PSCiYw75AKQBAfAEjCw1fDHnl8fAurbLjVvnXZZ7943Ue27dhdGNy3fNl5Zy0embcgz3P98A/Na/u4c5J01PNq1YiICDMbbVSeU73OnV20f+/oQ/cKMDb/1DMWLfj5iq8RsPZvG97/niV3L79Fs9g86GwqSbXEE7QGYlvQwNfpIWyEo/7hD41ZKTU8NHLOe85666KTFp/7YdNskaGHHv/Dj++4edW1N+/+68p8cq8hEiZWak9jiJrNPYON+tiYGRvbM8g99Sq0RqVKWd566jfdvX1f++5XP/Hlbzz96yepVr3ne/c9/LMVV3zoom8v/35nZ1VbrkFMImQMgRLpCT5LgRLUD+VbzAzwRZavVwTt9jtOe/M9DzyGVrtv2tSpM6e9vHb9X9a8cvzsw0ZHW1meZ3neFmkU5iMXnfPwD75+1ikL37rg+Efu/vcrLzl3yHCh8qxWyav5UJsPnda3fff+p599qXfWzCmTu1S1+v37H168aKFHOQ+AEf1TqSt+lEWxChSkI2LH9dkCv/uKkKiDg0Mzp/djtAlQYYhYZs2Y9oELz35l68D6rTtJVE/v5F/cdgMM7nrwt2s3bte6mHfYzKvOf8f5Z7z54i/8x4G9+6jdOuKoWVdd+u65R86iWnVUF1UWPTwyc+b0g41hLxnZWDBJ/R6JntsJiJhUlk9KahFfUglH1mARyQJ/lm3asfsrn7l63fad6/6+qUn0yWs+cNycIzZu2X7DlZed987FB4ZGbr760m079l76yVvWbx0YGx0bbgy//PeN9z/4xBtPnPf+c04bbIzc+YVrPv6+f960dYcxOHnBcb995rmRoaFFpyz8ymeuuvn2FXt27lbCcOELK9LA19Sp+udq1Wr9EOskwuJ4JTGJxKrFZkpRYFF5ZaTVXnz6W7786Sv37d1fq1baBp9YdsfA5u3TDj906dtOOef0U7rrtbM++rnJPV1BQRFiFjkwOPirby/L8vyxPz37wON/GNiwubNn0vIvXXdo/5ShxnBff99td/3o8V8/OamSFc0moyBH78Aw0AAZx6otngKAthuYEVAKllHamkuUTQjWBnYDpFReqTRautrdNf/EE8YMXnpuda1er3fUC4PGrj0r7rxl1boNK378UO/krqLQYBZhgDOl9h8c/NjF5yw47pirP7msa1pvbnRzrDk82Jg9//juav7y2nVjjeFJudKtFnRBRjMMYJiJDOxmnEcZR2MJmkASiyBKynOvJjFzqR4A6UJ31auqMfj87qFXVVc3oSKqaLYyJjW194hD+jds2yGZgvHiliGGgTGi1Oad+448pD/r7VFAu9VWonoy3jV5xprBthoamlSv6kIndWwsxiyTZg4lTSQY4i9FpCIuhkK9Ck+H3Fd1ocmYST09NWFTFDDapnc91hoaGZ06uZsKHZIPfCiSMX09kxpDw8XoGGtNWhutdaGrjM7ubhhjtLEqhZdMrFznFD6eIIvZrUhCmEATGgUoqfilz4vREa0ytkWJgU2cf1y99sK3n2rGmplSEgQ0YaXEjDXf/bY3/Wn1Wiq009ktq2HRzaZTLqxyBRPr3yjxOypX1qdZOJAeDt2KibuF+yr82SmFgweyjm6wAACMLorOzvoPH3hsxtQpF12wdM/WgUJrYpZMaea9A7suPG/JrGl9//PgE51dncZGJ4FEpLObDh4gyShZt6c0VsLgMgFNLQmV5V1IavMoyXk2aismd0evF7HK0BzNTzip2LieCs0shpBXKq8dOCi16u3Xf7Ta1fni+g37BoearWLypPp1l7/3lo9f9l/3PfL0n1dNqld1q03GsDbIc3XsicULKwmGANIaxnj9GY4hwHCi5jIHngAiyuBh1imOzKW+Erxr2dtZuQZEItQ4aF7bVzluoVn1DNXrKlP7d+/78Ife+4UrLlnysRv+5bLzfrH8pn0Hh4hoak/337cOnHX1l37+n180Ret7/31/39TegplGD2YnnaoHD6DxGlVrpDUJEwlpDXs+ltSwcQ7nQiMs3om78DIEl9V1+BwN19ixorcVm43hSq148dnGrKOp0aDC0Fhzybnv/OaN1yy54vPPr157+YsvHzprxjGzDxdR6zdu2bJlOxFdfP0tT3zv1oHtOx998DdUrdLoMGme9MJKznJoX9Fb1cgpowDF/zxOGiQNmSxIpVH4im0JnzLYuLsZ41pHRpPKGzsGLlk0/8y7bmu1Wn9Zs/7Gaz542We/9vRTK6f0TQGwb/e+32/fBaJ6nk/urCuRlStfuPhT//atm66bOqVn4bFHdXbU//D0ynufG6jnFdYaBGhDHtPgewcheTmdwsu6dkk2E0eu5KszX8Jb51PKaakiYGGllFLDzfYdt98057BZK+79uWTZjdd8cOPA7vdd/une6f3tdjuoqggYB6pU8n0Du1Ys//LbTj5x2R3fHx4Z/cAFZ+9/7eBV1y+rKTFFm4yG0Qxy+pctykxAQlhOYcUYJpBxypzVjmJjMPS70o6G12ihhIaHRt6+9Iz5x8w57V0fIiUE/tX/PfW7++5846KFq19c11GtGG2IvPwJx8+GGsPzTjjm+LmzT7no4we2bCNRD//kl0/88u4Lz1/6kx890NlZMwHonIcYDh0CpMVAdGxJy7dSpzNqScQwHBMCCECz+eY3nvjo755SRbuvp7uvt0cPDj/30suL3nBssWc3N0fJaGMA+wcEbbg11ty75+T589a+uvnAwO6pU/t6uydloh549HeLFp5ARcGRARhYImTC+Tmf8n4CL0iSeGIKjly71EUjsotwZwoYGEPMm7ZsP2HeHD00PNYcGx4ZwejY0a+bsWl/o7L0vXzYHDCjOUojDYw00ByFsBw+Ry05f/PBkcOn91G7OTw01G63isbgguPnbd42kHoIjGHX2bEd4iDR2TrekLWKdZVqbTolEpDvXKhQB7tszUlUiECUqtQe+cl3Hv/9M9/94U+zLPvMtZcfO3f2BVfc0HH0sdnsuVzrNK0mRkdYmCtVqlTRahUb1w+tfeH+u766bWD3stu/1W4V77/gnI9cet67Lv1EY+/ejElrTcYQdCSeTL4i840/eFpKTlaZBi+cJFlMBUmdJXMxL67VxyyiVKtA34zpX73p+kP6+5SSVzdvu/G2u8Yaw0q3YQx19XBXj3ROIhaMDJnB16hxUES0KFWt3HrjtXNnH9ZutRvDIzfeeufWDZsqilEUTkpBwpwjBBnPCeCg1jpOrdoPl4BDv4iZGRwbME7JsL11WyGAJcvahtrton/WTG3M/p27qh0dmVKGWIRNAEQiq8OBhaCFqNBmbHik/9BD8kwNbN6WZaqaK90uGNqFo9HRxlbl9anLcuwY1DBcq/Y7ITHkYFYOVcVRPae8hnaTF+2sPNjWhlnleaaNRiIMM0eZ1aGeL8tFpNlqE0wlz2C0KTQRyGgn+hvt4JLKGcA2R0LzGyBGVm5wc5CQ7P4QGkvkpDrrha7SM0abtj2poqVtLR1mEcZDgW28woBgClIEIuh2y0OMAzqGAZWnL2w+MfCdKL8BBhNlPkv7sHdMioiIjWV3VrtkGJBLyQTWxMK2wwICGXbCUzyrBM4jO7SWi7Z0DRoLLNEzYlsmZEH/b1JyWTaqOtLxmURA5TDBwezGMkJKYUeuvDZgl0Wxoeor2oCFYTOgVNy0la6rdym8hqfWXgP1Omlg1ZY2AFnCfYJ6FIdRCKCS6uIYHgBmAUCGiDUr8W0hf2m0NwXe4toqsTPJHl5AwTGQNvLCVxIT+A6UlUhVlnWkPfokXku9eN828Eoql6Z/AoUNLpCOXjCIyDgvZ8dlOHiFhXmg3FlnL5yE/h84+I8PMXgXigUxBz0MIJI4IsZJ191p2ZHGhnRvh5fGBTB7ISSt79g3G8eHCryNieLqYwcbSZCCAKVUPTh37N4E7ImN14Tthd2mEFaacCKmMMwEjkwdHBeM0vpSvkYhEnwR4JsD6X7sj8pURyo5cnoIVJqLKI2mJE185tIIYArJwQfSWR6U1p3U2Rj3JhJUQTK04Yoz+zSVqQ4kEkhqcSrX2HHQw1dqruhMJq1itIV5pxgYSddinFbgKb47ZATYQph1odJoUhSr3QmUJ2qSAcO4AaSO4gM7wBkj8QEu2zbJSChnKARinzQAwFHNSt+cODBFBF/QUOjH8oS6gG35Y00hsfwJQzlhWsDuCUHTIzhBId2SRd6w2UjxA9NEkk/t3hBpXGoaInbzQnESMEx2+Jm7pMkRbMy2TjJRdQo+Dv4Hk5tB60D5XST4E/INp4JacqyweMDlaRvKgjHTwc70CX4OLp13JcAQC8HEOVzENnRwd2YuBWBJVSsHsRcg/MPghRwOsVCaUfNgEmCUE16QCFspmvL4JtUEBS+tXuExNOJpYmJKhpgD3wzRgXGDoH5toAkGUErqJbRMGjWcAGjILuWrKMmcE4ZAS/MzmNDB9nnAkgtKVLe4OfjUUQYwjlO52biZ6ZJZ3YwOfOPSTJRM/XKQdIE4DWqa8HQPOxS4U5iqRKSftmGczmtG9PDEBkycpXPiiaMT0lGzdD543Hpi7gghDnjmkcSiR/eIyBNyWeJQMn7TXBrkRpR5s+S9f+AYYYIT4wf0rYLAHq3GdXHLHs6RTLITHlD+EGlYww9VW+MgyUtxCt/f4f8BNWc7mkl0R90AAAAASUVORK5CYII=" alt="" class="w-5 h-5 nav-icon"><span>Agent Hub</span>
                </button>
                <button onclick="navigate('tools')" id="nav-tools" data-permission="tools:view" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAR50lEQVR42mVaa8xmV1V+nrXP+37fNzO9TAco7bQBKmgNtwClchMRAUFAioBVlIJggpqQcgmYECVEQEOieIshoiYm0ER+WISSAsGWqYIpBRMJRg1IUi7pgIW207l+33f2evyx1t5nv9NJO/NeznvO2uv6rGctbm0dIQFBABkv43/Ev4xXzH8BKT8jwPhYiu+XzwGAAti/yxcC4ADbMxRfaXgd35HMj9udlj9NSkFT/DAvUBcOwyn6jyBAEhl3R74jSSiOLwnxFoQBENsD44gkZMo7SiIYj/R+WcoWWovHUAjJuOiXAMFpkQ4byhzEZugjpWbJ39NAKs4c904JOeosjoFFpiY62JQVOre8Z0ooEFToFgQ9T6Bu3HjCNEo6/psCpQ7YLNKlM5BNdBDMYzcfBNk1modpjqS8h6v9sh2uGQbez9sO27SqDY9WOwAXh1fTXhqMgkgClEQaUqimYjaPh8XvSVN3vri+X5uOFIc0dodNx0m3ZNxfItO7l/tluKpH29SsqDxiuGAqNq63Jqr1i9TCFyBpmQLimnDCZpnmBSn+YOL4Uuin6raRkFpTu/lmkAo9IUxNN3FydL22dwZJEGmgDfbj4GfLgQHmVcznESYKEhcfC0G0+EK6U4gWIhKLLN0KYRQtDx9ioOfAfhYC1jRB0NpJ2SWX2pUtiLWk4h5U8Z5LeHSxMs2GOZnJdPz1EH4i6OCSnvLPhOa5S66kMQ6bwWBNDnYH607NOJgAIyM5NHkyCZCCczM/RMyAgjzspq5FOYfCJIjhLpLSN8JM+dhp8dAlCearHgzNn22pbmRGqIV9msQkXKnQSItGuPcqkvfVUL/Orz3WnujKAoANi2W68gidKfWcOZHKYLIQj8vBTM1tsnS1IIuzhXSZXdEObySIYqlRCJJC9QDlFOQaqpRntQRpxgwVb5mZITeIcG8IE5bC2bIYw2iREtJ/NCQdLGFastJZ3MJIw5I5jcbFXyXIW3oXJZnRAfNelkSD+yYOIEFl6KbtpVYrgCmdCqMnWQZcSj/iiY5zSqt0kVtJa6FCg/XibUvQyeHNueMkarjHAImKDB+qVQt5gUv4p6RhewDUpCFbNdHJdPd0bgmUQCPb8TI1USRo4f20otA4jTSaiTCy0Ko7ISPn/X3I4QY55PDw+TQ9JGaIquEyQen+AklvZ4i3nAgOXpVnyHzSEAItIwS0IY0aMhhsSb5maY2yQimllLN7e/u7dXXhof29GXt7F2wf8N2zgEugg0aJkkeagREuUIDH/QSLTNX8sCM6xRGnFDeqc4ZDpu1Weiwdo8PrpmMQMIPZkr1pMMO0AqeyKqf2/eonPuHdv/3aRx29dH9//vhn7vjIxz55CKh75+gEKXeIFOEZvjTIvXmBCMmYvhcBxDHrs0zToQWHpdDWMybMIv/kYYywtAPNUKa4ADSwsBjLxGnitCplOlv9KU9/yq0fef+xr/znRz5+63/dfc/bXv/KJ179Y5+846s7pciHFgSZPEJIjkUpMz6zRDEzOBOYkds7j2yA2Zo3mzigg+biG6LHV1YI0orMANAKpglWWKYyTadYjt30oZtvu/NDf/HRAxcdPLu7d+jIJf/+Dx962wf/5nOfue0gve7tep3hFRJqBVz5IhMupPyw/5eB7VL4WAPrCfcTDmjAkhzyj0GMc6rHgzHMaqt12dqa1lurra3VemtmedxjH3PxBQduuvWOSy572M7W6pGHLzj5o/s+cfudL3rWU5xltb1TVutpWk3TilZYJsAY6T+sit6ZLTW0Y9duuWmBIkNn1qEDIqtmYKeLZ0BbyXRkhWXianVqz+v+DHOsDOLx+0+eObe3s5rO7O5PhhkO6eDO+u7jP/LTu/dBvlcxO2o9uI4AKxQDMGRFy2Q1luIGkVpDOjWYwAZCDb2TaM5HM8GyBct6NS0eNU22Wu9P6xc+79qjRy+tIsxodnp37+GXXHTja1/2tg/89cMvOri3t3/06KW/9pLnfvifbr/+ja8+sF7JndT9P7zvn2/7Fz95KqoyEImIZEEhKgRPFEGDHHlFwvBJHUkuRWqEawyVMzNMs0MUByOtTKvVyd35da966e+/5Ya7vv7N7a1VKMxrvfNr3/ifu49vba1dAg3VP3bLscdd/vCrr7g07n3u3N7VV1357Kc9/l2/98cXTGWeHU5wXpRoBU6gprwKmyxoYmqoJmHtgoHZ2zgQEcFIxSTssZZtrXp96hOv/vjnvvTud//pdOTi2T2AjU3TZHZoa+0+F+r0yVM3vu+vBJM7VEno5OmXveYX3vG6X9RqLT/XkIBRkPdjhFcZmuIDukV9m1qsjN5vrYUlQC3xPQR0pCwrGdDTtFt9vV5Nhy84cmirZn9C0STVeYZXyQke3t4KJkBeCnHCcHBn68zuHkqBDGaoNV2cbFmUge3TfXpPo6WpTw/R2N2oEz9qJcbyPGap+mKwAivIylZmm6p79WR1hMrOqbBAqF6T7XHBMFdJMDP056QePStruH9rkRsSWhqbCWZDhY3eYgN4pvfT5FocyQpLKdNkZVXW62neG3JviRY79JxtmpE0uNNAgWYQDJpmmRmHStoSSmDu9jc8mmMOfAFJyKfGlLAjqmyFezmMYjzg4oAPZZpOnN1HwWTTfHp3331lDq8tCcYDApJbh/hmE4AfPXiKVkrhfHZvFtwFK2HYSBtw7zoONioZrrEFBwBOWS00wCQO4DlQky2IraeeE3v1upe/4A2vfvHFFx763Je/fsnFF54+eRrV5a7AxraQXMp0XESenuvv3PDK655/7aqUf7z9y2fmur2e4B4RBYqKvqojMbXsmcifNCkL9tSIl0Dl2ZQRAxOq7HTSuDQr5cHd+b2/++Ybrnvhn330U/93/4mXPffpL33uNTd+8O9Kgdc5Erkq2K0HmtGKndivf/u+tzz+qiv+/KZP1+qveeEzn/C4R/39zZ83n1migTbBw50aVdQCN0MXLl+Ytu2DVy7AIdQcxEjWWmNEGAvNYMWm6WzV055xzc0fft8zfvXt3/3Wt6ftrUr7yauuPP6DH9Z5n40sjF9ZKeG2U5nuP3P2V17+s+958/VPvv4d5x48weplvb7ysiM/uOd42dv1eR/zvuoMd7mn1iV5ldf2iZAWzgumyG6JC9CQYOtfFzRB0kyAGefTu6/4uWd++thd3/3m3Zc94vB+rbDynW9/r5QykNqMRC3UBrQ079eXPOepH/vsF8+ePHnZhQfnefa53vu94yt4KFtaqpAUoE0Ln4iBvUyYqoY0E2lnrYJZI4KUbbwtdkR1I+d5hly1BjAupdjIOLggJyB3rzUCA5JLRsIXTvXcfp0dCTvZDuIVUQ0bE9AA0GYWStV2/n4hSRsUTdrH5YiOyd3L1urWY3e99HnXXnLF5d9/8MyD5/Z/eOrsoUsOzyzjmCBDS4JcXr3WyXjLsa/8+kuec+jiC+954NS9J8+eRXn+837q8CMeNrtCc1lzWq0UGhPaaHdtUNFWpvVF2ciMoZs9rkXxSgjUauDWzs43v3PPVY+58g9ufP29p3cfcemRd/3ma/7knW/61vF7v/bf/7s9lY7ge3ECKWFna/W1b3znyVc/+j2/dX0ln/akn/jAW1//G6960RWXX3rzZ/91x7K3TJYr7rCQ1EnrbpD1UJnWFzXM3fFcVKuSCCKzG/plArbX61vu+OrsesN1z//5Zz/1G9/9/r0nTh05fNFnvnDXgZW5N4s/RJT1ZJ+4/cvn9uZX/Mw1P/6oy2/69LFb/u0/XnDtkz76qdu2NGvez85R3e+VCdU9O7JF/4LA7YNXtCpsDSFHqi1gyU+sJJSwIgFWbLWKUsD11oEDB07fe+KP/vCt02r9zvf+5eFtq7UuxE6LLpqJFknugVPnkv85c+6Xb/ilN77yBS9+3dsvrOd8rvIKSV4TCdUZqgDkDq+ReRA1PrJQ9uKdPoFgBsGlpKi7GC6gwkoQZHWeL97ZAlF8f/fQ1vZ6NdeKeQ9aB5eYPE9OmygHKJFyHD6wDgr2AetIia0cpQXayCNSgrfC2qYh7ftpaMc4uJcBkiocLESk2rgo/btCnOdKM2Ce9+bq6krKRNc586hH8rAASPcUtM77qHMDcYK7vLLPAIL/8eaNUlTptCoIYmrU0eBYjWRl1GYtc4lO/cqdrFCRLKwZTGEpNpVS4Yn8wKHb46I6gZQBhSTp7lGeAjEv7C0cXjlYg5uDR0CTgs5ekJIB1mK6RUcwcGqzuT5H8pkusqDO2ys7eWavnt69byp19mRCgyckcB6zz+YVp86c25sPrFfYOyfWzkVDLnieuA9ggWFGlWloGk+jBZX3YZRD4UKWrLEEdxnAYKMcTtN851e//v63v+nxjzm6Xk/j/YKM9YXtGTt07e7uP/bRRz/1+S9yb5crKsuNoApvfUhKophRJVLMG4hbO0eZcwpTowqD1RABK8nJZUEYcpRZVkMrLNOeTT/9rGuOHr2sSmZBMSWiUFDz0Yw3UjBeG/nAiRO3feFLOnUSdW5RFALXRmg7BMRbQHK4twmOc3vn8uRl+0ApuqeYdpmBpTUGBEvMD6zECS1xhxUr5fTuvqsB+sbLNw/oSMThLQ00+uTgylBnuKRMA2pcPDNjBtTAcqRm5CnbAYn0YXqWM064o1gOW7UwHnI13GNBxTr80LoshOnSJ3FjCup09wSsEmTwWud9uTMiV8qWsXPUGkdKmRfic0lTm4sELloGODkEEFTnhNluooOA5ZIAzOJlaGuuNUm1TrqE9WidJAx418RKeAw5O9hvkcYG4obepA/pO7BLC2TxoPr8a6kIra2g4JBxzFmZ+NgGW95CzglQBaoxFZM7MoV7rj64L4sRIBafiWZAI5XYZ2pobtQx+7Sx/tGt0+a0jRIVVBlwX2gEmkWNVKw4xNjEK1CDNWINAhreVjrSVvEnupbIs1G/QuVycBT6vK0TKXNAumaZVofGNrkPBdo8vrWmfQthuXvDWzFoaXCN4QBxzmijwkm6Ut3hgtdUUbRXWBA/N6C/2mpNz0jqWysA+gE21j24zJIb7UWDlhWLvm6gGCGy8eDjrWIXJyXr9V8t2Tew2douSILDnX38CrUa4EsoUxwI3uEAS5kMDr2fggvKbsP1VovUEJL13adkZ5qz9bMkPHJvOxFtTyXtk/V1GGmGrw+f5HnSD+OYkzqHE87QNnbYZs658SDPKTK8sX6ebCsJr7mVEQyPGv3ajtj0hw7T2r5E+lJnzhuAzQM3NLrhSFwIU5XVdHDYPeDG3lAnfYf5ah90c+zthL5PkByqu1S78siHbIBlAHhsh2x6mjC2LMNPhmjJt9OwkKPhKd4nhpstXHcSizZxGYLmvhCExb6CU9xQ8Ii8BlmlpUvsTjI6UneFRghkqZvGIfe4cINxhSqXj3KQmSBvWV1iwhLYAjMbeu4t3pI9pcWPlj2PRcqNIrCRP32zpAW1yDEl5GQ/ynNLmdanVdk5dC6v7Wo1h1qaYKYKDaxZ5jUuvSk3oRIBqy0Ugl3l0qYrPdTBCHmZyoFhC5BY9vfi7jYcdwA4jTXJDq8TMyOJ0O2cmlta9SV9YXAbjFSARo9qcDoqt8bea+qRO7C/seHTh219H0iA5UJD32NBf2TjlHIPJncam4je8m+AB9fg+Fwq7gjdYkqQNWGgp5eIWtYux73TXORA36fKTdB+k4yWzW3XhYpMbWiRaYksBZPZv9UQvI3V2ggJdSzE86XvLeWwK9m2VjUA4LZk4BgGgW3DRS3d1ozYxmNIc+PCNjpCaURnG3tlQt1woax+PuyjaSO1dBda/IRY6gjt/AS6rDxaZ0BiTagRfqaxYLn6+t3Y2y67ltpAO9iouG1vmYuhliWOgXIp07TTeOlhJYhj99DiNSuxeF45ksYN1V6FGxbCMPpq2uWySbCRJMZpfMcRC8hbtqa7ZnPE1MQfxUnIE8UhuJQRwrR1yN52ezQuA4uNBeH0RfAFGozB4Ysx2u04EKBccunmPmbbG9WSUQbwtaCoXNhVX/Nst+3BE2tWtS9f9qgdVtJ9JGUH3KIGzpeVdqo3kep7K+POVq9/ZZoOjDMxLisG5/Fcy1Jpi3adtyN+/jstdtzE9y1wh28pCUHp6SGoKRXAjRqcz/t/IY2ITnCjTaYAAAAASUVORK5CYII=" alt="" class="w-5 h-5 nav-icon"><span>Tools</span>
                </button>
                <button onclick="navigate('create')" id="nav-create" data-permission="agents:create" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAASz0lEQVR42m1aebBcZZU/v/Pd7n793svG5oIYAUtcWNywRkURsXBFFEUH1AooijrKDDgIiFtUlNIBHXRgym2mMguKU5aKKXRQoBAEghAxQgScCCJZyPqW5PVy7/nNH996H3bSye3uu3zfWX7ndxZ0OstFRAThnV+IX4HpJwj/yslIp7e/CW+SKH9hPCZFKBBQCKEIyHAKKQDJeCeEk4ur/R2qdOjfKBbG1k+IC2L8BWnp5a6YFkkBIEJAy+dSwn6Y5UAhAXgpkP6DqMAfU/zG/AGFcZlA1ZJ5Xn0SalwrvITBtEjkDaR1J0VEjQFQvxuS/pxwp7AKkiQUIsU9vD7EQDF4tTDLAIhbEmElgqA9IRdbkf+RUdpg+t1LPe6qPKIQorJIj8XvXiH+BUHQXyk4Fh+88ki0jSdog1IFVUtp1UhSj6uHP43JIpNjRD1AkJfKqOZgEgZC2k9B8hmW/7HtK+mK7A7xPAYTWrRqeYJ7ZuvPuverjmYITfsksv8HaTLYm/fL8hnwX2bIYPBstPcSRMxil4wyZSVPfPknQUCmh2SB+SOoPzOo3CsbKM8LrqmaV5Yu985IChiuYJSuFzGtwCsA6m0c4T5e/xSRahG6hfsBScCEBjD1BhxV4X1AoMGtATxhlwwnR1zJBkJQCIg4CoUWnhoWRyCiRdRgVHFCy+C41SJXKzxUiLQTf7kGd4VGv0FQhViyeCnNzCMjrW2U0UGSOKHeI9O+mfC68MOMYxEODNmEkEJGkEW5IA/KUohYEe3Mn+8kaU7CnikCvz2okAxgHw6jUXvDSBBl3oDT9UKBIoAwAAFhYNiiCKrkqCk2McI8EtgHaab9aJAtQjBCDoIK1SySHMwJodCCLflteD8Wy/7pQx6b+DhlEbej6JUQiGUYbbMAib4Ib+LJoINSoQlEol3nMAfnIgQByT1irBUDRAL0WBPQQjRGWEb7Vb/nyFtACERJ81EchW1VGZe9TXpXDFvSQH8Yfgqmm8wkniNQUQUgqgIFHFShAJRmJEVIawgTkjShwAnNPINIIVrMJCBfEQOSehDcIJgMAUhVwj7bS/fAEgXj75y+DyEMAoESAlVRB3VV1aG6UcOxsWlMaB3nep2qo9LUtTWNsKEZGSxJaGFlJJwTkmYAg/3QEAO4hxUGn/FmH7lQNBj/p1h9lDcJKIAUqqJPe0NSFXVadVl1ZwbjTr962jMOXnnIU1asWFaPx1u2Pv7HPz265/GdvV6n3+/Vw4GgEWtCnDPvSkywAxUa/ZoZuISAiYAlQkiSFaLLUyKCSVis3yVFA8QjBVCIPwEQVUAFCufMVf0V+5311tcdd+zRK5ZOD0f1zOwcoEun+91u5/cPbPrO967beN8DyyYnbTS0ekyBmImaCMUIMYloKpGAetRCINSJ/2WWjYnuAQKxHLw0gEwIXt5BC51ABE4EUIhzPhRAnXa69cTU2jVX9PqTV16z9obbfrPr4b+Ik06lnap6xtMPPvmkV5z86pf+8rbfXPr1Nd1m7JpRPRyIGWlCIw1mQgkfvdMzxDLxSEXzzCp+SYq4qppixEp4OPc44w+S5BXQuBnnolZURKAOnS7UuYnJbr9fG1/4nMNOe+0rnv2sQzdtfnzfwmjZ9NT2HbtuuuO31996z2lvOOHs009ee+vdCwsLlcLMRCySaxYEvsTtRVQTJeGJG8ioH/m9B5ZwsWYKpE4UIQaHTQpcBXUw+/X6+39x+/ob7rz395seO/LZh1909ju2zczes3HT0n5vsleNh8Nrrrvx4KccdP77Trv+V3ePBgPQAgfwpkgLviiReaCMAlxE7SBwWk1GWowQAcJSNdGi4BJQ0aiW/K9Co96Afq/TATlutj2+82e/Xn/Xg3/+p39873Dc3LXhD10QZv1e9+77/3jm299w47p7Z2dmnarFVDHFkgAp2V9LtpDjmsdHFR8+y2SAAWQytgaRg4kvqANUtIJzqCq4yu+hNjYGG406Vh840d14/0Nv//jlHzvrbYeufNrQRFSH43rlUw5asXRq+X4rZsfSdHrdyUntdlF1RFWCLCKXkRSU8mLQIjjiXDUZ7UdzdoKkSYVfvagoAM8UVKDiKlFVdXAuPhjodEUVQoEjadCXv/ioQw8+6Nqf3QIzUjpVZ+vO3Q9sevSSD51xyCFP3bp77tGtOyZ7HYEyBWMPiplf5AQ8IHuRRDhXTXs2j+y+aaPBogAVTbHWESKqUAWcKFhCari3iqKqqgXjt1efe+2Nd96y7nf7LZ32uDk1Ofnbex885ugjTvqbY153/Eu2ze576OHHOpVT52L9IoaqmMsjMeMi6fGKcK6aiqQrGB+DffuVazCngPcQV4kAGkyfSGoRAbTT80mM6/ZM3b6x/Wnn7CVnnbpjZm7dfQ+Jc0OTPfODf/jQ6cc9/znHv/uCjQ9v/trF53zv+lu6E73DD1u5fccuFdIaD00MFDCmbZFICHPBpPKMlQnkg2uW5RTGlDgWAMJNDHA+1YA3Nld5cVWdzsC4fP/l16w+96bfPfjOz1615pMfWHnwk3fOzL3l+GPX3rHhbSe+bNUnvsr+1Gte/qJ1v39o+8zC0Uc+662vP27dhoeWdoG6tqYWX6wwZeDYOXvOuSjgqmo6ZR6F+EVyHBDvXgGmFIgBGKpwlaiDBC4kAld1xnATK1b86MpPXX/H74469KknHvu8cy77zntef9xRhx/y8zs3fPmjZ7xv9VX33rPxjLe9dtXJx3/osu/u/6QDPvquk997ygnrH96yZ2bORkOra18agIA+vQyZXMgSUknJVcEHEDfhV685XQkmLoAL5gR4r4U6UQf1puUA0apiVVl/8if/8pmf3HzXV7517fW3r3/uMw7+yGmvfe/nrrp27c2337NxL/HBU0/Uie75737T+1ZftWLJ1HnvefM5p7xqott59bFHzewbbN68dW7PjHiumqsVMckuYpmX1xJhiAAiKqoi3l0jiikETqBINA4qzkmQunrzI6CuQtXZh+qHV376jrvv+8I31jz1wBVWNw8+tm3Vya+67sY7Rnv3Luv3btvw4MK4eePxL/7ct3/4yBB7ds78zy/X7RzUz336k0/4wGduvvHWvbt2STNmY7niQ6ZAQYoiV7pc1ZkOhQAPNdF5GTN1SX8FUCfOiWqwmQhT3vtdb2KmwZqvXLhl87YLLrv6wKWTZlyo6+99+ePf/NFNv7rzt1MdNxoOJ8Tu/cOmH/zvbdu27Trs2Be9aNXpW+57YPOjf5mZm/vZDbdM26geDljXCKU2ERKMhdQyQxKK0FWdJQH4WqkKI8XWnLJICMkxAKvnQqoefrp7BvU/f/bv+5W8/6Kv7L9kUhXbd8994oNnTEz2P33lmgOn+uPxmPWYZv1Kpyd63U61Z9v2lS97SdXtPHb77Tu2b597fKsNBzYeiTUBP1pkQtofKSLoTjypiGIS4JJSaMOJhihGUVEfhgF19Cer9vqTO+eHF59/9nHHHHHKBz+1pNepqmp+MD76qCOu/uy5b/y7zw9m90hdW93QGgpVXQBiV9XiJiYn6tndHC3UCwsyHlkzgpHW0JqQ5pNkQ3onplggsCKsynIIUp1Zc+WNZHDrVHL0tRBSzETR7XZ2zu5d9e5T3/zKF5+06oJJpxBpGmrHXXHROau/+YPtW7Yum+jUde0BkWZWNxATKKAKDGa202ppatZjWiMiFBNPm6Pz+owzHoawRYacOL1RFCVTW4AkA/BqrAvFV6fT2T0/eM2Jr/zYmae+8awL68Gg160U2DG396ovnHfXxj/9+PqbD5jqjgaDkF3TnIM1xobCml60ZmINrYGXt5lYrkSRY7JVI0qegFheZ07SQwmzKPql2rhXEBm3hqrTnR+Oj3j2M796yYfPPO/zWx7bvGR6SoAdM/N/+5aTnnvEYa8/5zP7TU/U41G6DyjWNGKNz2BCKmx+3QElGVkR2BRhF7HJkbDV10ZjSCvQlrEiHEJsKJ+Ez6QZVJ3T4bhZtnzZf3z1Uxdd+o2712/Yb8WyxprR2J55+MqLP/yu0y+8XBb20anVdcik/LPMJIWm8GWk1CSi5SQGEcu6vqqSEoVQR9VQpaDlHo3GyhrDdSDj5unLJICSbESu/eZl3/2vH6/96S/2X76srhsRGZPfuvT8y9f85P4NG/sV6rq26I4krRnTGtLEYn2F6bYm7SIK4IEud4CiGjNTTaVFZXbSlLKFSkDUojdMp6paVbPzC9f82xV33X3v1d/4zvInHzQY7Ov2ert3z339yxdvfGTLmv/+0f5TvdFgGLYdyzlivkZkgRbQfMSNRmHhVPN5MFNrLBmRdw5ftqBIhcU9gYA6oQqQGWyqu4g6Nzs7f+nqj8GaCy/+0tIDVozHo063t3vnnjNXveOo5zzzpFUXLO9X49Eg+qKv73obCIulx0EzocFnZF4PZknb8SDnCbHdkXpsrIJveOoX/MEoCl93KFtXFFDUYWEwfP4LjnzpC49807vOXXLA/k3TVM7Nz80f8/znnf/+d775/Ze48VAc6E0/8XhGQ6WQja+WkmFLvrIVc8tcdqC/qmjj5G4CIKRmip2dBsCijhPKeoGZTXQ7w+F439xeoXS7nbqxqSXT3778kxd86V8f+b9NE8p6NKQFfJRmLE3DuhEzkLQGZojil+gDwqbojDJ7IXK3J28hKlTbXcp2o8nSvoJFkrTGpvq9devWb/rzY9f++xV1Pd69a2bvvoX/vPqL3//pTT9f+4vl/e54sMCmYdOINWJGIxvz+0lgTwsW5Z2bNFpTOAwLx5D4fRR/Ai7SOTedqXSqBpSJMxBJrI8EpLHT7Vx3w60vfMGRl5x39mDfvtWf+MgjW3d8+vNfW7Z0cjQcSO5EFN1pitBoBkkiDyUq+L9IIBMAF5B29zzBK3MjujvxJMTKT+pQ+MZRTgxSxgMlIFDPnOfnF0448RVvP+Wk+x96+Krvfn+666xphEWTO3aCJTUtglkzCRtCX58DQIugFAUs0U+SZpBCis+Mu70DQ70tZ/EiomUFJZaH4wac83t2VXd+Yci6kapasmTSmkbKqYSWy6W3x3sg4aMvuJuJEIQvLbZtqXCJQGoYcNa3WVMZUoSkIvTUKKIhzqsWj0/1ezY2mu510O9RpBmNJDc7yLI25VlQpGKgBIxPflkexw/F/xZQk6kw7f0DJF3lplCMFkByXinJG9BirCg6fxSaNwCRopmXpCsRzpvYlvXrYGo7ZPDIybsVwJ9xKdCkROxEIFKlqkK+Hy0wCsRzvfGpRo5kcWDB/LlQjcMAJpY6I8Ys1xgac7g0/2R4CEq/mKUWrocrD4iQcp3iIdIn9ZN5+KQg1gl84AttuS3KVGfJDSC2k4dIGcmIOV5FvuzkT7ZI7oUhT8h18zjKIuJ7H8FkM1kKEAvSuWoyN3RjLbTo2iCO+0AS0sXmeorVRXzPz6ZYMcmB5Arx8WGLraEQv0RKq7Ucw9Yiu/KUztdGF5XeQ/E5zTy13SCbW4riCIV4AsHEI4nKTwqcNxRLQtNBINF+uHhwqYzKiQuKFaTIjxqUMxixybx4pCk4RtEtRtS+T/mbBt7UYurn51MSVqQ0RRCLhYF5eWbKEm0zubTkBKFPw2xaAa6c036aSEn5ceRuxSRTwY9AeUITtJg7STbACOEoR81QXJWGB1gIvsU9UzevbWxMFSPnXL9IieMucrcmZ8uxU9Yap8urKXbEaF9FnhdjFpincHIulgJ2mkfJWQRQ1lRym9jvujVuwzAOonH+jr5eJIXRhAZi2e5EKXofIwMUeMAtuisIDbyywhyPkQGtaNJLaqGSoZsWByIACCOM5vma0BXJbc74McdVLHa31j9oB6B0bNYGnNLTJGQLBUwib6bV8kBJ9hlNCGnGJbeCW/NhbXITB6ISzkAKcy+cDJmIZktjew8oV88C4bh4fBIozZahtOj6xWktytCeY1xs6MiTk2mKp3A4thwiFRnAwnqYQkHqYiTzLCCfsQORP2ZAqJitEGniNEx4MI1IMRSz6NtvqcQSn4WU1hVENGpdipFDT5tRtsCYUpXcAG6PuCIjaXG/RSNnaHU0mdBRoFrMwiwyEFoe/2xNV4J5gjGbUA4hLCYGkl1ZHszJZQz5K8ONzDKrUmpTmkkcpKX4yaI8UERa8mYUxYGonMQF4mhcEbvTCDJboSgvpqiLlGtFziSJBFnhWqduAq1RpyLUtdydkdUlU5IWmBSbFD7BfXKkl+QtMXGxkjjkaBAptIaZwZb+E/hWWDSuVQ7V+QnsVqUgtj1YAjlELI9SRRoQQwRaQZQ5Syh8w6JB5aInCn0ByUpZwBhkUSCLMTOvLPBYxMpwcCcm3hzl5AfQLZ4mbYIg7c6KZIYjwvxAtiJaO5QgnYtyRp1VHoBqq7xcIUpmQIsgY5LJRfRXcrFdsSDbOY4wkL1okmiRUMaWJIt5UoZkov36f35wZllthY/qAAAAAElFTkSuQmCC" alt="" class="w-5 h-5 nav-icon"><span>AgentForge Studio</span>
                </button>
                <button onclick="navigate('demo')" id="nav-demo" data-permission="demo:access" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <span></span><span>Demo Lab</span>
                </button>
                <button onclick="navigate('settings')" id="nav-settings" data-permission="system:settings" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <span></span><span>Settings</span>
                </button>
                <button onclick="navigate('security')" id="nav-security" data-permission="users:view,roles:view,system:admin" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <span></span><span>Security</span>
                </button>
            </nav>
            
            <!-- User Profile -->
            <div class="p-4 border-t border-gray-800">
                <div onclick="navigate('profile')" title="View Profile" class="flex items-center gap-3 mb-3 cursor-pointer hover:bg-gray-800/50 p-2 rounded-lg transition group">
                    <div id="user-avatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center font-bold text-white">?</div>
                    <div class="flex-1 min-w-0">
                        <p id="user-name" class="text-sm font-medium truncate">Loading...</p>
                        <p id="user-email" class="text-xs text-gray-500 truncate">Click to view profile</p>
                    </div>
                    <span class="text-gray-500 group-hover:text-purple-400 transition"></span>
                </div>
                <button onclick="logout()" class="w-full text-left px-4 py-2 rounded-lg text-sm text-gray-400 hover:bg-gray-800 hover:text-white transition flex items-center gap-2">
                    <span></span><span>Logout</span>
                </button>
            </div>
            
            <div class="p-4 border-t border-gray-800">
                <p class="text-xs text-gray-500 text-center">AgentForge v3.2</p>
            </div>
        </aside>

        <!-- Mobile Header -->
        <div class="md:hidden fixed top-0 left-0 right-0 border-b border-gray-800 z-50 px-4 py-3 flex items-center justify-between" style="background:var(--sidebar-bg);">
            <div class="flex items-center gap-2">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-8 h-8 rounded-lg">
                <span class="gradient-text font-bold">AgentForge</span>
            </div>
            <button onclick="navigate('create')" class="btn-primary px-3 py-1.5 rounded-lg text-sm" data-permission="agents:create">+ Create</button>
        </div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col" style="min-width:0;height:100%;max-height:100%;padding-top:0;" id="main-content">
            
            <!-- Agents Page -->
            <section id="page-agents" class="flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-6">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                    <h2 class="text-xl md:text-2xl font-bold flex items-center gap-3">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAUXUlEQVR42m1aaZRdVZXee59731CVqkqqUgkJkSGBEAQiCS0GMcqghoCNMoggLAcUAZHGhQOKChq6RWy6bSKK0VawRRoVBUQQ0calAssVMGEwCQbJnMqckHo1vffuOV//OOOtskjCq/fuu/ecffb+9re/vbmST2Fmij/2NfwLIna/MTEA4vRSJiL7dcTvEhGDS/cI77O9kJgAIhCB4L6N8JF9yXExTIzwZrgtAKKMiEHpw+3n7B+HuCb7jnuMXb39bviobAJOt+QeDYp3CLdhlE0GbzG/GBA504FAsM+zd8nCnfwNUqNh4p6SExG7n7DSxIBEJERgEtiFAIhLZCIQMzMDRATYzQNufwwu7Qf2lMHE0aBuh5nzA2ee1GJhw8TW2tHeHHfjnILJOyIA71b2LyO1gFs/MxP8yp33WHMwkfFWY45nYX9hLjkM/Akg8elxPkvuKc5PMO6cQMTRLkzELDTOb8Je/F7B3jDlo3Yuyi6GvOMTUue0BvFvZeOXHCIW452YmJE4OgcjkTBHB/QBby3lwpR9wKO8GgAE7x3228wghj1IH9HRNZBsFbAxEA1DqbG8A7g7u9Vz2CISP/FL57AvZ1175hwQpmwRayMmhsAfsffl4JL2NEy6bmaGB4ks+vuEH2828U7v78hsl+ts5FxMkhgl7/3kg5i97xNZOE78yoYyCQNgcIxQ7wYEsTHOzo0j6Gbjlhxs7A0g4OSI3AUMt2n2sc4hcFG6ld0qPAJw+RQESf5AYnWKsO9vj5BD3KUhD/wDDA3nX4pw4giEYfXBrxxaOcRyHsoJyDk0stEV3AMEDjYCQGzPzB4a3G2JQcZeZ9wxgpnZbYA9UnnPhAgl9uZgzhjNRCTOYP5/ZCGIhQjWZxKYATMDhgxKDstCAMMHJzOTgTHsbQSX+cA+wCSJJxCy5Ei9M4R1h3wcchm7oOJo/tRbmETs9/zzrL8aIgaMBRufvUwC3WAPMCCxXucDxbkzQo5xDxTAsA/iMnD7lXtPAuIZMJGwPwR21zARkQgzkzCzIlEkopQAbAAhaK3JaMAQyP5LzGR0gu4BMK2bMdiwC9txecAldntdVspHgZ4Re+rB1tDOowN7i87jj0KERIgFLJzlJNIYGaNajVDQWKveUSdTsAHBAIaMIRgS8dwIkQ06RgAX4vYCi0eM6A5w72XWhA6anN8ySjlhwnLja3sUYokNs5AoUgoiulL73HUfO/kNr2emP/559Td/8L+VQpHR0Jp1QUxgImMJLpgJhjilk2HtzI6buOWYhNQCANeqUykiekBGCaELFvYMIvgM2ygXIlZuh8zEipWSSmWM5J47/7Xdai+/+2cqyz59xSWN4ZErP7WsQ9gUbegCumBLpwHAEMAAjOVAhpjIWC8Bh+xr6SAQqRKMXUIpCbA3s/cacQeCeBosQkQkTKJImKzhJWOlVF4ZHmudvfT0qT3dH77y8y++9PKq59dcfNXn5hw28/Qz3zLSakuWkcpYMogCMbGwKGKBezITi0/lnGQSKhk3+C1Iov2ImcXa3oWwXai9MbNdK7OQCCmBfRgJibBkJEKiOMtgaP68o/64eo3q7JjSO7m3d4pI/qdVa058/TEGJHlGIqwUiyJRYCFiFiYWeARzwMDWekQsxILou8wcQUYoZQSeI5BL+naJMXqJGSL2jixCzKyULQxYZaQyQ8y12kuvbl38T2/Qkh0szP5m02Tq1JNOeH79RqlVYU0uipUSlbEoG/puS9Yo4Q8Fy5I/pZBp3SJVpjpCBrXJ3IWCxO+TsMtQzCTCLMTKeg6ziMrIPj7LSGW58Lp1ryx965vOPvv0VwZ2Te/v+8YXr925Y9c377qns1oxLKwkJES2wIWIbgn35ZT1xURF5RqxVu0HS0rIPMxLREyLMCFPSaaynEVIFOxZiZDKqGgjyyuz56rZx7YO7r9yweEXnH0Gi9z7i8fu/suG2iGHtl9Z2960no3hvIp2i2DEVm66gNa6KMgUFmQZtoYznhrApzXD8VcQjFJZZ3C7YH5LJRxoisuy7rglU1k+NNpsjTZbba3zvFqvgwVjo+ro46qLl8iUqdi1XfbsePKR377uqCO27Np369e/09VZgTb5kXOz1y+kZtPsHqBqVSnVbLVHG8OtZqulTbVasQDPFJYbaT4DEQZ9kcPMmXdwn7YS8B9fmwmzUqzyoWbzzLPOOGPxyaNjzZ8++uT6v23omtRJZ76bpvS3nv099uziLM86OrIpk2uVvF6rZn29NDJc7Hyx/ddV3D+jtug0OfIY/cwTjaGR2UcefvG575jc3bly9ZoHHnq8pnKxOcrSZ2PSCiYw75AKQBAfAEjCw1fDHnl8fAurbLjVvnXZZ7943Ue27dhdGNy3fNl5Zy0embcgz3P98A/Na/u4c5J01PNq1YiICDMbbVSeU73OnV20f+/oQ/cKMDb/1DMWLfj5iq8RsPZvG97/niV3L79Fs9g86GwqSbXEE7QGYlvQwNfpIWyEo/7hD41ZKTU8NHLOe85666KTFp/7YdNskaGHHv/Dj++4edW1N+/+68p8cq8hEiZWak9jiJrNPYON+tiYGRvbM8g99Sq0RqVKWd566jfdvX1f++5XP/Hlbzz96yepVr3ne/c9/LMVV3zoom8v/35nZ1VbrkFMImQMgRLpCT5LgRLUD+VbzAzwRZavVwTt9jtOe/M9DzyGVrtv2tSpM6e9vHb9X9a8cvzsw0ZHW1meZ3neFmkU5iMXnfPwD75+1ikL37rg+Efu/vcrLzl3yHCh8qxWyav5UJsPnda3fff+p599qXfWzCmTu1S1+v37H168aKFHOQ+AEf1TqSt+lEWxChSkI2LH9dkCv/uKkKiDg0Mzp/djtAlQYYhYZs2Y9oELz35l68D6rTtJVE/v5F/cdgMM7nrwt2s3bte6mHfYzKvOf8f5Z7z54i/8x4G9+6jdOuKoWVdd+u65R86iWnVUF1UWPTwyc+b0g41hLxnZWDBJ/R6JntsJiJhUlk9KahFfUglH1mARyQJ/lm3asfsrn7l63fad6/6+qUn0yWs+cNycIzZu2X7DlZed987FB4ZGbr760m079l76yVvWbx0YGx0bbgy//PeN9z/4xBtPnPf+c04bbIzc+YVrPv6+f960dYcxOHnBcb995rmRoaFFpyz8ymeuuvn2FXt27lbCcOELK9LA19Sp+udq1Wr9EOskwuJ4JTGJxKrFZkpRYFF5ZaTVXnz6W7786Sv37d1fq1baBp9YdsfA5u3TDj906dtOOef0U7rrtbM++rnJPV1BQRFiFjkwOPirby/L8vyxPz37wON/GNiwubNn0vIvXXdo/5ShxnBff99td/3o8V8/OamSFc0moyBH78Aw0AAZx6otngKAthuYEVAKllHamkuUTQjWBnYDpFReqTRautrdNf/EE8YMXnpuda1er3fUC4PGrj0r7rxl1boNK378UO/krqLQYBZhgDOl9h8c/NjF5yw47pirP7msa1pvbnRzrDk82Jg9//juav7y2nVjjeFJudKtFnRBRjMMYJiJDOxmnEcZR2MJmkASiyBKynOvJjFzqR4A6UJ31auqMfj87qFXVVc3oSKqaLYyJjW194hD+jds2yGZgvHiliGGgTGi1Oad+448pD/r7VFAu9VWonoy3jV5xprBthoamlSv6kIndWwsxiyTZg4lTSQY4i9FpCIuhkK9Ck+H3Fd1ocmYST09NWFTFDDapnc91hoaGZ06uZsKHZIPfCiSMX09kxpDw8XoGGtNWhutdaGrjM7ubhhjtLEqhZdMrFznFD6eIIvZrUhCmEATGgUoqfilz4vREa0ytkWJgU2cf1y99sK3n2rGmplSEgQ0YaXEjDXf/bY3/Wn1Wiq009ktq2HRzaZTLqxyBRPr3yjxOypX1qdZOJAeDt2KibuF+yr82SmFgweyjm6wAACMLorOzvoPH3hsxtQpF12wdM/WgUJrYpZMaea9A7suPG/JrGl9//PgE51dncZGJ4FEpLObDh4gyShZt6c0VsLgMgFNLQmV5V1IavMoyXk2aismd0evF7HK0BzNTzip2LieCs0shpBXKq8dOCi16u3Xf7Ta1fni+g37BoearWLypPp1l7/3lo9f9l/3PfL0n1dNqld1q03GsDbIc3XsicULKwmGANIaxnj9GY4hwHCi5jIHngAiyuBh1imOzKW+Erxr2dtZuQZEItQ4aF7bVzluoVn1DNXrKlP7d+/78Ife+4UrLlnysRv+5bLzfrH8pn0Hh4hoak/337cOnHX1l37+n180Ret7/31/39TegplGD2YnnaoHD6DxGlVrpDUJEwlpDXs+ltSwcQ7nQiMs3om78DIEl9V1+BwN19ixorcVm43hSq148dnGrKOp0aDC0Fhzybnv/OaN1yy54vPPr157+YsvHzprxjGzDxdR6zdu2bJlOxFdfP0tT3zv1oHtOx998DdUrdLoMGme9MJKznJoX9Fb1cgpowDF/zxOGiQNmSxIpVH4im0JnzLYuLsZ41pHRpPKGzsGLlk0/8y7bmu1Wn9Zs/7Gaz542We/9vRTK6f0TQGwb/e+32/fBaJ6nk/urCuRlStfuPhT//atm66bOqVn4bFHdXbU//D0ynufG6jnFdYaBGhDHtPgewcheTmdwsu6dkk2E0eu5KszX8Jb51PKaakiYGGllFLDzfYdt98057BZK+79uWTZjdd8cOPA7vdd/une6f3tdjuoqggYB6pU8n0Du1Ys//LbTj5x2R3fHx4Z/cAFZ+9/7eBV1y+rKTFFm4yG0Qxy+pctykxAQlhOYcUYJpBxypzVjmJjMPS70o6G12ihhIaHRt6+9Iz5x8w57V0fIiUE/tX/PfW7++5846KFq19c11GtGG2IvPwJx8+GGsPzTjjm+LmzT7no4we2bCNRD//kl0/88u4Lz1/6kx890NlZMwHonIcYDh0CpMVAdGxJy7dSpzNqScQwHBMCCECz+eY3nvjo755SRbuvp7uvt0cPDj/30suL3nBssWc3N0fJaGMA+wcEbbg11ty75+T589a+uvnAwO6pU/t6uydloh549HeLFp5ARcGRARhYImTC+Tmf8n4CL0iSeGIKjly71EUjsotwZwoYGEPMm7ZsP2HeHD00PNYcGx4ZwejY0a+bsWl/o7L0vXzYHDCjOUojDYw00ByFsBw+Ry05f/PBkcOn91G7OTw01G63isbgguPnbd42kHoIjGHX2bEd4iDR2TrekLWKdZVqbTolEpDvXKhQB7tszUlUiECUqtQe+cl3Hv/9M9/94U+zLPvMtZcfO3f2BVfc0HH0sdnsuVzrNK0mRkdYmCtVqlTRahUb1w+tfeH+u766bWD3stu/1W4V77/gnI9cet67Lv1EY+/ejElrTcYQdCSeTL4i840/eFpKTlaZBi+cJFlMBUmdJXMxL67VxyyiVKtA34zpX73p+kP6+5SSVzdvu/G2u8Yaw0q3YQx19XBXj3ROIhaMDJnB16hxUES0KFWt3HrjtXNnH9ZutRvDIzfeeufWDZsqilEUTkpBwpwjBBnPCeCg1jpOrdoPl4BDv4iZGRwbME7JsL11WyGAJcvahtrton/WTG3M/p27qh0dmVKGWIRNAEQiq8OBhaCFqNBmbHik/9BD8kwNbN6WZaqaK90uGNqFo9HRxlbl9anLcuwY1DBcq/Y7ITHkYFYOVcVRPae8hnaTF+2sPNjWhlnleaaNRiIMM0eZ1aGeL8tFpNlqE0wlz2C0KTQRyGgn+hvt4JLKGcA2R0LzGyBGVm5wc5CQ7P4QGkvkpDrrha7SM0abtj2poqVtLR1mEcZDgW28woBgClIEIuh2y0OMAzqGAZWnL2w+MfCdKL8BBhNlPkv7sHdMioiIjWV3VrtkGJBLyQTWxMK2wwICGXbCUzyrBM4jO7SWi7Z0DRoLLNEzYlsmZEH/b1JyWTaqOtLxmURA5TDBwezGMkJKYUeuvDZgl0Wxoeor2oCFYTOgVNy0la6rdym8hqfWXgP1Omlg1ZY2AFnCfYJ6FIdRCKCS6uIYHgBmAUCGiDUr8W0hf2m0NwXe4toqsTPJHl5AwTGQNvLCVxIT+A6UlUhVlnWkPfokXku9eN828Eoql6Z/AoUNLpCOXjCIyDgvZ8dlOHiFhXmg3FlnL5yE/h84+I8PMXgXigUxBz0MIJI4IsZJ191p2ZHGhnRvh5fGBTB7ISSt79g3G8eHCryNieLqYwcbSZCCAKVUPTh37N4E7ImN14Tthd2mEFaacCKmMMwEjkwdHBeM0vpSvkYhEnwR4JsD6X7sj8pURyo5cnoIVJqLKI2mJE185tIIYArJwQfSWR6U1p3U2Rj3JhJUQTK04Yoz+zSVqQ4kEkhqcSrX2HHQw1dqruhMJq1itIV5pxgYSddinFbgKb47ZATYQph1odJoUhSr3QmUJ2qSAcO4AaSO4gM7wBkj8QEu2zbJSChnKARinzQAwFHNSt+cODBFBF/QUOjH8oS6gG35Y00hsfwJQzlhWsDuCUHTIzhBId2SRd6w2UjxA9NEkk/t3hBpXGoaInbzQnESMEx2+Jm7pMkRbMy2TjJRdQo+Dv4Hk5tB60D5XST4E/INp4JacqyweMDlaRvKgjHTwc70CX4OLp13JcAQC8HEOVzENnRwd2YuBWBJVSsHsRcg/MPghRwOsVCaUfNgEmCUE16QCFspmvL4JtUEBS+tXuExNOJpYmJKhpgD3wzRgXGDoH5toAkGUErqJbRMGjWcAGjILuWrKMmcE4ZAS/MzmNDB9nnAkgtKVLe4OfjUUQYwjlO52biZ6ZJZ3YwOfOPSTJRM/XKQdIE4DWqa8HQPOxS4U5iqRKSftmGczmtG9PDEBkycpXPiiaMT0lGzdD543Hpi7gghDnjmkcSiR/eIyBNyWeJQMn7TXBrkRpR5s+S9f+AYYYIT4wf0rYLAHq3GdXHLHs6RTLITHlD+EGlYww9VW+MgyUtxCt/f4f8BNWc7mkl0R90AAAAASUVORK5CYII=" alt="" class="w-7 h-7">
                        <span>Agent Hub</span>
                    </h2>
                    <button onclick="navigate('create')" class="btn-primary px-4 py-2 rounded-lg hidden md:block" data-permission="agents:create">+ Create</button>
                </div>
                
                <div class="flex gap-4 mb-6 border-b border-gray-800 overflow-x-auto">
                    <button onclick="setAgentTab('published')" id="tab-published" class="tab-btn active pb-3 px-2 border-b-2 whitespace-nowrap">Published</button>
                    <button onclick="setAgentTab('draft')" id="tab-draft" class="tab-btn pb-3 px-2 border-b-2 border-transparent whitespace-nowrap">Drafts</button>
                </div>
                
                <div id="agents-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-hidden"></div>
            </section>

            <!-- Tools Page -->
            <section id="page-tools" class="hidden flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-6">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                    <h2 class="text-xl md:text-2xl font-bold flex items-center gap-3">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAR50lEQVR42mVaa8xmV1V+nrXP+37fNzO9TAco7bQBKmgNtwClchMRAUFAioBVlIJggpqQcgmYECVEQEOieIshoiYm0ER+WISSAsGWqYIpBRMJRg1IUi7pgIW207l+33f2evyx1t5nv9NJO/NeznvO2uv6rGctbm0dIQFBABkv43/Ev4xXzH8BKT8jwPhYiu+XzwGAAti/yxcC4ADbMxRfaXgd35HMj9udlj9NSkFT/DAvUBcOwyn6jyBAEhl3R74jSSiOLwnxFoQBENsD44gkZMo7SiIYj/R+WcoWWovHUAjJuOiXAMFpkQ4byhzEZugjpWbJ39NAKs4c904JOeosjoFFpiY62JQVOre8Z0ooEFToFgQ9T6Bu3HjCNEo6/psCpQ7YLNKlM5BNdBDMYzcfBNk1modpjqS8h6v9sh2uGQbez9sO27SqDY9WOwAXh1fTXhqMgkgClEQaUqimYjaPh8XvSVN3vri+X5uOFIc0dodNx0m3ZNxfItO7l/tluKpH29SsqDxiuGAqNq63Jqr1i9TCFyBpmQLimnDCZpnmBSn+YOL4Uuin6raRkFpTu/lmkAo9IUxNN3FydL22dwZJEGmgDfbj4GfLgQHmVcznESYKEhcfC0G0+EK6U4gWIhKLLN0KYRQtDx9ioOfAfhYC1jRB0NpJ2SWX2pUtiLWk4h5U8Z5LeHSxMs2GOZnJdPz1EH4i6OCSnvLPhOa5S66kMQ6bwWBNDnYH607NOJgAIyM5NHkyCZCCczM/RMyAgjzspq5FOYfCJIjhLpLSN8JM+dhp8dAlCearHgzNn22pbmRGqIV9msQkXKnQSItGuPcqkvfVUL/Orz3WnujKAoANi2W68gidKfWcOZHKYLIQj8vBTM1tsnS1IIuzhXSZXdEObySIYqlRCJJC9QDlFOQaqpRntQRpxgwVb5mZITeIcG8IE5bC2bIYw2iREtJ/NCQdLGFastJZ3MJIw5I5jcbFXyXIW3oXJZnRAfNelkSD+yYOIEFl6KbtpVYrgCmdCqMnWQZcSj/iiY5zSqt0kVtJa6FCg/XibUvQyeHNueMkarjHAImKDB+qVQt5gUv4p6RhewDUpCFbNdHJdPd0bgmUQCPb8TI1USRo4f20otA4jTSaiTCy0Ko7ISPn/X3I4QY55PDw+TQ9JGaIquEyQen+AklvZ4i3nAgOXpVnyHzSEAItIwS0IY0aMhhsSb5maY2yQimllLN7e/u7dXXhof29GXt7F2wf8N2zgEugg0aJkkeagREuUIDH/QSLTNX8sCM6xRGnFDeqc4ZDpu1Weiwdo8PrpmMQMIPZkr1pMMO0AqeyKqf2/eonPuHdv/3aRx29dH9//vhn7vjIxz55CKh75+gEKXeIFOEZvjTIvXmBCMmYvhcBxDHrs0zToQWHpdDWMybMIv/kYYywtAPNUKa4ADSwsBjLxGnitCplOlv9KU9/yq0fef+xr/znRz5+63/dfc/bXv/KJ179Y5+846s7pciHFgSZPEJIjkUpMz6zRDEzOBOYkds7j2yA2Zo3mzigg+biG6LHV1YI0orMANAKpglWWKYyTadYjt30oZtvu/NDf/HRAxcdPLu7d+jIJf/+Dx962wf/5nOfue0gve7tep3hFRJqBVz5IhMupPyw/5eB7VL4WAPrCfcTDmjAkhzyj0GMc6rHgzHMaqt12dqa1lurra3VemtmedxjH3PxBQduuvWOSy572M7W6pGHLzj5o/s+cfudL3rWU5xltb1TVutpWk3TilZYJsAY6T+sit6ZLTW0Y9duuWmBIkNn1qEDIqtmYKeLZ0BbyXRkhWXianVqz+v+DHOsDOLx+0+eObe3s5rO7O5PhhkO6eDO+u7jP/LTu/dBvlcxO2o9uI4AKxQDMGRFy2Q1luIGkVpDOjWYwAZCDb2TaM5HM8GyBct6NS0eNU22Wu9P6xc+79qjRy+tIsxodnp37+GXXHTja1/2tg/89cMvOri3t3/06KW/9pLnfvifbr/+ja8+sF7JndT9P7zvn2/7Fz95KqoyEImIZEEhKgRPFEGDHHlFwvBJHUkuRWqEawyVMzNMs0MUByOtTKvVyd35da966e+/5Ya7vv7N7a1VKMxrvfNr3/ifu49vba1dAg3VP3bLscdd/vCrr7g07n3u3N7VV1357Kc9/l2/98cXTGWeHU5wXpRoBU6gprwKmyxoYmqoJmHtgoHZ2zgQEcFIxSTssZZtrXp96hOv/vjnvvTud//pdOTi2T2AjU3TZHZoa+0+F+r0yVM3vu+vBJM7VEno5OmXveYX3vG6X9RqLT/XkIBRkPdjhFcZmuIDukV9m1qsjN5vrYUlQC3xPQR0pCwrGdDTtFt9vV5Nhy84cmirZn9C0STVeYZXyQke3t4KJkBeCnHCcHBn68zuHkqBDGaoNV2cbFmUge3TfXpPo6WpTw/R2N2oEz9qJcbyPGap+mKwAivIylZmm6p79WR1hMrOqbBAqF6T7XHBMFdJMDP056QePStruH9rkRsSWhqbCWZDhY3eYgN4pvfT5FocyQpLKdNkZVXW62neG3JviRY79JxtmpE0uNNAgWYQDJpmmRmHStoSSmDu9jc8mmMOfAFJyKfGlLAjqmyFezmMYjzg4oAPZZpOnN1HwWTTfHp3331lDq8tCcYDApJbh/hmE4AfPXiKVkrhfHZvFtwFK2HYSBtw7zoONioZrrEFBwBOWS00wCQO4DlQky2IraeeE3v1upe/4A2vfvHFFx763Je/fsnFF54+eRrV5a7AxraQXMp0XESenuvv3PDK655/7aqUf7z9y2fmur2e4B4RBYqKvqojMbXsmcifNCkL9tSIl0Dl2ZQRAxOq7HTSuDQr5cHd+b2/++Ybrnvhn330U/93/4mXPffpL33uNTd+8O9Kgdc5Erkq2K0HmtGKndivf/u+tzz+qiv+/KZP1+qveeEzn/C4R/39zZ83n1migTbBw50aVdQCN0MXLl+Ytu2DVy7AIdQcxEjWWmNEGAvNYMWm6WzV055xzc0fft8zfvXt3/3Wt6ftrUr7yauuPP6DH9Z5n40sjF9ZKeG2U5nuP3P2V17+s+958/VPvv4d5x48weplvb7ysiM/uOd42dv1eR/zvuoMd7mn1iV5ldf2iZAWzgumyG6JC9CQYOtfFzRB0kyAGefTu6/4uWd++thd3/3m3Zc94vB+rbDynW9/r5QykNqMRC3UBrQ079eXPOepH/vsF8+ePHnZhQfnefa53vu94yt4KFtaqpAUoE0Ln4iBvUyYqoY0E2lnrYJZI4KUbbwtdkR1I+d5hly1BjAupdjIOLggJyB3rzUCA5JLRsIXTvXcfp0dCTvZDuIVUQ0bE9AA0GYWStV2/n4hSRsUTdrH5YiOyd3L1urWY3e99HnXXnLF5d9/8MyD5/Z/eOrsoUsOzyzjmCBDS4JcXr3WyXjLsa/8+kuec+jiC+954NS9J8+eRXn+837q8CMeNrtCc1lzWq0UGhPaaHdtUNFWpvVF2ciMoZs9rkXxSgjUauDWzs43v3PPVY+58g9ufP29p3cfcemRd/3ma/7knW/61vF7v/bf/7s9lY7ge3ECKWFna/W1b3znyVc/+j2/dX0ln/akn/jAW1//G6960RWXX3rzZ/91x7K3TJYr7rCQ1EnrbpD1UJnWFzXM3fFcVKuSCCKzG/plArbX61vu+OrsesN1z//5Zz/1G9/9/r0nTh05fNFnvnDXgZW5N4s/RJT1ZJ+4/cvn9uZX/Mw1P/6oy2/69LFb/u0/XnDtkz76qdu2NGvez85R3e+VCdU9O7JF/4LA7YNXtCpsDSFHqi1gyU+sJJSwIgFWbLWKUsD11oEDB07fe+KP/vCt02r9zvf+5eFtq7UuxE6LLpqJFknugVPnkv85c+6Xb/ilN77yBS9+3dsvrOd8rvIKSV4TCdUZqgDkDq+ReRA1PrJQ9uKdPoFgBsGlpKi7GC6gwkoQZHWeL97ZAlF8f/fQ1vZ6NdeKeQ9aB5eYPE9OmygHKJFyHD6wDgr2AetIia0cpQXayCNSgrfC2qYh7ftpaMc4uJcBkiocLESk2rgo/btCnOdKM2Ce9+bq6krKRNc586hH8rAASPcUtM77qHMDcYK7vLLPAIL/8eaNUlTptCoIYmrU0eBYjWRl1GYtc4lO/cqdrFCRLKwZTGEpNpVS4Yn8wKHb46I6gZQBhSTp7lGeAjEv7C0cXjlYg5uDR0CTgs5ekJIB1mK6RUcwcGqzuT5H8pkusqDO2ys7eWavnt69byp19mRCgyckcB6zz+YVp86c25sPrFfYOyfWzkVDLnieuA9ggWFGlWloGk+jBZX3YZRD4UKWrLEEdxnAYKMcTtN851e//v63v+nxjzm6Xk/j/YKM9YXtGTt07e7uP/bRRz/1+S9yb5crKsuNoApvfUhKophRJVLMG4hbO0eZcwpTowqD1RABK8nJZUEYcpRZVkMrLNOeTT/9rGuOHr2sSmZBMSWiUFDz0Yw3UjBeG/nAiRO3feFLOnUSdW5RFALXRmg7BMRbQHK4twmOc3vn8uRl+0ApuqeYdpmBpTUGBEvMD6zECS1xhxUr5fTuvqsB+sbLNw/oSMThLQ00+uTgylBnuKRMA2pcPDNjBtTAcqRm5CnbAYn0YXqWM064o1gOW7UwHnI13GNBxTr80LoshOnSJ3FjCup09wSsEmTwWud9uTMiV8qWsXPUGkdKmRfic0lTm4sELloGODkEEFTnhNluooOA5ZIAzOJlaGuuNUm1TrqE9WidJAx418RKeAw5O9hvkcYG4obepA/pO7BLC2TxoPr8a6kIra2g4JBxzFmZ+NgGW95CzglQBaoxFZM7MoV7rj64L4sRIBafiWZAI5XYZ2pobtQx+7Sx/tGt0+a0jRIVVBlwX2gEmkWNVKw4xNjEK1CDNWINAhreVjrSVvEnupbIs1G/QuVycBT6vK0TKXNAumaZVofGNrkPBdo8vrWmfQthuXvDWzFoaXCN4QBxzmijwkm6Ut3hgtdUUbRXWBA/N6C/2mpNz0jqWysA+gE21j24zJIb7UWDlhWLvm6gGCGy8eDjrWIXJyXr9V8t2Tew2douSILDnX38CrUa4EsoUxwI3uEAS5kMDr2fggvKbsP1VovUEJL13adkZ5qz9bMkPHJvOxFtTyXtk/V1GGmGrw+f5HnSD+OYkzqHE87QNnbYZs658SDPKTK8sX6ebCsJr7mVEQyPGv3ajtj0hw7T2r5E+lJnzhuAzQM3NLrhSFwIU5XVdHDYPeDG3lAnfYf5ah90c+zthL5PkByqu1S78siHbIBlAHhsh2x6mjC2LMNPhmjJt9OwkKPhKd4nhpstXHcSizZxGYLmvhCExb6CU9xQ8Ii8BlmlpUvsTjI6UneFRghkqZvGIfe4cINxhSqXj3KQmSBvWV1iwhLYAjMbeu4t3pI9pcWPlj2PRcqNIrCRP32zpAW1yDEl5GQ/ynNLmdanVdk5dC6v7Wo1h1qaYKYKDaxZ5jUuvSk3oRIBqy0Ugl3l0qYrPdTBCHmZyoFhC5BY9vfi7jYcdwA4jTXJDq8TMyOJ0O2cmlta9SV9YXAbjFSARo9qcDoqt8bea+qRO7C/seHTh219H0iA5UJD32NBf2TjlHIPJncam4je8m+AB9fg+Fwq7gjdYkqQNWGgp5eIWtYux73TXORA36fKTdB+k4yWzW3XhYpMbWiRaYksBZPZv9UQvI3V2ggJdSzE86XvLeWwK9m2VjUA4LZk4BgGgW3DRS3d1ozYxmNIc+PCNjpCaURnG3tlQt1woax+PuyjaSO1dBda/IRY6gjt/AS6rDxaZ0BiTagRfqaxYLn6+t3Y2y67ltpAO9iouG1vmYuhliWOgXIp07TTeOlhJYhj99DiNSuxeF45ksYN1V6FGxbCMPpq2uWySbCRJMZpfMcRC8hbtqa7ZnPE1MQfxUnIE8UhuJQRwrR1yN52ezQuA4uNBeH0RfAFGozB4Ysx2u04EKBccunmPmbbG9WSUQbwtaCoXNhVX/Nst+3BE2tWtS9f9qgdVtJ9JGUH3KIGzpeVdqo3kep7K+POVq9/ZZoOjDMxLisG5/Fcy1Jpi3adtyN+/jstdtzE9y1wh28pCUHp6SGoKRXAjRqcz/t/IY2ITnCjTaYAAAAASUVORK5CYII=" alt="" class="w-7 h-7">
                        <span>Tools</span>
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="deleteAllTools()" class="btn-danger px-3 py-2 rounded-lg text-sm" title="Delete all tools"> Delete All</button>
                        <button onclick="cleanupDuplicateTools()" class="btn-secondary px-3 py-2 rounded-lg text-sm" title="Remove duplicate tools"> Cleanup</button>
                        <button data-permission="tools:create" onclick="showToolModal()" class="btn-primary px-4 py-2 rounded-lg">+ Create Tool</button>
                    </div>
                </div>
                <div id="tools-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            </section>

            <!-- Tool Detail Page -->
            <section id="page-tool-detail" class="hidden flex-1 overflow-y-auto p-4 md:p-6">
                <button onclick="navigate('tools')" class="text-gray-400 hover:text-white mb-4 flex items-center gap-2">
                    <span></span><span>Back to Tools</span>
                </button>
                <div id="tool-detail"></div>
            </section>

            <!-- Settings Page -->
            <section id="page-settings" class="hidden flex-1 overflow-y-auto p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-bold mb-6"> Settings</h2>
                
                <div class="max-w-4xl space-y-6">
                    <!-- Theme Selection -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold flex items-center gap-2"> Theme</h3>
                            <p class="text-sm text-gray-400 mt-1">Choose your preferred appearance</p>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                            <!-- Dark Theme -->
                            <button onclick="setTheme('dark')" class="theme-btn group relative rounded-xl p-3 border-2 transition-all hover:scale-105" data-theme-btn="dark">
                                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden" style="background: linear-gradient(135deg, #0f0f17 0%, #1e1e2e 50%, #667eea 100%)"></div>
                                <span class="text-xs font-medium">Dark</span>
                                <div class="absolute top-1 right-1 w-4 h-4 bg-green-500 rounded-full hidden items-center justify-center theme-check">
                                    <span class="text-white text-xs"></span>
                                </div>
                            </button>
                            
                            <!-- Light Theme -->
                            <button onclick="setTheme('light')" class="theme-btn group relative rounded-xl p-3 border-2 transition-all hover:scale-105" data-theme-btn="light">
                                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #7c3aed 100%)"></div>
                                <span class="text-xs font-medium">Light</span>
                                <div class="absolute top-1 right-1 w-4 h-4 bg-green-500 rounded-full hidden items-center justify-center theme-check">
                                    <span class="text-white text-xs"></span>
                                </div>
                            </button>
                            
                            <!-- Ocean Theme -->
                            <button onclick="setTheme('ocean')" class="theme-btn group relative rounded-xl p-3 border-2 transition-all hover:scale-105" data-theme-btn="ocean">
                                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden" style="background: linear-gradient(135deg, #dbeafe 0%, #bae6fd 50%, #6366f1 100%)"></div>
                                <span class="text-xs font-medium">Ocean</span>
                                <div class="absolute top-1 right-1 w-4 h-4 bg-green-500 rounded-full hidden items-center justify-center theme-check">
                                    <span class="text-white text-xs"></span>
                                </div>
                            </button>
                            
                            <!-- Sunset Theme -->
                            <button onclick="setTheme('sunset')" class="theme-btn group relative rounded-xl p-3 border-2 transition-all hover:scale-105" data-theme-btn="sunset">
                                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #f97316 100%)"></div>
                                <span class="text-xs font-medium">Sunset</span>
                                <div class="absolute top-1 right-1 w-4 h-4 bg-green-500 rounded-full hidden items-center justify-center theme-check">
                                    <span class="text-white text-xs"></span>
                                </div>
                            </button>
                            
                            <!-- Forest Theme -->
                            <button onclick="setTheme('forest')" class="theme-btn group relative rounded-xl p-3 border-2 transition-all hover:scale-105" data-theme-btn="forest">
                                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden" style="background: linear-gradient(135deg, #0f1f13 0%, #1a3320 50%, #22c55e 100%)"></div>
                                <span class="text-xs font-medium">Forest</span>
                                <div class="absolute top-1 right-1 w-4 h-4 bg-green-500 rounded-full hidden items-center justify-center theme-check">
                                    <span class="text-white text-xs"></span>
                                </div>
                            </button>
                            
                            <!-- Midnight Theme -->
                            <button onclick="setTheme('midnight')" class="theme-btn group relative rounded-xl p-3 border-2 transition-all hover:scale-105" data-theme-btn="midnight">
                                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden" style="background: linear-gradient(135deg, #020617 0%, #1e293b 50%, #3b82f6 100%)"></div>
                                <span class="text-xs font-medium">Midnight</span>
                                <div class="absolute top-1 right-1 w-4 h-4 bg-green-500 rounded-full hidden items-center justify-center theme-check">
                                    <span class="text-white text-xs"></span>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Integrations (OAuth Setup for Admin) -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold flex items-center gap-2"> Integrations</h3>
                            <p class="text-sm text-gray-400 mt-1">Connect external services for your agents</p>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- Google Integration -->
                            <div class="p-4 rounded-lg" style="background:var(--bg-input);">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg bg-white flex items-center justify-center">
                                            <svg width="24" height="24" viewBox="0 0 24 24">
                                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h5 class="font-medium" style="color:var(--text-primary);">Google</h5>
                                            <p class="text-xs" style="color:var(--text-muted);" id="google-integration-status">Not configured</p>
                                        </div>
                                    </div>
                                    <button onclick="showIntegrationSetup('google')" class="btn-secondary px-4 py-2 rounded-lg text-sm">
                                        Configure
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Microsoft Integration -->
                            <div class="p-4 rounded-lg" style="background:var(--bg-input);">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg bg-white flex items-center justify-center">
                                            <svg width="21" height="21" viewBox="0 0 21 21">
                                                <rect x="1" y="1" width="9" height="9" fill="#F25022"/>
                                                <rect x="11" y="1" width="9" height="9" fill="#7FBA00"/>
                                                <rect x="1" y="11" width="9" height="9" fill="#00A4EF"/>
                                                <rect x="11" y="11" width="9" height="9" fill="#FFB900"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h5 class="font-medium" style="color:var(--text-primary);">Microsoft</h5>
                                            <p class="text-xs" style="color:var(--text-muted);" id="microsoft-integration-status">Not configured</p>
                                        </div>
                                    </div>
                                    <button onclick="showIntegrationSetup('microsoft')" class="btn-secondary px-4 py-2 rounded-lg text-sm">
                                        Configure
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-xs mt-4" style="color:var(--text-muted);">
                             These integrations allow users to connect their accounts with one click when creating Email tools.
                        </p>
                    </div>
                    
                    <!-- LLM Providers Management -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold flex items-center gap-2"> LLM Providers</h3>
                                <p class="text-sm text-gray-400 mt-1">Add and manage your AI model providers</p>
                            </div>
                        </div>
                        
                        <!-- Configured Providers Table -->
                        <div id="configured-providers-section" class="mb-6">
                            <h4 class="text-sm font-medium text-gray-300 mb-3"> Configured Providers</h4>
                            <div id="configured-providers-table" class="space-y-2">
                                <!-- Will be populated dynamically -->
                                <div class="text-center py-4 text-gray-500 text-sm" id="no-providers-msg">
                                    <span class="text-2xl block mb-2"></span>
                                    No providers configured yet. Add one below.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add New Provider Form -->
                        <div class="border-t border-gray-700 pt-4">
                            <h4 class="text-sm font-medium text-gray-300 mb-3"> Add New Provider</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                                    <select id="llm-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onLLMProviderChange()">
                                        <optgroup label="Cloud Providers">
                                            <option value="openai">OpenAI (GPT-4o, GPT-4)</option>
                                            <option value="anthropic">Anthropic (Claude)</option>
                                            <option value="google">Google (Gemini)</option>
                                            <option value="xai">xAI (Grok)</option>
                                            <option value="groq">Groq (Fast Inference)</option>
                                            <option value="mistral">Mistral AI</option>
                                            <option value="deepseek">DeepSeek</option>
                                            <option value="together">Together AI</option>
                                            <option value="perplexity">Perplexity</option>
                                            <option value="cohere">Cohere</option>
                                        </optgroup>
                                        <optgroup label="Enterprise">
                                            <option value="azure_openai">Azure OpenAI</option>
                                            <option value="aws_bedrock">AWS Bedrock</option>
                                        </optgroup>
                                        <optgroup label="Local / Self-hosted">
                                            <option value="ollama">Ollama (Local)</option>
                                            <option value="lmstudio">LM Studio</option>
                                            <option value="custom">Custom OpenAI-compatible</option>
                                        </optgroup>
                                    </select>
                            
                                </div>
                                <div id="llm-api-key-group">
                                    <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                                    <input type="password" id="llm-api-key" class="input-field w-full rounded-lg px-4 py-2" placeholder="Enter your API key...">
                                </div>
                                <div id="llm-api-base-group" class="hidden">
                                    <label class="text-sm text-gray-400 mb-1 block">API Base URL</label>
                                    <input type="text" id="llm-api-base" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://api.example.com/v1">
                                </div>
                                <div id="llm-resource-group" class="hidden">
                                    <label class="text-sm text-gray-400 mb-1 block">Resource Name / Deployment</label>
                                    <input type="text" id="llm-resource" class="input-field w-full rounded-lg px-4 py-2" placeholder="my-resource">
                                </div>
                            </div>
                            
                            <!-- Provider Info -->
                            <div id="llm-provider-info" class="mt-3 p-3 bg-gray-800/50 rounded-lg text-xs">
                                <p id="llm-provider-info-text" class="text-gray-400">Select a provider to see supported models and pricing info.</p>
                                <a id="llm-provider-link" href="#" target="_blank" class="text-purple-400 hover:text-purple-300 mt-1 inline-block hidden">Get API Key </a>
                            </div>
                            
                            <!-- Supported Models Preview -->
                            <div id="llm-models-preview" class="mt-3 hidden">
                                <label class="text-xs text-gray-400 mb-2 block">Supported Models:</label>
                                <div id="llm-models-list-preview" class="flex flex-wrap gap-1">
                                    <!-- Model tags will be added here -->
                                </div>
                            </div>
                            
                            <div class="flex gap-2 mt-4">
                                <button onclick="addLLMProvider()" class="btn-primary px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                                    <span></span> Add Provider
                                </button>
                                <button onclick="testNewLLMProvider()" class="btn-secondary px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                                    <span></span> Test Connection
                                </button>
                            </div>
                            <div id="llm-test-result" class="hidden mt-3 p-3 rounded-lg text-sm"></div>
                        </div>
                    </div>

                    <!-- Default LLM Selection -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold flex items-center gap-2"> Default LLM</h3>
                                <p class="text-sm text-gray-400 mt-1">Select the default model for agent chat and platform features</p>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Default Provider</label>
                                <select id="default-llm-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onDefaultProviderChange()">
                                    <option value="">-- Select Provider --</option>
                                    <!-- Populated from configured providers -->
                                </select>
                            
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Default Model</label>
                                <select id="default-llm-model" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="">-- Select Model --</option>
                                </select>
                            
                            </div>
                        </div>
                    </div>

                    <!-- Embedding Provider -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold flex items-center gap-2"> Embedding Provider</h3>
                                <p class="text-sm text-gray-400 mt-1">Configure embeddings for semantic search</p>
                            </div>
                            <button onclick="testEmbedding()" class="btn-secondary px-3 py-1.5 rounded-lg text-sm"> Test</button>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                                <select id="emb-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onEmbeddingProviderChange()">
                                    <option value="openai">OpenAI Embeddings</option>
                                    <option value="sentence_transformers">Sentence Transformers (Local)</option>
                                    <option value="ollama">Ollama Embeddings</option>
                                </select>
                            
                            </div>
                            <div id="emb-model-group">
                                <label class="text-sm text-gray-400 mb-1 block">Model</label>
                                <select id="emb-model" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="text-embedding-3-small">text-embedding-3-small (1536 dim)</option>
                                    <option value="text-embedding-3-large">text-embedding-3-large (3072 dim)</option>
                                    <option value="text-embedding-ada-002">text-embedding-ada-002 (1536 dim)</option>
                                </select>
                            
                            </div>
                            <div id="emb-local-model-group" class="hidden">
                                <label class="text-sm text-gray-400 mb-1 block">Local Model</label>
                                <select id="emb-local-model" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="all-MiniLM-L6-v2">all-MiniLM-L6-v2 (384 dim, Fast)</option>
                                    <option value="all-mpnet-base-v2">all-mpnet-base-v2 (768 dim, Better)</option>
                                    <option value="paraphrase-multilingual-MiniLM-L12-v2">Multilingual (384 dim)</option>
                                </select>
                            
                            </div>
                            <div id="emb-api-key-group">
                                <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                                <input type="password" id="emb-api-key" class="input-field w-full rounded-lg px-4 py-2" placeholder="sk-...">
                            </div>
                        </div>
                        <div id="emb-test-result" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
                    </div>

                    <!-- Vector Database -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold flex items-center gap-2"> Vector Database</h3>
                                <p class="text-sm text-gray-400 mt-1">Configure where embeddings are stored for RAG search</p>
                            </div>
                            <button onclick="reindexKnowledgeBase()" class="btn-secondary px-3 py-1.5 rounded-lg text-sm"> Reindex</button>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                                <select id="vdb-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onVectorDBProviderChange()">
                                    <option value="memory">In-Memory (Keyword Search)</option>
                                    <option value="chromadb">ChromaDB (Local Vector DB)</option>
                                    <option value="pinecone">Pinecone (Cloud)</option>
                                </select>
                            
                            </div>
                            <div id="vdb-chroma-path-group" class="hidden">
                                <label class="text-sm text-gray-400 mb-1 block">Storage Path</label>
                                <input type="text" id="vdb-chroma-path" class="input-field w-full rounded-lg px-4 py-2" placeholder="./data/chromadb">
                            </div>
                            <div id="vdb-pinecone-group" class="hidden col-span-2 grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Pinecone API Key</label>
                                    <input type="password" id="vdb-pinecone-key" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Index Name</label>
                                    <input type="text" id="vdb-pinecone-index" class="input-field w-full rounded-lg px-4 py-2" placeholder="agentforge">
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-gray-800 rounded-lg">
                            <div class="flex items-center gap-2 text-sm">
                                <span id="vdb-status-icon"></span>
                                <span id="vdb-status-text">Not configured</span>
                            </div>
                        </div>
                    </div>

                    <!-- RAG Settings -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"> RAG Settings</h3>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Chunk Size</label>
                                <input type="number" id="rag-chunk-size" class="input-field w-full rounded-lg px-4 py-2" value="1000">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Chunk Overlap</label>
                                <input type="number" id="rag-chunk-overlap" class="input-field w-full rounded-lg px-4 py-2" value="200">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Search Results (Top K)</label>
                                <input type="number" id="rag-top-k" class="input-field w-full rounded-lg px-4 py-2" value="5">
                            </div>
                        </div>
                    </div>

                    <!-- Feature Toggles -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"> Features</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Enable RAG</p>
                                    <p class="text-sm text-gray-400">Use vector search for knowledge retrieval</p>
                                </div>
                                <div id="toggle-rag" class="toggle-switch on" onclick="toggleFeature('rag')"></div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Enable Web Scraping</p>
                                    <p class="text-sm text-gray-400">Allow scraping websites as knowledge sources</p>
                                </div>
                                <div id="toggle-scraping" class="toggle-switch on" onclick="toggleFeature('scraping')"></div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Enable API Tools</p>
                                    <p class="text-sm text-gray-400">Allow agents to call external APIs</p>
                                </div>
                                <div id="toggle-api" class="toggle-switch on" onclick="toggleFeature('api')"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="flex justify-end gap-4">
                        <button onclick="loadSettings()" class="btn-secondary px-6 py-2 rounded-lg">Reset</button>
                        <button onclick="saveSettings()" class="btn-primary px-6 py-2 rounded-lg"> Save Settings</button>
                    </div>
                </div>
            </section>

            <!-- Profile Page -->
            <section id="page-profile" class="hidden flex-1 overflow-y-auto p-4 md:p-6">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                        <span></span><span>My Profile</span>
                    </h2>

                    <!-- Profile Info Card -->
                    <div class="bg-gray-800/50 backdrop-blur rounded-lg p-6 mb-6 border border-gray-700">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <span></span><span>Profile Information</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400">Name</label>
                                <p id="profile-name" class="text-white font-medium">Loading...</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400">Email</label>
                                <p id="profile-email" class="text-white font-medium">Loading...</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400">Role</label>
                                <p id="profile-role" class="text-white font-medium">Loading...</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400">Member Since</label>
                                <p id="profile-created" class="text-white font-medium">Loading...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Profile Form -->
                    <div class="bg-gray-800/50 backdrop-blur rounded-lg p-6 mb-6 border border-gray-700">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <span></span><span>Update Profile</span>
                        </h3>
                        <form id="update-profile-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">First Name</label>
                                    <input type="text" id="update-first-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="First name">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Last Name</label>
                                    <input type="text" id="update-last-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Last name">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Display Name</label>
                                <input type="text" id="update-display-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Display name">
                            </div>
                            <div class="flex justify-end gap-3">
                                <button type="button" onclick="loadProfileInfo()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                                <button type="submit" class="btn-primary px-4 py-2 rounded-lg">Save Changes</button>
                            </div>
                        </form>
                    </div>

                    <!-- Change Password Section -->
                    <div class="bg-gray-800/50 backdrop-blur rounded-lg p-6 mb-6 border border-gray-700">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <span></span><span>Change Password</span>
                        </h3>
                        <form id="change-password-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Current Password</label>
                                <div class="relative">
                                    <input type="password" id="current-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 pr-12 text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                                    <button type="button" onclick="togglePasswordVisibility('current-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition" title="Show/Hide password">
                                        <span id="current-password-icon">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                                            </svg>
                                        </span>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">New Password</label>
                                <div class="relative">
                                    <input type="password" id="new-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 pr-12 text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                                    <button type="button" onclick="togglePasswordVisibility('new-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition" title="Show/Hide password">
                                        <span id="new-password-icon">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                                            </svg>
                                        </span>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Confirm New Password</label>
                                <div class="relative">
                                    <input type="password" id="confirm-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 pr-12 text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                                    <button type="button" onclick="togglePasswordVisibility('confirm-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition" title="Show/Hide password">
                                        <span id="confirm-password-icon">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                                            </svg>
                                        </span>
                                    </button>
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="btn-primary px-4 py-2 rounded-lg">Change Password</button>
                            </div>
                        </form>
                    </div>

                    <!-- MFA Settings Section -->
                    <div class="bg-gray-800/50 backdrop-blur rounded-lg p-6 border border-gray-700">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <span></span><span>Multi-Factor Authentication (MFA)</span>
                        </h3>
                        
                        <!-- Current MFA Status -->
                        <div id="mfa-status-container" class="mb-4 p-4 rounded-lg bg-gray-700/50 border border-gray-600">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">MFA Status</p>
                                    <p id="mfa-status-text" class="text-sm text-gray-400">Loading...</p>
                                </div>
                                <div id="mfa-status-badge"></div>
                            </div>
                        </div>

                        <!-- MFA Setup/Disable Forms -->
                        <div id="mfa-disabled-section" class="hidden">
                            <p class="text-gray-300 mb-4">Enable MFA to add an extra layer of security to your account.</p>
                            <div class="space-y-3 mb-4">
                                <label class="flex items-center gap-3 p-3 bg-gray-700/30 rounded-lg cursor-pointer hover:bg-gray-700/50 transition">
                                    <input type="radio" name="mfa-type" value="totp" class="form-radio text-purple-600" checked>
                                    <div>
                                        <p class="font-medium">Authenticator App (TOTP)</p>
                                        <p class="text-sm text-gray-400">Use Google Authenticator, Authy, or similar apps</p>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 p-3 bg-gray-700/30 rounded-lg cursor-pointer hover:bg-gray-700/50 transition">
                                    <input type="radio" name="mfa-type" value="email" class="form-radio text-purple-600">
                                    <div>
                                        <p class="font-medium">Email Code</p>
                                        <p class="text-sm text-gray-400">Receive verification codes via email</p>
                                    </div>
                                </label>
                            </div>
                            <button onclick="startMFASetup()" class="btn-primary px-4 py-2 rounded-lg">Enable MFA</button>
                        </div>

                        <div id="mfa-enabled-section" class="hidden">
                            <div class="flex items-center justify-between">
                                <p class="text-gray-300">MFA is currently enabled for your account.</p>
                                <button onclick="disableMFA()" class="btn-danger px-4 py-2 rounded-lg">Disable MFA</button>
                            </div>
                        </div>

                        <!-- MFA Setup Modal Content (will be shown in modal) -->
                        <div id="mfa-setup-modal-content" class="hidden">
                            <!-- TOTP Setup -->
                            <div id="totp-setup" class="hidden">
                                <div class="text-center mb-4">
                                    <h4 class="text-lg font-semibold mb-2">Scan QR Code</h4>
                                    <p class="text-sm text-gray-400 mb-4">Scan this QR code with your authenticator app</p>
                                    <div id="qr-code-container" class="flex justify-center mb-4"></div>
                                    <p class="text-xs text-gray-500 mb-2">Or enter this key manually:</p>
                                    <code id="mfa-secret-key" class="bg-gray-700 px-3 py-1 rounded text-sm"></code>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Verification Code</label>
                                    <input type="text" id="totp-verify-code" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center text-lg tracking-wider" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                                </div>
                                <button onclick="verifyTOTPSetup()" class="btn-primary w-full py-2 rounded-lg">Verify & Enable</button>
                            </div>

                            <!-- Email Setup -->
                            <div id="email-setup" class="hidden">
                                <div class="text-center mb-4">
                                    <h4 class="text-lg font-semibold mb-2">Verify Email</h4>
                                    <p class="text-sm text-gray-400 mb-4">A verification code has been sent to your email</p>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Verification Code</label>
                                    <input type="text" id="email-verify-code" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center text-lg tracking-wider" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="resendEmailMFACode()" class="btn-secondary flex-1 py-2 rounded-lg">Resend Code</button>
                                    <button onclick="verifyEmailSetup()" class="btn-primary flex-1 py-2 rounded-lg">Verify & Enable</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Security Center Page -->
            <section id="page-security" class="hidden flex-1 overflow-y-auto p-4 md:p-6">
                <div class="max-w-7xl mx-auto">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold"> Security Center</h2>
                            <p class="text-gray-400 text-sm">Manage users, roles, and security settings</p>
                        </div>
                        <button id="invite-user-btn" data-permission="users:invite" onclick="showInviteModal()" class="btn-primary px-4 py-2 rounded-lg">+ Invite User</button>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="card rounded-xl p-4">
                            <div class="text-2xl font-bold text-purple-400" id="sec-stat-users">0</div>
                            <div class="text-sm text-gray-400">Total Users</div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <div class="text-2xl font-bold text-green-400" id="sec-stat-active">0</div>
                            <div class="text-sm text-gray-400">Active</div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <div class="text-2xl font-bold text-blue-400" id="sec-stat-roles">0</div>
                            <div class="text-sm text-gray-400">Roles</div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <div class="text-2xl font-bold text-yellow-400" id="sec-stat-policies">0</div>
                            <div class="text-sm text-gray-400">Policies</div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <div class="text-2xl font-bold text-cyan-400" id="sec-stat-mfa">0</div>
                            <div class="text-sm text-gray-400">MFA Enabled</div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex gap-2 mb-4 border-b border-gray-700 pb-2 overflow-x-auto">
                        <button data-permission="users:view" onclick="switchSecurityTab('users')" id="sec-tab-users" class="px-4 py-2 rounded-t-lg bg-purple-600 text-white whitespace-nowrap"> Users</button>
                        <button data-permission="roles:view" onclick="switchSecurityTab('roles')" id="sec-tab-roles" class="px-4 py-2 rounded-t-lg hover:bg-gray-700 whitespace-nowrap"> Roles</button>
                        <button data-permission="audit:view" onclick="switchSecurityTab('audit')" id="sec-tab-audit" class="px-4 py-2 rounded-t-lg hover:bg-gray-700 whitespace-nowrap"> Audit Log</button>
                        <button onclick="switchSecurityTab('mfa')" id="sec-tab-mfa" class="px-4 py-2 rounded-t-lg hover:bg-gray-700 whitespace-nowrap"> My MFA</button>
                        <button data-permission="security:settings" onclick="switchSecurityTab('settings')" id="sec-tab-settings" class="px-4 py-2 rounded-t-lg hover:bg-gray-700 whitespace-nowrap"> Settings</button>
                    </div>

                    <!-- Users Tab -->
                    <div id="sec-content-users" class="card rounded-xl" data-permission="users:view">
                        <!-- Pending Invitations -->
                        <div id="sec-invitations-section" class="p-4 border-b border-gray-700">
                            <h4 class="text-sm font-semibold text-yellow-400 mb-3"> Pending Invitations</h4>
                            <div id="sec-invitations-list" class="space-y-2">
                                <p class="text-gray-500 text-sm">Loading invitations...</p>
                            </div>
                        </div>
                        <!-- Users Filter -->
                        <div class="p-4 border-b border-gray-700 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                            <input type="text" id="sec-user-search" placeholder="Search users..." 
                                   class="input-field px-4 py-2 rounded-lg w-full md:w-64" oninput="filterSecurityUsers()">
                            <select id="sec-user-filter" class="input-field px-4 py-2 rounded-lg" onchange="filterSecurityUsers()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="locked">Locked</option>
                            </select>
                            
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-800/50">
                                    <tr>
                                        <th class="text-left p-4">User</th>
                                        <th class="text-left p-4">Roles</th>
                                        <th class="text-left p-4">Status</th>
                                        <th class="text-left p-4">MFA</th>
                                        <th class="text-left p-4">Last Login</th>
                                        <th class="text-left p-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="sec-users-table">
                                    <tr><td colspan="6" class="p-8 text-center text-gray-500">Loading users...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Roles Tab -->
                    <div id="sec-content-roles" class="hidden" data-permission="roles:view">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Manage Roles</h3>
                            <button onclick="showAddRoleModal()" class="btn-primary px-4 py-2 rounded-lg" data-permission="roles:create">+ Add Role</button>
                        </div>
                        <div class="flex justify-between mb-4">
                            <h3 class="text-lg font-semibold">System & Custom Roles</h3>
                            
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="sec-roles-grid">
                            <div class="card rounded-xl p-4 text-center text-gray-500">Loading roles...</div>
                        </div>
                    </div>

                    <!-- Audit Log Tab -->
                    <div id="sec-content-audit" class="hidden card rounded-xl" data-permission="audit:view">
                        <div class="p-4 border-b border-gray-700 flex items-center gap-4">
                            <select id="sec-audit-action" class="input-field px-3 py-2 rounded-lg" onchange="loadAuditLogs()">
                                <option value="">All Actions</option>
                                <option value="login">Login</option>
                                <option value="logout">Logout</option>
                                <option value="create">Create</option>
                                <option value="update">Update</option>
                                <option value="delete">Delete</option>
                            </select>
                            
                            <button data-permission="audit:export" onclick="exportAuditLogs()" class="btn-secondary px-4 py-2 rounded-lg"> Export CSV</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-800/50">
                                    <tr>
                                        <th class="text-left p-4">Time</th>
                                        <th class="text-left p-4">User</th>
                                        <th class="text-left p-4">Action</th>
                                        <th class="text-left p-4">Resource</th>
                                        <th class="text-left p-4">IP</th>
                                        <th class="text-left p-4">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="sec-audit-table">
                                    <tr><td colspan="6" class="p-8 text-center text-gray-500">Select action filter to load logs</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- MFA Tab -->
                    <div id="sec-content-mfa" class="hidden card rounded-xl p-6">
                        <div class="max-w-2xl mx-auto">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4"></div>
                                <h3 class="text-xl font-bold mb-2">Multi-Factor Authentication</h3>
                                <p class="text-gray-400">Secure your platform with email verification</p>
                            </div>
                            
                            <!-- Admin Controls -->
                            <div id="mfa-admin-controls" class="mb-8" data-permission="system:admin,security:settings">
                                <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-6">
                                    <h4 class="font-bold text-purple-400 mb-6 flex items-center gap-2">
                                        <span></span> Platform MFA Settings
                                    </h4>
                                    
                                    <!-- MFA Mode Selection -->
                                    <div class="space-y-3">
                                        <label class="block text-sm text-gray-400 mb-3">Choose MFA mode for your platform:</label>
                                        
                                        <label class="flex items-center p-4 rounded-lg border border-gray-700 hover:border-purple-500 cursor-pointer transition" onclick="selectMfaMode('off')">
                                            <input type="radio" name="mfa-mode" value="off" class="mr-4 accent-purple-500">
                                            <div class="flex-1">
                                                <span class="font-medium"> Disabled</span>
                                                <p class="text-sm text-gray-500">MFA is turned off for all users</p>
                                            </div>
                                        </label>
                                        
                                        <label class="flex items-center p-4 rounded-lg border border-gray-700 hover:border-purple-500 cursor-pointer transition" onclick="selectMfaMode('optional')">
                                            <input type="radio" name="mfa-mode" value="optional" class="mr-4 accent-purple-500">
                                            <div class="flex-1">
                                                <span class="font-medium"> Optional</span>
                                                <p class="text-sm text-gray-500">Users can enable/disable MFA from their profile</p>
                                            </div>
                                        </label>
                                        
                                        <label class="flex items-center p-4 rounded-lg border border-gray-700 hover:border-purple-500 cursor-pointer transition" onclick="selectMfaMode('admins')">
                                            <input type="radio" name="mfa-mode" value="admins" class="mr-4 accent-purple-500">
                                            <div class="flex-1">
                                                <span class="font-medium"> Required for Admins</span>
                                                <p class="text-sm text-gray-500">Administrators must use MFA, others optional</p>
                                            </div>
                                        </label>
                                        
                                        <label class="flex items-center p-4 rounded-lg border border-gray-700 hover:border-purple-500 cursor-pointer transition" onclick="selectMfaMode('all')">
                                            <input type="radio" name="mfa-mode" value="all" class="mr-4 accent-purple-500">
                                            <div class="flex-1">
                                                <span class="font-medium"> Required for Everyone</span>
                                                <p class="text-sm text-gray-500">All users must verify with email code</p>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <div id="mfa-save-status" class="mt-4 text-sm text-green-400 hidden"> Settings saved automatically</div>
                                </div>
                            </div>
                            
                            <!-- User Status Section -->
                            <div class="bg-gray-800/50 rounded-xl p-6 mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-semibold mb-1">Your MFA Status</h4>
                                        <p id="mfa-status-text" class="text-sm text-gray-400">Loading...</p>
                                    </div>
                                    <div id="mfa-status-badge">
                                        <span class="px-3 py-1 rounded-full text-sm bg-gray-600 text-gray-300">Loading</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- How it works -->
                            <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 mb-6">
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl"></span>
                                    <div>
                                        <h4 class="font-semibold text-blue-400 mb-1">How it works</h4>
                                        <p class="text-sm text-gray-400">When you log in, a 6-digit code will be sent to your email. Enter this code to complete sign-in.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- User MFA Toggle (shows for Optional mode) -->
                            <div id="mfa-user-toggle-section" class="hidden">
                                <div class="border border-gray-700 rounded-xl p-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="font-semibold mb-1">MFA for my account</h4>
                                            <p class="text-sm text-gray-400">Enable or disable MFA for your login</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="mfa-user-enabled" class="sr-only peer" onchange="toggleUserMFA()">
                                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="sec-content-settings" class="hidden card rounded-xl p-6" data-permission="security:settings">
                        <h3 class="text-lg font-bold mb-6">Security Settings</h3>
                        <form id="security-settings-form" class="space-y-6">
                            <!-- Authentication Settings -->
                            <div>
                                <h4 class="font-semibold mb-4 text-purple-400"> Authentication</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Registration Mode</label>
                                        <select id="sec-setting-registration_mode" name="registration_mode" class="input-field w-full px-4 py-2 rounded-lg">
                                            <option value="open">Open Registration</option>
                                            <option value="invite_only">Invite Only</option>
                                            <option value="disabled">Disabled</option>
                                        </select>
                            
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Email Verification</label>
                                        <select id="sec-setting-email_verification" name="email_verification" class="input-field w-full px-4 py-2 rounded-lg">
                                            <option value="required">Required</option>
                                            <option value="optional">Optional</option>
                                            <option value="disabled">Disabled</option>
                                        </select>
                            
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Password Policy -->
                            <div>
                                <h4 class="font-semibold mb-4 text-purple-400"> Password Policy</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Minimum Length</label>
                                        <input type="number" id="sec-setting-password_min_length" name="password_min_length" min="8" max="32" value="8" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Password Expiry (days, 0=never)</label>
                                        <input type="number" id="sec-setting-password_expiry_days" name="password_expiry_days" min="0" value="0" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                    <div class="col-span-2 space-y-2">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="sec-setting-require_uppercase" name="require_uppercase" class="rounded">
                                            <span class="text-sm">Require uppercase letter</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="sec-setting-require_number" name="require_number" class="rounded">
                                            <span class="text-sm">Require number</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="sec-setting-require_symbol" name="require_symbol" class="rounded">
                                            <span class="text-sm">Require special character</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Session Settings -->
                            <div>
                                <h4 class="font-semibold mb-4 text-purple-400"> Session</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Session Timeout (minutes)</label>
                                        <input type="number" id="sec-setting-session_timeout" name="session_timeout" min="15" value="1440" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Remember Me Duration (days)</label>
                                        <input type="number" id="sec-setting-remember_me_days" name="remember_me_days" min="1" value="30" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Max Concurrent Sessions</label>
                                        <input type="number" id="sec-setting-max_sessions" name="max_sessions" min="1" value="3" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                </div>
                            </div>

                            <!-- Security Policy -->
                            <div>
                                <h4 class="font-semibold mb-4 text-purple-400"> Security</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Account Lockout After (attempts)</label>
                                        <input type="number" id="sec-setting-lockout_attempts" name="lockout_attempts" min="3" value="5" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Lockout Duration (minutes)</label>
                                        <input type="number" id="sec-setting-lockout_duration" name="lockout_duration" min="5" value="30" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end pt-4 border-t border-gray-700">
                                <button type="button" onclick="saveSecuritySettings()" class="btn-primary px-6 py-2 rounded-lg">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Create Agent Wizard - AI-Powered -->
            <section id="page-create" class="hidden flex-1 p-4 md:p-6" style="overflow-y:auto !important; -webkit-overflow-scrolling:touch;">
                
                <!-- Steps Progress Bar -->
                <div id="wizard-progress" class="hidden mb-8">
                    <div class="flex items-center justify-start md:justify-center gap-1 md:gap-2 overflow-x-auto pb-2">
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-1" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-active cursor-pointer text-xs md:text-sm" onclick="goStep(1)">1</div>
                            <span class="text-xs whitespace-nowrap hidden md:inline">Basics</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-2" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(2)">2</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Tasks</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-3" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(3)">3</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Tools</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-4" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(4)">4</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Guardrails</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-5" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(5)">5</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Preview</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-6" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(6)">6</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Test</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-7" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(7)">7</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Deploy</span>
                        </div>
                    </div>
                </div>

                <!-- Step 0: Goal Input (Initial Step) -->
                <div id="wizard-step-0" class="max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center mb-4">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAASz0lEQVR42m1aebBcZZU/v/Pd7n793svG5oIYAUtcWNywRkURsXBFFEUH1AooijrKDDgIiFtUlNIBHXRgym2mMguKU5aKKXRQoBAEghAxQgScCCJZyPqW5PVy7/nNH996H3bSye3uu3zfWX7ndxZ0OstFRAThnV+IX4HpJwj/yslIp7e/CW+SKH9hPCZFKBBQCKEIyHAKKQDJeCeEk4ur/R2qdOjfKBbG1k+IC2L8BWnp5a6YFkkBIEJAy+dSwn6Y5UAhAXgpkP6DqMAfU/zG/AGFcZlA1ZJ5Xn0SalwrvITBtEjkDaR1J0VEjQFQvxuS/pxwp7AKkiQUIsU9vD7EQDF4tTDLAIhbEmElgqA9IRdbkf+RUdpg+t1LPe6qPKIQorJIj8XvXiH+BUHQXyk4Fh+88ki0jSdog1IFVUtp1UhSj6uHP43JIpNjRD1AkJfKqOZgEgZC2k9B8hmW/7HtK+mK7A7xPAYTWrRqeYJ7ZuvPuverjmYITfsksv8HaTLYm/fL8hnwX2bIYPBstPcSRMxil4wyZSVPfPknQUCmh2SB+SOoPzOo3CsbKM8LrqmaV5Yu985IChiuYJSuFzGtwCsA6m0c4T5e/xSRahG6hfsBScCEBjD1BhxV4X1AoMGtATxhlwwnR1zJBkJQCIg4CoUWnhoWRyCiRdRgVHFCy+C41SJXKzxUiLQTf7kGd4VGv0FQhViyeCnNzCMjrW2U0UGSOKHeI9O+mfC68MOMYxEODNmEkEJGkEW5IA/KUohYEe3Mn+8kaU7CnikCvz2okAxgHw6jUXvDSBBl3oDT9UKBIoAwAAFhYNiiCKrkqCk2McI8EtgHaab9aJAtQjBCDoIK1SySHMwJodCCLflteD8Wy/7pQx6b+DhlEbej6JUQiGUYbbMAib4Ib+LJoINSoQlEol3nMAfnIgQByT1irBUDRAL0WBPQQjRGWEb7Vb/nyFtACERJ81EchW1VGZe9TXpXDFvSQH8Yfgqmm8wkniNQUQUgqgIFHFShAJRmJEVIawgTkjShwAnNPINIIVrMJCBfEQOSehDcIJgMAUhVwj7bS/fAEgXj75y+DyEMAoESAlVRB3VV1aG6UcOxsWlMaB3nep2qo9LUtTWNsKEZGSxJaGFlJJwTkmYAg/3QEAO4hxUGn/FmH7lQNBj/p1h9lDcJKIAUqqJPe0NSFXVadVl1ZwbjTr962jMOXnnIU1asWFaPx1u2Pv7HPz265/GdvV6n3+/Vw4GgEWtCnDPvSkywAxUa/ZoZuISAiYAlQkiSFaLLUyKCSVis3yVFA8QjBVCIPwEQVUAFCufMVf0V+5311tcdd+zRK5ZOD0f1zOwcoEun+91u5/cPbPrO967beN8DyyYnbTS0ekyBmImaCMUIMYloKpGAetRCINSJ/2WWjYnuAQKxHLw0gEwIXt5BC51ABE4EUIhzPhRAnXa69cTU2jVX9PqTV16z9obbfrPr4b+Ik06lnap6xtMPPvmkV5z86pf+8rbfXPr1Nd1m7JpRPRyIGWlCIw1mQgkfvdMzxDLxSEXzzCp+SYq4qppixEp4OPc44w+S5BXQuBnnolZURKAOnS7UuYnJbr9fG1/4nMNOe+0rnv2sQzdtfnzfwmjZ9NT2HbtuuuO31996z2lvOOHs009ee+vdCwsLlcLMRCySaxYEvsTtRVQTJeGJG8ioH/m9B5ZwsWYKpE4UIQaHTQpcBXUw+/X6+39x+/ob7rz395seO/LZh1909ju2zczes3HT0n5vsleNh8Nrrrvx4KccdP77Trv+V3ePBgPQAgfwpkgLviiReaCMAlxE7SBwWk1GWowQAcJSNdGi4BJQ0aiW/K9Co96Afq/TATlutj2+82e/Xn/Xg3/+p39873Dc3LXhD10QZv1e9+77/3jm299w47p7Z2dmnarFVDHFkgAp2V9LtpDjmsdHFR8+y2SAAWQytgaRg4kvqANUtIJzqCq4yu+hNjYGG406Vh840d14/0Nv//jlHzvrbYeufNrQRFSH43rlUw5asXRq+X4rZsfSdHrdyUntdlF1RFWCLCKXkRSU8mLQIjjiXDUZ7UdzdoKkSYVfvagoAM8UVKDiKlFVdXAuPhjodEUVQoEjadCXv/ioQw8+6Nqf3QIzUjpVZ+vO3Q9sevSSD51xyCFP3bp77tGtOyZ7HYEyBWMPiplf5AQ8IHuRRDhXTXs2j+y+aaPBogAVTbHWESKqUAWcKFhCari3iqKqqgXjt1efe+2Nd96y7nf7LZ32uDk1Ofnbex885ugjTvqbY153/Eu2ze576OHHOpVT52L9IoaqmMsjMeMi6fGKcK6aiqQrGB+DffuVazCngPcQV4kAGkyfSGoRAbTT80mM6/ZM3b6x/Wnn7CVnnbpjZm7dfQ+Jc0OTPfODf/jQ6cc9/znHv/uCjQ9v/trF53zv+lu6E73DD1u5fccuFdIaD00MFDCmbZFICHPBpPKMlQnkg2uW5RTGlDgWAMJNDHA+1YA3Nld5cVWdzsC4fP/l16w+96bfPfjOz1615pMfWHnwk3fOzL3l+GPX3rHhbSe+bNUnvsr+1Gte/qJ1v39o+8zC0Uc+662vP27dhoeWdoG6tqYWX6wwZeDYOXvOuSjgqmo6ZR6F+EVyHBDvXgGmFIgBGKpwlaiDBC4kAld1xnATK1b86MpPXX/H74469KknHvu8cy77zntef9xRhx/y8zs3fPmjZ7xv9VX33rPxjLe9dtXJx3/osu/u/6QDPvquk997ygnrH96yZ2bORkOra18agIA+vQyZXMgSUknJVcEHEDfhV685XQkmLoAL5gR4r4U6UQf1puUA0apiVVl/8if/8pmf3HzXV7517fW3r3/uMw7+yGmvfe/nrrp27c2337NxL/HBU0/Uie75737T+1ZftWLJ1HnvefM5p7xqott59bFHzewbbN68dW7PjHiumqsVMckuYpmX1xJhiAAiKqoi3l0jiikETqBINA4qzkmQunrzI6CuQtXZh+qHV376jrvv+8I31jz1wBVWNw8+tm3Vya+67sY7Rnv3Luv3btvw4MK4eePxL/7ct3/4yBB7ds78zy/X7RzUz336k0/4wGduvvHWvbt2STNmY7niQ6ZAQYoiV7pc1ZkOhQAPNdF5GTN1SX8FUCfOiWqwmQhT3vtdb2KmwZqvXLhl87YLLrv6wKWTZlyo6+99+ePf/NFNv7rzt1MdNxoOJ8Tu/cOmH/zvbdu27Trs2Be9aNXpW+57YPOjf5mZm/vZDbdM26geDljXCKU2ERKMhdQyQxKK0FWdJQH4WqkKI8XWnLJICMkxAKvnQqoefrp7BvU/f/bv+5W8/6Kv7L9kUhXbd8994oNnTEz2P33lmgOn+uPxmPWYZv1Kpyd63U61Z9v2lS97SdXtPHb77Tu2b597fKsNBzYeiTUBP1pkQtofKSLoTjypiGIS4JJSaMOJhihGUVEfhgF19Cer9vqTO+eHF59/9nHHHHHKBz+1pNepqmp+MD76qCOu/uy5b/y7zw9m90hdW93QGgpVXQBiV9XiJiYn6tndHC3UCwsyHlkzgpHW0JqQ5pNkQ3onplggsCKsynIIUp1Zc+WNZHDrVHL0tRBSzETR7XZ2zu5d9e5T3/zKF5+06oJJpxBpGmrHXXHROau/+YPtW7Yum+jUde0BkWZWNxATKKAKDGa202ppatZjWiMiFBNPm6Pz+owzHoawRYacOL1RFCVTW4AkA/BqrAvFV6fT2T0/eM2Jr/zYmae+8awL68Gg160U2DG396ovnHfXxj/9+PqbD5jqjgaDkF3TnIM1xobCml60ZmINrYGXt5lYrkSRY7JVI0qegFheZ07SQwmzKPql2rhXEBm3hqrTnR+Oj3j2M796yYfPPO/zWx7bvGR6SoAdM/N/+5aTnnvEYa8/5zP7TU/U41G6DyjWNGKNz2BCKmx+3QElGVkR2BRhF7HJkbDV10ZjSCvQlrEiHEJsKJ+Ez6QZVJ3T4bhZtnzZf3z1Uxdd+o2712/Yb8WyxprR2J55+MqLP/yu0y+8XBb20anVdcik/LPMJIWm8GWk1CSi5SQGEcu6vqqSEoVQR9VQpaDlHo3GyhrDdSDj5unLJICSbESu/eZl3/2vH6/96S/2X76srhsRGZPfuvT8y9f85P4NG/sV6rq26I4krRnTGtLEYn2F6bYm7SIK4IEud4CiGjNTTaVFZXbSlLKFSkDUojdMp6paVbPzC9f82xV33X3v1d/4zvInHzQY7Ov2ert3z339yxdvfGTLmv/+0f5TvdFgGLYdyzlivkZkgRbQfMSNRmHhVPN5MFNrLBmRdw5ftqBIhcU9gYA6oQqQGWyqu4g6Nzs7f+nqj8GaCy/+0tIDVozHo063t3vnnjNXveOo5zzzpFUXLO9X49Eg+qKv73obCIulx0EzocFnZF4PZknb8SDnCbHdkXpsrIJveOoX/MEoCl93KFtXFFDUYWEwfP4LjnzpC49807vOXXLA/k3TVM7Nz80f8/znnf/+d775/Ze48VAc6E0/8XhGQ6WQja+WkmFLvrIVc8tcdqC/qmjj5G4CIKRmip2dBsCijhPKeoGZTXQ7w+F439xeoXS7nbqxqSXT3778kxd86V8f+b9NE8p6NKQFfJRmLE3DuhEzkLQGZojil+gDwqbojDJ7IXK3J28hKlTbXcp2o8nSvoJFkrTGpvq9devWb/rzY9f++xV1Pd69a2bvvoX/vPqL3//pTT9f+4vl/e54sMCmYdOINWJGIxvz+0lgTwsW5Z2bNFpTOAwLx5D4fRR/Ai7SOTedqXSqBpSJMxBJrI8EpLHT7Vx3w60vfMGRl5x39mDfvtWf+MgjW3d8+vNfW7Z0cjQcSO5EFN1pitBoBkkiDyUq+L9IIBMAF5B29zzBK3MjujvxJMTKT+pQ+MZRTgxSxgMlIFDPnOfnF0448RVvP+Wk+x96+Krvfn+666xphEWTO3aCJTUtglkzCRtCX58DQIugFAUs0U+SZpBCis+Mu70DQ70tZ/EiomUFJZaH4wac83t2VXd+Yci6kapasmTSmkbKqYSWy6W3x3sg4aMvuJuJEIQvLbZtqXCJQGoYcNa3WVMZUoSkIvTUKKIhzqsWj0/1ezY2mu510O9RpBmNJDc7yLI25VlQpGKgBIxPflkexw/F/xZQk6kw7f0DJF3lplCMFkByXinJG9BirCg6fxSaNwCRopmXpCsRzpvYlvXrYGo7ZPDIybsVwJ9xKdCkROxEIFKlqkK+Hy0wCsRzvfGpRo5kcWDB/LlQjcMAJpY6I8Ys1xgac7g0/2R4CEq/mKUWrocrD4iQcp3iIdIn9ZN5+KQg1gl84AttuS3KVGfJDSC2k4dIGcmIOV5FvuzkT7ZI7oUhT8h18zjKIuJ7H8FkM1kKEAvSuWoyN3RjLbTo2iCO+0AS0sXmeorVRXzPz6ZYMcmB5Arx8WGLraEQv0RKq7Ucw9Yiu/KUztdGF5XeQ/E5zTy13SCbW4riCIV4AsHEI4nKTwqcNxRLQtNBINF+uHhwqYzKiQuKFaTIjxqUMxixybx4pCk4RtEtRtS+T/mbBt7UYurn51MSVqQ0RRCLhYF5eWbKEm0zubTkBKFPw2xaAa6c036aSEn5ceRuxSRTwY9AeUITtJg7STbACOEoR81QXJWGB1gIvsU9UzevbWxMFSPnXL9IieMucrcmZ8uxU9Yap8urKXbEaF9FnhdjFpincHIulgJ2mkfJWQRQ1lRym9jvujVuwzAOonH+jr5eJIXRhAZi2e5EKXofIwMUeMAtuisIDbyywhyPkQGtaNJLaqGSoZsWByIACCOM5vma0BXJbc74McdVLHa31j9oB6B0bNYGnNLTJGQLBUwib6bV8kBJ9hlNCGnGJbeCW/NhbXITB6ISzkAKcy+cDJmIZktjew8oV88C4bh4fBIozZahtOj6xWktytCeY1xs6MiTk2mKp3A4thwiFRnAwnqYQkHqYiTzLCCfsQORP2ZAqJitEGniNEx4MI1IMRSz6NtvqcQSn4WU1hVENGpdipFDT5tRtsCYUpXcAG6PuCIjaXG/RSNnaHU0mdBRoFrMwiwyEFoe/2xNV4J5gjGbUA4hLCYGkl1ZHszJZQz5K8ONzDKrUmpTmkkcpKX4yaI8UERa8mYUxYGonMQF4mhcEbvTCDJboSgvpqiLlGtFziSJBFnhWqduAq1RpyLUtdydkdUlU5IWmBSbFD7BfXKkl+QtMXGxkjjkaBAptIaZwZb+E/hWWDSuVQ7V+QnsVqUgtj1YAjlELI9SRRoQQwRaQZQ5Syh8w6JB5aInCn0ByUpZwBhkUSCLMTOvLPBYxMpwcCcm3hzl5AfQLZ4mbYIg7c6KZIYjwvxAtiJaO5QgnYtyRp1VHoBqq7xcIUpmQIsgY5LJRfRXcrFdsSDbOY4wkL1okmiRUMaWJIt5UoZkov36f35wZllthY/qAAAAAElFTkSuQmCC" alt="" class="w-12 h-12">
                        </div>
                        <h2 class="text-2xl md:text-3xl font-bold mb-2">AgentForge Studio</h2>
                        <p class="text-gray-400">Tell us what you want your agent to do, and we'll configure everything for you</p>
                    </div>
                    
                    <div class="card rounded-xl p-6 md:p-8">
                        <label class="text-sm text-gray-400 mb-2 block">What should your agent do? *</label>
                        <textarea id="w-initial-goal" rows="4" class="input-field w-full rounded-lg px-4 py-4 text-lg" placeholder="Example: Help customers track their orders, answer product questions, and process returns..."></textarea>
                        
                        <div class="mt-6 flex flex-col sm:flex-row gap-3">
                            <button onclick="generateAgentConfig()" id="btn-generate-config" class="btn-primary px-8 py-3 rounded-lg flex-1 flex items-center justify-center gap-2 text-lg">
                                <span></span> Configure My Agent
                            </button>
                        </div>
                        
                        <div class="mt-6 pt-6 border-t border-gray-700">
                            <p class="text-sm text-gray-500 mb-3">Or try one of these templates:</p>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="useAgentTemplate('customer_support')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition"> Customer Support</button>
                                <button onclick="useAgentTemplate('sales')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition"> Sales Assistant</button>
                                <button onclick="useAgentTemplate('hr')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition"> HR Helper</button>
                                <button onclick="useAgentTemplate('research')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition"> Research Analyst</button>
                                <button onclick="useAgentTemplate('coding')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition"> Coding Assistant</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Generating Animation -->
                <div id="wizard-generating" class="hidden max-w-2xl mx-auto">
                    <div class="card rounded-xl p-8 text-center">
                        <div class="relative w-24 h-24 mx-auto mb-6">
                            <div class="absolute inset-0 rounded-full border-4 border-purple-500/30 animate-ping"></div>
                            <div class="absolute inset-2 rounded-full border-4 border-blue-500/30 animate-ping" style="animation-delay: 0.2s"></div>
                            <div class="absolute inset-4 rounded-full border-4 border-purple-500/30 animate-ping" style="animation-delay: 0.4s"></div>
                            <div class="relative w-full h-full rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-3xl">
                                
                            </div>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Configuring Your Agent...</h3>
                        <p class="text-gray-400 mb-6" id="generating-status">Analyzing your goal...</p>
                        <div class="space-y-2 text-left max-w-md mx-auto">
                            <div class="flex items-center gap-3 text-sm" id="gen-step-1">
                                <span class="w-5 h-5 rounded-full bg-purple-500 flex items-center justify-center animate-pulse"></span>
                                <span>Understanding your requirements</span>
                            </div>
                            <div class="flex items-center gap-3 text-sm text-gray-500" id="gen-step-2">
                                <span class="w-5 h-5 rounded-full bg-gray-700 flex items-center justify-center"></span>
                                <span>Selecting optimal AI model</span>
                            </div>
                            <div class="flex items-center gap-3 text-sm text-gray-500" id="gen-step-3">
                                <span class="w-5 h-5 rounded-full bg-gray-700 flex items-center justify-center"></span>
                                <span>Defining tasks & capabilities</span>
                            </div>
                            <div class="flex items-center gap-3 text-sm text-gray-500" id="gen-step-4">
                                <span class="w-5 h-5 rounded-full bg-gray-700 flex items-center justify-center"></span>
                                <span>Recommending tools</span>
                            </div>
                            <div class="flex items-center gap-3 text-sm text-gray-500" id="gen-step-5">
                                <span class="w-5 h-5 rounded-full bg-gray-700 flex items-center justify-center"></span>
                                <span>Setting up guardrails</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Basics (AI-Generated, Editable) -->
                <div id="wizard-step-1" class="hidden max-w-5xl mx-auto">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-xl"></span>
                        <div>
                            <h3 class="text-lg font-bold">Basic Configuration</h3>
                            <p class="text-xs text-gray-400">AI-suggested settings based on your goal</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
                        <!-- Main Config - Left Side -->
                        <div class="lg:col-span-8 space-y-4">
                            <!-- Agent Identity - Compact -->
                            <div class="card rounded-xl p-4">
                                <h4 class="text-sm font-semibold mb-3 flex items-center gap-2 text-gray-300">
                                    <span></span> Agent Identity
                                </h4>
                                <div class="flex gap-4">
                                    <!-- Icon Upload -->
                                    <div class="flex-shrink-0">
                                        <label class="text-xs text-gray-400 mb-1 block">Icon</label>
                                        <div class="relative">
                                            <div id="w-icon-preview" class="w-16 h-16 rounded-xl bg-gray-800 border-2 border-dashed border-gray-600 hover:border-purple-500 cursor-pointer flex items-center justify-center text-2xl transition-all"
                                                 onclick="document.getElementById('w-icon-upload').click()">
                                                <span id="w-icon-emoji"></span>
                                                <img id="w-icon-image" class="hidden w-full h-full object-cover rounded-xl" src="" alt="Icon">
                                            </div>
                                            <input type="file" id="w-icon-upload" class="hidden" accept="image/*" onchange="handleIconUpload(event)">
                                            <input type="hidden" id="w-icon" value="">
                                            <input type="hidden" id="w-icon-type" value="emoji">
                                            <input type="hidden" id="w-icon-data" value="">
                                            <button onclick="showIconPicker()" class="absolute -bottom-1 -right-1 w-6 h-6 bg-purple-600 rounded-full text-xs flex items-center justify-center hover:bg-purple-500 transition" title="Change icon">
                                                
                                            </button>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 text-center">Click to upload</p>
                                    </div>
                                    <!-- Name -->
                                    <div class="flex-1">
                                        <label class="text-xs text-gray-400 mb-1 block">Name *</label>
                                        <input type="text" id="w-name" class="input-field w-full rounded-lg px-3 py-2 text-sm" placeholder="Agent Name" oninput="updateAgentNameInPersonality()">
                                        <p class="text-[10px] text-purple-400 mt-1" id="w-name-hint"> AI suggested name based on your goal</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Enhanced Goal - Compact -->
                            <div class="card rounded-xl p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-semibold flex items-center gap-2 text-gray-300">
                                        <span></span> Enhanced Goal
                                        <span class="text-[10px] bg-purple-500/20 text-purple-300 px-1.5 py-0.5 rounded">AI Optimized</span>
                                    </h4>
                                    <div id="goal-update-indicator" class="hidden flex items-center gap-2">
                                        <div class="w-3 h-3 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                                        <span class="text-[10px] text-purple-400">Updating recommendations...</span>
                                    </div>
                                </div>
                                <textarea id="w-goal" rows="3" class="input-field w-full rounded-lg px-3 py-2 text-sm" placeholder="Your agent's goal..." oninput="onGoalChange()"></textarea>
                                <p class="text-[10px] text-gray-500 mt-1" id="goal-hint">Enhanced version of your goal, optimized for better AI understanding</p>
                            </div>
                            
                            <!-- Personality - Interactive Sliders -->
                            <div class="card rounded-xl p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="text-sm font-semibold flex items-center gap-2 text-gray-300">
                                        <span></span> Personality Configuration
                                    </h4>
                                    <button onclick="resetPersonalityDefaults()" class="text-[10px] text-gray-500 hover:text-gray-300 transition">
                                         Reset to Defaults
                                    </button>
                                </div>
                                
                                <!-- Personality Preview -->
                                <div class="bg-gradient-to-r from-purple-900/20 to-blue-900/20 border border-purple-500/20 rounded-lg p-3 mb-4">
                                    <div class="flex items-start gap-2">
                                        <span class="text-lg"></span>
                                        <div class="flex-1">
                                            <p class="text-xs font-medium text-purple-300 mb-1">Personality Preview</p>
                                            <p class="text-xs text-gray-400" id="personality-preview-text">
                                                Your agent will be professional and balanced in responses.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Personality Sliders -->
                                <div class="space-y-4" id="personality-sliders">
                                    
                                    <!-- Creativity Slider -->
                                    <div class="personality-slider-group">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm"></span>
                                                <span class="text-xs font-medium text-gray-300">Creativity</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="p-creativity-num" min="1" max="10" value="5" 
                                                       class="w-12 text-center text-xs bg-gray-800 border border-gray-700 rounded px-1 py-0.5"
                                                       onchange="syncSlider('creativity', this.value)">
                                                <span class="text-[10px] text-gray-500">/10</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-gray-500 w-16">Factual</span>
                                            <input type="range" id="p-creativity" min="1" max="10" value="5" 
                                                   class="personality-slider flex-1" 
                                                   oninput="updatePersonalitySlider('creativity', this.value)">
                                            <span class="text-[10px] text-gray-500 w-16 text-right">Creative</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 ml-6" id="p-creativity-desc">
                                            Balanced between facts and creative suggestions.
                                        </p>
                                    </div>
                                    
                                    <!-- Response Length Slider -->
                                    <div class="personality-slider-group">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm"></span>
                                                <span class="text-xs font-medium text-gray-300">Response Length</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="p-length-num" min="1" max="10" value="5" 
                                                       class="w-12 text-center text-xs bg-gray-800 border border-gray-700 rounded px-1 py-0.5"
                                                       onchange="syncSlider('length', this.value)">
                                                <span class="text-[10px] text-gray-500">/10</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-gray-500 w-16">Brief</span>
                                            <input type="range" id="p-length" min="1" max="10" value="5" 
                                                   class="personality-slider flex-1" 
                                                   oninput="updatePersonalitySlider('length', this.value)">
                                            <span class="text-[10px] text-gray-500 w-16 text-right">Detailed</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 ml-6" id="p-length-desc">
                                            Moderately detailed responses with key information.
                                        </p>
                                    </div>
                                    
                                    <!-- Formality Slider -->
                                    <div class="personality-slider-group">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm"></span>
                                                <span class="text-xs font-medium text-gray-300">Formality</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="p-formality-num" min="1" max="10" value="7" 
                                                       class="w-12 text-center text-xs bg-gray-800 border border-gray-700 rounded px-1 py-0.5"
                                                       onchange="syncSlider('formality', this.value)">
                                                <span class="text-[10px] text-gray-500">/10</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-gray-500 w-16">Casual</span>
                                            <input type="range" id="p-formality" min="1" max="10" value="7" 
                                                   class="personality-slider flex-1" 
                                                   oninput="updatePersonalitySlider('formality', this.value)">
                                            <span class="text-[10px] text-gray-500 w-16 text-right">Formal</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 ml-6" id="p-formality-desc">
                                            Professional tone suitable for business communication.
                                        </p>
                                    </div>
                                    
                                    <!-- Empathy Slider -->
                                    <div class="personality-slider-group">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm"></span>
                                                <span class="text-xs font-medium text-gray-300">Empathy</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="p-empathy-num" min="1" max="10" value="6" 
                                                       class="w-12 text-center text-xs bg-gray-800 border border-gray-700 rounded px-1 py-0.5"
                                                       onchange="syncSlider('empathy', this.value)">
                                                <span class="text-[10px] text-gray-500">/10</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-gray-500 w-16">Direct</span>
                                            <input type="range" id="p-empathy" min="1" max="10" value="6" 
                                                   class="personality-slider flex-1" 
                                                   oninput="updatePersonalitySlider('empathy', this.value)">
                                            <span class="text-[10px] text-gray-500 w-16 text-right">Empathetic</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 ml-6" id="p-empathy-desc">
                                            Shows understanding while staying solution-focused.
                                        </p>
                                    </div>
                                    
                                    <!-- Proactivity Slider -->
                                    <div class="personality-slider-group">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm"></span>
                                                <span class="text-xs font-medium text-gray-300">Proactivity</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="p-proactivity-num" min="1" max="10" value="5" 
                                                       class="w-12 text-center text-xs bg-gray-800 border border-gray-700 rounded px-1 py-0.5"
                                                       onchange="syncSlider('proactivity', this.value)">
                                                <span class="text-[10px] text-gray-500">/10</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-gray-500 w-16">Reactive</span>
                                            <input type="range" id="p-proactivity" min="1" max="10" value="5" 
                                                   class="personality-slider flex-1" 
                                                   oninput="updatePersonalitySlider('proactivity', this.value)">
                                            <span class="text-[10px] text-gray-500 w-16 text-right">Proactive</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 ml-6" id="p-proactivity-desc">
                                            Answers questions and occasionally suggests next steps.
                                        </p>
                                    </div>
                                    
                                    <!-- Confidence Slider -->
                                    <div class="personality-slider-group">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm"></span>
                                                <span class="text-xs font-medium text-gray-300">Confidence</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="p-confidence-num" min="1" max="10" value="7" 
                                                       class="w-12 text-center text-xs bg-gray-800 border border-gray-700 rounded px-1 py-0.5"
                                                       onchange="syncSlider('confidence', this.value)">
                                                <span class="text-[10px] text-gray-500">/10</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-gray-500 w-16">Cautious</span>
                                            <input type="range" id="p-confidence" min="1" max="10" value="7" 
                                                   class="personality-slider flex-1" 
                                                   oninput="updatePersonalitySlider('confidence', this.value)">
                                            <span class="text-[10px] text-gray-500 w-16 text-right">Confident</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 ml-6" id="p-confidence-desc">
                                            Provides clear answers while acknowledging limitations when appropriate.
                                        </p>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                        
                        <!-- LLM Model Selection - Right Side -->
                        <div class="lg:col-span-4">
                            <div class="card rounded-xl p-4 sticky top-4">
                                <h4 class="text-sm font-semibold mb-3 flex items-center gap-2 text-gray-300">
                                    <span></span> AI Model
                                </h4>
                                
                                <div id="llm-models-list" class="space-y-2 max-h-[280px] overflow-y-auto pr-1">
                                    <!-- Models will be populated dynamically based on configured providers -->
                                </div>
                                
                                <!-- Model Info -->
                                <div id="model-explanation" class="mt-3 p-2 bg-gray-800/50 rounded-lg text-xs">
                                    <p class="text-gray-400" id="model-why-text">Select a model to see details</p>
                                </div>
                                
                                <!-- Configure Link -->
                                <div class="mt-2 text-center">
                                    <a href="#" onclick="navigate('settings'); return false;" class="text-[10px] text-purple-400 hover:text-purple-300">
                                         Configure API Keys in Settings
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-4">
                        <button onclick="goStep(0)" class="btn-secondary px-4 py-2 rounded-lg text-sm"> Start Over</button>
                        <button onclick="nextStep()" class="btn-primary px-5 py-2 rounded-lg text-sm">Next: Tasks </button>
                    </div>
                </div>

                <!-- Icon Picker Modal -->
                <div id="icon-picker-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                    <div class="modal-content-box rounded-xl p-4 w-full max-w-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-sm">Choose Icon</h3>
                            <button onclick="closeIconPicker()" class="text-gray-400 hover:text-white"></button>
                        </div>
                        
                        <div class="space-y-3">
                            <!-- Upload Option -->
                            <div class="p-3 rounded-lg border-2 border-dashed cursor-pointer transition text-center upload-box"
                                 style="background:var(--bg-input);border-color:var(--border-color);"
                                 onclick="document.getElementById('w-icon-upload').click(); closeIconPicker();">
                                <span class="text-2xl"></span>
                                <p class="text-xs mt-1" style="color:var(--text-secondary);">Upload Image</p>
                                <p class="text-[10px]" style="color:var(--text-muted);">PNG, JPG, SVG (max 500KB)</p>
                            </div>
                            
                            <!-- Emoji Picker -->
                            <div>
                                <p class="text-xs mb-2" style="color:var(--text-secondary);">Or choose an emoji:</p>
                                <div id="emoji-grid" class="grid grid-cols-8 gap-1 max-h-32 overflow-y-auto">
                                    <!-- Emojis will be populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Tasks (AI-Generated, Editable) -->
                <div id="wizard-step-2" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl"></span>
                            <div>
                                <h3 class="text-xl font-bold">Tasks & Capabilities</h3>
                                <p class="text-sm text-gray-400">What your agent can do. AI has suggested these based on your goal.</p>
                            </div>
                        </div>
                        <button onclick="addTask()" class="btn-primary px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                            <span>+</span> Add Task
                        </button>
                    </div>
                    
                    <div id="w-tasks" class="space-y-4">
                        <!-- Tasks will be populated by JS -->
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between gap-3 mt-6">
                        <button onclick="prevStep()" class="btn-secondary px-6 py-2 rounded-lg"> Back</button>
                        <button onclick="nextStep()" class="btn-primary px-6 py-2 rounded-lg">Next: Tools </button>
                    </div>
                </div>

                <!-- Step 3: Tools Selection -->
                <div id="wizard-step-3" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="text-2xl"></span>
                        <div>
                            <h3 class="text-xl font-bold">Tools & Data Sources</h3>
                            <p class="text-sm text-gray-400">Select the tools your agent will use</p>
                        </div>
                    </div>
                    
                    <!-- Two Options -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <!-- Option 1: Select Configured Tool -->
                        <div onclick="showSelectToolModal()" class="card rounded-xl p-6 cursor-pointer hover:border-purple-500 transition-all border-2 border-transparent hover:bg-purple-500/5">
                            <div class="text-center">
                                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-purple-500/20 flex items-center justify-center">
                                    <span class="text-3xl"></span>
                                </div>
                                <h4 class="font-bold text-lg mb-2">Select Configured Tool</h4>
                                <p class="text-sm text-gray-400">Choose from existing tools you've already created</p>
                            </div>
                        </div>
                        
                        <!-- Option 2: Configure New Tool -->
                        <div onclick="goToConfigureNewTool()" class="card rounded-xl p-6 cursor-pointer hover:border-green-500 transition-all border-2 border-transparent hover:bg-green-500/5">
                            <div class="text-center">
                                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-green-500/20 flex items-center justify-center">
                                    <span class="text-3xl"></span>
                                </div>
                                <h4 class="font-bold text-lg mb-2">Configure New Tool</h4>
                                <p class="text-sm text-gray-400">Create and setup a new tool for your agent</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selected Tools -->
                    <div class="card rounded-xl p-5 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium flex items-center gap-2">
                                <span></span> Selected Tools
                                <span id="selected-tools-count" class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded-full">0</span>
                            </h4>
                        </div>
                        <div id="w-tools-list" class="space-y-2">
                            <div class="text-center py-6 text-gray-500 text-sm">
                                <span class="text-2xl block mb-2"></span>
                                No tools selected yet<br>
                                <span class="text-xs">Click one of the options above to add tools</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation Buttons -->
                    <div class="flex flex-col sm:flex-row justify-between gap-3 mt-6">
                        <button onclick="prevStep()" class="btn-secondary px-6 py-2 rounded-lg"> Back</button>
                        <button onclick="nextStep()" class="btn-primary px-6 py-2 rounded-lg">Next: Guardrails </button>
                    </div>
                </div>
                
                <!-- Select Tool Modal -->
                <div id="select-tool-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
                    <div class="modal-content-box rounded-2xl w-full max-w-3xl mx-4 max-h-[85vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="font-bold text-lg"> Select Configured Tools</h3>
                            <button onclick="closeSelectToolModal()" class="p-2 hover:bg-gray-700 rounded-lg"></button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[60vh]">
                            <div id="available-tools-list" class="space-y-3">
                                <div class="text-center py-8 text-gray-500">
                                    <div class="animate-spin w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                                    <p class="text-sm">Loading tools...</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
                            <button onclick="closeSelectToolModal()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Cancel</button>
                            <button onclick="confirmToolSelection()" class="px-6 py-2 rounded-lg bg-purple-600 hover:bg-purple-500">Add Selected</button>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Guardrails & Safety -->
                <div id="wizard-step-4" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center gap-2 mb-6">
                        <span class="text-2xl"></span>
                        <div>
                            <h3 class="text-xl font-bold">Guardrails & Safety</h3>
                            <p class="text-sm text-gray-400">Protect your agent and users with these safety settings</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Anti-Hallucination -->
                        <div class="card rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl"></span>
                                    <div>
                                        <h4 class="font-semibold">Anti-Hallucination</h4>
                                        <p class="text-sm text-gray-400">Ensure your agent only provides accurate information</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="guard-anti-hallucination" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:ring-2 peer-focus:ring-purple-500 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-500"></div>
                                </label>
                            </div>
                            <div id="anti-hallucination-options" class="space-y-3 pl-10">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-cite-sources" class="w-4 h-4 rounded" checked>
                                    <div>
                                        <span class="text-sm">Always cite sources</span>
                                        <p class="text-xs text-gray-500">Agent must reference where information comes from</p>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-admit-uncertainty" class="w-4 h-4 rounded" checked>
                                    <div>
                                        <span class="text-sm">Admit when uncertain</span>
                                        <p class="text-xs text-gray-500">Say "I don't know" instead of guessing</p>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-verify-facts" class="w-4 h-4 rounded" checked>
                                    <div>
                                        <span class="text-sm">Verify against knowledge base</span>
                                        <p class="text-xs text-gray-500">Cross-check answers with your data sources</p>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-no-speculation" class="w-4 h-4 rounded">
                                    <div>
                                        <span class="text-sm">No speculation</span>
                                        <p class="text-xs text-gray-500">Only state confirmed facts, never hypothesize</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Content Boundaries -->
                        <div class="card rounded-xl p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-2xl"></span>
                                <div>
                                    <h4 class="font-semibold">Content Boundaries</h4>
                                    <p class="text-sm text-gray-400">Define what your agent should and shouldn't discuss</p>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-2 block">Topics to AVOID (one per line)</label>
                                    <textarea id="guard-avoid-topics" rows="3" class="input-field w-full rounded-lg px-4 py-3 text-sm" placeholder="Competitor pricing&#10;Legal advice&#10;Medical diagnoses"></textarea>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-2 block">Stay focused on (optional)</label>
                                    <textarea id="guard-focus-topics" rows="2" class="input-field w-full rounded-lg px-4 py-3 text-sm" placeholder="Only discuss topics related to your business"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Response Limits -->
                        <div class="card rounded-xl p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-2xl"></span>
                                <div>
                                    <h4 class="font-semibold">Response Limits</h4>
                                    <p class="text-sm text-gray-400">Control how your agent responds</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-2 block">Max response length</label>
                                    <select id="guard-max-length" class="input-field w-full rounded-lg px-4 py-3">
                                        <option value="short">Short (1-2 paragraphs)</option>
                                        <option value="medium" selected>Medium (3-4 paragraphs)</option>
                                        <option value="long">Long (detailed explanations)</option>
                                        <option value="unlimited">Unlimited</option>
                                    </select>
                            
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-2 block">Language</label>
                                    <select id="guard-language" class="input-field w-full rounded-lg px-4 py-3">
                                        <option value="user">Match user's language</option>
                                        <option value="en">English only</option>
                                        <option value="ar">Arabic only</option>
                                        <option value="multi">Multilingual</option>
                                    </select>
                            
                                </div>
                            </div>
                        </div>
                        
                        <!-- Escalation Rules -->
                        <div class="card rounded-xl p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-2xl"></span>
                                <div>
                                    <h4 class="font-semibold">Escalation Rules</h4>
                                    <p class="text-sm text-gray-400">When to hand off to a human</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-escalate-angry" class="w-4 h-4 rounded" checked>
                                    <span class="text-sm">Escalate frustrated or angry users</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-escalate-complex" class="w-4 h-4 rounded" checked>
                                    <span class="text-sm">Escalate complex issues agent can't handle</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-escalate-request" class="w-4 h-4 rounded" checked>
                                    <span class="text-sm">Escalate when user asks for human</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-escalate-sensitive" class="w-4 h-4 rounded">
                                    <span class="text-sm">Escalate sensitive topics (legal, financial)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- PII Protection -->
                        <div class="card rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl"></span>
                                    <div>
                                        <h4 class="font-semibold">PII Protection</h4>
                                        <p class="text-sm text-gray-400">Protect personal information</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="guard-pii-protection" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:ring-2 peer-focus:ring-purple-500 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-500"></div>
                                </label>
                            </div>
                            <div class="space-y-3 pl-10">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-mask-pii" class="w-4 h-4 rounded" checked>
                                    <span class="text-sm">Mask sensitive data in logs (SSN, credit cards)</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-no-store-pii" class="w-4 h-4 rounded" checked>
                                    <span class="text-sm">Don't store personal data in conversation history</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between gap-3 mt-6">
                        <button onclick="prevStep()" class="btn-secondary px-6 py-2 rounded-lg"> Back</button>
                        <button onclick="nextStep()" class="btn-primary px-6 py-2 rounded-lg">Next: Preview </button>
                    </div>
                </div>

                <!-- Step 5: Preview -->
                <div id="wizard-step-5" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center gap-2 mb-6">
                        <span class="text-2xl"></span>
                        <div>
                            <h3 class="text-xl font-bold">Review Your Agent</h3>
                            <p class="text-sm text-gray-400">Make sure everything looks good before testing</p>
                        </div>
                    </div>
                    
                    <div id="w-preview" class="space-y-4">
                        <!-- Preview content will be populated by JS -->
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between gap-3 mt-6">
                        <button onclick="prevStep()" class="btn-secondary px-6 py-2 rounded-lg"> Back</button>
                        <button onclick="nextStep()" class="btn-primary px-6 py-2 rounded-lg">Next: Test </button>
                    </div>
                </div>

                <!-- Step 6: Test -->
                <div id="wizard-step-6" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl"></span>
                            <div>
                                <h3 class="text-xl font-bold">Test Your Agent</h3>
                                <p class="text-sm text-gray-400">Try a conversation to see how your agent responds</p>
                            </div>
                        </div>
                        <button onclick="resetTestConversation()" class="btn-secondary px-4 py-2 rounded-lg text-sm flex items-center gap-2" title="Clear conversation and start fresh">
                             Reset Chat
                        </button>
                    </div>
                    
                    <div class="card rounded-xl p-4 md:p-6 mb-4">
                        <div id="test-messages" class="h-64 md:h-80 overflow-y-auto rounded-lg p-4 mb-4 space-y-3" style="background:var(--bg-primary);"></div>
                        <div id="test-attachments" class="hidden flex flex-wrap gap-2 mb-2"></div>
                        <div class="flex gap-2 items-end">
                            <button onclick="document.getElementById('test-file-input').click()" class="btn-secondary p-2 rounded-lg flex-shrink-0" title="Attach file">
                                
                            </button>
                            <input type="file" id="test-file-input" class="hidden" accept=".pdf,.doc,.docx,.txt,.csv,.xlsx,.xls,.pptx,.ppt,.md,.png,.jpg,.jpeg,.gif,.webp,.bmp,.svg" onchange="handleTestFile(event)" multiple>
                            <input type="text" id="test-input" class="input-field flex-1 rounded-lg px-4 py-3" placeholder="Ask your agent something..." onkeypress="if(event.key==='Enter')sendTest()">
                            <button onclick="sendTest()" class="btn-primary px-6 py-3 rounded-lg">Send</button>
                        </div>
                    </div>
                    
                    <div class="card rounded-xl p-4 mb-4">
                        <h4 class="text-sm font-medium mb-3"> Try asking:</h4>
                        <div id="test-suggestions" class="flex flex-wrap gap-2">
                            <!-- Suggestions will be populated based on agent goal -->
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between gap-3 mt-6">
                        <button onclick="prevStep()" class="btn-secondary px-6 py-2 rounded-lg"> Back</button>
                        <button onclick="nextStep()" class="btn-primary px-6 py-2 rounded-lg">Next: Deploy </button>
                    </div>
                </div>

                <!-- Step 7: Deploy -->
                <div id="wizard-step-7" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center gap-2 mb-6">
                        <span class="text-2xl"></span>
                        <div>
                            <h3 class="text-xl font-bold">Deploy Your Agent</h3>
                            <p class="text-sm text-gray-400">Choose how to save and deploy your agent</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Save as Draft -->
                        <div class="card rounded-xl p-6 border-2 border-transparent hover:border-gray-600 cursor-pointer transition" onclick="selectDeployOption('draft')">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 rounded-xl bg-gray-700 flex items-center justify-center text-2xl"></div>
                                <div>
                                    <h4 class="font-semibold">Save as Draft</h4>
                                    <p class="text-sm text-gray-400">Continue editing later</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500">Your agent will be saved but not active. You can come back and finish the configuration anytime.</p>
                        </div>
                        
                        <!-- Deploy Now -->
                        <div class="card rounded-xl p-6 border-2 border-purple-500 bg-purple-500/10 cursor-pointer" onclick="selectDeployOption('deploy')">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-2xl"></div>
                                <div>
                                    <h4 class="font-semibold">Deploy Now</h4>
                                    <p class="text-sm text-gray-400">Make your agent live</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500">Your agent will be published and ready to use immediately.</p>
                        </div>
                    </div>
                    
                    <!-- Deployment Options (shown when Deploy is selected) -->
                    <div id="deploy-options" class="hidden space-y-6">
                        <h4 class="font-semibold flex items-center gap-2">
                            <span></span> Deployment Target
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Cloud Deployment -->
                            <div class="card rounded-xl p-4 border-2 border-transparent hover:border-purple-500 cursor-pointer transition deploy-target" data-target="cloud" onclick="selectDeployTarget('cloud')">
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="text-2xl"></span>
                                    <div>
                                        <h5 class="font-medium">Cloud Hosted</h5>
                                        <p class="text-xs text-gray-400">We manage everything for you</p>
                                    </div>
                                </div>
                                <ul class="text-xs text-gray-500 space-y-1">
                                    <li> No infrastructure to manage</li>
                                    <li> Auto-scaling</li>
                                    <li> 99.9% uptime SLA</li>
                                </ul>
                            </div>
                            
                            <!-- On-Premises -->
                            <div class="card rounded-xl p-4 border-2 border-transparent hover:border-purple-500 cursor-pointer transition deploy-target" data-target="onprem" onclick="selectDeployTarget('onprem')">
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="text-2xl"></span>
                                    <div>
                                        <h5 class="font-medium">On-Premises</h5>
                                        <p class="text-xs text-gray-400">Deploy in your own infrastructure</p>
                                    </div>
                                </div>
                                <ul class="text-xs text-gray-500 space-y-1">
                                    <li> Full data control</li>
                                    <li> Custom security policies</li>
                                    <li> Air-gapped environments</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Cloud Provider Selection -->
                        <div id="cloud-providers" class="hidden">
                            <h5 class="text-sm font-medium text-gray-400 mb-3">Select Cloud Provider</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div class="card rounded-lg p-3 text-center cursor-pointer border-2 border-transparent hover:border-purple-500 transition cloud-provider" data-provider="aws" onclick="selectCloudProvider('aws')">
                                    <span class="text-2xl block mb-1"></span>
                                    <span class="text-sm">AWS</span>
                                </div>
                                <div class="card rounded-lg p-3 text-center cursor-pointer border-2 border-transparent hover:border-purple-500 transition cloud-provider" data-provider="azure" onclick="selectCloudProvider('azure')">
                                    <span class="text-2xl block mb-1"></span>
                                    <span class="text-sm">Azure</span>
                                </div>
                                <div class="card rounded-lg p-3 text-center cursor-pointer border-2 border-transparent hover:border-purple-500 transition cloud-provider" data-provider="gcp" onclick="selectCloudProvider('gcp')">
                                    <span class="text-2xl block mb-1"></span>
                                    <span class="text-sm">Google Cloud</span>
                                </div>
                                <div class="card rounded-lg p-3 text-center cursor-pointer border-2 border-transparent hover:border-purple-500 transition cloud-provider" data-provider="oci" onclick="selectCloudProvider('oci')">
                                    <span class="text-2xl block mb-1"></span>
                                    <span class="text-sm">Oracle OCI</span>
                                </div>
                            </div>
                            
                            <!-- AWS Config -->
                            <div id="cloud-config-aws" class="hidden mt-4 card rounded-xl p-4 space-y-4">
                                <h5 class="font-medium flex items-center gap-2"> AWS Configuration</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>us-east-1 (N. Virginia)</option>
                                            <option>us-west-2 (Oregon)</option>
                                            <option>eu-west-1 (Ireland)</option>
                                            <option>ap-southeast-1 (Singapore)</option>
                                        </select>
                            
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Instance Type</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>t3.medium (2 vCPU, 4 GB)</option>
                                            <option>t3.large (2 vCPU, 8 GB)</option>
                                            <option>m5.large (2 vCPU, 8 GB)</option>
                                        </select>
                            
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Access Key ID</label>
                                        <input type="password" class="input-field w-full rounded-lg px-4 py-2" placeholder="AKIA...">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Secret Access Key</label>
                                        <input type="password" class="input-field w-full rounded-lg px-4 py-2">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Azure Config -->
                            <div id="cloud-config-azure" class="hidden mt-4 card rounded-xl p-4 space-y-4">
                                <h5 class="font-medium flex items-center gap-2"> Azure Configuration</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>East US</option>
                                            <option>West Europe</option>
                                            <option>Southeast Asia</option>
                                        </select>
                            
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Resource Group</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="my-resource-group">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Subscription ID</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Tenant ID</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- GCP Config -->
                            <div id="cloud-config-gcp" class="hidden mt-4 card rounded-xl p-4 space-y-4">
                                <h5 class="font-medium flex items-center gap-2"> Google Cloud Configuration</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Project ID</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="my-project-id">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>us-central1</option>
                                            <option>europe-west1</option>
                                            <option>asia-east1</option>
                                        </select>
                            
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="text-sm text-gray-400 mb-1 block">Service Account JSON</label>
                                        <textarea rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste service account JSON"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- OCI Config -->
                            <div id="cloud-config-oci" class="hidden mt-4 card rounded-xl p-4 space-y-4">
                                <h5 class="font-medium flex items-center gap-2"> Oracle OCI Configuration</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>us-ashburn-1 (US East)</option>
                                            <option>us-phoenix-1 (US West)</option>
                                            <option>eu-frankfurt-1 (Germany)</option>
                                            <option>uk-london-1 (UK)</option>
                                            <option>ap-tokyo-1 (Japan)</option>
                                            <option>me-jeddah-1 (Saudi Arabia)</option>
                                            <option>me-dubai-1 (UAE)</option>
                                        </select>
                            
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Compartment OCID</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="ocid1.compartment.oc1..">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Tenancy OCID</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="ocid1.tenancy.oc1..">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">User OCID</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="ocid1.user.oc1..">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">API Key Fingerprint</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="xx:xx:xx:...">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Shape</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>VM.Standard.E4.Flex</option>
                                            <option>VM.Standard3.Flex</option>
                                            <option>VM.Standard.A1.Flex (ARM)</option>
                                        </select>
                            
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="text-sm text-gray-400 mb-1 block">Private Key (PEM)</label>
                                        <textarea rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="-----BEGIN RSA PRIVATE KEY-----"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- On-Premises Config -->
                        <div id="onprem-config" class="hidden">
                            <h5 class="text-sm font-medium text-gray-400 mb-3">On-Premises Configuration</h5>
                            <div class="card rounded-xl p-4 space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Deployment Method</label>
                                        <select id="onprem-method" class="input-field w-full rounded-lg px-4 py-2" onchange="onOnpremMethodChange()">
                                            <option value="docker">Docker Container</option>
                                            <option value="kubernetes">Kubernetes</option>
                                            <option value="vm">Virtual Machine</option>
                                            <option value="bare">Bare Metal</option>
                                        </select>
                            
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Environment</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>Production</option>
                                            <option>Staging</option>
                                            <option>Development</option>
                                        </select>
                            
                                    </div>
                                </div>
                                
                                <!-- Docker Config -->
                                <div id="onprem-docker" class="space-y-4">
                                    <div class="bg-gray-800/50 rounded-lg p-4">
                                        <h6 class="text-sm font-medium mb-2">Docker Run Command</h6>
                                        <pre class="text-xs bg-black/50 p-3 rounded overflow-x-auto"><code>docker run -d \
  --name agentforge-agent \
  -p 8080:8080 \
  -e OPENAI_API_KEY=your-key \
  -e AGENT_CONFIG=/config/agent.json \
  -v ./config:/config \
  agentforge/agent:latest</code></pre>
                                        <button onclick="copyDockerCommand()" class="mt-2 text-xs text-purple-400 hover:text-purple-300"> Copy command</button>
                                    </div>
                                </div>
                                
                                <!-- Kubernetes Config -->
                                <div id="onprem-kubernetes" class="hidden space-y-4">
                                    <div class="bg-gray-800/50 rounded-lg p-4">
                                        <h6 class="text-sm font-medium mb-2">Kubernetes Manifest</h6>
                                        <pre class="text-xs bg-black/50 p-3 rounded overflow-x-auto max-h-48"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: agentforge-agent
spec:
  replicas: 2
  selector:
    matchLabels:
      app: agentforge-agent
  template:
    metadata:
      labels:
        app: agentforge-agent
    spec:
      containers:
      - name: agent
        image: agentforge/agent:latest
        ports:
        - containerPort: 8080
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: agent-secrets
              key: openai-key</code></pre>
                                        <button onclick="downloadK8sManifest()" class="mt-2 text-xs text-purple-400 hover:text-purple-300"> Download YAML</button>
                                    </div>
                                </div>
                                
                                <!-- Server Config -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Server Host</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="192.168.1.100 or hostname">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Port</label>
                                        <input type="number" class="input-field w-full rounded-lg px-4 py-2" value="8080">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">SSL Certificate</label>
                                        <input type="file" class="input-field w-full rounded-lg px-4 py-2" accept=".pem,.crt">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">SSL Key</label>
                                        <input type="file" class="input-field w-full rounded-lg px-4 py-2" accept=".pem,.key">
                                    </div>
                                </div>
                                
                                <!-- Resource Requirements -->
                                <div class="border-t border-gray-700 pt-4">
                                    <h6 class="text-sm font-medium mb-3">Minimum Requirements</h6>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                        <div class="text-center p-3 bg-gray-800/50 rounded-lg">
                                            <div class="text-lg font-bold text-purple-400">2</div>
                                            <div class="text-xs text-gray-500">CPU Cores</div>
                                        </div>
                                        <div class="text-center p-3 bg-gray-800/50 rounded-lg">
                                            <div class="text-lg font-bold text-purple-400">4 GB</div>
                                            <div class="text-xs text-gray-500">RAM</div>
                                        </div>
                                        <div class="text-center p-3 bg-gray-800/50 rounded-lg">
                                            <div class="text-lg font-bold text-purple-400">20 GB</div>
                                            <div class="text-xs text-gray-500">Storage</div>
                                        </div>
                                        <div class="text-center p-3 bg-gray-800/50 rounded-lg">
                                            <div class="text-lg font-bold text-purple-400">HTTPS</div>
                                            <div class="text-xs text-gray-500">Network</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between gap-3 mt-6">
                        <button onclick="prevStep()" class="btn-secondary px-6 py-2 rounded-lg"> Back</button>
                        <div class="flex gap-3">
                            <button onclick="saveAgent('draft')" class="btn-secondary px-6 py-2 rounded-lg"> Save Draft</button>
                            <button onclick="deployAgent()" id="btn-deploy" class="btn-success px-8 py-2 rounded-lg flex items-center gap-2">
                                <span></span> Deploy Agent
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Demo Lab Page - NEW DESIGN -->
            <section id="page-demo" class="hidden flex flex-col" style="height:100%;max-height:100%;min-height:0;overflow:hidden;">
                <!-- Header -->
                <div class="p-4 border-b border-gray-800 flex items-center justify-between bg-gradient-to-r from-purple-900/30 to-blue-900/30" style="flex-shrink:0;">
                    <div>
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center"></span>
                            Demo Lab
                        </h2>
                        <p class="text-sm text-gray-400 mt-1">Create demo environments with APIs, Knowledge Bases & Test Assets</p>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="flex flex-1 overflow-hidden">
                    <!-- Left Sidebar - Demo Kits List -->
                    <div class="w-72 border-r flex flex-col demo-sidebar" style="background:var(--bg-secondary);border-color:var(--border-color);">
                        <div class="p-3 border-b" style="border-color:var(--border-color);">
                            <button onclick="showCreateKitModal()" class="w-full btn-primary py-2.5 rounded-lg text-sm flex items-center justify-center gap-2">
                                <span></span> Create Demo Kit
                            </button>
                        </div>
                        
                        <!-- Kits List -->
                        <div id="demo-kits-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                            <div class="text-center py-8" style="color:var(--text-muted);">
                                <span class="text-3xl block mb-2"></span>
                                <p class="text-sm">No demo kits yet</p>
                                <p class="text-xs mt-1">Create one to get started!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Content Area -->
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <!-- Welcome / Kit Details -->
                        <div id="demo-content-area" class="flex-1 overflow-y-auto p-6">
                            <!-- Welcome Screen -->
                            <div id="demo-welcome" class="text-center py-12">
                                <div class="w-24 h-24 mx-auto rounded-2xl bg-gradient-to-br from-purple-500/20 to-blue-500/20 flex items-center justify-center mb-6">
                                    <span class="text-5xl"></span>
                                </div>
                                <h3 class="text-2xl font-bold mb-3">Welcome to Demo Lab</h3>
                                <p class="mb-8 max-w-lg mx-auto" style="color:var(--text-secondary);">
                                    Describe your agent's needs in plain language and we'll generate everything you need: 
                                    Mock APIs, Knowledge Bases, and sample documents for testing.
                                </p>
                                
                                <div class="max-w-2xl mx-auto">
                                    <div class="card rounded-xl p-6 text-left">
                                        <p class="text-sm font-medium mb-4" style="color:var(--accent-primary);"> Example Request:</p>
                                        <div class="rounded-lg p-4 text-sm italic" style="background:var(--bg-input);color:var(--text-secondary);">
                                            "I need tools for an HR agent that can check employee vacation balance, 
                                            submit vacation requests, process expense claims with receipt uploads, 
                                            and answer questions about HR policies including benefits and leave policies. 
                                            Also need sample invoices and receipts for testing."
                                        </div>
                                        <button onclick="useDemoKitExample()" class="mt-4 text-sm hover:underline" style="color:var(--accent-primary);">
                                             Use this example
                                        </button>
                                    </div>
                                    
                                    <div class="grid grid-cols-3 gap-4 mt-6">
                                        <div class="card rounded-lg p-4 text-center">
                                            <span class="text-2xl"></span>
                                            <p class="text-sm font-medium mt-2">Mock APIs</p>
                                            <p class="text-xs" style="color:var(--text-muted);">Testable endpoints</p>
                                        </div>
                                        <div class="card rounded-lg p-4 text-center">
                                            <span class="text-2xl"></span>
                                            <p class="text-sm font-medium mt-2">Knowledge Bases</p>
                                            <p class="text-xs" style="color:var(--text-muted);">Searchable docs</p>
                                        </div>
                                        <div class="card rounded-lg p-4 text-center">
                                            <span class="text-2xl"></span>
                                            <p class="text-sm font-medium mt-2">Demo Assets</p>
                                            <p class="text-xs" style="color:var(--text-muted);">Test files</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Kit Details (hidden by default) -->
                            <div id="demo-kit-details" class="hidden">
                                <!-- Kit Header -->
                                <div class="flex items-start justify-between mb-6">
                                    <div>
                                        <h3 id="kit-detail-name" class="text-2xl font-bold">Kit Name</h3>
                                        <p id="kit-detail-desc" class="mt-1" style="color:var(--text-secondary);">Description</p>
                                    </div>
                                    <button onclick="deleteCurrentKit()" class="px-3 py-1.5 rounded-lg text-sm bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                         Delete Kit
                                    </button>
                                </div>
                                
                                <!-- APIs Section -->
                                <div class="mb-8">
                                    <div class="flex items-center gap-2 mb-4">
                                        <span class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center"></span>
                                        <h4 class="text-lg font-semibold">APIs</h4>
                                        <span id="kit-api-count" class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded-full">0</span>
                                        <span class="text-xs text-gray-500 ml-2"> Available as tools in AgentForge Studio</span>
                                    </div>
                                    <div id="kit-apis-list" class="space-y-3">
                                        <!-- APIs will be rendered here -->
                                    </div>
                                </div>
                                
                                <!-- Knowledge Bases Section -->
                                <div class="mb-8">
                                    <div class="flex items-center gap-2 mb-4">
                                        <span class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center"></span>
                                        <h4 class="text-lg font-semibold">Knowledge Bases</h4>
                                        <span id="kit-kb-count" class="text-xs bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded-full">0</span>
                                        <span class="text-xs text-gray-500 ml-2"> Available as tools in AgentForge Studio</span>
                                    </div>
                                    <div id="kit-kb-list" class="space-y-3">
                                        <!-- Knowledge Bases will be rendered here -->
                                    </div>
                                </div>
                                
                                <!-- Demo Assets Section -->
                                <div class="mb-8">
                                    <div class="flex items-center gap-2 mb-4">
                                        <span class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center"></span>
                                        <h4 class="text-lg font-semibold">Demo Assets</h4>
                                        <span id="kit-asset-count" class="text-xs bg-green-500/20 text-green-300 px-2 py-0.5 rounded-full">0</span>
                                        <span class="text-xs text-gray-500 ml-2"> For testing only (not linked to agent)</span>
                                    </div>
                                    <div id="kit-assets-list" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        <!-- Assets will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Create Kit Modal -->
                <div id="create-kit-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
                    <div class="modal-content-box rounded-2xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="font-bold text-lg"> Create Demo Kit</h3>
                            <button onclick="closeCreateKitModal()" class="p-2 hover:bg-gray-700 rounded-lg"></button>
                        </div>
                        <div class="p-6">
                            <label class="block text-sm font-medium mb-2">Kit Name (optional)</label>
                            <input type="text" id="new-kit-name" class="w-full input-field rounded-lg px-4 py-2 mb-4" placeholder="e.g., HR Assistant Tools">
                            
                            <label class="block text-sm font-medium mb-2">Describe what you need</label>
                            <textarea id="new-kit-description" class="w-full input-field rounded-lg px-4 py-3 h-40 resize-none" placeholder="Describe the APIs, knowledge bases, and test documents you need for your agent...

Example: I need an HR agent that can:
- Check employee vacation balance from HR system
- Submit vacation requests
- Process expense claims with receipts
- Answer questions about HR policies (benefits, leave, etc.)
- Need sample invoices and receipts for testing"></textarea>
                            
                            <div id="kit-generation-status" class="hidden mt-4 p-4 bg-purple-500/10 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <div class="animate-spin w-5 h-5 border-2 border-purple-500 border-t-transparent rounded-full"></div>
                                    <span class="text-sm text-purple-300">Generating your demo kit...</span>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
                            <button onclick="closeCreateKitModal()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Cancel</button>
                            <button onclick="generateDemoKit()" id="generate-kit-btn" class="px-6 py-2 rounded-lg bg-purple-600 hover:bg-purple-500 flex items-center gap-2">
                                <span></span> Generate Kit
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- API Test Modal -->
                <div id="api-test-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
                    <div class="modal-content-box rounded-2xl w-full max-w-3xl mx-4 max-h-[85vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="font-bold text-lg" id="api-test-title">Test API</h3>
                            <button onclick="closeApiTestModal()" class="p-2 hover:bg-gray-700 rounded-lg"></button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[65vh]">
                            <div class="grid grid-cols-2 gap-6">
                                <!-- Request -->
                                <div>
                                    <h4 class="text-sm font-medium text-gray-400 mb-2">Request</h4>
                                    <div class="bg-gray-900 rounded-lg p-4">
                                        <div class="flex items-center gap-2 mb-3">
                                            <span id="api-test-method" class="px-2 py-0.5 rounded text-xs font-bold bg-green-500/20 text-green-400">GET</span>
                                            <code id="api-test-endpoint" class="text-sm text-gray-300">/api/mock/...</code>
                                        </div>
                                        <div id="api-test-params" class="space-y-2">
                                            <!-- Parameters will be rendered here -->
                                        </div>
                                        <textarea id="api-test-body" class="hidden w-full input-field rounded-lg px-3 py-2 mt-3 text-sm font-mono h-32" placeholder="Request body (JSON)"></textarea>
                                    </div>
                                </div>
                                <!-- Response -->
                                <div>
                                    <h4 class="text-sm font-medium text-gray-400 mb-2">Response</h4>
                                    <pre id="api-test-response" class="bg-gray-900 rounded-lg p-4 text-sm text-green-400 font-mono overflow-auto max-h-64">
// Click "Send Request" to test
                                    </pre>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
                            <button onclick="closeApiTestModal()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Close</button>
                            <button onclick="sendApiTestRequest()" class="px-6 py-2 rounded-lg bg-green-600 hover:bg-green-500 flex items-center gap-2">
                                <span></span> Send Request
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Knowledge Base View Modal -->
                <div id="kb-view-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
                    <div class="modal-content-box rounded-2xl w-full max-w-4xl mx-4 max-h-[85vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="font-bold text-lg" id="kb-view-title">Knowledge Base</h3>
                            <button onclick="closeKbViewModal()" class="p-2 hover:bg-gray-700 rounded-lg"></button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <div id="kb-view-content" class="prose prose-invert max-w-none">
                                <!-- Content will be rendered here -->
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-end">
                            <button onclick="closeKbViewModal()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Close</button>
                        </div>
                    </div>
                </div>
                
                <!-- Edit Asset Modal (Assets don't have a Tools page) -->
                <div id="edit-asset-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
                    <div class="modal-content-box rounded-2xl w-full max-w-xl mx-4 max-h-[85vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="font-bold text-lg"> Edit Asset</h3>
                            <button onclick="closeEditAssetModal()" class="p-2 hover:bg-gray-700 rounded-lg"></button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[60vh] space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Name</label>
                                <input type="text" id="edit-asset-name" class="w-full input-field rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Description</label>
                                <textarea id="edit-asset-description" class="w-full input-field rounded-lg px-4 py-2 h-16"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Type</label>
                                <select id="edit-asset-type" class="w-full input-field rounded-lg px-4 py-2">
                                    <option value="invoice">Invoice</option>
                                    <option value="receipt">Receipt</option>
                                    <option value="document">Document</option>
                                    <option value="image">Image</option>
                                </select>
                            
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
                            <button onclick="closeEditAssetModal()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Cancel</button>
                            <button onclick="saveEditAsset()" class="px-6 py-2 rounded-lg bg-purple-600 hover:bg-purple-500">Save</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Chat Page -->
            <section id="page-chat" class="hidden flex flex-col" style="height:100%;max-height:100%;min-height:0;overflow:hidden;">
                <div class="p-3 md:p-4 border-b border-gray-800 flex flex-col sm:flex-row gap-3" style="flex-shrink:0;">
                    <select id="chat-agent" onchange="onAgentChange()" class="input-field rounded-lg px-3 py-2 flex-1 sm:flex-none sm:min-w-[200px]">
                        <option value="">Select Agent...</option>
                    </select>
                            
                    <div class="flex gap-2 flex-1">
                        <select id="chat-conv" onchange="onConvChange()" class="input-field rounded-lg px-3 py-2 flex-1">
                            <option value="">New Chat</option>
                        </select>
                            
                        <button onclick="clearChat()" class="text-gray-400 hover:text-white px-3"></button>
                    </div>
                </div>
                <div id="chat-messages" class="p-3 md:p-4 space-y-4" style="flex:1;overflow-y:auto;min-height:0;-webkit-overflow-scrolling:touch;">
                    <div class="text-center text-gray-500 py-10 md:py-20">
                        <span class="text-4xl md:text-6xl mb-4 block"></span>
                        <p>Select an agent to start</p>
                    </div>
                </div>
                <div class="p-3 md:p-4 border-t border-gray-800" style="flex-shrink:0;">
                    <!-- Attached files preview -->
                    <div id="chat-attachments" class="hidden flex flex-wrap gap-2 mb-2"></div>
                    <div class="flex gap-2 md:gap-3 items-end">
                        <button onclick="document.getElementById('chat-file-input').click()" class="btn-secondary p-2 md:p-3 rounded-lg flex-shrink-0" title="Attach file">
                            
                        </button>
                        <input type="file" id="chat-file-input" class="hidden" accept=".pdf,.doc,.docx,.txt,.csv,.xlsx,.xls,.pptx,.ppt,.md,.png,.jpg,.jpeg,.gif,.webp,.bmp,.svg" onchange="handleChatFile(event)" multiple>
                        <input type="text" id="chat-input" class="input-field flex-1 rounded-lg px-3 md:px-4 py-2 md:py-3" placeholder="Message..." onkeypress="if(event.key==='Enter')sendMsg()">
                        <button onclick="sendMsg()" class="btn-primary px-4 md:px-6 py-2 md:py-3 rounded-lg">Send</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <button onclick="navigate('chat')" id="mob-chat" data-permission="chat:use" class=""><span></span><span>Chat</span></button>
        <button onclick="navigate('agents')" id="mob-agents" data-permission="agents:view" class="active"><span></span><span>Hub</span></button>
        <button onclick="navigate('create')" id="mob-create" data-permission="agents:create" class=""><span></span><span>Studio</span></button>
        <button onclick="navigate('tools')" id="mob-tools" data-permission="tools:view" class=""><span></span><span>Tools</span></button>
        <button onclick="navigate('settings')" id="mob-settings" data-permission="system:settings" class=""><span></span><span>Settings</span></button>
    </nav>

    <!-- Tool Creation Modal -->
<!-- Tool Wizard Modal -->
<div id="modal-tool" class="hidden fixed inset-0 modal-backdrop flex items-end md:items-center justify-center z-50">
    <div class="card rounded-t-xl md:rounded-xl w-full md:max-w-4xl md:mx-4 max-h-[90vh] flex flex-col">
        <!-- Header -->
        <div class="p-4 md:p-6 flex items-center justify-between shrink-0" style="border-bottom:1px solid var(--border-color)">
            <div class="flex items-center gap-3">
                <span id="wizard-icon" class="text-2xl"></span>
                <div>
                    <h3 class="text-lg md:text-xl font-bold" id="wizard-title">Create Tool</h3>
                    <p class="text-xs text-gray-400" id="wizard-subtitle">Select a tool type</p>
                </div>
            </div>
            <button onclick="closeWizard()" class="text-gray-400 hover:text-white text-2xl p-2"></button>
        </div>

        <!-- Steps Indicator -->
        <div id="wizard-steps-bar" class="hidden px-4 md:px-6 py-3 border-b shrink-0" style="background:var(--bg-secondary);border-color:var(--border-color);">
            <div class="flex items-center justify-center gap-2 md:gap-4">
                <div class="wizard-step flex items-center gap-2" data-step="1">
                    <div class="step-num w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-purple-600">1</div>
                    <span class="step-label text-sm hidden md:inline">Basics</span>
                </div>
                <div class="w-6 md:w-10 h-0.5 bg-gray-700 step-connector"></div>
                <div class="wizard-step flex items-center gap-2 opacity-50" data-step="2">
                    <div class="step-num w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-gray-700">2</div>
                    <span class="step-label text-sm hidden md:inline">Config</span>
                </div>
                <div class="w-6 md:w-10 h-0.5 bg-gray-700 step-connector"></div>
                <div class="wizard-step flex items-center gap-2 opacity-50" data-step="3">
                    <div class="step-num w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-gray-700">3</div>
                    <span class="step-label text-sm hidden md:inline">Sources</span>
                </div>
                <div class="w-6 md:w-10 h-0.5 bg-gray-700 step-connector"></div>
                <div class="wizard-step flex items-center gap-2 opacity-50" data-step="4">
                    <div class="step-num w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-gray-700">4</div>
                    <span class="step-label text-sm hidden md:inline">Test</span>
                </div>
            </div>
        </div>

        <!-- Content Area (Scrollable) -->
        <div class="p-4 md:p-6 overflow-y-auto flex-1">
            
            <!-- Step 0: Tool Type Selection -->
            <div id="wiz-step-0" class="space-y-4">
                <!-- Active Tools: Knowledge & Data -->
                <div>
                    <h4 class="text-xs uppercase text-gray-500 mb-2 font-semibold"> Knowledge & Data</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <button onclick="startWizard('knowledge')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Knowledge Base</span>
                            <p class="text-xs text-gray-500 mt-1">RAG with config</p>
                        </button>
                        <button onclick="startWizard('document')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Documents</span>
                            <p class="text-xs text-gray-500 mt-1">Upload files</p>
                        </button>
                        <button onclick="startWizard('website')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Website</span>
                            <p class="text-xs text-gray-500 mt-1">Scrape pages</p>
                        </button>
                        <button onclick="startWizard('database')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Database</span>
                            <p class="text-xs text-gray-500 mt-1">SQL, MongoDB</p>
                        </button>
                    </div>
                </div>
                
                <!-- Active Tools: Integrations -->
                <div>
                    <h4 class="text-xs uppercase text-gray-500 mb-2 font-semibold"> Integrations</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <button onclick="startWizard('api')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">REST API</span>
                            <p class="text-xs text-gray-500 mt-1">HTTP endpoints</p>
                        </button>
                        <button onclick="startWizard('email')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Email</span>
                            <p class="text-xs text-gray-500 mt-1">SMTP, SendGrid</p>
                        </button>
                        <button onclick="startWizard('webhook')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Webhook</span>
                            <p class="text-xs text-gray-500 mt-1">HTTP callbacks</p>
                        </button>
                        <button onclick="startWizard('slack')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Slack</span>
                            <p class="text-xs text-gray-500 mt-1">Messaging</p>
                        </button>
                        <button onclick="startWizard('websearch')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Web Search</span>
                            <p class="text-xs text-gray-500 mt-1">Tavily, Google</p>
                        </button>
                    </div>
                </div>
                
                <!-- Coming Soon -->
                <div>
                    <h4 class="text-xs uppercase text-gray-500 mb-2 font-semibold"> Coming Soon</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 opacity-60">
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Spreadsheet</span>
                            <p class="text-xs text-gray-500 mt-1">Sheets, Airtable</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Cloud Storage</span>
                            <p class="text-xs text-gray-500 mt-1">S3, GCS, Azure</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Calendar</span>
                            <p class="text-xs text-gray-500 mt-1">Google, Outlook</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">CRM</span>
                            <p class="text-xs text-gray-500 mt-1">Salesforce, HubSpot</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">ERP</span>
                            <p class="text-xs text-gray-500 mt-1">SAP, Oracle</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Image Gen</span>
                            <p class="text-xs text-gray-500 mt-1">DALL-E, SD</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Speech to Text</span>
                            <p class="text-xs text-gray-500 mt-1">Whisper</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Text to Speech</span>
                            <p class="text-xs text-gray-500 mt-1">ElevenLabs</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Translation</span>
                            <p class="text-xs text-gray-500 mt-1">DeepL, Google</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">OCR / Vision</span>
                            <p class="text-xs text-gray-500 mt-1">Extract text</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Code Exec</span>
                            <p class="text-xs text-gray-500 mt-1">Python, JS</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1"></span>
                            <span class="font-medium text-sm">Human in Loop</span>
                            <p class="text-xs text-gray-500 mt-1">Approval</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="wiz-step-1" class="hidden space-y-4">
                <div class="flex items-center gap-3 p-3 rounded-lg step-header-box">
                    <span id="step1-icon" class="text-2xl"></span>
                    <div>
                        <h4 class="font-semibold" id="step1-title">Tool Name</h4>
                        <p class="text-xs text-gray-400">Step 1 of 4: Basic Information</p>
                    </div>
                </div>
                <div>
                    <label class="text-sm text-gray-400 mb-1 block">Name *</label>
                    <input type="text" id="wiz-name" class="input-field w-full rounded-lg px-4 py-3 text-lg" placeholder="Enter a descriptive name...">
                </div>
                <div>
                    <label class="text-sm text-gray-400 mb-1 block">Description</label>
                    <textarea id="wiz-desc" rows="3" class="input-field w-full rounded-lg px-4 py-3" placeholder="What does this tool do? What data does it contain?"></textarea>
                </div>
            </div>

            <!-- Step 2: Configuration (Tool-specific) -->
            <div id="wiz-step-2" class="hidden space-y-4">
                <div class="flex items-center gap-3 p-3 rounded-lg step-header-box">
                    <span class="text-2xl"></span>
                    <div>
                        <h4 class="font-semibold">Configuration</h4>
                        <p class="text-xs text-gray-400">Step 2 of 4: Tool-specific settings</p>
                    </div>
                </div>
                
                <!-- Knowledge Base Config -->
                <div id="cfg-knowledge" class="hidden space-y-4">
                    <!-- Embedding -->
                    <div class="card rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h5 class="font-medium"> Embedding Model</h5>
                            <label class="flex items-center gap-2 text-sm cursor-pointer">
                                <input type="checkbox" id="kb-emb-global" class="w-4 h-4" checked onchange="toggleKBEmb()">
                                <span class="text-gray-400">Use global</span>
                            </label>
                        </div>
                        <div id="kb-emb-fields" class="hidden grid md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Provider</label>
                                <select id="kb-emb-provider" class="input-field w-full rounded-lg px-3 py-2" onchange="onKBEmbChange()">
                                    <option value="openai">OpenAI</option>
                                    <option value="local">Sentence Transformers (Free)</option>
                                </select>
                            
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Model</label>
                                <select id="kb-emb-model" class="input-field w-full rounded-lg px-3 py-2">
                                    <option value="text-embedding-3-small">text-embedding-3-small</option>
                                    <option value="text-embedding-3-large">text-embedding-3-large</option>
                                </select>
                            
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Settings -->
                    <div class="card rounded-lg p-4">
                        <h5 class="font-medium mb-3"> Search Settings</h5>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Chunk Size</label>
                                <input type="number" id="kb-chunk" class="input-field w-full rounded-lg px-3 py-2" value="1000">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Overlap</label>
                                <input type="number" id="kb-overlap" class="input-field w-full rounded-lg px-3 py-2" value="200">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Top K</label>
                                <input type="number" id="kb-topk" class="input-field w-full rounded-lg px-3 py-2" value="5">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Search Type</label>
                                <select id="kb-search" class="input-field w-full rounded-lg px-3 py-2">
                                    <option value="hybrid">Hybrid</option>
                                    <option value="semantic">Semantic</option>
                                    <option value="keyword">Keyword</option>
                                </select>
                            
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Website Config -->
                <div id="cfg-website" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Website URL *</label>
                        <input type="url" id="web-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://example.com">
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="web-recursive" class="w-4 h-4">
                            <span class="text-sm">Recursive scraping</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-400">Max pages:</label>
                            <input type="number" id="web-max" class="input-field w-20 rounded px-2 py-1" value="10">
                        </div>
                    </div>
                </div>

                <!-- Database Config -->
                <div id="cfg-database" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Database Type</label>
                        <select id="db-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onDBTypeChange()">
                            <optgroup label="Relational Databases">
                                <option value="postgresql">PostgreSQL</option>
                                <option value="mysql">MySQL / MariaDB</option>
                                <option value="mssql">Microsoft SQL Server</option>
                                <option value="oracle">Oracle Database</option>
                                <option value="oracle_autonomous">Oracle Autonomous Database</option>
                                <option value="sqlite">SQLite</option>
                                <option value="db2">IBM Db2</option>
                                <option value="sybase">SAP Sybase</option>
                                <option value="teradata">Teradata</option>
                                <option value="snowflake">Snowflake</option>
                                <option value="redshift">Amazon Redshift</option>
                                <option value="bigquery">Google BigQuery</option>
                                <option value="azure_sql">Azure SQL Database</option>
                                <option value="cockroachdb">CockroachDB</option>
                                <option value="tidb">TiDB</option>
                            </optgroup>
                            <optgroup label="NoSQL Databases">
                                <option value="mongodb">MongoDB</option>
                                <option value="mongodb_atlas">MongoDB Atlas</option>
                                <option value="dynamodb">Amazon DynamoDB</option>
                                <option value="cosmosdb">Azure Cosmos DB</option>
                                <option value="firestore">Google Firestore</option>
                                <option value="couchdb">CouchDB</option>
                                <option value="cassandra">Apache Cassandra</option>
                                <option value="scylladb">ScyllaDB</option>
                                <option value="hbase">Apache HBase</option>
                            </optgroup>
                            <optgroup label="In-Memory / Cache">
                                <option value="redis">Redis</option>
                                <option value="memcached">Memcached</option>
                                <option value="elasticache">Amazon ElastiCache</option>
                            </optgroup>
                            <optgroup label="Search Engines">
                                <option value="elasticsearch">Elasticsearch</option>
                                <option value="opensearch">OpenSearch</option>
                                <option value="solr">Apache Solr</option>
                                <option value="meilisearch">Meilisearch</option>
                            </optgroup>
                            <optgroup label="Vector Databases">
                                <option value="pinecone">Pinecone</option>
                                <option value="weaviate">Weaviate</option>
                                <option value="qdrant">Qdrant</option>
                                <option value="milvus">Milvus</option>
                                <option value="chroma">ChromaDB</option>
                            </optgroup>
                            <optgroup label="Time Series">
                                <option value="influxdb">InfluxDB</option>
                                <option value="timescaledb">TimescaleDB</option>
                                <option value="questdb">QuestDB</option>
                            </optgroup>
                            <optgroup label="Graph Databases">
                                <option value="neo4j">Neo4j</option>
                                <option value="neptune">Amazon Neptune</option>
                                <option value="arangodb">ArangoDB</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    
                    <!-- Standard Connection Fields -->
                    <div id="db-standard-fields">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Host</label>
                                <input type="text" id="db-host" class="input-field w-full rounded-lg px-4 py-2" placeholder="localhost or hostname">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Port</label>
                                <input type="number" id="db-port" class="input-field w-full rounded-lg px-4 py-2" value="5432">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Database Name</label>
                                <input type="text" id="db-name" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Schema (optional)</label>
                                <input type="text" id="db-schema" class="input-field w-full rounded-lg px-4 py-2" placeholder="public">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Username</label>
                                <input type="text" id="db-user" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Password</label>
                                <input type="password" id="db-pass" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Oracle Specific Fields -->
                    <div id="db-oracle-fields" class="hidden space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Connection Type</label>
                                <select id="oracle-conn-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onOracleConnTypeChange()">
                                    <option value="basic">Basic (Host/Port/Service)</option>
                                    <option value="tns">TNS Name</option>
                                    <option value="connection_string">Connection String</option>
                                    <option value="wallet">Wallet (Cloud)</option>
                                </select>
                            
                            </div>
                            <div id="oracle-service-field">
                                <label class="text-sm text-gray-400 mb-1 block">Service Name / SID</label>
                                <input type="text" id="oracle-service" class="input-field w-full rounded-lg px-4 py-2" placeholder="ORCL or service_name">
                            </div>
                        </div>
                        <div id="oracle-tns-field" class="hidden">
                            <label class="text-sm text-gray-400 mb-1 block">TNS Name</label>
                            <input type="text" id="oracle-tns" class="input-field w-full rounded-lg px-4 py-2" placeholder="MY_TNS_ALIAS">
                        </div>
                        <div id="oracle-wallet-fields" class="hidden">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Wallet Location</label>
                                    <input type="text" id="oracle-wallet-loc" class="input-field w-full rounded-lg px-4 py-2" placeholder="/path/to/wallet">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Wallet Password</label>
                                    <input type="password" id="oracle-wallet-pass" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="text-sm text-gray-400 mb-1 block">Or Upload Wallet ZIP</label>
                                <input type="file" id="oracle-wallet-file" class="input-field w-full rounded-lg px-4 py-2" accept=".zip">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Oracle Autonomous DB Fields -->
                    <div id="db-oracle-adb-fields" class="hidden space-y-4">
                        <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 text-sm text-amber-300 mb-4">
                             Oracle Autonomous Database requires a wallet for secure connections. Download it from OCI Console.
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">ADB Type</label>
                                <select id="oracle-adb-type" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="atp">Autonomous Transaction Processing (ATP)</option>
                                    <option value="adw">Autonomous Data Warehouse (ADW)</option>
                                    <option value="ajd">Autonomous JSON Database (AJD)</option>
                                    <option value="apex">APEX Service</option>
                                </select>
                            
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Connection Service</label>
                                <select id="oracle-adb-service" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="high">High (Parallel Queries)</option>
                                    <option value="medium">Medium (Balanced)</option>
                                    <option value="low">Low (Serial)</option>
                                    <option value="tp">TP (Transaction Processing)</option>
                                    <option value="tpurgent">TP Urgent</option>
                                </select>
                            
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Database Name</label>
                            <input type="text" id="oracle-adb-name" class="input-field w-full rounded-lg px-4 py-2" placeholder="myatp_high">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Wallet ZIP File</label>
                            <input type="file" id="oracle-adb-wallet" class="input-field w-full rounded-lg px-4 py-2" accept=".zip">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Username</label>
                                <input type="text" id="oracle-adb-user" class="input-field w-full rounded-lg px-4 py-2" placeholder="ADMIN">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Password</label>
                                <input type="password" id="oracle-adb-pass" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cloud DB Fields (BigQuery, Snowflake, etc) -->
                    <div id="db-cloud-fields" class="hidden space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Account / Project ID</label>
                                <input type="text" id="db-cloud-account" class="input-field w-full rounded-lg px-4 py-2" placeholder="my-project-id">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Warehouse / Dataset</label>
                                <input type="text" id="db-cloud-warehouse" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Service Account / API Key JSON</label>
                            <textarea id="db-cloud-creds" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste credentials JSON or API key"></textarea>
                        </div>
                        <div id="db-snowflake-extra" class="hidden grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Role</label>
                                <input type="text" id="db-snowflake-role" class="input-field w-full rounded-lg px-4 py-2" placeholder="ACCOUNTADMIN">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                <input type="text" id="db-snowflake-region" class="input-field w-full rounded-lg px-4 py-2" placeholder="us-east-1">
                            </div>
                        </div>
                    </div>
                    
                    <!-- NoSQL Fields (MongoDB, etc) -->
                    <div id="db-nosql-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Connection String</label>
                            <input type="text" id="db-nosql-uri" class="input-field w-full rounded-lg px-4 py-2" placeholder="mongodb+srv://user:pass@cluster.mongodb.net/db">
                        </div>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="db-nosql-ssl" class="w-4 h-4" checked>
                                <span class="text-sm">Use SSL/TLS</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="db-nosql-srv" class="w-4 h-4">
                                <span class="text-sm">SRV Record</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Vector DB Fields -->
                    <div id="db-vector-fields" class="hidden space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                                <input type="password" id="db-vector-key" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Environment / Region</label>
                                <input type="text" id="db-vector-env" class="input-field w-full rounded-lg px-4 py-2" placeholder="us-east-1-aws">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Index / Collection Name</label>
                            <input type="text" id="db-vector-index" class="input-field w-full rounded-lg px-4 py-2" placeholder="my-index">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Dimensions</label>
                                <input type="number" id="db-vector-dims" class="input-field w-full rounded-lg px-4 py-2" value="1536">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Metric</label>
                                <select id="db-vector-metric" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="cosine">Cosine Similarity</option>
                                    <option value="euclidean">Euclidean Distance</option>
                                    <option value="dotproduct">Dot Product</option>
                                </select>
                            
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connection Options -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">Connection Options</p>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="db-ssl" class="w-4 h-4">
                                <span class="text-sm">Use SSL/TLS</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="db-readonly" class="w-4 h-4">
                                <span class="text-sm">Read-only mode</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="db-pool" class="w-4 h-4" checked>
                                <span class="text-sm">Connection pooling</span>
                            </label>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4 mt-3">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Connection Timeout (sec)</label>
                                <input type="number" id="db-timeout" class="input-field w-full rounded-lg px-4 py-2" value="30">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Max Connections</label>
                                <input type="number" id="db-max-conn" class="input-field w-full rounded-lg px-4 py-2" value="10">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Config -->
                <div id="cfg-api" class="hidden space-y-4">
                    <div class="grid md:grid-cols-4 gap-4">
                        <div class="md:col-span-3">
                            <label class="text-sm text-gray-400 mb-1 block">Base URL *</label>
                            <input type="url" id="api-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://api.example.com">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Method</label>
                            <select id="api-method" class="input-field w-full rounded-lg px-4 py-2">
                                <option>GET</option>
                                <option>POST</option>
                                <option>PUT</option>
                                <option>DELETE</option>
                            </select>
                            
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Endpoint Path</label>
                        <input type="text" id="api-path" class="input-field w-full rounded-lg px-4 py-2" placeholder="/v1/data">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Authentication</label>
                            <select id="api-auth" class="input-field w-full rounded-lg px-4 py-2" onchange="onApiAuthChange()">
                                <option value="none">None</option>
                                <option value="api_key">API Key</option>
                                <option value="bearer">Bearer Token</option>
                            </select>
                            
                        </div>
                        <div id="api-auth-val-group" class="hidden">
                            <label class="text-sm text-gray-400 mb-1 block">Auth Value</label>
                            <input type="password" id="api-auth-val" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                </div>

                <!-- Email Config -->
                <div id="cfg-email" class="hidden space-y-4">
                    <!-- Super Simple - Just Connect -->
                    <div class="space-y-3">
                        <!-- Google / Gmail -->
                        <div id="gmail-connect-card" class="card rounded-xl p-5 border-2 border-transparent hover:border-purple-500 transition">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-xl bg-white flex items-center justify-center shadow-sm shrink-0">
                                    <svg width="32" height="32" viewBox="0 0 24 24">
                                        <path fill="#EA4335" d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h5 class="font-semibold text-lg" style="color:var(--text-primary);">Gmail</h5>
                                    <p class="text-sm" style="color:var(--text-muted);">Send emails from your Gmail account</p>
                                </div>
                                <button onclick="connectEmailProvider('google')" id="gmail-connect-btn" class="btn-primary px-5 py-2.5 rounded-lg flex items-center gap-2">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                    Connect
                                </button>
                            </div>
                            <!-- Connected State (hidden by default) -->
                            <div id="gmail-connected" class="hidden mt-4 pt-4 border-t" style="border-color:var(--border-color);">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center">
                                            <span class="text-green-500"></span>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium" style="color:var(--text-primary);">Connected</p>
                                            <p class="text-xs" style="color:var(--text-muted);" id="gmail-connected-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="265355435466435e474b564a430845494b">[email&#160;protected]</a></p>
                                        </div>
                                    </div>
                                    <button onclick="disconnectEmailProvider('google')" class="text-xs px-3 py-1.5 rounded-lg hover:bg-red-500/10 text-red-400">
                                        Disconnect
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Microsoft / Outlook -->
                        <div id="outlook-connect-card" class="card rounded-xl p-5 border-2 border-transparent hover:border-purple-500 transition">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-xl bg-white flex items-center justify-center shadow-sm shrink-0">
                                    <svg width="32" height="32" viewBox="0 0 24 24">
                                        <path fill="#0078D4" d="M24 7.387v10.478c0 .23-.08.424-.238.576-.158.154-.352.23-.58.23h-8.547v-6.959l1.6 1.229c.102.086.228.13.378.13.15 0 .276-.044.378-.13l6.771-5.186c.076-.056.142-.076.199-.06.057.017.086.063.086.138v10.054c0 .077-.03.14-.09.186-.06.047-.126.07-.2.07H15.91v1.14h8.908c.076 0 .14-.028.188-.084.047-.056.07-.12.07-.19V7.387z"/>
                                        <path fill="#0078D4" d="M15.635 9.807v11.57H.818c-.227 0-.42-.078-.577-.234C.083 21.013 0 20.83 0 20.604V7.387l7.818 5.642 7.817-3.222z"/>
                                        <path fill="#28A8EA" d="M15.635 2.623v7.184l-7.817 3.222L0 7.387V3.396c0-.227.083-.42.241-.577C.398 2.662.591 2.58.818 2.58h14.043c.227 0 .42.082.577.24.157.158.197.35.197.577v-.774z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h5 class="font-semibold text-lg" style="color:var(--text-primary);">Outlook</h5>
                                    <p class="text-sm" style="color:var(--text-muted);">Send emails from your Microsoft account</p>
                                </div>
                                <button onclick="connectEmailProvider('microsoft')" id="outlook-connect-btn" class="btn-secondary px-5 py-2.5 rounded-lg flex items-center gap-2">
                                    Connect
                                </button>
                            </div>
                            <!-- Connected State -->
                            <div id="outlook-connected" class="hidden mt-4 pt-4 border-t" style="border-color:var(--border-color);">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center">
                                            <span class="text-green-500"></span>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium" style="color:var(--text-primary);">Connected</p>
                                            <p class="text-xs" style="color:var(--text-muted);" id="outlook-connected-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dda8aeb8af9db8a5bcb0adb1b8f3beb2b0">[email&#160;protected]</a></p>
                                        </div>
                                    </div>
                                    <button onclick="disconnectEmailProvider('microsoft')" class="text-xs px-3 py-1.5 rounded-lg hover:bg-red-500/10 text-red-400">
                                        Disconnect
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SendGrid (for power users) -->
                        <div id="sendgrid-connect-card" class="card rounded-xl p-5 border-2 border-transparent hover:border-purple-500 transition">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-xl bg-[#1A82E2] flex items-center justify-center shadow-sm shrink-0">
                                    <span class="text-white font-bold text-xl">SG</span>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <h5 class="font-semibold text-lg" style="color:var(--text-primary);">SendGrid</h5>
                                        <span class="text-xs px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400">Pro</span>
                                    </div>
                                    <p class="text-sm" style="color:var(--text-muted);">Professional email delivery service</p>
                                </div>
                                <button onclick="toggleSendGridSetup()" id="sendgrid-setup-btn" class="btn-secondary px-5 py-2.5 rounded-lg">
                                    Setup
                                </button>
                            </div>
                            <!-- SendGrid Setup -->
                            <div id="sendgrid-setup" class="hidden mt-4 pt-4 border-t space-y-3" style="border-color:var(--border-color);">
                                <div>
                                    <label class="text-sm mb-1 block" style="color:var(--text-secondary);">API Key</label>
                                    <input type="password" id="sendgrid-api-key" class="input-field w-full rounded-lg px-4 py-2.5" placeholder="SG.xxxxxxxxxxxx">
                                </div>
                                <div>
                                    <label class="text-sm mb-1 block" style="color:var(--text-secondary);">From Email</label>
                                    <input type="email" id="sendgrid-from-email" class="input-field w-full rounded-lg px-4 py-2.5" placeholder="notifications@yourdomain.com">
                                </div>
                                <div class="flex justify-end">
                                    <button onclick="saveSendGridConfig()" class="btn-primary px-4 py-2 rounded-lg text-sm">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden field -->
                    <input type="hidden" id="email-provider" value="">
                    <input type="hidden" id="email-config-data" value="">
                </div>

                <!-- Webhook Config -->
                <div id="cfg-webhook" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Webhook URL *</label>
                        <input type="url" id="hook-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://api.example.com/webhook">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Method</label>
                            <select id="hook-method" class="input-field w-full rounded-lg px-4 py-2">
                                <option>POST</option>
                                <option>PUT</option>
                            </select>
                            
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Secret (optional)</label>
                            <input type="password" id="hook-secret" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                </div>

                <!-- Web Search Config -->
                <div id="cfg-websearch" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Search Provider</label>
                        <select id="search-provider" class="input-field w-full rounded-lg px-4 py-2">
                            <option value="tavily">Tavily (AI-optimized)</option>
                            <option value="serper">Serper (Google)</option>
                            <option value="bing">Bing Search</option>
                        </select>
                            
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">API Key *</label>
                        <input type="password" id="search-key" class="input-field w-full rounded-lg px-4 py-2">
                    </div>
                </div>

                <!-- Code Exec Config -->
                <div id="cfg-code" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Execution Mode</label>
                        <select id="code-mode" class="input-field w-full rounded-lg px-4 py-2" onchange="onCodeModeChange()">
                            <option value="execute">Execute Provided Code</option>
                            <option value="generate">Generate Code from Description (AI)</option>
                            <option value="both">Both (Generate & Execute)</option>
                        </select>
                            
                    </div>
                    
                    <!-- Code Generation Section -->
                    <div id="code-gen-section" class="hidden space-y-4">
                        <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-3 text-sm text-purple-300 mb-2">
                             AI will generate tool code based on your description. Describe what the tool should do and the AI will create the implementation.
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Tool Description *</label>
                            <textarea id="code-description" rows="4" class="input-field w-full rounded-lg px-4 py-2" placeholder="Describe what this tool should do in detail...

Example: A tool that fetches weather data from OpenWeatherMap API. It should accept a city name as input and return current temperature, humidity, and weather conditions. Handle API errors gracefully."></textarea>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Input Parameters</label>
                                <input type="text" id="code-inputs" class="input-field w-full rounded-lg px-4 py-2" placeholder="city: string, units: string">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Output Format</label>
                                <select id="code-output-format" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="json">JSON Object</option>
                                    <option value="text">Plain Text</option>
                                    <option value="number">Number</option>
                                    <option value="boolean">Boolean</option>
                                    <option value="array">Array</option>
                                </select>
                            
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Keys / Credentials (will be injected as env vars)</label>
                            <textarea id="code-env-vars" rows="2" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="OPENWEATHER_API_KEY=xxxxx
OTHER_API_KEY=yyyyy"></textarea>
                        </div>
                        <button onclick="generateToolCode()" class="w-full bg-purple-600 hover:bg-purple-500 rounded-lg py-3 font-medium flex items-center justify-center gap-2">
                            <span></span> Generate Code
                        </button>
                        <div id="generated-code-preview" class="hidden">
                            <label class="text-sm text-gray-400 mb-1 block">Generated Code (editable)</label>
                            <textarea id="code-generated" rows="12" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs"></textarea>
                        </div>
                    </div>
                    
                    <!-- Manual Code Section -->
                    <div id="code-manual-section">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Language</label>
                            <select id="code-lang" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="python">Python 3</option>
                                <option value="javascript">JavaScript (Node.js)</option>
                                <option value="typescript">TypeScript</option>
                                <option value="bash">Bash Script</option>
                                <option value="ruby">Ruby</option>
                                <option value="go">Go</option>
                                <option value="rust">Rust</option>
                            </select>
                            
                        </div>
                        <div id="code-manual-input">
                            <label class="text-sm text-gray-400 mb-1 block">Code Template (optional)</label>
                            <textarea id="code-template" rows="6" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="# Your code here
def run(input_data):
    # Process input
    result = process(input_data)
    return result"></textarea>
                        </div>
                    </div>
                    
                    <!-- Execution Settings -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">Execution Settings</p>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Timeout (seconds)</label>
                                <input type="number" id="code-timeout" class="input-field w-full rounded-lg px-4 py-2" value="30">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Memory (MB)</label>
                                <input type="number" id="code-memory" class="input-field w-full rounded-lg px-4 py-2" value="256">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Max Retries</label>
                                <input type="number" id="code-retries" class="input-field w-full rounded-lg px-4 py-2" value="3">
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4 mt-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="code-sandbox" class="w-4 h-4" checked>
                                <span class="text-sm">Run in sandbox</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="code-network" class="w-4 h-4" checked>
                                <span class="text-sm">Allow network access</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="code-filesystem" class="w-4 h-4">
                                <span class="text-sm">Allow file system</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Dependencies -->
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Dependencies / Packages</label>
                        <input type="text" id="code-deps" class="input-field w-full rounded-lg px-4 py-2" placeholder="requests, pandas, numpy (comma separated)">
                    </div>
                </div>

                <!-- Human in the Loop Config -->
                <div id="cfg-hitl" class="hidden space-y-4">
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 text-sm text-blue-300 mb-2">
                         Human in the Loop allows you to pause agent execution for human approval, input collection, or decision making.
                    </div>
                    
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Interaction Type</label>
                        <select id="hitl-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onHITLTypeChange()">
                            <option value="approval">Approval (Yes/No/Maybe)</option>
                            <option value="input">Text Input</option>
                            <option value="selection">Selection (Multiple Choice)</option>
                            <option value="form">Custom Form</option>
                            <option value="review">Review & Edit</option>
                            <option value="escalation">Escalation to Human</option>
                        </select>
                            
                    </div>
                    
                    <!-- Approval Fields -->
                    <div id="hitl-approval-fields" class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Approval Question</label>
                            <input type="text" id="hitl-question" class="input-field w-full rounded-lg px-4 py-2" placeholder="Should we proceed with this action?">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Options</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center gap-2"><input type="checkbox" id="hitl-opt-yes" checked> Yes</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="hitl-opt-no" checked> No</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="hitl-opt-maybe"> Maybe/Later</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="hitl-opt-custom"> Custom options</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selection Fields -->
                    <div id="hitl-selection-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Selection Prompt</label>
                            <input type="text" id="hitl-select-prompt" class="input-field w-full rounded-lg px-4 py-2" placeholder="Please select an option:">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Options (one per line)</label>
                            <textarea id="hitl-options" rows="4" class="input-field w-full rounded-lg px-4 py-2" placeholder="Option 1
Option 2
Option 3"></textarea>
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="hitl-multi-select" class="w-4 h-4">
                            <span class="text-sm">Allow multiple selections</span>
                        </label>
                    </div>
                    
                    <!-- Form Builder Fields -->
                    <div id="hitl-form-fields" class="hidden space-y-4">
                        <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-3 text-sm text-purple-300 mb-2">
                             Build a custom form that will be presented to users. You can optionally deploy it as a web form.
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Form Title</label>
                            <input type="text" id="hitl-form-title" class="input-field w-full rounded-lg px-4 py-2" placeholder="Customer Feedback Form">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Form Description</label>
                            <textarea id="hitl-form-desc" rows="2" class="input-field w-full rounded-lg px-4 py-2" placeholder="Please provide your feedback..."></textarea>
                        </div>
                        
                        <!-- Form Fields Builder -->
                        <div>
                            <label class="text-sm text-gray-400 mb-2 block">Form Fields</label>
                            <div id="hitl-form-builder" class="space-y-2">
                                <!-- Dynamic form fields will be added here -->
                            </div>
                            <button onclick="addHITLFormField()" class="mt-2 text-sm text-purple-400 hover:text-purple-300 flex items-center gap-1">
                                <span>+</span> Add Field
                            </button>
                        </div>
                        
                        <!-- Form Field Template (hidden) -->
                        <template id="hitl-field-template">
                            <div class="card rounded-lg p-3 space-y-2 hitl-field-item">
                                <div class="flex items-center justify-between">
                                    <input type="text" class="input-field flex-1 rounded px-2 py-1 text-sm hitl-field-label" placeholder="Field Label">
                                    <button onclick="removeHITLFormField(this)" class="text-red-400 hover:text-red-300 p-1"></button>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <select class="input-field rounded px-2 py-1 text-sm hitl-field-type" onchange="onHITLFieldTypeChange(this)">
                                        <option value="text">Text Input</option>
                                        <option value="textarea">Text Area</option>
                                        <option value="number">Number</option>
                                        <option value="email">Email</option>
                                        <option value="phone">Phone</option>
                                        <option value="date">Date</option>
                                        <option value="time">Time</option>
                                        <option value="select">Dropdown</option>
                                        <option value="radio">Radio Buttons</option>
                                        <option value="checkbox">Checkboxes</option>
                                        <option value="file">File Upload</option>
                                        <option value="rating">Rating (1-5)</option>
                                    </select>
                            
                                    <label class="flex items-center gap-1 text-sm">
                                        <input type="checkbox" class="hitl-field-required">
                                        Required
                                    </label>
                                </div>
                                <input type="text" class="input-field w-full rounded px-2 py-1 text-sm hitl-field-options hidden" placeholder="Options (comma separated)">
                            </div>
                        </template>
                        
                        <!-- Web Form Deployment (optional) -->
                        <div class="border-t border-gray-700 pt-4 mt-4">
                            <label class="flex items-center gap-2 cursor-pointer mb-3">
                                <input type="checkbox" id="hitl-deploy-form" class="w-4 h-4" onchange="toggleHITLDeployment()">
                                <span class="text-sm font-medium">Deploy as Web Form</span>
                            </label>
                            <div id="hitl-deployment-fields" class="hidden space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Form URL Slug</label>
                                        <div class="flex items-center gap-1">
                                            <span class="text-sm text-gray-500">/forms/</span>
                                            <input type="text" id="hitl-form-slug" class="input-field flex-1 rounded-lg px-3 py-2" placeholder="customer-feedback">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Expiration</label>
                                        <select id="hitl-form-expiry" class="input-field w-full rounded-lg px-4 py-2">
                                            <option value="never">Never</option>
                                            <option value="1h">1 Hour</option>
                                            <option value="24h">24 Hours</option>
                                            <option value="7d">7 Days</option>
                                            <option value="30d">30 Days</option>
                                        </select>
                            
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="hitl-form-public" class="w-4 h-4">
                                        <span class="text-sm">Public (no auth required)</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="hitl-form-notify" class="w-4 h-4" checked>
                                        <span class="text-sm">Notify on submission</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Notification Email</label>
                                    <input type="email" id="hitl-notify-email" class="input-field w-full rounded-lg px-4 py-2" placeholder="admin@company.com">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Webhook URL (optional)</label>
                                    <input type="url" id="hitl-webhook" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://your-server.com/webhook">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Common Settings -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">Behavior Settings</p>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Timeout (minutes)</label>
                                <input type="number" id="hitl-timeout" class="input-field w-full rounded-lg px-4 py-2" value="60" placeholder="0 = no timeout">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Default Action (on timeout)</label>
                                <select id="hitl-default" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="wait">Keep Waiting</option>
                                    <option value="approve">Auto Approve</option>
                                    <option value="reject">Auto Reject</option>
                                    <option value="escalate">Escalate</option>
                                </select>
                            
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4 mt-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="hitl-notify-slack" class="w-4 h-4">
                                <span class="text-sm">Notify via Slack</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="hitl-notify-email-opt" class="w-4 h-4">
                                <span class="text-sm">Notify via Email</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="hitl-log" class="w-4 h-4" checked>
                                <span class="text-sm">Log all interactions</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Spreadsheet Config -->
                <div id="cfg-spreadsheet" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="sheet-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onSheetProvChange()">
                            <option value="google">Google Sheets</option>
                            <option value="airtable">Airtable</option>
                            <option value="excel">Excel Online</option>
                        </select>
                            
                    </div>
                    <div id="sheet-google-fields">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Spreadsheet ID</label>
                            <input type="text" id="sheet-id" class="input-field w-full rounded-lg px-4 py-2" placeholder="From URL: docs.google.com/spreadsheets/d/[ID]">
                        </div>
                        <div class="mt-3">
                            <label class="text-sm text-gray-400 mb-1 block">Service Account JSON</label>
                            <textarea id="sheet-creds" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder='{"type": "service_account", ...}'></textarea>
                        </div>
                    </div>
                    <div id="sheet-airtable-fields" class="hidden">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                            <input type="password" id="airtable-key" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div class="mt-3">
                            <label class="text-sm text-gray-400 mb-1 block">Base ID</label>
                            <input type="text" id="airtable-base" class="input-field w-full rounded-lg px-4 py-2" placeholder="appXXXXXXXXXXXXXX">
                        </div>
                    </div>
                </div>

                <!-- Cloud Storage Config -->
                <div id="cfg-storage" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Storage Type</label>
                        <select id="storage-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onStorageTypeChange()">
                            <option value="cloud">Cloud Storage</option>
                            <option value="local">Local / Network Storage</option>
                        </select>
                            
                    </div>
                    
                    <!-- Cloud Storage Providers -->
                    <div id="storage-cloud-section">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                            <select id="storage-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onStorageProvChange()">
                                <optgroup label="Amazon Web Services">
                                    <option value="s3">Amazon S3</option>
                                    <option value="s3_glacier">Amazon S3 Glacier</option>
                                    <option value="efs">Amazon EFS</option>
                                </optgroup>
                                <optgroup label="Google Cloud">
                                    <option value="gcs">Google Cloud Storage</option>
                                    <option value="gcs_nearline">GCS Nearline</option>
                                    <option value="gcs_coldline">GCS Coldline</option>
                                    <option value="gcs_archive">GCS Archive</option>
                                </optgroup>
                                <optgroup label="Microsoft Azure">
                                    <option value="azure_blob">Azure Blob Storage</option>
                                    <option value="azure_files">Azure Files</option>
                                    <option value="azure_datalake">Azure Data Lake Storage</option>
                                    <option value="azure_archive">Azure Archive Storage</option>
                                </optgroup>
                                <optgroup label="Oracle Cloud Infrastructure">
                                    <option value="oci_object">OCI Object Storage</option>
                                    <option value="oci_archive">OCI Archive Storage</option>
                                    <option value="oci_file">OCI File Storage</option>
                                    <option value="oci_block">OCI Block Volume</option>
                                </optgroup>
                                <optgroup label="Other Cloud Providers">
                                    <option value="ibm_cos">IBM Cloud Object Storage</option>
                                    <option value="alibaba_oss">Alibaba Cloud OSS</option>
                                    <option value="digitalocean_spaces">DigitalOcean Spaces</option>
                                    <option value="backblaze_b2">Backblaze B2</option>
                                    <option value="wasabi">Wasabi</option>
                                    <option value="cloudflare_r2">Cloudflare R2</option>
                                    <option value="linode_obj">Linode Object Storage</option>
                                    <option value="vultr_obj">Vultr Object Storage</option>
                                    <option value="minio">MinIO (S3 Compatible)</option>
                                </optgroup>
                            </select>
                            
                        </div>
                        
                        <!-- Standard S3-Compatible Fields -->
                        <div id="storage-s3-fields" class="mt-4 space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Bucket / Container Name</label>
                                    <input type="text" id="storage-bucket" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                    <input type="text" id="storage-region" class="input-field w-full rounded-lg px-4 py-2" placeholder="us-east-1">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Access Key ID</label>
                                <input type="password" id="storage-key" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Secret Access Key</label>
                                <input type="password" id="storage-secret" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div id="storage-endpoint-field" class="hidden">
                                <label class="text-sm text-gray-400 mb-1 block">Custom Endpoint URL</label>
                                <input type="url" id="storage-endpoint" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://s3.custom-endpoint.com">
                            </div>
                        </div>
                        
                        <!-- OCI Object Storage Fields -->
                        <div id="storage-oci-fields" class="hidden mt-4 space-y-4">
                            <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 text-sm text-orange-300 mb-2">
                                 OCI requires API Key authentication. Generate keys from OCI Console  User Settings  API Keys
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Namespace</label>
                                    <input type="text" id="oci-namespace" class="input-field w-full rounded-lg px-4 py-2" placeholder="your-tenancy-namespace">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Bucket Name</label>
                                    <input type="text" id="oci-bucket" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Compartment OCID</label>
                                    <input type="text" id="oci-compartment" class="input-field w-full rounded-lg px-4 py-2" placeholder="ocid1.compartment.oc1..">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                    <select id="oci-region" class="input-field w-full rounded-lg px-4 py-2">
                                        <option value="us-ashburn-1">US East (Ashburn)</option>
                                        <option value="us-phoenix-1">US West (Phoenix)</option>
                                        <option value="eu-frankfurt-1">Germany (Frankfurt)</option>
                                        <option value="eu-london-1">UK (London)</option>
                                        <option value="ap-tokyo-1">Japan (Tokyo)</option>
                                        <option value="ap-sydney-1">Australia (Sydney)</option>
                                        <option value="ap-mumbai-1">India (Mumbai)</option>
                                        <option value="me-jeddah-1">Saudi Arabia (Jeddah)</option>
                                        <option value="me-dubai-1">UAE (Dubai)</option>
                                        <option value="sa-saopaulo-1">Brazil (Sao Paulo)</option>
                                    </select>
                            
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">User OCID</label>
                                <input type="text" id="oci-user-ocid" class="input-field w-full rounded-lg px-4 py-2" placeholder="ocid1.user.oc1..">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Tenancy OCID</label>
                                <input type="text" id="oci-tenancy-ocid" class="input-field w-full rounded-lg px-4 py-2" placeholder="ocid1.tenancy.oc1..">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">API Key Fingerprint</label>
                                <input type="text" id="oci-fingerprint" class="input-field w-full rounded-lg px-4 py-2" placeholder="xx:xx:xx:xx:xx:...">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Private Key (PEM)</label>
                                <textarea id="oci-private-key" rows="4" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="-----BEGIN RSA PRIVATE KEY-----..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Azure Fields -->
                        <div id="storage-azure-fields" class="hidden mt-4 space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Storage Account Name</label>
                                    <input type="text" id="azure-account" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Container Name</label>
                                    <input type="text" id="azure-container" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Authentication Method</label>
                                <select id="azure-auth-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onAzureAuthChange()">
                                    <option value="connection_string">Connection String</option>
                                    <option value="account_key">Account Key</option>
                                    <option value="sas_token">SAS Token</option>
                                    <option value="service_principal">Service Principal</option>
                                    <option value="managed_identity">Managed Identity</option>
                                </select>
                            
                            </div>
                            <div id="azure-conn-string-field">
                                <label class="text-sm text-gray-400 mb-1 block">Connection String</label>
                                <textarea id="azure-conn-string" rows="2" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs"></textarea>
                            </div>
                            <div id="azure-sp-fields" class="hidden space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Tenant ID</label>
                                        <input type="text" id="azure-tenant" class="input-field w-full rounded-lg px-4 py-2">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Client ID</label>
                                        <input type="text" id="azure-client" class="input-field w-full rounded-lg px-4 py-2">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Client Secret</label>
                                    <input type="password" id="azure-secret" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                        </div>
                        
                        <!-- GCS Fields -->
                        <div id="storage-gcs-fields" class="hidden mt-4 space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Project ID</label>
                                    <input type="text" id="gcs-project" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Bucket Name</label>
                                    <input type="text" id="gcs-bucket" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Service Account JSON</label>
                                <textarea id="gcs-credentials" rows="4" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste service account JSON"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Local/Network Storage Section -->
                    <div id="storage-local-section" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Storage Protocol</label>
                            <select id="local-storage-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onLocalStorageTypeChange()">
                                <option value="local">Local Filesystem</option>
                                <option value="nfs">NFS (Network File System)</option>
                                <option value="smb">SMB/CIFS (Windows Share)</option>
                                <option value="sftp">SFTP</option>
                                <option value="ftp">FTP</option>
                                <option value="webdav">WebDAV</option>
                            </select>
                            
                        </div>
                        
                        <!-- Local Path -->
                        <div id="local-path-field">
                            <label class="text-sm text-gray-400 mb-1 block">Base Path</label>
                            <input type="text" id="local-path" class="input-field w-full rounded-lg px-4 py-2" placeholder="/data/storage or C:\Storage">
                        </div>
                        
                        <!-- Network Storage Fields -->
                        <div id="network-storage-fields" class="hidden space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Host / Server</label>
                                    <input type="text" id="net-host" class="input-field w-full rounded-lg px-4 py-2" placeholder="192.168.1.100 or server.local">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Port</label>
                                    <input type="number" id="net-port" class="input-field w-full rounded-lg px-4 py-2" value="22">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Share / Path</label>
                                <input type="text" id="net-share" class="input-field w-full rounded-lg px-4 py-2" placeholder="/share or \\server\share">
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Username</label>
                                    <input type="text" id="net-user" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Password</label>
                                    <input type="password" id="net-pass" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                            <div id="sftp-key-field" class="hidden">
                                <label class="text-sm text-gray-400 mb-1 block">SSH Private Key (optional)</label>
                                <textarea id="sftp-key" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Storage Options -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">Storage Options</p>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="storage-public" class="w-4 h-4">
                                <span class="text-sm">Public access</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="storage-versioning" class="w-4 h-4">
                                <span class="text-sm">Enable versioning</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="storage-encryption" class="w-4 h-4" checked>
                                <span class="text-sm">Server-side encryption</span>
                            </label>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4 mt-3">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Prefix / Folder</label>
                                <input type="text" id="storage-prefix" class="input-field w-full rounded-lg px-4 py-2" placeholder="uploads/">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Max File Size (MB)</label>
                                <input type="number" id="storage-max-size" class="input-field w-full rounded-lg px-4 py-2" value="100">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Config -->
                <div id="cfg-calendar" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="cal-provider" class="input-field w-full rounded-lg px-4 py-2">
                            <option value="google">Google Calendar</option>
                            <option value="outlook">Microsoft Outlook</option>
                            <option value="caldav">CalDAV</option>
                        </select>
                            
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Calendar ID</label>
                        <input type="text" id="cal-id" class="input-field w-full rounded-lg px-4 py-2" placeholder="primary or specific calendar ID">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Service Account / API Key</label>
                        <textarea id="cal-creds" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste credentials JSON"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="cal-read" class="w-4 h-4" checked>
                            <span class="text-sm">Read events</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="cal-write" class="w-4 h-4">
                            <span class="text-sm">Create/Edit events</span>
                        </label>
                    </div>
                </div>

                <!-- CRM Config -->
                <div id="cfg-crm" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Platform</label>
                        <select id="crm-platform" class="input-field w-full rounded-lg px-4 py-2" onchange="onCRMChange()">
                            <option value="salesforce">Salesforce</option>
                            <option value="hubspot">HubSpot</option>
                            <option value="zoho">Zoho CRM</option>
                            <option value="pipedrive">Pipedrive</option>
                        </select>
                            
                    </div>
                    <div id="crm-salesforce-fields">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Instance URL</label>
                                <input type="url" id="sf-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://yourorg.salesforce.com">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Consumer Key</label>
                                <input type="text" id="sf-key" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="text-sm text-gray-400 mb-1 block">Consumer Secret</label>
                            <input type="password" id="sf-secret" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    <div id="crm-hubspot-fields" class="hidden">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key / Access Token</label>
                            <input type="password" id="hs-key" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Objects to Access</label>
                        <div class="flex flex-wrap gap-3 mt-2">
                            <label class="flex items-center gap-2"><input type="checkbox" id="crm-contacts" checked> Contacts</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="crm-companies" checked> Companies</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="crm-deals"> Deals</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="crm-leads"> Leads</label>
                        </div>
                    </div>
                </div>

                <!-- ERP Config -->
                <div id="cfg-erp" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Platform</label>
                        <select id="erp-platform" class="input-field w-full rounded-lg px-4 py-2">
                            <option value="sap">SAP</option>
                            <option value="oracle">Oracle ERP</option>
                            <option value="netsuite">NetSuite</option>
                            <option value="dynamics">Microsoft Dynamics</option>
                        </select>
                            
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Server URL</label>
                        <input type="url" id="erp-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://erp.company.com">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Username / Client ID</label>
                            <input type="text" id="erp-user" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Password / Secret</label>
                            <input type="password" id="erp-pass" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    <div class="bg-yellow-900/30 border border-yellow-600 rounded-lg p-3 text-sm">
                        <p class="text-yellow-300"> ERP integration requires additional setup. Contact your ERP administrator.</p>
                    </div>
                </div>

                <!-- Messaging (Slack/Teams) Config -->
                <div id="cfg-slack" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Platform</label>
                        <select id="msg-platform" class="input-field w-full rounded-lg px-4 py-2" onchange="onMsgPlatformChange()">
                            <optgroup label="Business Messaging">
                                <option value="slack">Slack</option>
                                <option value="teams">Microsoft Teams</option>
                                <option value="discord">Discord</option>
                                <option value="mattermost">Mattermost</option>
                                <option value="rocket">Rocket.Chat</option>
                                <option value="google_chat">Google Chat</option>
                                <option value="webex">Cisco Webex</option>
                                <option value="zoom">Zoom Chat</option>
                            </optgroup>
                            <optgroup label="Consumer Messaging">
                                <option value="whatsapp">WhatsApp Business API</option>
                                <option value="facebook">Facebook Messenger</option>
                                <option value="instagram">Instagram Direct</option>
                                <option value="telegram">Telegram Bot</option>
                                <option value="viber">Viber</option>
                                <option value="line">LINE</option>
                                <option value="wechat">WeChat</option>
                            </optgroup>
                            <optgroup label="SMS / Voice">
                                <option value="twilio">Twilio SMS</option>
                                <option value="vonage">Vonage (Nexmo)</option>
                                <option value="plivo">Plivo</option>
                                <option value="messagebird">MessageBird</option>
                                <option value="sinch">Sinch</option>
                            </optgroup>
                            <optgroup label="Push Notifications">
                                <option value="firebase_fcm">Firebase Cloud Messaging</option>
                                <option value="onesignal">OneSignal</option>
                                <option value="pusher">Pusher</option>
                                <option value="apns">Apple Push Notifications</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    
                    <!-- Slack Fields -->
                    <div id="msg-slack-fields" class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Bot Token</label>
                            <input type="password" id="slack-token" class="input-field w-full rounded-lg px-4 py-2" placeholder="xoxb-...">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Default Channel</label>
                            <input type="text" id="slack-channel" class="input-field w-full rounded-lg px-4 py-2" placeholder="#general">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Signing Secret (for webhooks)</label>
                            <input type="password" id="slack-signing" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    
                    <!-- MS Teams Fields -->
                    <div id="msg-teams-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Integration Type</label>
                            <select id="teams-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onTeamsTypeChange()">
                                <option value="webhook">Incoming Webhook</option>
                                <option value="bot">Bot Framework</option>
                                <option value="graph">Microsoft Graph API</option>
                            </select>
                            
                        </div>
                        <div id="teams-webhook-field">
                            <label class="text-sm text-gray-400 mb-1 block">Webhook URL</label>
                            <input type="url" id="teams-webhook" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div id="teams-bot-fields" class="hidden space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">App ID</label>
                                    <input type="text" id="teams-app-id" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">App Password</label>
                                    <input type="password" id="teams-app-pass" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Tenant ID</label>
                                <input type="text" id="teams-tenant" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- WhatsApp Fields -->
                    <div id="msg-whatsapp-fields" class="hidden space-y-4">
                        <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3 text-sm text-green-300 mb-2">
                             WhatsApp Business API requires approval. You can use Meta Business Suite or a BSP like Twilio/MessageBird.
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                            <select id="whatsapp-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onWhatsAppProviderChange()">
                                <option value="meta">Meta Cloud API (Direct)</option>
                                <option value="twilio">Twilio for WhatsApp</option>
                                <option value="messagebird">MessageBird</option>
                                <option value="360dialog">360dialog</option>
                                <option value="gupshup">Gupshup</option>
                            </select>
                            
                        </div>
                        <div id="whatsapp-meta-fields" class="space-y-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Access Token</label>
                                <input type="password" id="whatsapp-token" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Phone Number ID</label>
                                    <input type="text" id="whatsapp-phone-id" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Business Account ID</label>
                                    <input type="text" id="whatsapp-business-id" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Webhook Verify Token</label>
                                <input type="text" id="whatsapp-verify" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Facebook Messenger Fields -->
                    <div id="msg-facebook-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Page Access Token</label>
                            <input type="password" id="fb-page-token" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">App ID</label>
                                <input type="text" id="fb-app-id" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">App Secret</label>
                                <input type="password" id="fb-app-secret" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Webhook Verify Token</label>
                            <input type="text" id="fb-verify" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    
                    <!-- Telegram Fields -->
                    <div id="msg-telegram-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Bot Token (from @BotFather)</label>
                            <input type="password" id="telegram-token" class="input-field w-full rounded-lg px-4 py-2" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Default Chat ID (optional)</label>
                            <input type="text" id="telegram-chat-id" class="input-field w-full rounded-lg px-4 py-2" placeholder="-1001234567890">
                        </div>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="telegram-webhook" class="w-4 h-4">
                                <span class="text-sm">Use Webhook (instead of polling)</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Twilio SMS Fields -->
                    <div id="msg-twilio-fields" class="hidden space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Account SID</label>
                                <input type="text" id="twilio-sid" class="input-field w-full rounded-lg px-4 py-2" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Auth Token</label>
                                <input type="password" id="twilio-token" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Phone Number (From)</label>
                            <input type="tel" id="twilio-phone" class="input-field w-full rounded-lg px-4 py-2" placeholder="+1234567890">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Messaging Service SID (optional)</label>
                            <input type="text" id="twilio-msg-sid" class="input-field w-full rounded-lg px-4 py-2" placeholder="MGxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                        </div>
                    </div>
                    
                    <!-- Discord Fields -->
                    <div id="msg-discord-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Bot Token</label>
                            <input type="password" id="discord-token" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Default Channel ID</label>
                            <input type="text" id="discord-channel" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Webhook URL (optional)</label>
                            <input type="url" id="discord-webhook" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    
                    <!-- Firebase FCM Fields -->
                    <div id="msg-firebase-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Service Account JSON</label>
                            <textarea id="fcm-credentials" rows="4" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste Firebase service account JSON"></textarea>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Default Topic (optional)</label>
                            <input type="text" id="fcm-topic" class="input-field w-full rounded-lg px-4 py-2" placeholder="all-users">
                        </div>
                    </div>
                    
                    <!-- Generic Webhook Fields (for other platforms) -->
                    <div id="msg-generic-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key / Token</label>
                            <input type="password" id="msg-api-key" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Endpoint (if custom)</label>
                            <input type="url" id="msg-endpoint" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    
                    <!-- Common Options -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">Options</p>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="msg-receive" class="w-4 h-4" checked>
                                <span class="text-sm">Receive messages</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="msg-send" class="w-4 h-4" checked>
                                <span class="text-sm">Send messages</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="msg-attachments" class="w-4 h-4">
                                <span class="text-sm">Support attachments</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Image Gen Config -->
                <div id="cfg-imagegen" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="img-provider" class="input-field w-full rounded-lg px-4 py-2">
                            <option value="dalle">OpenAI DALL-E</option>
                            <option value="stability">Stability AI</option>
                            <option value="replicate">Replicate</option>
                        </select>
                            
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                        <input type="password" id="img-key" class="input-field w-full rounded-lg px-4 py-2">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Default Size</label>
                            <select id="img-size" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="1024x1024">1024x1024</option>
                                <option value="1792x1024">1792x1024 (Wide)</option>
                                <option value="1024x1792">1024x1792 (Tall)</option>
                            </select>
                            
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Quality</label>
                            <select id="img-quality" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="standard">Standard</option>
                                <option value="hd">HD</option>
                            </select>
                            
                        </div>
                    </div>
                </div>

                <!-- Speech to Text Config -->
                <div id="cfg-stt" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="stt-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onSTTProviderChange()">
                            <optgroup label="Cloud Providers">
                                <option value="whisper">OpenAI Whisper</option>
                                <option value="azure">Azure Speech Services</option>
                                <option value="google">Google Speech-to-Text</option>
                                <option value="aws_transcribe">Amazon Transcribe</option>
                                <option value="oci_speech">Oracle OCI Speech</option>
                                <option value="ibm_watson">IBM Watson Speech to Text</option>
                                <option value="deepgram">Deepgram</option>
                                <option value="assemblyai">AssemblyAI</option>
                                <option value="rev">Rev AI</option>
                                <option value="speechmatics">Speechmatics</option>
                            </optgroup>
                            <optgroup label="On-Premise / Self-Hosted">
                                <option value="whisper_local">Whisper (Local/Self-hosted)</option>
                                <option value="vosk">Vosk (Offline)</option>
                                <option value="deepspeech">Mozilla DeepSpeech</option>
                                <option value="kaldi">Kaldi</option>
                                <option value="coqui">Coqui STT</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    
                    <!-- Cloud API Fields -->
                    <div id="stt-cloud-fields" class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                            <input type="password" id="stt-key" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div id="stt-region-field">
                            <label class="text-sm text-gray-400 mb-1 block">Region / Endpoint</label>
                            <input type="text" id="stt-region" class="input-field w-full rounded-lg px-4 py-2" placeholder="us-east-1 or endpoint URL">
                        </div>
                    </div>
                    
                    <!-- OCI Speech Fields -->
                    <div id="stt-oci-fields" class="hidden space-y-4">
                        <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 text-sm text-orange-300 mb-2">
                             OCI Speech supports real-time and batch transcription with Arabic, English, and other languages.
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Compartment OCID</label>
                                <input type="text" id="stt-oci-compartment" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                <select id="stt-oci-region" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="us-ashburn-1">US East (Ashburn)</option>
                                    <option value="us-phoenix-1">US West (Phoenix)</option>
                                    <option value="eu-frankfurt-1">Germany (Frankfurt)</option>
                                    <option value="uk-london-1">UK (London)</option>
                                </select>
                            
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">OCI Config File or API Key</label>
                            <textarea id="stt-oci-config" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste OCI config or API key details"></textarea>
                        </div>
                    </div>
                    
                    <!-- Azure Speech Fields -->
                    <div id="stt-azure-fields" class="hidden space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Speech Key</label>
                                <input type="password" id="stt-azure-key" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Service Region</label>
                                <input type="text" id="stt-azure-region" class="input-field w-full rounded-lg px-4 py-2" placeholder="eastus">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Custom Endpoint (optional)</label>
                            <input type="url" id="stt-azure-endpoint" class="input-field w-full rounded-lg px-4 py-2" placeholder="For custom speech models">
                        </div>
                    </div>
                    
                    <!-- Self-hosted Fields -->
                    <div id="stt-local-fields" class="hidden space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Server URL</label>
                                <input type="url" id="stt-local-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="http://localhost:8080">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Model</label>
                                <select id="stt-local-model" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="tiny">Tiny (Fast, Less Accurate)</option>
                                    <option value="base">Base</option>
                                    <option value="small">Small</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="large">Large (Most Accurate)</option>
                                    <option value="large-v3">Large V3</option>
                                </select>
                            
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Model Path (for local files)</label>
                            <input type="text" id="stt-model-path" class="input-field w-full rounded-lg px-4 py-2" placeholder="/models/whisper-medium">
                        </div>
                    </div>
                    
                    <!-- Common Options -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Default Language</label>
                            <select id="stt-lang" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="auto">Auto-detect</option>
                                <option value="en">English</option>
                                <option value="ar">Arabic</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="zh">Chinese</option>
                                <option value="ja">Japanese</option>
                                <option value="ko">Korean</option>
                                <option value="pt">Portuguese</option>
                                <option value="ru">Russian</option>
                                <option value="hi">Hindi</option>
                            </select>
                            
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Audio Format</label>
                            <select id="stt-format" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="auto">Auto-detect</option>
                                <option value="wav">WAV</option>
                                <option value="mp3">MP3</option>
                                <option value="ogg">OGG</option>
                                <option value="flac">FLAC</option>
                                <option value="webm">WebM</option>
                            </select>
                            
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="stt-realtime" class="w-4 h-4">
                            <span class="text-sm">Real-time streaming</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="stt-punctuation" class="w-4 h-4" checked>
                            <span class="text-sm">Auto punctuation</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="stt-timestamps" class="w-4 h-4">
                            <span class="text-sm">Word timestamps</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="stt-diarization" class="w-4 h-4">
                            <span class="text-sm">Speaker diarization</span>
                        </label>
                    </div>
                </div>

                <!-- Text to Speech Config -->
                <div id="cfg-tts" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="tts-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onTTSProviderChange()">
                            <optgroup label="Cloud Providers">
                                <option value="elevenlabs">ElevenLabs</option>
                                <option value="openai">OpenAI TTS</option>
                                <option value="azure">Azure Speech Services</option>
                                <option value="google">Google Cloud Text-to-Speech</option>
                                <option value="aws_polly">Amazon Polly</option>
                                <option value="oci_speech">Oracle OCI Speech</option>
                                <option value="ibm_watson">IBM Watson Text to Speech</option>
                                <option value="murf">Murf AI</option>
                                <option value="play_ht">Play.ht</option>
                                <option value="resemble">Resemble AI</option>
                                <option value="wellsaid">WellSaid Labs</option>
                            </optgroup>
                            <optgroup label="On-Premise / Self-Hosted">
                                <option value="coqui_tts">Coqui TTS</option>
                                <option value="piper">Piper TTS</option>
                                <option value="espeak">eSpeak NG</option>
                                <option value="festival">Festival</option>
                                <option value="mimic">Mycroft Mimic</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    
                    <!-- Cloud API Fields -->
                    <div id="tts-cloud-fields" class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                            <input type="password" id="tts-key" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    
                    <!-- OCI TTS Fields -->
                    <div id="tts-oci-fields" class="hidden space-y-4">
                        <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 text-sm text-orange-300 mb-2">
                             OCI Speech supports multiple voices including Arabic neural voices.
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Compartment OCID</label>
                                <input type="text" id="tts-oci-compartment" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                <select id="tts-oci-region" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="us-ashburn-1">US East (Ashburn)</option>
                                    <option value="us-phoenix-1">US West (Phoenix)</option>
                                    <option value="eu-frankfurt-1">Germany (Frankfurt)</option>
                                </select>
                            
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">OCI Config</label>
                            <textarea id="tts-oci-config" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste OCI config"></textarea>
                        </div>
                    </div>
                    
                    <!-- Self-hosted Fields -->
                    <div id="tts-local-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Server URL</label>
                            <input type="url" id="tts-local-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="http://localhost:5002">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Model Path</label>
                            <input type="text" id="tts-model-path" class="input-field w-full rounded-lg px-4 py-2" placeholder="/models/tts-model">
                        </div>
                    </div>
                    
                    <!-- Voice Selection -->
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Voice</label>
                        <select id="tts-voice" class="input-field w-full rounded-lg px-4 py-2">
                            <optgroup label="OpenAI Voices">
                                <option value="alloy">Alloy (Neutral)</option>
                                <option value="echo">Echo (Male)</option>
                                <option value="fable">Fable (British)</option>
                                <option value="onyx">Onyx (Deep Male)</option>
                                <option value="nova">Nova (Female)</option>
                                <option value="shimmer">Shimmer (Female)</option>
                            </optgroup>
                            <optgroup label="Azure Neural Voices">
                                <option value="en-US-JennyNeural">Jenny (US Female)</option>
                                <option value="en-US-GuyNeural">Guy (US Male)</option>
                                <option value="en-GB-SoniaNeural">Sonia (UK Female)</option>
                                <option value="ar-SA-ZariyahNeural">Zariyah (Arabic Female)</option>
                                <option value="ar-SA-HamedNeural">Hamed (Arabic Male)</option>
                            </optgroup>
                            <optgroup label="ElevenLabs">
                                <option value="rachel">Rachel</option>
                                <option value="drew">Drew</option>
                                <option value="clyde">Clyde</option>
                                <option value="paul">Paul</option>
                                <option value="domi">Domi</option>
                                <option value="dave">Dave</option>
                                <option value="fin">Fin</option>
                                <option value="sarah">Sarah</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    
                    <!-- TTS Options -->
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Speed</label>
                            <input type="range" id="tts-speed" min="0.5" max="2" step="0.1" value="1" class="w-full">
                            <span class="text-xs text-gray-500" id="tts-speed-val">1.0x</span>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Pitch</label>
                            <input type="range" id="tts-pitch" min="-20" max="20" step="1" value="0" class="w-full">
                            <span class="text-xs text-gray-500" id="tts-pitch-val">0</span>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Output Format</label>
                            <select id="tts-format" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="mp3">MP3</option>
                                <option value="wav">WAV</option>
                                <option value="ogg">OGG</option>
                                <option value="opus">Opus</option>
                            </select>
                            
                        </div>
                    </div>
                </div>

                <!-- Translation Config -->
                <div id="cfg-translate" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="trans-provider" class="input-field w-full rounded-lg px-4 py-2">
                            <optgroup label="Cloud Providers">
                                <option value="deepl">DeepL</option>
                                <option value="google">Google Translate</option>
                                <option value="azure">Azure Translator</option>
                                <option value="aws_translate">Amazon Translate</option>
                                <option value="oci_language">Oracle OCI Language</option>
                                <option value="ibm_watson">IBM Watson Language Translator</option>
                                <option value="yandex">Yandex Translate</option>
                                <option value="papago">Naver Papago</option>
                            </optgroup>
                            <optgroup label="Self-Hosted">
                                <option value="libretranslate">LibreTranslate</option>
                                <option value="argos">Argos Translate</option>
                                <option value="opus_mt">Opus-MT (Hugging Face)</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                        <input type="password" id="trans-key" class="input-field w-full rounded-lg px-4 py-2">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Source Language</label>
                            <select id="trans-source" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="auto">Auto-detect</option>
                                <option value="en">English</option>
                                <option value="ar">Arabic</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="zh">Chinese</option>
                                <option value="ja">Japanese</option>
                                <option value="ko">Korean</option>
                                <option value="pt">Portuguese</option>
                                <option value="ru">Russian</option>
                            </select>
                            
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Target Language</label>
                            <select id="trans-target" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="en">English</option>
                                <option value="ar">Arabic</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="zh">Chinese</option>
                                <option value="ja">Japanese</option>
                                <option value="ko">Korean</option>
                                <option value="pt">Portuguese</option>
                                <option value="ru">Russian</option>
                            </select>
                            
                        </div>
                    </div>
                </div>

                <!-- OCR / Vision Config -->
                <div id="cfg-ocr" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="ocr-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onOCRProviderChange()">
                            <optgroup label="AI Vision (Multi-modal)">
                                <option value="gpt4v">OpenAI GPT-4 Vision</option>
                                <option value="claude_vision">Anthropic Claude Vision</option>
                                <option value="gemini_vision">Google Gemini Vision</option>
                            </optgroup>
                            <optgroup label="Cloud OCR Services">
                                <option value="azure_vision">Azure Computer Vision</option>
                                <option value="azure_doc">Azure Document Intelligence</option>
                                <option value="google_vision">Google Cloud Vision</option>
                                <option value="google_doc_ai">Google Document AI</option>
                                <option value="aws_textract">Amazon Textract</option>
                                <option value="aws_rekognition">Amazon Rekognition</option>
                                <option value="oci_vision">Oracle OCI Vision</option>
                                <option value="oci_doc">Oracle OCI Document Understanding</option>
                                <option value="ibm_watson">IBM Watson Visual Recognition</option>
                            </optgroup>
                            <optgroup label="Specialized OCR">
                                <option value="abbyy">ABBYY Cloud OCR</option>
                                <option value="nanonets">Nanonets</option>
                                <option value="docparser">Docparser</option>
                                <option value="rossum">Rossum</option>
                                <option value="veryfi">Veryfi (Receipts/Invoices)</option>
                                <option value="mindee">Mindee</option>
                            </optgroup>
                            <optgroup label="On-Premise / Self-Hosted">
                                <option value="tesseract">Tesseract OCR</option>
                                <option value="paddleocr">PaddleOCR</option>
                                <option value="easyocr">EasyOCR</option>
                                <option value="doctr">docTR</option>
                                <option value="surya">Surya OCR</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    
                    <!-- Cloud API Fields -->
                    <div id="ocr-cloud-fields" class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                            <input type="password" id="ocr-key" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div id="ocr-endpoint-field">
                            <label class="text-sm text-gray-400 mb-1 block">Endpoint / Region</label>
                            <input type="text" id="ocr-endpoint" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://... or region name">
                        </div>
                    </div>
                    
                    <!-- OCI Vision Fields -->
                    <div id="ocr-oci-fields" class="hidden space-y-4">
                        <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 text-sm text-orange-300 mb-2">
                             OCI Vision supports document analysis, text detection, image classification, and object detection.
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Compartment OCID</label>
                                <input type="text" id="ocr-oci-compartment" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                <select id="ocr-oci-region" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="us-ashburn-1">US East (Ashburn)</option>
                                    <option value="us-phoenix-1">US West (Phoenix)</option>
                                    <option value="eu-frankfurt-1">Germany (Frankfurt)</option>
                                    <option value="uk-london-1">UK (London)</option>
                                    <option value="ap-tokyo-1">Japan (Tokyo)</option>
                                </select>
                            
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">OCI Config</label>
                            <textarea id="ocr-oci-config" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste OCI config"></textarea>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Model (optional)</label>
                            <input type="text" id="ocr-oci-model" class="input-field w-full rounded-lg px-4 py-2" placeholder="Custom model OCID">
                        </div>
                    </div>
                    
                    <!-- Self-hosted Fields -->
                    <div id="ocr-local-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Server URL (if remote)</label>
                            <input type="url" id="ocr-local-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="http://localhost:8000 (leave empty for local)">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Language(s)</label>
                                <input type="text" id="ocr-langs" class="input-field w-full rounded-lg px-4 py-2" placeholder="eng+ara (Tesseract format)">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Tessdata Path</label>
                                <input type="text" id="ocr-tessdata" class="input-field w-full rounded-lg px-4 py-2" placeholder="/usr/share/tesseract-ocr/tessdata">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Capabilities -->
                    <div>
                        <label class="text-sm text-gray-400 mb-3 block">Capabilities</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-text" class="w-4 h-4" checked>
                                <span class="text-sm">Text extraction</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-tables" class="w-4 h-4">
                                <span class="text-sm">Table extraction</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-forms" class="w-4 h-4">
                                <span class="text-sm">Form fields</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-handwriting" class="w-4 h-4">
                                <span class="text-sm">Handwriting</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-labels" class="w-4 h-4">
                                <span class="text-sm">Label detection</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-faces" class="w-4 h-4">
                                <span class="text-sm">Face detection</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-objects" class="w-4 h-4">
                                <span class="text-sm">Object detection</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-barcode" class="w-4 h-4">
                                <span class="text-sm">Barcode/QR</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-pdf" class="w-4 h-4">
                                <span class="text-sm">PDF processing</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Document Types -->
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Specialized Document Type (optional)</label>
                        <select id="ocr-doc-type" class="input-field w-full rounded-lg px-4 py-2">
                            <option value="general">General / Any</option>
                            <option value="invoice">Invoice</option>
                            <option value="receipt">Receipt</option>
                            <option value="id_card">ID Card / Passport</option>
                            <option value="business_card">Business Card</option>
                            <option value="bank_statement">Bank Statement</option>
                            <option value="medical">Medical Document</option>
                            <option value="contract">Contract / Legal</option>
                        </select>
                            
                    </div>
                </div>

                <!-- Simple tools (no config) -->
                <div id="cfg-simple" class="hidden">
                    <div class="text-center p-8 text-gray-400">
                        <span class="text-4xl block mb-3"></span>
                        <p>This tool requires no additional configuration.</p>
                        <p class="text-sm mt-2">Click Next to continue.</p>
                    </div>
                </div>
            </div>

            <!-- Step 3: Add Sources (for data tools) -->
            <div id="wiz-step-3" class="hidden space-y-4">
                <div class="flex items-center gap-3 p-3 rounded-lg step-header-box">
                    <span class="text-2xl"></span>
                    <div>
                        <h4 class="font-semibold">Add Sources</h4>
                        <p class="text-xs text-gray-400">Step 3 of 4: Add content to your knowledge base</p>
                    </div>
                </div>

                <!-- Source Tabs -->
                <div id="source-tabs" class="flex flex-wrap gap-2 border-b border-gray-700">
                    <button onclick="setSourceTab('docs')" id="tab-docs" class="px-4 py-2 text-sm border-b-2 border-purple-500 text-white"> Files</button>
                    <button onclick="setSourceTab('urls')" id="tab-urls" class="px-4 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-white"> URLs</button>
                    <button onclick="setSourceTab('text')" id="tab-text" class="px-4 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-white"> Text</button>
                    <button onclick="setSourceTab('table')" id="tab-table" class="px-4 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-white"> Table</button>
                </div>

                <!-- Documents Upload -->
                <div id="sources-docs" class="space-y-4">
                    <div class="drop-zone rounded-lg p-8 text-center cursor-pointer border-2 border-dashed border-gray-600 hover:border-purple-500 transition" onclick="document.getElementById('wiz-files').click()">
                        <input type="file" id="wiz-files" class="hidden" multiple onchange="handleWizFiles(event)">
                        <span class="text-4xl block mb-2"></span>
                        <p class="text-gray-400">Drop files or click to browse</p>
                        <p class="text-xs text-gray-500 mt-1">PDF, Word, Excel, PowerPoint, Text, CSV</p>
                    </div>
                    <div id="wiz-files-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>

                <!-- URL Input -->
                <div id="sources-urls" class="hidden space-y-4">
                    <div class="flex gap-2">
                        <input type="url" id="wiz-url-input" class="input-field flex-1 rounded-lg px-4 py-2" placeholder="https://example.com/page">
                        <button onclick="addWizUrl()" class="btn-primary px-4 py-2 rounded-lg">Add</button>
                    </div>
                    <div id="wiz-urls-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>

                <!-- Text Entry -->
                <div id="sources-text" class="hidden space-y-4">
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Entry Title</label>
                            <input type="text" id="wiz-text-title" class="input-field w-full rounded-lg px-4 py-2" placeholder="e.g., Company Policy, FAQ">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Content</label>
                            <textarea id="wiz-text-content" class="input-field w-full rounded-lg px-4 py-3 font-mono text-sm" rows="6" placeholder="Enter text content that the agent can search..."></textarea>
                        </div>
                        <button onclick="addWizTextEntry()" class="btn-secondary w-full py-2 rounded-lg"> Add Text Entry</button>
                    </div>
                    <div id="wiz-text-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>

                <!-- Table Entry -->
                <div id="sources-table" class="hidden space-y-4">
                    <div class="space-y-3">
                        <div class="flex gap-3">
                            <div class="flex-1">
                                <label class="text-sm text-gray-400 mb-1 block">Table Name</label>
                                <input type="text" id="wiz-table-name" class="input-field w-full rounded-lg px-4 py-2" placeholder="e.g., Employee Directory">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Import</label>
                                <input type="file" id="wiz-table-file" class="hidden" accept=".csv,.xlsx,.xls" onchange="importWizTableFile(event)">
                                <button onclick="document.getElementById('wiz-table-file').click()" class="btn-secondary px-4 py-2 rounded-lg h-[42px]"> CSV/Excel</button>
                            </div>
                        </div>
                        <div class="flex gap-4 items-center">
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400">Columns:</label>
                                <button onclick="changeWizTableCols(-1)" class="btn-secondary w-8 h-8 rounded">-</button>
                                <span id="wiz-col-count" class="w-8 text-center">3</span>
                                <button onclick="changeWizTableCols(1)" class="btn-secondary w-8 h-8 rounded">+</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400">Rows:</label>
                                <button onclick="changeWizTableRows(-1)" class="btn-secondary w-8 h-8 rounded">-</button>
                                <span id="wiz-row-count" class="w-8 text-center">2</span>
                                <button onclick="changeWizTableRows(1)" class="btn-secondary w-8 h-8 rounded">+</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto max-h-48">
                            <div id="wiz-table-editor"></div>
                        </div>
                        <button onclick="addWizTableEntry()" class="btn-secondary w-full py-2 rounded-lg"> Add Table</button>
                    </div>
                    <div id="wiz-table-list" class="space-y-2 max-h-32 overflow-y-auto"></div>
                </div>

                <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-3 text-sm">
                    <p class="text-blue-300"> You can skip this step and add sources later from the tool detail page.</p>
                </div>
            </div>

            <!-- Step 4: Test & Create -->
            <div id="wiz-step-4" class="hidden space-y-4">
                <div class="flex items-center gap-3 p-3 rounded-lg border border-green-700 bg-green-900/20">
                    <span class="text-2xl"></span>
                    <div>
                        <h4 class="font-semibold">Test & Create</h4>
                        <p class="text-xs text-gray-400">Step 4 of 4: Verify and finish</p>
                    </div>
                </div>

                <!-- Summary -->
                <div class="card rounded-lg p-4">
                    <h5 class="font-medium mb-3"> Summary</h5>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3 text-sm">
                        <div><span class="text-gray-400">Type:</span> <span id="sum-type" class="ml-2">-</span></div>
                        <div><span class="text-gray-400">Name:</span> <span id="sum-name" class="ml-2 font-medium">-</span></div>
                        <div><span class="text-gray-400"> Files:</span> <span id="sum-docs" class="ml-2">0</span></div>
                        <div><span class="text-gray-400"> URLs:</span> <span id="sum-urls" class="ml-2">0</span></div>
                        <div><span class="text-gray-400"> Text:</span> <span id="sum-text" class="ml-2">0</span></div>
                        <div><span class="text-gray-400"> Tables:</span> <span id="sum-tables" class="ml-2">0</span></div>
                    </div>
                </div>

                <!-- Test Section -->
                <div class="card rounded-lg p-4">
                    <h5 class="font-medium mb-3"> Test Connection</h5>
                    <button onclick="testWizTool()" class="btn-secondary w-full py-2 rounded-lg mb-3">Run Test</button>
                    <div id="wiz-test-result" class="hidden p-3 rounded-lg text-sm"></div>
                </div>

                <div class="bg-green-900/30 border border-green-600/50 rounded-lg p-3 text-sm">
                    <p class="text-green-300"> Ready to create! Click "Create Tool" to finish.</p>
                </div>
            </div>

        </div>

        <!-- Footer with Navigation -->
        <div id="wizard-footer" class="hidden p-4 md:p-6 border-t border-gray-800 flex justify-between shrink-0 bg-[#1e1e2e]">
            <button onclick="wizBack()" id="btn-back" class="btn-secondary px-6 py-2 rounded-lg"> Back</button>
            <div class="flex gap-2">
                <button onclick="wizSkip()" id="btn-skip" class="hidden text-gray-400 hover:text-white px-4 py-2">Skip</button>
                <button onclick="wizNext()" id="btn-next" class="btn-primary px-6 py-2 rounded-lg">Next </button>
                <button onclick="wizCreate()" id="btn-create" class="hidden btn-primary px-6 py-2 rounded-lg bg-green-600 hover:bg-green-700"> Create Tool</button>
            </div>
        </div>
    </div>
</div>

    <!-- Progress Modal -->
    <div id="progress-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[60]">
        <div class="card rounded-xl w-full max-w-md mx-4 p-6">
            <h3 id="progress-title" class="text-lg font-bold mb-4">Processing...</h3>
            
            <!-- Progress Bar -->
            <div class="bg-gray-700 rounded-full h-3 mb-3 overflow-hidden">
                <div id="progress-bar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            
            <!-- Status Text -->
            <p id="progress-status" class="text-sm text-gray-300 mb-4">Starting...</p>
            
            <!-- Log Area -->
            <div id="progress-log" class="bg-gray-900 rounded-lg p-3 h-32 overflow-y-auto font-mono text-xs space-y-1"></div>
            
            <!-- Spinner -->
            <div class="flex items-center justify-center mt-4">
                <div class="animate-spin rounded-full h-6 w-6 border-2 border-purple-500 border-t-transparent"></div>
                <span class="ml-2 text-sm text-gray-400">Please wait...</span>
            </div>
        </div>
    </div>

    <!-- Data Viewer Modal -->
    <div id="data-viewer-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[70]" onclick="if(event.target===this)closeDataViewer()">
        <div class="card rounded-xl w-full max-w-5xl mx-4 max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="p-4 border-b border-gray-700 flex items-center justify-between flex-shrink-0">
                <div>
                    <h3 id="data-viewer-title" class="text-lg font-bold"> Extracted Data</h3>
                    <p id="data-viewer-subtitle" class="text-sm text-gray-400"></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="copyDataContent()" class="btn-secondary px-3 py-1.5 rounded-lg text-sm"> Copy</button>
                    <button onclick="downloadDataContent()" class="btn-secondary px-3 py-1.5 rounded-lg text-sm"> Download</button>
                    <button onclick="closeDataViewer()" class="text-gray-400 hover:text-white text-xl px-2"></button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="flex gap-4 px-4 pt-3 border-b border-gray-700 flex-shrink-0">
                <button onclick="setDataTab('tables')" id="data-tab-tables" class="pb-2 px-1 border-b-2 border-purple-500 text-white text-sm"> Tables</button>
                <button onclick="setDataTab('text')" id="data-tab-text" class="pb-2 px-1 border-b-2 border-transparent text-gray-400 text-sm"> Full Text</button>
                <button onclick="setDataTab('chunks')" id="data-tab-chunks" class="pb-2 px-1 border-b-2 border-transparent text-gray-400 text-sm"> Chunks</button>
            </div>
            
            <!-- Search Box -->
            <div id="data-search-box" class="hidden px-4 py-3 border-b border-gray-700 flex-shrink-0">
                <div class="flex gap-2">
                    <input type="text" id="data-search-input" class="input-field flex-1 rounded-lg px-4 py-2 text-sm" placeholder=" Search in data... (e.g. 'file storage', 'compute', 'price')" onkeyup="if(event.key==='Enter')searchToolData()">
                    <button onclick="searchToolData()" class="btn-primary px-4 py-2 rounded-lg text-sm">Search</button>
                    <button onclick="document.getElementById('data-search-input').value='';searchToolData()" class="btn-secondary px-3 py-2 rounded-lg text-sm">Clear</button>
                </div>
            </div>
            
            <!-- Content -->
            <div id="data-viewer-content" class="flex-1 overflow-auto p-4">
                <div class="text-center text-gray-500 py-10">Loading...</div>
            </div>
            
            <!-- Footer Stats -->
            <div id="data-viewer-stats" class="p-3 border-t border-gray-700 text-xs text-gray-500 flex gap-4 flex-shrink-0">
            </div>
        </div>
    </div>

    <script>
        const API='';
        
        // Utility function - define early
        function escHtml(text) {
            if(text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        let step=0,wizard={name:'',icon:'',goal:'',originalGoal:'',personality:null,tasks:[],tool_ids:[],suggestedTools:[],guardrails:{},model:'',modelReason:'',editId:null,deployTarget:'cloud',cloudProvider:''},allTools=[],toolType=null,uploadedFiles=[],agentTab='published',conv=null,testAgent=null,apiStep=1,apiParams=[],configMode='manual',chatAttachments=[],testAttachments=[];

        function navigate(p, updateHash = true){
            document.querySelectorAll('main>section').forEach(s=>s.classList.add('hidden'));
            document.getElementById('page-'+p).classList.remove('hidden');
            // Desktop nav
            document.querySelectorAll('.sidebar-item').forEach(b=>b.classList.remove('active'));
            document.getElementById('nav-'+p)?.classList.add('active');
            // Mobile nav
            document.querySelectorAll('.mobile-nav button').forEach(b=>b.classList.remove('active'));
            document.getElementById('mob-'+p)?.classList.add('active');
            
            // Update URL hash (for browser back/forward and refresh)
            if (updateHash) {
                window.location.hash = p;
            }
            
            if(p==='agents')loadAgents();
            if(p==='tools')loadTools();
            if(p==='chat')loadChatAgents();
            if(p==='create'){resetWizardNew();step=0;updateStepsNew();}
            if(p==='settings'){
                loadSettings();
                // Update theme buttons to show current selection
                const currentTheme = localStorage.getItem('agentforge-theme') || 'dark';
                updateThemeButtons(currentTheme);
            }
            if(p==='profile') loadProfileInfo();
            if(p==='demo')initDemoLab();
        }
        
        // Handle browser back/forward buttons
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.slice(1); // Remove the '#'
            if (hash && document.getElementById('page-' + hash)) {
                navigate(hash, false);
            }
        });
        
        // ============================================================================
        // PERSONALITY SLIDER FUNCTIONS
        // ============================================================================
        
        // Store API-provided personality descriptions (100% dynamic from LLM)
        let apiPersonalityDescriptions = {};
        
        // Update a personality slider - descriptions come from API only
        function updatePersonalitySlider(trait, value) {
            value = Math.min(10, Math.max(1, parseInt(value) || 5));
            
            // Update number input
            const numInput = document.getElementById(`p-${trait}-num`);
            const slider = document.getElementById(`p-${trait}`);
            if (numInput) numInput.value = value;
            if (slider) slider.value = value;
            
            // Update wizard personality
            if (!wizard.personality) wizard.personality = {};
            wizard.personality[trait] = value;
            
            // Update description - ONLY use API description (no fallback)
            const descEl = document.getElementById(`p-${trait}-desc`);
            if (descEl) {
                const apiDesc = apiPersonalityDescriptions[trait + 'Desc'];
                if (apiDesc) {
                    descEl.textContent = apiDesc;
                }
                // If no API description, leave as is (will be updated on next API call)
            }
            
            // Update overall preview
            updatePersonalityPreview();
        }
        
        // Sync slider from number input
        function syncSlider(trait, value) {
            value = Math.min(10, Math.max(1, parseInt(value) || 5));
            document.getElementById(`p-${trait}`).value = value;
            updatePersonalitySlider(trait, value);
        }
        
        // Update the personality preview text - uses API-provided reason
        function updatePersonalityPreview() {
            const previewEl = document.getElementById('personality-preview-text');
            if (!previewEl) return;
            
            // If we have an API-provided personality reason, use it
            if (wizard.personalityReason) {
                previewEl.textContent = wizard.personalityReason;
                return;
            }
            
            // Otherwise show a simple dynamic message
            const name = wizard.name || 'Your agent';
            previewEl.textContent = `${name}'s personality is configured above. Generate from a goal to get AI recommendations.`;
        }
        
        // Reset personality - just clears values, user must regenerate
        function resetPersonalityDefaults() {
            const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
            traits.forEach(trait => {
                const slider = document.getElementById(`p-${trait}`);
                const numInput = document.getElementById(`p-${trait}-num`);
                const descEl = document.getElementById(`p-${trait}-desc`);
                if (slider) slider.value = 5;
                if (numInput) numInput.value = 5;
                if (descEl) descEl.textContent = 'Generate from goal to get AI recommendation';
            });
            wizard.personality = null;
            wizard.personalityReason = null;
            apiPersonalityDescriptions = {};
            updatePersonalityPreview();
        }
        
        // Initialize personality sliders from wizard state
        function initPersonalitySliders() {
            if (!wizard.personality) return;
            
            const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
            traits.forEach(trait => {
                const val = wizard.personality[trait];
                if (val !== undefined) {
                    const slider = document.getElementById(`p-${trait}`);
                    const numInput = document.getElementById(`p-${trait}-num`);
                    if (slider) slider.value = val;
                    if (numInput) numInput.value = val;
                }
            });
            
            updatePersonalityPreview();
        }
        
        // Update all personality descriptions when agent name changes
        function updateAgentNameInPersonality() {
            wizard.name = document.getElementById('w-name')?.value || '';
            const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
            traits.forEach(trait => {
                const slider = document.getElementById(`p-${trait}`);
                if (slider) {
                    updatePersonalitySlider(trait, slider.value);
                }
            });
            updatePersonalityPreview();
        }
        
        // ============================================================================
        // GOAL CHANGE - REAL-TIME RECOMMENDATIONS
        // ============================================================================
        
        let goalDebounceTimer = null;
        let lastGoalText = '';
        
        // Called when goal text changes
        function onGoalChange() {
            const goal = document.getElementById('w-goal')?.value?.trim() || '';
            
            // Don't update if goal is too short or hasn't changed significantly
            if (goal.length < 20 || goal === lastGoalText) {
                return;
            }
            
            // Clear previous timer
            if (goalDebounceTimer) {
                clearTimeout(goalDebounceTimer);
            }
            
            // Show hint that we're waiting
            const hint = document.getElementById('goal-hint');
            if (hint) {
                hint.textContent = 'Keep typing... recommendations will update automatically';
                hint.className = 'text-[10px] text-purple-400 mt-1';
            }
            
            // Debounce: wait 1.5 seconds after user stops typing
            goalDebounceTimer = setTimeout(() => {
                lastGoalText = goal;
                updateRecommendationsFromGoal(goal);
            }, 1500);
        }
        
        // Fetch new recommendations from API based on goal
        async function updateRecommendationsFromGoal(goal) {
            const indicator = document.getElementById('goal-update-indicator');
            const hint = document.getElementById('goal-hint');
            
            // Show loading indicator
            if (indicator) indicator.classList.remove('hidden');
            if (hint) {
                hint.textContent = 'AI is analyzing your goal...';
                hint.className = 'text-[10px] text-purple-400 mt-1';
            }
            
            try {
                const response = await fetch(API + '/api/agents/generate-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        goal: goal,
                        update_mode: true  // Flag to indicate this is an update, not initial creation
                    })
                });
                
                if (!response.ok) throw new Error('Failed to get recommendations');
                
                const config = await response.json();
                
                // Apply recommendations with animation
                applyRecommendationsWithAnimation(config);
                
                // Show success
                if (hint) {
                    hint.textContent = ' Recommendations updated based on your goal';
                    hint.className = 'text-[10px] text-green-400 mt-1';
                    
                    // Reset hint after 3 seconds
                    setTimeout(() => {
                        hint.textContent = 'Edit your goal anytime - recommendations will update automatically';
                        hint.className = 'text-[10px] text-gray-500 mt-1';
                    }, 3000);
                }
                
                // Show toast
                showToast(' AI recommendations updated!', 'success');
                
            } catch (error) {
                console.error('Error updating recommendations:', error);
                if (hint) {
                    hint.textContent = 'Could not update recommendations. Try again.';
                    hint.className = 'text-[10px] text-red-400 mt-1';
                }
            } finally {
                // Hide loading indicator
                if (indicator) indicator.classList.add('hidden');
            }
        }
        
        // Apply recommendations with smooth animation
        function applyRecommendationsWithAnimation(config) {
            // 1. Update Model with animation
            if (config.model) {
                wizard.model = config.model;
                wizard.modelReason = config.modelReason;  // Store the reason
                
                const modelContainer = document.getElementById('llm-models-list');
                if (modelContainer) {
                    modelContainer.classList.add('animate-pulse');
                    setTimeout(() => {
                        loadLLMModels();  // This will highlight the new recommended model
                        modelContainer.classList.remove('animate-pulse');
                    }, 300);
                }
                
                // Update model reason
                const modelWhyEl = document.getElementById('model-why-text');
                if (modelWhyEl && config.modelReason) {
                    modelWhyEl.textContent = config.modelReason;
                }
            }
            
            // 2. Store personality descriptions from API
            if (config.personalityDescriptions) {
                apiPersonalityDescriptions = config.personalityDescriptions;
            }
            
            // 3. Update Personality sliders with animation
            if (config.personality) {
                const slidersContainer = document.getElementById('personality-sliders');
                if (slidersContainer) {
                    slidersContainer.classList.add('animate-pulse');
                }
                
                // Update personality reason
                if (config.personalityReason) {
                    const previewEl = document.getElementById('personality-preview-text');
                    if (previewEl) {
                        previewEl.textContent = config.personalityReason;
                    }
                }
                
                setTimeout(() => {
                    // Apply each personality value
                    const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
                    traits.forEach((trait, index) => {
                        const value = config.personality[trait];
                        if (value !== undefined) {
                            // Animate slider update with slight delay for each
                            setTimeout(() => {
                                animateSliderTo(trait, value);
                                
                                // Update description from API
                                const desc = apiPersonalityDescriptions[trait + 'Desc'];
                                const descEl = document.getElementById(`p-${trait}-desc`);
                                if (desc && descEl) {
                                    descEl.textContent = desc;
                                }
                            }, index * 100);
                        }
                    });
                    
                    if (slidersContainer) {
                        slidersContainer.classList.remove('animate-pulse');
                    }
                }, 300);
                
                // Update wizard personality
                wizard.personality = { ...wizard.personality, ...config.personality };
            }
            
            // 3. Update Agent Name if provided
            if (config.name && !wizard.name) {
                const nameEl = document.getElementById('w-name');
                if (nameEl && !nameEl.value) {
                    nameEl.value = config.name;
                    wizard.name = config.name;
                }
            }
            
            // 4. Store suggested tasks for later
            if (config.tasks) {
                wizard.tasks = config.tasks;
            }
            
            // 5. Store guardrails recommendations
            if (config.guardrails) {
                wizard.guardrails = { ...wizard.guardrails, ...config.guardrails };
            }
            
            // 6. Store suggested tools
            if (config.suggestedTools) {
                wizard.suggestedTools = config.suggestedTools;
            }
            
            // Update preview text
            updatePersonalityPreview();
        }
        
        // Animate slider from current value to target value
        function animateSliderTo(trait, targetValue) {
            const slider = document.getElementById(`p-${trait}`);
            const numInput = document.getElementById(`p-${trait}-num`);
            
            if (!slider) return;
            
            const currentValue = parseInt(slider.value) || 5;
            const steps = Math.abs(targetValue - currentValue);
            const direction = targetValue > currentValue ? 1 : -1;
            
            if (steps === 0) return;
            
            let currentStep = 0;
            const interval = setInterval(() => {
                currentStep++;
                const newValue = currentValue + (direction * currentStep);
                
                slider.value = newValue;
                if (numInput) numInput.value = newValue;
                
                // Update description
                updatePersonalitySlider(trait, newValue);
                
                if (currentStep >= steps) {
                    clearInterval(interval);
                }
            }, 50);
        }
        
        // ============================================================================
        // NEW AI-POWERED WIZARD FUNCTIONS
        // ============================================================================
        
        function resetWizardNew() {
            step = 0;
            wizard = {
                name: '',
                icon: '',
                goal: '',
                originalGoal: '',
                personality: null,
                personalityReason: '',
                tasks: [],
                tool_ids: [],
                suggestedTools: [],
                guardrails: {},
                model: '',
                modelReason: '',
                editId: null,
                deployTarget: 'cloud',
                cloudProvider: ''
            };
            
            // Clear API descriptions
            apiPersonalityDescriptions = {};
            lastGoalText = '';
            
            // Reset UI
            document.getElementById('wizard-step-0')?.classList.remove('hidden');
            document.getElementById('wizard-generating')?.classList.add('hidden');
            document.getElementById('wizard-progress')?.classList.add('hidden');
            for(let i=1; i<=7; i++) {
                document.getElementById('wizard-step-'+i)?.classList.add('hidden');
            }
            document.getElementById('w-initial-goal').value = '';
        }
        
        function updateStepsNew() {
            console.log('=== updateStepsNew called, step:', step);
            
            // Show/hide step 0 vs other steps
            if(step === 0) {
                document.getElementById('wizard-step-0')?.classList.remove('hidden');
                document.getElementById('wizard-generating')?.classList.add('hidden');
                document.getElementById('wizard-progress')?.classList.add('hidden');
                for(let i=1; i<=7; i++) {
                    document.getElementById('wizard-step-'+i)?.classList.add('hidden');
                }
                return;
            }
            
            // Show progress bar for steps 1-7
            document.getElementById('wizard-step-0')?.classList.add('hidden');
            document.getElementById('wizard-generating')?.classList.add('hidden');
            document.getElementById('wizard-progress')?.classList.remove('hidden');
            
            // Update step indicators
            for(let i=1; i<=7; i++) {
                const el = document.getElementById('step-'+i);
                const content = document.getElementById('wizard-step-'+i);
                if(el) {
                    el.className = 'w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center cursor-pointer text-xs md:text-sm ' + 
                        (i < step ? 'step-done' : i === step ? 'step-active' : 'step-pending');
                }
                if(content) {
                    content.classList.toggle('hidden', i !== step);
                    console.log('Step', i, 'visibility:', i === step ? 'visible' : 'hidden');
                }
            }
            
            // Load step-specific content
            console.log('Loading content for step:', step);
            if(step === 1) {
                console.log('Loading LLM models');
                loadLLMModels();
                initPersonalitySliders();
            }
            if(step === 3) {
                console.log('Loading Demo Kit Tools for selection');
                loadDemoKitToolsForSelection();
            }
            if(step === 5) {
                console.log('Calling showPreviewNew');
                // Ensure tools are collected before preview
                collectToolsNew();
                showPreviewNew();
            }
            if(step === 6) {
                console.log('Calling prepareTestSuggestions');
                prepareTestSuggestions();
                // Reset test conversation when entering test step
                resetTestConversation();
            }
        }
        
        // Reset test conversation
        function resetTestConversation() {
            document.getElementById('test-messages').innerHTML = '';
            testAgent = null;
            testAttachments = [];
            renderTestAttachments();
            console.log('Test conversation reset');
        }
        
        function goStep(s) {
            if(s <= step && s >= 1) {
                step = s;
                updateStepsNew();
            }
        }
        
        function nextStep() {
            // Validate and collect data based on current step
            if(step === 1) {
                wizard.name = document.getElementById('w-name').value;
                wizard.icon = document.getElementById('w-icon').value || '';
                wizard.iconType = document.getElementById('w-icon-type')?.value || 'emoji';
                wizard.iconData = document.getElementById('w-icon-data')?.value || '';
                wizard.goal = document.getElementById('w-goal').value;
                
                // Collect personality slider values (must be set by AI generation)
                const creativity = parseInt(document.getElementById('p-creativity')?.value);
                const length = parseInt(document.getElementById('p-length')?.value);
                const formality = parseInt(document.getElementById('p-formality')?.value);
                const empathy = parseInt(document.getElementById('p-empathy')?.value);
                const proactivity = parseInt(document.getElementById('p-proactivity')?.value);
                const confidence = parseInt(document.getElementById('p-confidence')?.value);
                
                // Check if personality was configured
                if (!creativity || !length || !formality || !empathy || !proactivity || !confidence) {
                    alert('Personality not configured. Please generate agent configuration first.');
                    return;
                }
                
                wizard.personality = { creativity, length, formality, empathy, proactivity, confidence };
                
                if(!wizard.name || !wizard.goal) {
                    alert('Please fill in Name and Goal');
                    return;
                }
            }
            if(step === 2) collectTasksNew();
            if(step === 3) collectToolsNew();
            if(step === 4) collectGuardrails();
            
            step++;
            if(step > 7) step = 7;
            updateStepsNew();
        }
        
        function prevStep() {
            if(step > 1) {
                step--;
                updateStepsNew();
            }
        }
        
        // Agent Templates
        function useAgentTemplate(template) {
            const templates = {
                customer_support: "Help customers with their inquiries about orders, products, returns, and general support questions. Provide accurate information, track order status, and escalate complex issues when needed.",
                sales: "Assist potential customers in finding the right products, answer pricing questions, provide product comparisons, and help close sales. Be persuasive but honest.",
                hr: "Help employees with HR-related questions about policies, benefits, leave requests, and company procedures. Maintain confidentiality and direct sensitive matters to HR staff.",
                research: "Research topics thoroughly, analyze information from multiple sources, summarize findings, and provide well-structured reports with citations.",
                coding: "Help developers write, debug, and improve code. Explain programming concepts, suggest best practices, and assist with technical documentation."
            };
            
            document.getElementById('w-initial-goal').value = templates[template] || '';
        }
        
        // Generate Agent Configuration using AI
        async function generateAgentConfig() {
            const goal = document.getElementById('w-initial-goal').value.trim();
            if(!goal) {
                alert('Please describe what your agent should do');
                return;
            }
            
            wizard.originalGoal = goal;
            
            // Show generating animation
            document.getElementById('wizard-step-0').classList.add('hidden');
            document.getElementById('wizard-generating').classList.remove('hidden');
            
            // Animate steps
            const steps = ['gen-step-1', 'gen-step-2', 'gen-step-3', 'gen-step-4', 'gen-step-5'];
            const statuses = [
                'Understanding your requirements...',
                'Selecting optimal AI model...',
                'Defining tasks & capabilities...',
                'Recommending tools...',
                'Setting up guardrails...'
            ];
            
            for(let i=0; i<steps.length; i++) {
                await new Promise(r => setTimeout(r, 600));
                document.getElementById('generating-status').textContent = statuses[i];
                
                // Mark previous as done
                if(i > 0) {
                    const prev = document.getElementById(steps[i-1]);
                    prev.querySelector('span').className = 'w-5 h-5 rounded-full bg-green-500 flex items-center justify-center';
                    prev.querySelector('span').textContent = '';
                    prev.classList.remove('text-gray-500');
                }
                
                // Activate current
                const curr = document.getElementById(steps[i]);
                curr.querySelector('span').className = 'w-5 h-5 rounded-full bg-purple-500 flex items-center justify-center animate-pulse';
                curr.classList.remove('text-gray-500');
            }
            
            // Mark last as done
            await new Promise(r => setTimeout(r, 400));
            const last = document.getElementById(steps[steps.length-1]);
            last.querySelector('span').className = 'w-5 h-5 rounded-full bg-green-500 flex items-center justify-center';
            last.querySelector('span').textContent = '';
            
            try {
                // Call AI to generate configuration - 100% dynamic, no fallback
                const response = await fetch(API + '/api/agents/generate-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goal })
                });
                
                if(response.ok) {
                    const config = await response.json();
                    applyGeneratedConfig(config);
                } else {
                    // Show error - no local fallback
                    const error = await response.json().catch(() => ({}));
                    alert('Failed to generate agent configuration: ' + (error.detail || 'Please check your LLM settings.'));
                    document.getElementById('wizard-generating').classList.add('hidden');
                    document.getElementById('wizard-step-0').classList.remove('hidden');
                    return;
                }
            } catch(e) {
                console.error('Config generation error:', e);
                alert('Failed to connect to AI service. Please check your settings and try again.');
                document.getElementById('wizard-generating').classList.add('hidden');
                document.getElementById('wizard-step-0').classList.remove('hidden');
                return;
            }
            
            // Move to step 1
            await new Promise(r => setTimeout(r, 500));
            step = 1;
            updateStepsNew();
        }
        
        
        function applyGeneratedConfig(config) {
            console.log('=== applyGeneratedConfig called ===');
            console.log('Received config:', JSON.stringify(config, null, 2));
            
            // Set all wizard properties from API response (no defaults!)
            wizard.name = config.name;
            wizard.icon = config.icon;
            wizard.goal = config.goal;
            wizard.model = config.model;
            wizard.modelReason = config.modelReason;  // Store for display
            wizard.tasks = Array.isArray(config.tasks) ? config.tasks : [];
            wizard.suggestedTools = Array.isArray(config.suggestedTools) ? config.suggestedTools : [];
            wizard.personality = config.personality;
            wizard.guardrails = config.guardrails;
            
            // Store personality descriptions from API
            if (config.personalityDescriptions) {
                apiPersonalityDescriptions = config.personalityDescriptions;
            }
            
            // Store the goal for debounce comparison
            lastGoalText = wizard.goal;
            
            console.log('Wizard state after assignment:');
            console.log('- name:', wizard.name);
            console.log('- model:', wizard.model);
            console.log('- modelReason:', wizard.modelReason);
            console.log('- personality:', wizard.personality);
            
            // Apply to form elements
            const nameEl = document.getElementById('w-name');
            const iconEl = document.getElementById('w-icon');
            const goalEl = document.getElementById('w-goal');
            
            if(nameEl) nameEl.value = wizard.name || '';
            if(iconEl) iconEl.value = wizard.icon || '';
            if(goalEl) goalEl.value = wizard.goal || '';
            
            // Set personality sliders from API response
            if (config.personality) {
                const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
                traits.forEach(trait => {
                    const value = config.personality[trait];
                    if (value !== undefined) {
                        const slider = document.getElementById(`p-${trait}`);
                        const numInput = document.getElementById(`p-${trait}-num`);
                        if (slider) slider.value = value;
                        if (numInput) numInput.value = value;
                    }
                });
                
                // Show personality reason if provided
                if (config.personalityReason) {
                    const previewEl = document.getElementById('personality-preview-text');
                    if (previewEl) {
                        previewEl.textContent = config.personalityReason;
                    }
                }
                
                // Update individual trait descriptions
                if (config.personalityDescriptions) {
                    traits.forEach(trait => {
                        const desc = config.personalityDescriptions[trait + 'Desc'];
                        const descEl = document.getElementById(`p-${trait}-desc`);
                        if (desc && descEl) {
                            descEl.textContent = desc;
                        }
                    });
                }
            }
            
            // Update model selection UI
            selectModel(wizard.model);
            
            // Update model explanation from API
            const modelWhyEl = document.getElementById('model-why-text');
            if(modelWhyEl && config.modelReason) {
                modelWhyEl.textContent = config.modelReason;
            }
            
            // Render tasks
            renderTasks();
            
            console.log('applyGeneratedConfig complete');
        }
        
        // ========== ICON MANAGEMENT ==========
        
        function handleIconUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 500KB)
            if (file.size > 500 * 1024) {
                alert('Image too large. Maximum size is 500KB.');
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                
                // Update preview
                document.getElementById('w-icon-emoji').classList.add('hidden');
                const imgEl = document.getElementById('w-icon-image');
                imgEl.src = base64Data;
                imgEl.classList.remove('hidden');
                
                // Store data
                document.getElementById('w-icon-type').value = 'image';
                document.getElementById('w-icon-data').value = base64Data;
                document.getElementById('w-icon').value = ''; // Fallback
                
                wizard.icon = '';
                wizard.iconType = 'image';
                wizard.iconData = base64Data;
            };
            reader.readAsDataURL(file);
        }
        
        function showIconPicker() {
            // Populate emoji grid
            const emojis = ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''];
            const grid = document.getElementById('emoji-grid');
            if (grid) {
                grid.innerHTML = emojis.map(e => 
                    `<button onclick="selectEmoji('${e}')" class="w-8 h-8 text-lg hover:bg-gray-700 rounded transition">${e}</button>`
                ).join('');
            }
            document.getElementById('icon-picker-modal').classList.remove('hidden');
        }
        
        function closeIconPicker() {
            document.getElementById('icon-picker-modal').classList.add('hidden');
        }
        
        function selectEmoji(emoji) {
            // Update preview
            document.getElementById('w-icon-image').classList.add('hidden');
            const emojiEl = document.getElementById('w-icon-emoji');
            emojiEl.textContent = emoji;
            emojiEl.classList.remove('hidden');
            
            // Store data
            document.getElementById('w-icon-type').value = 'emoji';
            document.getElementById('w-icon-data').value = '';
            document.getElementById('w-icon').value = emoji;
            
            wizard.icon = emoji;
            wizard.iconType = 'emoji';
            wizard.iconData = '';
            
            closeIconPicker();
        }
        
        // ========== LLM MODEL MANAGEMENT - 100% DYNAMIC ==========
        // No hardcoded model config - everything comes from API
        
        async function loadLLMModels() {
            const container = document.getElementById('llm-models-list');
            if (!container) return;
            
            // Fetch current settings to get configured providers
            let settings = {};
            try {
                const r = await fetch(API + '/api/settings');
                const data = await r.json();
                settings = data.settings || data || {};
            } catch (e) {
                console.log('Could not fetch settings:', e);
            }
            
            const llmProviders = settings.llm_providers || [];
            
            if (llmProviders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6">
                        <span class="text-3xl"></span>
                        <p class="text-sm text-gray-400 mt-3">No AI models configured</p>
                        <p class="text-xs text-gray-500 mt-1">Add API keys in Settings to enable AI models</p>
                        <button onclick="navigate('settings')" class="mt-4 btn-primary px-4 py-2 rounded-lg text-sm">
                             Configure API Keys
                        </button>
                    </div>
                `;
                return;
            }
            
            // Build list of available models from configured providers
            const availableModels = [];
            for (const provider of llmProviders) {
                const providerModels = provider.models || [];
                for (const modelId of providerModels) {
                    availableModels.push({
                        id: modelId,
                        name: modelId,
                        provider: provider.provider,
                        providerName: provider.name
                    });
                }
            }
            
            // Check if wizard.model is available, if not use first available
            const currentModelAvailable = availableModels.some(m => m.id === wizard.model);
            if (!currentModelAvailable && availableModels.length > 0) {
                wizard.model = availableModels[0].id;
            }
            
            // Group models by provider
            const modelsByProvider = {};
            for (const model of availableModels) {
                const providerKey = model.providerName || model.provider;
                if (!modelsByProvider[providerKey]) {
                    modelsByProvider[providerKey] = [];
                }
                modelsByProvider[providerKey].push(model);
            }
            
            // Get provider icons
            const providerIcons = {
                'openai': '', 'OpenAI': '',
                'anthropic': '', 'Anthropic': '',
                'google': '', 'Google': '',
                'xai': '', 'xAI': '',
                'groq': '', 'Groq': '',
                'mistral': '', 'Mistral': '',
                'deepseek': '', 'DeepSeek': '',
                'together': '', 'Together AI': '',
                'perplexity': '', 'Perplexity': '',
                'cohere': '', 'Cohere': '',
                'ollama': '', 'Ollama': '',
                'lmstudio': '', 'LM Studio': ''
            };
            
            let html = '';
            
            // Show AI recommendation from API if available
            if (wizard.model && wizard.modelReason && wizard.goal) {
                html += `
                    <div class="mb-4 p-3 bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-purple-500/30 rounded-lg">
                        <div class="flex items-start gap-2">
                            <span class="text-lg"></span>
                            <div>
                                <p class="text-sm font-medium text-purple-300">AI Recommendation</p>
                                <p class="text-xs text-gray-400 mt-1">${wizard.modelReason}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Render models grouped by provider
            for (const [providerName, models] of Object.entries(modelsByProvider)) {
                const icon = providerIcons[providerName] || '';
                
                html += `
                    <div class="mb-3">
                        <p class="text-xs text-gray-500 mb-2 flex items-center gap-1">
                            <span>${icon}</span> ${providerName}
                        </p>
                        <div class="space-y-2">
                `;
                
                for (const model of models) {
                    const isSelected = model.id === wizard.model;
                    const isRecommended = model.id === wizard.model && wizard.goal;
                    
                    const recommendedBadge = isRecommended
                        ? `<span class="text-[10px] bg-purple-500/30 text-purple-300 px-1.5 py-0.5 rounded ml-1"> AI Selected</span>`
                        : '';
                    
                    html += `
                        <div class="p-2.5 rounded-lg cursor-pointer model-option transition-all ${isSelected ? 'border-2 border-purple-500 bg-purple-500/10' : 'border border-gray-700 hover:border-gray-500'}" 
                             data-model="${model.id}" onclick="selectModel('${model.id}')">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">${model.name}</span>
                                ${recommendedBadge}
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Update model explanation
            if (wizard.modelReason) {
                const modelWhyEl = document.getElementById('model-why-text');
                if (modelWhyEl) {
                    modelWhyEl.textContent = wizard.modelReason;
                }
            }
        }
        
        function selectModel(modelId) {
            wizard.model = modelId;
            
            // Update UI
            document.querySelectorAll('.model-option').forEach(el => {
                const isSelected = el.dataset.model === modelId;
                if (el.dataset.model) {
                    el.className = 'p-2.5 rounded-lg cursor-pointer model-option transition-all ' + 
                        (isSelected ? 'border-2 border-purple-500 bg-purple-500/10' : 'border border-gray-700 hover:border-gray-500');
                }
            });
            
            // Update explanation
            updateModelExplanation(modelId, wizard.goal);
        }
        
        function updateModelExplanation(modelId, goal) {
            const modelWhyEl = document.getElementById('model-why-text');
            if (!modelWhyEl) return;
            
            // Use the API-provided model reason (100% dynamic)
            if (wizard.modelReason) {
                modelWhyEl.textContent = wizard.modelReason;
            } else {
                // If no reason yet, show simple message
                modelWhyEl.textContent = `${modelId} selected for your agent.`;
            }
        }
        
        function renderTasks() {
            const container = document.getElementById('w-tasks');
            if(!container) return;
            
            const tasks = wizard.tasks || [];
            
            if(tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="text-4xl block mb-2"></span>
                        <p>No tasks defined. Click "+ Add Task" to create one.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tasks.map((task, idx) => `
                <div class="card rounded-lg p-4" id="task-${idx}" data-task-idx="${idx}">
                    <div class="flex gap-3">
                        <div class="flex-1 space-y-4">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <label class="text-xs text-gray-400 mb-1 block">Task Name *</label>
                                    <input type="text" class="task-name input-field w-full rounded px-3 py-2" value="${escHtml(task.name || '')}" oninput="autoSaveTask(${idx}, 'name', this.value)">
                                </div>
                                <button onclick="removeTask(${idx})" class="text-gray-500 hover:text-red-400 text-xl ml-2"></button>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Description</label>
                                <textarea class="task-desc input-field w-full rounded px-3 py-2 text-sm" rows="2" oninput="autoSaveTask(${idx}, 'description', this.value)">${escHtml(task.description || '')}</textarea>
                            </div>
                            <div class="bg-gray-800/50 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <span class="text-sm font-medium text-purple-400"> Instructions</span>
                                        <p class="text-xs text-gray-500">Step-by-step guide for the LLM</p>
                                    </div>
                                    <button onclick="addInstruction(${idx})" class="btn-secondary px-3 py-1 rounded text-xs">+ Add Step</button>
                                </div>
                                <div class="insts space-y-2" id="instructions-${idx}" ondragover="handleDragOver(event)" ondrop="handleInstructionDrop(event, ${idx})">
                                    ${(task.instructions || []).map((inst, instIdx) => `
                                        <div class="flex gap-2 items-start bg-gray-900/50 rounded p-2 instruction-item" draggable="true" data-task-idx="${idx}" data-inst-idx="${instIdx}" ondragstart="handleInstructionDragStart(event)" ondragend="handleDragEnd(event)">
                                            <span class="cursor-move text-gray-500 hover:text-gray-300 mr-1" title="Drag to reorder"></span>
                                            <span class="text-purple-400 text-xs font-bold mt-1">${instIdx + 1}.</span>
                                            <input type="text" class="inst-text input-field flex-1 rounded px-2 py-1 text-sm" value="${escHtml(inst)}" oninput="autoSaveInstruction(${idx}, ${instIdx}, this.value)">
                                            <button onclick="removeInstruction(${idx}, ${instIdx})" class="text-gray-500 hover:text-red-400 text-sm"></button>
                                        </div>
                                    `).join('')}
                                </div>
                                ${(task.instructions || []).length === 0 ? '<p class="text-xs text-gray-500 mt-2">No instructions. Click "+ Add Step".</p>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Auto-save task field
        function autoSaveTask(taskIdx, field, value) {
            if (wizard.tasks[taskIdx]) {
                wizard.tasks[taskIdx][field] = value;
            }
        }
        
        // Auto-save instruction
        function autoSaveInstruction(taskIdx, instIdx, value) {
            if (wizard.tasks[taskIdx] && wizard.tasks[taskIdx].instructions) {
                wizard.tasks[taskIdx].instructions[instIdx] = value;
            }
        }
        
        function addTask() {
            saveCurrentTaskEdits();  // Save current edits first
            wizard.tasks.push({ name: '', description: '', instructions: [] });
            renderTasks();
        }
        
        function removeTask(idx) {
            saveCurrentTaskEdits();  // Save current edits first
            wizard.tasks.splice(idx, 1);
            renderTasks();
        }
        
        function addInstruction(taskIdx) {
            saveCurrentTaskEdits();  // Save current edits first
            if(!wizard.tasks[taskIdx].instructions) wizard.tasks[taskIdx].instructions = [];
            wizard.tasks[taskIdx].instructions.push('');
            renderTasks();
            
            // Focus on the new instruction input
            setTimeout(() => {
                const taskEl = document.getElementById(`task-${taskIdx}`);
                if (taskEl) {
                    const inputs = taskEl.querySelectorAll('.inst-text');
                    if (inputs.length > 0) {
                        inputs[inputs.length - 1].focus();
                    }
                }
            }, 100);
        }
        
        // Drag & Drop for Instructions
        let draggedInstruction = null;
        
        function handleInstructionDragStart(e) {
            draggedInstruction = e.target.closest('.instruction-item');
            draggedInstruction.classList.add('opacity-50');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const container = e.target.closest('.insts');
            if (!container) return;
            
            const afterElement = getDragAfterElement(container, e.clientY);
            const dragging = document.querySelector('.instruction-item.opacity-50');
            if (dragging) {
                if (afterElement == null) {
                    container.appendChild(dragging);
                } else {
                    container.insertBefore(dragging, afterElement);
                }
            }
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.instruction-item:not(.opacity-50)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('opacity-50');
            draggedInstruction = null;
        }
        
        function handleInstructionDrop(e, taskIdx) {
            e.preventDefault();
            
            // Get new order from DOM
            const container = document.getElementById(`instructions-${taskIdx}`);
            const items = container.querySelectorAll('.instruction-item');
            const newInstructions = [];
            
            items.forEach(item => {
                const input = item.querySelector('.inst-text');
                if (input) {
                    newInstructions.push(input.value);
                }
            });
            
            // Update wizard data
            wizard.tasks[taskIdx].instructions = newInstructions;
            
            // Re-render to update numbers
            renderTasks();
        }

        function removeInstructionOriginal(taskIdx, instIdx) {
            saveCurrentTaskEdits();  // Save current edits first
            wizard.tasks[taskIdx].instructions.splice(instIdx, 1);
            renderTasks();
        }
        
        // Alias for backward compatibility
        function removeInstruction(taskIdx, instIdx) {
            removeInstructionOriginal(taskIdx, instIdx);
        }
        
        // Save current task edits from DOM to wizard.tasks
        function saveCurrentTaskEdits() {
            const taskElements = document.querySelectorAll('#w-tasks > div[id^="task-"]');
            
            taskElements.forEach((taskEl, idx) => {
                if (wizard.tasks[idx]) {
                    // Save task name
                    const nameInput = taskEl.querySelector('.task-name');
                    if (nameInput) wizard.tasks[idx].name = nameInput.value;
                    
                    // Save task description
                    const descInput = taskEl.querySelector('.task-desc');
                    if (descInput) wizard.tasks[idx].description = descInput.value;
                    
                    // Save instructions
                    const instInputs = taskEl.querySelectorAll('.inst-text');
                    wizard.tasks[idx].instructions = [];
                    instInputs.forEach(input => {
                        wizard.tasks[idx].instructions.push(input.value);
                    });
                }
            });
        }
        
        function collectTasksNew() {
            console.log('=== collectTasksNew called ===');
            const taskElements = document.querySelectorAll('#w-tasks > div[id^="task-"]');
            console.log('Found task elements:', taskElements.length);
            
            if(taskElements.length === 0) {
                // No task elements in DOM, keep existing tasks
                console.log('No task elements, keeping existing tasks:', wizard.tasks?.length || 0);
                return;
            }
            
            const tasks = [];
            taskElements.forEach((taskEl, idx) => {
                const name = taskEl.querySelector('.task-name')?.value || '';
                const desc = taskEl.querySelector('.task-desc')?.value || '';
                const insts = [];
                taskEl.querySelectorAll('.inst-text').forEach(i => {
                    if(i.value.trim()) insts.push(i.value.trim());
                });
                if(name) {
                    tasks.push({ name, description: desc, instructions: insts });
                    console.log('Collected task:', name);
                }
            });
            wizard.tasks = tasks;
            console.log('Total tasks collected:', tasks.length);
        }
        
        // Tools with business explanations
        // Base tool info - will be customized based on agent goal
        const baseToolInfo = {
            knowledge: { icon: '', name: 'Knowledge Base' },
            database: { icon: '', name: 'Database' },
            email: { icon: '', name: 'Email' },
            calendar: { icon: '', name: 'Calendar' },
            crm: { icon: '', name: 'CRM' },
            websearch: { icon: '', name: 'Web Search' },
            code: { icon: '', name: 'Code Execution' },
            slack: { icon: '', name: 'Messaging' }
        };
        
        // Generate dynamic tool info based on agent goal
        function getToolBusinessInfo(toolType) {
            const base = baseToolInfo[toolType] || { icon: '', name: toolType };
            const goal = (wizard.goal || wizard.originalGoal || '').toLowerCase();
            const agentName = wizard.name || 'Agent';
            
            // Dynamic descriptions based on goal context
            const contextualInfo = {
                knowledge: getKnowledgeInfo(goal, agentName),
                database: getDatabaseInfo(goal, agentName),
                email: getEmailInfo(goal, agentName),
                calendar: getCalendarInfo(goal, agentName),
                crm: getCrmInfo(goal, agentName),
                websearch: getWebSearchInfo(goal, agentName),
                code: getCodeInfo(goal, agentName),
                slack: getSlackInfo(goal, agentName)
            };
            
            return { ...base, ...contextualInfo[toolType] } || base;
        }
        
        function getKnowledgeInfo(goal, agentName) {
            if(goal.includes('customer') || goal.includes('support')) {
                return {
                    businessDesc: 'Access support documentation and FAQs',
                    examples: ['Support articles', 'Troubleshooting guides', 'Return policies', 'Product manuals'],
                    benefit: `${agentName} can answer customer questions using your support docs`
                };
            } else if(goal.includes('sales') || goal.includes('product')) {
                return {
                    businessDesc: 'Product information and sales materials',
                    examples: ['Product specs', 'Pricing sheets', 'Competitive analysis', 'Sales playbooks'],
                    benefit: `${agentName} can provide accurate product info to close deals`
                };
            } else if(goal.includes('hr') || goal.includes('employee')) {
                return {
                    businessDesc: 'HR policies and employee resources',
                    examples: ['Employee handbook', 'Benefits guide', 'Leave policies', 'Onboarding docs'],
                    benefit: `${agentName} can answer HR questions accurately`
                };
            } else if(goal.includes('research') || goal.includes('analysis')) {
                return {
                    businessDesc: 'Research documents and data sources',
                    examples: ['Research papers', 'Market reports', 'Data sets', 'Analysis templates'],
                    benefit: `${agentName} can reference existing research for better insights`
                };
            } else if(goal.includes('code') || goal.includes('developer')) {
                return {
                    businessDesc: 'Technical documentation and code references',
                    examples: ['API docs', 'Code standards', 'Architecture guides', 'Best practices'],
                    benefit: `${agentName} can provide consistent coding guidance`
                };
            }
            return {
                businessDesc: 'Your organization\'s documents and information',
                examples: ['Documentation', 'Guidelines', 'Procedures', 'Reference materials'],
                benefit: `${agentName} can answer questions using your content`
            };
        }
        
        function getDatabaseInfo(goal, agentName) {
            if(goal.includes('customer') || goal.includes('order')) {
                return {
                    businessDesc: 'Customer and order data access',
                    examples: ['Order status', 'Customer history', 'Shipping info', 'Payment records'],
                    benefit: `${agentName} can look up real-time order and customer info`
                };
            } else if(goal.includes('sales')) {
                return {
                    businessDesc: 'Sales and inventory data',
                    examples: ['Stock levels', 'Pricing', 'Discounts', 'Sales history'],
                    benefit: `${agentName} can check availability and pricing instantly`
                };
            } else if(goal.includes('hr') || goal.includes('employee')) {
                return {
                    businessDesc: 'Employee and HR records',
                    examples: ['Leave balances', 'Employee profiles', 'Attendance', 'Payroll info'],
                    benefit: `${agentName} can access employee data securely`
                };
            }
            return {
                businessDesc: 'Connect to your business databases',
                examples: ['Records lookup', 'Data queries', 'Status checks', 'History retrieval'],
                benefit: `${agentName} can fetch real-time data from your systems`
            };
        }
        
        function getEmailInfo(goal, agentName) {
            if(goal.includes('customer') || goal.includes('support')) {
                return {
                    businessDesc: 'Send support emails and confirmations',
                    examples: ['Ticket updates', 'Resolution confirmations', 'Follow-ups', 'Satisfaction surveys'],
                    benefit: `${agentName} can send timely support communications`
                };
            } else if(goal.includes('sales')) {
                return {
                    businessDesc: 'Sales outreach and follow-ups',
                    examples: ['Quote emails', 'Follow-up sequences', 'Meeting requests', 'Proposal delivery'],
                    benefit: `${agentName} can maintain sales momentum with timely emails`
                };
            } else if(goal.includes('hr')) {
                return {
                    businessDesc: 'HR communications and notifications',
                    examples: ['Policy updates', 'Leave approvals', 'Onboarding emails', 'Announcements'],
                    benefit: `${agentName} can handle routine HR communications`
                };
            }
            return {
                businessDesc: 'Automated email communications',
                examples: ['Notifications', 'Confirmations', 'Reports', 'Alerts'],
                benefit: `${agentName} can send emails automatically`
            };
        }
        
        function getCalendarInfo(goal, agentName) {
            if(goal.includes('sales') || goal.includes('meeting')) {
                return {
                    businessDesc: 'Schedule sales meetings and demos',
                    examples: ['Demo bookings', 'Follow-up calls', 'Team syncs', 'Client meetings'],
                    benefit: `${agentName} can book meetings without back-and-forth`
                };
            } else if(goal.includes('hr') || goal.includes('interview')) {
                return {
                    businessDesc: 'Manage interviews and HR appointments',
                    examples: ['Interview scheduling', '1:1 meetings', 'Training sessions', 'Reviews'],
                    benefit: `${agentName} can coordinate HR schedules efficiently`
                };
            }
            return {
                businessDesc: 'Schedule and manage appointments',
                examples: ['Meeting booking', 'Availability checks', 'Reminders', 'Rescheduling'],
                benefit: `${agentName} can manage calendar tasks automatically`
            };
        }
        
        function getCrmInfo(goal, agentName) {
            return {
                businessDesc: 'Customer relationship management',
                examples: ['Contact lookup', 'Deal tracking', 'Interaction history', 'Lead info'],
                benefit: `${agentName} can personalize interactions with CRM data`
            };
        }
        
        function getWebSearchInfo(goal, agentName) {
            if(goal.includes('research') || goal.includes('analysis')) {
                return {
                    businessDesc: 'Research current information online',
                    examples: ['Market data', 'News articles', 'Competitor info', 'Industry trends'],
                    benefit: `${agentName} can find up-to-date information for research`
                };
            }
            return {
                businessDesc: 'Search the web for current information',
                examples: ['Latest updates', 'External data', 'News', 'Public information'],
                benefit: `${agentName} can access current web information`
            };
        }
        
        function getCodeInfo(goal, agentName) {
            if(goal.includes('code') || goal.includes('developer') || goal.includes('programming')) {
                return {
                    businessDesc: 'Execute and test code',
                    examples: ['Code testing', 'Script execution', 'Debugging', 'Code generation'],
                    benefit: `${agentName} can run and validate code directly`
                };
            }
            return {
                businessDesc: 'Run calculations and scripts',
                examples: ['Data processing', 'Calculations', 'Transformations', 'Automation'],
                benefit: `${agentName} can perform complex computations`
            };
        }
        
        function getSlackInfo(goal, agentName) {
            return {
                businessDesc: 'Team notifications and alerts',
                examples: ['Escalations', 'Status updates', 'Alerts', 'Team notifications'],
                benefit: `${agentName} can notify your team when needed`
            };
        }
        
        // Simple object for backward compatibility
        function getAllToolBusinessInfo() {
            const result = {};
            Object.keys(baseToolInfo).forEach(key => {
                result[key] = getToolBusinessInfo(key);
            });
            return result;
        }
        
        // Selected tools for the agent - ALL types
        let selectedDemoTools = {
            apis: [],
            knowledge_bases: [],
            emails: [],
            webhooks: [],
            slacks: [],
            calendars: [],
            databases: [],
            websearches: [],
            websites: []
        };
        
        // Temporary selection in modal
        let tempToolSelection = {
            apis: [],
            knowledge_bases: [],
            emails: [],
            webhooks: [],
            slacks: [],
            calendars: [],
            databases: [],
            websearches: [],
            websites: []
        };
        
        // Flag to return to wizard after creating tool
        let returnToWizardAfterTool = false;
        
        // Auto-save agent data
        async function autoSaveAgent() {
            if (!wizard.editId) return; // Only auto-save if editing existing agent
            
            try {
                // Collect all current data
                collectToolsNew();
                collectGuardrails();
                
                const agentData = {
                    name: wizard.name || 'Untitled Agent',
                    icon: wizard.icon || '',
                    goal: wizard.goal || '',
                    tasks: wizard.tasks || [],
                    tool_ids: wizard.tool_ids || [],
                    guardrails: wizard.guardrails || {},
                    personality: wizard.personality || {},
                    model_id: wizard.model || 'gpt-4o',
                    status: 'draft'
                };
                
                await fetch(API + `/api/agents/${wizard.editId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(agentData)
                });
                
                console.log(' Agent auto-saved');
            } catch (e) {
                console.error('Auto-save failed:', e);
            }
        }
        
        // Debounced auto-save
        let autoSaveTimeout = null;
        function triggerAutoSave() {
            if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSaveAgent, 2000); // Save after 2 seconds of no changes
        }
        
        // Show select tool modal
        async function showSelectToolModal() {
            document.getElementById('select-tool-modal').classList.remove('hidden');
            document.getElementById('select-tool-modal').classList.add('flex');
            
            // Reset temp selection to current selection
            tempToolSelection = {
                apis: [...selectedDemoTools.apis],
                knowledge_bases: [...selectedDemoTools.knowledge_bases],
                emails: [...selectedDemoTools.emails],
                webhooks: [...selectedDemoTools.webhooks],
                slacks: [...selectedDemoTools.slacks],
                calendars: [...selectedDemoTools.calendars],
                databases: [...selectedDemoTools.databases],
                websearches: [...selectedDemoTools.websearches],
                websites: [...selectedDemoTools.websites]
            };
            
            await loadToolsForModal();
        }
        
        // Close select tool modal
        function closeSelectToolModal() {
            document.getElementById('select-tool-modal').classList.add('hidden');
            document.getElementById('select-tool-modal').classList.remove('flex');
        }
        
        // Load tools into modal
        async function loadToolsForModal() {
            const container = document.getElementById('available-tools-list');
            
            try {
                const response = await fetch(API + '/api/tools');
                const data = await response.json();
                const tools = data.tools || [];
                
                if (tools.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 bg-gray-800/30 rounded-xl">
                            <span class="text-4xl block mb-3"></span>
                            <p class="text-gray-400 mb-2">No tools available yet</p>
                            <p class="text-sm text-gray-500">Create tools in the Tools page or Demo Lab first</p>
                        </div>
                    `;
                    return;
                }
                
                // Group by type
                const apis = tools.filter(t => t.type === 'api');
                const kbs = tools.filter(t => t.type === 'knowledge' || t.type === 'document');
                const emails = tools.filter(t => t.type === 'email');
                const webhooks = tools.filter(t => t.type === 'webhook');
                const websearches = tools.filter(t => t.type === 'websearch');
                const slacks = tools.filter(t => t.type === 'slack');
                const calendars = tools.filter(t => t.type === 'calendar');
                const databases = tools.filter(t => t.type === 'database');
                const websites = tools.filter(t => t.type === 'website');
                
                let html = '';
                
                // Helper function to render tool section
                const renderToolSection = (toolList, icon, title, color, typeKey) => {
                    if (toolList.length === 0) return '';
                    
                    // Map typeKey to tempToolSelection array
                    const typeToArray = {
                        'api': 'apis',
                        'kb': 'knowledge_bases',
                        'email': 'emails',
                        'webhook': 'webhooks',
                        'slack': 'slacks',
                        'calendar': 'calendars',
                        'database': 'databases',
                        'websearch': 'websearches',
                        'website': 'websites'
                    };
                    const arrayKey = typeToArray[typeKey] || 'apis';
                    
                    let sectionHtml = `
                        <div class="mb-4">
                            <h5 class="text-sm font-medium text-${color}-400 mb-3 flex items-center gap-2">
                                <span>${icon}</span> ${title}
                                <span class="text-xs bg-${color}-500/20 px-2 py-0.5 rounded-full">${toolList.length}</span>
                            </h5>
                            <div class="space-y-2">
                    `;
                    
                    for (const tool of toolList) {
                        const isSelected = (tempToolSelection[arrayKey] || []).some(t => t.id === tool.id);
                        sectionHtml += `
                            <div class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors ${isSelected ? 'bg-' + color + '-500/20 border border-' + color + '-500/50' : 'bg-gray-800/50 hover:bg-gray-800 border border-transparent'}"
                                 onclick="toggleModalToolSelection('${typeKey}', '${tool.id}', this, '${color}')" data-tool-id="${tool.id}">
                                <input type="checkbox" class="w-4 h-4 rounded" ${isSelected ? 'checked' : ''}>
                                <span class="text-xl">${icon}</span>
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-sm truncate">${escHtml(tool.name)}</p>
                                    <p class="text-xs text-gray-500 truncate">${escHtml(tool.description || 'No description')}</p>
                                </div>
                                ${tool.config?.source === 'demo_kit' ? '<span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded">Demo</span>' : ''}
                            </div>
                        `;
                    }
                    
                    sectionHtml += `</div></div>`;
                    return sectionHtml;
                };
                
                // APIs
                html += renderToolSection(apis, '', 'APIs', 'purple', 'api');
                
                // Knowledge Bases
                html += renderToolSection(kbs, '', 'Knowledge Bases', 'blue', 'kb');
                
                // Email
                html += renderToolSection(emails, '', 'Email', 'green', 'email');
                
                // Webhooks
                html += renderToolSection(webhooks, '', 'Webhooks', 'yellow', 'webhook');
                
                // Web Search
                html += renderToolSection(websearches, '', 'Web Search', 'cyan', 'websearch');
                
                // Slack
                html += renderToolSection(slacks, '', 'Slack', 'pink', 'slack');
                
                // Calendar
                html += renderToolSection(calendars, '', 'Calendar', 'orange', 'calendar');
                
                // Database
                html += renderToolSection(databases, '', 'Database', 'indigo', 'database');
                
                // Websites
                html += renderToolSection(websites, '', 'Websites', 'teal', 'website');
                
                container.innerHTML = html;
                
                // Store tool data for reference
                container._toolsData = tools;
                
            } catch (e) {
                console.error('Failed to load tools:', e);
                container.innerHTML = `
                    <div class="text-center py-6 text-red-400">
                        <p>Failed to load tools</p>
                        <button onclick="loadToolsForModal()" class="text-sm text-purple-400 mt-2">Retry</button>
                    </div>
                `;
            }
        }
        
        // Toggle tool selection in modal
        function toggleModalToolSelection(type, toolId, element, color = 'purple') {
            const container = document.getElementById('available-tools-list');
            const toolsData = container._toolsData || [];
            const toolData = toolsData.find(t => t.id === toolId);
            const checkbox = element.querySelector('input[type="checkbox"]');
            
            // Map type to correct array
            const typeToArray = {
                'api': 'apis',
                'kb': 'knowledge_bases',
                'email': 'emails',
                'webhook': 'webhooks',
                'slack': 'slacks',
                'calendar': 'calendars',
                'database': 'databases',
                'websearch': 'websearches',
                'website': 'websites'
            };
            const arrayKey = typeToArray[type] || 'apis';
            const targetArray = tempToolSelection[arrayKey];
            
            if (!targetArray) {
                console.error('Unknown tool type:', type);
                return;
            }
            
            const idx = targetArray.findIndex(t => t.id === toolId);
            if (idx >= 0) {
                // Remove
                targetArray.splice(idx, 1);
                element.className = element.className.replace(/bg-\w+-500\/20/g, 'bg-gray-800/50');
                element.className = element.className.replace(/border-\w+-500\/50/g, 'border-transparent');
                if (checkbox) checkbox.checked = false;
            } else if (toolData) {
                // Add
                targetArray.push(toolData);
                element.classList.remove('bg-gray-800/50', 'border-transparent');
                element.classList.add(`bg-${color}-500/20`, `border-${color}-500/50`);
                if (checkbox) checkbox.checked = true;
            }
        }
        
        // Confirm tool selection
        function confirmToolSelection() {
            selectedDemoTools = {
                apis: [...tempToolSelection.apis],
                knowledge_bases: [...tempToolSelection.knowledge_bases],
                emails: [...tempToolSelection.emails],
                webhooks: [...tempToolSelection.webhooks],
                slacks: [...tempToolSelection.slacks],
                calendars: [...tempToolSelection.calendars],
                databases: [...tempToolSelection.databases],
                websearches: [...tempToolSelection.websearches],
                websites: [...tempToolSelection.websites]
            };
            closeSelectToolModal();
            updateSelectedToolsList();
            
            // Update wizard.tool_ids immediately
            syncToolsToWizard();
            
            // Trigger auto-save
            triggerAutoSave();
        }
        
        // Sync selectedDemoTools to wizard.tool_ids
        function syncToolsToWizard() {
            wizard.tool_ids = [];
            
            console.log(' syncToolsToWizard called');
            console.log('   selectedDemoTools:', JSON.stringify(selectedDemoTools, null, 2));
            
            // Add all tool types with their actual IDs (no prefix for non-demo tools)
            const addTools = (tools, prefix = '', typeName = '') => {
                console.log(`   Processing ${typeName}: ${tools.length} tools`);
                tools.forEach(tool => {
                    const isDemoKit = tool.config?.source === 'demo_kit' || tool.id.startsWith('kit_');
                    const toolId = isDemoKit ? `${prefix}${tool.id}` : tool.id;
                    console.log(`      Tool: ${tool.name} (${tool.id}) -> ${toolId} (isDemoKit: ${isDemoKit})`);
                    if (!wizard.tool_ids.includes(toolId)) {
                        wizard.tool_ids.push(toolId);
                    }
                });
            };
            
            addTools(selectedDemoTools.apis, 'api:', 'APIs');
            addTools(selectedDemoTools.knowledge_bases, 'kb:', 'KnowledgeBases');
            addTools(selectedDemoTools.emails, '', 'Emails');
            addTools(selectedDemoTools.webhooks, '', 'Webhooks');
            addTools(selectedDemoTools.slacks, '', 'Slacks');
            addTools(selectedDemoTools.calendars, '', 'Calendars');
            addTools(selectedDemoTools.databases, '', 'Databases');
            addTools(selectedDemoTools.websearches, '', 'WebSearches');
            addTools(selectedDemoTools.websites, '', 'Websites');
            
            console.log(' Final wizard.tool_ids:', wizard.tool_ids);
        }
        
        // Go to configure new tool
        function goToConfigureNewTool() {
            returnToWizardAfterTool = true;
            showPage('tools');
            // Show create tool modal
            setTimeout(() => showToolModal(), 300);
        }
        
        // Update the selected tools list display
        function updateSelectedToolsList() {
            const container = document.getElementById('w-tools-list');
            const countEl = document.getElementById('selected-tools-count');
            
            // Count all tool types
            const totalCount = 
                selectedDemoTools.apis.length + 
                selectedDemoTools.knowledge_bases.length +
                selectedDemoTools.emails.length +
                selectedDemoTools.webhooks.length +
                selectedDemoTools.slacks.length +
                selectedDemoTools.calendars.length +
                selectedDemoTools.databases.length +
                selectedDemoTools.websearches.length +
                selectedDemoTools.websites.length;
            
            if (countEl) countEl.textContent = totalCount;
            
            if (!container) return;
            
            if (totalCount === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-gray-500 text-sm">
                        <span class="text-2xl block mb-2"></span>
                        No tools selected yet<br>
                        <span class="text-xs">Click one of the options above to add tools</span>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Helper to render tool items
            const renderToolItems = (tools, icon, label, colorClass, typeKey) => {
                tools.forEach(tool => {
                    html += `
                        <div class="flex items-center gap-3 p-3 rounded-lg ${colorClass}">
                            <span class="text-xl">${icon}</span>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-sm">${escHtml(tool.name)}</p>
                                <p class="text-xs text-gray-500">${label}</p>
                            </div>
                            <button onclick="removeSelectedTool('${typeKey}', '${tool.id}')" class="text-gray-500 hover:text-red-400 p-1"></button>
                        </div>
                    `;
                });
            };
            
            renderToolItems(selectedDemoTools.apis, '', 'API', 'bg-purple-500/10 border border-purple-500/30', 'api');
            renderToolItems(selectedDemoTools.knowledge_bases, '', 'Knowledge Base', 'bg-blue-500/10 border border-blue-500/30', 'kb');
            renderToolItems(selectedDemoTools.emails, '', 'Email', 'bg-green-500/10 border border-green-500/30', 'email');
            renderToolItems(selectedDemoTools.webhooks, '', 'Webhook', 'bg-yellow-500/10 border border-yellow-500/30', 'webhook');
            renderToolItems(selectedDemoTools.slacks, '', 'Slack', 'bg-pink-500/10 border border-pink-500/30', 'slack');
            renderToolItems(selectedDemoTools.calendars, '', 'Calendar', 'bg-orange-500/10 border border-orange-500/30', 'calendar');
            renderToolItems(selectedDemoTools.databases, '', 'Database', 'bg-indigo-500/10 border border-indigo-500/30', 'database');
            renderToolItems(selectedDemoTools.websearches, '', 'Web Search', 'bg-cyan-500/10 border border-cyan-500/30', 'websearch');
            renderToolItems(selectedDemoTools.websites, '', 'Website', 'bg-teal-500/10 border border-teal-500/30', 'website');
            
            container.innerHTML = html;
        }
        
        // Remove a selected tool
        function removeSelectedTool(type, toolId) {
            const typeToArray = {
                'api': 'apis',
                'kb': 'knowledge_bases',
                'email': 'emails',
                'webhook': 'webhooks',
                'slack': 'slacks',
                'calendar': 'calendars',
                'database': 'databases',
                'websearch': 'websearches',
                'website': 'websites'
            };
            const arrayKey = typeToArray[type];
            if (arrayKey && selectedDemoTools[arrayKey]) {
                selectedDemoTools[arrayKey] = selectedDemoTools[arrayKey].filter(t => t.id !== toolId);
            }
            updateSelectedToolsList();
            syncToolsToWizard();
            triggerAutoSave();
        }
        
        // Load available tools for selection in Step 3 (compatibility)
        async function loadDemoKitToolsForSelection() {
            updateSelectedToolsList();
        }
        
        function loadWizardToolsNew() {
            console.log('=== loadWizardToolsNew called ===');
            console.log('wizard.suggestedTools:', JSON.stringify(wizard.suggestedTools));
            console.log('wizard.tool_ids (existing):', JSON.stringify(wizard.tool_ids));
            
            const suggestedContainer = document.getElementById('w-tools-suggested');
            const allContainer = document.getElementById('w-tools-list');
            
            if(!suggestedContainer) {
                console.error('w-tools-suggested container not found!');
                return;
            }
            
            const suggestedTools = wizard.suggestedTools || [];
            const existingToolIds = wizard.tool_ids || [];
            
            // Check if we already have tools selected (from Demo Kit, edit mode, or manual selection)
            const hasExistingTools = existingToolIds.length > 0 || 
                selectedDemoTools.apis.length > 0 || 
                selectedDemoTools.knowledge_bases.length > 0 ||
                selectedDemoTools.emails.length > 0 ||
                selectedDemoTools.webhooks.length > 0;
            const isEditMode = wizard.editId && existingToolIds.length > 0;
            
            console.log('isEditMode:', isEditMode, 'hasExistingTools:', hasExistingTools, 'existingToolIds:', existingToolIds);
            
            // Render suggested tools based on AI recommendation
            if(suggestedTools.length > 0) {
                let html = '';
                suggestedTools.forEach(toolType => {
                    console.log('Processing tool:', toolType);
                    const info = getToolBusinessInfo(toolType);
                    if(!info || !info.name) {
                        console.warn('No info for tool type:', toolType);
                        return;
                    }
                    // Check if this tool is already selected (for edit mode)
                    const isSelected = existingToolIds.includes(toolType);
                    html += `
                        <div class="card rounded-lg p-4 border-2 ${isSelected ? 'border-purple-500/50 bg-purple-500/5' : 'border-gray-700'} cursor-pointer tool-item" 
                             data-tool-type="${toolType}" onclick="toggleToolSelection(this, '${toolType}'); showToolDetail('${toolType}');">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center text-xl flex-shrink-0">
                                    ${info.icon}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between gap-2">
                                        <h5 class="font-medium">${info.name}</h5>
                                        <span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded flex-shrink-0">Recommended</span>
                                    </div>
                                    <p class="text-sm text-gray-400 mt-1">${info.businessDesc}</p>
                                    <p class="text-xs text-gray-500 mt-2">${info.benefit}</p>
                                </div>
                                <input type="checkbox" class="w-5 h-5 rounded flex-shrink-0" ${isSelected ? 'checked' : ''}>
                            </div>
                        </div>
                    `;
                });
                
                if(html) {
                    suggestedContainer.innerHTML = html;
                    // Only initialize tool_ids with suggested tools if NO existing tools (preserve Demo Kit and manual selections)
                    if(!isEditMode && !hasExistingTools) {
                        wizard.tool_ids = [...suggestedTools];
                    }
                    console.log('Rendered suggested tools, tool_ids:', wizard.tool_ids);
                } else {
                    suggestedContainer.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <p class="text-sm">No specific tools recommended. Select from available tools below.</p>
                        </div>
                    `;
                }
            } else {
                console.log('No suggested tools, showing default message');
                suggestedContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <p class="text-sm">No specific tools recommended. Select from available tools below.</p>
                    </div>
                `;
            }
            
            // Also load all available tools from the system
            loadAvailableToolTypes();
        }
        
        function loadAvailableToolTypes() {
            const allContainer = document.getElementById('w-tools-list');
            if(!allContainer) return;
            
            // Show all tool types that are not already suggested
            const allToolTypes = Object.keys(baseToolInfo);
            const notSuggested = allToolTypes.filter(t => !(wizard.suggestedTools || []).includes(t));
            
            let html = '';
            
            // Add abstract tool types
            if(notSuggested.length > 0) {
                html += notSuggested.map(toolType => {
                    const info = getToolBusinessInfo(toolType);
                    return `
                        <div class="card rounded-lg p-4 border border-gray-700 hover:border-gray-500 cursor-pointer tool-item" 
                             data-tool-type="${toolType}" onclick="toggleToolSelection(this, '${toolType}'); showToolDetail('${toolType}');">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-lg bg-gray-700 flex items-center justify-center text-xl flex-shrink-0">
                                    ${info.icon}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h5 class="font-medium">${info.name}</h5>
                                    <p class="text-sm text-gray-400 mt-1">${info.businessDesc}</p>
                                </div>
                                <input type="checkbox" class="w-5 h-5 rounded flex-shrink-0">
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Also load actual tools from the system
            loadSystemTools(allContainer, html);
        }
        
        async function loadSystemTools(container, existingHtml) {
            try {
                const r = await fetch(API + '/api/tools');
                const d = await r.json();
                const systemTools = d.tools || [];
                
                if(systemTools.length > 0) {
                    const icons = {document:'', website:'', api:'', knowledge:''};
                    const toolsHtml = systemTools.map(t => `
                        <div class="card rounded-lg p-4 border border-gray-700 hover:border-gray-500 cursor-pointer tool-item" 
                             data-tool-id="${t.id}" onclick="toggleSystemTool(this, '${t.id}');">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-xl flex-shrink-0">
                                    ${icons[t.type] || ''}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <h5 class="font-medium">${escHtml(t.name)}</h5>
                                        <span class="text-xs bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded">${t.type}</span>
                                    </div>
                                    <p class="text-sm text-gray-400 mt-1">${t.documents?.length || 0} documents</p>
                                </div>
                                <input type="checkbox" class="w-5 h-5 rounded flex-shrink-0" ${wizard.tool_ids?.includes(t.id) ? 'checked' : ''}>
                            </div>
                        </div>
                    `).join('');
                    
                    if(existingHtml) {
                        container.innerHTML = existingHtml + `
                            <div class="col-span-full mt-4 pt-4 border-t border-gray-700">
                                <h5 class="text-sm font-medium text-gray-400 mb-3"> Your Knowledge Bases</h5>
                            </div>
                        ` + toolsHtml;
                    } else {
                        container.innerHTML = toolsHtml;
                    }
                } else if(existingHtml) {
                    container.innerHTML = existingHtml;
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No tools available</p>';
                }
            } catch(e) {
                console.error('Error loading system tools:', e);
                if(existingHtml) {
                    container.innerHTML = existingHtml;
                }
            }
        }
        
        function toggleSystemTool(el, toolId) {
            const checkbox = el.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if(checkbox.checked) {
                el.classList.add('border-purple-500/50', 'bg-purple-500/5');
                el.classList.remove('border-gray-700');
                if(!wizard.tool_ids.includes(toolId)) {
                    wizard.tool_ids.push(toolId);
                }
            } else {
                el.classList.remove('border-purple-500/50', 'bg-purple-500/5');
                el.classList.add('border-gray-700');
                wizard.tool_ids = wizard.tool_ids.filter(id => id !== toolId);
            }
        }
        
        function showToolDetail(toolType) {
            const info = getToolBusinessInfo(toolType);
            const sidebar = document.getElementById('tool-detail-sidebar');
            if(!info || !sidebar) return;
            
            sidebar.innerHTML = `
                <div class="text-center mb-4">
                    <div class="w-16 h-16 mx-auto rounded-xl bg-purple-500/20 flex items-center justify-center text-3xl mb-3">
                        ${info.icon}
                    </div>
                    <h4 class="font-semibold">${info.name}</h4>
                    <p class="text-sm text-gray-400 mt-1">${info.businessDesc}</p>
                </div>
                
                <div class="mb-4">
                    <h5 class="text-xs font-medium text-gray-400 uppercase mb-2">What it does</h5>
                    <p class="text-sm">${info.benefit}</p>
                </div>
                
                <div>
                    <h5 class="text-xs font-medium text-gray-400 uppercase mb-2">Examples</h5>
                    <ul class="space-y-2">
                        ${(info.examples || []).map(ex => `
                            <li class="flex items-center gap-2 text-sm">
                                <span class="text-green-400"></span>
                                <span>${ex}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }
        
        function toggleToolSelection(el, toolType) {
            const checkbox = el.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if(checkbox.checked) {
                el.classList.add('border-purple-500/50', 'bg-purple-500/5');
                el.classList.remove('border-gray-700');
            } else {
                el.classList.remove('border-purple-500/50', 'bg-purple-500/5');
                el.classList.add('border-gray-700');
            }
            
            showToolDetail(toolType);
        }
        
        function collectToolsNew() {
            // Use syncToolsToWizard for consistent tool ID handling
            syncToolsToWizard();
            
            // Store references for demo tools
            wizard.demo_apis = selectedDemoTools.apis || [];
            wizard.demo_knowledge_bases = selectedDemoTools.knowledge_bases || [];
            
            // Also check for any custom tools from suggested tools UI
            document.querySelectorAll('.tool-item input[type="checkbox"]:checked').forEach(cb => {
                const toolItem = cb.closest('.tool-item');
                const toolId = toolItem?.dataset?.toolId || toolItem?.dataset?.toolType;
                if(toolId && !wizard.tool_ids.includes(toolId)) {
                    wizard.tool_ids.push(toolId);
                }
            });
            
            console.log(' collectToolsNew - Final tool_ids:', wizard.tool_ids);
        }
        
        function collectGuardrails() {
            wizard.guardrails = {
                antiHallucination: document.getElementById('guard-anti-hallucination')?.checked ?? true,
                citeSources: document.getElementById('guard-cite-sources')?.checked ?? true,
                admitUncertainty: document.getElementById('guard-admit-uncertainty')?.checked ?? true,
                verifyFacts: document.getElementById('guard-verify-facts')?.checked ?? true,
                noSpeculation: document.getElementById('guard-no-speculation')?.checked ?? false,
                avoidTopics: document.getElementById('guard-avoid-topics')?.value || '',
                focusTopics: document.getElementById('guard-focus-topics')?.value || '',
                maxLength: document.getElementById('guard-max-length')?.value || 'medium',
                language: document.getElementById('guard-language')?.value || 'user',
                escalateAngry: document.getElementById('guard-escalate-angry')?.checked ?? true,
                escalateComplex: document.getElementById('guard-escalate-complex')?.checked ?? true,
                escalateRequest: document.getElementById('guard-escalate-request')?.checked ?? true,
                escalateSensitive: document.getElementById('guard-escalate-sensitive')?.checked ?? false,
                piiProtection: document.getElementById('guard-pii-protection')?.checked ?? true,
                maskPii: document.getElementById('guard-mask-pii')?.checked ?? true,
                noStorePii: document.getElementById('guard-no-store-pii')?.checked ?? true
            };
        }
        
        function loadGuardrailsToForm() {
            const g = wizard.guardrails || {};
            
            const setChecked = (id, value, defaultVal = true) => {
                const el = document.getElementById(id);
                if(el) el.checked = value ?? defaultVal;
            };
            
            const setValue = (id, value, defaultVal = '') => {
                const el = document.getElementById(id);
                if(el) el.value = value ?? defaultVal;
            };
            
            setChecked('guard-anti-hallucination', g.antiHallucination, true);
            setChecked('guard-cite-sources', g.citeSources, true);
            setChecked('guard-admit-uncertainty', g.admitUncertainty, true);
            setChecked('guard-verify-facts', g.verifyFacts, true);
            setChecked('guard-no-speculation', g.noSpeculation, false);
            setValue('guard-avoid-topics', g.avoidTopics, '');
            setValue('guard-focus-topics', g.focusTopics, '');
            setValue('guard-max-length', g.maxLength, 'medium');
            setValue('guard-language', g.language, 'user');
            setChecked('guard-escalate-angry', g.escalateAngry, true);
            setChecked('guard-escalate-complex', g.escalateComplex, true);
            setChecked('guard-escalate-request', g.escalateRequest, true);
            setChecked('guard-escalate-sensitive', g.escalateSensitive, false);
            setChecked('guard-pii-protection', g.piiProtection, true);
            setChecked('guard-mask-pii', g.maskPii, true);
            setChecked('guard-no-store-pii', g.noStorePii, true);
        }
        
        async function showPreviewNew() {
            console.log('=== showPreviewNew called ===');
            
            const preview = document.getElementById('w-preview');
            if(!preview) {
                console.error('Preview container #w-preview not found');
                return;
            }
            
            // Use wizard state (populated by AI generation)
            if (!wizard.name || !wizard.goal || !wizard.personality) {
                console.error('Agent not fully configured. Please generate configuration first.');
                return;
            }
            
            // Collect guardrails from form
            collectGuardrails();
            
            // Load tools from API if not loaded
            if (allTools.length === 0) {
                try {
                    const toolsResponse = await fetch(API + '/api/tools');
                    const toolsData = await toolsResponse.json();
                    allTools = toolsData.tools || [];
                    console.log('Loaded tools for preview:', allTools.length);
                } catch(e) {
                    console.error('Error loading tools:', e);
                }
            }
            
            // Debug
            console.log('Preview state:', JSON.stringify({
                name: wizard.name,
                icon: wizard.icon,
                goal: (wizard.goal || '').substring(0, 50),
                tasksCount: (wizard.tasks || []).length,
                toolsCount: (wizard.tool_ids || []).length,
                allToolsCount: allTools.length
            }));
            
            // Safe access to arrays
            const tasks = Array.isArray(wizard.tasks) ? wizard.tasks : [];
            const toolIds = Array.isArray(wizard.tool_ids) ? wizard.tool_ids : [];
            const guardrails = wizard.guardrails || {};
            
            // Safe HTML escape
            const esc = (text) => {
                if(text === null || text === undefined) return '';
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            };
            
            // Build tasks HTML with instructions
            let tasksHtml = '';
            if(tasks.length > 0) {
                tasks.forEach(task => {
                    if(!task) return;
                    const insts = Array.isArray(task.instructions) ? task.instructions : [];
                    let instsHtml = '';
                    if (insts.length > 0) {
                        instsHtml = `
                            <div class="mt-2 space-y-1">
                                ${insts.map((inst, i) => `
                                    <div class="flex gap-2 text-xs text-gray-400">
                                        <span class="text-purple-400">${i + 1}.</span>
                                        <span>${esc(inst)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    tasksHtml += `
                        <div class="bg-gray-800/50 rounded-lg p-3">
                            <div class="font-medium text-sm">${esc(task.name || 'Unnamed Task')}</div>
                            <p class="text-xs text-gray-400 mt-1">${esc(task.description || '')}</p>
                            ${instsHtml}
                        </div>
                    `;
                });
            } else {
                tasksHtml = '<p class="text-gray-500 text-sm">No tasks defined</p>';
            }
            
            // Build tools HTML - fetch fresh from API to ensure names are shown
            let toolsHtml = '';
            
            // Debug
            console.log('=== Tools Debug ===');
            console.log('toolIds:', toolIds);
            
            if (toolIds.length > 0) {
                // Fetch tools from API and match by ID
                try {
                    const response = await fetch(API + '/api/tools');
                    const data = await response.json();
                    const allToolsFromApi = data.tools || [];
                    
                    console.log('Fetched tools:', allToolsFromApi.length);
                    console.log('Tool IDs to match:', toolIds);
                    
                    toolsHtml = toolIds.map(toolId => {
                        // Remove prefix (api: or kb:) for matching
                        const searchId = toolId.includes(':') ? toolId.split(':')[1] : toolId;
                        const tool = allToolsFromApi.find(t => t.id === searchId);
                        console.log('Matching:', toolId, ' searchId:', searchId, '', tool?.name || 'NOT FOUND');
                        
                        const icon = (tool?.type === 'api' || toolId.includes('api')) ? '' : '';
                        const name = tool?.name || 'Tool';
                        const colorClass = (tool?.type === 'api' || toolId.includes('api'))
                            ? 'bg-blue-900/30 border border-blue-500/30' 
                            : 'bg-purple-900/30 border border-purple-500/30';
                        
                        return `<span class="px-3 py-1.5 ${colorClass} rounded-lg text-sm">${icon} ${esc(name)}</span>`;
                    }).join('');
                } catch(e) {
                    console.error('Error fetching tools:', e);
                    toolsHtml = '<span class="text-gray-500 text-sm">Error loading tools</span>';
                }
            } else if (wizard.generatedTools && wizard.generatedTools.length > 0) {
                // Use generated tools if available
                toolsHtml = wizard.generatedTools.map(tool => {
                    const icon = tool.type === 'api' ? '' : '';
                    const colorClass = tool.type === 'api'
                        ? 'bg-blue-900/30 border border-blue-500/30' 
                        : 'bg-purple-900/30 border border-purple-500/30';
                    return `<span class="px-3 py-1.5 ${colorClass} rounded-lg text-sm">${icon} ${esc(tool.name)}</span>`;
                }).join('');
            } else {
                toolsHtml = '<span class="text-gray-500 text-sm">No tools selected</span>';
            }
            
            // Update toolIds count for display
            const toolsCount = wizard.generatedTools?.length || toolIds.length || 0;
            
            // Build guardrails HTML
            const hasGuardrails = guardrails.antiHallucination || guardrails.citeSources || 
                                 guardrails.piiProtection || guardrails.escalateComplex ||
                                 guardrails.escalateAngry || guardrails.escalateRequest;
            
            let guardrailsHtml = '';
            if(guardrails.antiHallucination) guardrailsHtml += '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded"> Anti-Hallucination</span>';
            if(guardrails.citeSources) guardrailsHtml += '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded"> Cite Sources</span>';
            if(guardrails.piiProtection) guardrailsHtml += '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded"> PII Protection</span>';
            if(guardrails.escalateComplex) guardrailsHtml += '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded"> Smart Escalation</span>';
            if(guardrails.escalateAngry) guardrailsHtml += '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded"> Anger Detection</span>';
            if(guardrails.admitUncertainty) guardrailsHtml += '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded"> Admit Uncertainty</span>';
            if(!hasGuardrails) guardrailsHtml = '<span class="text-gray-500">No guardrails configured</span>';
            
            // Set the HTML
            preview.innerHTML = `
                <!-- Agent Identity -->
                <div class="card rounded-xl p-4">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-3xl">
                            ${wizard.icon || ''}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">${esc(wizard.name)}</h3>
                            <p class="text-sm text-gray-400">
                                Model: ${wizard.model}
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Personality Summary -->
                <div class="card rounded-xl p-4">
                    <h4 class="font-medium mb-2 flex items-center gap-2">
                        <span></span> Personality
                    </h4>
                    <p class="text-sm text-gray-300">${wizard.personalityReason || 'AI-configured personality'}</p>
                    <div class="grid grid-cols-3 gap-2 mt-3 text-xs text-gray-400">
                        <div>Creativity: ${wizard.personality?.creativity || '-'}/10</div>
                        <div>Length: ${wizard.personality?.length || '-'}/10</div>
                        <div>Formality: ${wizard.personality?.formality || '-'}/10</div>
                        <div>Empathy: ${wizard.personality?.empathy || '-'}/10</div>
                        <div>Proactivity: ${wizard.personality?.proactivity || '-'}/10</div>
                        <div>Confidence: ${wizard.personality?.confidence || '-'}/10</div>
                    </div>
                </div>
                
                <!-- Goal -->
                <div class="card rounded-xl p-4">
                    <h4 class="font-medium mb-2 flex items-center gap-2">
                        <span></span> Goal
                    </h4>
                    <p class="text-sm text-gray-300 whitespace-pre-wrap">${esc(wizard.goal)}</p>
                </div>
                
                <!-- Tasks -->
                <div class="card rounded-xl p-4">
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        <span></span> Tasks (${tasks.length})
                    </h4>
                    <div class="space-y-3">${tasksHtml}</div>
                </div>
                
                <!-- Tools -->
                <div class="card rounded-xl p-4">
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        <span></span> Tools (${toolsCount})
                    </h4>
                    <div class="flex flex-wrap gap-2">${toolsHtml}</div>
                </div>
                
                <!-- Guardrails Summary -->
                <div class="card rounded-xl p-4">
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        <span></span> Guardrails
                    </h4>
                    <div class="flex flex-wrap gap-2 text-sm">${guardrailsHtml}</div>
                </div>
            `;
            
            console.log('Preview rendered successfully');
        }
        
        function prepareTestSuggestions() {
            try {
                const container = document.getElementById('test-suggestions');
                if(!container) return;
                
                // Use unified test prompts if available (generated from demo data)
                let suggestions = [];
                
                if (wizard.testPrompts && wizard.testPrompts.length > 0) {
                    // Use the test prompts generated from actual demo data
                    suggestions = wizard.testPrompts.slice(0, 5).map(tp => ({
                        prompt: tp.prompt,
                        category: tp.category,
                        hasData: true  // These prompts CAN be answered
                    }));
                    console.log('Using unified test prompts:', suggestions.length);
                } else {
                    // Fallback to task-based suggestions
                    const tasks = wizard.tasks || [];
                    suggestions = tasks.slice(0, 3).map(task => ({
                        prompt: `Test: ${task.name || 'Task'}`,
                        category: task.name,
                        hasData: false
                    }));
                    
                    // Add generic suggestions
                    suggestions.push({ prompt: 'Hello, what can you help me with?', category: 'General', hasData: true });
                    suggestions.push({ prompt: 'Can you explain your capabilities?', category: 'General', hasData: true });
                }
                
                container.innerHTML = suggestions.map(s => `
                    <button onclick="document.getElementById('test-input').value='${escHtml(s.prompt)}'; sendTest();" 
                            class="px-3 py-1.5 ${s.hasData ? 'bg-green-900/30 border border-green-500/30 hover:bg-green-800/30' : 'bg-gray-800 hover:bg-gray-700'} rounded-lg text-sm transition"
                            title="${s.hasData ? ' This prompt can be answered from demo data' : 'Generic test prompt'}">
                        ${escHtml(s.prompt)}
                    </button>
                `).join('');
                
                // Show info about prompts
                if (wizard.testPrompts && wizard.testPrompts.length > 0) {
                    container.insertAdjacentHTML('afterbegin', `
                        <div class="w-full mb-2 text-xs text-green-400 flex items-center gap-1">
                            <span></span> These prompts are generated from your demo data - the agent can answer them!
                        </div>
                    `);
                }
                
                console.log('Test suggestions prepared');
            } catch(e) {
                console.error('Error in prepareTestSuggestions:', e);
            }
        }
        
        // ============================================================================
        // UNIFIED DEMO SYSTEM - Connected Tools, Data & Test Prompts
        // ============================================================================
        
        async function generateUnifiedDemo() {
            /**
             * Unified Demo Generation:
             * 1. Calls /api/demo/unified-setup
             * 2. Gets demo tools WITH actual data stored in knowledge base
             * 3. Gets test prompts that CAN BE ANSWERED from the data
             * 4. Everything is connected!
             */
            
            const goal = wizard.goal || wizard.originalGoal;
            if (!goal) {
                alert('Please define an agent goal first');
                return;
            }
            
            // Show loading state
            const readyEl = document.getElementById('demo-setup-ready');
            const generatingEl = document.getElementById('demo-setup-generating');
            const resultsEl = document.getElementById('demo-setup-results');
            
            if (readyEl) readyEl.classList.add('hidden');
            if (generatingEl) generatingEl.classList.remove('hidden');
            if (resultsEl) resultsEl.classList.add('hidden');
            
            try {
                // Call unified setup API
                const response = await fetch(API + '/api/demo/unified-setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        goal: goal,
                        agent_name: wizard.name,
                        tasks: wizard.tasks,
                        personality: wizard.personality
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Store the results
                    wizard.unifiedDemo = data;
                    wizard.generatedTools = data.tools || [];
                    wizard.testPrompts = data.test_prompts || [];
                    wizard.demoAssets = data.demo_assets || [];
                    wizard.demoScript = data.demo_script || [];
                    
                    // Add ALL generated tools to selectedDemoTools AND wizard.tool_ids
                    if (data.tools && data.tools.length > 0) {
                        data.tools.forEach(tool => {
                            // Add to selectedDemoTools based on type
                            addToolToSelection(tool);
                        });
                        // Sync to wizard.tool_ids
                        syncToolsToWizard();
                        console.log('[Demo] Tools added to selectedDemoTools and wizard:', wizard.tool_ids);
                    }
                    
                    console.log('[Unified Demo] Success:', {
                        domain: data.domain,
                        tools: data.tools.length,
                        testPrompts: data.test_prompts.length,
                        documents: data.sample_data_count
                    });
                    
                    // Update the tools list UI
                    updateSelectedToolsList();
                    
                    // Show results
                    if (generatingEl) generatingEl.classList.add('hidden');
                    if (resultsEl) resultsEl.classList.remove('hidden');
                    
                    renderUnifiedDemoResults(data);
                    
                } else {
                    throw new Error('API request failed');
                }
                
            } catch (e) {
                console.error('[Unified Demo] Error:', e);
                
                // Show error state
                if (generatingEl) generatingEl.classList.add('hidden');
                if (readyEl) readyEl.classList.remove('hidden');
                
                alert('Failed to generate demo. Please try again.');
            }
        }
        
        function renderUnifiedDemoResults(data) {
            const container = document.getElementById('generated-demo-tools');
            if (!container) return;
            
            // Tools already added in the main generation function
            // Just render the UI
            
            // Render API tools
            const apiTools = (data.tools || []).filter(t => t.type === 'api');
            const kbTools = (data.tools || []).filter(t => t.type === 'knowledge');
            
            let toolsHtml = '';
            
            // API Tools Section
            if (apiTools.length > 0) {
                toolsHtml += `<div class="mb-4">
                    <h5 class="text-xs font-medium text-gray-400 mb-2"> Mockup APIs Created:</h5>
                    <div class="space-y-2">`;
                
                apiTools.forEach(tool => {
                    toolsHtml += `
                    <div class="p-3 rounded-xl bg-blue-900/20 border border-blue-500/30">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-blue-300">${escHtml(tool.name)}</span>
                            <span class="text-xs text-green-400"> Ready</span>
                        </div>
                        <p class="text-xs text-gray-400 mb-2">${escHtml(tool.description)}</p>
                        <div class="text-xs font-mono bg-gray-800/50 rounded px-2 py-1 text-gray-500">
                            ${escHtml(tool.endpoint || '')}
                        </div>
                        ${tool.mock_data ? `
                        <details class="mt-2">
                            <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-400">View mock response</summary>
                            <pre class="mt-1 text-xs bg-gray-800/50 rounded p-2 overflow-x-auto text-green-400">${escHtml(JSON.stringify(tool.mock_data, null, 2))}</pre>
                        </details>` : ''}
                    </div>`;
                });
                
                toolsHtml += `</div></div>`;
            }
            
            // Knowledge Base Section
            if (kbTools.length > 0) {
                toolsHtml += `<div class="mb-4">
                    <h5 class="text-xs font-medium text-gray-400 mb-2"> Knowledge Bases:</h5>
                    <div class="space-y-2">`;
                
                kbTools.forEach(tool => {
                    toolsHtml += `
                    <div class="p-3 rounded-xl bg-purple-900/20 border border-purple-500/30">
                        <div class="flex items-center justify-between">
                            <span class="font-medium text-purple-300">${escHtml(tool.name)}</span>
                            <span class="text-xs text-green-400"> ${tool.documents_count || 0} docs indexed</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">${escHtml(tool.description)}</p>
                    </div>`;
                });
                
                toolsHtml += `</div></div>`;
            }
            
            // Demo Assets Section with download links
            if (data.demo_assets && data.demo_assets.length > 0) {
                toolsHtml += `<div class="mb-4">
                    <h5 class="text-xs font-medium text-gray-400 mb-2"> Demo Assets (for testing):</h5>
                    <div class="space-y-2">`;
                
                data.demo_assets.forEach(asset => {
                    const icon = asset.type === 'image' ? '' : '';
                    const downloadBtn = asset.download_url 
                        ? `<a href="${API}${asset.download_url}" download="${asset.name}" class="text-xs text-purple-400 hover:text-purple-300 ml-2"> Download</a>`
                        : '';
                    
                    toolsHtml += `
                    <div class="p-3 rounded-lg bg-gray-800/50 border border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span>${icon}</span>
                                <span class="text-sm font-medium">${escHtml(asset.name)}</span>
                            </div>
                            ${downloadBtn}
                        </div>
                        <p class="text-xs text-gray-400 mt-1">${escHtml(asset.description || '')}</p>
                        ${asset.purpose ? `<p class="text-xs text-gray-500 mt-1">Purpose: ${escHtml(asset.purpose)}</p>` : ''}
                        ${asset.sample_text ? `
                        <details class="mt-2">
                            <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-400">View OCR text content</summary>
                            <pre class="mt-1 text-xs bg-gray-900/50 rounded p-2 overflow-x-auto text-gray-400 whitespace-pre-wrap">${escHtml(asset.sample_text)}</pre>
                        </details>` : ''}
                    </div>`;
                });
                
                toolsHtml += `</div></div>`;
            }
            
            // Test Prompts Preview
            if (data.test_prompts && data.test_prompts.length > 0) {
                toolsHtml += `<div class="mb-4">
                    <h5 class="text-xs font-medium text-gray-400 mb-2"> Test Prompts (${data.test_prompts.length}):</h5>
                    <div class="space-y-1">`;
                
                data.test_prompts.slice(0, 4).forEach(tp => {
                    toolsHtml += `
                    <div class="flex items-center gap-2 text-xs">
                        <span class="text-purple-400"></span>
                        <span class="text-gray-300">"${escHtml(tp.prompt)}"</span>
                        <span class="text-gray-600 ml-auto">${escHtml(tp.category || '')}</span>
                    </div>`;
                });
                
                if (data.test_prompts.length > 4) {
                    toolsHtml += `<p class="text-xs text-gray-500 mt-1">+ ${data.test_prompts.length - 4} more in Test step</p>`;
                }
                
                toolsHtml += `</div></div>`;
            }
            
            // Demo Script
            if (data.demo_script && data.demo_script.length > 0) {
                toolsHtml += `
                <details class="mt-4 pt-4 border-t border-gray-700">
                    <summary class="text-sm font-medium text-gray-400 cursor-pointer hover:text-white"> Demo Setup Script</summary>
                    <div class="mt-2 p-3 bg-gray-800/50 rounded-lg text-xs font-mono space-y-1">
                        ${data.demo_script.map(line => `<div class="${line.startsWith('') ? 'text-green-400' : 'text-gray-400'}">${escHtml(line)}</div>`).join('')}
                    </div>
                </details>`;
            }
            
            // Summary
            if (data.summary) {
                toolsHtml += `
                <div class="mt-4 p-3 bg-green-500/10 border border-green-500/20 rounded-lg">
                    <div class="flex items-center gap-4 text-xs">
                        <span class="text-green-400"> Demo Ready</span>
                        <span class="text-gray-400">${data.summary.apis_created} APIs</span>
                        <span class="text-gray-400">${data.summary.knowledge_bases} KB</span>
                        <span class="text-gray-400">${data.summary.documents_indexed} docs</span>
                        <span class="text-gray-400">${data.summary.demo_assets} assets</span>
                    </div>
                </div>`;
            }
            
            container.innerHTML = toolsHtml;
            
            // Update the Agent's Tools list
            updateAgentToolsList();
        }
        
        function updateAgentToolsList() {
            const container = document.getElementById('w-tools-list');
            if (!container) return;
            
            if (wizard.tool_ids.length === 0) {
                container.innerHTML = `<div class="text-center py-4 text-gray-500 text-sm">
                    Generate demo environment above to add tools automatically
                </div>`;
                return;
            }
            
            // Fetch and display the actual tools
            fetch(API + '/api/tools')
                .then(r => r.json())
                .then(data => {
                    const tools = data.tools || [];
                    const selectedTools = tools.filter(t => wizard.tool_ids.includes(t.id));
                    
                    if (selectedTools.length === 0) {
                        container.innerHTML = `<div class="text-center py-4 text-gray-500 text-sm">
                            No tools added yet
                        </div>`;
                        return;
                    }
                    
                    container.innerHTML = selectedTools.map(tool => {
                        const icon = tool.type === 'api' ? '' : tool.type === 'knowledge' ? '' : '';
                        let bgClass = 'bg-gray-800/50';
                        let borderClass = 'border-gray-700';
                        if (tool.type === 'api') {
                            bgClass = 'bg-blue-900/20';
                            borderClass = 'border-blue-500/30';
                        } else if (tool.type === 'knowledge') {
                            bgClass = 'bg-purple-900/20';
                            borderClass = 'border-purple-500/30';
                        }
                        return `
                        <div class="flex items-center gap-3 p-3 rounded-lg ${bgClass} border ${borderClass}">
                            <span class="text-lg">${icon}</span>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-sm truncate">${escHtml(tool.name)}</div>
                                <div class="text-xs text-gray-500 truncate">${escHtml(tool.description || tool.type)}</div>
                            </div>
                            <button onclick="removeToolFromWizard('${tool.id}')" class="text-gray-500 hover:text-red-400 text-sm"></button>
                        </div>`;
                    }).join('');
                })
                .catch(e => {
                    console.error('Error loading tools:', e);
                });
        }
        
        function removeToolFromWizard(toolId) {
            wizard.tool_ids = wizard.tool_ids.filter(id => id !== toolId);
            
            // Also remove from selectedDemoTools
            const cleanId = toolId.replace(/^(api:|kb:)/, '');
            Object.keys(selectedDemoTools).forEach(key => {
                selectedDemoTools[key] = selectedDemoTools[key].filter(t => t.id !== toolId && t.id !== cleanId);
            });
            
            updateAgentToolsList();
            updateSelectedToolsList();
        }
        
        async function refineUnifiedDemo() {
            const input = document.getElementById('demo-refine-input');
            const refinement = input?.value?.trim();
            if (!refinement) return;
            
            input.value = '';
            input.disabled = true;
            
            try {
                const response = await fetch(API + '/api/demo/refine-unified', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        knowledge_base_id: wizard.knowledgeBaseId,
                        refinement_prompt: refinement,
                        goal: wizard.goal
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    wizard.unifiedDemo = data;
                    wizard.testPrompts = data.test_prompts || wizard.testPrompts;
                    renderUnifiedDemoResults(data);
                }
            } catch (e) {
                console.error('Refine error:', e);
            }
            
            input.disabled = false;
        }
        
        function regenerateUnifiedDemo() {
            // Reset UI state
            const readyEl = document.getElementById('demo-setup-ready');
            const resultsEl = document.getElementById('demo-setup-results');
            
            if (resultsEl) resultsEl.classList.add('hidden');
            if (readyEl) readyEl.classList.remove('hidden');
            
            // Clear previous data
            wizard.unifiedDemo = null;
            wizard.testPrompts = [];
            wizard.knowledgeBaseId = null;
            
            // Regenerate
            generateUnifiedDemo();
        }
        
        // ============================================================================
        // AI Configure Tools & Demo Data Generation
        // ============================================================================
        
        function toggleDemoGenerator() {
            const content = document.getElementById('demo-gen-content');
            const toggle = document.getElementById('demo-gen-toggle');
            if(content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggle.textContent = '';
            } else {
                content.classList.add('hidden');
                toggle.textContent = '';
            }
        }
        
        async function aiConfigureTools() {
            const goal = wizard.goal || wizard.originalGoal;
            if(!goal) {
                alert('Please define an agent goal first (Step 1)');
                return;
            }
            
            // Show loading
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse"></span> Analyzing...';
            btn.disabled = true;
            
            try {
                const response = await fetch(API + '/api/agents/configure-tools', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        goal: goal,
                        agent_name: wizard.name,
                        tasks: wizard.tasks 
                    })
                });
                
                if(response.ok) {
                    const data = await response.json();
                    wizard.suggestedTools = data.tools || [];
                    wizard.demoSuggestions = data.demo_suggestions || {};
                    loadWizardToolsNew();
                    
                    // Show demo suggestions if any
                    if(data.demo_suggestions) {
                        updateDemoSuggestions(data.demo_suggestions);
                    }
                    
                    alert(` AI recommended ${wizard.suggestedTools.length} tools for your agent!`);
                } else {
                    // Fallback to local
                    wizard.suggestedTools = getLocalToolRecommendations(goal);
                    loadWizardToolsNew();
                }
            } catch(e) {
                console.error('AI configure tools error:', e);
                wizard.suggestedTools = getLocalToolRecommendations(goal);
                loadWizardToolsNew();
            }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        
        function getLocalToolRecommendations(goal) {
            const goalLower = goal.toLowerCase();
            
            if(goalLower.includes('customer') || goalLower.includes('support')) {
                return ['knowledge', 'database', 'email'];
            } else if(goalLower.includes('sales') || goalLower.includes('product')) {
                return ['database', 'crm', 'knowledge'];
            } else if(goalLower.includes('hr') || goalLower.includes('employee')) {
                return ['knowledge', 'calendar', 'database'];
            } else if(goalLower.includes('research') || goalLower.includes('analysis')) {
                return ['websearch', 'knowledge', 'code'];
            } else if(goalLower.includes('code') || goalLower.includes('developer')) {
                return ['code', 'websearch', 'knowledge'];
            }
            return ['knowledge', 'websearch'];
        }
        
        function updateDemoSuggestions(suggestions) {
            // Store suggestions for later use
            wizard.demoSuggestions = suggestions;
        }
        
        async function generateDemoAPIs() {
            const statusEl = document.getElementById('demo-apis-status');
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<span class="animate-pulse text-purple-400">Generating APIs...</span>';
            
            try {
                const response = await fetch(API + '/api/demo-lab/generate-for-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'apis',
                        agent_goal: wizard.goal,
                        agent_name: wizard.name,
                        tasks: wizard.tasks
                    })
                });
                
                if(response.ok) {
                    const data = await response.json();
                    statusEl.innerHTML = `<span class="text-green-400"> ${data.count || 1} APIs created!</span>`;
                    addGeneratedItem('api', data.items || [{ name: 'Mock API', endpoint: '/api/mock' }]);
                } else {
                    statusEl.innerHTML = '<span class="text-yellow-400"> Using demo data</span>';
                    // Create sample mock API
                    createSampleMockAPI();
                }
            } catch(e) {
                console.error('Generate APIs error:', e);
                statusEl.innerHTML = '<span class="text-yellow-400"> Using demo data</span>';
                createSampleMockAPI();
            }
        }
        
        async function generateDemoDocs() {
            const statusEl = document.getElementById('demo-docs-status');
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<span class="animate-pulse text-purple-400">Generating documents...</span>';
            
            try {
                const response = await fetch(API + '/api/demo-lab/generate-for-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'documents',
                        agent_goal: wizard.goal,
                        agent_name: wizard.name,
                        tasks: wizard.tasks
                    })
                });
                
                if(response.ok) {
                    const data = await response.json();
                    statusEl.innerHTML = `<span class="text-green-400"> ${data.count || 1} documents created!</span>`;
                    addGeneratedItem('document', data.items || []);
                } else {
                    statusEl.innerHTML = '<span class="text-yellow-400"> Using demo data</span>';
                    createSampleDocument();
                }
            } catch(e) {
                console.error('Generate docs error:', e);
                statusEl.innerHTML = '<span class="text-yellow-400"> Using demo data</span>';
                createSampleDocument();
            }
        }
        
        async function generateDemoImages() {
            const statusEl = document.getElementById('demo-images-status');
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<span class="animate-pulse text-purple-400">Generating images...</span>';
            
            try {
                const response = await fetch(API + '/api/demo-lab/generate-for-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'images',
                        agent_goal: wizard.goal,
                        agent_name: wizard.name,
                        tasks: wizard.tasks
                    })
                });
                
                if(response.ok) {
                    const data = await response.json();
                    statusEl.innerHTML = `<span class="text-green-400"> ${data.count || 1} images created!</span>`;
                    addGeneratedItem('image', data.items || []);
                } else {
                    statusEl.innerHTML = '<span class="text-yellow-400"> Placeholder images</span>';
                }
            } catch(e) {
                console.error('Generate images error:', e);
                statusEl.innerHTML = '<span class="text-yellow-400"> Placeholder images</span>';
            }
        }
        
        async function generateAllDemoData() {
            const btn = event.target;
            btn.innerHTML = '<span class="animate-pulse"></span> Generating all demo data...';
            btn.disabled = true;
            
            await generateDemoAPIs();
            await new Promise(r => setTimeout(r, 500));
            await generateDemoDocs();
            await new Promise(r => setTimeout(r, 500));
            await generateDemoImages();
            
            btn.innerHTML = '<span></span> Generate All Demo Data';
            btn.disabled = false;
        }
        
        function addGeneratedItem(type, items) {
            const container = document.getElementById('generated-demo-items');
            const list = document.getElementById('demo-items-list');
            container.classList.remove('hidden');
            
            const icons = { api: '', document: '', image: '' };
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-800/50 rounded px-3 py-2';
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>${icons[type] || ''}</span>
                        <span class="text-sm">${item.name || type}</span>
                    </div>
                    <span class="text-xs text-green-400"></span>
                `;
                list.appendChild(div);
            });
        }
        
        async function createSampleMockAPI() {
            // Create a sample mock API based on agent goal
            const goalLower = (wizard.goal || '').toLowerCase();
            let apiName = 'Sample API';
            let endpoint = '/api/sample';
            
            if(goalLower.includes('customer') || goalLower.includes('order')) {
                apiName = 'Orders API';
                endpoint = '/api/orders';
            } else if(goalLower.includes('product') || goalLower.includes('catalog')) {
                apiName = 'Products API';
                endpoint = '/api/products';
            } else if(goalLower.includes('employee') || goalLower.includes('hr')) {
                apiName = 'Employees API';
                endpoint = '/api/employees';
            }
            
            addGeneratedItem('api', [{ name: apiName, endpoint: endpoint }]);
        }
        
        async function createSampleDocument() {
            const goalLower = (wizard.goal || '').toLowerCase();
            let docName = 'Sample Document';
            
            if(goalLower.includes('customer')) {
                docName = 'Customer Support FAQ';
            } else if(goalLower.includes('product')) {
                docName = 'Product Catalog';
            } else if(goalLower.includes('hr') || goalLower.includes('employee')) {
                docName = 'HR Policies';
            }
            
            addGeneratedItem('document', [{ name: docName }]);
        }
        
        // Deploy Options
        function selectDeployOption(option) {
            if(option === 'draft') {
                saveAgent('draft');
            } else {
                document.getElementById('deploy-options').classList.remove('hidden');
            }
        }
        
        function selectDeployTarget(target) {
            wizard.deployTarget = target;
            
            document.querySelectorAll('.deploy-target').forEach(el => {
                el.classList.toggle('border-purple-500', el.dataset.target === target);
                el.classList.toggle('bg-purple-500/10', el.dataset.target === target);
            });
            
            document.getElementById('cloud-providers').classList.toggle('hidden', target !== 'cloud');
            document.getElementById('onprem-config').classList.toggle('hidden', target !== 'onprem');
        }
        
        function selectCloudProvider(provider) {
            wizard.cloudProvider = provider;
            
            document.querySelectorAll('.cloud-provider').forEach(el => {
                el.classList.toggle('border-purple-500', el.dataset.provider === provider);
                el.classList.toggle('bg-purple-500/10', el.dataset.provider === provider);
            });
            
            ['aws', 'azure', 'gcp', 'oci'].forEach(p => {
                document.getElementById('cloud-config-' + p)?.classList.toggle('hidden', p !== provider);
            });
        }
        
        function onOnpremMethodChange() {
            const method = document.getElementById('onprem-method').value;
            document.getElementById('onprem-docker').classList.toggle('hidden', method !== 'docker');
            document.getElementById('onprem-kubernetes').classList.toggle('hidden', method !== 'kubernetes');
        }
        
        function copyDockerCommand() {
            const code = document.querySelector('#onprem-docker pre code').textContent;
            navigator.clipboard.writeText(code);
            alert('Docker command copied!');
        }
        
        function downloadK8sManifest() {
            const code = document.querySelector('#onprem-kubernetes pre code').textContent;
            const blob = new Blob([code], { type: 'text/yaml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'agent-deployment.yaml';
            a.click();
        }
        
        async function deployAgent() {
            // Collect all data and deploy
            collectGuardrails();
            
            const deployData = {
                name: wizard.name,
                icon: wizard.icon,
                goal: wizard.goal,
                personality: wizard.personality,
                guardrails: wizard.guardrails || {},
                tasks: wizard.tasks || [],
                tool_ids: wizard.tool_ids || [],
                model_id: wizard.model,
                status: 'published'
            };
            
            try {
                let response;
                const agentId = testAgent?.id || wizard.editId;
                
                if (agentId) {
                    // Update existing agent
                    response = await fetch(API + '/api/agents/' + agentId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(deployData)
                    });
                } else {
                    // Create new agent
                    response = await fetch(API + '/api/agents', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(deployData)
                    });
                }
                
                if(response.ok) {
                    alert(' Agent deployed successfully!');
                    wizard.editId = null;
                    testAgent = null;
                    navigate('agents');
                    setAgentTab('published');
                } else {
                    const err = await response.json();
                    alert('Error: ' + (err.detail || 'Failed to deploy'));
                }
            } catch(e) {
                console.error('Deploy error:', e);
                alert('Error deploying agent: ' + e.message);
            }
        }

        // ============================================================================
        // DEMO LAB FUNCTIONS
        // ============================================================================
        
        let demoTab = 'api';
        let demoItems = { apis: [], docs: [], images: [] };
        let demoConversation = [];
        let demoCurrentMode = 'api';
        let demoSidebarTab = 'all';
        let demoEditingItem = null;
        let demoKits = [];
        let currentKitId = null;
        let currentTestApi = null;

        // Initialize Demo Lab
        function initDemoLab() {
            loadDemoKits();
        }

        // Load demo kits from server
        async function loadDemoKits() {
            try {
                const response = await fetch(API + '/api/demo-kits');
                const data = await response.json();
                demoKits = data.kits || [];
                renderDemoKitsList();
            } catch (e) {
                console.error('Failed to load demo kits:', e);
            }
        }

        // Render demo kits list in sidebar
        function renderDemoKitsList() {
            const container = document.getElementById('demo-kits-list');
            if (!container) return;
            
            if (demoKits.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="text-3xl block mb-2"></span>
                        <p class="text-sm">No demo kits yet</p>
                        <p class="text-xs mt-1">Create one to get started!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = demoKits.map(kit => `
                <div onclick="selectDemoKit('${kit.id}')" class="p-3 rounded-lg cursor-pointer transition-colors ${currentKitId === kit.id ? 'bg-purple-500/20 border border-purple-500/50' : 'bg-gray-800/50 hover:bg-gray-800 border border-transparent'}">
                    <div class="flex items-start gap-2">
                        <span class="text-xl"></span>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-sm truncate">${escHtml(kit.name)}</p>
                            <p class="text-xs text-gray-500 truncate">${escHtml(kit.description || '')}</p>
                            <div class="flex gap-2 mt-2 text-xs">
                                <span class="px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-300">${kit.api_count} APIs</span>
                                <span class="px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-300">${kit.kb_count} KBs</span>
                                <span class="px-1.5 py-0.5 rounded bg-green-500/20 text-green-300">${kit.asset_count} Assets</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Select a demo kit to view details
        async function selectDemoKit(kitId) {
            currentKitId = kitId;
            renderDemoKitsList();
            
            try {
                const response = await fetch(API + `/api/demo-kits/${kitId}`);
                const kit = await response.json();
                renderKitDetails(kit);
            } catch (e) {
                console.error('Failed to load kit details:', e);
                alert('Failed to load kit details');
            }
        }

        // Render kit details
        function renderKitDetails(kit) {
            document.getElementById('demo-welcome').classList.add('hidden');
            document.getElementById('demo-kit-details').classList.remove('hidden');
            
            document.getElementById('kit-detail-name').textContent = kit.name;
            document.getElementById('kit-detail-desc').textContent = kit.description;
            document.getElementById('kit-api-count').textContent = kit.apis?.length || 0;
            document.getElementById('kit-kb-count').textContent = kit.knowledge_bases?.length || 0;
            document.getElementById('kit-asset-count').textContent = kit.assets?.length || 0;
            
            // Render APIs
            const apisContainer = document.getElementById('kit-apis-list');
            if (kit.apis && kit.apis.length > 0) {
                apisContainer.innerHTML = kit.apis.map(api => `
                    <div class="card rounded-lg p-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-0.5 rounded text-xs font-bold ${api.method === 'GET' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}">${api.method}</span>
                                    <code class="text-sm text-gray-300">${escHtml(api.endpoint)}</code>
                                </div>
                                <p class="font-medium">${escHtml(api.name)}</p>
                                <p class="text-sm text-gray-400 mt-1">${escHtml(api.description)}</p>
                                ${api.parameters && api.parameters.length > 0 ? `
                                    <div class="mt-2 text-xs text-gray-500">
                                        Parameters: ${api.parameters.map(p => p.name).join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="goToToolPage('${api.id}')" class="px-3 py-1.5 rounded-lg text-sm bg-gray-700 text-gray-300 hover:bg-gray-600">
                                     Edit
                                </button>
                                <button onclick="testDemoApi('${kit.id}', '${api.id}')" class="px-3 py-1.5 rounded-lg text-sm bg-green-500/20 text-green-400 hover:bg-green-500/30">
                                     Test
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                apisContainer.innerHTML = '<p class="text-gray-500 text-sm">No APIs in this kit</p>';
            }
            
            // Render Knowledge Bases
            const kbContainer = document.getElementById('kit-kb-list');
            if (kit.knowledge_bases && kit.knowledge_bases.length > 0) {
                kbContainer.innerHTML = kit.knowledge_bases.map(kb => `
                    <div class="card rounded-lg p-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-medium">${escHtml(kb.name)}</p>
                                <p class="text-sm text-gray-400 mt-1">${escHtml(kb.description)}</p>
                                <div class="mt-2 text-xs text-gray-500">
                                    ${kb.sections?.length || 0} sections
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="goToToolPage('${kb.id}')" class="px-3 py-1.5 rounded-lg text-sm bg-gray-700 text-gray-300 hover:bg-gray-600">
                                     Edit
                                </button>
                                <button onclick="viewKnowledgeBase('${kit.id}', '${kb.id}')" class="px-3 py-1.5 rounded-lg text-sm bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                     View
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                kbContainer.innerHTML = '<p class="text-gray-500 text-sm">No knowledge bases in this kit</p>';
            }
            
            // Render Assets (assets don't have a Tools page, keep edit modal)
            const assetsContainer = document.getElementById('kit-assets-list');
            if (kit.assets && kit.assets.length > 0) {
                assetsContainer.innerHTML = kit.assets.map(asset => `
                    <div class="card rounded-lg p-4 text-center">
                        <div class="w-12 h-12 mx-auto mb-2 rounded-lg bg-gray-700 flex items-center justify-center">
                            ${asset.asset_type === 'invoice' ? '' : asset.asset_type === 'receipt' ? '' : ''}
                        </div>
                        <p class="font-medium text-sm truncate">${escHtml(asset.name)}</p>
                        <p class="text-xs text-gray-500 capitalize">${asset.asset_type}</p>
                        <div class="flex gap-1 mt-3 justify-center flex-wrap">
                            <button onclick="editDemoAsset('${kit.id}', '${asset.id}')" class="px-2 py-1 rounded text-xs bg-gray-700 text-gray-300 hover:bg-gray-600">
                                
                            </button>
                            <button onclick="generateAssetFile('${kit.id}', '${asset.id}')" class="px-2 py-1 rounded text-xs bg-green-500/20 text-green-400 hover:bg-green-500/30">
                                Generate
                            </button>
                            ${asset.file_url ? `
                                <a href="${API}${asset.file_url}" download class="px-2 py-1 rounded text-xs bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                    
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                assetsContainer.innerHTML = '<p class="text-gray-500 text-sm col-span-3 text-center">No demo assets in this kit</p>';
            }
        }
        
        // Navigate to Tool page for editing
        function goToToolPage(toolId) {
            showPage('tools');
            setTimeout(() => viewTool(toolId), 100);
        }

        // Show create kit modal
        function showCreateKitModal() {
            document.getElementById('create-kit-modal').classList.remove('hidden');
            document.getElementById('create-kit-modal').classList.add('flex');
            document.getElementById('new-kit-description').focus();
        }

        // Close create kit modal
        function closeCreateKitModal() {
            document.getElementById('create-kit-modal').classList.add('hidden');
            document.getElementById('create-kit-modal').classList.remove('flex');
            document.getElementById('kit-generation-status').classList.add('hidden');
            document.getElementById('generate-kit-btn').disabled = false;
        }

        // Generate demo kit
        async function generateDemoKit() {
            const name = document.getElementById('new-kit-name').value.trim();
            const description = document.getElementById('new-kit-description').value.trim();
            
            if (!description) {
                alert('Please describe what you need');
                return;
            }
            
            // Show loading
            document.getElementById('kit-generation-status').classList.remove('hidden');
            document.getElementById('generate-kit-btn').disabled = true;
            
            try {
                const response = await fetch(API + '/api/demo-kits/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description: description,
                        kit_name: name || null
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate kit');
                }
                
                const kit = await response.json();
                
                // Close modal and refresh
                closeCreateKitModal();
                document.getElementById('new-kit-name').value = '';
                document.getElementById('new-kit-description').value = '';
                
                // Reload kits and select the new one
                await loadDemoKits();
                selectDemoKit(kit.id);
                
            } catch (e) {
                console.error('Failed to generate kit:', e);
                alert('Failed to generate demo kit: ' + e.message);
                document.getElementById('kit-generation-status').classList.add('hidden');
                document.getElementById('generate-kit-btn').disabled = false;
            }
        }

        // Delete current kit
        async function deleteCurrentKit() {
            if (!currentKitId) return;
            if (!confirm('Are you sure you want to delete this demo kit?')) return;
            
            try {
                await fetch(API + `/api/demo-kits/${currentKitId}`, { method: 'DELETE' });
                currentKitId = null;
                document.getElementById('demo-welcome').classList.remove('hidden');
                document.getElementById('demo-kit-details').classList.add('hidden');
                await loadDemoKits();
            } catch (e) {
                alert('Failed to delete kit');
            }
        }

        // Test API
        function testDemoApi(kitId, apiId) {
            const kit = demoKits.find(k => k.id === kitId);
            if (!kit) return;
            
            // Load full kit data to get API details
            fetch(API + `/api/demo-kits/${kitId}`)
                .then(r => r.json())
                .then(fullKit => {
                    const api = fullKit.apis.find(a => a.id === apiId);
                    if (!api) return;
                    
                    currentTestApi = { kitId, apiId, api };
                    
                    document.getElementById('api-test-title').textContent = `Test: ${api.name}`;
                    document.getElementById('api-test-method').textContent = api.method;
                    document.getElementById('api-test-method').className = `px-2 py-0.5 rounded text-xs font-bold ${api.method === 'GET' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}`;
                    document.getElementById('api-test-endpoint').textContent = api.endpoint;
                    
                    // Render parameters
                    const paramsContainer = document.getElementById('api-test-params');
                    if (api.parameters && api.parameters.length > 0) {
                        paramsContainer.innerHTML = api.parameters.map(p => `
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-400 w-24">${p.name}${p.required ? '*' : ''}</label>
                                <input type="text" class="api-param-input flex-1 input-field rounded px-2 py-1 text-sm" 
                                       data-param="${p.name}" placeholder="${p.type || 'string'}">
                            </div>
                        `).join('');
                    } else {
                        paramsContainer.innerHTML = '<p class="text-xs text-gray-500">No parameters</p>';
                    }
                    
                    // Show/hide body for POST
                    const bodyEl = document.getElementById('api-test-body');
                    if (api.method === 'POST' || api.method === 'PUT') {
                        bodyEl.classList.remove('hidden');
                        bodyEl.value = api.sample_request ? JSON.stringify(api.sample_request, null, 2) : '{}';
                    } else {
                        bodyEl.classList.add('hidden');
                    }
                    
                    // Reset response
                    document.getElementById('api-test-response').textContent = '// Click "Send Request" to test';
                    
                    document.getElementById('api-test-modal').classList.remove('hidden');
                    document.getElementById('api-test-modal').classList.add('flex');
                });
        }

        // Close API test modal
        function closeApiTestModal() {
            document.getElementById('api-test-modal').classList.add('hidden');
            document.getElementById('api-test-modal').classList.remove('flex');
            currentTestApi = null;
        }

        // Send API test request
        async function sendApiTestRequest() {
            if (!currentTestApi) return;
            
            const { kitId, apiId, api } = currentTestApi;
            
            // Collect parameters
            const params = {};
            document.querySelectorAll('.api-param-input').forEach(input => {
                if (input.value) {
                    params[input.dataset.param] = input.value;
                }
            });
            
            // Get body if POST
            let body = {};
            if (api.method === 'POST' || api.method === 'PUT') {
                try {
                    body = JSON.parse(document.getElementById('api-test-body').value || '{}');
                } catch (e) {
                    alert('Invalid JSON in request body');
                    return;
                }
            }
            
            try {
                const response = await fetch(API + `/api/demo-kits/${kitId}/api/${apiId}/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...params, ...body })
                });
                
                const result = await response.json();
                document.getElementById('api-test-response').textContent = JSON.stringify(result.response || result, null, 2);
            } catch (e) {
                document.getElementById('api-test-response').textContent = `Error: ${e.message}`;
            }
        }

        // View Knowledge Base
        function viewKnowledgeBase(kitId, kbId) {
            fetch(API + `/api/demo-kits/${kitId}`)
                .then(r => r.json())
                .then(kit => {
                    const kb = kit.knowledge_bases.find(k => k.id === kbId);
                    if (!kb) return;
                    
                    document.getElementById('kb-view-title').textContent = kb.name;
                    
                    // Render content with sections
                    let html = `<p class="text-gray-400 mb-4">${escHtml(kb.description)}</p>`;
                    
                    if (kb.sections && kb.sections.length > 0) {
                        html += kb.sections.map(s => `
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-purple-400 mb-2">${escHtml(s.title)}</h3>
                                <div class="text-gray-300 whitespace-pre-wrap">${escHtml(s.content)}</div>
                            </div>
                        `).join('');
                    } else if (kb.content) {
                        html += `<div class="text-gray-300 whitespace-pre-wrap">${escHtml(kb.content)}</div>`;
                    }
                    
                    document.getElementById('kb-view-content').innerHTML = html;
                    
                    document.getElementById('kb-view-modal').classList.remove('hidden');
                    document.getElementById('kb-view-modal').classList.add('flex');
                });
        }

        // Close KB view modal
        function closeKbViewModal() {
            document.getElementById('kb-view-modal').classList.add('hidden');
            document.getElementById('kb-view-modal').classList.remove('flex');
        }

        // Generate asset file
        async function generateAssetFile(kitId, assetId) {
            try {
                const response = await fetch(API + `/api/demo-kits/${kitId}/assets/${assetId}/generate`, {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Failed to generate');
                
                const result = await response.json();
                alert('Asset generated! You can now download it.');
                
                // Refresh kit details
                selectDemoKit(kitId);
            } catch (e) {
                alert('Failed to generate asset file: ' + e.message);
            }
        }
        
        // ========== EDIT FUNCTIONS ==========
        let currentEditKitId = null;
        let currentEditItemId = null;
        
        // Edit Asset (only Assets need modal - APIs and KBs go to Tools page)
        function editDemoAsset(kitId, assetId) {
            currentEditKitId = kitId;
            currentEditItemId = assetId;
            
            fetch(API + `/api/demo-kits/${kitId}`)
                .then(r => r.json())
                .then(kit => {
                    const asset = kit.assets.find(a => a.id === assetId);
                    if (!asset) return;
                    
                    document.getElementById('edit-asset-name').value = asset.name || '';
                    document.getElementById('edit-asset-description').value = asset.description || '';
                    document.getElementById('edit-asset-type').value = asset.asset_type || 'document';
                    
                    document.getElementById('edit-asset-modal').classList.remove('hidden');
                    document.getElementById('edit-asset-modal').classList.add('flex');
                });
        }
        
        function closeEditAssetModal() {
            document.getElementById('edit-asset-modal').classList.add('hidden');
            document.getElementById('edit-asset-modal').classList.remove('flex');
        }
        
        async function saveEditAsset() {
            try {
                const response = await fetch(API + `/api/demo-kits/${currentEditKitId}/asset/${currentEditItemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('edit-asset-name').value,
                        description: document.getElementById('edit-asset-description').value,
                        asset_type: document.getElementById('edit-asset-type').value
                    })
                });
                
                if (!response.ok) throw new Error('Failed to update');
                
                closeEditAssetModal();
                selectDemoKit(currentEditKitId);
            } catch (e) {
                alert('Failed to save: ' + e.message);
            }
        }

        // Use example text in modal
        function useDemoKitExample() {
            showCreateKitModal();
            document.getElementById('new-kit-description').value = `I need tools for an HR agent that can check employee vacation balance, submit vacation requests, process expense claims with receipt uploads, and answer questions about HR policies including benefits and leave policies. Also need sample invoices and receipts for testing.`;
        }

        async function loadDemoItems() {
            try {
                const r = await fetch(API + '/api/demo/items');
                const d = await r.json();
                demoItems = d;
                renderDemoSidebar();
                updateDemoCounts();
            } catch(e) {
                console.log('Demo items not loaded:', e);
            }
        }

        function updateDemoCounts() {
            const apis = demoItems.apis || [];
            const docs = demoItems.docs || [];
            const images = demoItems.images || [];
            const all = apis.length + docs.length + images.length;
            
            document.getElementById('count-all').textContent = all;
            document.getElementById('count-api').textContent = apis.length;
            document.getElementById('count-document').textContent = docs.length;
            document.getElementById('count-image').textContent = images.length;
        }

        function renderDemoSidebar() {
            const container = document.getElementById('demo-sidebar-items');
            let items = [];
            
            // Get items based on tab filter
            if (demoSidebarTab === 'all') {
                items = [
                    ...(demoItems.apis || []).map(i => ({...i, itemType: 'api'})),
                    ...(demoItems.docs || []).map(i => ({...i, itemType: 'document'})),
                    ...(demoItems.images || []).map(i => ({...i, itemType: 'image'}))
                ];
            } else if (demoSidebarTab === 'api') {
                items = (demoItems.apis || []).map(i => ({...i, itemType: 'api'}));
            } else if (demoSidebarTab === 'document') {
                items = (demoItems.docs || []).map(i => ({...i, itemType: 'document'}));
            } else if (demoSidebarTab === 'image') {
                items = (demoItems.images || []).map(i => ({...i, itemType: 'image'}));
            }
            
            if (!items.length) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="text-3xl block mb-2"></span>
                        <p class="text-sm">No items yet</p>
                        <p class="text-xs mt-1">Generate something to get started!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = items.map(item => {
                const icons = { api: '', document: '', image: '' };
                const colors = { api: 'purple', document: 'blue', image: 'green' };
                const icon = icons[item.itemType] || '';
                const color = colors[item.itemType] || 'gray';
                
                return `
                    <div class="group bg-gray-800/50 hover:bg-gray-800 rounded-lg p-3 transition-all border border-transparent hover:border-${color}-500/30 cursor-pointer" onclick="viewDemoItem('${item.id}', '${item.itemType}')">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex items-center gap-2 min-w-0 flex-1">
                                <span class="w-8 h-8 rounded-lg bg-${color}-500/20 flex items-center justify-center text-sm flex-shrink-0">${icon}</span>
                                <div class="min-w-0 flex-1">
                                    <p class="font-medium text-sm truncate">${item.name || 'Untitled'}</p>
                                    <p class="text-xs text-gray-500 truncate">${item.description || item.itemType}</p>
                                </div>
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="event.stopPropagation(); editDemoItem('${item.id}', '${item.itemType}')" class="p-1.5 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="Edit">
                                    
                                </button>
                                <button onclick="event.stopPropagation(); deleteDemoItem('${item.id}', '${item.itemType}')" class="p-1.5 hover:bg-red-900/50 rounded text-gray-400 hover:text-red-400" title="Delete">
                                    
                                </button>
                            </div>
                        </div>
                        ${item.url ? `
                            <div class="mt-2 pt-2 border-t border-gray-700/50 flex gap-2">
                                <a href="${item.url.startsWith('http') ? item.url : API + item.url}" target="_blank" onclick="event.stopPropagation()" class="text-xs text-${color}-400 hover:underline flex items-center gap-1">
                                    ${item.itemType === 'api' ? ' Test API' : item.itemType === 'image' ? ' View' : ' Download'}
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // View item details
        function viewDemoItem(id, type) {
            const items = type === 'api' ? demoItems.apis : type === 'document' ? demoItems.docs : demoItems.images;
            const item = items?.find(i => i.id === id);
            if (!item) return;
            
            const url = item.url ? (item.url.startsWith('http') ? item.url : API + item.url) : null;
            
            if (type === 'api' && url) {
                window.open(url, '_blank');
            } else if (url) {
                window.open(url, '_blank');
            }
        }

        // Edit item
        function editDemoItem(id, type) {
            const items = type === 'api' ? demoItems.apis : type === 'document' ? demoItems.docs : demoItems.images;
            const item = items?.find(i => i.id === id);
            if (!item) return;
            
            demoEditingItem = { id, type, item };
            
            const modal = document.getElementById('demo-edit-modal');
            const title = document.getElementById('edit-modal-title');
            const content = document.getElementById('edit-modal-content');
            
            const icons = { api: '', document: '', image: '' };
            title.textContent = `${icons[type]} Edit ${item.name || 'Item'}`;
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Name</label>
                        <input type="text" id="edit-item-name" class="input-field w-full rounded-lg px-3 py-2" value="${item.name || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Description</label>
                        <textarea id="edit-item-description" class="input-field w-full rounded-lg px-3 py-2 h-24">${item.description || ''}</textarea>
                    </div>
                    ${type === 'api' ? `
                        <div>
                            <label class="block text-sm font-medium mb-2">API URL</label>
                            <input type="text" id="edit-item-url" class="input-field w-full rounded-lg px-3 py-2 bg-gray-700" value="${item.url || ''}" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Endpoints</label>
                            <div class="bg-gray-800 rounded-lg p-3 text-sm font-mono max-h-40 overflow-y-auto">
                                ${(item.endpoints || []).map(e => `<div class="text-gray-300">${e.method} ${e.path}</div>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeDemoEditModal() {
            const modal = document.getElementById('demo-edit-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            demoEditingItem = null;
        }

        async function saveDemoEdit() {
            if (!demoEditingItem) return;
            
            const name = document.getElementById('edit-item-name')?.value;
            const description = document.getElementById('edit-item-description')?.value;
            
            try {
                const response = await fetch(API + '/api/demo/items/' + demoEditingItem.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: demoEditingItem.type,
                        name,
                        description
                    })
                });
                
                if (response.ok) {
                    closeDemoEditModal();
                    loadDemoItems();
                    addDemoMessage('assistant', ` Updated "${name}" successfully!`);
                } else {
                    alert('Failed to save changes');
                }
            } catch (e) {
                console.error('Save error:', e);
                alert('Error saving: ' + e.message);
            }
        }

        // Delete item
        async function deleteDemoItem(id, type) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            try {
                const response = await fetch(API + '/api/demo/items/' + id + '?type=' + type, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadDemoItems();
                    addDemoMessage('assistant', ' Item deleted successfully.');
                } else {
                    alert('Failed to delete item');
                }
            } catch (e) {
                console.error('Delete error:', e);
                alert('Error deleting: ' + e.message);
            }
        }

        // Clear all demo history
        async function clearDemoHistory() {
            if (!confirm('Are you sure you want to clear all generated items? This cannot be undone.')) return;
            
            try {
                const response = await fetch(API + '/api/demo/items/clear', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    demoItems = { apis: [], docs: [], images: [] };
                    demoConversation = [];
                    renderDemoSidebar();
                    updateDemoCounts();
                    clearDemoChat();
                }
            } catch (e) {
                console.error('Clear error:', e);
            }
        }

        async function sendDemoMessage() {
            const input = document.getElementById('demo-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            
            // Remove welcome message
            const welcome = document.getElementById('demo-welcome');
            if (welcome) welcome.remove();
            
            // Add user message
            addDemoMessage('user', message);
            
            // Add thinking indicator
            const thinkingId = addDemoMessage('assistant', `<span class="animate-pulse"> Generating ${demoCurrentMode}...</span>`, true);
            
            try {
                const response = await fetch(API + '/api/demo/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message, 
                        conversation: demoConversation,
                        mode_hint: demoCurrentMode  // Pass the current mode as a hint
                    })
                });
                
                const data = await response.json();
                
                // Remove thinking indicator
                document.getElementById(thinkingId)?.remove();
                
                // Add assistant response
                addDemoMessage('assistant', data.response);
                
                // If there's a generated item, show action buttons
                if (data.generated) {
                    addDemoActionButtons(data.generated);
                }
                
                // Save to conversation
                demoConversation.push({ role: 'user', content: message });
                demoConversation.push({ role: 'assistant', content: data.response });
                
                // Refresh items list
                loadDemoItems();
                
            } catch (e) {
                document.getElementById(thinkingId)?.remove();
                addDemoMessage('assistant', ' Error: ' + e.message);
            }
        }

        function addDemoMessage(role, content, isTemp = false) {
            const container = document.getElementById('demo-chat-messages');
            const id = 'demo-msg-' + Date.now();
            
            const msgDiv = document.createElement('div');
            msgDiv.id = id;
            msgDiv.className = role === 'user' 
                ? 'flex justify-end' 
                : 'flex justify-start';
            
            const bgColor = role === 'user' ? 'bg-gradient-to-r from-purple-600 to-purple-700' : 'bg-gray-800';
            
            msgDiv.innerHTML = `
                <div class="${bgColor} rounded-2xl px-4 py-3 max-w-[80%] shadow-lg">
                    ${role === 'assistant' ? '<span class="text-lg mr-2"></span>' : ''}
                    <div class="text-sm ${role === 'user' ? '' : 'prose prose-invert prose-sm max-w-none'}">${content}</div>
                </div>
            `;
            
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            
            return id;
        }

        function addDemoActionButtons(generated) {
            const container = document.getElementById('demo-chat-messages');
            
            console.log('[Demo Lab] Generated item:', generated);
            
            if (!generated) {
                console.log('[Demo Lab] No generated item');
                return;
            }
            
            // For documents/images, check if URL exists
            if ((generated.type === 'document' || generated.type === 'image') && !generated.url) {
                console.log('[Demo Lab] No URL for generated item:', generated);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'flex justify-start';
                errorDiv.innerHTML = `
                    <div class="bg-red-900/30 border border-red-500/30 rounded-xl px-4 py-3 text-sm text-red-300 mt-2">
                         Generation may have failed. Check server logs for details.
                    </div>
                `;
                container.appendChild(errorDiv);
                return;
            }
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex justify-start';
            
            let buttons = '';
            const fullUrl = generated.url ? (generated.url.startsWith('http') ? generated.url : API + generated.url) : '';
            
            if (generated.type === 'api') {
                const apiUrl = generated.url ? (generated.url.startsWith('http') ? generated.url : API + generated.url) : API + '/demo-api/' + generated.name;
                buttons = `
                    <button onclick="createToolFromDemo('${generated.id}')" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded-xl text-sm font-medium transition-colors">
                         Create API Tool
                    </button>
                    <a href="${apiUrl}" target="_blank" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-xl text-sm font-medium transition-colors">
                         Test API
                    </a>
                `;
            } else if (generated.type === 'document') {
                buttons = `
                    <a href="${fullUrl}" download class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl text-sm font-medium flex items-center gap-2 transition-colors">
                         Download ${generated.name || 'Document'}
                    </a>
                    <a href="${fullUrl}" target="_blank" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-xl text-sm font-medium transition-colors">
                         Preview
                    </a>
                `;
            } else if (generated.type === 'image') {
                buttons = `
                    <a href="${fullUrl}" download class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-xl text-sm font-medium transition-colors">
                         Download Image
                    </a>
                    <a href="${fullUrl}" target="_blank" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-xl text-sm font-medium transition-colors">
                         View Full Size
                    </a>
                `;
            }
            
            actionsDiv.innerHTML = `
                <div class="flex gap-2 mt-3 ml-2">
                    ${buttons}
                </div>
            `;
            
            container.appendChild(actionsDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function createToolFromDemo(demoApiId) {
            try {
                const response = await fetch(API + '/api/demo/create-tool', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ demo_id: demoApiId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addDemoMessage('assistant', ` API Tool "${data.tool_name}" created successfully! You can now assign it to any agent.`);
                    loadTools();
                } else {
                    addDemoMessage('assistant', ' Failed to create tool: ' + data.error);
                }
            } catch (e) {
                addDemoMessage('assistant', ' Error: ' + e.message);
            }
        }

        async function createDocToolFromDemo(demoDocId) {
            addDemoMessage('assistant', ' To add this document to a tool, go to Tools and upload it there.');
        }

        function clearDemoChat() {
            demoConversation = [];
            const container = document.getElementById('demo-chat-messages');
            container.innerHTML = `
                <div class="text-center text-gray-500 py-6" id="demo-welcome">
                    <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-purple-500/20 to-blue-500/20 flex items-center justify-center mb-4">
                        <span class="text-4xl"></span>
                    </div>
                    <p class="text-lg font-medium mb-2">Welcome to Demo Lab!</p>
                    <p class="text-sm mb-6 text-gray-400">Generate instant mock APIs, professional documents & images</p>
                    <p class="text-xs text-gray-500">Select a mode above and type your request below</p>
                </div>
            `;
        }
        // ============================================================================
        // END DEMO LAB FUNCTIONS
        // ============================================================================

        function setAgentTab(t){
            agentTab=t;
            document.getElementById('tab-published').className='tab-btn pb-3 px-2 border-b-2 whitespace-nowrap '+(t==='published'?'active border-purple-500':'border-transparent');
            document.getElementById('tab-draft').className='tab-btn pb-3 px-2 border-b-2 whitespace-nowrap '+(t==='draft'?'active border-purple-500':'border-transparent');
            loadAgents();
        }

        async function loadAgents(){
            const r=await fetch(API+'/api/agents?status='+agentTab);
            const d=await r.json();
            const g=document.getElementById('agents-grid');
            if(!d.agents.length){
                g.innerHTML=`<div class="col-span-full text-center py-10 md:py-20 text-gray-500">
                    <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-20 h-20 mx-auto mb-4 opacity-50">
                    <p class="mb-4">No ${agentTab} agents yet</p>
                    <button onclick="navigate('create')" class="btn-primary px-4 py-2 rounded-lg">Create Your First Agent</button>
                </div>`;
                return;
            }
            g.innerHTML=d.agents.map(a=>`
                <div class="card agent-card rounded-xl p-4 hover:border-purple-500 transition" style="min-width:0;overflow:visible;">
                    <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;" class="cursor-pointer" onclick="openAgent('${a.id}', '${a.status}')">
                        <span style="font-size:1.75rem;flex-shrink:0;">${a.icon}</span>
                        <div style="flex:1;min-width:0;overflow:hidden;width:100%;">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <h3 class="agent-title" style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0;">${a.name}</h3>
                                <span class="agent-status-badge ${a.status === 'published' ? 'published' : 'draft'}">${a.status}</span>
                            </div>
                            <p class="agent-desc" style="font-size:0.875rem;margin-top:4px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;word-break:break-word;">${a.goal}</p>
                        </div>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border-color);padding-top:12px;margin-top:8px;">
                        <div class="agent-stats" style="display:flex;gap:16px;font-size:0.75rem;">
                            <span> ${a.tasks_count} tasks</span>
                            <span> ${a.tools_count} tools</span>
                        </div>
                        <div style="display:flex;gap:6px;">
                            ${a.status === 'draft' ? `<button data-permission="agents:publish" onclick="event.stopPropagation();publishAgent('${a.id}')" class="agent-btn publish" title="Publish"></button>` : ''}
                            <button data-permission="agents:edit" onclick="event.stopPropagation();editAgent('${a.id}')" class="agent-btn edit" title="Edit"></button>
                            <button data-permission="agents:delete" onclick="event.stopPropagation();deleteAgent('${a.id}')" class="agent-btn delete" title="Delete"></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openAgent(id, status){
            if(status === 'published'){
                // Open chat for published agents
                navigate('chat');
                setTimeout(()=>{
                    document.getElementById('chat-agent').value=id;
                    onAgentChange();
                },100);
            } else {
                // Open edit for draft agents
                editAgent(id);
            }
        }
        
        async function editAgent(id){
            // Fetch agent details
            const r = await fetch(API+'/api/agents/'+id);
            const agent = await r.json();
            
            // First, show the create page WITHOUT resetting
            // Hide all pages
            document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-create').classList.remove('hidden');
            
            // Update nav
            document.querySelectorAll('.sidebar-item, .mobile-nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-create')?.classList.add('active');
            
            // Process tasks - convert instruction objects to strings
            const tasks = (agent.tasks || []).map(task => ({
                name: task.name || '',
                description: task.description || '',
                instructions: (task.instructions || []).map(inst => 
                    typeof inst === 'string' ? inst : (inst.text || '')
                )
            }));
            
            // Store agent ID for update
            wizard.editId = id;
            wizard.name = agent.name || '';
            wizard.icon = agent.icon || '';
            wizard.goal = agent.goal || '';
            wizard.model = agent.model_id || '';
            wizard.modelReason = agent.model_reason || '';
            wizard.tasks = tasks;
            wizard.tool_ids = agent.tool_ids || [];
            wizard.generatedTools = [];
            wizard.guardrails = agent.guardrails || {};
            
            // Load personality from agent
            wizard.personality = agent.personality || null;
            wizard.personalityReason = agent.personality_reason || '';
            
            // Load tools into selectedDemoTools for UI display
            await loadAgentToolsToSelection(agent.tool_ids || [], agent.tools || []);
            
            // Set basic info in form
            document.getElementById('w-name').value = wizard.name;
            document.getElementById('w-icon').value = wizard.icon;
            document.getElementById('w-goal').value = wizard.goal;
            
            // Apply personality to sliders if exists
            if (wizard.personality) {
                const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
                traits.forEach(trait => {
                    const val = wizard.personality[trait];
                    if (val !== undefined) {
                        const slider = document.getElementById(`p-${trait}`);
                        const numInput = document.getElementById(`p-${trait}-num`);
                        if (slider) slider.value = val;
                        if (numInput) numInput.value = val;
                    }
                });
            }
            
            if(document.getElementById('w-model')) {
                document.getElementById('w-model').value = wizard.model;
            }
            
            // Update testAgent to point to existing agent
            testAgent = { id: id, convId: null };
            
            // Go to step 1 (Basics) to show the loaded data
            step = 1;
            updateStepsNew();
            
            // Render tasks
            renderTasks();
            
            // Load guardrails to form (for when user navigates to step 4)
            loadGuardrailsToForm();
            
            console.log('Editing agent:', id, wizard);
        }
        
        // Load agent's tools into selectedDemoTools for display
        async function loadAgentToolsToSelection(toolIds, toolsData) {
            // Reset selectedDemoTools
            selectedDemoTools = {
                apis: [],
                knowledge_bases: [],
                emails: [],
                webhooks: [],
                slacks: [],
                calendars: [],
                databases: [],
                websearches: [],
                websites: []
            };
            
            // If we have tools data from the agent response, use it
            if (toolsData && toolsData.length > 0) {
                toolsData.forEach(tool => {
                    addToolToSelection(tool);
                });
            } else if (toolIds && toolIds.length > 0) {
                // Otherwise, fetch tools from API
                try {
                    const response = await fetch(API + '/api/tools');
                    const data = await response.json();
                    const allTools = data.tools || [];
                    
                    toolIds.forEach(tid => {
                        // Handle prefixed IDs (api:xxx, kb:xxx)
                        const cleanId = tid.replace(/^(api:|kb:)/, '');
                        const tool = allTools.find(t => t.id === tid || t.id === cleanId);
                        if (tool) {
                            addToolToSelection(tool);
                        }
                    });
                } catch (e) {
                    console.error('Failed to load tools for agent:', e);
                }
            }
            
            // Update UI
            updateSelectedToolsList();
            console.log(' Loaded tools to selection:', selectedDemoTools);
        }
        
        // Add a tool to the correct category in selectedDemoTools
        function addToolToSelection(tool) {
            const typeToArray = {
                'api': 'apis',
                'knowledge': 'knowledge_bases',
                'document': 'knowledge_bases',
                'email': 'emails',
                'webhook': 'webhooks',
                'slack': 'slacks',
                'calendar': 'calendars',
                'database': 'databases',
                'websearch': 'websearches',
                'website': 'websites'
            };
            
            const arrayKey = typeToArray[tool.type] || 'apis';
            if (selectedDemoTools[arrayKey] && !selectedDemoTools[arrayKey].some(t => t.id === tool.id)) {
                selectedDemoTools[arrayKey].push(tool);
            }
        }
        
        async function deleteAgent(id){
            if(!confirm('Are you sure you want to delete this agent?')) return;
            
            try {
                await fetch(API+'/api/agents/'+id, { method: 'DELETE' });
                loadAgents();
            } catch(e) {
                alert('Failed to delete agent: ' + e.message);
            }
        }
        
        async function publishAgent(id){
            try {
                await fetch(API+'/api/agents/'+id, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: 'published' })
                });
                loadAgents();
                setAgentTab('published');
            } catch(e) {
                alert('Failed to publish agent: ' + e.message);
            }
        }

        function resetWizard(){
            step=1;
            wizard={name:'',icon:'',goal:'',personality:null,personalityReason:'',tasks:[],tool_ids:[],model:'',modelReason:'',editId:null};
            
            // Reset selectedDemoTools
            selectedDemoTools = {
                apis: [],
                knowledge_bases: [],
                emails: [],
                webhooks: [],
                slacks: [],
                calendars: [],
                databases: [],
                websearches: [],
                websites: []
            };
            tempToolSelection = {
                apis: [],
                knowledge_bases: [],
                emails: [],
                webhooks: [],
                slacks: [],
                calendars: [],
                databases: [],
                websearches: [],
                websites: []
            };
            
            updateSteps();
            document.getElementById('w-name').value='';
            document.getElementById('w-icon').value='';
            document.getElementById('w-goal').value='';
            
            // Reset personality sliders
            resetPersonalityDefaults();
            
            document.getElementById('w-tasks').innerHTML=`
                <div class="text-center py-8 text-gray-500">
                    <span class="text-4xl block mb-2"></span>
                    <p>No tasks yet. Click "+ Add Task" to create one.</p>
                    <p class="text-xs mt-2">Each task should have clear instructions for the LLM.</p>
                </div>
            `;
            document.getElementById('test-messages').innerHTML='';
            testAgent=null;
            
            // Update tools list display
            updateSelectedToolsList();
        }

        // Old wizard functions removed - using new 7-step wizard functions instead
        // updateStepsNew, nextStep, prevStep, collectTasksNew, loadWizardToolsNew, collectToolsNew, showPreviewNew

        function addTask(){
            const c=document.getElementById('w-tasks');
            // Clear empty state message
            const emptyState = c.querySelector('.text-center.py-8');
            if(emptyState) emptyState.remove();
            
            const id=Date.now();
            c.insertAdjacentHTML('beforeend',`
                <div class="card rounded-lg p-4" id="task-${id}">
                    <div class="flex gap-3">
                        <div class="flex-1 space-y-4">
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Task Name *</label>
                                <input type="text" class="task-name input-field w-full rounded px-3 py-2" placeholder="e.g., Answer HR Questions">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Task Description</label>
                                <textarea class="task-desc input-field w-full rounded px-3 py-2 text-sm" rows="2" placeholder="What does this task do?"></textarea>
                            </div>
                            <div class="bg-gray-800/50 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <span class="text-sm font-medium text-purple-400"> Instructions</span>
                                        <p class="text-xs text-gray-500">Step-by-step guide for the LLM to follow</p>
                                    </div>
                                    <button onclick="addInst(${id})" class="btn-secondary px-3 py-1 rounded text-xs">+ Add Step</button>
                                </div>
                                <div class="insts space-y-2"></div>
                                <p class="text-xs text-gray-500 mt-2 inst-empty">No instructions yet. Click "+ Add Step" to add instructions.</p>
                            </div>
                        </div>
                        <button onclick="document.getElementById('task-${id}').remove()" class="text-gray-500 hover:text-red-400 text-xl h-fit"></button>
                    </div>
                </div>
            `);
        }

        function addInst(tid){
            const container = document.querySelector('#task-'+tid+' .insts');
            const emptyMsg = document.querySelector('#task-'+tid+' .inst-empty');
            if(emptyMsg) emptyMsg.style.display = 'none';
            
            const stepNum = container.children.length + 1;
            container.insertAdjacentHTML('beforeend',`
                <div class="flex gap-2 items-start bg-gray-900/50 rounded p-2" id="inst-${Date.now()}">
                    <span class="text-purple-400 text-xs font-bold mt-1">${stepNum}.</span>
                    <input type="text" class="inst-text input-field flex-1 rounded px-2 py-1 text-sm" placeholder="e.g., First, greet the user politely">
                    <button onclick="removeInst(this)" class="text-gray-500 hover:text-red-400 text-sm"></button>
                </div>
            `);
        }
        
        function removeInst(btn){
            const instDiv = btn.parentElement;
            const container = instDiv.parentElement;
            const taskDiv = container.closest('[id^=task-]');
            instDiv.remove();
            
            // Update step numbers
            container.querySelectorAll('[id^=inst-]').forEach((inst, i) => {
                inst.querySelector('span').textContent = (i+1) + '.';
            });
            
            // Show empty message if no instructions
            if(container.children.length === 0){
                const emptyMsg = taskDiv.querySelector('.inst-empty');
                if(emptyMsg) emptyMsg.style.display = 'block';
            }
        }

        // Old collectTasks, loadWizardTools, collectTools, showReview removed
        // Using new functions: collectTasksNew, loadWizardToolsNew, collectToolsNew, showPreviewNew

        async function sendTest(){
            const inp=document.getElementById('test-input');
            const m=inp.value.trim();
            if(!m && testAttachments.length === 0)return;
            inp.value='';
            
            // Get user's timezone
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            // Show message with attachments
            let displayMsg = m;
            if(testAttachments.length > 0){
                displayMsg += '\n\n Attachments: ' + testAttachments.map(f => f.name).join(', ');
            }
            addTestMsg('user', displayMsg);
            
            if(!testAgent){
                const r=await fetch(API+'/api/agents',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:wizard.name,goal:wizard.goal,personality:wizard.personality,tasks:wizard.tasks,tool_ids:wizard.tool_ids,model_id:wizard.model,status:'draft'})});
                const d=await r.json();
                testAgent={id:d.agent_id};
            }
            try{
                let response;
                if(testAttachments.length > 0){
                    // Send with FormData for file upload
                    const formData = new FormData();
                    formData.append('message', m);
                    formData.append('timezone', userTimezone);
                    if(testAgent.convId) formData.append('conversation_id', testAgent.convId);
                    testAttachments.forEach(f => formData.append('files', f));
                    
                    response = await fetch(API+'/api/agents/'+testAgent.id+'/test-chat-with-files', {method:'POST', body: formData});
                } else {
                    response = await fetch(API+'/api/agents/'+testAgent.id+'/test-chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:m,conversation_id:testAgent.convId,timezone:userTimezone})});
                }
                const d=await response.json();
                testAgent.convId=d.conversation_id;
                
                // Show real extractions info if any
                if(d.real_extractions && d.real_extractions > 0) {
                    addTestMsg('system', ` Real OCR/extraction performed on ${d.real_extractions} file(s)`);
                }
                
                // Show tool calls if any (demo mode)
                if(d.tool_calls && d.tool_calls.length > 0) {
                    const toolsUsed = d.tool_calls.join(', ');
                    addTestMsg('system', ` Tools used: ${toolsUsed}`);
                }
                
                addTestMsg('assistant',d.response,d.sources);
                // Clear attachments after send
                testAttachments = [];
                renderTestAttachments();
            }catch(e){addTestMsg('error','Error: '+e.message);}
        }

        function addTestMsg(role,content,sources=[]){
            const c=document.getElementById('test-messages');
            const d=document.createElement('div');
            d.className='animate-fade-in';
            if(role==='user')d.innerHTML=`<div class="flex justify-end"><div class="bg-purple-600 rounded-2xl rounded-tr-sm px-3 py-2 max-w-[85%] text-sm">${esc(content)}</div></div>`;
            else if(role==='assistant')d.innerHTML=`<div class="flex"><div class="bg-gray-700 rounded-2xl rounded-tl-sm px-3 py-2 max-w-[85%] chat-content text-sm">${fmt(content)}</div></div>`;
            else if(role==='system')d.innerHTML=`<div class="text-center text-xs py-1 text-gray-500">${content}</div>`;
            else d.innerHTML=`<div class="text-center text-red-400 text-sm">${content}</div>`;
            c.appendChild(d);
            c.scrollTop=c.scrollHeight;
        }

        async function saveAgent(status){
            // Collect current wizard data
            if(typeof collectTasksNew === 'function') collectTasksNew();
            else if(typeof collectTasks === 'function') collectTasks();
            
            if(typeof collectToolsNew === 'function') collectToolsNew();
            else if(typeof collectTools === 'function') collectTools();
            
            if(typeof collectGuardrails === 'function') collectGuardrails();
            
            // Use wizard personality (from AI generation)
            if (!wizard.personality) {
                alert('Agent personality not configured. Please generate configuration first.');
                return;
            }
            
            const agentData = {
                name: wizard.name,
                icon: wizard.icon,
                goal: wizard.goal,
                personality: wizard.personality,
                personality_reason: wizard.personalityReason,
                guardrails: wizard.guardrails || {},
                tasks: wizard.tasks || [],
                tool_ids: wizard.tool_ids || [],
                model_id: wizard.model,
                model_reason: wizard.modelReason,
                status: status
            };
            
            console.log('Saving agent:', agentData);
            
            try {
                let response;
                // Check for valid agent ID (not undefined, not null, not empty string)
                const agentId = testAgent?.id || wizard.editId;
                const hasValidId = agentId && agentId !== 'undefined' && agentId.length > 0;
                
                if(hasValidId){
                    // Update existing agent
                    console.log('Updating agent:', agentId);
                    response = await fetch(API+'/api/agents/'+agentId, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(agentData)
                    });
                } else {
                    // Create new agent
                    console.log('Creating new agent');
                    response = await fetch(API+'/api/agents', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(agentData)
                    });
                }
                
                if(response.ok) {
                    alert(status === 'published' ? ' Agent Published!' : ' Saved as Draft!');
                    wizard.editId = null;
                    testAgent = null;
                    navigate('agents');
                    setAgentTab(status);
                } else {
                    const err = await response.json();
                    alert('Error: ' + (err.detail || 'Failed to save agent'));
                }
            } catch(e) {
                console.error('Save error:', e);
                alert('Error saving agent: ' + e.message);
            }
        }

        async function cleanupDuplicateTools() {
            if(!confirm('This will remove duplicate tools (keeping only the first of each name). Continue?')) return;
            
            try {
                console.log('Calling cleanup endpoint...');
                const r = await fetch(API + '/api/tools/cleanup-duplicates', { method: 'POST' });
                console.log('Response status:', r.status);
                
                if(!r.ok) {
                    const errorText = await r.text();
                    console.error('Cleanup error:', errorText);
                    alert('Error: ' + errorText);
                    return;
                }
                
                const data = await r.json();
                console.log('Cleanup result:', data);
                
                if(data.status === 'success') {
                    if(data.duplicates_removed > 0) {
                        alert(` Removed ${data.duplicates_removed} duplicate tools.\n\nRemaining tools: ${data.remaining_tools}`);
                    } else {
                        alert(' No duplicates found. All tools have unique names.');
                    }
                    loadTools(); // Refresh
                } else {
                    alert('Error: ' + (data.error || 'Failed to cleanup'));
                }
            } catch(e) {
                console.error('Cleanup exception:', e);
                alert('Failed to cleanup: ' + e.message);
            }
        }
        
        async function deleteAllTools() {
            if(!confirm(' WARNING: This will DELETE ALL TOOLS permanently!\n\nAre you sure?')) return;
            if(!confirm('This action cannot be undone. Type DELETE to confirm.')) return;
            
            try {
                const r = await fetch(API + '/api/tools/all', { method: 'DELETE' });
                const data = await r.json();
                
                if(data.status === 'success') {
                    alert(` Deleted ${data.deleted_count} tools.`);
                    loadTools();
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete'));
                }
            } catch(e) {
                alert('Failed to delete: ' + e.message);
            }
        }

        async function loadTools(){
            const r=await fetch(API+'/api/tools');
            const d=await r.json();
            allTools=d.tools;
            const g=document.getElementById('tools-grid');
            const icons={document:'',website:'',api:'',knowledge:''};
            if(!d.tools.length){
                g.innerHTML=`<div class="col-span-full text-center py-10 md:py-20 text-gray-500">
                    <span class="text-4xl md:text-6xl mb-4 block"></span>
                    <p class="mb-4">No tools yet</p>
                    <button data-permission="tools:create" onclick="showToolModal()" class="btn-primary px-4 py-2 rounded-lg">Create Tool</button>
                </div>`;
                return;
            }
            g.innerHTML=d.tools.map(t=>{
                const isFromDemo = t.config?.source === 'demo_kit';
                const sourceLabel = isFromDemo ? '<span class="tool-demo-badge">Demo</span>' : '';
                return `
                <div class="card tool-card rounded-xl p-4 hover:border-purple-500 transition cursor-pointer" 
                     style="min-width:0;" 
                     onclick="selectTool('${t.id}')"
                     ondblclick="viewTool('${t.id}')"
                     data-tool-id="${t.id}"
                     data-tool-name="${escHtml(t.name)}">
                    <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;">
                        <span style="font-size:1.75rem;flex-shrink:0;">${icons[t.type]||''}</span>
                        <div style="flex:1;min-width:0;overflow:hidden;">
                            <h3 class="tool-title" style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escHtml(t.name)}</h3>
                            <p class="tool-type">${t.type.toUpperCase()}${sourceLabel}</p>
                        </div>
                    </div>
                    <p class="tool-desc" style="font-size:0.875rem;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;word-break:break-word;">${escHtml(t.description||'No description')}</p>
                </div>
            `}).join('');

        }
        async function viewTool(id){
            const r=await fetch(API+'/api/tools/'+id);
            const t=await r.json();
            const icons={document:'',website:'',api:'',knowledge:'',email:'',webhook:'',websearch:'',slack:'',calendar:'',database:''};
            
            let h=`
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
                    <div class="flex items-center gap-4 flex-1 min-w-0">
                        <span class="text-3xl md:text-4xl">${icons[t.type]||''}</span>
                        <div class="min-w-0">
                            <h2 class="text-lg md:text-xl font-bold truncate">${t.name}</h2>
                            <p class="text-gray-400 text-sm truncate">${t.type.toUpperCase()} - ${t.description||'No description'}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="navigate('tools')" class="btn-secondary px-4 py-2 rounded-lg text-sm"> Back</button>
                        <button data-permission="tools:delete" onclick="delTool('${t.id}')" class="btn-danger px-4 py-2 rounded-lg text-sm"> Delete</button>
                    </div>
                </div>
            `;
            
            // ========== KNOWLEDGE BASE / DOCUMENT TYPE ==========
            if(t.type==='document' || t.type==='knowledge'){
                // Check if this is a Demo Kit knowledge base with embedded content
                const isDemoKb = t.config?.source === 'demo_kit';
                const demoContent = t.config?.content || '';
                const demoSections = t.config?.sections || [];
                
                h+=`<div class="card rounded-xl p-4 md:p-5 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold"> Knowledge Base ${isDemoKb ? '<span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-1 rounded ml-2">From Demo Lab</span>' : ''}</h3>
                        <span class="text-sm text-gray-400">${t.documents?.length || 0} document(s)</span>
                    </div>
                    
                    ${isDemoKb && demoSections.length > 0 ? `
                    <!-- Demo KB Content -->
                    <div class="mb-4 p-4 bg-gray-800/50 rounded-lg border border-purple-500/20">
                        <h4 class="text-sm font-medium text-purple-300 mb-3"> Embedded Content (${demoSections.length} sections)</h4>
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            ${demoSections.map((s, i) => `
                                <div class="bg-gray-800 rounded p-3">
                                    <h5 class="text-sm font-medium text-white mb-1">${escHtml(s.title || 'Section ' + (i+1))}</h5>
                                    <p class="text-xs text-gray-400 line-clamp-3">${escHtml((s.content || '').substring(0, 200))}${(s.content || '').length > 200 ? '...' : ''}</p>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="viewDemoKbFullContent('${t.id}')" class="mt-3 text-sm text-purple-400 hover:text-purple-300">View full content </button>
                    </div>
                    ` : ''}
                    
                    <!-- Upload Zone -->
                    <div class="drop-zone rounded-lg p-6 text-center mb-4 cursor-pointer border-2 border-dashed border-gray-600 hover:border-purple-500 transition" 
                         onclick="document.getElementById('det-input').click()"
                         ondragover="this.classList.add('border-purple-500');event.preventDefault()" 
                         ondragleave="this.classList.remove('border-purple-500')"
                         ondrop="handleDocDrop(event,'${t.id}')">
                        <input type="file" id="det-input" class="hidden" multiple accept=".pdf,.doc,.docx,.txt,.md,.csv,.xlsx" onchange="uploadDocs('${t.id}',event)">
                        <span class="text-3xl block mb-2"></span>
                        <p class="text-gray-400 text-sm">Drop files or click to upload</p>
                        <p class="text-xs text-gray-500 mt-1">Supports: PDF, DOC, DOCX, TXT, MD, CSV, XLSX</p>
                    </div>
                    
                    <!-- Add Entry Buttons - Available for ALL knowledge bases -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                        <button onclick="showAddTextEntryModal('${t.id}')" class="btn-secondary px-3 py-2 rounded-lg text-sm border border-dashed border-gray-600 hover:border-purple-500">
                             Text
                        </button>
                        <button onclick="showAddTableModal('${t.id}')" class="btn-secondary px-3 py-2 rounded-lg text-sm border border-dashed border-gray-600 hover:border-green-500">
                             Table
                        </button>
                        <button onclick="showAddUrlModal('${t.id}')" class="btn-secondary px-3 py-2 rounded-lg text-sm border border-dashed border-gray-600 hover:border-blue-500">
                             URL
                        </button>
                        <button onclick="document.getElementById('det-input').click()" class="btn-secondary px-3 py-2 rounded-lg text-sm border border-dashed border-gray-600 hover:border-yellow-500">
                             File
                        </button>
                    </div>
                    
                    <!-- Documents List -->
                    <div class="space-y-2" id="docs-list-${t.id}">
                        ${t.documents?.length ? t.documents.map(d=>`
                            <div class="flex items-center justify-between bg-gray-800 rounded-lg p-3 hover:bg-gray-750 transition ${d.is_demo ? 'border-l-2 border-purple-500' : ''} ${d.is_table ? 'border-l-2 border-green-500' : ''}">
                                <div class="flex items-center gap-3 min-w-0 flex-1 cursor-pointer" onclick="${d.is_table ? `viewTableEntry('${t.id}', '${escHtml(d.original_name)}')` : (d.is_demo ? `viewTextEntry('${t.id}', '${escHtml(d.original_name)}', true)` : `viewDocContent('${d.id}', '${escHtml(d.original_name)}')`)}">
                                    <span class="text-xl">${d.is_table ? '' : (d.is_demo ? '' : fileIcon(d.file_type))}</span>
                                    <div class="min-w-0">
                                        <div class="flex items-center gap-2">
                                            <p class="text-sm font-medium truncate">${d.original_name}</p>
                                            ${d.is_table ? '<span class="text-xs bg-green-500/20 text-green-300 px-1.5 py-0.5 rounded">Table</span>' : ''}
                                            ${d.is_demo && !d.is_table ? '<span class="text-xs bg-purple-500/20 text-purple-300 px-1.5 py-0.5 rounded">Text</span>' : ''}
                                        </div>
                                        <p class="text-xs text-gray-500">${d.is_table ? (d.rows_count || 0) + ' rows' : fmtSize(d.file_size)}  ${d.chunks_count || 0} chunks  <span class="status-${d.status}">${d.status}</span></p>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    ${d.is_table ? `
                                        <button onclick="viewTableEntry('${t.id}', '${escHtml(d.original_name)}')" class="p-2 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="View/Edit Table"></button>
                                        <button onclick="deleteTextEntry('${t.id}', '${escHtml(d.original_name)}')" class="p-2 hover:bg-red-900/50 rounded text-gray-400 hover:text-red-400" title="Delete"></button>
                                    ` : d.is_demo ? `
                                        <button onclick="viewTextEntry('${t.id}', '${escHtml(d.original_name)}', true)" class="p-2 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="View/Edit"></button>
                                        <button onclick="deleteTextEntry('${t.id}', '${escHtml(d.original_name)}')" class="p-2 hover:bg-red-900/50 rounded text-gray-400 hover:text-red-400" title="Delete"></button>
                                    ` : `
                                        <button onclick="viewDocContent('${d.id}', '${escHtml(d.original_name)}')" class="p-2 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="View Content"></button>
                                        <button onclick="downloadDoc('${d.id}', '${escHtml(d.original_name)}')" class="p-2 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="Download"></button>
                                        <button onclick="delDoc('${d.id}','${t.id}')" class="p-2 hover:bg-red-900/50 rounded text-gray-400 hover:text-red-400" title="Delete"></button>
                                    `}
                                </div>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-center py-8">No documents yet. Add content using the buttons above.</p>'}
                    </div>
                    
                    <!-- Scraped Pages List -->
                    ${t.scraped_pages?.length ? `
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <h4 class="text-sm font-medium text-gray-400 mb-2"> Scraped URLs (${t.scraped_pages.length})</h4>
                            <div class="space-y-2">
                                ${t.scraped_pages.map(p => `
                                    <div class="flex items-center justify-between bg-gray-800/50 rounded-lg p-2">
                                        <div class="flex items-center gap-2 min-w-0">
                                            <span></span>
                                            <a href="${escHtml(p.url)}" target="_blank" class="text-sm text-blue-400 hover:underline truncate">${escHtml(p.url)}</a>
                                        </div>
                                        <span class="text-xs text-gray-500">${p.chunks_extracted || 0} chunks</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Search/Query Section -->
                <div class="card rounded-xl p-4 md:p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold"> Ask Knowledge Base</h3>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-400">Mode:</label>
                            <select id="kb-mode-${t.id}" class="input-field rounded px-2 py-1 text-xs">
                                <option value="ai"> AI Answer</option>
                                <option value="raw"> Raw Search</option>
                            </select>
                            
                        </div>
                    </div>
                    <div class="flex gap-3 mb-4">
                        <input type="text" id="kb-search-${t.id}" class="input-field flex-1 rounded-lg px-4 py-2" 
                               placeholder="Ask a question..." 
                               onkeypress="if(event.key==='Enter')askKnowledgeBase('${t.id}')">
                        <button onclick="askKnowledgeBase('${t.id}')" class="btn-primary px-4 py-2 rounded-lg">Ask</button>
                    </div>
                    <div id="kb-results-${t.id}" class="hidden">
                        <!-- Results will appear here -->
                    </div>
                </div>`;
            }
            
            // ========== WEBSITE TYPE ==========
            if(t.type==='website'){
                h+=`<div class="card rounded-xl p-4 md:p-5 mb-4">
                    <h3 class="font-semibold mb-4"> Web Scraping</h3>
                    <div class="flex flex-col sm:flex-row gap-3 mb-4">
                        <input type="text" id="scrape-url" class="input-field flex-1 rounded-lg px-4 py-2" placeholder="https://example.com" value="${t.config?.url||''}">
                        <div class="flex gap-2 items-center">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="scrape-rec" class="rounded">
                                <span>Recursive</span>
                            </label>
                            <input type="number" id="scrape-max" class="input-field w-20 rounded px-2 py-2" value="10" placeholder="Max">
                            <button onclick="scrape('${t.id}')" class="btn-primary px-4 py-2 rounded-lg"> Scrape</button>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        ${t.scraped_pages?.length ? t.scraped_pages.map(p=>`
                            <div class="bg-gray-800 rounded-lg p-3 hover:bg-gray-750 transition">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="min-w-0 flex-1 cursor-pointer" onclick="viewPageContent('${p.id}')">
                                        <p class="text-sm truncate font-medium">${p.title||'Untitled'}</p>
                                        <p class="text-xs text-gray-500 truncate">${p.url}</p>
                                    </div>
                                    <div class="flex gap-1 ml-2">
                                        <button onclick="viewPageContent('${p.id}')" class="p-2 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="View Content"></button>
                                        <a href="${p.url}" target="_blank" class="p-2 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="Open URL"></a>
                                        <button onclick="delPage('${p.id}','${t.id}')" class="p-2 hover:bg-red-900/50 rounded text-gray-400 hover:text-red-400" title="Delete"></button>
                                    </div>
                                </div>
                                <div class="flex gap-3 text-xs text-gray-500">
                                    <span> ${p.chunks?.length || 0} chunks</span>
                                    <span> ${(p.content?.length || 0).toLocaleString()} chars</span>
                                    <span class="status-${p.status}">${p.status}</span>
                                </div>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-center py-4">No pages scraped yet. Enter a URL above.</p>'}
                    </div>
                </div>`;
            }
            
            // ========== EMAIL TYPE ==========
            if(t.type==='email'){
                const emailConfig = t.config || {};
                const provider = emailConfig.provider || 'Not configured';
                const email = emailConfig.email || '';
                const isConnected = !!emailConfig.provider;
                
                h+=`<div class="card rounded-xl p-4 md:p-5 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold"> Email Configuration</h3>
                        <span class="text-xs px-2 py-1 rounded ${isConnected ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                            ${isConnected ? ' Connected' : ' Not Connected'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Provider</label>
                            <div class="input-field w-full rounded px-3 py-2 bg-gray-800">${provider === 'google' ? ' Gmail' : provider === 'sendgrid' ? ' SendGrid' : provider === 'microsoft' ? ' Outlook' : provider}</div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Email Address</label>
                            <div class="input-field w-full rounded px-3 py-2 bg-gray-800">${email || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Send Email Form -->
                <div class="card rounded-xl p-4 md:p-5 mb-4">
                    <h3 class="font-semibold mb-4"> Send Email</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">To *</label>
                            <input type="email" id="email-to-${t.id}" class="input-field w-full rounded px-3 py-2" placeholder="recipient@example.com">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Subject *</label>
                            <input type="text" id="email-subject-${t.id}" class="input-field w-full rounded px-3 py-2" placeholder="Email subject">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Message *</label>
                            <textarea id="email-body-${t.id}" class="input-field w-full rounded px-3 py-2" rows="5" placeholder="Write your email message..."></textarea>
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="flex items-center gap-2 text-sm text-gray-400">
                                <input type="checkbox" id="email-html-${t.id}" class="w-4 h-4">
                                <span>Send as HTML</span>
                            </label>
                            <button onclick="sendEmailFromTool('${t.id}')" class="btn-primary px-6 py-2 rounded-lg flex items-center gap-2" ${!isConnected ? 'disabled' : ''}>
                                 Send Email
                            </button>
                        </div>
                    </div>
                    <div id="email-result-${t.id}" class="mt-4 hidden"></div>
                </div>`;
            }
            
            // ========== API TYPE ==========
            if(t.type==='api'){
                const apiConfig = t.api_config || {};
                const mockResponse = t.config?.mock_response ? JSON.stringify(t.config.mock_response, null, 2) : '{}';
                const isDemoMode = t.config?.demo_mode || false;
                
                h+=`<div class="card rounded-xl p-4 md:p-5 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold"> API Configuration</h3>
                        ${isDemoMode ? '<span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-1 rounded">Has Sample Response</span>' : ''}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Base URL</label>
                            <input type="text" id="api-base-url-${t.id}" class="input-field w-full rounded px-3 py-2" value="${apiConfig.base_url || ''}">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Endpoint Path</label>
                            <input type="text" id="api-endpoint-${t.id}" class="input-field w-full rounded px-3 py-2" value="${apiConfig.endpoint_path || ''}">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">HTTP Method</label>
                            <select id="api-method-${t.id}" class="input-field w-full rounded px-3 py-2">
                                <option value="GET" ${apiConfig.http_method === 'GET' ? 'selected' : ''}>GET</option>
                                <option value="POST" ${apiConfig.http_method === 'POST' ? 'selected' : ''}>POST</option>
                                <option value="PUT" ${apiConfig.http_method === 'PUT' ? 'selected' : ''}>PUT</option>
                                <option value="DELETE" ${apiConfig.http_method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                            </select>
                            
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Auth Type</label>
                            <select id="api-auth-${t.id}" class="input-field w-full rounded px-3 py-2">
                                <option value="none" ${apiConfig.auth_type === 'none' ? 'selected' : ''}>None</option>
                                <option value="api_key" ${apiConfig.auth_type === 'api_key' ? 'selected' : ''}>API Key</option>
                                <option value="bearer" ${apiConfig.auth_type === 'bearer' ? 'selected' : ''}>Bearer Token</option>
                                <option value="basic" ${apiConfig.auth_type === 'basic' ? 'selected' : ''}>Basic Auth</option>
                            </select>
                            
                        </div>
                    </div>
                    
                    <button onclick="updateApiConfig('${t.id}')" class="btn-secondary px-4 py-2 rounded-lg text-sm mb-4"> Save Configuration</button>
                    
                    <!-- Parameters -->
                    ${apiConfig.input_parameters?.length ? `
                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-300 mb-2">Parameters</h4>
                            <div class="space-y-2">
                                ${apiConfig.input_parameters.map(p=>`
                                    <div class="bg-gray-800 rounded px-3 py-2 flex items-center gap-3">
                                        <span class="text-purple-400 font-mono">{${p.name}}</span>
                                        <span class="text-xs text-gray-500">${p.data_type}</span>
                                        ${p.required ? '<span class="text-xs text-red-400">required</span>' : ''}
                                        <span class="text-xs text-gray-500 flex-1">${p.description || ''}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Sample Response Editor (for testing without real API) -->
                ${isDemoMode ? `
                <div class="card rounded-xl p-4 md:p-5 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold"> Sample Response</h3>
                        <button onclick="saveMockResponse('${t.id}')" class="btn-primary px-4 py-2 rounded-lg text-sm"> Save</button>
                    </div>
                    <textarea id="mock-response-${t.id}" class="input-field w-full rounded-lg px-4 py-3 font-mono text-sm" rows="12" placeholder="Enter JSON sample response...">${escHtml(mockResponse)}</textarea>
                    <p class="text-xs text-gray-500 mt-2">This JSON will be returned when the agent calls this API during testing.</p>
                </div>
                ` : ''}
                
                <!-- Output Transformation (Natural Language) -->
                <div class="card rounded-xl p-4 md:p-5 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold"> Output Transformation</h3>
                        <button onclick="saveOutputTransform('${t.id}')" class="btn-primary px-4 py-2 rounded-lg text-sm"> Save</button>
                    </div>
                    <p class="text-sm text-gray-400 mb-3">Describe in plain English how you want the API response to be transformed:</p>
                    <textarea id="output-transform-${t.id}" class="input-field w-full rounded-lg px-4 py-3 text-sm" rows="3" 
                              placeholder="Examples:&#10; Show only the total amount&#10; Extract just the employee names as a list&#10; Format as a summary with key metrics&#10; Convert to a simple success/failure message">${escHtml(t.config?.output_transform || '')}</textarea>
                    <div class="flex items-center gap-4 mt-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="transform-enabled-${t.id}" class="w-4 h-4 rounded" ${t.config?.transform_enabled ? 'checked' : ''}>
                            <span class="text-sm text-gray-400">Enable transformation</span>
                        </label>
                        <span class="text-xs text-gray-500">When enabled, the API response will be transformed by AI based on your instructions</span>
                    </div>
                </div>
                
                <!-- Test API -->
                <div class="card rounded-xl p-4 md:p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold"> Test API</h3>
                        <div class="flex gap-2">
                            ${isDemoMode ? `
                                <button onclick="analyzeApiParams('${t.id}')" class="btn-secondary px-3 py-1.5 rounded-lg text-sm" id="btn-analyze-${t.id}">
                                     Analyze Parameters
                                </button>
                                <button onclick="autoFillTestData('${t.id}')" class="btn-secondary px-3 py-1.5 rounded-lg text-sm">
                                     Auto-fill
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Parameters Container - Will be populated by LLM analysis or default -->
                    <div id="api-params-container-${t.id}">
                        ${apiConfig.input_parameters?.length ? `
                            <div class="space-y-4 mb-4">
                                ${apiConfig.input_parameters.map(p => `
                                <div class="bg-gray-800/50 rounded-lg p-3" id="param-wrapper-${p.name}">
                                    <div class="flex items-center justify-between mb-2">
                                        <label class="text-sm font-medium">${p.name} ${p.required ? '<span class="text-red-400">*</span>' : ''}</label>
                                        <span class="text-xs text-gray-500">${p.data_type || 'string'}</span>
                                    </div>
                                    <p class="text-xs text-gray-400 mb-2">${p.description || ''}</p>
                                    
                                    <!-- Default: Simple input, LLM will enhance this -->
                                    <div id="param-input-area-${p.name}">
                                        <textarea id="test-param-${p.name}" class="input-field w-full rounded px-3 py-2 text-sm" rows="2" 
                                                  placeholder="Enter ${p.name}..."></textarea>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                            
                            <div class="bg-blue-900/20 border border-blue-600/30 rounded-lg p-3 mb-4 text-sm" id="analyze-hint-${t.id}">
                                <p class="text-blue-300"> Click " Analyze Parameters" to get smart input options based on your API configuration.</p>
                            </div>
                        ` : '<p class="text-gray-500 text-sm mb-4">No parameters required for this API.</p>'}
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="testApiCall('${t.id}')" class="btn-primary px-6 py-2 rounded-lg">
                             Test Call
                        </button>
                        ${isDemoMode ? `
                            <span class="text-xs text-purple-400 flex items-center gap-1">
                                 Sample response configured
                            </span>
                        ` : ''}
                    </div>
                    
                    <div id="api-test-result-${t.id}" class="hidden mt-4">
                        <h4 class="text-sm font-medium text-gray-300 mb-2">Response:</h4>
                        <pre class="bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm"></pre>
                    </div>
                </div>`;
            }
            
            // ========== ANY OTHER TOOL TYPE (Generic Config) ==========
            const handledTypes = ['document', 'knowledge', 'website', 'api'];
            if(!handledTypes.includes(t.type)) {
                const configJson = JSON.stringify(t.config || {}, null, 2);
                const toolIcon = {
                    'database': '',
                    'slack': '',
                    'email': '',
                    'calendar': '',
                    'crm': '',
                    'code': '',
                    'websearch': '',
                    'ocr': ''
                }[t.type] || '';
                
                h+=`<div class="card rounded-xl p-4 md:p-5 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold">${toolIcon} ${t.type.toUpperCase()} Configuration</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Tool Name</label>
                            <input type="text" id="tool-name-${t.id}" class="input-field w-full rounded px-3 py-2" value="${escHtml(t.name || '')}">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Description</label>
                            <textarea id="tool-desc-${t.id}" class="input-field w-full rounded px-3 py-2" rows="2">${escHtml(t.description || '')}</textarea>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Configuration (JSON)</label>
                            <textarea id="tool-config-${t.id}" class="input-field w-full rounded-lg px-4 py-3 font-mono text-sm" rows="10" placeholder="{}">${escHtml(configJson)}</textarea>
                            <p class="text-xs text-gray-500 mt-1">Edit the JSON configuration for this tool</p>
                        </div>
                        
                        <button onclick="saveToolConfig('${t.id}')" class="btn-primary px-4 py-2 rounded-lg"> Save Configuration</button>
                    </div>
                </div>
                
                <!-- Test Section -->
                <div class="card rounded-xl p-4 md:p-5">
                    <h3 class="font-semibold mb-4"> Test Tool</h3>
                    <div class="space-y-3 mb-4">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Test Input</label>
                            <textarea id="tool-test-input-${t.id}" class="input-field w-full rounded px-3 py-2 font-mono text-sm" rows="3" placeholder='{"query": "test"}'>{}</textarea>
                        </div>
                    </div>
                    <button onclick="testGenericTool('${t.id}')" class="btn-primary px-4 py-2 rounded-lg mb-4"> Test</button>
                    
                    <div id="tool-test-result-${t.id}" class="hidden">
                        <h4 class="text-sm font-medium text-gray-300 mb-2">Result:</h4>
                        <pre class="bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm"></pre>
                    </div>
                </div>`;
            }
            
            document.getElementById('tool-detail').innerHTML=h;
            document.querySelectorAll('main>section').forEach(s=>s.classList.add('hidden'));
            document.getElementById('page-tool-detail').classList.remove('hidden');
        }

        async function uploadDocs(tid,e){
            const btn = e.target;
            for(const f of e.target.files){
                const fd=new FormData();
                fd.append('file',f);
                await fetch(API+'/api/tools/'+tid+'/documents',{method:'POST',body:fd});
            }
            viewTool(tid);
        }
        
        function handleDocDrop(e, tid) {
            e.preventDefault();
            e.target.classList.remove('border-purple-500');
            const files = e.dataTransfer.files;
            if(files.length > 0) {
                uploadDocsFromDrop(tid, files);
            }
        }
        
        async function uploadDocsFromDrop(tid, files) {
            for(const f of files) {
                const fd = new FormData();
                fd.append('file', f);
                await fetch(API+'/api/tools/'+tid+'/documents', {method:'POST', body:fd});
            }
            viewTool(tid);
        }
        
        async function delDoc(docId, toolId){
            if(!confirm('Delete this document?')) return;
            await fetch(API+'/api/documents/'+docId, {method:'DELETE'});
            if(toolId) viewTool(toolId);
            else location.reload();
        }
        
        // View Demo KB full content
        async function viewDemoKbFullContent(toolId) {
            try {
                const r = await fetch(API + '/api/tools/' + toolId);
                const t = await r.json();
                
                const sections = t.config?.sections || [];
                const content = t.config?.content || '';
                
                let html = `<p class="text-gray-400 mb-4">${escHtml(t.description)}</p>`;
                
                if (sections.length > 0) {
                    html += sections.map(s => `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-purple-400 mb-2">${escHtml(s.title)}</h3>
                            <div class="text-gray-300 whitespace-pre-wrap">${escHtml(s.content)}</div>
                        </div>
                    `).join('');
                } else if (content) {
                    html += `<div class="text-gray-300 whitespace-pre-wrap">${escHtml(content)}</div>`;
                }
                
                document.getElementById('kb-view-title').textContent = t.name;
                document.getElementById('kb-view-content').innerHTML = html;
                document.getElementById('kb-view-modal').classList.remove('hidden');
                document.getElementById('kb-view-modal').classList.add('flex');
            } catch (e) {
                alert('Failed to load content');
            }
        }

        async function viewDocContent(docId, docName) {
            try {
                const r = await fetch(API+'/api/documents/'+docId+'/content');
                const data = await r.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
                modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="bg-[#1e1e2e] rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="font-semibold truncate">${docName}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl"></button>
                        </div>
                        <div class="p-4 overflow-auto flex-1">
                            <pre class="whitespace-pre-wrap text-sm text-gray-300">${escHtml(data.content || data.text || 'No content available')}</pre>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-between text-xs text-gray-500">
                            <span>${data.chunks_count || 0} chunks indexed</span>
                            <span>${(data.content?.length || 0).toLocaleString()} characters</span>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch(e) {
                alert('Failed to load document: ' + e.message);
            }
        }
        
        async function viewTextEntry(toolId, docName, isTextEntry = false) {
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/data');
                const data = await r.json();
                
                // Find chunks for this document
                const chunks = data.chunks?.filter(c => c.source === docName) || [];
                const content = chunks.map(c => c.text).join('\n\n');
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
                modal.id = 'text-entry-modal';
                modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="bg-[#1e1e2e] rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <h3 class="font-semibold">${escHtml(docName)}</h3>
                                ${isTextEntry ? '<span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded">Text Entry</span>' : ''}
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl"></button>
                        </div>
                        <div class="p-4 flex-1 overflow-auto">
                            <label class="text-sm text-gray-400 mb-2 block">${isTextEntry ? 'Edit Content:' : 'Content (Read-only for uploaded files):'}</label>
                            <textarea id="text-entry-content" class="input-field w-full rounded-lg px-4 py-3 font-mono text-sm" rows="15" ${isTextEntry ? '' : 'readonly'}>${escHtml(content)}</textarea>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-between items-center">
                            <span class="text-xs text-gray-500">${chunks.length} chunk(s)  ${content.length.toLocaleString()} characters</span>
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('text-entry-modal').remove()" class="btn-secondary px-4 py-2 rounded-lg">Close</button>
                                ${isTextEntry ? `<button onclick="saveTextEntry('${toolId}', '${escHtml(docName)}')" class="btn-primary px-4 py-2 rounded-lg"> Save Changes</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch(e) {
                alert('Failed to load document: ' + e.message);
            }
        }
        
        // Keep old function names for backward compatibility
        async function viewDemoDocContent(toolId, docName) {
            return viewTextEntry(toolId, docName, true);
        }
        
        async function saveTextEntry(toolId, docName) {
            const content = document.getElementById('text-entry-content')?.value;
            if(!content) return alert('Content cannot be empty');
            
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/demo-document', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ source: docName, content })
                });
                const data = await r.json();
                
                if(data.status === 'success') {
                    alert(' Entry updated!');
                    document.getElementById('text-entry-modal')?.remove();
                    viewTool(toolId); // Refresh
                } else {
                    alert('Error: ' + (data.error || 'Failed to save'));
                }
            } catch(e) {
                alert('Failed to save: ' + e.message);
            }
        }
        
        // Keep old function name for backward compatibility
        async function saveDemoDocContent(toolId, docName) {
            return saveTextEntry(toolId, docName);
        }
        
        async function deleteTextEntry(toolId, docName) {
            if(!confirm(`Delete "${docName}"?`)) return;
            
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/demo-document/'+encodeURIComponent(docName), {
                    method: 'DELETE'
                });
                const data = await r.json();
                
                if(data.status === 'success') {
                    viewTool(toolId); // Refresh
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete'));
                }
            } catch(e) {
                alert('Failed to delete: ' + e.message);
            }
        }
        
        // Keep old function name for backward compatibility
        async function deleteDemoDoc(toolId, docName) {
            return deleteTextEntry(toolId, docName);
        }
        
        function showAddTextEntryModal(toolId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
            modal.id = 'add-text-entry-modal';
            modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div class="bg-[#1e1e2e] rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                        <h3 class="font-semibold"> Add Text Entry</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl"></button>
                    </div>
                    <div class="p-4 flex-1 overflow-auto space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Title *</label>
                            <input type="text" id="new-text-entry-title" class="input-field w-full rounded-lg px-4 py-2" placeholder="e.g., Company Policy, FAQ, Product Info">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Content *</label>
                            <textarea id="new-text-entry-content" class="input-field w-full rounded-lg px-4 py-3 font-mono text-sm" rows="12" placeholder="Enter the text content that will be searchable by the agent..."></textarea>
                            <p class="text-xs text-gray-500 mt-1"> Tip: You can add multiple entries for different topics to organize your knowledge base.</p>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
                        <button onclick="document.getElementById('add-text-entry-modal').remove()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                        <button onclick="addTextEntry('${toolId}')" class="btn-primary px-4 py-2 rounded-lg"> Add Entry</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Keep old function name for backward compatibility
        function showAddDemoDocModal(toolId) {
            return showAddTextEntryModal(toolId);
        }
        
        async function addTextEntry(toolId) {
            const title = document.getElementById('new-text-entry-title')?.value?.trim();
            const content = document.getElementById('new-text-entry-content')?.value?.trim();
            
            if(!title || !content) {
                return alert('Please enter both title and content');
            }
            
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/demo-document', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ source: title, content })
                });
                const data = await r.json();
                
                if(data.status === 'success') {
                    alert(' Entry added!');
                    document.getElementById('add-text-entry-modal')?.remove();
                    viewTool(toolId); // Refresh
                } else {
                    alert('Error: ' + (data.error || 'Failed to add'));
                }
            } catch(e) {
                alert('Failed to add: ' + e.message);
            }
        }
        
        // Keep old function name for backward compatibility
        async function addDemoDoc(toolId) {
            return addTextEntry(toolId);
        }
        
        // ========== URL SCRAPING FUNCTIONS ==========
        function showAddUrlModal(toolId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
            modal.id = 'add-url-modal';
            modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div class="bg-[#1e1e2e] rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                        <h3 class="font-semibold"> Add URL / Scrape Website</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl"></button>
                    </div>
                    <div class="p-4 flex-1 overflow-auto space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Website URL *</label>
                            <input type="url" id="scrape-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://example.com/page">
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="scrape-recursive" class="w-4 h-4 rounded">
                                <span class="text-sm">Scrape linked pages (recursive)</span>
                            </label>
                        </div>
                        
                        <div id="scrape-options" class="hidden">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Max Pages</label>
                                    <input type="number" id="scrape-max" class="input-field w-full rounded-lg px-4 py-2" value="10" min="1" max="100">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Max Depth</label>
                                    <input type="number" id="scrape-depth" class="input-field w-full rounded-lg px-4 py-2" value="2" min="1" max="5">
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-3 text-sm">
                            <p class="text-blue-300"> The content will be extracted and added to your knowledge base for the agent to search.</p>
                        </div>
                        
                        <div id="scrape-status" class="hidden"></div>
                    </div>
                    <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
                        <button onclick="document.getElementById('add-url-modal').remove()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                        <button onclick="scrapeUrlForTool('${toolId}')" id="btn-scrape" class="btn-primary px-4 py-2 rounded-lg"> Scrape URL</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Toggle recursive options
            document.getElementById('scrape-recursive').onchange = (e) => {
                document.getElementById('scrape-options').classList.toggle('hidden', !e.target.checked);
            };
        }
        
        async function scrapeUrlForTool(toolId) {
            const url = document.getElementById('scrape-url')?.value?.trim();
            if (!url) return alert('Please enter a URL');
            if (!url.startsWith('http')) return alert('Please enter a valid URL starting with http:// or https://');
            
            const recursive = document.getElementById('scrape-recursive')?.checked || false;
            const maxPages = parseInt(document.getElementById('scrape-max')?.value) || 10;
            const maxDepth = parseInt(document.getElementById('scrape-depth')?.value) || 2;
            
            const statusEl = document.getElementById('scrape-status');
            const btnEl = document.getElementById('btn-scrape');
            
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<div class="flex items-center gap-2 text-blue-300"><span class="animate-spin"></span> Scraping website...</div>';
            btnEl.disabled = true;
            btnEl.textContent = 'Scraping...';
            
            try {
                const r = await fetch(API + '/api/tools/' + toolId + '/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        url, 
                        recursive, 
                        max_pages: maxPages,
                        max_depth: maxDepth
                    })
                });
                
                const data = await r.json();
                
                if (r.ok) {
                    statusEl.innerHTML = '<div class="text-green-300"> Successfully scraped! Extracted ' + (data.chunks_extracted || 0) + ' chunks.</div>';
                    setTimeout(() => {
                        document.getElementById('add-url-modal')?.remove();
                        viewTool(toolId); // Refresh
                    }, 1500);
                } else {
                    statusEl.innerHTML = '<div class="text-red-300"> ' + (data.detail || data.error || 'Failed to scrape') + '</div>';
                    btnEl.disabled = false;
                    btnEl.textContent = ' Scrape URL';
                }
            } catch (e) {
                statusEl.innerHTML = '<div class="text-red-300"> Error: ' + e.message + '</div>';
                btnEl.disabled = false;
                btnEl.textContent = ' Scrape URL';
            }
        }
        
        // ========== TABLE FUNCTIONS ==========
        let currentTableData = { headers: [], rows: [] };
        let currentTableToolId = null;
        let currentTableName = null;
        
        function showAddTableModal(toolId) {
            currentTableToolId = toolId;
            currentTableData = { headers: ['Column 1', 'Column 2', 'Column 3'], rows: [['', '', ''], ['', '', '']] };
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
            modal.id = 'add-table-modal';
            modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div class="bg-[#1e1e2e] rounded-xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                        <h3 class="font-semibold"> Add Table</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl"></button>
                    </div>
                    <div class="p-4 flex-1 overflow-auto space-y-4">
                        <!-- Table Name -->
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Table Name *</label>
                            <input type="text" id="table-name" class="input-field w-full rounded-lg px-4 py-2" placeholder="e.g., Employee Directory, Product Catalog">
                        </div>
                        
                        <!-- Import Options -->
                        <div class="flex gap-3 items-center p-3 bg-gray-800/50 rounded-lg">
                            <span class="text-sm text-gray-400">Import from:</span>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="file" id="table-file-input" class="hidden" accept=".csv,.xlsx,.xls" onchange="importTableFromFile(event)">
                                <button onclick="document.getElementById('table-file-input').click()" class="btn-secondary px-3 py-1.5 rounded text-sm">
                                     CSV/Excel
                                </button>
                            </label>
                            <span class="text-gray-500">or create manually below</span>
                        </div>
                        
                        <!-- Table Size Controls -->
                        <div class="flex gap-4 items-center">
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400">Columns:</label>
                                <button onclick="changeTableCols(-1)" class="btn-secondary w-8 h-8 rounded">-</button>
                                <span id="col-count" class="w-8 text-center">3</span>
                                <button onclick="changeTableCols(1)" class="btn-secondary w-8 h-8 rounded">+</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400">Rows:</label>
                                <button onclick="changeTableRows(-1)" class="btn-secondary w-8 h-8 rounded">-</button>
                                <span id="row-count" class="w-8 text-center">2</span>
                                <button onclick="changeTableRows(1)" class="btn-secondary w-8 h-8 rounded">+</button>
                            </div>
                        </div>
                        
                        <!-- Editable Table -->
                        <div class="overflow-x-auto">
                            <div id="table-editor"></div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-700 flex justify-between items-center">
                        <span class="text-xs text-gray-500"> Click any cell to edit. Table data will be searchable by the agent.</span>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('add-table-modal').remove()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                            <button onclick="saveNewTable()" class="btn-primary px-4 py-2 rounded-lg"> Add Table</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            renderTableEditor();
        }
        
        function renderTableEditor(containerId = 'table-editor') {
            const container = document.getElementById(containerId);
            if(!container) return;
            
            let html = '<table class="w-full border-collapse text-sm">';
            
            // Headers row
            html += '<tr>';
            currentTableData.headers.forEach((h, i) => {
                html += `<th class="border border-gray-600 p-0">
                    <input type="text" value="${escHtml(h)}" 
                           onchange="currentTableData.headers[${i}]=this.value" 
                           class="w-full bg-gray-700 text-white font-semibold px-3 py-2 text-center outline-none focus:bg-gray-600"
                           placeholder="Header ${i+1}">
                </th>`;
            });
            html += '</tr>';
            
            // Data rows
            currentTableData.rows.forEach((row, ri) => {
                html += '<tr>';
                row.forEach((cell, ci) => {
                    html += `<td class="border border-gray-700 p-0">
                        <input type="text" value="${escHtml(cell)}" 
                               onchange="currentTableData.rows[${ri}][${ci}]=this.value"
                               class="w-full bg-gray-800 px-3 py-2 outline-none focus:bg-gray-700"
                               placeholder="">
                    </td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            container.innerHTML = html;
            
            // Update counters
            const colCount = document.getElementById('col-count');
            const rowCount = document.getElementById('row-count');
            if(colCount) colCount.textContent = currentTableData.headers.length;
            if(rowCount) rowCount.textContent = currentTableData.rows.length;
        }
        
        function changeTableCols(delta) {
            const newCount = currentTableData.headers.length + delta;
            if(newCount < 1 || newCount > 20) return;
            
            if(delta > 0) {
                currentTableData.headers.push(`Column ${newCount}`);
                currentTableData.rows.forEach(row => row.push(''));
            } else {
                currentTableData.headers.pop();
                currentTableData.rows.forEach(row => row.pop());
            }
            renderTableEditor();
        }
        
        function changeTableRows(delta) {
            const newCount = currentTableData.rows.length + delta;
            if(newCount < 1 || newCount > 100) return;
            
            if(delta > 0) {
                currentTableData.rows.push(new Array(currentTableData.headers.length).fill(''));
            } else {
                currentTableData.rows.pop();
            }
            renderTableEditor();
        }
        
        function importTableFromFile(event) {
            const file = event.target.files[0];
            if(!file) return;
            
            const fileName = file.name.toLowerCase();
            
            if(fileName.endsWith('.csv')) {
                // Parse CSV
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    parseCSVToTable(text);
                };
                reader.readAsText(file);
            } else if(fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                // Parse Excel using SheetJS
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // Dynamic import SheetJS
                        if(!window.XLSX) {
                            const script = document.createElement('script');
                            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                            document.head.appendChild(script);
                            await new Promise(r => script.onload = r);
                        }
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        if(jsonData.length > 0) {
                            currentTableData.headers = jsonData[0].map(h => String(h || ''));
                            currentTableData.rows = jsonData.slice(1).map(row => 
                                currentTableData.headers.map((_, i) => String(row[i] || ''))
                            );
                            if(currentTableData.rows.length === 0) {
                                currentTableData.rows = [new Array(currentTableData.headers.length).fill('')];
                            }
                            renderTableEditor();
                            
                            // Auto-fill table name from filename
                            const tableName = document.getElementById('table-name');
                            if(tableName && !tableName.value) {
                                tableName.value = file.name.replace(/\.(csv|xlsx|xls)$/i, '');
                            }
                        }
                    } catch(err) {
                        alert('Failed to parse Excel file: ' + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }
        
        function parseCSVToTable(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim());
            if(lines.length === 0) return;
            
            // Simple CSV parser (handles basic cases)
            const parseRow = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for(let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if(char === '"') {
                        inQuotes = !inQuotes;
                    } else if(char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            };
            
            currentTableData.headers = parseRow(lines[0]);
            currentTableData.rows = lines.slice(1).map(line => {
                const row = parseRow(line);
                // Ensure row has same length as headers
                while(row.length < currentTableData.headers.length) row.push('');
                return row.slice(0, currentTableData.headers.length);
            });
            
            if(currentTableData.rows.length === 0) {
                currentTableData.rows = [new Array(currentTableData.headers.length).fill('')];
            }
            
            renderTableEditor();
        }
        
        async function saveNewTable() {
            const tableName = document.getElementById('table-name')?.value?.trim();
            if(!tableName) return alert('Please enter a table name');
            if(currentTableData.headers.length === 0) return alert('Table must have at least one column');
            
            // Convert table to searchable text format
            const tableContent = convertTableToText(tableName, currentTableData);
            
            try {
                const r = await fetch(API+'/api/tools/'+currentTableToolId+'/table-entry', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        source: tableName, 
                        content: tableContent,
                        table_data: currentTableData
                    })
                });
                const data = await r.json();
                
                if(data.status === 'success') {
                    alert(' Table added!');
                    document.getElementById('add-table-modal')?.remove();
                    viewTool(currentTableToolId);
                } else {
                    alert('Error: ' + (data.error || 'Failed to add'));
                }
            } catch(e) {
                alert('Failed to add: ' + e.message);
            }
        }
        
        function convertTableToText(tableName, tableData) {
            let text = `## ${tableName}\n\n`;
            
            // Add as markdown table
            text += '| ' + tableData.headers.join(' | ') + ' |\n';
            text += '| ' + tableData.headers.map(() => '---').join(' | ') + ' |\n';
            tableData.rows.forEach(row => {
                text += '| ' + row.join(' | ') + ' |\n';
            });
            
            text += '\n\n### Records:\n\n';
            
            // Also add as structured text for better search
            tableData.rows.forEach((row, i) => {
                text += `**Record ${i + 1}:**\n`;
                tableData.headers.forEach((h, j) => {
                    if(row[j]) text += `- ${h}: ${row[j]}\n`;
                });
                text += '\n';
            });
            
            return text;
        }
        
        async function viewTableEntry(toolId, tableName) {
            currentTableToolId = toolId;
            currentTableName = tableName;
            
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/table-entry/'+encodeURIComponent(tableName));
                const data = await r.json();
                
                if(data.table_data) {
                    currentTableData = data.table_data;
                } else {
                    // Try to parse from content
                    currentTableData = { headers: ['Column 1'], rows: [['No data']] };
                }
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
                modal.id = 'view-table-modal';
                modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="bg-[#1e1e2e] rounded-xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <h3 class="font-semibold">${escHtml(tableName)}</h3>
                                <span class="text-xs bg-green-500/20 text-green-300 px-2 py-0.5 rounded">Table</span>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl"></button>
                        </div>
                        <div class="p-4 flex-1 overflow-auto space-y-4">
                            <!-- Table Size Controls -->
                            <div class="flex gap-4 items-center">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm text-gray-400">Columns:</label>
                                    <button onclick="changeTableCols(-1);renderTableEditor('view-table-editor')" class="btn-secondary w-8 h-8 rounded">-</button>
                                    <span id="col-count" class="w-8 text-center">${currentTableData.headers.length}</span>
                                    <button onclick="changeTableCols(1);renderTableEditor('view-table-editor')" class="btn-secondary w-8 h-8 rounded">+</button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm text-gray-400">Rows:</label>
                                    <button onclick="changeTableRows(-1);renderTableEditor('view-table-editor')" class="btn-secondary w-8 h-8 rounded">-</button>
                                    <span id="row-count" class="w-8 text-center">${currentTableData.rows.length}</span>
                                    <button onclick="changeTableRows(1);renderTableEditor('view-table-editor')" class="btn-secondary w-8 h-8 rounded">+</button>
                                </div>
                                <button onclick="exportTableToCSV('${escHtml(tableName)}')" class="btn-secondary px-3 py-1.5 rounded text-sm ml-auto">
                                     Export CSV
                                </button>
                            </div>
                            
                            <!-- Editable Table -->
                            <div class="overflow-x-auto">
                                <div id="view-table-editor"></div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-between items-center">
                            <span class="text-xs text-gray-500">${currentTableData.headers.length} columns  ${currentTableData.rows.length} rows</span>
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('view-table-modal').remove()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                                <button onclick="updateTableEntry()" class="btn-primary px-4 py-2 rounded-lg"> Save Changes</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                renderTableEditor('view-table-editor');
                
            } catch(e) {
                alert('Failed to load table: ' + e.message);
            }
        }
        
        async function updateTableEntry() {
            const tableContent = convertTableToText(currentTableName, currentTableData);
            
            try {
                const r = await fetch(API+'/api/tools/'+currentTableToolId+'/table-entry/'+encodeURIComponent(currentTableName), {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        content: tableContent,
                        table_data: currentTableData
                    })
                });
                const data = await r.json();
                
                if(data.status === 'success') {
                    alert(' Table updated!');
                    document.getElementById('view-table-modal')?.remove();
                    viewTool(currentTableToolId);
                } else {
                    alert('Error: ' + (data.error || 'Failed to update'));
                }
            } catch(e) {
                alert('Failed to update: ' + e.message);
            }
        }
        
        function exportTableToCSV(tableName) {
            let csv = currentTableData.headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + '\n';
            currentTableData.rows.forEach(row => {
                csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = tableName + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function downloadDoc(docId, docName) {
            try {
                const r = await fetch(API+'/api/documents/'+docId+'/download');
                const blob = await r.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = docName;
                a.click();
                URL.revokeObjectURL(url);
            } catch(e) {
                alert('Failed to download: ' + e.message);
            }
        }
        
        // Send email using email tool
        async function sendEmailFromTool(toolId) {
            const toEl = document.getElementById(`email-to-${toolId}`);
            const subjectEl = document.getElementById(`email-subject-${toolId}`);
            const bodyEl = document.getElementById(`email-body-${toolId}`);
            const htmlEl = document.getElementById(`email-html-${toolId}`);
            const resultEl = document.getElementById(`email-result-${toolId}`);
            
            const to = toEl?.value?.trim();
            const subject = subjectEl?.value?.trim();
            const body = bodyEl?.value?.trim();
            const html = htmlEl?.checked || false;
            
            if (!to) return alert('Please enter recipient email');
            if (!subject) return alert('Please enter email subject');
            if (!body) return alert('Please enter email message');
            
            // Show loading
            resultEl.classList.remove('hidden');
            resultEl.innerHTML = `
                <div class="flex items-center gap-2 text-blue-400 p-3 bg-blue-500/10 rounded-lg">
                    <span class="animate-spin"></span>
                    <span>Sending email...</span>
                </div>
            `;
            
            try {
                const response = await fetch(API + `/api/tools/${toolId}/send-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to, subject, body, html })
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    resultEl.innerHTML = `
                        <div class="p-3 bg-green-500/10 border border-green-500/30 rounded-lg">
                            <div class="flex items-center gap-2 text-green-400 font-medium">
                                <span></span>
                                <span>Email sent successfully!</span>
                            </div>
                            <p class="text-sm text-gray-400 mt-1">
                                To: ${escHtml(to)}<br>
                                Subject: ${escHtml(subject)}
                            </p>
                        </div>
                    `;
                    // Clear form
                    toEl.value = '';
                    subjectEl.value = '';
                    bodyEl.value = '';
                } else {
                    resultEl.innerHTML = `
                        <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                            <div class="flex items-center gap-2 text-red-400 font-medium">
                                <span></span>
                                <span>Failed to send email</span>
                            </div>
                            <p class="text-sm text-gray-400 mt-1">${escHtml(data.detail || data.message || 'Unknown error')}</p>
                        </div>
                    `;
                }
            } catch (err) {
                resultEl.innerHTML = `
                    <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                        <div class="flex items-center gap-2 text-red-400">
                            <span></span>
                            <span>Error: ${escHtml(err.message)}</span>
                        </div>
                    </div>
                `;
            }
        }
        
        async function askKnowledgeBase(toolId) {
            const query = document.getElementById('kb-search-'+toolId)?.value;
            if(!query) return alert('Please enter a question');
            
            const mode = document.getElementById('kb-mode-'+toolId)?.value || 'ai';
            const resultsDiv = document.getElementById('kb-results-'+toolId);
            
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = `
                <div class="flex items-center gap-2 text-gray-400 py-4">
                    <span class="animate-spin"></span>
                    <span>${mode === 'ai' ? 'Thinking...' : 'Searching...'}</span>
                </div>
            `;
            
            try {
                if (mode === 'ai') {
                    // AI-powered answer
                    const r = await fetch(API+'/api/tools/'+toolId+'/ask', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ query, top_k: 5 })
                    });
                    const data = await r.json();
                    
                    resultsDiv.innerHTML = `
                        <div class="space-y-4">
                            <!-- AI Answer -->
                            <div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-purple-500/30 rounded-lg p-4">
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl"></span>
                                    <div class="flex-1">
                                        <p class="text-gray-200 whitespace-pre-wrap">${escHtml(data.answer || 'No answer generated')}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sources -->
                            ${data.sources?.length ? `
                                <div class="pt-2 border-t border-gray-700">
                                    <p class="text-xs text-gray-500 mb-2"> Sources used:</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${data.sources.map(s => `
                                            <span class="text-xs bg-gray-800 text-gray-400 px-2 py-1 rounded">
                                                ${escHtml(s.source)} (${s.score}%)
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Confidence -->
                            <div class="flex items-center gap-2 text-xs text-gray-500">
                                <span>Confidence:</span>
                                <div class="flex-1 bg-gray-700 rounded-full h-2 max-w-[100px]">
                                    <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-2 rounded-full" style="width: ${data.confidence || 0}%"></div>
                                </div>
                                <span>${data.confidence || 0}%</span>
                            </div>
                        </div>
                    `;
                } else {
                    // Raw search mode
                    const r = await fetch(API+'/api/tools/'+toolId+'/search', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ query, top_k: 5 })
                    });
                    const data = await r.json();
                    
                    if(data.results?.length) {
                        resultsDiv.innerHTML = `
                            <h4 class="text-sm font-medium text-gray-300 mb-3">Found ${data.results.length} results:</h4>
                            <div class="space-y-3">
                                ${data.results.map((r, i) => `
                                    <div class="bg-gray-800 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs text-purple-400">#${i+1} - Score: ${(r.score * 100).toFixed(1)}%</span>
                                            <span class="text-xs text-gray-500">${r.source || 'Unknown source'}</span>
                                        </div>
                                        <p class="text-sm text-gray-300">${escHtml(r.text?.substring(0, 500) || '')}${r.text?.length > 500 ? '...' : ''}</p>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        resultsDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No results found. Try a different query.</p>';
                    }
                }
            } catch(e) {
                resultsDiv.innerHTML = `<p class="text-red-400">Error: ${e.message}</p>`;
            }
        }
        
        // Keep old function for backward compatibility
        async function testKnowledgeSearch(toolId) {
            document.getElementById('kb-mode-'+toolId).value = 'raw';
            return askKnowledgeBase(toolId);
        }
        
        async function viewPageContent(pageId) {
            try {
                const r = await fetch(API+'/api/scraped-pages/'+pageId);
                const data = await r.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
                modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="bg-[#1e1e2e] rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-gray-700">
                            <h3 class="font-semibold truncate">${data.title || 'Page Content'}</h3>
                            <a href="${data.url}" target="_blank" class="text-xs text-purple-400 hover:underline">${data.url}</a>
                        </div>
                        <div class="p-4 overflow-auto flex-1">
                            <pre class="whitespace-pre-wrap text-sm text-gray-300">${escHtml(data.content || 'No content')}</pre>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-between text-xs text-gray-500">
                            <span>${data.chunks?.length || 0} chunks</span>
                            <span>${(data.content?.length || 0).toLocaleString()} characters</span>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch(e) {
                alert('Failed to load page: ' + e.message);
            }
        }
        
        async function delPage(pageId, toolId) {
            if(!confirm('Delete this page?')) return;
            await fetch(API+'/api/scraped-pages/'+pageId, {method:'DELETE'});
            if(toolId) viewTool(toolId);
            else location.reload();
        }
        
        async function updateApiConfig(toolId) {
            const config = {
                base_url: document.getElementById('api-base-url-'+toolId)?.value,
                endpoint_path: document.getElementById('api-endpoint-'+toolId)?.value,
                http_method: document.getElementById('api-method-'+toolId)?.value,
                auth_type: document.getElementById('api-auth-'+toolId)?.value
            };
            
            try {
                await fetch(API+'/api/tools/'+toolId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ api_config: config })
                });
                alert(' Configuration saved!');
            } catch(e) {
                alert('Failed to save: ' + e.message);
            }
        }
        
        async function saveMockResponse(toolId) {
            const textarea = document.getElementById('mock-response-'+toolId);
            if(!textarea) return;
            
            try {
                const mockResponse = JSON.parse(textarea.value);
                await fetch(API+'/api/tools/'+toolId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ config: { mock_response: mockResponse, demo_mode: true } })
                });
                alert(' Mock response saved!');
            } catch(e) {
                if(e instanceof SyntaxError) {
                    alert('Invalid JSON format. Please check your input.');
                } else {
                    alert('Failed to save: ' + e.message);
                }
            }
        }
        
        async function saveOutputTransform(toolId) {
            const textarea = document.getElementById('output-transform-'+toolId);
            const checkbox = document.getElementById('transform-enabled-'+toolId);
            if(!textarea) return;
            
            const outputTransform = textarea.value.trim();
            const transformEnabled = checkbox?.checked || false;
            
            try {
                // Get current tool config first
                const r = await fetch(API+'/api/tools/'+toolId);
                const tool = await r.json();
                const currentConfig = tool.config || {};
                
                // Update with new transform settings
                await fetch(API+'/api/tools/'+toolId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        config: { 
                            ...currentConfig,
                            output_transform: outputTransform,
                            transform_enabled: transformEnabled
                        } 
                    })
                });
                alert(' Output transformation saved!');
            } catch(e) {
                alert('Failed to save: ' + e.message);
            }
        }
        
        // ========== SMART API TESTING FUNCTIONS ==========
        
        async function analyzeApiParams(toolId) {
            const btn = document.getElementById('btn-analyze-' + toolId);
            const hint = document.getElementById('analyze-hint-' + toolId);
            
            if (btn) {
                btn.innerHTML = '<span class="animate-pulse"> AI Analyzing...</span>';
                btn.disabled = true;
            }
            
            try {
                const r = await fetch(API + '/api/tools/' + toolId + '/analyze-params', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await r.json();
                const params = data.parameters;
                
                if (data.error) {
                    alert('Analysis failed: ' + data.error);
                    if (btn) {
                        btn.innerHTML = ' Failed';
                        setTimeout(() => { btn.innerHTML = ' Analyze Parameters'; btn.disabled = false; }, 2000);
                    }
                    return;
                }
            
                if (params && params.length > 0) {
                    // Update each parameter with smart input options
                    params.forEach(param => {
                        const inputArea = document.getElementById('param-input-area-' + param.name);
                        if (!inputArea) return;
                        
                        // Build smart input based on LLM analysis
                        let inputHtml = `
                            <div class="flex flex-wrap gap-2 mb-2">
                                <button onclick="toggleParamInputMode('${param.name}', 'text')" 
                                        id="btn-text-${param.name}" 
                                        class="text-xs px-2 py-1 rounded bg-purple-600 text-white">
                                     Text
                                </button>
                        `;
                        
                        // Add file upload if LLM suggests it
                        if (param.supports_file_upload) {
                            inputHtml += `
                                <button onclick="toggleParamInputMode('${param.name}', 'file')" 
                                        id="btn-file-${param.name}"
                                        class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-300 hover:bg-gray-600">
                                     ${param.file_upload_label || 'Upload File'}
                                </button>
                            `;
                        }
                        
                        // Add quick generate button
                        inputHtml += `
                                <button onclick="quickGenerate('${param.name}', '${toolId}')" 
                                        class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-300 hover:bg-gray-600">
                                     Generate
                                </button>
                            </div>
                        `;
                        
                        // Text input
                        inputHtml += `
                            <div id="input-text-${param.name}">
                                <textarea id="test-param-${param.name}" class="input-field w-full rounded px-3 py-2 text-sm" 
                                          rows="${param.suggested_rows || 2}" 
                                          placeholder="${param.placeholder || 'Enter ' + param.name}...">${param.sample_value || ''}</textarea>
                            </div>
                        `;
                        
                        // File upload area (if LLM suggested)
                        if (param.supports_file_upload) {
                            inputHtml += `
                                <div id="input-file-${param.name}" class="hidden">
                                    <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center hover:border-purple-500 cursor-pointer transition"
                                         onclick="document.getElementById('file-${param.name}').click()">
                                        <input type="file" id="file-${param.name}" class="hidden" 
                                               accept="${param.accepted_files || '.pdf,.doc,.docx,.txt,.csv,.xlsx,.xls,.jpg,.jpeg,.png'}"
                                               onchange="handleParamFileUpload('${param.name}', '${toolId}', event)">
                                        <span class="text-2xl block mb-1"></span>
                                        <p class="text-sm text-gray-400">${param.file_upload_hint || 'Upload file to extract data'}</p>
                                        <p class="text-xs text-gray-500">${param.accepted_file_types || 'PDF, Word, Excel, CSV, Images'}</p>
                                    </div>
                                    <div id="file-preview-${param.name}" class="hidden mt-2 bg-gray-900 rounded p-2 text-xs"></div>
                                </div>
                            `;
                        }
                        
                        // Add tip if available
                        if (param.tip) {
                            inputHtml += `<p class="text-xs text-purple-400 mt-2"> ${param.tip}</p>`;
                        }
                        
                        inputArea.innerHTML = inputHtml;
                    });
                    
                    // Hide hint
                    if (hint) hint.classList.add('hidden');
                    
                    // Update button
                    if (btn) {
                        btn.innerHTML = ' Analyzed';
                        setTimeout(() => {
                            btn.innerHTML = ' Re-analyze';
                            btn.disabled = false;
                        }, 2000);
                    }
                } else {
                    if (btn) {
                        btn.innerHTML = ' No results';
                        setTimeout(() => {
                            btn.innerHTML = ' Analyze Parameters';
                            btn.disabled = false;
                        }, 2000);
                    }
                }
            } catch (e) {
                alert('Analysis error: ' + e.message);
                if (btn) {
                    btn.innerHTML = ' Failed';
                    setTimeout(() => { btn.innerHTML = ' Analyze Parameters'; btn.disabled = false; }, 2000);
                }
            }
        }
        
        // Quick generate - Pure LLM
        async function quickGenerate(paramName, toolId) {
            const paramInput = document.getElementById('test-param-' + paramName);
            if (!paramInput) return;
            
            // Show loading
            const originalValue = paramInput.value;
            paramInput.value = ' AI Generating...';
            paramInput.disabled = true;
            
            try {
                const r = await fetch(API + '/api/tools/' + toolId + '/generate-param', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ param_name: paramName, prompt: '' })
                });
                
                const data = await r.json();
                
                if (data.generated_data) {
                    paramInput.value = typeof data.generated_data === 'string'
                        ? data.generated_data
                        : JSON.stringify(data.generated_data, null, 2);
                } else if (data.error) {
                    paramInput.value = originalValue;
                    alert('Generation failed: ' + data.error);
                } else {
                    paramInput.value = originalValue;
                    alert('Could not generate data. Check LLM configuration.');
                }
            } catch (e) {
                paramInput.value = originalValue;
                alert('Error: ' + e.message);
            }
            
            paramInput.disabled = false;
            
            // Make sure we're in text mode
            toggleParamInputMode(paramName, 'text');
        }
        
        function toggleParamInputMode(paramName, mode) {
            // Hide all input modes
            ['text', 'file', 'ai'].forEach(m => {
                const inputDiv = document.getElementById('input-' + m + '-' + paramName);
                const btn = document.getElementById('btn-' + m + '-' + paramName);
                if (inputDiv) inputDiv.classList.add('hidden');
                if (btn) {
                    btn.classList.remove('bg-purple-600', 'text-white');
                    btn.classList.add('bg-gray-700', 'text-gray-300');
                }
            });
            
            // Show selected mode
            const selectedInput = document.getElementById('input-' + mode + '-' + paramName);
            const selectedBtn = document.getElementById('btn-' + mode + '-' + paramName);
            if (selectedInput) selectedInput.classList.remove('hidden');
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-gray-700', 'text-gray-300');
                selectedBtn.classList.add('bg-purple-600', 'text-white');
            }
        }
        
        async function handleParamFileUpload(paramName, toolId, event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const previewDiv = document.getElementById('file-preview-' + paramName);
            const paramInput = document.getElementById('test-param-' + paramName);
            
            previewDiv.classList.remove('hidden');
            previewDiv.innerHTML = '<span class="animate-pulse"> Processing ' + file.name + '...</span>';
            
            try {
                // Read file content
                const fileContent = await readFileContent(file);
                
                // Use LLM to extract relevant data
                const r = await fetch(API + '/api/tools/' + toolId + '/extract-param', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        param_name: paramName,
                        file_name: file.name,
                        file_content: fileContent,
                        file_type: file.type
                    })
                });
                
                const data = await r.json();
                
                if (data.extracted_data) {
                    // Set the extracted data to the parameter input
                    if (paramInput) {
                        paramInput.value = typeof data.extracted_data === 'string' 
                            ? data.extracted_data 
                            : JSON.stringify(data.extracted_data, null, 2);
                    }
                    
                    previewDiv.innerHTML = `
                        <div class="text-green-400 mb-2"> Extracted from ${file.name}</div>
                        <pre class="text-xs text-gray-400 max-h-32 overflow-auto">${escHtml(paramInput?.value || '')}</pre>
                    `;
                    
                    // Switch back to text mode to show the result
                    toggleParamInputMode(paramName, 'text');
                } else {
                    previewDiv.innerHTML = '<span class="text-red-400"> Could not extract data. Try manually entering.</span>';
                }
            } catch (e) {
                previewDiv.innerHTML = '<span class="text-red-400"> Error: ' + e.message + '</span>';
            }
        }
        
        async function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                if (file.type.startsWith('image/')) {
                    reader.onload = () => resolve('[Image file: ' + file.name + ']');
                    reader.readAsDataURL(file);
                } else {
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                }
            });
        }
        
        async function aiGenerateParam(paramName, toolId) {
            const promptInput = document.getElementById('ai-prompt-' + paramName);
            const resultDiv = document.getElementById('ai-result-' + paramName);
            const paramInput = document.getElementById('test-param-' + paramName);
            
            const prompt = promptInput?.value || 'Generate sample data';
            
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="animate-pulse text-gray-400"> Generating with AI...</span>';
            
            try {
                const r = await fetch(API + '/api/tools/' + toolId + '/generate-param', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        param_name: paramName,
                        prompt: prompt
                    })
                });
                
                const data = await r.json();
                
                if (data.generated_data) {
                    if (paramInput) {
                        paramInput.value = typeof data.generated_data === 'string'
                            ? data.generated_data
                            : JSON.stringify(data.generated_data, null, 2);
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="text-green-400 mb-2"> Generated successfully!</div>
                        <button onclick="toggleParamInputMode('${paramName}', 'text')" class="text-xs text-purple-400 hover:underline">
                            View & Edit 
                        </button>
                    `;
                } else if (data.error) {
                    resultDiv.innerHTML = `<span class="text-red-400"> ${data.error}</span>`;
                } else {
                    resultDiv.innerHTML = '<span class="text-red-400"> Could not generate data. Check LLM configuration.</span>';
                }
            } catch (e) {
                resultDiv.innerHTML = '<span class="text-red-400"> Error: ' + e.message + '</span>';
            }
        }
        
        async function autoFillTestData(toolId) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse"> AI Generating...</span>';
            btn.disabled = true;
            
            try {
                const r = await fetch(API + '/api/tools/' + toolId + '/auto-fill-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await r.json();
                
                if (data.parameters && Object.keys(data.parameters).length > 0) {
                    // Fill in all parameters from server
                    Object.entries(data.parameters).forEach(([name, value]) => {
                        const input = document.getElementById('test-param-' + name);
                        if (input) {
                            input.value = typeof value === 'string' ? value : JSON.stringify(value, null, 2);
                        }
                    });
                    
                    btn.innerHTML = ' Filled!';
                    setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
                } else if (data.error) {
                    alert('Failed to auto-fill: ' + data.error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                } else {
                    alert('Could not generate data. Check LLM configuration.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                alert('Error: ' + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function testApiCall(toolId) {
            const resultsDiv = document.getElementById('api-test-result-'+toolId);
            const pre = resultsDiv?.querySelector('pre');
            if(!pre) return;
            
            resultsDiv.classList.remove('hidden');
            pre.textContent = 'Calling API...';
            pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm';
            
            // Collect parameters
            const params = {};
            document.querySelectorAll('[id^="test-param-"]').forEach(input => {
                const name = input.id.replace('test-param-', '');
                if(input.value) {
                    // Try to parse JSON values
                    try {
                        params[name] = JSON.parse(input.value);
                    } catch {
                        params[name] = input.value;
                    }
                }
            });
            
            // Check if output transformation is enabled
            const transformEnabled = document.getElementById('transform-enabled-'+toolId)?.checked;
            const outputTransform = document.getElementById('output-transform-'+toolId)?.value?.trim();
            
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        parameters: params,
                        apply_transform: transformEnabled && outputTransform ? true : false,
                        transform_instructions: outputTransform
                    })
                });
                const data = await r.json();
                
                // Check if there's a transformed response
                if (data.transformed_response !== undefined) {
                    // Show both original and transformed
                    resultsDiv.innerHTML = `
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-sm font-medium text-purple-400 mb-2"> Transformed Response:</h4>
                                <pre class="bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm text-green-400">${escHtml(
                                    typeof data.transformed_response === 'string' 
                                        ? data.transformed_response 
                                        : JSON.stringify(data.transformed_response, null, 2)
                                )}</pre>
                            </div>
                            <details class="text-sm">
                                <summary class="text-gray-500 cursor-pointer hover:text-gray-300">View Original Response</summary>
                                <pre class="bg-gray-800 rounded-lg p-4 overflow-x-auto text-xs text-gray-400 mt-2">${escHtml(JSON.stringify(data.original_response || data.response, null, 2))}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    pre.textContent = JSON.stringify(data, null, 2);
                    pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm text-green-400';
                }
            } catch(e) {
                pre.textContent = 'Error: ' + e.message;
                pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm text-red-400';
            }
        }
        
        async function saveToolConfig(toolId) {
            const name = document.getElementById('tool-name-'+toolId)?.value;
            const description = document.getElementById('tool-desc-'+toolId)?.value;
            const configText = document.getElementById('tool-config-'+toolId)?.value;
            
            let config = {};
            try {
                config = JSON.parse(configText || '{}');
            } catch(e) {
                alert('Invalid JSON in configuration');
                return;
            }
            
            try {
                await fetch(API+'/api/tools/'+toolId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, description, config })
                });
                alert(' Configuration saved!');
            } catch(e) {
                alert('Failed to save: ' + e.message);
            }
        }
        
        async function testGenericTool(toolId) {
            const resultsDiv = document.getElementById('tool-test-result-'+toolId);
            const pre = resultsDiv?.querySelector('pre');
            if(!pre) return;
            
            resultsDiv.classList.remove('hidden');
            pre.textContent = 'Testing...';
            pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm';
            
            const inputText = document.getElementById('tool-test-input-'+toolId)?.value || '{}';
            let input = {};
            try {
                input = JSON.parse(inputText);
            } catch(e) {
                pre.textContent = 'Invalid JSON input';
                pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm text-red-400';
                return;
            }
            
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ parameters: input })
                });
                const data = await r.json();
                pre.textContent = JSON.stringify(data, null, 2);
                pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm text-green-400';
            } catch(e) {
                pre.textContent = 'Error: ' + e.message;
                pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm text-red-400';
            }
        }
        async function scrape(tid){
            const url=document.getElementById('scrape-url').value;
            const rec=document.getElementById('scrape-rec').checked;
            const max=parseInt(document.getElementById('scrape-max').value);
            if(!url){alert('Enter URL');return;}
            
            // Show progress modal
            showProgressModal('Scraping website...');
            
            // Check if it's a dynamic site
            const dynamicSites = ['oracle.com', 'azure.microsoft.com', 'cloud.google.com', 'aws.amazon.com'];
            const isDynamic = dynamicSites.some(site => url.includes(site));
            
            if(isDynamic) {
                // Simulate progress for dynamic sites
                const steps = [
                    ' [1/7] Launching Chromium browser...',
                    ' [2/7] Creating browser context...',
                    ' [3/7] Navigating to page...',
                    ' [4/7] Waiting for JavaScript to render...',
                    ' [5/7] Scrolling to load dynamic content...',
                    ' [6/7] Extracting rendered HTML...',
                    ' Extracting tables and pricing data...'
                ];
                let stepIndex = 0;
                const progressInterval = setInterval(() => {
                    if(stepIndex < steps.length) {
                        updateProgress((stepIndex + 1) / steps.length * 90, steps[stepIndex]);
                        stepIndex++;
                    }
                }, 4000);
                
                try {
                    await fetch(API+'/api/tools/'+tid+'/scrape',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url,recursive:rec,max_pages:max})});
                    clearInterval(progressInterval);
                    updateProgress(100, ' Scraping complete!');
                    await new Promise(r => setTimeout(r, 1000));
                    hideProgressModal();
                    viewTool(tid);
                } catch(e) {
                    clearInterval(progressInterval);
                    hideProgressModal();
                    alert('Error scraping: ' + e.message);
                }
            } else {
                updateProgress(30, ' Fetching page content...');
                try {
                    await fetch(API+'/api/tools/'+tid+'/scrape',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url,recursive:rec,max_pages:max})});
                    updateProgress(100, ' Scraping complete!');
                    await new Promise(r => setTimeout(r, 1000));
                    hideProgressModal();
                    viewTool(tid);
                } catch(e) {
                    hideProgressModal();
                    alert('Error scraping: ' + e.message);
                }
            }
        }
        async function delPage(id){if(!confirm('Delete page?'))return;await fetch(API+'/api/scraped-pages/'+id,{method:'DELETE'});location.reload();}
        async function delTool(id){if(!confirm('Delete this tool?'))return;await fetch(API+'/api/tools/'+id,{method:'DELETE'});navigate('tools');}
        
        async function delToolFromCard(id, name){
            if(!confirm('Delete tool "' + name + '"?')) return;
            try {
                await fetch(API+'/api/tools/'+id, {method:'DELETE'});
                showToast('Tool deleted', 'success');
                loadTools();
            } catch(e) {
                showToast('Failed to delete: ' + e.message, 'error');
            }
        }
        
        function toggleToolMenu(toolId) {
            closeAllToolMenus();
            const menu = document.getElementById('tool-menu-' + toolId);
            if(menu) menu.classList.toggle('hidden');
        }
        
        function closeAllToolMenus() {
            document.querySelectorAll('[id^="tool-menu-"]').forEach(m => m.classList.add('hidden'));
        }
        
        async function duplicateTool(toolId) {
            try {
                const r = await fetch(API + '/api/tools/' + toolId);
                const tool = await r.json();
                const newTool = {
                    name: tool.name + ' (Copy)',
                    description: tool.description,
                    type: tool.type,
                    config: tool.config
                };
                const resp = await fetch(API + '/api/tools', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(newTool)
                });
                if(resp.ok) {
                    showToast('Tool duplicated', 'success');
                    loadTools();
                } else {
                    showToast('Failed to duplicate', 'error');
                }
            } catch(e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

// Tool Selection Pattern
let selectedToolId = null;

function selectTool(toolId) {
    const card = document.querySelector(`[data-tool-id="${toolId}"]`);
    const toolName = card?.dataset.toolName || 'Tool';
    
    // If same tool clicked, deselect
    if (selectedToolId === toolId) {
        clearToolSelection();
        return;
    }
    
    // Clear previous selection
    document.querySelectorAll('.tool-card').forEach(c => c.classList.remove('ring-2', 'ring-purple-500'));
    
    // Select new tool
    selectedToolId = toolId;
    card?.classList.add('ring-2', 'ring-purple-500');
    
    // Show action bar
    document.getElementById('selected-tool-name').textContent = toolName;
    document.getElementById('tools-action-bar').classList.remove('hidden');
    
    // Apply permissions
    if (typeof applyPermissions === 'function') applyPermissions();
}

function clearToolSelection() {
    selectedToolId = null;
    document.querySelectorAll('.tool-card').forEach(c => c.classList.remove('ring-2', 'ring-purple-500'));
    document.getElementById('tools-action-bar').classList.add('hidden');
}

function viewSelectedTool() {
    if (selectedToolId) {
        clearToolSelection();
        viewTool(selectedToolId);
    }
}

function editSelectedTool() {
    if (selectedToolId) {
        const id = selectedToolId;
        clearToolSelection();
        openToolEditPanel(id);
    }
}

function duplicateSelectedTool() {
    if (selectedToolId) {
        const id = selectedToolId;
        clearToolSelection();
        duplicateTool(id);
    }
}

function deleteSelectedTool() {
    if (selectedToolId) {
        const card = document.querySelector(`[data-tool-id="${selectedToolId}"]`);
        const toolName = card?.dataset.toolName || 'this tool';
        const id = selectedToolId;
        clearToolSelection();
        delToolFromCard(id, toolName);
    }
}

// Clear selection when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.tool-card') && !e.target.closest('#tools-action-bar')) {
        clearToolSelection();
    }
});

// Clear selection on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') clearToolSelection();
});
        
        // Close menus when clicking outside
        document.addEventListener('click', () => closeAllToolMenus());

// Edit Tool Modal

// Tool Edit Panel Functions
let currentEditTool = null;

async function openToolEditPanel(toolId) {
    try {
        const r = await fetch(API + '/api/tools/' + toolId);
        if (!r.ok) throw new Error('Failed to load tool');
        currentEditTool = await r.json();
        
        const icons = {document:'', website:'', api:'', knowledge:'', email:'', webhook:'', websearch:'', database:''};
        
        // Set basic fields
        document.getElementById('edit-tool-id').value = currentEditTool.id;
        document.getElementById('edit-tool-type').value = currentEditTool.type;
        document.getElementById('edit-tool-name').value = currentEditTool.name || '';
        document.getElementById('edit-tool-desc').value = currentEditTool.description || '';
        document.getElementById('edit-tool-active').checked = currentEditTool.is_active !== false;
        document.getElementById('edit-panel-icon').textContent = icons[currentEditTool.type] || '';
        document.getElementById('edit-panel-type').textContent = currentEditTool.type.toUpperCase();
        
        // Load config fields based on type
        loadEditConfigFields(currentEditTool);
        
        // Load sources
        loadEditSources(currentEditTool);
        
        // Show panel with animation
        const panel = document.getElementById('tool-edit-panel');
        const slider = document.getElementById('tool-edit-slider');
        panel.classList.remove('hidden');
        setTimeout(() => slider.classList.remove('translate-x-full'), 10);
        
        // Reset to first tab
        switchEditTab('basic');
        
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

function closeToolEditPanel() {
    const panel = document.getElementById('tool-edit-panel');
    const slider = document.getElementById('tool-edit-slider');
    slider.classList.add('translate-x-full');
    setTimeout(() => panel.classList.add('hidden'), 300);
    currentEditTool = null;
}

function switchEditTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.edit-tab').forEach(t => {
        t.classList.remove('active', 'border-purple-500', 'text-purple-400');
        t.classList.add('border-transparent', 'text-gray-400');
    });
    const activeTab = document.querySelector(`.edit-tab[data-tab="${tab}"]`);
    if (activeTab) {
        activeTab.classList.add('active', 'border-purple-500', 'text-purple-400');
        activeTab.classList.remove('border-transparent', 'text-gray-400');
    }
    
    // Show content
    document.querySelectorAll('.edit-tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('edit-tab-' + tab)?.classList.remove('hidden');
}

function loadEditConfigFields(tool) {
    const container = document.getElementById('edit-config-content');
    const config = tool.config || {};
    let html = '';
    
    switch(tool.type) {
        case 'website':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Website URL</label>
                        <input type="url" id="edit-cfg-url" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.url || '')}">
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="edit-cfg-recursive" class="w-4 h-4" ${config.recursive ? 'checked' : ''}>
                            <span class="text-sm">Recursive scraping</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-400">Max pages:</label>
                            <input type="number" id="edit-cfg-maxpages" class="input-field w-20 rounded px-2 py-1" value="${config.max_pages || 10}">
                        </div>
                    </div>
                    <p class="text-xs text-yellow-400"> Changing URL will require re-scraping</p>
                </div>
            `;
            break;
            
        case 'document':
        case 'knowledge':
            html = `
                <div class="space-y-4">
                    <div class="card rounded-lg p-4">
                        <h5 class="font-medium mb-3"> Search Settings</h5>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Chunk Size</label>
                                <input type="number" id="edit-cfg-chunk" class="input-field w-full rounded-lg px-3 py-2" value="${config.chunk_size || 1000}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Overlap</label>
                                <input type="number" id="edit-cfg-overlap" class="input-field w-full rounded-lg px-3 py-2" value="${config.overlap || 200}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Top K Results</label>
                                <input type="number" id="edit-cfg-topk" class="input-field w-full rounded-lg px-3 py-2" value="${config.top_k || 5}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Search Type</label>
                                <select id="edit-cfg-search" class="input-field w-full rounded-lg px-3 py-2">
                                    <option value="hybrid" ${config.search_type === 'hybrid' ? 'selected' : ''}>Hybrid</option>
                                    <option value="semantic" ${config.search_type === 'semantic' ? 'selected' : ''}>Semantic</option>
                                    <option value="keyword" ${config.search_type === 'keyword' ? 'selected' : ''}>Keyword</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-yellow-400"> Changing chunk size/overlap will require re-indexing documents</p>
                </div>
            `;
            break;
            
        case 'api':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">API Base URL</label>
                        <input type="url" id="edit-cfg-apiurl" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.base_url || '')}">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">API Key</label>
                        <input type="password" id="edit-cfg-apikey" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.api_key || '')}" placeholder="Enter API key">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Headers (JSON)</label>
                        <textarea id="edit-cfg-headers" rows="3" class="input-field w-full px-4 py-2 rounded-lg font-mono text-sm">${escHtml(JSON.stringify(config.headers || {}, null, 2))}</textarea>
                    </div>
                </div>
            `;
            break;
            
        case 'database':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Database Type</label>
                        <select id="edit-cfg-dbtype" class="input-field w-full px-4 py-2 rounded-lg">
                            <option value="postgresql" ${config.db_type === 'postgresql' ? 'selected' : ''}>PostgreSQL</option>
                            <option value="mysql" ${config.db_type === 'mysql' ? 'selected' : ''}>MySQL</option>
                            <option value="mssql" ${config.db_type === 'mssql' ? 'selected' : ''}>SQL Server</option>
                            <option value="mongodb" ${config.db_type === 'mongodb' ? 'selected' : ''}>MongoDB</option>
                            <option value="sqlite" ${config.db_type === 'sqlite' ? 'selected' : ''}>SQLite</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Connection String</label>
                        <input type="password" id="edit-cfg-connstr" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.connection_string || '')}" placeholder="postgresql://user:pass@host:5432/db">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Allowed Tables (comma-separated, empty = all)</label>
                        <input type="text" id="edit-cfg-tables" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml((config.tables || []).join(', '))}" placeholder="users, orders, products">
                    </div>
                </div>
            `;
            break;
            
        case 'email':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Email Provider</label>
                        <select id="edit-cfg-emailprovider" class="input-field w-full px-4 py-2 rounded-lg">
                            <option value="smtp" ${config.provider === 'smtp' ? 'selected' : ''}>SMTP</option>
                            <option value="sendgrid" ${config.provider === 'sendgrid' ? 'selected' : ''}>SendGrid</option>
                            <option value="ses" ${config.provider === 'ses' ? 'selected' : ''}>AWS SES</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">From Email</label>
                        <input type="email" id="edit-cfg-fromemail" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.from_email || '')}" placeholder="noreply@example.com">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">API Key / Password</label>
                        <input type="password" id="edit-cfg-emailkey" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.api_key || config.password || '')}" placeholder="Enter API key or password">
                    </div>
                    <div id="smtp-fields" class="${config.provider === 'smtp' ? '' : 'hidden'}">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">SMTP Host</label>
                                <input type="text" id="edit-cfg-smtphost" class="input-field w-full px-3 py-2 rounded-lg" value="${escHtml(config.smtp_host || '')}" placeholder="smtp.gmail.com">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">SMTP Port</label>
                                <input type="number" id="edit-cfg-smtpport" class="input-field w-full px-3 py-2 rounded-lg" value="${config.smtp_port || 587}">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'webhook':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Webhook URL</label>
                        <input type="url" id="edit-cfg-webhookurl" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.url || '')}" placeholder="https://api.example.com/webhook">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">HTTP Method</label>
                        <select id="edit-cfg-webhookmethod" class="input-field w-full px-4 py-2 rounded-lg">
                            <option value="POST" ${config.method === 'POST' ? 'selected' : ''}>POST</option>
                            <option value="GET" ${config.method === 'GET' ? 'selected' : ''}>GET</option>
                            <option value="PUT" ${config.method === 'PUT' ? 'selected' : ''}>PUT</option>
                            <option value="PATCH" ${config.method === 'PATCH' ? 'selected' : ''}>PATCH</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Headers (JSON)</label>
                        <textarea id="edit-cfg-webhookheaders" rows="3" class="input-field w-full px-4 py-2 rounded-lg font-mono text-sm">${escHtml(JSON.stringify(config.headers || {}, null, 2))}</textarea>
                    </div>
                </div>
            `;
            break;
            
        case 'slack':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Bot Token</label>
                        <input type="password" id="edit-cfg-slacktoken" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.bot_token || '')}" placeholder="xoxb-...">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Default Channel</label>
                        <input type="text" id="edit-cfg-slackchannel" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.default_channel || '')}" placeholder="#general">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Allowed Channels (comma-separated, empty = all)</label>
                        <input type="text" id="edit-cfg-slackchannels" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml((config.channels || []).join(', '))}" placeholder="#general, #support">
                    </div>
                </div>
            `;
            break;
            
        case 'websearch':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Search Provider</label>
                        <select id="edit-cfg-searchprovider" class="input-field w-full px-4 py-2 rounded-lg">
                            <option value="tavily" ${config.provider === 'tavily' ? 'selected' : ''}>Tavily</option>
                            <option value="serper" ${config.provider === 'serper' ? 'selected' : ''}>Serper (Google)</option>
                            <option value="bing" ${config.provider === 'bing' ? 'selected' : ''}>Bing</option>
                            <option value="duckduckgo" ${config.provider === 'duckduckgo' ? 'selected' : ''}>DuckDuckGo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">API Key</label>
                        <input type="password" id="edit-cfg-searchkey" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.api_key || '')}" placeholder="Enter API key">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Max Results</label>
                        <input type="number" id="edit-cfg-searchmax" class="input-field w-full px-4 py-2 rounded-lg" value="${config.max_results || 10}" min="1" max="50">
                    </div>
                </div>
            `;
            break;
            
        default:
            html = `
                <div class="text-center py-8 text-gray-400">
                    <p>Configuration for ${tool.type} type</p>
                    <pre class="mt-4 text-left text-xs bg-gray-800 p-4 rounded-lg overflow-auto max-h-64">${escHtml(JSON.stringify(config, null, 2))}</pre>
                </div>
            `;
    }
    
    container.innerHTML = html;
}
function loadEditSources(tool) {
    const container = document.getElementById('edit-sources-content');
    let html = '';
    
    // Documents
    const docs = tool.documents || [];
    html += `
        <div class="mb-6">
            <div class="flex items-center justify-between mb-3">
                <h5 class="font-medium"> Documents (${docs.length})</h5>
            </div>
            ${docs.length > 0 ? `
                <div class="space-y-2 max-h-48 overflow-y-auto">
                    ${docs.map(d => `
                        <div class="flex items-center justify-between p-2 bg-gray-800 rounded-lg">
                            <span class="text-sm truncate flex-1">${escHtml(d.name || d.filename || 'Document')}</span>
                            <button onclick="removeEditDoc('${d.id}')" class="text-red-400 hover:text-red-300 p-1"></button>
                        </div>
                    `).join('')}
                </div>
            ` : '<p class="text-gray-500 text-sm">No documents uploaded</p>'}
        </div>
    `;
    
    // Scraped Pages (for website type)
    if (tool.type === 'website') {
        const pages = tool.scraped_pages || [];
        html += `
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h5 class="font-medium"> Scraped Pages (${pages.length})</h5>
                </div>
                ${pages.length > 0 ? `
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        ${pages.map(p => `
                            <div class="flex items-center justify-between p-2 bg-gray-800 rounded-lg">
                                <span class="text-sm truncate flex-1">${escHtml(p.title || p.url || 'Page')}</span>
                                <button onclick="removeEditPage('${p.id}')" class="text-red-400 hover:text-red-300 p-1"></button>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p class="text-gray-500 text-sm">No pages scraped</p>'}
            </div>
        `;
    }
    
    // Add new source button
    html += `
        <div class="pt-4 border-t border-gray-700">
            <p class="text-sm text-gray-400 mb-3">To add new sources, use the tool detail page.</p>
            <button onclick="closeToolEditPanel(); viewTool('${tool.id}')" class="btn-secondary px-4 py-2 rounded-lg text-sm">
                Open Full View 
            </button>
        </div>
    `;
    
    container.innerHTML = html;
}

async function saveToolChanges() {
    const toolId = document.getElementById('edit-tool-id').value;
    const toolType = document.getElementById('edit-tool-type').value;
    
    // Gather basic info
    const updates = {
        name: document.getElementById('edit-tool-name').value,
        description: document.getElementById('edit-tool-desc').value,
        is_active: document.getElementById('edit-tool-active').checked
    };
    
    // Gather config based on type
    const config = {};
    switch(toolType) {
        case 'website':
            config.url = document.getElementById('edit-cfg-url')?.value || '';
            config.recursive = document.getElementById('edit-cfg-recursive')?.checked || false;
            config.max_pages = parseInt(document.getElementById('edit-cfg-maxpages')?.value) || 10;
            break;
        case 'document':
        case 'knowledge':
            config.chunk_size = parseInt(document.getElementById('edit-cfg-chunk')?.value) || 1000;
            config.overlap = parseInt(document.getElementById('edit-cfg-overlap')?.value) || 200;
            config.top_k = parseInt(document.getElementById('edit-cfg-topk')?.value) || 5;
            config.search_type = document.getElementById('edit-cfg-search')?.value || 'hybrid';
            break;
        case 'api':
            config.base_url = document.getElementById('edit-cfg-apiurl')?.value || '';
            config.api_key = document.getElementById('edit-cfg-apikey')?.value || '';
            try {
                config.headers = JSON.parse(document.getElementById('edit-cfg-headers')?.value || '{}');
            } catch(e) {
                config.headers = {};
            }
            break;
        case 'database':
            config.db_type = document.getElementById('edit-cfg-dbtype')?.value || 'postgresql';
            config.connection_string = document.getElementById('edit-cfg-connstr')?.value || '';
            const tablesStr = document.getElementById('edit-cfg-tables')?.value || '';
            config.tables = tablesStr ? tablesStr.split(',').map(t => t.trim()).filter(t => t) : [];
            break;
        case 'email':
            config.provider = document.getElementById('edit-cfg-emailprovider')?.value || 'smtp';
            config.from_email = document.getElementById('edit-cfg-fromemail')?.value || '';
            config.api_key = document.getElementById('edit-cfg-emailkey')?.value || '';
            if (config.provider === 'smtp') {
                config.smtp_host = document.getElementById('edit-cfg-smtphost')?.value || '';
                config.smtp_port = parseInt(document.getElementById('edit-cfg-smtpport')?.value) || 587;
            }
            break;
        case 'webhook':
            config.url = document.getElementById('edit-cfg-webhookurl')?.value || '';
            config.method = document.getElementById('edit-cfg-webhookmethod')?.value || 'POST';
            try {
                config.headers = JSON.parse(document.getElementById('edit-cfg-webhookheaders')?.value || '{}');
            } catch(e) {
                config.headers = {};
            }
            break;
        case 'slack':
            config.bot_token = document.getElementById('edit-cfg-slacktoken')?.value || '';
            config.default_channel = document.getElementById('edit-cfg-slackchannel')?.value || '';
            const channelsStr = document.getElementById('edit-cfg-slackchannels')?.value || '';
            config.channels = channelsStr ? channelsStr.split(',').map(c => c.trim()).filter(c => c) : [];
            break;
        case 'websearch':
            config.provider = document.getElementById('edit-cfg-searchprovider')?.value || 'tavily';
            config.api_key = document.getElementById('edit-cfg-searchkey')?.value || '';
            config.max_results = parseInt(document.getElementById('edit-cfg-searchmax')?.value) || 10;
            break;
    }
    
    // Merge with existing config
    updates.config = { ...(currentEditTool?.config || {}), ...config };
    
    // Check if critical config changed (for re-processing)
    const oldConfig = currentEditTool?.config || {};
    let needsReprocess = false;
    let reprocessMessage = '';
    
    if (toolType === 'website' && oldConfig.url !== config.url) {
        needsReprocess = true;
        reprocessMessage = 'URL changed. You may need to re-scrape the website.';
    } else if ((toolType === 'document' || toolType === 'knowledge') && 
               (oldConfig.chunk_size !== config.chunk_size || oldConfig.overlap !== config.overlap)) {
        needsReprocess = true;
        reprocessMessage = 'Chunk settings changed. You may need to re-index documents.';
    }
    
    try {
        const r = await fetch(API + '/api/tools/' + toolId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (r.ok) {
            const result = await r.json();
            
            // Show appropriate message based on reprocess action
            if (result.reprocess_action) {
                let msg = 'Tool updated. ';
                switch(result.reprocess_action) {
                    case 'rescrape':
                        const pagesCount = result.reprocess_result?.pages_scraped || 0;
                        msg += `Re-scraped ${pagesCount} pages from new URL.`;
                        break;
                    case 'reindex':
                        const docsCount = result.reprocess_result?.documents_reindexed || 0;
                        msg += `Re-indexed ${docsCount} documents with new chunk settings.`;
                        break;
                    case 'test_connection':
                        msg += result.reprocess_result?.message || 'Configuration updated.';
                        break;
                    default:
                        msg += 'Configuration updated.';
                }
                if (result.reprocess_result?.error) {
                    showToast('Tool updated but re-processing failed: ' + result.reprocess_result.error, 'warning');
                } else {
                    showToast(msg, 'success');
                }
            } else {
                showToast('Tool updated successfully', 'success');
            }
            closeToolEditPanel();
            loadTools();
        } else {
            const err = await r.json();
            showToast(err.detail || 'Failed to update', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

function removeEditDoc(docId) {
    // This would need backend support - for now just show message
    showToast('Use full view to manage documents', 'info');
}

function removeEditPage(pageId) {
    showToast('Use full view to manage pages', 'info');
}
async function showEditToolModal(toolId) {
    try {
        const r = await fetch(API + '/api/tools/' + toolId);
        if (!r.ok) {
            showToast('Failed to load tool', 'error');
            return;
        }
        const tool = await r.json();
        
        // Create edit modal
        const modal = document.createElement('div');
        modal.id = 'edit-tool-modal';
        modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999]';
        modal.innerHTML = `
            <div class="card rounded-2xl p-6 w-full max-w-lg mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold"> Edit Tool</h3>
                    <button onclick="closeEditToolModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <form id="edit-tool-form" class="space-y-4">
                    <input type="hidden" id="edit-tool-id" value="${tool.id}">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Name</label>
                        <input type="text" id="edit-tool-name" value="${escHtml(tool.name)}" class="input-field w-full px-4 py-2 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Description</label>
                        <textarea id="edit-tool-desc" rows="3" class="input-field w-full px-4 py-2 rounded-lg">${escHtml(tool.description || '')}</textarea>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeEditToolModal()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                        <button type="submit" class="btn-primary flex-1 py-2 rounded-lg">Save Changes</button>
                    </div>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Handle form submit
        document.getElementById('edit-tool-form').onsubmit = async (e) => {
            e.preventDefault();
            await saveToolEdit();
        };
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

function closeEditToolModal() {
    document.getElementById('edit-tool-modal')?.remove();
}

async function saveToolEdit() {
    const toolId = document.getElementById('edit-tool-id').value;
    const name = document.getElementById('edit-tool-name').value;
    const description = document.getElementById('edit-tool-desc').value;
    
    try {
        const r = await fetch(API + '/api/tools/' + toolId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        });
        
        if (r.ok) {
            showToast('Tool updated successfully', 'success');
            closeEditToolModal();
            // Refresh tool view
            navigate('tools');
            setTimeout(() => showToolDetails(toolId), 100);
        } else {
            const data = await r.json();
            showToast(data.detail || 'Failed to update tool', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}


        // Data Viewer Functions
        let currentPageData = null;
        let currentToolData = null;
        let currentDataTab = 'tables';
        let dataSearchQuery = '';
        
        async function viewToolData(toolId) {
            document.getElementById('data-viewer-modal').classList.remove('hidden');
            document.getElementById('data-viewer-content').innerHTML = '<div class="text-center text-gray-500 py-10"><div class="animate-spin rounded-full h-8 w-8 border-2 border-purple-500 border-t-transparent mx-auto mb-3"></div>Loading all tool data...</div>';
            
            try {
                const r = await fetch(API + '/api/tools/' + toolId + '/data');
                const data = await r.json();
                currentToolData = data;
                currentPageData = null;
                dataSearchQuery = '';
                
                document.getElementById('data-viewer-title').textContent = ' ' + (data.name || 'Tool Data');
                document.getElementById('data-viewer-subtitle').textContent = `${data.type.toUpperCase()} - ${data.total_chunks} chunks from ${data.sources?.length || 0} sources`;
                
                // Show search box
                document.getElementById('data-search-box').classList.remove('hidden');
                document.getElementById('data-search-input').value = '';
                
                // Stats
                document.getElementById('data-viewer-stats').innerHTML = `
                    <span> ${(data.total_chars || 0).toLocaleString()} total characters</span>
                    <span> ${data.total_chunks || 0} chunks</span>
                    <span> ${data.sources?.length || 0} sources</span>
                `;
                
                renderToolDataTab();
            } catch (e) {
                document.getElementById('data-viewer-content').innerHTML = '<div class="text-center text-red-400 py-10">Error loading data: ' + e.message + '</div>';
            }
        }
        
        function searchToolData() {
            dataSearchQuery = document.getElementById('data-search-input').value.toLowerCase().trim();
            if (currentToolData) {
                renderToolDataTab();
            } else if (currentPageData) {
                renderDataTab();
            }
        }
        
        function renderToolDataTab() {
            const container = document.getElementById('data-viewer-content');
            if (!currentToolData) return;
            
            let chunks = currentToolData.chunks || [];
            
            // Filter by search
            if (dataSearchQuery) {
                chunks = chunks.filter(c => 
                    (c.text || '').toLowerCase().includes(dataSearchQuery) ||
                    (c.source || '').toLowerCase().includes(dataSearchQuery)
                );
            }
            
            if (currentDataTab === 'tables') {
                // Show all tables from all chunks
                let allContent = chunks.map(c => c.text || '').join('\n\n');
                const tables = extractTables(allContent);
                
                if (tables.length === 0) {
                    container.innerHTML = `<div class="text-center text-gray-500 py-10">
                        ${dataSearchQuery ? 'No tables found matching "' + escHtml(dataSearchQuery) + '"' : 'No tables found in the data.'}
                        <br><br>Switch to "Full Text" or "Chunks" tab to see content.
                    </div>`;
                    return;
                }
                
                let html = dataSearchQuery ? `<p class="text-sm text-purple-400 mb-4">Found ${tables.length} tables matching "${escHtml(dataSearchQuery)}"</p>` : '';
                tables.forEach((table, i) => {
                    html += `<div class="mb-6">
                        <h4 class="text-sm font-semibold text-purple-400 mb-2">Table ${i + 1}</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse">${table}</table>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
                
            } else if (currentDataTab === 'text') {
                // Full text view grouped by source
                const bySource = {};
                chunks.forEach(c => {
                    const src = c.source || 'Unknown';
                    if (!bySource[src]) bySource[src] = [];
                    bySource[src].push(c.text || '');
                });
                
                let html = dataSearchQuery ? `<p class="text-sm text-purple-400 mb-4">Showing results for "${escHtml(dataSearchQuery)}" (${chunks.length} chunks)</p>` : '';
                
                Object.entries(bySource).forEach(([source, texts]) => {
                    html += `<div class="mb-6">
                        <h4 class="text-sm font-semibold text-purple-400 mb-2 flex items-center gap-2">
                            <span></span> ${escHtml(source)}
                            <span class="text-gray-500 font-normal">(${texts.length} chunks)</span>
                        </h4>
                        <div class="bg-gray-900 rounded-lg p-4 font-mono text-xs whitespace-pre-wrap max-h-64 overflow-y-auto">${highlightSearch(escHtml(texts.join('\n\n---\n\n')))}</div>
                    </div>`;
                });
                
                container.innerHTML = html || '<div class="text-center text-gray-500 py-10">No content available.</div>';
                
            } else if (currentDataTab === 'chunks') {
                if (chunks.length === 0) {
                    container.innerHTML = `<div class="text-center text-gray-500 py-10">
                        ${dataSearchQuery ? 'No chunks found matching "' + escHtml(dataSearchQuery) + '"' : 'No chunks available.'}
                    </div>`;
                    return;
                }
                
                let html = dataSearchQuery ? `<p class="text-sm text-purple-400 mb-4">Found ${chunks.length} chunks matching "${escHtml(dataSearchQuery)}"</p>` : '';
                html += '<div class="space-y-4">';
                
                chunks.slice(0, 50).forEach((chunk, i) => {
                    const text = chunk.text || '';
                    html += `
                        <div class="bg-gray-800 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-semibold text-purple-400">Chunk ${i + 1}</span>
                                <div class="flex gap-2 text-xs text-gray-500">
                                    <span> ${escHtml(chunk.source || 'Unknown')}</span>
                                    <span>${text.length} chars</span>
                                </div>
                            </div>
                            <pre class="text-sm whitespace-pre-wrap text-gray-300">${highlightSearch(escHtml(text.substring(0, 500)))}${text.length > 500 ? '...' : ''}</pre>
                        </div>
                    `;
                });
                
                if (chunks.length > 50) {
                    html += `<p class="text-center text-gray-500 py-4">Showing 50 of ${chunks.length} chunks. Use search to find specific data.</p>`;
                }
                
                html += '</div>';
                container.innerHTML = html;
            }
        }
        
        function highlightSearch(text) {
            if (!dataSearchQuery) return text;
            const regex = new RegExp('(' + dataSearchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return text.replace(regex, '<mark class="bg-yellow-500/30 text-yellow-200 px-0.5 rounded">$1</mark>');
        }
        
        async function viewPageData(pageId) {
            document.getElementById('data-viewer-modal').classList.remove('hidden');
            document.getElementById('data-search-box').classList.add('hidden'); // Hide search for page data
            document.getElementById('data-viewer-content').innerHTML = '<div class="text-center text-gray-500 py-10"><div class="animate-spin rounded-full h-8 w-8 border-2 border-purple-500 border-t-transparent mx-auto mb-3"></div>Loading data...</div>';
            
            currentToolData = null; // Reset tool data
            dataSearchQuery = '';
            
            try {
                const r = await fetch(API + '/api/scraped-pages/' + pageId + '/data');
                const data = await r.json();
                currentPageData = data;
                
                document.getElementById('data-viewer-title').textContent = ' ' + (data.title || 'Extracted Data');
                document.getElementById('data-viewer-subtitle').textContent = data.url;
                
                // Stats
                document.getElementById('data-viewer-stats').innerHTML = `
                    <span> ${(data.content?.length || 0).toLocaleString()} characters</span>
                    <span> ${data.chunks?.length || 0} chunks</span>
                    <span> ${data.tables?.length || 0} tables found</span>
                    <span> ${new Date(data.created_at).toLocaleString()}</span>
                `;
                
                renderDataTab();
            } catch (e) {
                document.getElementById('data-viewer-content').innerHTML = '<div class="text-center text-red-400 py-10">Error loading data: ' + e.message + '</div>';
            }
        }
        
        function setDataTab(tab) {
            currentDataTab = tab;
            document.querySelectorAll('[id^="data-tab-"]').forEach(btn => {
                btn.classList.toggle('border-purple-500', btn.id === 'data-tab-' + tab);
                btn.classList.toggle('text-white', btn.id === 'data-tab-' + tab);
                btn.classList.toggle('border-transparent', btn.id !== 'data-tab-' + tab);
                btn.classList.toggle('text-gray-400', btn.id !== 'data-tab-' + tab);
            });
            if (currentToolData) {
                renderToolDataTab();
            } else {
                renderDataTab();
            }
        }
        
        function renderDataTab() {
            const container = document.getElementById('data-viewer-content');
            if (!currentPageData) return;
            
            if (currentDataTab === 'tables') {
                // Extract and render tables
                const tables = extractTables(currentPageData.content || '');
                if (tables.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-10">No tables found in the extracted data.<br><br>Switch to "Full Text" tab to see all content.</div>';
                    return;
                }
                
                let html = '';
                tables.forEach((table, i) => {
                    html += `<div class="mb-6">
                        <h4 class="text-sm font-semibold text-purple-400 mb-2">Table ${i + 1}</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse">
                                ${table}
                            </table>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            } else if (currentDataTab === 'text') {
                // Full text view
                const content = currentPageData.content || 'No content';
                container.innerHTML = `
                    <div class="bg-gray-900 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap overflow-x-auto" style="max-height: 60vh;">${escHtml(content)}</div>
                `;
            } else if (currentDataTab === 'chunks') {
                // Chunks view
                const chunks = currentPageData.chunks || [];
                if (chunks.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-10">No chunks available.</div>';
                    return;
                }
                
                let html = '<div class="space-y-4">';
                chunks.forEach((chunk, i) => {
                    const text = typeof chunk === 'string' ? chunk : (chunk.text || chunk.content || JSON.stringify(chunk));
                    html += `
                        <div class="bg-gray-800 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-semibold text-purple-400">Chunk ${i + 1}</span>
                                <span class="text-xs text-gray-500">${text.length} chars</span>
                            </div>
                            <pre class="text-sm whitespace-pre-wrap text-gray-300">${escHtml(text.substring(0, 1000))}${text.length > 1000 ? '...' : ''}</pre>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            }
        }
        
        function extractTables(content) {
            const tables = [];
            
            // Look for [TABLE] markers
            const tableMatches = content.match(/\[TABLE\]([\s\S]*?)\[\/TABLE\]/gi);
            if (tableMatches) {
                tableMatches.forEach(match => {
                    const tableContent = match.replace(/\[TABLE\]/i, '').replace(/\[\/TABLE\]/i, '').trim();
                    const rows = tableContent.split('\n').filter(r => r.trim());
                    if (rows.length > 0) {
                        let tableHtml = '';
                        rows.forEach((row, i) => {
                            const cells = row.split('|').map(c => c.trim()).filter(c => c);
                            const tag = i === 0 ? 'th' : 'td';
                            const bgClass = i === 0 ? 'bg-purple-900/30' : (i % 2 === 0 ? 'bg-gray-800' : 'bg-gray-800/50');
                            tableHtml += '<tr class="' + bgClass + '">' + cells.map(c => '<' + tag + ' class="border border-gray-700 px-3 py-2">' + escHtml(c) + '</' + tag + '>').join('') + '</tr>';
                        });
                        tables.push(tableHtml);
                    }
                });
            }
            
            // Also look for pipe-separated tables without markers
            const lines = content.split('\n');
            let currentTable = [];
            let inTable = false;
            
            lines.forEach(line => {
                if (line.includes('|') && line.split('|').length >= 3) {
                    currentTable.push(line);
                    inTable = true;
                } else if (inTable && currentTable.length > 0) {
                    // End of table
                    if (currentTable.length >= 2) {
                        let tableHtml = '';
                        currentTable.forEach((row, i) => {
                            const cells = row.split('|').map(c => c.trim()).filter(c => c && !c.match(/^-+$/));
                            if (cells.length > 0) {
                                const tag = i === 0 ? 'th' : 'td';
                                const bgClass = i === 0 ? 'bg-purple-900/30' : (i % 2 === 0 ? 'bg-gray-800' : 'bg-gray-800/50');
                                tableHtml += '<tr class="' + bgClass + '">' + cells.map(c => '<' + tag + ' class="border border-gray-700 px-3 py-2">' + escHtml(c) + '</' + tag + '>').join('') + '</tr>';
                            }
                        });
                        if (tableHtml) tables.push(tableHtml);
                    }
                    currentTable = [];
                    inTable = false;
                }
            });
            
            // Check if we ended while still in a table
            if (currentTable.length >= 2) {
                let tableHtml = '';
                currentTable.forEach((row, i) => {
                    const cells = row.split('|').map(c => c.trim()).filter(c => c && !c.match(/^-+$/));
                    if (cells.length > 0) {
                        const tag = i === 0 ? 'th' : 'td';
                        const bgClass = i === 0 ? 'bg-purple-900/30' : (i % 2 === 0 ? 'bg-gray-800' : 'bg-gray-800/50');
                        tableHtml += '<tr class="' + bgClass + '">' + cells.map(c => '<' + tag + ' class="border border-gray-700 px-3 py-2">' + escHtml(c) + '</' + tag + '>').join('') + '</tr>';
                    }
                });
                if (tableHtml) tables.push(tableHtml);
            }
            
            return tables;
        }
        
        function closeDataViewer() {
            document.getElementById('data-viewer-modal').classList.add('hidden');
            document.getElementById('data-search-box').classList.add('hidden');
            currentPageData = null;
            currentToolData = null;
            dataSearchQuery = '';
        }
        
        function copyDataContent() {
            let content = '';
            if (currentToolData) {
                content = currentToolData.chunks?.map(c => c.text).join('\n\n---\n\n') || '';
            } else if (currentPageData) {
                content = currentPageData.content || '';
            }
            if (!content) return;
            navigator.clipboard.writeText(content);
            alert('Content copied to clipboard!');
        }
        
        function downloadDataContent() {
            let content = '';
            let filename = 'data.txt';
            if (currentToolData) {
                content = currentToolData.chunks?.map(c => `[Source: ${c.source}]\n${c.text}`).join('\n\n' + '='.repeat(50) + '\n\n') || '';
                filename = (currentToolData.name || 'tool-data') + '.txt';
            } else if (currentPageData) {
                content = currentPageData.content || '';
                filename = (currentPageData.title || 'data') + '.txt';
            }
            if (!content) return;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showToolModal(){
            toolType=null;uploadedFiles=[];apiStep=1;apiParams=[];configMode='manual';
            document.querySelectorAll('.tool-type').forEach(b=>b.classList.remove('border-purple-500'));
            document.getElementById('tool-form').classList.add('hidden');
            // Hide all form types
            const formTypes = ['knowledge','document','website','api','database','spreadsheet','email','slack','calendar','crm','webhook','websearch','imagegen','code','calculator','storage','stt','tts','translate','ocr','hitl'];
            formTypes.forEach(t => {
                const el = document.getElementById('form-'+t);
                if(el) el.classList.add('hidden');
            });
            document.getElementById('tool-categories').classList.remove('hidden');
            document.getElementById('doc-files-list').innerHTML='';
            const paramsList = document.getElementById('api-params-list');
            if(paramsList) paramsList.innerHTML='';
            const testResult = document.getElementById('api-test-result');
            if(testResult) testResult.classList.add('hidden');
            showModal('modal-tool');
        }

        function backToToolTypes(){
            document.getElementById('tool-form').classList.add('hidden');
            document.getElementById('tool-categories').classList.remove('hidden');
            document.querySelectorAll('.tool-type').forEach(b=>b.classList.remove('border-purple-500'));
        }

        function selectToolType(type){
            toolType=type;
            document.querySelectorAll('.tool-type').forEach(b=>b.classList.remove('border-purple-500'));
            document.getElementById('tool-categories').classList.add('hidden');
            document.getElementById('tool-form').classList.remove('hidden');
            
            // Hide all form types
            const formTypes2 = ['knowledge','document','website','api','database','spreadsheet','email','slack','calendar','crm','webhook','websearch','imagegen','code','calculator','storage','stt','tts','translate','ocr','hitl'];
            formTypes2.forEach(t => {
                const el = document.getElementById('form-'+t);
                if(el) el.classList.add('hidden');
            });
            
            // Show selected form
            const selectedForm = document.getElementById('form-'+type);
            if(selectedForm) selectedForm.classList.remove('hidden');
            
            if(type==='document'){
                const z=document.getElementById('doc-upload-zone');
                z.ondragover=e=>{e.preventDefault();z.classList.add('dragover');};
                z.ondragleave=()=>z.classList.remove('dragover');
                z.ondrop=e=>{e.preventDefault();z.classList.remove('dragover');handleDocFilesDrop(e.dataTransfer.files);};
            }
        }

        // Tool form helper functions
        function onDBTypeChange(){
            const t = document.getElementById('db-type').value;
            const portMap = {
                // Relational
                postgresql:'5432', mysql:'3306', mssql:'1433', sqlite:'', 
                oracle:'1521', oracle_autonomous:'1522', db2:'50000', sybase:'5000', 
                teradata:'1025', azure_sql:'1433', cockroachdb:'26257', tidb:'4000',
                // Cloud Data Warehouses
                snowflake:'443', redshift:'5439', bigquery:'443',
                // NoSQL
                mongodb:'27017', mongodb_atlas:'27017', dynamodb:'443', cosmosdb:'443',
                firestore:'443', couchdb:'5984', cassandra:'9042', scylladb:'9042', hbase:'9090',
                // In-Memory
                redis:'6379', memcached:'11211', elasticache:'6379',
                // Search
                elasticsearch:'9200', opensearch:'9200', solr:'8983', meilisearch:'7700',
                // Vector
                pinecone:'443', weaviate:'8080', qdrant:'6333', milvus:'19530', chroma:'8000',
                // Time Series
                influxdb:'8086', timescaledb:'5432', questdb:'9000',
                // Graph
                neo4j:'7687', neptune:'8182', arangodb:'8529'
            };
            document.getElementById('db-port').value = portMap[t] || '5432';
        }
        function onSheetProviderChange(){
            const p = document.getElementById('sheet-provider').value;
            document.getElementById('sheet-google-fields').classList.toggle('hidden', p !== 'google');
            document.getElementById('sheet-airtable-fields').classList.toggle('hidden', p !== 'airtable');
        }
        function onEmailProviderChange(){
            const p = document.getElementById('email-provider').value;
            document.getElementById('email-smtp-fields').classList.toggle('hidden', p !== 'smtp');
            document.getElementById('email-api-fields').classList.toggle('hidden', p === 'smtp');
        }
        function onMsgPlatformChange(){
            const p = document.getElementById('msg-platform').value;
            document.getElementById('msg-slack-fields').classList.toggle('hidden', p !== 'slack');
            document.getElementById('msg-teams-fields').classList.toggle('hidden', p !== 'teams');
            document.getElementById('msg-discord-fields').classList.toggle('hidden', p !== 'discord');
        }
        function onCalProviderChange(){}
        function onCRMPlatformChange(){
            const p = document.getElementById('crm-platform').value;
            document.getElementById('crm-salesforce-fields').classList.toggle('hidden', p !== 'salesforce');
            document.getElementById('crm-hubspot-fields').classList.toggle('hidden', p !== 'hubspot');
        }
        function onWebhookTypeChange(){
            const t = document.getElementById('hook-type').value;
            document.getElementById('hook-outgoing-fields').classList.toggle('hidden', t !== 'outgoing');
            document.getElementById('hook-incoming-fields').classList.toggle('hidden', t !== 'incoming');
        }
        function onSearchProviderChange(){
            const p = document.getElementById('search-provider').value;
            const hints = {tavily:'Get your API key from tavily.com',serper:'Get your API key from serper.dev',bing:'Get your API key from Azure Portal',brave:'Get your API key from brave.com/search/api'};
            document.getElementById('search-api-hint').textContent = hints[p] || '';
        }
        function onImageProviderChange(){}
        function testDBConnection(){alert('Database connection test coming soon!');}
        function testSheetConnection(){alert('Spreadsheet connection test coming soon!');}
        function testEmailConnection(){alert('Email connection test coming soon!');}

        // Knowledge Base helper functions
        function toggleKBEmbedding(){
            const useGlobal = document.getElementById('kb-emb-global').checked;
            document.getElementById('kb-emb-custom').classList.toggle('hidden', useGlobal);
        }
        function toggleKBVectorDB(){
            const useGlobal = document.getElementById('kb-vdb-global').checked;
            document.getElementById('kb-vdb-custom').classList.toggle('hidden', useGlobal);
        }
        function onKBEmbProviderChange(){
            const p = document.getElementById('kb-emb-provider').value;
            document.getElementById('kb-emb-model-group').classList.toggle('hidden', p === 'sentence_transformers');
            document.getElementById('kb-emb-local-group').classList.toggle('hidden', p !== 'sentence_transformers');
            document.getElementById('kb-emb-key-group').classList.toggle('hidden', p === 'sentence_transformers' || p === 'ollama');
        }
        function onKBVDBProviderChange(){
            const p = document.getElementById('kb-vdb-provider').value;
            document.getElementById('kb-vdb-pinecone-group').classList.toggle('hidden', p !== 'pinecone');
        }

        function handleDocFiles(e){handleDocFilesDrop(e.target.files);}
        function handleDocFilesDrop(files){for(const f of files)uploadedFiles.push(f);renderDocFiles();}
        function renderDocFiles(){document.getElementById('doc-files-list').innerHTML=uploadedFiles.map((f,i)=>`<div class="flex items-center justify-between bg-gray-800 rounded-lg p-2"><div class="flex items-center gap-2 min-w-0"><span>${fileIcon(f.name.split('.').pop())}</span><span class="text-sm truncate">${f.name}</span></div><button onclick="uploadedFiles.splice(${i},1);renderDocFiles()" class="text-gray-500 hover:text-red-400 p-1"></button></div>`).join('');}

        // API Tool Wizard
        function setApiStep(s){
            apiStep=s;
            for(let i=1;i<=4;i++){
                document.getElementById('api-step-'+i).classList.toggle('hidden',i!==s);
                document.getElementById('api-step-'+i+'-btn').className='api-step px-2 md:px-4 py-2 rounded-lg border text-xs md:text-sm whitespace-nowrap '+(i===s?'border-purple-500 bg-purple-500/10 text-white':'border-gray-700 text-gray-400');
            }
            if(s===4)renderTestParams();
        }

        function addApiParam(){
            apiParams.push({id:Date.now(),name:'',description:'',data_type:'string',required:false,location:'query'});
            renderApiParams();
        }

        function renderApiParams(){
            document.getElementById('api-params-list').innerHTML=apiParams.map((p,i)=>`
                <div class="card rounded-lg p-3 md:p-4 space-y-3" id="param-${p.id}">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div>
                            <label class="text-xs text-gray-400">Name</label>
                            <input type="text" value="${p.name}" onchange="apiParams[${i}].name=this.value.replace(/\\s/g,'')" class="input-field w-full rounded px-3 py-2 text-sm mt-1" placeholder="city">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Type</label>
                            <select onchange="apiParams[${i}].data_type=this.value" class="input-field w-full rounded px-3 py-2 text-sm mt-1">
                                <option value="string" ${p.data_type==='string'?'selected':''}>String</option>
                                <option value="integer" ${p.data_type==='integer'?'selected':''}>Integer</option>
                                <option value="boolean" ${p.data_type==='boolean'?'selected':''}>Boolean</option>
                            </select>
                            
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Location</label>
                            <select onchange="apiParams[${i}].location=this.value" class="input-field w-full rounded px-3 py-2 text-sm mt-1">
                                <option value="query" ${p.location==='query'?'selected':''}>Query</option>
                                <option value="path" ${p.location==='path'?'selected':''}>Path</option>
                                <option value="header" ${p.location==='header'?'selected':''}>Header</option>
                                <option value="body" ${p.location==='body'?'selected':''}>Body</option>
                            </select>
                            
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Description</label>
                        <input type="text" value="${p.description}" onchange="apiParams[${i}].description=this.value" class="input-field w-full rounded px-3 py-2 text-sm mt-1" placeholder="The city name">
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="toggle-switch ${p.required?'on':''}" onclick="apiParams[${i}].required=!apiParams[${i}].required;renderApiParams()"></div>
                            <span class="text-sm">Required</span>
                        </div>
                        <button onclick="apiParams.splice(${i},1);renderApiParams()" class="text-gray-500 hover:text-red-400 text-sm">Remove</button>
                    </div>
                </div>
            `).join('')||'<p class="text-gray-500 text-center py-4">No parameters. Click "Add Parameter" to create one.</p>';
        }

        function setConfigMode(mode){
            configMode=mode;
            document.getElementById('config-manual-btn').className='card p-3 md:p-4 rounded-lg text-center'+(mode==='manual'?' border-purple-500 bg-purple-500/10':'');
            document.getElementById('config-spec-btn').className='card p-3 md:p-4 rounded-lg text-center'+(mode==='spec'?' border-purple-500 bg-purple-500/10':'');
            document.getElementById('config-manual-form').classList.toggle('hidden',mode==='spec');
            document.getElementById('config-spec-upload').classList.toggle('hidden',mode==='manual');
        }

        async function handleSpecFile(e){
            const file=e.target.files[0];if(!file)return;
            const fd=new FormData();fd.append('file',file);
            try{
                const r=await fetch(API+'/api/tools/parse-openapi',{method:'POST',body:fd});
                const d=await r.json();
                if(d.base_url)document.getElementById('api-base-url').value=d.base_url;
                if(d.endpoints?.length){
                    const ep=d.endpoints[0];
                    document.getElementById('api-method').value=ep.method;
                    document.getElementById('api-path').value=ep.path;
                    apiParams=ep.parameters.map(p=>({id:Date.now()+Math.random(),name:p.name,description:p.description,data_type:p.data_type,required:p.required,location:p.location}));
                    renderApiParams();
                }
                alert('OpenAPI spec loaded!');
                setConfigMode('manual');
            }catch(e){alert('Failed to parse spec');}
        }

        function toggleAuthFields(){
            const auth=document.getElementById('api-auth').value;
            document.getElementById('auth-value-container').classList.toggle('hidden',auth==='none');
            document.getElementById('api-key-options').classList.toggle('hidden',auth!=='api_key');
        }

        function renderTestParams(){
            document.getElementById('api-test-params').innerHTML=apiParams.map(p=>`
                <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
                    <label class="sm:w-32 text-sm text-gray-400">${p.name}${p.required?' *':''}</label>
                    <input type="text" id="test-param-${p.name}" class="input-field flex-1 rounded px-3 py-2 text-sm" placeholder="Enter ${p.name}">
                </div>
            `).join('')||'<p class="text-gray-500 text-sm">No parameters to test</p>';
        }

        async function testApiConnection(){
            const btn=document.getElementById('test-api-btn');
            btn.disabled=true;btn.textContent='Testing...';
            document.getElementById('api-test-result').classList.remove('hidden');
            document.getElementById('test-status-icon').textContent='';
            document.getElementById('test-status-text').textContent='Testing...';
            const params={};
            apiParams.forEach(p=>{const el=document.getElementById('test-param-'+p.name);if(el&&el.value)params[p.name]=el.value;});
            try{
                const r=await fetch(API+'/api/tools/test-api',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
                    base_url:document.getElementById('api-base-url').value,
                    http_method:document.getElementById('api-method').value,
                    endpoint_path:document.getElementById('api-path').value,
                    auth_type:document.getElementById('api-auth').value,
                    auth_value:document.getElementById('api-auth-value').value,
                    api_key_name:document.getElementById('api-key-name').value,
                    api_key_location:document.getElementById('api-key-loc').value,
                    parameters:params
                })});
                const d=await r.json();
                if(d.success){
                    document.getElementById('test-status-icon').textContent='';
                    document.getElementById('test-status-text').textContent='Success! Status: '+d.status_code;
                }else{
                    document.getElementById('test-status-icon').textContent='';
                    document.getElementById('test-status-text').textContent='Failed: '+(d.error||'Status '+d.status_code);
                }
                document.getElementById('test-response').textContent=JSON.stringify(d.data,null,2);
            }catch(e){
                document.getElementById('test-status-icon').textContent='';
                document.getElementById('test-status-text').textContent='Error: '+e.message;
            }
            btn.disabled=false;btn.textContent=' Test Connection';
        }

        async function createTool(){
            if(!toolType){alert('Select tool type');return;}
            let name,desc,config={},api_config=null;
            
            // Helper function to check if name exists
            function isNameDuplicate(toolName) {
                if(!allTools || !toolName) return false;
                return allTools.some(t => t.name.toLowerCase().trim() === toolName.toLowerCase().trim());
            }
            
            // Knowledge Base Tool
            if(toolType==='knowledge'){
                name=document.getElementById('kb-name').value?.trim();
                desc=document.getElementById('kb-desc').value;
                if(!name){alert('Enter knowledge base name');return;}
                if(isNameDuplicate(name)){
                    alert(` A tool named "${name}" already exists.\nPlease choose a different name.`);
                    return;
                }
                
                // Build KB config
                config = {
                    collection_id: document.getElementById('kb-collection').value || name.toLowerCase().replace(/[^a-z0-9]/g, '_'),
                    // Embedding config
                    embedding: {
                        use_global: document.getElementById('kb-emb-global').checked,
                        provider: document.getElementById('kb-emb-provider').value,
                        model: document.getElementById('kb-emb-model').value,
                        local_model: document.getElementById('kb-emb-local-model').value,
                        api_key: document.getElementById('kb-emb-api-key').value
                    },
                    // Vector DB config
                    vector_db: {
                        use_global: document.getElementById('kb-vdb-global').checked,
                        provider: document.getElementById('kb-vdb-provider').value,
                        pinecone_api_key: document.getElementById('kb-vdb-pinecone-key').value
                    },
                    // RAG Settings
                    chunk_size: parseInt(document.getElementById('kb-chunk-size').value) || 1000,
                    chunk_overlap: parseInt(document.getElementById('kb-chunk-overlap').value) || 200,
                    top_k: parseInt(document.getElementById('kb-top-k').value) || 5,
                    search_type: document.getElementById('kb-search-type').value,
                    similarity_threshold: parseInt(document.getElementById('kb-threshold').value) / 100,
                    // Advanced
                    reranking: document.getElementById('kb-rerank').value,
                    context_window: parseInt(document.getElementById('kb-context-window').value) || 4000,
                    include_metadata: document.getElementById('kb-include-metadata').checked,
                    auto_reindex: document.getElementById('kb-auto-reindex').checked
                };
            }
            else if(toolType==='document'){
                name=document.getElementById('doc-name').value?.trim();
                desc=document.getElementById('doc-desc').value;
                if(!name){alert('Enter tool name');return;}
                if(isNameDuplicate(name)){
                    alert(` A tool named "${name}" already exists.\nPlease choose a different name.`);
                    return;
                }
            }else if(toolType==='website'){
                name=document.getElementById('web-name').value?.trim();
                desc=document.getElementById('web-desc').value;
                config.url=document.getElementById('web-url').value;
                config.recursive=document.getElementById('web-recursive').checked;
                config.max_pages=parseInt(document.getElementById('web-max').value);
                if(!name){alert('Enter tool name');return;}
                if(isNameDuplicate(name)){
                    alert(` A tool named "${name}" already exists.\nPlease choose a different name.`);
                    return;
                }
                if(!config.url){alert('Enter website URL');return;}
            }else if(toolType==='api'){
                name=document.getElementById('api-name').value?.trim();
                desc=document.getElementById('api-desc').value;
                if(!name){alert('Enter tool name');return;}
                if(isNameDuplicate(name)){
                    alert(` A tool named "${name}" already exists.\nPlease choose a different name.`);
                    return;
                }
                api_config={
                    base_url:document.getElementById('api-base-url').value,
                    http_method:document.getElementById('api-method').value,
                    endpoint_path:document.getElementById('api-path').value,
                    auth_type:document.getElementById('api-auth').value,
                    auth_value:document.getElementById('api-auth-value').value,
                    api_key_name:document.getElementById('api-key-name').value,
                    api_key_location:document.getElementById('api-key-loc').value,
                    headers:{},
                    input_parameters:apiParams.map(p=>({name:p.name,description:p.description,data_type:p.data_type,required:p.required,location:p.location}))
                };
            }
            // Email Tool
            else if(toolType==='email'){
                name = document.getElementById('wiz-name')?.value?.trim();
                desc = document.getElementById('wiz-desc')?.value || '';
                if(!name){alert('Enter tool name');return;}
                if(isNameDuplicate(name)){
                    alert(` A tool named "${name}" already exists.\nPlease choose a different name.`);
                    return;
                }
                
                // Get email config from the form
                const emailConfigData = document.getElementById('email-config-data')?.value;
                if(emailConfigData){
                    try {
                        config = JSON.parse(emailConfigData);
                    } catch(e) {
                        config = {};
                    }
                }
                
                // If no OAuth config, check for SendGrid
                if(!config.provider){
                    const sendgridKey = document.getElementById('sendgrid-api-key')?.value;
                    const sendgridFrom = document.getElementById('sendgrid-from-email')?.value;
                    if(sendgridKey && sendgridFrom){
                        config = {
                            provider: 'sendgrid',
                            apiKey: sendgridKey,
                            fromEmail: sendgridFrom
                        };
                    }
                }
                
                if(!config.provider){
                    alert('Please connect an email provider first');
                    return;
                }
            }
            // Generic handler for other tools (webhook, websearch, etc.)
            else {
                name = document.getElementById('wiz-name')?.value?.trim();
                desc = document.getElementById('wiz-desc')?.value || '';
                if(!name){alert('Enter tool name');return;}
                if(isNameDuplicate(name)){
                    alert(` A tool named "${name}" already exists.\nPlease choose a different name.`);
                    return;
                }
            }
            
            // Show progress modal
            showProgressModal('Creating tool...');
            
            try {
                updateProgress(10, ' Creating tool...');
                const r=await fetch(API+'/api/tools',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:toolType,name,description:desc,config,api_config})});
                
                // Check for errors (including duplicate name)
                if(!r.ok) {
                    const errorData = await r.json().catch(() => ({}));
                    const errorMsg = errorData.detail || errorData.message || `Error: ${r.status}`;
                    hideProgressModal();
                    alert(' ' + errorMsg);
                    return;
                }
                
                const d=await r.json();
                
                if(toolType==='document'&&uploadedFiles.length){
                    updateProgress(30, ' Uploading documents...');
                    for(let i=0; i<uploadedFiles.length; i++){
                        const f = uploadedFiles[i];
                        updateProgress(30 + (i/uploadedFiles.length)*60, ` Uploading ${f.name}...`);
                        const fd=new FormData();
                        fd.append('file',f);
                        await fetch(API+'/api/tools/'+d.tool_id+'/documents',{method:'POST',body:fd});
                    }
                    updateProgress(100, ' Documents uploaded!');
                }
                
                if(toolType==='website'&&config.url){
                    updateProgress(20, ' Starting web scraper...');
                    
                    // Check if dynamic site
                    const domain = new URL(config.url).hostname;
                    const dynamicSites = ['oracle.com','azure.microsoft.com','cloud.google.com','aws.amazon.com','digitalocean.com','vercel.com','netlify.com','heroku.com'];
                    const isDynamic = dynamicSites.some(s => domain.includes(s));
                    
                    let progressInterval;
                    let currentProgress = 20;
                    
                    if(isDynamic){
                        updateProgress(25, ' Detected dynamic site - launching Playwright browser...');
                        
                        // Simulate progress during long scrape
                        const progressSteps = [
                            {p: 30, msg: ' [1/7] Launching Chromium browser...'},
                            {p: 35, msg: ' [2/7] Creating browser context...'},
                            {p: 40, msg: ' [3/7] Navigating to page...'},
                            {p: 50, msg: ' [4/7] Waiting for JavaScript to render...'},
                            {p: 60, msg: ' [5/7] Scrolling to load dynamic content...'},
                            {p: 70, msg: ' [6/7] Extracting rendered HTML...'},
                            {p: 80, msg: ' Extracting tables and pricing data...'},
                        ];
                        let stepIndex = 0;
                        
                        progressInterval = setInterval(() => {
                            if(stepIndex < progressSteps.length){
                                updateProgress(progressSteps[stepIndex].p, progressSteps[stepIndex].msg);
                                stepIndex++;
                            }
                        }, 4000); // Every 4 seconds
                    } else {
                        updateProgress(30, ' Fetching page content...');
                        progressInterval = setInterval(() => {
                            if(currentProgress < 80){
                                currentProgress += 10;
                                updateProgress(currentProgress, ' Processing page...');
                            }
                        }, 2000);
                    }
                    
                    try {
                        const scrapeResult = await fetch(API+'/api/tools/'+d.tool_id+'/scrape',{
                            method:'POST',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({url:config.url,recursive:config.recursive,max_pages:config.max_pages})
                        });
                        
                        clearInterval(progressInterval);
                        
                        const scrapeData = await scrapeResult.json();
                        
                        if(scrapeData.pages_scraped > 0){
                            updateProgress(100, ` Successfully scraped ${scrapeData.pages_scraped} page(s)!`);
                        } else {
                            updateProgress(100, ' No content found on page');
                        }
                    } catch(scrapeError) {
                        clearInterval(progressInterval);
                        updateProgress(100, ` Scrape failed: ${scrapeError.message}`);
                    }
                }
                
                if(toolType==='api'){
                    updateProgress(100, ' API Tool created!');
                }
                
                // Wait a moment to show success
                await new Promise(r => setTimeout(r, 1500));
                
                hideProgressModal();
                hideModal('modal-tool');
                loadTools();
                loadWizardTools();
                
                // Navigate to tool detail to see the scraped data
                viewTool(d.tool_id);
                
            } catch(error) {
                updateProgress(0, ` Error: ${error.message}`);
                await new Promise(r => setTimeout(r, 2000));
                hideProgressModal();
            }
        }
        
        function showProgressModal(title){
            document.getElementById('progress-modal').classList.remove('hidden');
            document.getElementById('progress-title').textContent = title;
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-status').textContent = 'Starting...';
            document.getElementById('progress-log').innerHTML = '';
            // Disable create button (check both possible IDs)
            const createBtn = document.getElementById('create-tool-btn') || document.getElementById('btn-create');
            if (createBtn) {
                createBtn.disabled = true;
                createBtn.dataset.originalText = createBtn.textContent;
                createBtn.textContent = 'Creating...';
            }
        }
        
        function updateProgress(percent, status){
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-status').textContent = status;
            // Add to log
            const log = document.getElementById('progress-log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `<div class="text-xs text-gray-400">[${time}] ${status}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function hideProgressModal(){
            document.getElementById('progress-modal').classList.add('hidden');
            document.getElementById('progress-log').innerHTML = '';
            // Re-enable create button (check both possible IDs)
            const createBtn = document.getElementById('create-tool-btn') || document.getElementById('btn-create');
            if (createBtn) {
                createBtn.disabled = false;
                createBtn.textContent = createBtn.dataset.originalText || 'Create Tool';
            }
        }

        async function loadChatAgents(){
            const r=await fetch(API+'/api/agents?status=published');
            const d=await r.json();
            document.getElementById('chat-agent').innerHTML='<option value="">Select Agent...</option>'+d.agents.map(a=>`<option value="${a.id}">${a.icon} ${a.name}</option>`).join('');
        }

        async function onAgentChange(){
            const id=document.getElementById('chat-agent').value;
            if(!id)return;
            const r=await fetch(API+'/api/agents/'+id+'/conversations');
            const d=await r.json();
            document.getElementById('chat-conv').innerHTML='<option value="">New Chat</option>'+d.conversations.map(c=>`<option value="${c.id}">${c.title}</option>`).join('');
            clearMsgs();conv=null;
        }

        async function onConvChange(){
            const cid=document.getElementById('chat-conv').value;
            if(!cid){clearMsgs();conv=null;return;}
            const r=await fetch(API+'/api/conversations/'+cid);
            const c=await r.json();
            conv=cid;
            document.getElementById('chat-messages').innerHTML='';
            c.messages.forEach(m=>{if(m.role==='user'||m.role==='assistant')addMsg(m.role,m.content,m.sources);});
        }

        // File handling for chat
        function handleChatFile(event){
            const files = Array.from(event.target.files);
            chatAttachments = [...chatAttachments, ...files];
            renderChatAttachments();
            event.target.value = '';
        }
        
        function handleTestFile(event){
            const files = Array.from(event.target.files);
            testAttachments = [...testAttachments, ...files];
            renderTestAttachments();
            event.target.value = '';
        }
        
        function renderChatAttachments(){
            const container = document.getElementById('chat-attachments');
            if(chatAttachments.length === 0){
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');
            container.innerHTML = chatAttachments.map((f, i) => `
                <div class="flex items-center gap-2 bg-gray-700 rounded-lg px-3 py-1 text-sm">
                    <span>${getFileIcon(f.name)} ${f.name.substring(0, 20)}${f.name.length > 20 ? '...' : ''}</span>
                    <button onclick="removeChatAttachment(${i})" class="text-red-400 hover:text-red-300"></button>
                </div>
            `).join('');
        }
        
        function renderTestAttachments(){
            const container = document.getElementById('test-attachments');
            if(testAttachments.length === 0){
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');
            container.innerHTML = testAttachments.map((f, i) => `
                <div class="flex items-center gap-2 bg-gray-700 rounded-lg px-3 py-1 text-sm">
                    <span>${getFileIcon(f.name)} ${f.name.substring(0, 20)}${f.name.length > 20 ? '...' : ''}</span>
                    <button onclick="removeTestAttachment(${i})" class="text-red-400 hover:text-red-300"></button>
                </div>
            `).join('');
        }
        
        function getFileIcon(filename){
            const ext = filename.toLowerCase().split('.').pop();
            const icons = {
                'pdf': '',
                'doc': '', 'docx': '',
                'xls': '', 'xlsx': '',
                'ppt': '', 'pptx': '',
                'csv': '',
                'txt': '', 'md': '',
                'png': '', 'jpg': '', 'jpeg': '', 'gif': '', 'webp': '', 'bmp': '', 'svg': ''
            };
            return icons[ext] || '';
        }
        
        function removeChatAttachment(index){
            chatAttachments.splice(index, 1);
            renderChatAttachments();
        }
        
        function removeTestAttachment(index){
            testAttachments.splice(index, 1);
            renderTestAttachments();
        }

        async function sendMsg(){
            const aid=document.getElementById('chat-agent').value;
            const inp=document.getElementById('chat-input');
            const m=inp.value.trim();
            if(!aid){alert('Please select an agent');return;}
            if(!m && chatAttachments.length === 0)return;
            inp.value='';
            
            // Get user's timezone
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            // Show message with attachments
            let displayMsg = m;
            if(chatAttachments.length > 0){
                displayMsg += '\n\n Attachments: ' + chatAttachments.map(f => f.name).join(', ');
            }
            addMsg('user', displayMsg);
            addTyping();
            
            try{
                let response;
                if(chatAttachments.length > 0){
                    // Send with FormData for file upload
                    const formData = new FormData();
                    formData.append('message', m);
                    formData.append('timezone', userTimezone);
                    if(conv) formData.append('conversation_id', conv);
                    chatAttachments.forEach(f => formData.append('files', f));
                    response = await fetch(API+'/api/agents/'+aid+'/chat-with-files', {method:'POST', body: formData});
                } else {
                    response = await fetch(API+'/api/agents/'+aid+'/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:m,conversation_id:conv,timezone:userTimezone})});
                }
                const d=await response.json();
                rmTyping();
                conv=d.conversation_id;
                addMsg('assistant',d.response,d.sources);
                const sel=document.getElementById('chat-conv');
                if(!sel.querySelector(`option[value="${d.conversation_id}"]`)){
                    const o=document.createElement('option');
                    o.value=d.conversation_id;
                    o.textContent=m.substring(0,30)+'...';
                    sel.insertBefore(o,sel.firstChild.nextSibling);
                    sel.value=d.conversation_id;
                }
                // Clear attachments after send
                chatAttachments = [];
                renderChatAttachments();
            }catch(e){rmTyping();addMsg('error','Error: '+e.message);}
        }

        function addMsg(role,content,sources=[]){
            const c=document.getElementById('chat-messages');
            const d=document.createElement('div');
            d.className='animate-fade-in';
            if(role==='user')d.innerHTML=`<div class="flex justify-end"><div class="bg-purple-600 rounded-2xl rounded-tr-sm px-3 md:px-4 py-2 md:py-3 max-w-[85%] md:max-w-[70%] text-sm md:text-base">${esc(content)}</div></div>`;
            else if(role==='assistant'){
                d.innerHTML=`<div class="flex"><div class="bg-gray-700 rounded-2xl rounded-tl-sm px-3 md:px-4 py-2 md:py-3 max-w-[85%] md:max-w-[70%] chat-content text-sm md:text-base">${fmt(content)}</div></div>`;
                if(sources?.length)d.innerHTML+=`<div class="mt-1 ml-2 flex flex-wrap gap-1">${sources.map(s=>`<span class="source-badge px-2 py-1 rounded text-xs">${s.source}</span>`).join('')}</div>`;
            }else d.innerHTML=`<div class="text-center text-red-400 text-sm py-2">${content}</div>`;
            c.appendChild(d);
            c.scrollTop=c.scrollHeight;
            d.querySelectorAll('pre code').forEach(b=>hljs.highlightElement(b));
        }

        function addTyping(){
            const c=document.getElementById('chat-messages');
            const d=document.createElement('div');
            d.id='typing';
            d.innerHTML=`<div class="flex"><div class="bg-gray-700 rounded-2xl px-4 py-3"><div class="flex gap-1"><span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span><span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay:0.1s"></span><span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay:0.2s"></span></div></div></div>`;
            c.appendChild(d);
            c.scrollTop=c.scrollHeight;
        }

        function rmTyping(){document.getElementById('typing')?.remove();}
        function clearChat(){conv=null;document.getElementById('chat-conv').value='';clearMsgs();}
        function clearMsgs(){document.getElementById('chat-messages').innerHTML=`<div class="text-center text-gray-500 py-10 md:py-20"><span class="text-4xl md:text-6xl mb-4 block"></span><p>Start a conversation!</p></div>`;}
        function showModal(id){document.getElementById(id).classList.remove('hidden');}
        function hideModal(id){document.getElementById(id).classList.add('hidden');}
        function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
        function fmt(t){
            // Clean LaTeX notation for better display
            let text = t;
            // Convert LaTeX math symbols to readable format
            text = text.replace(/\\times/g, '');
            text = text.replace(/\\div/g, '');
            text = text.replace(/\\pm/g, '');
            text = text.replace(/\\leq/g, '');
            text = text.replace(/\\geq/g, '');
            text = text.replace(/\\neq/g, '');
            text = text.replace(/\\approx/g, '');
            text = text.replace(/\\cdot/g, '');
            text = text.replace(/\\text\{([^}]+)\}/g, '$1');
            // Remove LaTeX brackets but keep content
            text = text.replace(/\\\[/g, '');
            text = text.replace(/\\\]/g, '');
            text = text.replace(/\\\(/g, '');
            text = text.replace(/\\\)/g, '');
            // Clean up display math blocks
            text = text.replace(/\[\s*([^\]]+)\s*\]/g, (match, content) => {
                // If it looks like math (has operators), format it nicely
                if(content.includes('=') || content.includes('') || content.includes('+') || content.includes('-')){
                    return '\n**' + content.trim() + '**\n';
                }
                return match;
            });
            
            if(typeof marked!=='undefined'){
                marked.setOptions({breaks:true,gfm:true});
                return marked.parse(text);
            }
            return esc(text).replace(/\n/g,'<br>');
        }
        function fileIcon(ext){const i={pdf:'',doc:'',docx:'',xls:'',xlsx:'',ppt:'',pptx:'',txt:'',csv:'',md:''};return i[ext?.toLowerCase()]||'';}
        function fmtSize(b){if(b<1024)return b+' B';if(b<1024*1024)return(b/1024).toFixed(1)+' KB';return(b/1024/1024).toFixed(1)+' MB';}

        // ============================================================================
        // Theme Functions
        // ============================================================================
        
        const THEMES = ['dark', 'light', 'ocean', 'sunset', 'forest', 'midnight'];
        
        function setTheme(themeName) {
            if (!THEMES.includes(themeName)) themeName = 'dark';
            
            // Remove old theme
            document.documentElement.removeAttribute('data-theme');
            
            // Apply new theme (dark is default, so no attribute needed)
            if (themeName !== 'dark') {
                document.documentElement.setAttribute('data-theme', themeName);
            }
            
            // Save preference
            localStorage.setItem('agentforge-theme', themeName);
            
            // Update UI buttons
            updateThemeButtons(themeName);
            
            console.log('Theme changed to:', themeName);
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('agentforge-theme') || 'dark';
            setTheme(savedTheme);
        }
        
        function updateThemeButtons(activeTheme) {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                const btnTheme = btn.getAttribute('data-theme-btn');
                const checkmark = btn.querySelector('.theme-check');
                
                if (btnTheme === activeTheme) {
                    btn.classList.add('border-purple-500', 'bg-purple-500/10');
                    btn.classList.remove('border-gray-700', 'border-transparent');
                    if (checkmark) checkmark.classList.remove('hidden');
                    if (checkmark) checkmark.classList.add('flex');
                } else {
                    btn.classList.remove('border-purple-500', 'bg-purple-500/10');
                    btn.classList.add('border-gray-700');
                    if (checkmark) checkmark.classList.add('hidden');
                    if (checkmark) checkmark.classList.remove('flex');
                }
            });
        }
        
        // ============================================================================
        // INTEGRATION SETUP (Admin Only)
        // ============================================================================
        
        function showIntegrationSetup(provider) {
            const providerInfo = {
                google: {
                    name: 'Google',
                    icon: `<svg width="32" height="32" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>`,
                    consoleUrl: 'https://console.cloud.google.com/apis/credentials',
                    apiUrl: 'https://console.cloud.google.com/apis/library/gmail.googleapis.com',
                    scopes: 'Gmail API (gmail.send)',
                    envVars: ['GOOGLE_CLIENT_ID', 'GOOGLE_CLIENT_SECRET']
                },
                microsoft: {
                    name: 'Microsoft',
                    icon: `<svg width="32" height="32" viewBox="0 0 21 21">
                        <rect x="1" y="1" width="9" height="9" fill="#F25022"/>
                        <rect x="11" y="1" width="9" height="9" fill="#7FBA00"/>
                        <rect x="1" y="11" width="9" height="9" fill="#00A4EF"/>
                        <rect x="11" y="11" width="9" height="9" fill="#FFB900"/>
                    </svg>`,
                    consoleUrl: 'https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade',
                    apiUrl: '',
                    scopes: 'Mail.Send, User.Read',
                    envVars: ['MICROSOFT_CLIENT_ID', 'MICROSOFT_CLIENT_SECRET']
                }
            };
            
            const info = providerInfo[provider];
            const redirectUri = `${window.location.origin}/api/oauth/${provider}/callback`;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4';
            modal.id = 'integration-setup-modal';
            modal.innerHTML = `
                <div class="modal-content-box rounded-2xl w-full max-w-xl max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b flex items-center justify-between shrink-0" style="border-color:var(--border-color);">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-white flex items-center justify-center">
                                ${info.icon}
                            </div>
                            <h3 class="font-bold text-lg" style="color:var(--text-primary);">Configure ${info.name}</h3>
                        </div>
                        <button onclick="document.getElementById('integration-setup-modal').remove()" 
                                class="text-gray-400 hover:text-white text-xl"></button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto flex-1 space-y-6">
                        <!-- Steps -->
                        <div class="space-y-4">
                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center shrink-0 text-sm font-bold">1</div>
                                <div class="flex-1">
                                    <h5 class="font-medium" style="color:var(--text-primary);">Create OAuth App</h5>
                                    <p class="text-sm mt-1" style="color:var(--text-muted);">Create a new OAuth application in ${info.name} Console</p>
                                    <a href="${info.consoleUrl}" target="_blank" 
                                       class="inline-flex items-center gap-1 text-sm text-purple-400 hover:underline mt-2">
                                        Open ${info.name} Console 
                                    </a>
                                </div>
                            </div>
                            
                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center shrink-0 text-sm font-bold">2</div>
                                <div class="flex-1">
                                    <h5 class="font-medium" style="color:var(--text-primary);">Set Redirect URI</h5>
                                    <p class="text-sm mt-1" style="color:var(--text-muted);">Add this redirect URI to your OAuth app:</p>
                                    <div class="flex items-center gap-2 mt-2">
                                        <code class="flex-1 text-xs p-2 rounded" style="background:var(--bg-input);color:var(--text-secondary);">${redirectUri}</code>
                                        <button onclick="navigator.clipboard.writeText('${redirectUri}'); showToast('Copied!', 'success')" 
                                                class="btn-secondary px-3 py-2 rounded text-xs">Copy</button>
                                    </div>
                                </div>
                            </div>
                            
                            ${info.apiUrl ? `
                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center shrink-0 text-sm font-bold">3</div>
                                <div class="flex-1">
                                    <h5 class="font-medium" style="color:var(--text-primary);">Enable API</h5>
                                    <p class="text-sm mt-1" style="color:var(--text-muted);">Enable ${info.scopes}</p>
                                    <a href="${info.apiUrl}" target="_blank" 
                                       class="inline-flex items-center gap-1 text-sm text-purple-400 hover:underline mt-2">
                                        Enable API 
                                    </a>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center shrink-0 text-sm font-bold">${info.apiUrl ? '4' : '3'}</div>
                                <div class="flex-1">
                                    <h5 class="font-medium" style="color:var(--text-primary);">Enter Credentials</h5>
                                    <p class="text-sm mt-1 mb-3" style="color:var(--text-muted);">Copy your Client ID and Secret from ${info.name}</p>
                                    
                                    <div class="space-y-3">
                                        <div>
                                            <label class="text-sm mb-1 block" style="color:var(--text-secondary);">Client ID</label>
                                            <input type="text" id="integration-client-id" 
                                                   class="input-field w-full rounded-lg px-4 py-2" 
                                                   placeholder="Enter Client ID">
                                        </div>
                                        <div>
                                            <label class="text-sm mb-1 block" style="color:var(--text-secondary);">Client Secret</label>
                                            <input type="password" id="integration-client-secret" 
                                                   class="input-field w-full rounded-lg px-4 py-2" 
                                                   placeholder="Enter Client Secret">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 border-t flex justify-between shrink-0" style="border-color:var(--border-color);">
                        <button onclick="document.getElementById('integration-setup-modal').remove()" 
                                class="btn-secondary px-6 py-2 rounded-lg">Cancel</button>
                        <button onclick="saveIntegration('${provider}')" 
                                class="btn-primary px-6 py-2 rounded-lg flex items-center gap-2">
                            <span>Save & Test</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function saveIntegration(provider) {
            const clientId = document.getElementById('integration-client-id')?.value;
            const clientSecret = document.getElementById('integration-client-secret')?.value;
            
            if (!clientId || !clientSecret) {
                showToast('Please fill in both Client ID and Client Secret', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/settings/integrations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, clientId, clientSecret })
                });
                
                if (res.ok) {
                    document.getElementById('integration-setup-modal')?.remove();
                    showToast(`${provider === 'google' ? 'Google' : 'Microsoft'} integration saved!`, 'success');
                    
                    // Update status
                    const statusEl = document.getElementById(`${provider}-integration-status`);
                    if (statusEl) {
                        statusEl.textContent = ' Configured';
                        statusEl.style.color = '#22c55e';
                    }
                } else {
                    showToast('Failed to save integration', 'error');
                }
            } catch (err) {
                showToast('Error saving integration', 'error');
            }
        }
        
        // Load theme on page load
        loadTheme();

        // ============================================================================
        // Settings Functions
        // ============================================================================
        
        let currentSettings = null;
        
        async function loadSettings() {
            try {
                const r = await fetch(API + '/api/settings');
                const data = await r.json();
                currentSettings = data.settings;
                populateSettingsForm(currentSettings);
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }
        
        function populateSettingsForm(settings) {
            // Load configured LLM providers
            configuredLLMProviders = settings.llm_providers || [];
            
            // If no providers array but has legacy llm config, convert it
            if (configuredLLMProviders.length === 0 && settings.llm?.api_key) {
                const config = getProviderConfig(settings.llm.provider);
                configuredLLMProviders.push({
                    provider: settings.llm.provider,
                    name: config.name,
                    api_key: settings.llm.api_key,
                    api_base: settings.llm.api_base || '',
                    resource: settings.llm.resource || '',
                    models: config.models
                });
            }
            
            renderConfiguredProviders();
            updateDefaultProviderDropdown();
            
            // Set default provider and model
            if (settings.llm?.provider) {
                const defaultSelect = document.getElementById('default-llm-provider');
                if (defaultSelect) {
                    defaultSelect.value = settings.llm.provider;
                    onDefaultProviderChange();
                    if (settings.llm.model) {
                        document.getElementById('default-llm-model').value = settings.llm.model;
                    }
                }
            }
            
            // Initialize add provider form
            onLLMProviderChange();
            
            // Embedding
            document.getElementById('emb-provider').value = settings.embedding?.provider || 'openai';
            document.getElementById('emb-model').value = settings.embedding?.model || 'text-embedding-3-small';
            document.getElementById('emb-local-model').value = settings.embedding?.local_model || 'all-MiniLM-L6-v2';
            document.getElementById('emb-api-key').value = settings.embedding?.api_key || '';
            onEmbeddingProviderChange();
            
            // Vector DB
            document.getElementById('vdb-provider').value = settings.vector_db?.provider || 'memory';
            document.getElementById('vdb-chroma-path').value = settings.vector_db?.chroma_path || './data/chromadb';
            document.getElementById('vdb-pinecone-key').value = settings.vector_db?.pinecone_api_key || '';
            document.getElementById('vdb-pinecone-index').value = settings.vector_db?.pinecone_index || '';
            onVectorDBProviderChange();
            
            // RAG Settings
            document.getElementById('rag-chunk-size').value = settings.chunk_size || 1000;
            document.getElementById('rag-chunk-overlap').value = settings.chunk_overlap || 200;
            document.getElementById('rag-top-k').value = settings.search_top_k || 5;
            
            // Feature Toggles
            updateToggle('toggle-rag', settings.enable_rag);
            updateToggle('toggle-scraping', settings.enable_web_scraping);
            updateToggle('toggle-api', settings.enable_api_tools);
            
            updateVDBStatus();
        }
        
        function updateToggle(id, enabled) {
            const el = document.getElementById(id);
            if (enabled) {
                el.classList.add('on');
            } else {
                el.classList.remove('on');
            }
        }
        
        function toggleFeature(feature) {
            const toggleId = feature === 'rag' ? 'toggle-rag' : feature === 'scraping' ? 'toggle-scraping' : 'toggle-api';
            const el = document.getElementById(toggleId);
            el.classList.toggle('on');
        }
        
        function onLLMProviderChange() {
            const provider = document.getElementById('llm-provider').value;
            const apiKeyGroup = document.getElementById('llm-api-key-group');
            const apiBaseGroup = document.getElementById('llm-api-base-group');
            const resourceGroup = document.getElementById('llm-resource-group');
            const providerInfo = document.getElementById('llm-provider-info');
            const providerInfoText = document.getElementById('llm-provider-info-text');
            const providerLink = document.getElementById('llm-provider-link');
            const modelsPreview = document.getElementById('llm-models-preview');
            const modelsListPreview = document.getElementById('llm-models-list-preview');
            
            const config = getProviderConfig(provider);
            
            // Show/hide fields based on provider
            apiKeyGroup.classList.toggle('hidden', !config.needsApiKey);
            apiBaseGroup.classList.toggle('hidden', !config.needsApiBase);
            resourceGroup.classList.toggle('hidden', !config.needsResource);
            
            // Update placeholder
            if (config.needsApiKey) {
                document.getElementById('llm-api-key').placeholder = config.keyPlaceholder;
            }
            
            // Clear API key field when changing provider
            document.getElementById('llm-api-key').value = '';
            document.getElementById('llm-api-base').value = '';
            
            // Show provider info
            providerInfoText.textContent = config.info;
            if (config.link) {
                providerLink.href = config.link;
                providerLink.classList.remove('hidden');
            } else {
                providerLink.classList.add('hidden');
            }
            
            // Show supported models preview
            if (modelsPreview && modelsListPreview) {
                modelsPreview.classList.remove('hidden');
                modelsListPreview.innerHTML = config.models.map(m => 
                    `<span class="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded">${m}</span>`
                ).join('');
            }
            
            // Set default API base for local providers
            const apiBaseInput = document.getElementById('llm-api-base');
            if (provider === 'ollama') {
                apiBaseInput.placeholder = 'http://localhost:11434';
                apiBaseInput.value = 'http://localhost:11434';
            } else if (provider === 'lmstudio') {
                apiBaseInput.placeholder = 'http://localhost:1234/v1';
                apiBaseInput.value = 'http://localhost:1234/v1';
            } else {
                apiBaseInput.placeholder = 'https://api.example.com/v1';
            }
        }
        
        // Update the provider dropdown to hide already configured providers
        function updateProviderDropdown() {
            const select = document.getElementById('llm-provider');
            if (!select) return;
            
            const configuredProviderIds = configuredLLMProviders.map(p => p.provider);
            
            // Get all options
            const options = select.querySelectorAll('option');
            let firstAvailable = null;
            let hasAvailable = false;
            
            options.forEach(option => {
                if (option.value && configuredProviderIds.includes(option.value)) {
                    // Hide configured providers
                    option.style.display = 'none';
                } else if (option.value) {
                    option.style.display = '';
                    hasAvailable = true;
                    if (!firstAvailable) {
                        firstAvailable = option.value;
                    }
                }
            });
            
            // If current selection is configured, switch to first available
            if (configuredProviderIds.includes(select.value) && firstAvailable) {
                select.value = firstAvailable;
                onLLMProviderChange();
            }
            
            // If all providers are configured, hide the add section
            const addSection = document.querySelector('.border-t.border-gray-700.pt-4');
            if (addSection) {
                if (!hasAvailable) {
                    addSection.innerHTML = `
                        <div class="text-center py-6">
                            <span class="text-3xl"></span>
                            <p class="text-gray-400 mt-2 font-medium">All providers configured!</p>
                            <p class="text-xs text-gray-500 mt-1">You can remove a provider above to add a different configuration.</p>
                        </div>
                    `;
                }
            }
        }
        
        // Provider configurations (shared across functions)
        function getProviderConfig(provider) {
            const providerConfigs = {
                openai: {
                    name: 'OpenAI',
                    models: ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-3.5-turbo', 'o1-preview', 'o1-mini'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'sk-...',
                    info: 'Industry-leading models with excellent reasoning capabilities',
                    link: 'https://platform.openai.com/api-keys'
                },
                anthropic: {
                    name: 'Anthropic',
                    models: ['claude-sonnet-4-20250514', 'claude-opus-4-20250514', 'claude-3-5-sonnet-20241022', 'claude-3-5-haiku-20241022'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'sk-ant-...',
                    info: 'Excellent for writing, analysis, and nuanced conversations',
                    link: 'https://console.anthropic.com/settings/keys'
                },
                google: {
                    name: 'Google',
                    models: ['gemini-1.5-pro', 'gemini-1.5-flash', 'gemini-pro', 'gemini-pro-vision'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'AIza...',
                    info: 'Multimodal models with long context support (up to 1M tokens)',
                    link: 'https://aistudio.google.com/app/apikey'
                },
                xai: {
                    name: 'xAI',
                    models: ['grok-2', 'grok-2-mini', 'grok-beta'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'xai-...',
                    info: 'Grok models by xAI with real-time knowledge',
                    link: 'https://console.x.ai/'
                },
                groq: {
                    name: 'Groq',
                    models: ['llama-3.3-70b-versatile', 'llama-3.1-70b-versatile', 'llama-3.1-8b-instant', 'mixtral-8x7b-32768', 'gemma2-9b-it'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'gsk_...',
                    info: 'Ultra-fast inference with open-source models',
                    link: 'https://console.groq.com/keys'
                },
                mistral: {
                    name: 'Mistral',
                    models: ['mistral-large-latest', 'mistral-medium-latest', 'mistral-small-latest', 'open-mixtral-8x22b', 'codestral-latest'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'Your Mistral API key',
                    info: 'Efficient European AI models with strong multilingual support',
                    link: 'https://console.mistral.ai/api-keys/'
                },
                deepseek: {
                    name: 'DeepSeek',
                    models: ['deepseek-chat', 'deepseek-coder', 'deepseek-reasoner'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'sk-...',
                    info: 'Cost-effective models with strong coding capabilities',
                    link: 'https://platform.deepseek.com/api_keys'
                },
                together: {
                    name: 'Together AI',
                    models: ['meta-llama/Llama-3.3-70B-Instruct-Turbo', 'meta-llama/Llama-3.1-405B-Instruct-Turbo', 'mistralai/Mixtral-8x22B-Instruct-v0.1'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'Your Together API key',
                    info: 'Access to 100+ open-source models',
                    link: 'https://api.together.xyz/settings/api-keys'
                },
                perplexity: {
                    name: 'Perplexity',
                    models: ['llama-3.1-sonar-large-128k-online', 'llama-3.1-sonar-small-128k-online', 'llama-3.1-sonar-huge-128k-online'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'pplx-...',
                    info: 'Models with real-time internet search capabilities',
                    link: 'https://www.perplexity.ai/settings/api'
                },
                cohere: {
                    name: 'Cohere',
                    models: ['command-a-03-2025', 'command-r-plus-08-2024', 'command-r-08-2024', 'command-r7b-12-2024'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'Your Cohere API key',
                    info: 'Enterprise-focused models with RAG capabilities',
                    link: 'https://dashboard.cohere.com/api-keys'
                },
                azure_openai: {
                    name: 'Azure OpenAI',
                    models: ['gpt-4o', 'gpt-4', 'gpt-35-turbo'],
                    needsApiKey: true, needsApiBase: true, needsResource: true,
                    keyPlaceholder: 'Your Azure API key',
                    info: 'Enterprise Azure-hosted OpenAI models',
                    link: 'https://portal.azure.com/'
                },
                aws_bedrock: {
                    name: 'AWS Bedrock',
                    models: ['anthropic.claude-3-5-sonnet-20241022-v2:0', 'anthropic.claude-3-sonnet-20240229-v1:0', 'amazon.titan-text-premier-v1:0'],
                    needsApiKey: true, needsApiBase: true, needsResource: true,
                    keyPlaceholder: 'AWS Access Key',
                    info: 'AWS-hosted models with enterprise security',
                    link: 'https://aws.amazon.com/bedrock/'
                },
                ollama: {
                    name: 'Ollama',
                    models: ['llama3.2', 'llama3.1', 'llama3.1:70b', 'mistral', 'mixtral', 'codellama', 'phi3', 'gemma2', 'qwen2.5'],
                    needsApiKey: false, needsApiBase: true, needsResource: false,
                    keyPlaceholder: '',
                    info: 'Run open-source models locally for free',
                    link: 'https://ollama.ai/'
                },
                lmstudio: {
                    name: 'LM Studio',
                    models: ['local-model'],
                    needsApiKey: false, needsApiBase: true, needsResource: false,
                    keyPlaceholder: '',
                    info: 'Run models locally with LM Studio GUI',
                    link: 'https://lmstudio.ai/'
                },
                custom: {
                    name: 'Custom',
                    models: ['custom-model'],
                    needsApiKey: true, needsApiBase: true, needsResource: false,
                    keyPlaceholder: 'Your API key',
                    info: 'Any OpenAI-compatible API endpoint',
                    link: ''
                }
            };
            return providerConfigs[provider] || providerConfigs.openai;
        }
        
        // Configured LLM Providers storage
        let configuredLLMProviders = [];
        
        function addLLMProvider() {
            const provider = document.getElementById('llm-provider').value;
            const apiKey = document.getElementById('llm-api-key').value;
            const apiBase = document.getElementById('llm-api-base').value;
            const resource = document.getElementById('llm-resource')?.value || '';
            
            const config = getProviderConfig(provider);
            
            // Validation
            if (config.needsApiKey && !apiKey) {
                alert('Please enter an API key');
                return;
            }
            if (config.needsApiBase && !apiBase) {
                alert('Please enter an API base URL');
                return;
            }
            
            // Add new provider
            configuredLLMProviders.push({
                provider,
                name: config.name,
                api_key: apiKey,
                api_base: apiBase,
                resource: resource,
                models: config.models
            });
            
            // Clear form
            document.getElementById('llm-api-key').value = '';
            document.getElementById('llm-api-base').value = '';
            if (document.getElementById('llm-resource')) {
                document.getElementById('llm-resource').value = '';
            }
            
            // Update UI
            renderConfiguredProviders();
            updateDefaultProviderDropdown();
            
            // Auto-select as default if it's the first one
            if (configuredLLMProviders.length === 1) {
                document.getElementById('default-llm-provider').value = provider;
                onDefaultProviderChange();
            }
            
            // Auto-save
            saveSettingsQuiet();
            
            // Show success message
            showToast(` ${config.name} added successfully!`, 'success');
        }
        
        // Toast notification helper
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transition-all transform translate-y-0 ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 'bg-gray-700'
            }`;
            toast.innerHTML = `<span class="text-white text-sm">${message}</span>`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function removeLLMProvider(provider) {
            if (!confirm('Are you sure you want to remove this provider?')) {
                return;
            }
            
            configuredLLMProviders = configuredLLMProviders.filter(p => p.provider !== provider);
            renderConfiguredProviders();
            updateDefaultProviderDropdown();
            saveSettingsQuiet();
        }
        
        function renderConfiguredProviders() {
            const container = document.getElementById('configured-providers-table');
            const noProvidersMsg = document.getElementById('no-providers-msg');
            
            if (configuredLLMProviders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500 text-sm" id="no-providers-msg">
                        <span class="text-2xl block mb-2"></span>
                        No providers configured yet. Add one below.
                    </div>
                `;
                updateProviderDropdown();
                return;
            }
            
            container.innerHTML = configuredLLMProviders.map((p, idx) => {
                const maskedKey = p.api_key ? '' + p.api_key.slice(-4) : 'No key';
                const isDefault = currentSettings?.llm?.provider === p.provider;
                
                return `
                    <div class="bg-gray-800/50 rounded-lg p-3 border ${isDefault ? 'border-purple-500' : 'border-gray-700'}" id="provider-card-${p.provider}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${getProviderIcon(p.provider)}</span>
                                <span class="font-medium">${p.name}</span>
                                ${isDefault ? '<span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded">Default</span>' : ''}
                            </div>
                            <div class="flex items-center gap-1">
                                <button onclick="event.stopPropagation(); testConfiguredProvider('${p.provider}')" 
                                        class="text-xs text-gray-400 hover:text-green-400 px-2 py-1.5 rounded hover:bg-gray-700 transition-colors" 
                                        title="Test Connection">
                                    
                                </button>
                                <button onclick="event.stopPropagation(); editLLMProvider('${p.provider}')" 
                                        class="text-xs text-gray-400 hover:text-blue-400 px-2 py-1.5 rounded hover:bg-gray-700 transition-colors" 
                                        title="Edit API Key">
                                    
                                </button>
                                <button onclick="event.stopPropagation(); removeLLMProvider('${p.provider}')" 
                                        class="text-xs text-gray-400 hover:text-red-400 px-2 py-1.5 rounded hover:bg-gray-700 transition-colors" 
                                        title="Remove Provider">
                                    
                                </button>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">
                            API Key: <span class="text-gray-400">${maskedKey}</span>
                            ${p.api_base ? `  Base: <span class="text-gray-400">${p.api_base}</span>` : ''}
                        </div>
                        <div class="flex flex-wrap gap-1">
                            ${p.models.slice(0, 5).map(m => 
                                `<span class="text-[10px] bg-gray-700 text-gray-300 px-1.5 py-0.5 rounded">${m}</span>`
                            ).join('')}
                            ${p.models.length > 5 ? `<span class="text-[10px] text-gray-500">+${p.models.length - 5} more</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update dropdown to hide configured providers
            updateProviderDropdown();
        }
        
        // Edit an existing LLM provider
        function editLLMProvider(providerName) {
            const providerData = configuredLLMProviders.find(p => p.provider === providerName);
            if (!providerData) return;
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.id = 'edit-provider-modal';
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold flex items-center gap-2">
                            <span>${getProviderIcon(providerName)}</span>
                            Edit ${providerData.name}
                        </h3>
                        <button onclick="closeEditModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                            <input type="password" id="edit-api-key" class="input-field w-full rounded-lg px-4 py-2" 
                                   value="${providerData.api_key}" placeholder="Enter new API key...">
                        </div>
                        ${providerData.api_base ? `
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Base URL</label>
                            <input type="text" id="edit-api-base" class="input-field w-full rounded-lg px-4 py-2" 
                                   value="${providerData.api_base}" placeholder="API Base URL">
                        </div>
                        ` : ''}
                        
                        <div id="edit-test-result" class="hidden p-3 rounded-lg text-sm"></div>
                        
                        <div class="flex gap-2 pt-2">
                            <button onclick="testEditedProvider('${providerName}')" class="btn-secondary px-4 py-2 rounded-lg text-sm flex-1">
                                 Test
                            </button>
                            <button onclick="saveEditedProvider('${providerName}')" class="btn-primary px-4 py-2 rounded-lg text-sm flex-1">
                                 Save
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus on input
            document.getElementById('edit-api-key').focus();
        }
        
        function closeEditModal() {
            const modal = document.getElementById('edit-provider-modal');
            if (modal) modal.remove();
        }
        
        async function testEditedProvider(providerName) {
            const apiKey = document.getElementById('edit-api-key').value;
            const apiBase = document.getElementById('edit-api-base')?.value || '';
            const config = getProviderConfig(providerName);
            
            const resultEl = document.getElementById('edit-test-result');
            resultEl.classList.remove('hidden', 'bg-green-900/50', 'bg-red-900/50');
            resultEl.classList.add('bg-gray-700');
            resultEl.innerHTML = '<span class="animate-pulse"> Testing...</span>';
            
            try {
                const r = await fetch(API + '/api/settings/test-llm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: providerName,
                        model: config.models[0],
                        api_key: apiKey,
                        api_base: apiBase
                    })
                });
                
                const data = await r.json();
                resultEl.classList.remove('bg-gray-700');
                
                if (data.status === 'success') {
                    resultEl.classList.add('bg-green-900/50');
                    resultEl.innerHTML = ' Connection successful!';
                } else {
                    resultEl.classList.add('bg-red-900/50');
                    resultEl.innerHTML = ' ' + data.message;
                }
            } catch (e) {
                resultEl.classList.remove('bg-gray-700');
                resultEl.classList.add('bg-red-900/50');
                resultEl.innerHTML = ' ' + e.message;
            }
        }
        
        function saveEditedProvider(providerName) {
            const apiKey = document.getElementById('edit-api-key').value;
            const apiBase = document.getElementById('edit-api-base')?.value || '';
            
            if (!apiKey) {
                alert('Please enter an API key');
                return;
            }
            
            // Update provider
            const idx = configuredLLMProviders.findIndex(p => p.provider === providerName);
            if (idx >= 0) {
                configuredLLMProviders[idx].api_key = apiKey;
                if (apiBase) configuredLLMProviders[idx].api_base = apiBase;
            }
            
            // Close modal
            closeEditModal();
            
            // Update UI and save
            renderConfiguredProviders();
            saveSettingsQuiet();
            
            alert(' Provider updated successfully!');
        }
        
        function getProviderIcon(provider) {
            const icons = {
                openai: '', anthropic: '', google: '', xai: '', groq: '',
                mistral: '', deepseek: '', together: '', perplexity: '',
                cohere: '', azure_openai: '', aws_bedrock: '', ollama: '',
                lmstudio: '', custom: ''
            };
            return icons[provider] || '';
        }
        
        function updateDefaultProviderDropdown() {
            const select = document.getElementById('default-llm-provider');
            if (!select) return;
            
            const currentDefault = currentSettings?.llm?.provider || '';
            
            select.innerHTML = '<option value="">-- Select Provider --</option>' +
                configuredLLMProviders.map(p => 
                    `<option value="${p.provider}" ${p.provider === currentDefault ? 'selected' : ''}>${p.name}</option>`
                ).join('');
            
            // Update model dropdown
            onDefaultProviderChange();
        }
        
        function onDefaultProviderChange() {
            const provider = document.getElementById('default-llm-provider').value;
            const modelSelect = document.getElementById('default-llm-model');
            
            if (!provider) {
                modelSelect.innerHTML = '<option value="">-- Select Model --</option>';
                return;
            }
            
            const providerData = configuredLLMProviders.find(p => p.provider === provider);
            if (!providerData) return;
            
            const currentModel = currentSettings?.llm?.model || '';
            modelSelect.innerHTML = providerData.models.map(m => 
                `<option value="${m}" ${m === currentModel ? 'selected' : ''}>${m}</option>`
            ).join('');
        }
        
        async function testNewLLMProvider() {
            const provider = document.getElementById('llm-provider').value;
            const apiKey = document.getElementById('llm-api-key').value;
            const apiBase = document.getElementById('llm-api-base').value;
            
            const resultEl = document.getElementById('llm-test-result');
            resultEl.classList.remove('hidden', 'bg-green-900/50', 'bg-red-900/50');
            resultEl.classList.add('bg-gray-800');
            resultEl.innerHTML = '<span class="animate-pulse"> Testing connection...</span>';
            
            try {
                const config = getProviderConfig(provider);
                const r = await fetch(API + '/api/settings/test-llm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider,
                        model: config.models[0],
                        api_key: apiKey,
                        api_base: apiBase
                    })
                });
                
                const data = await r.json();
                resultEl.classList.remove('bg-gray-800');
                
                if (data.status === 'success') {
                    resultEl.classList.add('bg-green-900/50');
                    resultEl.innerHTML = ' <strong>Success!</strong> Connection verified.';
                } else {
                    resultEl.classList.add('bg-red-900/50');
                    resultEl.innerHTML = ' <strong>Failed:</strong> ' + data.message;
                }
            } catch (e) {
                resultEl.classList.remove('bg-gray-800');
                resultEl.classList.add('bg-red-900/50');
                resultEl.innerHTML = ' <strong>Error:</strong> ' + e.message;
            }
        }
        
        async function testConfiguredProvider(providerName) {
            const providerData = configuredLLMProviders.find(p => p.provider === providerName);
            if (!providerData) {
                alert('Provider not found');
                return;
            }
            
            // Show loading state
            const card = document.getElementById(`provider-card-${providerName}`);
            const originalBorder = card?.className;
            if (card) {
                card.classList.add('animate-pulse');
            }
            
            try {
                const r = await fetch(API + '/api/settings/test-llm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: providerData.provider,
                        model: providerData.models[0],
                        api_key: providerData.api_key,
                        api_base: providerData.api_base || ''
                    })
                });
                
                const data = await r.json();
                
                if (card) {
                    card.classList.remove('animate-pulse');
                }
                
                if (data.status === 'success') {
                    alert(` ${providerData.name} is working!\n\nResponse: "${data.response?.substring(0, 100)}..."`);
                } else {
                    alert(` ${providerData.name} test failed:\n\n${data.message}`);
                }
            } catch (e) {
                if (card) {
                    card.classList.remove('animate-pulse');
                }
                alert(` Error testing ${providerData.name}:\n\n${e.message}`);
            }
        }
        
        async function saveSettingsQuiet() {
            // Save without showing alert
            try {
                const defaultProvider = document.getElementById('default-llm-provider')?.value || '';
                const defaultModel = document.getElementById('default-llm-model')?.value || '';
                
                const settings = {
                    llm: {
                        provider: defaultProvider,
                        model: defaultModel,
                        api_key: configuredLLMProviders.find(p => p.provider === defaultProvider)?.api_key || '',
                        api_base: configuredLLMProviders.find(p => p.provider === defaultProvider)?.api_base || '',
                    },
                    llm_providers: configuredLLMProviders,
                    embedding: {
                        provider: document.getElementById('emb-provider')?.value || 'openai',
                        model: document.getElementById('emb-model')?.value || 'text-embedding-3-small',
                        local_model: document.getElementById('emb-local-model')?.value || 'all-MiniLM-L6-v2',
                        api_key: document.getElementById('emb-api-key')?.value || '',
                    },
                    vector_db: {
                        provider: document.getElementById('vdb-provider')?.value || 'memory',
                        chroma_path: document.getElementById('vdb-chroma-path')?.value || './data/chromadb',
                        pinecone_api_key: document.getElementById('vdb-pinecone-key')?.value || '',
                        pinecone_index: document.getElementById('vdb-pinecone-index')?.value || '',
                    },
                    chunk_size: parseInt(document.getElementById('rag-chunk-size')?.value) || 1000,
                    chunk_overlap: parseInt(document.getElementById('rag-chunk-overlap')?.value) || 200,
                    search_top_k: parseInt(document.getElementById('rag-top-k')?.value) || 5,
                    enable_rag: document.getElementById('toggle-rag')?.classList.contains('on') ?? true,
                    enable_web_scraping: document.getElementById('toggle-scraping')?.classList.contains('on') ?? true,
                    enable_api_tools: document.getElementById('toggle-api')?.classList.contains('on') ?? true,
                };
                
                console.log('Saving settings with', configuredLLMProviders.length, 'providers');
                
                const response = await fetch(API + '/api/settings', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    console.log(' Settings saved successfully');
                    currentSettings = settings;
                } else {
                    console.error(' Failed to save settings:', data.message);
                }
            } catch (e) {
                console.error(' Failed to save settings:', e);
            }
        }
        
        function onEmbeddingProviderChange() {
            const provider = document.getElementById('emb-provider').value;
            
            document.getElementById('emb-model-group').classList.toggle('hidden', provider === 'sentence_transformers');
            document.getElementById('emb-local-model-group').classList.toggle('hidden', provider !== 'sentence_transformers');
            document.getElementById('emb-api-key-group').classList.toggle('hidden', provider === 'sentence_transformers' || provider === 'ollama');
        }
        
        function onVectorDBProviderChange() {
            const provider = document.getElementById('vdb-provider').value;
            
            document.getElementById('vdb-chroma-path-group').classList.toggle('hidden', provider !== 'chromadb');
            document.getElementById('vdb-pinecone-group').classList.toggle('hidden', provider !== 'pinecone');
            
            updateVDBStatus();
        }
        
        function updateVDBStatus() {
            const provider = document.getElementById('vdb-provider').value;
            const iconEl = document.getElementById('vdb-status-icon');
            const textEl = document.getElementById('vdb-status-text');
            
            if (provider === 'memory') {
                iconEl.textContent = '';
                textEl.textContent = 'Using keyword search (no embeddings)';
            } else if (provider === 'chromadb') {
                iconEl.textContent = '';
                textEl.textContent = 'ChromaDB ready - local vector search enabled';
            } else if (provider === 'pinecone') {
                const hasKey = document.getElementById('vdb-pinecone-key').value && !document.getElementById('vdb-pinecone-key').value.startsWith('***');
                iconEl.textContent = hasKey ? '' : '';
                textEl.textContent = hasKey ? 'Pinecone configured' : 'API key required';
            }
        }
        
        async function saveSettings() {
            try {
                const defaultProvider = document.getElementById('default-llm-provider')?.value || '';
                const defaultModel = document.getElementById('default-llm-model')?.value || '';
                const defaultProviderData = configuredLLMProviders.find(p => p.provider === defaultProvider);
                
                const settings = {
                    llm: {
                        provider: defaultProvider,
                        model: defaultModel,
                        api_key: defaultProviderData?.api_key || '',
                        api_base: defaultProviderData?.api_base || '',
                        resource: defaultProviderData?.resource || '',
                    },
                    llm_providers: configuredLLMProviders,
                    embedding: {
                        provider: document.getElementById('emb-provider').value,
                        model: document.getElementById('emb-model').value,
                        local_model: document.getElementById('emb-local-model').value,
                        api_key: document.getElementById('emb-api-key').value,
                    },
                    vector_db: {
                        provider: document.getElementById('vdb-provider').value,
                        chroma_path: document.getElementById('vdb-chroma-path').value,
                        pinecone_api_key: document.getElementById('vdb-pinecone-key').value,
                        pinecone_index: document.getElementById('vdb-pinecone-index').value,
                    },
                    chunk_size: parseInt(document.getElementById('rag-chunk-size').value),
                    chunk_overlap: parseInt(document.getElementById('rag-chunk-overlap').value),
                    search_top_k: parseInt(document.getElementById('rag-top-k').value),
                    enable_rag: document.getElementById('toggle-rag').classList.contains('on'),
                    enable_web_scraping: document.getElementById('toggle-scraping').classList.contains('on'),
                    enable_api_tools: document.getElementById('toggle-api').classList.contains('on'),
                };
                
                const r = await fetch(API + '/api/settings', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });
                
                const data = await r.json();
                if (data.status === 'success') {
                    currentSettings = settings;
                    alert(' Settings saved successfully!');
                } else {
                    alert(' Failed to save: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert(' Error: ' + e.message);
            }
        }
        
        async function testLLM() {
            const resultEl = document.getElementById('llm-test-result');
            resultEl.classList.remove('hidden', 'bg-green-900/50', 'bg-red-900/50');
            resultEl.classList.add('bg-gray-800');
            resultEl.innerHTML = '<span class="animate-pulse"> Testing LLM connection...</span>';
            
            try {
                const settings = {
                    provider: document.getElementById('llm-provider').value,
                    model: document.getElementById('llm-model').value,
                    api_key: document.getElementById('llm-api-key').value,
                    api_base: document.getElementById('llm-api-base').value,
                    ollama_host: document.getElementById('llm-ollama-host').value,
                };
                
                const r = await fetch(API + '/api/settings/test-llm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });
                
                const data = await r.json();
                resultEl.classList.remove('bg-gray-800');
                
                if (data.status === 'success') {
                    resultEl.classList.add('bg-green-900/50');
                    resultEl.innerHTML = ' <strong>Success!</strong> Response: ' + data.response.substring(0, 100);
                } else {
                    resultEl.classList.add('bg-red-900/50');
                    resultEl.innerHTML = ' <strong>Failed:</strong> ' + data.message;
                }
            } catch (e) {
                resultEl.classList.remove('bg-gray-800');
                resultEl.classList.add('bg-red-900/50');
                resultEl.innerHTML = ' <strong>Error:</strong> ' + e.message;
            }
        }
        
        async function testEmbedding() {
            const resultEl = document.getElementById('emb-test-result');
            resultEl.classList.remove('hidden', 'bg-green-900/50', 'bg-red-900/50');
            resultEl.classList.add('bg-gray-800');
            resultEl.innerHTML = '<span class="animate-pulse"> Testing embedding provider...</span>';
            
            try {
                const settings = {
                    provider: document.getElementById('emb-provider').value,
                    model: document.getElementById('emb-model').value,
                    local_model: document.getElementById('emb-local-model').value,
                    api_key: document.getElementById('emb-api-key').value,
                };
                
                const r = await fetch(API + '/api/settings/test-embedding', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });
                
                const data = await r.json();
                resultEl.classList.remove('bg-gray-800');
                
                if (data.status === 'success') {
                    resultEl.classList.add('bg-green-900/50');
                    resultEl.innerHTML = ` <strong>Success!</strong> Dimensions: ${data.dimensions}`;
                } else {
                    resultEl.classList.add('bg-red-900/50');
                    resultEl.innerHTML = ' <strong>Failed:</strong> ' + data.message;
                }
            } catch (e) {
                resultEl.classList.remove('bg-gray-800');
                resultEl.classList.add('bg-red-900/50');
                resultEl.innerHTML = ' <strong>Error:</strong> ' + e.message;
            }
        }
        
        async function reindexKnowledgeBase() {
            if (!confirm('This will reindex all documents with the current embedding settings. Continue?')) return;
            
            try {
                const r = await fetch(API + '/api/settings/reindex', { method: 'POST' });
                const data = await r.json();
                
                if (data.status === 'success') {
                    alert(' ' + data.message);
                } else {
                    alert(' ' + (data.message || 'Reindex failed'));
                }
            } catch (e) {
                alert(' Error: ' + e.message);
            }
        }

        // Initial data loading moved to showApp() function
        function initAppData() {
            loadAgents();
            loadTools();
            loadSettings();
            
            // Navigate to hash page or default to agents
            const hash = window.location.hash.slice(1);
            if (hash && document.getElementById('page-' + hash)) {
                navigate(hash, false);
            } else {
                navigate('agents', true);
            }
        }
// ============================================================================
// TOOL WIZARD - JavaScript
// ============================================================================

// Wizard State
let wizState = {
    type: null,
    step: 0,
    maxSteps: 4,
    data: {
        name: '',
        description: '',
        config: {},
        files: [],
        urls: []
    }
};

// Tool metadata
const toolMeta = {
    // Knowledge & Data
    knowledge: { icon: '', name: 'Knowledge Base', hasConfig: true, hasSources: true, steps: ['Basics', 'RAG Config', 'Sources', 'Test'] },
    document: { icon: '', name: 'Documents', hasConfig: false, hasSources: true, steps: ['Basics', 'Upload', 'Test'] },
    website: { icon: '', name: 'Website', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    database: { icon: '', name: 'Database', hasConfig: true, hasSources: false, steps: ['Basics', 'Connection', 'Test'] },
    spreadsheet: { icon: '', name: 'Spreadsheet', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    storage: { icon: '', name: 'Cloud Storage', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    // Integrations
    api: { icon: '', name: 'REST API', hasConfig: true, hasSources: false, steps: ['Basics', 'Endpoint', 'Params', 'Test'] },
    email: { icon: '', name: 'Email', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    slack: { icon: '', name: 'Messaging', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    calendar: { icon: '', name: 'Calendar', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    crm: { icon: '', name: 'CRM', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    webhook: { icon: '', name: 'Webhook', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    erp: { icon: '', name: 'ERP', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    // AI Services
    websearch: { icon: '', name: 'Web Search', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    imagegen: { icon: '', name: 'Image Gen', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    stt: { icon: '', name: 'Speech to Text', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    tts: { icon: '', name: 'Text to Speech', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    translate: { icon: '', name: 'Translation', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    ocr: { icon: '', name: 'OCR / Vision', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    code: { icon: '', name: 'Code Exec', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] },
    calculator: { icon: '', name: 'Calculator', hasConfig: false, hasSources: false, steps: ['Basics', 'Test'] },
    hitl: { icon: '', name: 'Human in Loop', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Test'] }
};

// Show tool modal
function showToolModal() {
    resetWizard();
    document.getElementById('modal-tool').classList.remove('hidden');
}

// Close wizard
function closeWizard() {
    document.getElementById('modal-tool').classList.add('hidden');
    resetWizard();
}

// Reset wizard state
function resetWizard() {
    wizState = {
        type: null,
        step: 0,
        maxSteps: 4,
        data: { name: '', description: '', config: {}, files: [], urls: [] },
        tableData: null
    };
    
    // Reset text and table entries
    wizTextEntries = [];
    wizTableEntries = [];
    
    // Reset UI
    document.getElementById('wizard-steps-bar').classList.add('hidden');
    document.getElementById('wizard-footer').classList.add('hidden');
    document.getElementById('wizard-icon').textContent = '';
    document.getElementById('wizard-title').textContent = 'Create Tool';
    document.getElementById('wizard-subtitle').textContent = 'Select a tool type';
    
    // Show step 0, hide others
    for (let i = 0; i <= 4; i++) {
        const el = document.getElementById('wiz-step-' + i);
        if (el) el.classList.toggle('hidden', i !== 0);
    }
    
    // Reset forms
    document.getElementById('wiz-name').value = '';
    document.getElementById('wiz-desc').value = '';
    document.getElementById('wiz-files-list').innerHTML = '';
    document.getElementById('wiz-urls-list').innerHTML = '';
    
    // Reset text/table lists
    const textList = document.getElementById('wiz-text-list');
    const tableList = document.getElementById('wiz-table-list');
    if (textList) textList.innerHTML = '';
    if (tableList) tableList.innerHTML = '';
    
    // Hide all config sections
    document.querySelectorAll('[id^="cfg-"]').forEach(el => el.classList.add('hidden'));
}

// Start wizard with tool type
function startWizard(type) {
    wizState.type = type;
    wizState.step = 1;
    
    const meta = toolMeta[type] || { icon: '', name: type, steps: ['Basics', 'Config', 'Test'] };
    wizState.maxSteps = meta.steps.length;
    
    // Update header
    document.getElementById('wizard-icon').textContent = meta.icon;
    document.getElementById('wizard-title').textContent = meta.name;
    document.getElementById('wizard-subtitle').textContent = 'Step 1 of ' + wizState.maxSteps;
    
    // Update step 1 header
    document.getElementById('step1-icon').textContent = meta.icon;
    document.getElementById('step1-title').textContent = meta.name;
    
    // Show steps bar and footer
    document.getElementById('wizard-steps-bar').classList.remove('hidden');
    document.getElementById('wizard-footer').classList.remove('hidden');
    
    // Update steps labels
    updateStepsBar();
    
    // Show step 1
    showStep(1);
}

// Update steps bar
function updateStepsBar() {
    const meta = toolMeta[wizState.type] || { steps: ['Basics', 'Config', 'Sources', 'Test'] };
    const steps = document.querySelectorAll('.wizard-step');
    
    steps.forEach((step, idx) => {
        const stepNum = idx + 1;
        const numEl = step.querySelector('.step-num');
        const labelEl = step.querySelector('.step-label');
        
        // Hide steps beyond max
        step.style.display = stepNum <= wizState.maxSteps ? 'flex' : 'none';
        
        // Update label
        if (labelEl && meta.steps[idx]) {
            labelEl.textContent = meta.steps[idx];
        }
        
        // Update styling
        if (stepNum < wizState.step) {
            // Completed
            step.classList.remove('opacity-50');
            numEl.classList.remove('bg-gray-700');
            numEl.classList.add('bg-green-600');
            numEl.innerHTML = '';
        } else if (stepNum === wizState.step) {
            // Current
            step.classList.remove('opacity-50');
            numEl.classList.remove('bg-gray-700', 'bg-green-600');
            numEl.classList.add('bg-purple-600');
            numEl.textContent = stepNum;
        } else {
            // Future
            step.classList.add('opacity-50');
            numEl.classList.remove('bg-purple-600', 'bg-green-600');
            numEl.classList.add('bg-gray-700');
            numEl.textContent = stepNum;
        }
    });
    
    // Hide connectors beyond max
    const connectors = document.querySelectorAll('.step-connector');
    connectors.forEach((conn, idx) => {
        conn.style.display = (idx + 2) <= wizState.maxSteps ? 'block' : 'none';
    });
}

// Show specific step
function showStep(step) {
    wizState.step = step;
    
    // Update subtitle
    const meta = toolMeta[wizState.type] || {};
    document.getElementById('wizard-subtitle').textContent = 
        'Step ' + step + ' of ' + wizState.maxSteps + ': ' + (meta.steps?.[step-1] || '');
    
    // Hide all step contents
    for (let i = 0; i <= 4; i++) {
        const el = document.getElementById('wiz-step-' + i);
        if (el) el.classList.add('hidden');
    }
    
    // Map logical step to actual step
    const actualStep = getActualStep(step);
    document.getElementById('wiz-step-' + actualStep).classList.remove('hidden');
    
    // Show appropriate config section
    if (actualStep === 2) {
        showConfigSection();
    }
    
    // Show/hide sources tabs based on tool type
    if (actualStep === 3) {
        const hasSources = toolMeta[wizState.type]?.hasSources;
        document.getElementById('source-tabs').style.display = hasSources ? 'flex' : 'none';
    }
    
    // Update buttons
    updateButtons();
    updateStepsBar();
    
    // Update summary if on last step
    if (step === wizState.maxSteps) {
        updateSummary();
    }
}

// Get actual step content based on tool type
function getActualStep(logicalStep) {
    const meta = toolMeta[wizState.type];
    if (!meta) return logicalStep;
    
    // Map based on tool capabilities
    if (logicalStep === 1) return 1; // Always basics
    
    if (!meta.hasConfig && meta.hasSources) {
        // document: Basics -> Sources -> Test
        if (logicalStep === 2) return 3;
        if (logicalStep === 3) return 4;
    } else if (meta.hasConfig && !meta.hasSources) {
        // api, database, etc: Basics -> Config -> Test
        if (logicalStep === 2) return 2;
        if (logicalStep === 3) return 4;
    } else if (!meta.hasConfig && !meta.hasSources) {
        // calculator: Basics -> Test
        if (logicalStep === 2) return 4;
    }
    // knowledge: Basics -> Config -> Sources -> Test (default)
    return logicalStep;
}

// Show appropriate config section
function showConfigSection() {
    document.querySelectorAll('[id^="cfg-"]').forEach(el => el.classList.add('hidden'));
    
    const cfgId = 'cfg-' + wizState.type;
    const cfgEl = document.getElementById(cfgId);
    
    if (cfgEl) {
        cfgEl.classList.remove('hidden');
    } else {
        document.getElementById('cfg-simple').classList.remove('hidden');
    }
}

// Update navigation buttons
function updateButtons() {
    const btnBack = document.getElementById('btn-back');
    const btnNext = document.getElementById('btn-next');
    const btnSkip = document.getElementById('btn-skip');
    const btnCreate = document.getElementById('btn-create');
    
    // Back button
    btnBack.style.display = wizState.step > 1 ? 'block' : 'none';
    
    // Skip button (only on sources step)
    const actualStep = getActualStep(wizState.step);
    btnSkip.classList.toggle('hidden', actualStep !== 3);
    
    // Next vs Create
    if (wizState.step >= wizState.maxSteps) {
        btnNext.classList.add('hidden');
        btnCreate.classList.remove('hidden');
    } else {
        btnNext.classList.remove('hidden');
        btnCreate.classList.add('hidden');
    }
}

// Navigate back
function wizBack() {
    if (wizState.step > 1) {
        showStep(wizState.step - 1);
    } else {
        // Go back to type selection
        resetWizard();
        document.getElementById('wiz-step-0').classList.remove('hidden');
    }
}

// Navigate next
function wizNext() {
    // Validate current step
    if (!validateStep()) return;
    
    // Save current step data
    saveStepData();
    
    if (wizState.step < wizState.maxSteps) {
        showStep(wizState.step + 1);
    }
}

// Skip step
function wizSkip() {
    if (wizState.step < wizState.maxSteps) {
        showStep(wizState.step + 1);
    }
}

// Validate current step
function validateStep() {
    if (wizState.step === 1) {
        const name = document.getElementById('wiz-name').value.trim();
        if (!name) {
            alert('Please enter a name');
            return false;
        }
    }
    
    if (getActualStep(wizState.step) === 2) {
        // Validate config based on type
        if (wizState.type === 'website') {
            const url = document.getElementById('web-url').value.trim();
            if (!url) {
                alert('Please enter a website URL');
                return false;
            }
        }
        if (wizState.type === 'api') {
            const url = document.getElementById('api-url').value.trim();
            if (!url) {
                alert('Please enter an API URL');
                return false;
            }
        }
    }
    
    return true;
}

// Save step data
function saveStepData() {
    if (wizState.step === 1) {
        wizState.data.name = document.getElementById('wiz-name').value.trim();
        wizState.data.description = document.getElementById('wiz-desc').value.trim();
    }
    
    if (getActualStep(wizState.step) === 2) {
        // Save config based on type
        const config = {};
        
        if (wizState.type === 'knowledge') {
            config.embedding = {
                use_global: document.getElementById('kb-emb-global').checked,
                provider: document.getElementById('kb-emb-provider').value,
                model: document.getElementById('kb-emb-model').value
            };
            config.chunk_size = parseInt(document.getElementById('kb-chunk').value) || 1000;
            config.chunk_overlap = parseInt(document.getElementById('kb-overlap').value) || 200;
            config.top_k = parseInt(document.getElementById('kb-topk').value) || 5;
            config.search_type = document.getElementById('kb-search').value;
        }
        
        if (wizState.type === 'website') {
            config.url = document.getElementById('web-url').value;
            config.recursive = document.getElementById('web-recursive').checked;
            config.max_pages = parseInt(document.getElementById('web-max').value) || 10;
        }
        
        if (wizState.type === 'database') {
            config.db_type = document.getElementById('db-type').value;
            config.host = document.getElementById('db-host').value;
            config.port = parseInt(document.getElementById('db-port').value);
            config.database = document.getElementById('db-name').value;
            config.username = document.getElementById('db-user').value;
            config.password = document.getElementById('db-pass').value;
        }
        
        if (wizState.type === 'api') {
            config.base_url = document.getElementById('api-url').value;
            config.method = document.getElementById('api-method').value;
            config.path = document.getElementById('api-path').value;
            config.auth_type = document.getElementById('api-auth').value;
            config.auth_value = document.getElementById('api-auth-val')?.value;
        }
        
        if (wizState.type === 'websearch') {
            config.provider = document.getElementById('search-provider').value;
            config.api_key = document.getElementById('search-key').value;
        }
        
        if (wizState.type === 'email') {
            // Get email config from hidden field or state
            const emailConfigData = document.getElementById('email-config-data')?.value;
            if (emailConfigData) {
                try {
                    const emailConfig = JSON.parse(emailConfigData);
                    Object.assign(config, emailConfig);
                } catch(e) {
                    console.error('Failed to parse email config:', e);
                }
            }
            
            // Also check if config was already set in wizState
            if (wizState.data.config && wizState.data.config.email) {
                Object.assign(config, wizState.data.config.email);
            }
            
            // Also check for SendGrid config
            const sendgridKey = document.getElementById('sendgrid-api-key')?.value;
            const sendgridFrom = document.getElementById('sendgrid-from-email')?.value;
            if (sendgridKey && sendgridFrom) {
                config.provider = 'sendgrid';
                config.apiKey = sendgridKey;
                config.fromEmail = sendgridFrom;
            }
            
            console.log('Email config:', config);
        }
        
        if (wizState.type === 'webhook') {
            config.url = document.getElementById('hook-url')?.value;
            config.method = document.getElementById('hook-method')?.value;
            config.secret = document.getElementById('hook-secret')?.value;
        }
        
        if (wizState.type === 'slack') {
            config.webhook_url = document.getElementById('slack-webhook')?.value;
        }
        
        if (wizState.type === 'calendar') {
            config.provider = document.getElementById('cal-provider')?.value;
            config.api_key = document.getElementById('cal-api-key')?.value;
        }
        
        wizState.data.config = config;
    }
}

// Update summary
function updateSummary() {
    const meta = toolMeta[wizState.type] || {};
    document.getElementById('sum-type').textContent = meta.icon + ' ' + meta.name;
    document.getElementById('sum-name').textContent = wizState.data.name || '-';
    document.getElementById('sum-docs').textContent = wizState.data.files?.length || 0;
    document.getElementById('sum-urls').textContent = wizState.data.urls?.length || 0;
    document.getElementById('sum-text').textContent = wizTextEntries?.length || 0;
    document.getElementById('sum-tables').textContent = wizTableEntries?.length || 0;
}

// Test tool
async function testWizTool() {
    const resultEl = document.getElementById('wiz-test-result');
    resultEl.classList.remove('hidden');
    resultEl.className = 'p-3 rounded-lg text-sm bg-blue-900/30 border border-blue-600';
    resultEl.innerHTML = '<span class="animate-pulse"> Testing...</span>';
    
    try {
        // Simulate test based on type
        await new Promise(r => setTimeout(r, 1000));
        
        // For now, just show success
        resultEl.className = 'p-3 rounded-lg text-sm bg-green-900/30 border border-green-600';
        resultEl.innerHTML = ' Connection successful! Tool is ready to create.';
    } catch (e) {
        resultEl.className = 'p-3 rounded-lg text-sm bg-red-900/30 border border-red-600';
        resultEl.innerHTML = ' Test failed: ' + e.message;
    }
}

// Create tool
async function wizCreate() {
    saveStepData();
    
    // Validate required data
    if (!wizState.data.name) {
        alert('Please enter a tool name');
        return;
    }
    
    // Special validation for email
    if (wizState.type === 'email') {
        const config = wizState.data.config || {};
        const emailConfigData = document.getElementById('email-config-data')?.value;
        const hasOAuthConfig = config.provider || config.email || (emailConfigData && emailConfigData.length > 2);
        const hasSendGridConfig = document.getElementById('sendgrid-api-key')?.value && document.getElementById('sendgrid-from-email')?.value;
        
        if (!hasOAuthConfig && !hasSendGridConfig) {
            alert('Please connect an email provider first (Gmail, Outlook, or SendGrid)');
            return;
        }
    }
    
    // Show progress
    showProgressModal('Creating tool...');
    updateProgress(10, 'Creating tool...');
    
    try {
        // Create tool
        console.log('Creating tool:', {
            type: wizState.type,
            name: wizState.data.name,
            description: wizState.data.description,
            config: wizState.data.config
        });
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        const response = await fetch(API + '/api/tools', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: wizState.type,
                name: wizState.data.name,
                description: wizState.data.description,
                config: wizState.data.config
            }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || 'Failed to create tool');
        }
        
        const result = await response.json();
        const toolId = result.tool_id;
        
        updateProgress(20, 'Tool created!');
        
        // Upload files if any
        if (wizState.data.files && wizState.data.files.length > 0) {
            for (let i = 0; i < wizState.data.files.length; i++) {
                const file = wizState.data.files[i];
                updateProgress(20 + (i / wizState.data.files.length) * 25, 'Uploading ' + file.name + '...');
                
                const fd = new FormData();
                fd.append('file', file);
                await fetch(API + '/api/tools/' + toolId + '/documents', { method: 'POST', body: fd });
            }
        }
        
        // Scrape URLs if any
        if (wizState.data.urls && wizState.data.urls.length > 0) {
            for (let i = 0; i < wizState.data.urls.length; i++) {
                const url = wizState.data.urls[i];
                updateProgress(45 + (i / wizState.data.urls.length) * 20, 'Scraping ' + url + '...');
                
                await fetch(API + '/api/tools/' + toolId + '/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, recursive: false, max_pages: 1 })
                });
            }
        }
        
        // Add text entries if any
        if (wizTextEntries && wizTextEntries.length > 0) {
            for (let i = 0; i < wizTextEntries.length; i++) {
                const entry = wizTextEntries[i];
                updateProgress(65 + (i / wizTextEntries.length) * 15, 'Adding text: ' + entry.title + '...');
                
                await fetch(API + '/api/tools/' + toolId + '/demo-document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source: entry.title, content: entry.content })
                });
            }
        }
        
        // Add table entries if any
        if (wizTableEntries && wizTableEntries.length > 0) {
            for (let i = 0; i < wizTableEntries.length; i++) {
                const table = wizTableEntries[i];
                updateProgress(80 + (i / wizTableEntries.length) * 15, 'Adding table: ' + table.name + '...');
                
                // Convert table to searchable text
                let tableContent = `## ${table.name}\n\n`;
                tableContent += '| ' + table.data.headers.join(' | ') + ' |\n';
                tableContent += '| ' + table.data.headers.map(() => '---').join(' | ') + ' |\n';
                table.data.rows.forEach(row => {
                    tableContent += '| ' + row.join(' | ') + ' |\n';
                });
                tableContent += '\n### Records:\n\n';
                table.data.rows.forEach((row, idx) => {
                    tableContent += `**Record ${idx + 1}:**\n`;
                    table.data.headers.forEach((h, j) => {
                        if (row[j]) tableContent += `- ${h}: ${row[j]}\n`;
                    });
                    tableContent += '\n';
                });
                
                await fetch(API + '/api/tools/' + toolId + '/table-entry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        source: table.name, 
                        content: tableContent,
                        table_data: table.data
                    })
                });
            }
        }
        
        updateProgress(100, ' Done!');
        
        // Reset wizard entries
        wizTextEntries = [];
        wizTableEntries = [];
        
        setTimeout(() => {
            hideProgressModal();
            closeWizard();
            loadTools();
        }, 500);
        
    } catch (e) {
        hideProgressModal();
        console.error('Error creating tool:', e);
        if (e.name === 'AbortError') {
            alert('Request timed out. Please try again.');
        } else {
            alert('Error creating tool: ' + (e.message || 'Unknown error'));
        }
    }
}

// File handling
function handleWizFiles(event) {
    const files = Array.from(event.target.files);
    wizState.data.files.push(...files);
    renderWizFiles();
}

function renderWizFiles() {
    const list = document.getElementById('wiz-files-list');
    list.innerHTML = wizState.data.files.map((f, i) => `
        <div class="flex items-center justify-between bg-gray-800 rounded-lg p-2">
            <div class="flex items-center gap-2 min-w-0">
                <span>${getFileIcon(f.name)}</span>
                <span class="text-sm truncate">${f.name}</span>
                <span class="text-xs text-gray-500">(${formatSize(f.size)})</span>
            </div>
            <button onclick="removeWizFile(${i})" class="text-gray-500 hover:text-red-400 p-1"></button>
        </div>
    `).join('');
}

function removeWizFile(idx) {
    wizState.data.files.splice(idx, 1);
    renderWizFiles();
}

function getFileIcon(name) {
    const ext = name.split('.').pop().toLowerCase();
    const icons = { pdf: '', doc: '', docx: '', xls: '', xlsx: '', ppt: '', pptx: '', txt: '', csv: '', md: '' };
    return icons[ext] || '';
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// URL handling
function addWizUrl() {
    const input = document.getElementById('wiz-url-input');
    const url = input.value.trim();
    if (url && url.startsWith('http')) {
        wizState.data.urls.push(url);
        input.value = '';
        renderWizUrls();
    }
}

function renderWizUrls() {
    const list = document.getElementById('wiz-urls-list');
    list.innerHTML = wizState.data.urls.map((url, i) => `
        <div class="flex items-center justify-between bg-gray-800 rounded-lg p-2">
            <div class="flex items-center gap-2 min-w-0">
                <span></span>
                <span class="text-sm truncate">${url}</span>
            </div>
            <button onclick="removeWizUrl(${i})" class="text-gray-500 hover:text-red-400 p-1"></button>
        </div>
    `).join('');
}

function removeWizUrl(idx) {
    wizState.data.urls.splice(idx, 1);
    renderWizUrls();
}

// Source tabs
function setSourceTab(tab) {
    const tabs = ['docs', 'urls', 'text', 'table'];
    
    tabs.forEach(t => {
        const tabEl = document.getElementById('tab-' + t);
        const sourceEl = document.getElementById('sources-' + t);
        
        if (tabEl) {
            tabEl.classList.toggle('border-purple-500', tab === t);
            tabEl.classList.toggle('text-white', tab === t);
            tabEl.classList.toggle('border-transparent', tab !== t);
            tabEl.classList.toggle('text-gray-400', tab !== t);
        }
        
        if (sourceEl) {
            sourceEl.classList.toggle('hidden', tab !== t);
        }
    });
    
    // Initialize table editor if switching to table tab
    if (tab === 'table' && !wizState.tableData) {
        wizState.tableData = { headers: ['Column 1', 'Column 2', 'Column 3'], rows: [['', '', ''], ['', '', '']] };
        renderWizTableEditor();
    }
}

// Wizard Text Entry functions
let wizTextEntries = [];

function addWizTextEntry() {
    const title = document.getElementById('wiz-text-title')?.value?.trim();
    const content = document.getElementById('wiz-text-content')?.value?.trim();
    
    if (!title || !content) {
        alert('Please enter both title and content');
        return;
    }
    
    wizTextEntries.push({ title, content });
    document.getElementById('wiz-text-title').value = '';
    document.getElementById('wiz-text-content').value = '';
    renderWizTextList();
}

function renderWizTextList() {
    const list = document.getElementById('wiz-text-list');
    if (!list) return;
    
    list.innerHTML = wizTextEntries.map((e, i) => `
        <div class="flex items-center justify-between bg-gray-800 rounded-lg p-3">
            <div class="flex items-center gap-2 min-w-0">
                <span></span>
                <div class="min-w-0">
                    <p class="text-sm font-medium truncate">${escHtml(e.title)}</p>
                    <p class="text-xs text-gray-500">${e.content.length} characters</p>
                </div>
            </div>
            <button onclick="removeWizTextEntry(${i})" class="text-red-400 hover:text-red-300 p-1"></button>
        </div>
    `).join('');
}

function removeWizTextEntry(idx) {
    wizTextEntries.splice(idx, 1);
    renderWizTextList();
}

// Wizard Table functions
let wizTableEntries = [];

function renderWizTableEditor() {
    const container = document.getElementById('wiz-table-editor');
    if (!container || !wizState.tableData) return;
    
    let html = '<table class="w-full border-collapse text-sm">';
    
    // Headers row
    html += '<tr>';
    wizState.tableData.headers.forEach((h, i) => {
        html += `<th class="border border-gray-600 p-0">
            <input type="text" value="${escHtml(h)}" 
                   onchange="wizState.tableData.headers[${i}]=this.value" 
                   class="w-full bg-gray-700 text-white font-semibold px-2 py-1.5 text-center outline-none focus:bg-gray-600 text-xs"
                   placeholder="Header">
        </th>`;
    });
    html += '</tr>';
    
    // Data rows
    wizState.tableData.rows.forEach((row, ri) => {
        html += '<tr>';
        row.forEach((cell, ci) => {
            html += `<td class="border border-gray-700 p-0">
                <input type="text" value="${escHtml(cell)}" 
                       onchange="wizState.tableData.rows[${ri}][${ci}]=this.value"
                       class="w-full bg-gray-800 px-2 py-1.5 outline-none focus:bg-gray-700 text-xs">
            </td>`;
        });
        html += '</tr>';
    });
    
    html += '</table>';
    container.innerHTML = html;
    
    // Update counters
    const colCount = document.getElementById('wiz-col-count');
    const rowCount = document.getElementById('wiz-row-count');
    if (colCount) colCount.textContent = wizState.tableData.headers.length;
    if (rowCount) rowCount.textContent = wizState.tableData.rows.length;
}

function changeWizTableCols(delta) {
    if (!wizState.tableData) return;
    const newCount = wizState.tableData.headers.length + delta;
    if (newCount < 1 || newCount > 10) return;
    
    if (delta > 0) {
        wizState.tableData.headers.push('Column ' + newCount);
        wizState.tableData.rows.forEach(row => row.push(''));
    } else {
        wizState.tableData.headers.pop();
        wizState.tableData.rows.forEach(row => row.pop());
    }
    renderWizTableEditor();
}

function changeWizTableRows(delta) {
    if (!wizState.tableData) return;
    const newCount = wizState.tableData.rows.length + delta;
    if (newCount < 1 || newCount > 20) return;
    
    if (delta > 0) {
        wizState.tableData.rows.push(new Array(wizState.tableData.headers.length).fill(''));
    } else {
        wizState.tableData.rows.pop();
    }
    renderWizTableEditor();
}

function importWizTableFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const fileName = file.name.toLowerCase();
    
    if (fileName.endsWith('.csv')) {
        const reader = new FileReader();
        reader.onload = (e) => {
            parseWizCSV(e.target.result);
        };
        reader.readAsText(file);
    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                if (!window.XLSX) {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                    document.head.appendChild(script);
                    await new Promise(r => script.onload = r);
                }
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                
                if (jsonData.length > 0) {
                    wizState.tableData = {
                        headers: jsonData[0].map(h => String(h || '')),
                        rows: jsonData.slice(1).map(row => 
                            jsonData[0].map((_, i) => String(row[i] || ''))
                        )
                    };
                    if (wizState.tableData.rows.length === 0) {
                        wizState.tableData.rows = [new Array(wizState.tableData.headers.length).fill('')];
                    }
                    renderWizTableEditor();
                    
                    // Auto-fill table name
                    const tableName = document.getElementById('wiz-table-name');
                    if (tableName && !tableName.value) {
                        tableName.value = file.name.replace(/\.(csv|xlsx|xls)$/i, '');
                    }
                }
            } catch (err) {
                alert('Failed to parse file: ' + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }
}

function parseWizCSV(csvText) {
    const lines = csvText.split(/\r?\n/).filter(line => line.trim());
    if (lines.length === 0) return;
    
    const parseRow = (line) => {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        return result;
    };
    
    wizState.tableData = {
        headers: parseRow(lines[0]),
        rows: lines.slice(1).map(line => {
            const row = parseRow(line);
            while (row.length < wizState.tableData.headers.length) row.push('');
            return row.slice(0, wizState.tableData.headers.length);
        })
    };
    
    if (wizState.tableData.rows.length === 0) {
        wizState.tableData.rows = [new Array(wizState.tableData.headers.length).fill('')];
    }
    
    renderWizTableEditor();
}

function addWizTableEntry() {
    const tableName = document.getElementById('wiz-table-name')?.value?.trim();
    if (!tableName) {
        alert('Please enter a table name');
        return;
    }
    if (!wizState.tableData || wizState.tableData.headers.length === 0) {
        alert('Please create a table first');
        return;
    }
    
    wizTableEntries.push({
        name: tableName,
        data: JSON.parse(JSON.stringify(wizState.tableData))
    });
    
    // Reset
    document.getElementById('wiz-table-name').value = '';
    wizState.tableData = { headers: ['Column 1', 'Column 2', 'Column 3'], rows: [['', '', ''], ['', '', '']] };
    renderWizTableEditor();
    renderWizTableList();
}

function renderWizTableList() {
    const list = document.getElementById('wiz-table-list');
    if (!list) return;
    
    list.innerHTML = wizTableEntries.map((e, i) => `
        <div class="flex items-center justify-between bg-gray-800 rounded-lg p-3">
            <div class="flex items-center gap-2 min-w-0">
                <span></span>
                <div class="min-w-0">
                    <p class="text-sm font-medium truncate">${escHtml(e.name)}</p>
                    <p class="text-xs text-gray-500">${e.data.headers.length} cols  ${e.data.rows.length} rows</p>
                </div>
            </div>
            <button onclick="removeWizTableEntry(${i})" class="text-red-400 hover:text-red-300 p-1"></button>
        </div>
    `).join('');
}

function removeWizTableEntry(idx) {
    wizTableEntries.splice(idx, 1);
    renderWizTableList();
}

// Config helpers
function toggleKBEmb() {
    const useGlobal = document.getElementById('kb-emb-global').checked;
    document.getElementById('kb-emb-fields').classList.toggle('hidden', useGlobal);
}

function onKBEmbChange() {
    const provider = document.getElementById('kb-emb-provider').value;
    // Update model options based on provider
}

function onDBTypeChange() {
    const type = document.getElementById('db-type').value;
    const ports = {
        postgresql: 5432, mysql: 3306, mssql: 1433, sqlite: '', 
        oracle: 1521, oracle_autonomous: 1522, db2: 50000, sybase: 5000, 
        teradata: 1025, azure_sql: 1433, cockroachdb: 26257, tidb: 4000,
        snowflake: 443, redshift: 5439, bigquery: 443,
        mongodb: 27017, mongodb_atlas: 27017, dynamodb: 443, cosmosdb: 443,
        firestore: 443, couchdb: 5984, cassandra: 9042, scylladb: 9042, hbase: 9090,
        redis: 6379, memcached: 11211, elasticache: 6379,
        elasticsearch: 9200, opensearch: 9200, solr: 8983, meilisearch: 7700,
        pinecone: 443, weaviate: 8080, qdrant: 6333, milvus: 19530, chroma: 8000,
        influxdb: 8086, timescaledb: 5432, questdb: 9000,
        neo4j: 7687, neptune: 8182, arangodb: 8529
    };
    document.getElementById('db-port').value = ports[type] || 5432;
    
    // Show/hide specific field sections
    const isOracle = type === 'oracle';
    const isOracleADB = type === 'oracle_autonomous';
    const isCloudDW = ['snowflake', 'bigquery', 'redshift'].includes(type);
    const isNoSQL = ['mongodb', 'mongodb_atlas', 'couchdb', 'dynamodb', 'cosmosdb', 'firestore'].includes(type);
    const isVector = ['pinecone', 'weaviate', 'qdrant', 'milvus', 'chroma'].includes(type);
    
    document.getElementById('db-standard-fields')?.classList.toggle('hidden', isOracleADB || isCloudDW || isVector);
    document.getElementById('db-oracle-fields')?.classList.toggle('hidden', !isOracle);
    document.getElementById('db-oracle-adb-fields')?.classList.toggle('hidden', !isOracleADB);
    document.getElementById('db-cloud-fields')?.classList.toggle('hidden', !isCloudDW);
    document.getElementById('db-nosql-fields')?.classList.toggle('hidden', !isNoSQL);
    document.getElementById('db-vector-fields')?.classList.toggle('hidden', !isVector);
    document.getElementById('db-snowflake-extra')?.classList.toggle('hidden', type !== 'snowflake');
}

function onOracleConnTypeChange() {
    const type = document.getElementById('oracle-conn-type')?.value;
    document.getElementById('oracle-service-field')?.classList.toggle('hidden', type !== 'basic');
    document.getElementById('oracle-tns-field')?.classList.toggle('hidden', type !== 'tns');
    document.getElementById('oracle-wallet-fields')?.classList.toggle('hidden', type !== 'wallet');
}

function onApiAuthChange() {
    const auth = document.getElementById('api-auth').value;
    document.getElementById('api-auth-val-group').classList.toggle('hidden', auth === 'none');
}

// ============================================================================
// EMAIL CONFIGURATION (Simple & User-Friendly)
// ============================================================================
// EMAIL INTEGRATION - Simple OAuth Flow for End Users
// ============================================================================

// Connect email provider via OAuth
async function connectEmailProvider(provider) {
    const btnId = provider === 'google' ? 'gmail-connect-btn' : 'outlook-connect-btn';
    const btn = document.getElementById(btnId);
    if (!btn) return;
    
    const originalText = btn.innerHTML;
    
    // Show loading
    btn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div> Connecting...';
    btn.disabled = true;
    
    try {
        // Request OAuth URL from backend
        const endpoint = provider === 'google' ? '/api/oauth/google/email/url' : '/api/oauth/microsoft/email/url';
        const res = await fetch(endpoint);
        
        if (!res.ok) {
            // OAuth not configured - show admin message
            showOAuthNotConfigured(provider);
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }
        
        const data = await res.json();
        console.log("Login response:", data);
        
        // Open OAuth popup
        const popup = window.open(
            data.url, 
            `${provider} Login`, 
            'width=500,height=600,menubar=no,toolbar=no,location=no,status=no'
        );
        
        // Listen for OAuth completion
        const handleMessage = (event) => {
            if (event.data.type === `${provider}-oauth-success`) {
                window.removeEventListener('message', handleMessage);
                // Pass tokens along with email
                onEmailConnected(provider, event.data.email, {
                    access_token: event.data.access_token,
                    refresh_token: event.data.refresh_token
                });
                btn.innerHTML = originalText;
                btn.disabled = false;
            } else if (event.data.type === `${provider}-oauth-error`) {
                window.removeEventListener('message', handleMessage);
                showToast('Connection failed. Please try again.', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
        
        window.addEventListener('message', handleMessage);
        
        // Timeout after 2 minutes
        setTimeout(() => {
            window.removeEventListener('message', handleMessage);
            if (btn.disabled) {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }, 120000);
        
    } catch (err) {
        console.error('OAuth error:', err);
        showOAuthNotConfigured(provider);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Handle successful email connection
function onEmailConnected(provider, email, tokens = {}) {
    const cardId = provider === 'google' ? 'gmail' : 'outlook';
    const card = document.getElementById(`${cardId}-connect-card`);
    const btn = document.getElementById(`${cardId}-connect-btn`);
    const connected = document.getElementById(`${cardId}-connected`);
    const emailEl = document.getElementById(`${cardId}-connected-email`);
    
    if (!card || !btn || !connected || !emailEl) return;
    
    // Update UI
    card.classList.add('border-green-500');
    btn.classList.add('hidden');
    connected.classList.remove('hidden');
    emailEl.textContent = email;
    
    // Store config with tokens
    const emailConfig = { 
        provider, 
        email,
        access_token: tokens.access_token || '',
        refresh_token: tokens.refresh_token || ''
    };
    
    const providerEl = document.getElementById('email-provider');
    const configEl = document.getElementById('email-config-data');
    if (providerEl) providerEl.value = provider;
    if (configEl) configEl.value = JSON.stringify(emailConfig);
    
    // Update wizard state with tokens
    if (typeof wizState !== 'undefined' && wizState.data) {
        wizState.data.config = wizState.data.config || {};
        wizState.data.config = emailConfig;
    }
    
    console.log('Email connected:', { provider, email, hasTokens: !!tokens.access_token });
    showToast(`Connected to ${email}`, 'success');
}

// Disconnect email provider
function disconnectEmailProvider(provider) {
    const cardId = provider === 'google' ? 'gmail' : 'outlook';
    const card = document.getElementById(`${cardId}-connect-card`);
    const btn = document.getElementById(`${cardId}-connect-btn`);
    const connected = document.getElementById(`${cardId}-connected`);
    
    if (!card || !btn || !connected) return;
    
    // Reset UI
    card.classList.remove('border-green-500');
    btn.classList.remove('hidden');
    connected.classList.add('hidden');
    
    // Clear config
    const providerEl = document.getElementById('email-provider');
    const configEl = document.getElementById('email-config-data');
    if (providerEl) providerEl.value = '';
    if (configEl) configEl.value = '';
    
    showToast('Email disconnected', 'info');
}

// Show message when OAuth is not configured (for platform admin)
function showOAuthNotConfigured(provider) {
    const providerName = provider === 'google' ? 'Google' : 'Microsoft';
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4';
    modal.id = 'oauth-config-modal';
    modal.innerHTML = `
        <div class="modal-content-box rounded-2xl w-full max-w-md overflow-hidden">
            <div class="p-6 text-center">
                <div class="w-16 h-16 rounded-full bg-yellow-500/20 flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl"></span>
                </div>
                <h3 class="text-xl font-bold mb-2" style="color:var(--text-primary);">Setup Required</h3>
                <p class="mb-6" style="color:var(--text-secondary);">
                    ${providerName} integration needs to be configured by the administrator.
                </p>
                <p class="text-sm mb-6" style="color:var(--text-muted);">
                    Go to <strong>Settings  Integrations</strong> to set up ${providerName} OAuth credentials.
                </p>
                <button onclick="document.getElementById('oauth-config-modal').remove()" 
                        class="btn-primary px-8 py-3 rounded-lg">
                    Got it
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Toggle SendGrid setup panel
function toggleSendGridSetup() {
    const setup = document.getElementById('sendgrid-setup');
    const btn = document.getElementById('sendgrid-setup-btn');
    if (!setup || !btn) return;
    
    const isHidden = setup.classList.contains('hidden');
    setup.classList.toggle('hidden');
    btn.textContent = isHidden ? 'Cancel' : 'Setup';
}

// Save SendGrid configuration
function saveSendGridConfig() {
    const apiKey = document.getElementById('sendgrid-api-key')?.value;
    const fromEmail = document.getElementById('sendgrid-from-email')?.value;
    
    if (!apiKey || !fromEmail) {
        showToast('Please fill all fields', 'error');
        return;
    }
    
    // Update UI
    const card = document.getElementById('sendgrid-connect-card');
    if (card) card.classList.add('border-green-500');
    
    // Store config
    const providerEl = document.getElementById('email-provider');
    const configEl = document.getElementById('email-config-data');
    if (providerEl) providerEl.value = 'sendgrid';
    if (configEl) configEl.value = JSON.stringify({ provider: 'sendgrid', apiKey, fromEmail });
    
    // Hide setup and show connected state
    const setup = document.getElementById('sendgrid-setup');
    const btn = document.getElementById('sendgrid-setup-btn');
    if (setup) setup.classList.add('hidden');
    if (btn) {
        btn.textContent = 'Connected ';
        btn.disabled = true;
        btn.classList.remove('btn-secondary');
        btn.classList.add('bg-green-500/20', 'text-green-400', 'cursor-default');
    }
    
    // Update wizard state
    if (typeof wizState !== 'undefined' && wizState.data) {
        wizState.data.config = wizState.data.config || {};
        wizState.data.config.email = { provider: 'sendgrid', apiKey, fromEmail };
    }
    
    showToast('SendGrid configured successfully', 'success');
}

// Get email configuration (for saving tool)
function getEmailConfig() {
    const configData = document.getElementById('email-config-data')?.value;
    if (configData) {
        try {
            return JSON.parse(configData);
        } catch (e) {}
    }
    return null;
}

// Legacy functions for compatibility
function toggleEmailProvider(provider) {}
function onEmailProviderSelect() {}
function onEmailProvChange() {}

function onSheetProvChange() {
    const p = document.getElementById('sheet-provider').value;
    document.getElementById('sheet-google-fields').classList.toggle('hidden', p !== 'google');
    document.getElementById('sheet-airtable-fields').classList.toggle('hidden', p !== 'airtable');
}

function onStorageTypeChange() {
    const type = document.getElementById('storage-type')?.value;
    document.getElementById('storage-cloud-section')?.classList.toggle('hidden', type !== 'cloud');
    document.getElementById('storage-local-section')?.classList.toggle('hidden', type !== 'local');
}

function onStorageProvChange() {
    const p = document.getElementById('storage-provider')?.value;
    const isOCI = p?.startsWith('oci_');
    const isAzure = p?.startsWith('azure_');
    const isGCS = p?.startsWith('gcs');
    const needsEndpoint = ['minio', 'digitalocean_spaces', 'backblaze_b2', 'wasabi', 'cloudflare_r2', 'linode_obj', 'vultr_obj'].includes(p);
    
    document.getElementById('storage-s3-fields')?.classList.toggle('hidden', isOCI || isAzure || isGCS);
    document.getElementById('storage-oci-fields')?.classList.toggle('hidden', !isOCI);
    document.getElementById('storage-azure-fields')?.classList.toggle('hidden', !isAzure);
    document.getElementById('storage-gcs-fields')?.classList.toggle('hidden', !isGCS);
    document.getElementById('storage-endpoint-field')?.classList.toggle('hidden', !needsEndpoint);
}

function onLocalStorageTypeChange() {
    const type = document.getElementById('local-storage-type')?.value;
    const isLocal = type === 'local';
    document.getElementById('local-path-field')?.classList.toggle('hidden', !isLocal);
    document.getElementById('network-storage-fields')?.classList.toggle('hidden', isLocal);
    document.getElementById('sftp-key-field')?.classList.toggle('hidden', type !== 'sftp');
    
    // Update port based on protocol
    const ports = { nfs: 2049, smb: 445, sftp: 22, ftp: 21, webdav: 443 };
    const portEl = document.getElementById('net-port');
    if (portEl && ports[type]) portEl.value = ports[type];
}

function onAzureAuthChange() {
    const type = document.getElementById('azure-auth-type')?.value;
    const isConnString = type === 'connection_string' || type === 'account_key' || type === 'sas_token';
    document.getElementById('azure-conn-string-field')?.classList.toggle('hidden', !isConnString);
    document.getElementById('azure-sp-fields')?.classList.toggle('hidden', type !== 'service_principal');
}

function onCRMChange() {
    const p = document.getElementById('crm-platform').value;
    document.getElementById('crm-salesforce-fields')?.classList.toggle('hidden', p !== 'salesforce');
    document.getElementById('crm-hubspot-fields')?.classList.toggle('hidden', p !== 'hubspot');
}

function onMsgPlatformChange() {
    const p = document.getElementById('msg-platform').value;
    
    // Hide all platform-specific fields first
    const platforms = ['slack', 'teams', 'whatsapp', 'facebook', 'telegram', 'twilio', 'discord', 'firebase', 'generic'];
    platforms.forEach(plat => {
        document.getElementById(`msg-${plat}-fields`)?.classList.add('hidden');
    });
    
    // Show relevant fields
    if (p === 'slack') document.getElementById('msg-slack-fields')?.classList.remove('hidden');
    else if (p === 'teams') document.getElementById('msg-teams-fields')?.classList.remove('hidden');
    else if (p === 'whatsapp') document.getElementById('msg-whatsapp-fields')?.classList.remove('hidden');
    else if (p === 'facebook' || p === 'instagram') document.getElementById('msg-facebook-fields')?.classList.remove('hidden');
    else if (p === 'telegram') document.getElementById('msg-telegram-fields')?.classList.remove('hidden');
    else if (p === 'twilio' || p === 'vonage' || p === 'plivo' || p === 'messagebird' || p === 'sinch') document.getElementById('msg-twilio-fields')?.classList.remove('hidden');
    else if (p === 'discord') document.getElementById('msg-discord-fields')?.classList.remove('hidden');
    else if (p === 'firebase_fcm' || p === 'onesignal' || p === 'pusher') document.getElementById('msg-firebase-fields')?.classList.remove('hidden');
    else document.getElementById('msg-generic-fields')?.classList.remove('hidden');
}

function onTeamsTypeChange() {
    const type = document.getElementById('teams-type')?.value;
    document.getElementById('teams-webhook-field')?.classList.toggle('hidden', type !== 'webhook');
    document.getElementById('teams-bot-fields')?.classList.toggle('hidden', type !== 'bot' && type !== 'graph');
}

function onWhatsAppProviderChange() {
    const p = document.getElementById('whatsapp-provider')?.value;
    document.getElementById('whatsapp-meta-fields')?.classList.toggle('hidden', p !== 'meta');
}

function onSTTProviderChange() {
    const p = document.getElementById('stt-provider')?.value;
    const isOCI = p === 'oci_speech';
    const isAzure = p === 'azure';
    const isLocal = ['whisper_local', 'vosk', 'deepspeech', 'kaldi', 'coqui'].includes(p);
    
    document.getElementById('stt-cloud-fields')?.classList.toggle('hidden', isOCI || isAzure || isLocal);
    document.getElementById('stt-oci-fields')?.classList.toggle('hidden', !isOCI);
    document.getElementById('stt-azure-fields')?.classList.toggle('hidden', !isAzure);
    document.getElementById('stt-local-fields')?.classList.toggle('hidden', !isLocal);
}

function onTTSProviderChange() {
    const p = document.getElementById('tts-provider')?.value;
    const isOCI = p === 'oci_speech';
    const isLocal = ['coqui_tts', 'piper', 'espeak', 'festival', 'mimic'].includes(p);
    
    document.getElementById('tts-cloud-fields')?.classList.toggle('hidden', isOCI || isLocal);
    document.getElementById('tts-oci-fields')?.classList.toggle('hidden', !isOCI);
    document.getElementById('tts-local-fields')?.classList.toggle('hidden', !isLocal);
}

function onOCRProviderChange() {
    const p = document.getElementById('ocr-provider')?.value;
    const isOCI = p === 'oci_vision' || p === 'oci_doc';
    const isLocal = ['tesseract', 'paddleocr', 'easyocr', 'doctr', 'surya'].includes(p);
    
    document.getElementById('ocr-cloud-fields')?.classList.toggle('hidden', isOCI || isLocal);
    document.getElementById('ocr-oci-fields')?.classList.toggle('hidden', !isOCI);
    document.getElementById('ocr-local-fields')?.classList.toggle('hidden', !isLocal);
}

// Code Execution Functions
function onCodeModeChange() {
    const mode = document.getElementById('code-mode')?.value;
    document.getElementById('code-gen-section')?.classList.toggle('hidden', mode === 'execute');
    document.getElementById('code-manual-section')?.classList.toggle('hidden', mode === 'generate');
    document.getElementById('code-manual-input')?.classList.toggle('hidden', mode === 'generate');
}

async function generateToolCode() {
    const description = document.getElementById('code-description')?.value;
    const inputs = document.getElementById('code-inputs')?.value;
    const outputFormat = document.getElementById('code-output-format')?.value;
    const lang = document.getElementById('code-lang')?.value || 'python';
    
    if (!description) {
        alert('Please provide a tool description');
        return;
    }
    
    try {
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="animate-spin"></span> Generating...';
        
        const response = await fetch(API + '/api/tools/generate-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ description, inputs, output_format: outputFormat, language: lang })
        });
        
        const data = await response.json();
        
        if (data.code) {
            document.getElementById('code-generated').value = data.code;
            document.getElementById('generated-code-preview').classList.remove('hidden');
        } else {
            alert('Failed to generate code: ' + (data.error || 'Unknown error'));
        }
        
        btn.disabled = false;
        btn.innerHTML = '<span></span> Generate Code';
    } catch (e) {
        console.error('Code generation error:', e);
        alert('Error generating code: ' + e.message);
    }
}

// Human in the Loop Functions
function onHITLTypeChange() {
    const type = document.getElementById('hitl-type')?.value;
    
    document.getElementById('hitl-approval-fields')?.classList.toggle('hidden', type !== 'approval');
    document.getElementById('hitl-selection-fields')?.classList.toggle('hidden', type !== 'selection');
    document.getElementById('hitl-form-fields')?.classList.toggle('hidden', type !== 'form');
}

function addHITLFormField() {
    const template = document.getElementById('hitl-field-template');
    const builder = document.getElementById('hitl-form-builder');
    if (!template || !builder) return;
    
    const clone = template.content.cloneNode(true);
    builder.appendChild(clone);
}

function removeHITLFormField(btn) {
    btn.closest('.hitl-field-item')?.remove();
}

function onHITLFieldTypeChange(select) {
    const type = select.value;
    const container = select.closest('.hitl-field-item');
    const optionsField = container?.querySelector('.hitl-field-options');
    
    if (optionsField) {
        optionsField.classList.toggle('hidden', !['select', 'radio', 'checkbox'].includes(type));
    }
}

function toggleHITLDeployment() {
    const checked = document.getElementById('hitl-deploy-form')?.checked;
    document.getElementById('hitl-deployment-fields')?.classList.toggle('hidden', !checked);
}

// TTS speed/pitch display
function updateTTSDisplay() {
    const speed = document.getElementById('tts-speed')?.value || 1;
    const pitch = document.getElementById('tts-pitch')?.value || 1;
    document.getElementById('tts-speed-val').textContent = speed + 'x';
    document.getElementById('tts-pitch-val').textContent = pitch + 'x';
}

// ============================================================================
// AUTHENTICATION & SECURITY FUNCTIONS
// ============================================================================

// Auth state
let authToken = localStorage.getItem('agentforge_token') || null;
let currentUser = JSON.parse(localStorage.getItem('agentforge_user') || 'null');
let securityUsers = [];
let securityRoles = [];
// ============================================================================
// PERMISSION SYSTEM
// ============================================================================

function hasPermission(permission) {
    if (!currentUser || !currentUser.permissions) return false;
    if (currentUser.permissions.includes('system:admin')) return true;
    return currentUser.permissions.includes(permission);
}

function hasAnyPermission(permissions) {
    return permissions.some(p => hasPermission(p));
}

function hasAllPermissions(permissions) {
    return permissions.every(p => hasPermission(p));
}

const MENU_PERMISSIONS = {
    "chat": "chat:use",
    "agents": "agents:view",
    "tools": "tools:view",
    "create": "agents:create",
    "demo": "demo:access",
    "settings": "system:settings",
    "security": "users:view",
};

function updateUIByPermissions() {
    if (!currentUser) return;
    
    Object.entries(MENU_PERMISSIONS).forEach(([menu, permission]) => {
        const navItem = document.getElementById('nav-' + menu);
        const mobItem = document.getElementById('mob-' + menu);
        
        if (hasPermission(permission)) {
            if (navItem) navItem.classList.remove('hidden');
            if (mobItem) mobItem.classList.remove('hidden');
        } else {
            if (navItem) navItem.classList.add('hidden');
            if (mobItem) mobItem.classList.add('hidden');
        }
    });
    
    const secNav = document.getElementById('nav-security');
    if (secNav) {
        if (hasAnyPermission(['users:view', 'roles:view', 'system:admin'])) {
            secNav.classList.remove('hidden');
        } else {
            secNav.classList.add('hidden');
        }
    }
    
    document.querySelectorAll('[data-permission]').forEach(el => {
        const perms = el.dataset.permission.split(',').map(p => p.trim());
        if (hasAnyPermission(perms)) {
            el.style.display = '';
        } else {
            el.style.display = 'none';
        }
    });
    
    console.log('Permissions updated:', currentUser.email);
}



// Check authentication on page load
function checkAuth() {
    // Check for OAuth token in URL hash
    const hash = window.location.hash;
    if (hash && hash.includes('token=')) {
        const params = new URLSearchParams(hash.split('?')[1]);
        const oauthToken = params.get('token');
        if (oauthToken) {
            authToken = oauthToken;
            localStorage.setItem('agentforge_token', authToken);
            window.history.replaceState(null, '', '/ui/');
        }
    }
    
    if (!authToken) {
        showLoginPage();
        return false;
    }
    
    // We have a token - show app immediately while we verify
    // This prevents the login flash
    if (currentUser && currentUser.id) {
        showApp();
        updateUserDisplay();
        updateUIByPermissions();
    }
    
    // Verify token is still valid in background
    fetch('/api/security/auth/me', {
        headers: { 'Authorization': 'Bearer ' + authToken }
    }).then(res => {
        if (!res.ok) {
            clearAuth();
            showLoginPage();
            return null;
        }
        return res.json();
    }).then(data => {
        if (data && data.id) {
            currentUser = data;
            localStorage.setItem('agentforge_user', JSON.stringify(currentUser));
            if (data.must_change_password) {
                showFirstLoginPasswordModal();
                return;
            }
            showApp();
            updateUserDisplay();
            updateUIByPermissions();
            
            // Navigate to hash if present
            const pageHash = window.location.hash.slice(1);
            if (pageHash && !pageHash.includes('token') && document.getElementById('page-' + pageHash)) {
                navigate(pageHash, false);
            }
        }
    }).catch((err) => {
        console.error('Auth check failed:', err);
        clearAuth();
        showLoginPage();
    });
    
    return true;
}

// Show login page
function showLoginPage() {
    document.getElementById('loading-screen')?.classList.add('hidden');
    document.getElementById('page-login').classList.add('visible');
    document.getElementById('app').classList.add('hidden');
}

// Show main app
function showApp() {
    document.getElementById('loading-screen')?.classList.add('hidden');
    document.getElementById('page-login').classList.remove('visible');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('app').classList.add('flex');
    // Initialize app data after showing
    if (typeof initAppData === 'function') {
        initAppData();
    }
}

// Handle login
// Check password strength
function checkPasswordStrength(password) {
    let strength = 0;
    const str1 = document.getElementById('str-1');
    const str2 = document.getElementById('str-2');
    const str3 = document.getElementById('str-3');
    const str4 = document.getElementById('str-4');
    const strText = document.getElementById('str-text');
    
    if (!str1) return; // Elements not found
    
    // Reset
    [str1, str2, str3, str4].forEach(el => el.className = 'h-1 flex-1 rounded bg-gray-600');
    
    if (password.length >= 8) strength++;
    if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
    if (password.match(/[0-9]/)) strength++;
    if (password.match(/[^a-zA-Z0-9]/)) strength++;
    
    const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500'];
    const texts = ['Weak', 'Fair', 'Good', 'Strong'];
    
    if (strength >= 1) str1.className = 'h-1 flex-1 rounded ' + colors[strength-1];
    if (strength >= 2) str2.className = 'h-1 flex-1 rounded ' + colors[strength-1];
    if (strength >= 3) str3.className = 'h-1 flex-1 rounded ' + colors[strength-1];
    if (strength >= 4) str4.className = 'h-1 flex-1 rounded ' + colors[strength-1];
    
    strText.textContent = strength > 0 ? texts[strength-1] : '';
    strText.className = 'text-xs ' + (strength > 0 ? colors[strength-1].replace('bg-', 'text-') : 'text-gray-500');
}

// OAuth login
async function oauthLogin(provider) {
    try {
        showToast('Redirecting to ' + provider + '...', 'info');
        const res = await fetch('/api/security/oauth/' + provider + '/login');
        const data = await res.json();
        console.log("Login response:", data);
        
        if (data.auth_url) {
            window.location.href = data.auth_url;
        } else {
            showToast(data.detail || 'OAuth not configured', 'error');
        }
    } catch (e) {
        showToast('OAuth error: ' + e.message, 'error');
    }
}

// Toggle password visibility
function togglePassword(inputId, btn) {
    const input = document.getElementById(inputId);
    const icon = btn.querySelector('.eye-icon');
    if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88"/></svg>';
    } else {
        input.type = 'password';
        icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>';
    }
}

async function handleLogin(event) {
    event.preventDefault();
    
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const remember = document.getElementById('login-remember')?.checked || false;
    const mfaCode = document.getElementById('login-mfa-code')?.value || '';
    
    const btn = document.getElementById('login-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin inline-block"></span> Signing in...';
    
    try {
        const res = await fetch('/api/security/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, remember_me: remember, mfa_code: mfaCode || undefined })
        });
        
        const data = await res.json();
        console.log("Login response:", data);
        
        if (!res.ok) {
            showToast(typeof data.detail === 'object' ? JSON.stringify(data.detail) : (data.detail || 'Login failed'), 'error');
            btn.disabled = false;
            btn.textContent = 'Sign In';
            return;
        }
        
        // Check if MFA is required
        if (data.requires_mfa) {
            btn.disabled = false;
            btn.textContent = 'Sign In';
            
            // Store credentials temporarily for MFA verification
            window.pendingLoginEmail = email;
            window.pendingLoginPassword = password;
            window.pendingLoginRemember = remember;
            window.pendingMfaMethods = data.mfa_methods || [];
            
            showLoginMfaModal(data.mfa_methods);
            return;
        }
        
        // Store auth data
        authToken = data.access_token;
        currentUser = data.user;
        
        if (remember) {
            localStorage.setItem('agentforge_token', authToken);
            localStorage.setItem('agentforge_user', JSON.stringify(currentUser));
        } else {
            sessionStorage.setItem('agentforge_token', authToken);
            sessionStorage.setItem('agentforge_user', JSON.stringify(currentUser));
        }
        
        if (data.must_change_password) { btn.disabled = false; btn.textContent = 'Sign In'; showFirstLoginPasswordModal(); return; }
        showApp();
        updateUserDisplay();
        updateUIByPermissions();
        navigate('agents');
        showToast('Welcome back, ' + (currentUser.name || currentUser.email) + '!', 'success');
        
    } catch (e) {
        showToast('Connection error: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.textContent = 'Sign In';
}

function showLoginMfaModal(methods) {
    const modal = document.createElement('div');
    modal.id = 'login-mfa-modal';
    modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999]';
    modal.innerHTML = `
        <div class="card rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="text-center mb-6">
                <div class="text-5xl mb-3"></div>
                <h3 class="text-xl font-bold">Two-Factor Authentication</h3>
                <p class="text-gray-400 text-sm mt-2">A verification code has been sent to your email</p>
            </div>
            
            <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 mb-6">
                <div class="flex items-center gap-3">
                    <span class="text-2xl"></span>
                    <div>
                        <p class="text-green-400 font-medium">Code Sent!</p>
                        <p class="text-sm text-gray-400">Check your email for the 6-digit code</p>
                    </div>
                </div>
            </div>
            
            <div>
                <label class="block text-sm text-gray-400 mb-2">Verification Code</label>
                <input type="text" id="login-mfa-code" class="input-field w-full px-4 py-3 rounded-lg text-center text-2xl tracking-widest" placeholder="000000" maxlength="6" autofocus>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="closeLoginMfaModal()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                <button onclick="verifyLoginMfa()" id="verify-mfa-btn" class="btn-primary flex-1 py-2 rounded-lg">Verify</button>
            </div>
            
            <div class="text-center mt-4">
                <button onclick="resendLoginMfaCode()" id="resend-mfa-btn" class="text-sm text-gray-400 hover:text-purple-400 transition">
                    Didn't receive the code? Resend
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Focus on input
    setTimeout(() => document.getElementById('login-mfa-code')?.focus(), 100);
}

function closeLoginMfaModal() {
    document.getElementById('login-mfa-modal')?.remove();
    window.pendingLoginEmail = null;
    window.pendingLoginPassword = null;
    window.pendingLoginRemember = null;
}

async function resendLoginMfaCode() {
    const btn = document.getElementById('resend-mfa-btn');
    btn.disabled = true;
    btn.textContent = 'Sending...';
    
    try {
        const res = await fetch('/api/security/mfa/send-login-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: window.pendingLoginEmail,
                password: window.pendingLoginPassword
            })
        });
        
        if (res.ok) {
            showToast('New code sent to your email', 'success');
            btn.textContent = 'Code Sent ';
            setTimeout(() => {
                btn.textContent = "Didn't receive the code? Resend";
                btn.disabled = false;
            }, 30000);
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to send code', 'error');
            btn.disabled = false;
            btn.textContent = "Didn't receive the code? Resend";
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
        btn.disabled = false;
        btn.textContent = "Didn't receive the code? Resend";
    }
}

async function verifyLoginMfa() {
    const code = document.getElementById('login-mfa-code')?.value;
    if (!code || code.length < 6) {
        showToast('Please enter a valid code', 'error');
        return;
    }
    
    const btn = document.getElementById('verify-mfa-btn');
    btn.disabled = true;
    btn.textContent = 'Verifying...';
    
    try {
        const res = await fetch('/api/security/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: window.pendingLoginEmail,
                password: window.pendingLoginPassword,
                remember_me: window.pendingLoginRemember,
                mfa_code: code
            })
        });
        
        const data = await res.json();
        console.log("Login response:", data);
        
        if (!res.ok) {
            showToast(data.detail || 'Invalid code', 'error');
            btn.disabled = false;
            btn.textContent = 'Verify';
            return;
        }
        
        // Success - close modal and complete login
        closeLoginMfaModal();
        
        authToken = data.access_token;
        currentUser = data.user;
        
        if (window.pendingLoginRemember) {
            localStorage.setItem('agentforge_token', authToken);
            localStorage.setItem('agentforge_user', JSON.stringify(currentUser));
        } else {
            sessionStorage.setItem('agentforge_token', authToken);
            sessionStorage.setItem('agentforge_user', JSON.stringify(currentUser));
        }
        
        if (data.must_change_password) { showFirstLoginPasswordModal(); return; }
        showApp();
        updateUserDisplay();
        updateUIByPermissions();
        navigate('agents');
        showToast('Welcome back, ' + (currentUser.name || currentUser.email) + '!', 'success');
        
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Verify';
    }
}



// Handle First Login Password Change
async function handleFirstLoginPasswordChange(event) {
    event.preventDefault();
    var newPass = document.getElementById('flp-new-password').value;
    var confirmPass = document.getElementById('flp-confirm-password').value;
    var errorDiv = document.getElementById('flp-error');
    var btn = document.getElementById('flp-submit-btn');
    errorDiv.classList.add('hidden');
    if (newPass !== confirmPass) { errorDiv.textContent = 'Passwords do not match'; errorDiv.classList.remove('hidden'); return; }
    btn.disabled = true; btn.textContent = 'Changing...';
    try {
        var res = await fetch('/api/security/auth/first-login-password-change', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, body: JSON.stringify({ new_password: newPass, confirm_password: confirmPass }) });
        var data = await res.json();
        if (!res.ok) { errorDiv.textContent = data.detail.message || data.detail; errorDiv.classList.remove('hidden'); btn.disabled = false; btn.textContent = 'Change Password'; return; }
        document.getElementById('first-login-password-modal').remove();
        currentUser.must_change_password = false;
        showApp(); updateUserDisplay(); navigate('agents'); showToast('Password changed successfully!', 'success');
    } catch (e) { errorDiv.textContent = 'Error: ' + e.message; errorDiv.classList.remove('hidden'); }
    btn.disabled = false; btn.textContent = 'Change Password';
}

// First Login Password Modal
function showFirstLoginPasswordModal() {
    var modal = document.createElement('div');
    modal.id = 'first-login-password-modal';
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
    modal.innerHTML = '<div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div><div class="relative card rounded-2xl p-8 w-full max-w-md mx-4"><div class="text-center mb-6"><h2 class="text-2xl font-bold mb-2">Change Your Password</h2><p class="text-gray-400">For security, you must change your temporary password.</p></div><form onsubmit="handleFirstLoginPasswordChange(event)"><div class="space-y-4"><div><label class="block text-sm text-gray-400 mb-2">New Password</label><input type="password" id="flp-new-password" required minlength="8" class="input-field w-full px-4 py-3 rounded-lg" placeholder="Enter new password"></div><div><label class="block text-sm text-gray-400 mb-2">Confirm Password</label><input type="password" id="flp-confirm-password" required minlength="8" class="input-field w-full px-4 py-3 rounded-lg" placeholder="Confirm password"></div><div id="flp-error" class="hidden bg-red-500/20 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg text-sm"></div><button type="submit" id="flp-submit-btn" class="w-full py-3 rounded-lg font-semibold text-white" style="background: var(--accent-gradient);">Change Password</button></div></form></div>';
    document.body.appendChild(modal);
}

// Show register form
function showRegister() {
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
            <p class="text-gray-400">Create your account</p>
        </div>
        <div class="card rounded-2xl p-8">
            <h2 class="text-xl font-bold mb-6">Get Started</h2>
            
            <!-- OAuth Buttons -->
            <div class="space-y-3 mb-6">
                <button onclick="oauthLogin('google')" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg border border-gray-600 hover:bg-gray-700 transition">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    <span>Continue with Google</span>
                </button>
                <button onclick="oauthLogin('microsoft')" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg border border-gray-600 hover:bg-gray-700 transition">
                    <svg width="20" height="20" viewBox="0 0 23 23"><path fill="#f35325" d="M1 1h10v10H1z"/><path fill="#81bc06" d="M12 1h10v10H12z"/><path fill="#05a6f0" d="M1 12h10v10H1z"/><path fill="#ffba08" d="M12 12h10v10H12z"/></svg>
                    <span>Continue with Microsoft</span>
                </button>
            </div>
            
            <!-- Divider -->
            <div class="flex items-center gap-4 mb-6">
                <div class="flex-1 h-px bg-gray-600"></div>
                <span class="text-sm text-gray-400">or register with email</span>
                <div class="flex-1 h-px bg-gray-600"></div>
            </div>
            
            <form onsubmit="handleRegister(event)">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">First Name</label>
                            <input type="text" id="reg-firstname" required class="input-field w-full px-4 py-3 rounded-lg" placeholder="John">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Last Name</label>
                            <input type="text" id="reg-lastname" required class="input-field w-full px-4 py-3 rounded-lg" placeholder="Doe">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Work Email</label>
                        <input type="email" id="reg-email" required class="input-field w-full px-4 py-3 rounded-lg" placeholder="you@company.com">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Password</label>
                        <div class="relative">
                            <input type="password" id="reg-password" required minlength="8" 
                                   class="input-field w-full px-4 py-3 pr-12 rounded-lg" 
                                   placeholder="Min 8 characters"
                                   oninput="checkPasswordStrength(this.value)">
                            <button type="button" onclick="togglePassword('reg-password', this)" 
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1">
                                <span class="eye-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>
                            </button>
                        </div>
                        <!-- Password Strength Indicator -->
                        <div class="mt-2">
                            <div class="flex gap-1 mb-1">
                                <div id="str-1" class="h-1 flex-1 rounded bg-gray-600"></div>
                                <div id="str-2" class="h-1 flex-1 rounded bg-gray-600"></div>
                                <div id="str-3" class="h-1 flex-1 rounded bg-gray-600"></div>
                                <div id="str-4" class="h-1 flex-1 rounded bg-gray-600"></div>
                            </div>
                            <p id="str-text" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Confirm Password</label>
                        <div class="relative">
                            <input type="password" id="reg-password2" required class="input-field w-full px-4 py-3 pr-12 rounded-lg" placeholder="Repeat password">
                            <button type="button" onclick="togglePassword('reg-password2', this)" 
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1">
                                <span class="eye-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Terms of Service -->
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="reg-terms" required class="mt-1 rounded">
                        <label for="reg-terms" class="text-sm text-gray-400">
                            I agree to the <a href="#" class="text-purple-400 hover:text-purple-300">Terms of Service</a> 
                            and <a href="#" class="text-purple-400 hover:text-purple-300">Privacy Policy</a>
                        </label>
                    </div>
                    
                    <button type="submit" id="reg-btn" class="btn-primary w-full py-3 rounded-lg font-semibold">Create Account</button>
                </div>
            </form>
            <p class="text-center text-gray-400 text-sm mt-6">
                Already have an account? <button onclick="location.reload()" class="text-purple-400 hover:text-purple-300">Sign in</button>
            </p>
        </div>
    `;
}

// Handle registration
async function handleRegister(event) {
    event.preventDefault();
    
    const password = document.getElementById('reg-password').value;
    const password2 = document.getElementById('reg-password2').value;
    const passInput1 = document.getElementById('reg-password');
    const passInput2 = document.getElementById('reg-password2');
    
    // Reset any previous error styling
    passInput1.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
    passInput2.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
    
    // Validate passwords match
    if (password !== password2) {
        passInput1.classList.add('border-red-500', 'ring-2', 'ring-red-500');
        passInput2.classList.add('border-red-500', 'ring-2', 'ring-red-500');
        passInput2.focus();
        showToast('Passwords do not match. Please check and try again.', 'error');
        return;
    }
    
    // Validate password strength
    if (password.length < 8) {
        passInput1.classList.add('border-red-500', 'ring-2', 'ring-red-500');
        passInput1.focus();
        showToast('Password must be at least 8 characters long.', 'error');
        return;
    }
    
    // Validate terms accepted
    const termsCheckbox = document.getElementById('reg-terms');
    if (termsCheckbox && !termsCheckbox.checked) {
        showToast('Please accept the Terms of Service and Privacy Policy.', 'error');
        return;
    }
    
    const btn = document.getElementById('reg-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin inline-block"></span> Creating account...';
    
    try {
        const res = await fetch('/api/security/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: document.getElementById('reg-email').value,
                password: password,
                first_name: document.getElementById('reg-firstname').value,
                last_name: document.getElementById('reg-lastname').value
            })
        });
        
        const data = await res.json();
        console.log("Login response:", data);
        
        if (!res.ok) {
            let errorMsg = 'Registration failed. Please try again.';
            if (data.detail) {
                if (typeof data.detail === 'string') {
                    errorMsg = data.detail;
                } else if (data.detail.message) {
                    errorMsg = data.detail.message;
                }
            }
            showToast(errorMsg, 'error');
            btn.disabled = false;
            btn.textContent = 'Create Account';
            return;
        }
        
        // Show success message with email verification info
        showRegistrationSuccess(document.getElementById('reg-email').value, data.email_verification_required);
        
    } catch (e) {
        showToast('Connection error. Please check your internet and try again.', 'error');
        btn.disabled = false;
        btn.textContent = 'Create Account';
    }
}

// Show registration success with clear instructions
function showRegistrationSuccess(email, verificationRequired) {
    const container = document.getElementById('auth-container');
    
    if (verificationRequired) {
        container.innerHTML = `
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-3 mb-4">
                    <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                    <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
                </div>
            </div>
            <div class="card rounded-2xl p-8 text-center">
                <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold mb-2">Check your email</h2>
                <p class="text-gray-400 mb-4">
                    We sent a verification link to<br>
                    <strong class="text-white">${email}</strong>
                </p>
                <p class="text-sm text-gray-500 mb-6">
                    Click the link in the email to verify your account.<br>
                    If you don't see it, check your spam folder.
                </p>
                <button onclick="location.reload()" class="btn-primary w-full py-3 rounded-lg font-semibold">
                    Back to Sign In
                </button>
                <p class="text-sm text-gray-500 mt-4">
                    Didn't receive the email? 
                    <button onclick="resendVerification('${email}')" class="text-purple-400 hover:text-purple-300">Resend</button>
                </p>
            </div>
        `;
    } else {
        // No verification required - direct to login
        container.innerHTML = `
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-3 mb-4">
                    <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                    <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
                </div>
            </div>
            <div class="card rounded-2xl p-8 text-center">
                <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold mb-2">Account Created!</h2>
                <p class="text-gray-400 mb-6">
                    Your account has been created successfully.<br>
                    You can now sign in with your credentials.
                </p>
                <button onclick="location.reload()" class="btn-primary w-full py-3 rounded-lg font-semibold">
                    Sign In Now
                </button>
            </div>
        `;
    }
}

// Resend verification email
async function resendVerification(email) {
    showToast('Sending verification email...', 'info');
    try {
        const res = await fetch('/api/security/auth/resend-verification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        if (res.ok) {
            showToast('Verification email sent! Check your inbox.', 'success');
        } else {
            showToast('Could not send email. Please try again later.', 'error');
        }
    } catch (e) {
        showToast('Connection error. Please try again.', 'error');
    }
}

// Show forgot password
function showForgotPassword() {
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
            <p class="text-gray-400">Reset your password</p>
        </div>
        <div class="card rounded-2xl p-8">
            <h2 class="text-xl font-bold mb-2">Forgot Password?</h2>
            <p class="text-gray-400 text-sm mb-6">Enter your email and we'll send you a reset link.</p>
            
            <form onsubmit="handleForgotPassword(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Email</label>
                        <input type="email" id="forgot-email" required 
                               class="input-field w-full px-4 py-3 rounded-lg"
                               placeholder="you@company.com">
                    </div>
                    
                    <button type="submit" id="forgot-btn"
                            class="btn-primary w-full py-3 rounded-lg font-semibold">
                        Send Reset Link
                    </button>
                </div>
            </form>
            
            <p class="text-center text-gray-400 text-sm mt-6">
                Remember your password? 
                <button onclick="location.reload()" class="text-purple-400 hover:text-purple-300">Sign in</button>
            </p>
        </div>
    `;
}

// Handle forgot password
async function handleForgotPassword(event) {
    event.preventDefault();
    
    const email = document.getElementById('forgot-email').value;
    const btn = document.getElementById('forgot-btn');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin inline-block"></span> Sending...';
    
    try {
        const res = await fetch('/api/security/auth/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        
        // Always show success (don't reveal if email exists)
        showForgotPasswordSuccess(email);
        
    } catch (e) {
        showForgotPasswordSuccess(email);
    }
}

// Show forgot password success
function showForgotPasswordSuccess(email) {
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
        </div>
        <div class="card rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
            </div>
            <h2 class="text-xl font-bold mb-2">Check your email</h2>
            <p class="text-gray-400 mb-4">
                If an account exists for<br>
                <strong class="text-white">${email}</strong><br>
                you will receive a password reset link.
            </p>
            <p class="text-sm text-gray-500 mb-6">
                Check your spam folder if you don't see it.
            </p>
            <button onclick="location.reload()" class="btn-primary w-full py-3 rounded-lg font-semibold">
                Back to Sign In
            </button>
        </div>
    `;
}

// Logout
function logout() {
    clearAuth();
    location.reload();
}

// Clear auth data
function clearAuth() {
    authToken = null;
    currentUser = null;
    localStorage.removeItem('agentforge_token');
    localStorage.removeItem('agentforge_user');
    sessionStorage.removeItem('agentforge_token');
    sessionStorage.removeItem('agentforge_user');
}

// Update user display
function updateUserDisplay() {
    if (!currentUser) return;
    
    const name = currentUser.name || currentUser.email?.split('@')[0] || 'User';
    document.getElementById('user-avatar').textContent = name[0].toUpperCase();
    document.getElementById('user-name').textContent = name;
    const emailEl = document.getElementById('user-email');
    if (emailEl) {
        emailEl.textContent = currentUser.email || 'Click to view profile';
    }
}

// Alias for profile page compatibility
async function fetchCurrentUser() {
    try {
        const res = await fetch(API + '/api/security/auth/me', {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (res.ok) {
            currentUser = await res.json();
            localStorage.setItem('agentforge_user', JSON.stringify(currentUser));
            updateUserDisplay();
        }
    } catch (e) {
        console.error('Error fetching current user:', e);
    }
}

// Get auth headers
function getAuthHeaders() {
    return authToken ? { 'Authorization': 'Bearer ' + authToken } : {};
}

// ============================================================================
// SECURITY CENTER FUNCTIONS
// ============================================================================

// Initialize security page

// Load security statistics
async function loadSecurityStats() {
    // Don't make request if not authenticated (best practice)
    if (!authToken) return;
    
    try {
        const res = await fetch('/api/security/stats', {
            headers: getAuthHeaders()
        });
        if (!res.ok) return;
        const stats = await res.json();
        
        document.getElementById('sec-stat-users').textContent = stats.users?.total || 0;
        document.getElementById('sec-stat-active').textContent = stats.users?.active || 0;
        document.getElementById('sec-stat-roles').textContent = stats.roles || 0;
        document.getElementById('sec-stat-policies').textContent = stats.policies || 0;
        document.getElementById('sec-stat-mfa').textContent = stats.users?.mfa_enabled || 0;
    } catch (e) {
        console.error('Error loading security stats:', e);
    }
}

// Load security users
async function loadSecurityUsers() {
    // Don't make request if not authenticated (best practice)
    if (!authToken) return;
    
    try {
        const res = await fetch('/api/security/users', {
            headers: getAuthHeaders()
        });
        
        if (res.status === 403) {
            document.getElementById('sec-users-table').innerHTML = 
                '<tr><td colspan="6" class="p-8 text-center text-yellow-500"> Admin permissions required</td></tr>';
            return;
        }
        
        if (!res.ok) return;
        const data = await res.json();
        console.log("Login response:", data);
        securityUsers = data.users || [];
        renderSecurityUsers();
    } catch (e) {
        console.error('Error loading users:', e);
    }
}

// Render security users table
function renderSecurityUsers() {
    const filter = document.getElementById('sec-user-search')?.value?.toLowerCase() || '';
    const status = document.getElementById('sec-user-filter')?.value || '';
    
    let users = securityUsers.filter(u => {
        if (filter && !u.email.toLowerCase().includes(filter) && !(u.name||'').toLowerCase().includes(filter)) return false;
        if (status && u.status !== status) return false;
        return true;
    });
    
    if (!users.length) {
        document.getElementById('sec-users-table').innerHTML = 
            '<tr><td colspan="6" class="p-8 text-center text-gray-500">No users found</td></tr>';
        return;
    }
    
    document.getElementById('sec-users-table').innerHTML = users.map(u => `
        <tr class="border-t border-gray-700 hover:bg-gray-800/50">
            <td class="p-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center font-bold text-white">
                        ${(u.name || u.email)[0].toUpperCase()}
                    </div>
                    <div>
                        <div class="font-medium">${escHtml(u.name || 'No name')}</div>
                        <div class="text-sm text-gray-400">${escHtml(u.email)}</div>
                    </div>
                </div>
            </td>
            <td class="p-4">
                ${(u.roles || []).map(roleName => {
                    // Use role names directly from API response (best practice)
                    return `<span class="px-2 py-1 rounded text-xs bg-blue-600/30 text-blue-400 mr-1">${escHtml(roleName)}</span>`;
                }).join('') || (u.role_ids || []).map(roleId => {
                    // Fallback: if roles array not available, try to find in securityRoles
                    const role = securityRoles.find(r => r.id === roleId);
                    const roleName = role ? role.name : (roleId.replace('role_', '') || roleId);
                    return `<span class="px-2 py-1 rounded text-xs bg-blue-600/30 text-blue-400 mr-1">${escHtml(roleName)}</span>`;
                }).join('')}
            </td>
            <td class="p-4">
                <span class="px-2 py-1 rounded text-xs ${u.status === 'active' ? 'bg-green-600/30 text-green-400' : u.status === 'pending' ? 'bg-yellow-600/30 text-yellow-400' : 'bg-red-600/30 text-red-400'}">${u.status}</span>
            </td>
            <td class="p-4 text-center">${u.mfa_enabled ? '<span class="text-green-400"></span>' : '<span class="text-gray-500"></span>'}</td>
            <td class="p-4 text-sm text-gray-400">${u.last_login ? new Date(u.last_login).toLocaleDateString() : 'Never'}</td>
            <td class="p-4 flex gap-2">
                <button data-permission="users:edit" onclick="editSecurityUser('${u.id}')" class="text-blue-400 hover:text-blue-300" title="Edit"></button>
                ${u.status === 'pending' && !u.email_verified ? `<button onclick="resendVerificationEmail('${u.id}', '${u.email}')" class="text-yellow-400 hover:text-yellow-300" title="Resend Verification"></button>` : ''}
                ${u.id !== currentUser?.id ? `<button data-permission="users:delete" onclick="deleteSecurityUser('${u.id}')" class="text-red-400 hover:text-red-300" title="Delete"></button>` : ''}
            </td>
        </tr>
    `).join('');
}

// Resend verification email to user
async function resendVerificationEmail(userId, email) {
    if (!confirm(`Send verification email to ${email}?`)) return;
    
    try {
        const res = await fetch(`/api/security/users/${userId}/resend-verification`, {
            method: 'POST',
            headers: getAuthHeaders()
        });
        
        if (res.ok) {
            showToast(`Verification email sent to ${email}`, 'success');
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to send email', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}


// Delete security user
async function deleteSecurityUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    
    try {
        const res = await fetch('/api/security/users/' + userId, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        
        if (res.ok) {
            showToast('User deleted successfully', 'success');
            loadSecurityUsers();
            loadSecurityStats();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to delete user', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

// Edit security user
function editSecurityUser(userId) {
    const user = securityUsers.find(u => u.id === userId);
    if (!user) return;
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm';
    modal.id = 'edit-user-modal';
    modal.innerHTML = `
        <div class="card rounded-2xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">Edit User</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Email</label>
                    <input type="email" id="edit-user-email" value="${user.email}" class="input-field w-full px-4 py-2 rounded-lg" disabled>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">First Name</label>
                        <input type="text" id="edit-user-firstname" value="${user.profile?.first_name || ''}" class="input-field w-full px-4 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Last Name</label>
                        <input type="text" id="edit-user-lastname" value="${user.profile?.last_name || ''}" class="input-field w-full px-4 py-2 rounded-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Status</label>
                    <select id="edit-user-status" class="input-field w-full px-4 py-2 rounded-lg">
                        <option value="active" ${user.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="pending" ${user.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="locked" ${user.status === 'locked' ? 'selected' : ''}>Locked</option>
                        <option value="disabled" ${user.status === 'disabled' ? 'selected' : ''}>Disabled</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Roles</label>
                    <div id="edit-user-roles" class="space-y-2">
                        ${securityRoles.map(r => `
                            <label class="flex items-center gap-2">
                                <input type="checkbox" value="${r.id}" ${(user.role_ids || []).includes(r.id) ? 'checked' : ''} class="rounded">
                                <span>${r.name}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="document.getElementById('edit-user-modal').remove()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                    <button onclick="saveUserEdit('${userId}')" class="btn-primary flex-1 py-2 rounded-lg">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Save user edit
async function saveUserEdit(userId) {
    const firstName = document.getElementById('edit-user-firstname').value;
    const lastName = document.getElementById('edit-user-lastname').value;
    const status = document.getElementById('edit-user-status').value;
    const roleCheckboxes = document.querySelectorAll('#edit-user-roles input[type="checkbox"]:checked');
    const roleIds = Array.from(roleCheckboxes).map(cb => cb.value);
    
    try {
        const res = await fetch('/api/security/users/' + userId, {
            method: 'PUT',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({
                profile: { first_name: firstName, last_name: lastName },
                status: status,
                role_ids: roleIds
            })
        });
        
        if (res.ok) {
            showToast('User updated successfully', 'success');
            document.getElementById('edit-user-modal').remove();
            loadSecurityUsers();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to update user', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

// Filter security users
function filterSecurityUsers() {
    renderSecurityUsers();
}

// Load security roles

// Load invitations
let securityInvitations = [];

async function loadSecurityInvitations() {
    // Don't make request if not authenticated (best practice)
    if (!authToken) return;
    
    try {
        const res = await fetch('/api/security/invitations', { headers: getAuthHeaders() });
        if (res.ok) {
            const data = await res.json();
        console.log("Login response:", data);
            securityInvitations = data.invitations || [];
            renderSecurityInvitations();
        }
    } catch (e) {
        console.error('Error loading invitations:', e);
    }
}

function renderSecurityInvitations() {
    const container = document.getElementById('sec-invitations-list');
    if (!container) return;
    
    if (!securityInvitations.length) {
        container.innerHTML = '<p class="text-gray-500 text-sm p-4">No pending invitations</p>';
        return;
    }
    
    container.innerHTML = securityInvitations.map(inv => `
        <div class="flex items-center justify-between p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-yellow-500/30 flex items-center justify-center text-yellow-400"></div>
                <div>
                    <p class="font-medium">${escHtml(inv.email)}</p>
                    <p class="text-xs text-gray-400">Invited ${new Date(inv.created_at).toLocaleDateString()}  ${inv.roles.join(', ')}</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs px-2 py-1 rounded ${inv.status === 'expired' ? 'bg-red-500/20 text-red-400' : 'bg-yellow-500/20 text-yellow-400'}">${inv.status}</span>
                <button onclick="resendInvitation('${inv.id}')" class="text-blue-400 hover:text-blue-300 p-1" title="Resend"></button>
                <button onclick="deleteInvitation('${inv.id}')" class="text-red-400 hover:text-red-300 p-1" title="Delete"></button>
            </div>
        </div>
    `).join('');
}

async function resendInvitation(invId) {
    try {
        const res = await fetch('/api/security/invitations/' + invId + '/resend', {
            method: 'POST',
            headers: getAuthHeaders()
        });
        if (res.ok) {
            showToast('Invitation resent successfully', 'success');
            loadSecurityInvitations();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to resend', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function deleteInvitation(invId) {
    if (!confirm('Delete this invitation?')) return;
    try {
        const res = await fetch('/api/security/invitations/' + invId, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        if (res.ok) {
            showToast('Invitation deleted', 'success');
            loadSecurityInvitations();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to delete', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function loadSecurityRoles() {
    // Don't make request if not authenticated (best practice)
    if (!authToken) return;
    
    try {
        const res = await fetch('/api/security/roles', {
            headers: getAuthHeaders()
        });
        if (!res.ok) return;
        const data = await res.json();
        console.log("Login response:", data);
        securityRoles = data.roles || [];
        renderSecurityRoles();
    } catch (e) {
        console.error('Error loading roles:', e);
    }
}

// Render security roles


// Toggle all permissions
function toggleAllPermissions(checked) {
    document.querySelectorAll('.role-perm').forEach(cb => cb.checked = checked);
    document.querySelectorAll('.select-cat').forEach(cb => cb.checked = checked);
}

// Toggle category permissions
function toggleCategoryPermissions(catIdx, checked) {
    document.querySelectorAll('.cat-' + catIdx).forEach(cb => cb.checked = checked);
    updateSelectAllState();
}

// Update select all checkbox state
function updateSelectAllState() {
    const allPerms = document.querySelectorAll('.role-perm');
    const checkedPerms = document.querySelectorAll('.role-perm:checked');
    const selectAll = document.getElementById('select-all-perms');
    if (selectAll) {
        selectAll.checked = allPerms.length === checkedPerms.length;
        selectAll.indeterminate = checkedPerms.length > 0 && checkedPerms.length < allPerms.length;
    }
}

// Show Add Role Modal
function showAddRoleModal() {
    const allPermissions = [
        // Security - User Management
        { category: ' User Management', permissions: [
            { id: 'users:view', name: 'View Users' },
            { id: 'users:edit', name: 'Edit Users' },
            { id: 'users:delete', name: 'Delete Users' },
            { id: 'users:invite', name: 'Invite Users' },
        ]},
        // Security - Role Management
        { category: ' Role Management', permissions: [
            { id: 'roles:view', name: 'View Roles' },
            { id: 'roles:create', name: 'Create Roles' },
            { id: 'roles:edit', name: 'Edit Roles' },
            { id: 'roles:delete', name: 'Delete Roles' },
        ]},
        // Security - Security & MFA
        { category: ' Security & MFA', permissions: [
            { id: 'security:settings', name: 'Security Settings' },
            { id: 'mfa:manage', name: 'Manage MFA' },
        ]},
        // AI Agent - Agents
        { category: ' AI Agents', permissions: [
            { id: 'agents:view', name: 'View Agents' },
            { id: 'agents:create', name: 'Create Agents' },
            { id: 'agents:edit', name: 'Edit Agents' },
            { id: 'agents:delete', name: 'Delete Agents' },
            { id: 'agents:publish', name: 'Publish Agents' },
        ]},
        // AI Agent - Tools
        { category: ' Tools & Integrations', permissions: [
            { id: 'tools:view', name: 'View Tools' },
            { id: 'tools:create', name: 'Create Tools' },
            { id: 'tools:edit', name: 'Edit Tools' },
            { id: 'tools:delete', name: 'Delete Tools' },
            { id: 'tools:execute', name: 'Execute Tools' },
        ]},
        // AI Agent - Chat
        { category: ' Chat', permissions: [
            { id: 'chat:use', name: 'Use Chat' },
            { id: 'chat:view_all', name: 'View All Chats' },
            { id: 'chat:delete', name: 'Delete Chats' },
        ]},
        // Analytics & Audit
        { category: ' Analytics & Audit', permissions: [
            { id: 'audit:view', name: 'View Audit Logs' },
            { id: 'audit:export', name: 'Export Audit Logs' },
            { id: 'analytics:view', name: 'View Analytics' },
            { id: 'reports:generate', name: 'Generate Reports' },
        ]},
        // Demo Lab
        { category: ' Demo Lab', permissions: [
            { id: 'demo:access', name: 'Access Demo Lab' },
            { id: 'demo:create', name: 'Create Demos' },
            { id: 'demo:share', name: 'Share Demos' },
        ]},
        // System
        { category: ' System', permissions: [
            { id: 'system:admin', name: 'Full System Admin' },
            { id: 'system:settings', name: 'System Settings' },
        ]},
    ];
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm';
    modal.id = 'role-modal';
    modal.innerHTML = `
        <div class="card rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Create New Role</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Role Name *</label>
                    <input type="text" id="role-name" class="input-field w-full px-4 py-2 rounded-lg" placeholder="e.g. Marketing Team">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Description</label>
                    <textarea id="role-description" class="input-field w-full px-4 py-2 rounded-lg" rows="2" placeholder="Role description..."></textarea>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm text-gray-400">Permissions</label>
                        <label class="flex items-center gap-2 text-sm text-green-400 cursor-pointer">
                            <input type="checkbox" id="select-all-add" onchange="document.querySelectorAll('#role-modal .role-perm').forEach(c=>c.checked=this.checked)" class="rounded">
                            <span>Select All</span>
                        </label>
                    </div>
                    ${allPermissions.map((cat, i) => `
                        <div class="mb-4 p-3 rounded-lg" style="background:rgba(139,92,246,0.1)">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-sm font-semibold text-purple-400">${cat.category}</h5>
                                <label class="flex items-center gap-1 text-xs text-gray-400 cursor-pointer">
                                    <input type="checkbox" onchange="document.querySelectorAll('#role-modal .cat-${i}').forEach(c=>c.checked=this.checked)" class="rounded">
                                    <span>All</span>
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                ${cat.permissions.map(p => `
                                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                                        <input type="checkbox" class="role-perm cat-${i} rounded" value="${p.id}">
                                        <span>${p.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="document.getElementById('role-modal').remove()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                    <button onclick="saveNewRole()" class="btn-primary flex-1 py-2 rounded-lg">Create Role</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Show Edit Role Modal
function showEditRoleModal(roleId) {
    const role = securityRoles.find(r => r.id === roleId);
    if (!role) return;
    
    const allPermissions = [
        // Security - User Management
        { category: ' User Management', permissions: [
            { id: 'users:view', name: 'View Users' },
            { id: 'users:edit', name: 'Edit Users' },
            { id: 'users:delete', name: 'Delete Users' },
            { id: 'users:invite', name: 'Invite Users' },
        ]},
        // Security - Role Management
        { category: ' Role Management', permissions: [
            { id: 'roles:view', name: 'View Roles' },
            { id: 'roles:create', name: 'Create Roles' },
            { id: 'roles:edit', name: 'Edit Roles' },
            { id: 'roles:delete', name: 'Delete Roles' },
        ]},
        // Security - Security & MFA
        { category: ' Security & MFA', permissions: [
            { id: 'security:settings', name: 'Security Settings' },
            { id: 'mfa:manage', name: 'Manage MFA' },
        ]},
        // AI Agent - Agents
        { category: ' AI Agents', permissions: [
            { id: 'agents:view', name: 'View Agents' },
            { id: 'agents:create', name: 'Create Agents' },
            { id: 'agents:edit', name: 'Edit Agents' },
            { id: 'agents:delete', name: 'Delete Agents' },
            { id: 'agents:publish', name: 'Publish Agents' },
        ]},
        // AI Agent - Tools
        { category: ' Tools & Integrations', permissions: [
            { id: 'tools:view', name: 'View Tools' },
            { id: 'tools:create', name: 'Create Tools' },
            { id: 'tools:edit', name: 'Edit Tools' },
            { id: 'tools:delete', name: 'Delete Tools' },
            { id: 'tools:execute', name: 'Execute Tools' },
        ]},
        // AI Agent - Chat
        { category: ' Chat', permissions: [
            { id: 'chat:use', name: 'Use Chat' },
            { id: 'chat:view_all', name: 'View All Chats' },
            { id: 'chat:delete', name: 'Delete Chats' },
        ]},
        // Analytics & Audit
        { category: ' Analytics & Audit', permissions: [
            { id: 'audit:view', name: 'View Audit Logs' },
            { id: 'audit:export', name: 'Export Audit Logs' },
            { id: 'analytics:view', name: 'View Analytics' },
            { id: 'reports:generate', name: 'Generate Reports' },
        ]},
        // Demo Lab
        { category: ' Demo Lab', permissions: [
            { id: 'demo:access', name: 'Access Demo Lab' },
            { id: 'demo:create', name: 'Create Demos' },
            { id: 'demo:share', name: 'Share Demos' },
        ]},
        // System
        { category: ' System', permissions: [
            { id: 'system:admin', name: 'Full System Admin' },
            { id: 'system:settings', name: 'System Settings' },
        ]},
    ];
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm';
    modal.id = 'role-modal';
    modal.innerHTML = `
        <div class="card rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Edit Role: ${escHtml(role.name)}</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Role Name *</label>
                    <input type="text" id="role-name" value="${escHtml(role.name)}" class="input-field w-full px-4 py-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Description</label>
                    <textarea id="role-description" class="input-field w-full px-4 py-2 rounded-lg" rows="2">${escHtml(role.description || '')}</textarea>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm text-gray-400">Permissions</label>
                        <label class="flex items-center gap-2 text-sm text-green-400 cursor-pointer">
                            <input type="checkbox" id="select-all-edit" onchange="document.querySelectorAll('#role-modal .role-perm').forEach(c=>c.checked=this.checked)" class="rounded">
                            <span>Select All</span>
                        </label>
                    </div>
                    ${allPermissions.map((cat, i) => `
                        <div class="mb-4 p-3 rounded-lg" style="background:rgba(139,92,246,0.1)">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-sm font-semibold text-purple-400">${cat.category}</h5>
                                <label class="flex items-center gap-1 text-xs text-gray-400 cursor-pointer">
                                    <input type="checkbox" onchange="document.querySelectorAll('#role-modal .cat-${i}').forEach(c=>c.checked=this.checked)" class="rounded">
                                    <span>All</span>
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                ${cat.permissions.map(p => `
                                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                                        <input type="checkbox" class="role-perm cat-${i} rounded" value="${p.id}" ${(role.permissions || []).includes(p.id) ? 'checked' : ''}>
                                        <span>${p.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="document.getElementById('role-modal').remove()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                    <button onclick="updateRole('${roleId}')" class="btn-primary flex-1 py-2 rounded-lg">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Save new role
async function saveNewRole() {
    const name = document.getElementById('role-name').value.trim();
    const description = document.getElementById('role-description').value.trim();
    const permissions = Array.from(document.querySelectorAll('.role-perm:checked')).map(cb => cb.value);
    
    if (!name) {
        showToast('Role name is required', 'error');
        return;
    }
    
    try {
        const res = await fetch('/api/security/roles', {
            method: 'POST',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, permissions })
        });
        
        if (res.ok) {
            showToast('Role created successfully', 'success');
            document.getElementById('role-modal').remove();
            loadSecurityRoles();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to create role', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

// Update existing role
async function updateRole(roleId) {
    const name = document.getElementById('role-name').value.trim();
    const description = document.getElementById('role-description').value.trim();
    const permissions = Array.from(document.querySelectorAll('.role-perm:checked')).map(cb => cb.value);
    
    if (!name) {
        showToast('Role name is required', 'error');
        return;
    }
    
    try {
        const res = await fetch('/api/security/roles/' + roleId, {
            method: 'PUT',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, permissions })
        });
        
        if (res.ok) {
            showToast('Role updated successfully', 'success');
            document.getElementById('role-modal').remove();
            loadSecurityRoles();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to update role', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

// Delete role
async function deleteRole(roleId) {
    const role = securityRoles.find(r => r.id === roleId);
    if (!role) return;
    
    if (role.is_system) {
        showToast('Cannot delete system roles', 'error');
        return;
    }
    
    if (!confirm('Are you sure you want to delete the role "' + role.name + '"?')) return;
    
    try {
        const res = await fetch('/api/security/roles/' + roleId, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        
        if (res.ok) {
            showToast('Role deleted successfully', 'success');
            loadSecurityRoles();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to delete role', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

function renderSecurityRoles() {
    const icons = { 'role_super_admin': '', 'role_admin': '', 'role_manager': '', 'role_user': '', 'role_viewer': '' };
    
    document.getElementById('sec-roles-grid').innerHTML = securityRoles.map(r => `
        <div class="card rounded-xl p-4 hover:border-purple-500/50 transition-colors">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">${icons[r.id] || ''}</span>
                    <h4 class="font-bold">${escHtml(r.name)}</h4>
                    ${r.is_system ? '<span class="text-xs bg-gray-600 px-2 py-1 rounded ml-2">System</span>' : ''}
                </div>
                <div class="flex items-center gap-2">
                    <button data-permission="roles:edit" onclick="showEditRoleModal('${r.id}')" class="text-blue-400 hover:text-blue-300" title="Edit Permissions"></button>
                    ${!r.is_system ? `<button data-permission="roles:delete" onclick="deleteRole('${r.id}')" class="text-red-400 hover:text-red-300" title="Delete"></button>` : ''}
                </div>
            </div>
            <p class="text-sm text-gray-400 mb-3">${escHtml(r.description || 'No description')}</p>
            <div class="flex items-center justify-between text-sm">
                <span class="text-purple-400">${(r.permissions || []).length} permissions</span>
                <span class="text-gray-500">${r.user_count || 0} users</span>
            </div>
        </div>
    `).join('');
}

// Switch security tab
function switchSecurityTab(tab) {
    const tabs = ['users', 'roles', 'audit', 'mfa', 'settings'];
    
    // Check if requested tab is visible (has permission)
    const requestedTabBtn = document.getElementById('sec-tab-' + tab);
    if (requestedTabBtn && requestedTabBtn.style.display === 'none') {
        // Find first visible tab
        for (const t of tabs) {
            const btn = document.getElementById('sec-tab-' + t);
            if (btn && btn.style.display !== 'none') {
                tab = t;
                break;
            }
        }
    }
    
    // Hide all tabs
    tabs.forEach(t => {
        document.getElementById('sec-content-' + t)?.classList.add('hidden');
        const tabBtn = document.getElementById('sec-tab-' + t);
        if (tabBtn) {
            tabBtn.classList.remove('bg-purple-600', 'text-white');
            tabBtn.classList.add('hover:bg-gray-700');
        }
    });
    
    // Show selected tab
    document.getElementById('sec-content-' + tab)?.classList.remove('hidden');
    const activeBtn = document.getElementById('sec-tab-' + tab);
    if (activeBtn) {
        activeBtn.classList.add('bg-purple-600', 'text-white');
        activeBtn.classList.remove('hover:bg-gray-700');
    }
    
    // Load tab data
    if (tab === 'audit') loadAuditLogs();
    if (tab === 'mfa') checkMfaStatus();
    if (tab === 'settings') loadSecuritySettings();
}

// Initialize security page
async function initSecurityPage() {
    // Load data first - roles must be loaded before users to display role names
    await loadSecurityStats();
    await loadSecurityRoles(); // Load roles first
    await loadSecurityUsers(); // Then load users (so role names can be displayed)
    await loadSecurityInvitations();
    
    // Find first visible tab and switch to it
    const tabs = ['users', 'roles', 'audit', 'mfa', 'settings'];
    let foundTab = 'mfa'; // Default fallback
    
    for (const t of tabs) {
        const btn = document.getElementById('sec-tab-' + t);
        if (btn && btn.style.display !== 'none') {
            foundTab = t;
            break;
        }
    }
    
    switchSecurityTab(foundTab);
}

// Load audit logs
async function loadAuditLogs() {
    const action = document.getElementById('sec-audit-action')?.value || '';
    
    try {
        let url = '/api/security/audit-logs?limit=100';
        if (action) url += '&action=' + action;
        
        const res = await fetch(url, { headers: getAuthHeaders() });
        if (!res.ok) return;
        
        const data = await res.json();
        console.log("Login response:", data);
        const logs = data.logs || [];
        
        if (!logs.length) {
            document.getElementById('sec-audit-table').innerHTML = 
                '<tr><td colspan="6" class="p-8 text-center text-gray-500">No audit logs found</td></tr>';
            return;
        }
        
        document.getElementById('sec-audit-table').innerHTML = logs.map(l => `
            <tr class="border-t border-gray-700">
                <td class="p-4 text-sm">${new Date(l.timestamp).toLocaleString()}</td>
                <td class="p-4">${escHtml(l.user_email || 'System')}</td>
                <td class="p-4"><span class="px-2 py-1 rounded text-xs bg-blue-600/30 text-blue-400">${l.action}</span></td>
                <td class="p-4 text-sm">${escHtml(l.resource_type || '-')}</td>
                <td class="p-4 text-sm text-gray-400">${l.ip_address || '-'}</td>
                <td class="p-4 text-center">${l.success ? '<span class="text-green-400"></span>' : '<span class="text-red-400"></span>'}</td>
            </tr>
        `).join('');
    } catch (e) {
        console.error('Error loading audit logs:', e);
    }
}

// Export audit logs
async function exportAuditLogs() {
    showToast('Exporting audit logs...', 'info');
    try {
        const res = await fetch('/api/security/audit-logs/export', { headers: getAuthHeaders() });
        if (!res.ok) throw new Error('Export failed');
        
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'audit-logs-' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Audit logs exported', 'success');
    } catch (e) {
        showToast('Export failed: ' + e.message, 'error');
    }
}

// Check MFA status



function selectMfaMode(mode) {
    document.querySelector(`input[name="mfa-mode"][value="${mode}"]`).checked = true;
    saveMfaSettings();
}

async function saveMfaSettings() {
    const mode = document.querySelector('input[name="mfa-mode"]:checked')?.value || 'off';
    
    try {
        const res = await fetch('/api/security/settings', {
            method: 'PUT',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ mfa_enforcement: mode })
        });
        
        if (res.ok) {
            const status = document.getElementById('mfa-save-status');
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 2000);
            checkMfaStatus();
        } else {
            showToast('Failed to save settings', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function loadMfaAdminSettings() {
    try {
        const res = await fetch('/api/security/settings', { headers: getAuthHeaders() });
        if (!res.ok) return;
        
        const settings = await res.json();
        const mode = settings.mfa_enforcement || 'off';
        
        // Set radio button
        const radio = document.querySelector(`input[name="mfa-mode"][value="${mode}"]`);
        if (radio) radio.checked = true;
    } catch (e) {
        console.error('Error loading MFA settings:', e);
    }
}

async function checkMfaStatus() {
    // Load admin settings if admin
    loadMfaAdminSettings();
    
    try {
        // Get user info
        const userRes = await fetch('/api/security/auth/me', { headers: getAuthHeaders() });
        if (!userRes.ok) return;
        const userData = await userRes.json();
        
        // Get security settings
        const settingsRes = await fetch('/api/security/settings', { headers: getAuthHeaders() });
        const settings = settingsRes.ok ? await settingsRes.json() : {};
        
        const userMfaEnabled = userData.user?.mfa_enabled || false;
        const enforcement = settings.mfa_enforcement || 'off';
        
        // Update status badge
        const badge = document.getElementById('mfa-status-badge');
        const statusText = document.getElementById('mfa-status-text');
        
        if (badge && statusText) {
            if (enforcement === 'off') {
                badge.innerHTML = '<span class="px-3 py-1 rounded-full text-sm bg-gray-600 text-gray-300">Disabled</span>';
                statusText.textContent = 'MFA is turned off for your organization';
            } else if (enforcement === 'optional') {
                badge.innerHTML = userMfaEnabled 
                    ? '<span class="px-3 py-1 rounded-full text-sm bg-green-500/20 text-green-400"> Active</span>'
                    : '<span class="px-3 py-1 rounded-full text-sm bg-yellow-500/20 text-yellow-400">Optional</span>';
                statusText.textContent = userMfaEnabled ? 'MFA is active on your account' : 'MFA is optional - you can enable it below';
            } else if (enforcement === 'admins') {
                badge.innerHTML = '<span class="px-3 py-1 rounded-full text-sm bg-blue-500/20 text-blue-400">Admins Only</span>';
                statusText.textContent = 'MFA is required for administrators';
            } else {
                badge.innerHTML = '<span class="px-3 py-1 rounded-full text-sm bg-green-500/20 text-green-400"> Required</span>';
                statusText.textContent = 'MFA is required for all users';
            }
        }
        
        // Show user toggle only for Optional mode
        const userToggleSection = document.getElementById('mfa-user-toggle-section');
        if (userToggleSection) {
            if (enforcement === 'optional') {
                userToggleSection.classList.remove('hidden');
                const userEnabledCheckbox = document.getElementById('mfa-user-enabled');
                if (userEnabledCheckbox) userEnabledCheckbox.checked = userMfaEnabled;
            } else {
                userToggleSection.classList.add('hidden');
            }
        }
        
    } catch (e) {
        console.error('Error checking MFA status:', e);
    }
}

async function toggleUserMFA() {
    const checkbox = document.getElementById('mfa-user-enabled');
    const newState = checkbox.checked;
    
    try {
        const res = await fetch('/api/security/mfa/user-toggle', {
            method: 'POST',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: newState })
        });
        
        if (res.ok) {
            showToast(newState ? 'MFA enabled for your account' : 'MFA disabled for your account', 'success');
            checkMfaStatus();
        } else {
            const data = await res.json();
            showToast(data.detail || 'Failed to update MFA', 'error');
            checkbox.checked = !newState;
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
        checkbox.checked = !newState;
    }
}

function showInviteModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999]';
    modal.id = 'invite-modal';
    modal.innerHTML = `
        <div class="card rounded-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4"> Invite User</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Email Address</label>
                    <input type="email" id="invite-email" placeholder="user@company.com" class="input-field w-full px-4 py-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Role</label>
                    <select id="invite-role" class="input-field w-full px-4 py-2 rounded-lg">
                        ${securityRoles.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                    </select>
                            
                </div>
                <div class="flex gap-2 pt-4">
                    <button onclick="document.getElementById('invite-modal').remove()" class="btn-secondary px-4 py-2 rounded-lg flex-1">Cancel</button>
                    <button onclick="sendInvite()" class="btn-primary px-4 py-2 rounded-lg flex-1">Send Invite</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Send invite
async function sendInvite() {
    const email = document.getElementById('invite-email')?.value;
    const role = document.getElementById('invite-role')?.value;
    
    if (!email) {
        showToast('Please enter an email', 'error');
        return;
    }
    
    try {
        const res = await fetch('/api/security/users/invite', {
            method: 'POST',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, role_ids: [role] })
        });
        
        if (res.ok) {
            showToast('Invitation sent!', 'success');
            document.getElementById('invite-modal')?.remove();
            loadSecurityUsers();
            loadSecurityStats();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to send invite', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}


// Load security settings into form
async function loadSecuritySettings() {
    try {
        const res = await fetch('/api/security/settings', { headers: getAuthHeaders() });
        if (!res.ok) return;
        
        const settings = await res.json();
        
        // Populate select fields
        const mfaEnforcement = document.getElementById('sec-setting-mfa_enforcement');
        if (mfaEnforcement) mfaEnforcement.value = settings.mfa_enforcement || 'off';
        
        const lockoutAttempts = document.getElementById('sec-setting-lockout_attempts');
        if (lockoutAttempts) lockoutAttempts.value = settings.account_lockout_attempts || 5;
        
        const lockoutDuration = document.getElementById('sec-setting-lockout_duration');
        if (lockoutDuration) lockoutDuration.value = settings.account_lockout_duration_minutes || 30;
        
        // Populate checkboxes
        const mfaOptout = document.getElementById('sec-setting-mfa_allow_user_optout');
        if (mfaOptout) mfaOptout.checked = settings.mfa_allow_user_optout || false;
        
    } catch (e) {
        console.error('Error loading security settings:', e);
    }
}

// Save security settings
async function saveSecuritySettings() {
    const form = document.getElementById('security-settings-form');
    const formData = new FormData(form);
    const settings = {};
    
    for (const [key, value] of formData.entries()) {
        settings[key] = value;
    }
    
    // Handle checkboxes
    form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        settings[cb.name] = cb.checked;
    });
    
    try {
        const res = await fetch('/api/security/settings', {
            method: 'PUT',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        if (res.ok) {
            showToast('Settings saved!', 'success');
        } else {
            showToast('Failed to save settings', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

// Toast notification
function showToast(message, type = 'info') {
    const colors = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-600', info: 'bg-blue-600' };
    const icons = { success: '', error: '', warning: '', info: '' };
    
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-[9999] px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 ${colors[type] || colors.info} text-white animate-fade-in`;
    toast.innerHTML = `<span>${icons[type] || icons.info}</span><span>${escHtml(message)}</span>`;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Update navigate function to include security
const originalNavigate = navigate;
navigate = function(p, updateHash = true) {
    // Check auth for protected pages
    if (!authToken && p !== 'login') {
        showLoginPage();
        return;
    }
    
    // Hide login if showing app
    if (authToken && p !== 'login') {
        document.getElementById('page-login')?.classList.add('hidden');
        document.getElementById('app')?.classList.remove('hidden');
    }
    
    // Call original navigate
    originalNavigate(p, updateHash);
    
    // Initialize security page
    if (p === 'security') {
        initSecurityPage();
    }
};

// Handle reset password page
function showSpecialPage() {
    document.getElementById('loading-screen')?.classList.add('hidden');
    document.getElementById('page-login').classList.add('visible');
    document.getElementById('app').classList.add('hidden');
}

function showResetPasswordPage(token) {
    showSpecialPage();
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
            <p class="text-gray-400">Create new password</p>
        </div>
        <div class="card rounded-2xl p-8">
            <h2 class="text-xl font-bold mb-6">Reset Password</h2>
            
            <form onsubmit="handleResetPassword(event, '${token}')">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">New Password</label>
                        <div class="relative">
                            <input type="password" id="reset-password" required minlength="8"
                                   class="input-field w-full px-4 py-3 pr-12 rounded-lg"
                                   placeholder="Min 8 characters"
                                   oninput="checkPasswordStrength(this.value)">
                            <button type="button" onclick="togglePassword('reset-password', this)" 
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1">
                                <span class="eye-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>
                            </button>
                        </div>
                        <div class="mt-2">
                            <div class="flex gap-1 mb-1">
                                <div id="str-1" class="h-1 flex-1 rounded bg-gray-600"></div>
                                <div id="str-2" class="h-1 flex-1 rounded bg-gray-600"></div>
                                <div id="str-3" class="h-1 flex-1 rounded bg-gray-600"></div>
                                <div id="str-4" class="h-1 flex-1 rounded bg-gray-600"></div>
                            </div>
                            <p id="str-text" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Confirm Password</label>
                        <div class="relative">
                            <input type="password" id="reset-password2" required
                                   class="input-field w-full px-4 py-3 pr-12 rounded-lg"
                                   placeholder="Repeat password">
                            <button type="button" onclick="togglePassword('reset-password2', this)" 
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1">
                                <span class="eye-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" id="reset-btn"
                            class="btn-primary w-full py-3 rounded-lg font-semibold">
                        Reset Password
                    </button>
                </div>
            </form>
        </div>
    `;
}

// Handle reset password submit
async function handleResetPassword(event, token) {
    event.preventDefault();
    
    const password = document.getElementById('reset-password').value;
    const password2 = document.getElementById('reset-password2').value;
    
    if (password !== password2) {
        showToast('Passwords do not match', 'error');
        return;
    }
    
    if (password.length < 8) {
        showToast('Password must be at least 8 characters', 'error');
        return;
    }
    
    const btn = document.getElementById('reset-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin inline-block"></span> Resetting...';
    
    try {
        const res = await fetch('/api/security/auth/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, new_password: password })
        });
        
        const data = await res.json();
        console.log("Login response:", data);
        
        if (res.ok) {
            showResetPasswordSuccess();
        } else {
            showToast(data.detail || 'Reset failed. Link may have expired.', 'error');
            btn.disabled = false;
            btn.textContent = 'Reset Password';
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Reset Password';
    }
}

// Show reset password success
function showResetPasswordSuccess() {
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
        </div>
        <div class="card rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h2 class="text-xl font-bold mb-2">Password Reset!</h2>
            <p class="text-gray-400 mb-6">
                Your password has been reset successfully.<br>
                You can now sign in with your new password.
            </p>
            <button onclick="window.location.href='/ui/'" class="btn-primary w-full py-3 rounded-lg font-semibold">
                Sign In Now
            </button>
        </div>
    `;
}

// Handle email verification page
function showVerifyEmailPage(token) {
    showSpecialPage();
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
        </div>
        <div class="card rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="animate-spin text-2xl"></span>
            </div>
            <h2 class="text-xl font-bold mb-2">Verifying Email...</h2>
            <p class="text-gray-400">Please wait while we verify your email.</p>
        </div>
    `;
    
    // Call verify API
    verifyEmail(token);
}

// Verify email API call
async function verifyEmail(token) {
    try {
        const res = await fetch('/api/security/auth/verify-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
        });
        
        if (res.ok) {
            showVerifyEmailSuccess();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showVerifyEmailError(data.detail || 'Verification failed');
        }
    } catch (e) {
        showVerifyEmailError('Error verifying email');
    }
}

// Show verification success
function showVerifyEmailSuccess() {
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
        </div>
        <div class="card rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h2 class="text-xl font-bold mb-2">Email Verified!</h2>
            <p class="text-gray-400 mb-6">
                Your email has been verified successfully.<br>
                You can now sign in to your account.
            </p>
            <button onclick="window.location.href='/ui/'" class="btn-primary w-full py-3 rounded-lg font-semibold">
                Sign In Now
            </button>
        </div>
    `;
}

// Show verification error
function showVerifyEmailError(message) {
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
        </div>
        <div class="card rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </div>
            <h2 class="text-xl font-bold mb-2">Verification Failed</h2>
            <p class="text-gray-400 mb-6">${message}</p>
            <button onclick="location.reload()" class="btn-primary w-full py-3 rounded-lg font-semibold">
                Back to Sign In
            </button>
        </div>
    `;
}


// Show invitation register form
function showInvitationRegister(token) {
    showSpecialPage();
    document.getElementById('page-login').classList.remove('hidden');
    document.getElementById('app').classList.add('hidden');
    
    var eyeIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>';
    
    document.getElementById('auth-container').innerHTML = 
        '<div class="text-center mb-8">' +
            '<div class="inline-flex items-center gap-3 mb-4">' +
                '<img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">' +
                '<h1 class="text-3xl font-bold gradient-text">AgentForge</h1>' +
            '</div>' +
            '<p class="text-gray-400">Complete your registration</p>' +
        '</div>' +
        '<div class="card rounded-2xl p-8">' +
            '<h2 class="text-xl font-bold mb-6">Accept Invitation</h2>' +
            '<form onsubmit="handleInvitationRegister(event, \'' + token + '\')">' +
                '<div class="space-y-4">' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div><label class="block text-sm text-gray-400 mb-2">First Name</label>' +
                        '<input type="text" id="inv-firstname" required class="input-field w-full px-4 py-3 rounded-lg" placeholder="John"></div>' +
                        '<div><label class="block text-sm text-gray-400 mb-2">Last Name</label>' +
                        '<input type="text" id="inv-lastname" required class="input-field w-full px-4 py-3 rounded-lg" placeholder="Doe"></div>' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-sm text-gray-400 mb-2">Password</label>' +
                        '<div class="relative">' +
                            '<input type="password" id="inv-password" required minlength="8" class="input-field w-full px-4 py-3 pr-12 rounded-lg" placeholder="Min 8 characters" oninput="checkPasswordStrength(this.value)">' +
                            '<button type="button" onclick="togglePassword(\'inv-password\', this)" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1"><span class="eye-icon">' + eyeIcon + '</span></button>' +
                        '</div>' +
                        '<div class="mt-2"><div class="flex gap-1 mb-1"><div id="str-1" class="h-1 flex-1 rounded bg-gray-600"></div><div id="str-2" class="h-1 flex-1 rounded bg-gray-600"></div><div id="str-3" class="h-1 flex-1 rounded bg-gray-600"></div><div id="str-4" class="h-1 flex-1 rounded bg-gray-600"></div></div><p id="str-text" class="text-xs text-gray-500"></p></div>' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-sm text-gray-400 mb-2">Confirm Password</label>' +
                        '<div class="relative">' +
                            '<input type="password" id="inv-confirm-password" required minlength="8" class="input-field w-full px-4 py-3 pr-12 rounded-lg" placeholder="Confirm password">' +
                            '<button type="button" onclick="togglePassword(\'inv-confirm-password\', this)" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1"><span class="eye-icon">' + eyeIcon + '</span></button>' +
                        '</div>' +
                    '</div>' +
                    '<div id="inv-error" class="hidden bg-red-500/20 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg text-sm"></div>' +
                    '<button type="submit" id="inv-submit-btn" class="w-full py-3 rounded-lg font-semibold text-white" style="background: var(--accent-gradient);">Create Account</button>' +
                '</div>' +
            '</form>' +
        '</div>';
}

// Handle invitation register
async function handleInvitationRegister(event, token) {
    event.preventDefault();
    var firstName = document.getElementById('inv-firstname').value;
    var lastName = document.getElementById('inv-lastname').value;
    var password = document.getElementById('inv-password').value;
    var confirmPassword = document.getElementById('inv-confirm-password').value;
    var errorDiv = document.getElementById('inv-error');
    var btn = document.getElementById('inv-submit-btn');
    errorDiv.classList.add('hidden');
    if (password !== confirmPassword) { 
        errorDiv.textContent = 'Passwords do not match'; 
        errorDiv.classList.remove('hidden'); 
        return; 
    }
    btn.disabled = true; 
    btn.textContent = 'Creating account...';
    try {
        var res = await fetch('/api/security/auth/accept-invitation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                token: token,
                first_name: firstName, 
                last_name: lastName, 
                password: password 
            })
        });
        var data = await res.json();
        if (!res.ok) { 
            errorDiv.textContent = data.detail || 'Registration failed'; 
            errorDiv.classList.remove('hidden'); 
            btn.disabled = false; 
            btn.textContent = 'Create Account'; 
            return; 
        }
        showToast('Account created! Please sign in.', 'success');
        window.location.hash = '';
        location.reload();
    } catch (e) { 
        errorDiv.textContent = 'Error: ' + e.message; 
        errorDiv.classList.remove('hidden'); 
    }
    btn.disabled = false; 
    btn.textContent = 'Create Account';
}

// ============================================================================
// Profile Page Functions
// ============================================================================

let currentUserProfile = null;

async function loadProfileInfo() {
    try {
        const res = await fetch(API + '/api/security/auth/me', {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (!res.ok) {
            throw new Error('Failed to load profile');
        }
        
        const data = await res.json();
        currentUserProfile = data;
        
        // Update profile info display
        document.getElementById('profile-name').textContent = data.name || 'N/A';
        document.getElementById('profile-email').textContent = data.email || 'N/A';
        document.getElementById('profile-role').textContent = data.roles?.map(r => r.name).join(', ') || 'N/A';
        
        // Format created date
        if (data.profile?.created_at) {
            const date = new Date(data.profile.created_at);
            document.getElementById('profile-created').textContent = date.toLocaleDateString();
        } else {
            document.getElementById('profile-created').textContent = 'N/A';
        }
        
        // Populate edit form
        document.getElementById('update-first-name').value = data.profile?.first_name || '';
        document.getElementById('update-last-name').value = data.profile?.last_name || '';
        document.getElementById('update-display-name').value = data.profile?.display_name || '';
        
        // Update MFA status
        updateMFAStatus(data);
        
    } catch (error) {
        console.error('Error loading profile:', error);
        showToast('Failed to load profile information', 'error');
    }
}

function updateMFAStatus(userData) {
    const mfaEnabled = userData.mfa?.enabled || false;
    const mfaMethod = userData.mfa?.method || 'none';
    
    const statusText = document.getElementById('mfa-status-text');
    const statusBadge = document.getElementById('mfa-status-badge');
    const enabledSection = document.getElementById('mfa-enabled-section');
    const disabledSection = document.getElementById('mfa-disabled-section');
    
    if (mfaEnabled) {
        statusText.textContent = `Enabled (${mfaMethod.toUpperCase()})`;
        statusBadge.innerHTML = '<span class="px-3 py-1 bg-green-600 text-white text-sm rounded-full">Enabled</span>';
        enabledSection.classList.remove('hidden');
        disabledSection.classList.add('hidden');
    } else {
        statusText.textContent = 'Disabled';
        statusBadge.innerHTML = '<span class="px-3 py-1 bg-gray-600 text-white text-sm rounded-full">Disabled</span>';
        enabledSection.classList.add('hidden');
        disabledSection.classList.remove('hidden');
    }
}

// Update Profile Form Handler
document.getElementById('update-profile-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const firstName = document.getElementById('update-first-name').value.trim();
    const lastName = document.getElementById('update-last-name').value.trim();
    const displayName = document.getElementById('update-display-name').value.trim();
    
    try {
        const res = await fetch(API + `/api/security/users/${currentUserProfile.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                first_name: firstName,
                last_name: lastName,
                display_name: displayName
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Failed to update profile');
        }
        
        showToast('Profile updated successfully', 'success');
        await loadProfileInfo();
        await fetchCurrentUser(); // Refresh user info in sidebar
        
    } catch (error) {
        console.error('Error updating profile:', error);
        showToast(error.message || 'Failed to update profile', 'error');
    }
});

// Change Password Form Handler
document.getElementById('change-password-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    // Validate passwords match
    if (newPassword !== confirmPassword) {
        showToast('New passwords do not match', 'error');
        return;
    }
    
    // Validate password strength
    if (newPassword.length < 8) {
        showToast('Password must be at least 8 characters long', 'error');
        return;
    }
    
    try {
        const res = await fetch(API + '/api/security/auth/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Failed to change password');
        }
        
        showToast('Password changed successfully', 'success');
        
        // Clear form
        document.getElementById('change-password-form').reset();
        
    } catch (error) {
        console.error('Error changing password:', error);
        showToast(error.message || 'Failed to change password', 'error');
    }
});

// MFA Functions
async function startMFASetup() {
    const selectedType = document.querySelector('input[name="mfa-type"]:checked').value;
    
    try {
        const res = await fetch(API + '/api/security/mfa/enable', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                method: selectedType
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Failed to start MFA setup');
        }
        
        const data = await res.json();
        
        if (selectedType === 'totp') {
            showTOTPSetup(data);
        } else if (selectedType === 'email') {
            showEmailSetup();
        }
        
    } catch (error) {
        console.error('Error starting MFA setup:', error);
        showToast(error.message || 'Failed to start MFA setup', 'error');
    }
}

function showTOTPSetup(data) {
    // Show modal with TOTP setup
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">Setup Authenticator App</h3>
            <div class="text-center mb-4">
                <p class="text-sm text-gray-400 mb-4">Scan this QR code with your authenticator app</p>
                <div id="modal-qr-code" class="flex justify-center mb-4 bg-white p-4 rounded-lg"></div>
                <p class="text-xs text-gray-500 mb-2">Or enter this key manually:</p>
                <code class="bg-gray-700 px-3 py-1 rounded text-sm block">${data.secret}</code>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">Verification Code</label>
                <input type="text" id="modal-totp-code" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center text-lg tracking-wider" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
            </div>
            <div class="flex gap-3">
                <button onclick="closeMFAModal()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                <button onclick="verifyTOTPSetupModal('${data.secret}')" class="btn-primary flex-1 py-2 rounded-lg">Verify & Enable</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.id = 'mfa-setup-modal';
    
    // Generate QR code
    if (data.qr_code) {
        document.getElementById('modal-qr-code').innerHTML = `<img src="${data.qr_code}" alt="QR Code" class="w-48 h-48">`;
    }
}

function showEmailSetup() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">Verify Email MFA</h3>
            <div class="text-center mb-4">
                <p class="text-sm text-gray-400 mb-4">A verification code has been sent to your email</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">Verification Code</label>
                <input type="text" id="modal-email-code" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center text-lg tracking-wider" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
            </div>
            <div class="flex gap-3">
                <button onclick="closeMFAModal()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                <button onclick="verifyEmailSetupModal()" class="btn-primary flex-1 py-2 rounded-lg">Verify & Enable</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.id = 'mfa-setup-modal';
}

function closeMFAModal() {
    const modal = document.getElementById('mfa-setup-modal');
    if (modal) {
        modal.remove();
    }
}

async function verifyTOTPSetupModal(secret) {
    const code = document.getElementById('modal-totp-code').value;
    
    if (!code || code.length !== 6) {
        showToast('Please enter a 6-digit code', 'error');
        return;
    }
    
    try {
        const res = await fetch(API + '/api/security/mfa/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                code: code,
                method: 'totp'
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Invalid verification code');
        }
        
        showToast('MFA enabled successfully!', 'success');
        closeMFAModal();
        await loadProfileInfo();
        
    } catch (error) {
        console.error('Error verifying TOTP:', error);
        showToast(error.message || 'Failed to verify code', 'error');
    }
}

async function verifyEmailSetupModal() {
    const code = document.getElementById('modal-email-code').value;
    
    if (!code || code.length !== 6) {
        showToast('Please enter a 6-digit code', 'error');
        return;
    }
    
    try {
        const res = await fetch(API + '/api/security/mfa/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                code: code,
                method: 'email'
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Invalid verification code');
        }
        
        showToast('Email MFA enabled successfully!', 'success');
        closeMFAModal();
        await loadProfileInfo();
        
    } catch (error) {
        console.error('Error verifying email code:', error);
        showToast(error.message || 'Failed to verify code', 'error');
    }
}

// Toggle password visibility
function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(inputId + '-icon');
    
    if (input.type === 'password') {
        input.type = 'text';
        // Eye open icon (showing password)
        icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        </svg>`;
    } else {
        input.type = 'password';
        // Eye closed icon (hiding password)
        icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
        </svg>`;
    }
}

async function disableMFA() {
    const confirmed = confirm('Are you sure you want to disable MFA? This will make your account less secure.');
    
    if (!confirmed) return;
    
    // Ask for password confirmation
    const password = prompt('Please enter your password to confirm:');
    
    if (!password) return;
    
    try {
        const res = await fetch(API + '/api/security/mfa/disable', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                password: password
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Failed to disable MFA');
        }
        
        showToast('MFA disabled successfully', 'success');
        await loadProfileInfo();
        
    } catch (error) {
        console.error('Error disabling MFA:', error);
        showToast(error.message || 'Failed to disable MFA', 'error');
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    
    // Get token from localStorage FIRST
    authToken = localStorage.getItem('agentforge_token');
    const savedUser = localStorage.getItem('agentforge_user');
    if (savedUser) {
        try { currentUser = JSON.parse(savedUser); } catch(e) {}
    }
    
    // Fallback to sessionStorage
    if (!authToken) {
        authToken = sessionStorage.getItem('agentforge_token');
        const sessionUser = sessionStorage.getItem('agentforge_user');
        if (sessionUser) {
            try { currentUser = JSON.parse(sessionUser); } catch(e) {}
        }
    }
    
    // Handle special PUBLIC pages (no auth required)
    if (hash) {
        // Reset password page
        if (hash.includes('reset-password')) {
            const params = new URLSearchParams(hash.split('?')[1]);
            const token = params.get('token');
            if (token) {
                showResetPasswordPage(token);
                return;
            }
        }
        
        // Invitation register page
        if (hash.includes('register')) {
            const params = new URLSearchParams(hash.split('?')[1]);
            const token = params.get('token');
            if (token) {
                showInvitationRegister(token);
                return;
            }
        }
        
        // Verify email page
        if (hash.includes('verify-email')) {
            const params = new URLSearchParams(hash.split('?')[1]);
            const token = params.get('token');
            if (token) {
                showVerifyEmailPage(token);
                return;
            }
        }
    }
    
    // Normal auth flow
    checkAuth();
});

    </script>

<!-- Tool Edit Slide-over Panel -->
<div id="tool-edit-panel" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/60" onclick="closeToolEditPanel()"></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-2xl bg-gray-900 shadow-2xl transform transition-transform duration-300 translate-x-full" id="tool-edit-slider">
        <div class="flex flex-col h-full">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <span id="edit-panel-icon" class="text-2xl"></span>
                    <div>
                        <h2 class="font-bold text-lg">Edit Tool</h2>
                        <p id="edit-panel-type" class="text-xs text-gray-400">KNOWLEDGE BASE</p>
                    </div>
                </div>
                <button onclick="closeToolEditPanel()" class="p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b border-gray-700">
                <button onclick="switchEditTab('basic')" class="edit-tab active flex-1 px-4 py-3 text-sm font-medium border-b-2 border-purple-500 text-purple-400" data-tab="basic">Basic Info</button>
                <button onclick="switchEditTab('config')" class="edit-tab flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="config">Configuration</button>
                <button onclick="switchEditTab('sources')" class="edit-tab flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="sources">Sources</button>
            </div>
            
            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4">
                <input type="hidden" id="edit-tool-id">
                <input type="hidden" id="edit-tool-type">
                
                <!-- Basic Info Tab -->
                <div id="edit-tab-basic" class="edit-tab-content space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Name *</label>
                        <input type="text" id="edit-tool-name" class="input-field w-full px-4 py-2 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Description</label>
                        <textarea id="edit-tool-desc" rows="3" class="input-field w-full px-4 py-2 rounded-lg"></textarea>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="edit-tool-active" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-700 peer-focus:ring-2 peer-focus:ring-purple-500 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                        <span class="text-sm">Active</span>
                    </div>
                </div>
                
                <!-- Configuration Tab -->
                <div id="edit-tab-config" class="edit-tab-content hidden space-y-4">
                    <div id="edit-config-content">
                        <!-- Dynamic config fields will be inserted here -->
                    </div>
                </div>
                
                <!-- Sources Tab -->
                <div id="edit-tab-sources" class="edit-tab-content hidden space-y-4">
                    <div id="edit-sources-content">
                        <!-- Dynamic sources will be shown here -->
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="flex items-center justify-end gap-3 p-4 border-t border-gray-700">
                <button onclick="closeToolEditPanel()" class="btn-secondary px-6 py-2 rounded-lg">Cancel</button>
                <button onclick="saveToolChanges()" class="btn-primary px-6 py-2 rounded-lg">Save Changes</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>

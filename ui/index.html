<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentForge - AI Agent Builder</title>
    <link rel="icon" type="image/png" href="/AgentForge_Logo.png">
    <link rel="stylesheet" href="/ui/theme.css">
    <script src="/ui/theme.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        /* Theme variables live in theme.css (single source of truth) */
        *{font-family:'Inter',sans-serif;box-sizing:border-box}
        html,body{height:100%;margin:0;padding:0;overflow:hidden;max-width:100vw;background:var(--bg-primary);color:var(--text-primary)}
        .gradient-bg{background:var(--accent-gradient)}
        .gradient-text{background:var(--accent-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .sidebar-item.active{background:var(--sidebar-active);border-left:3px solid var(--accent-primary)}
        .card{background:var(--bg-card);border:1px solid var(--border-color);overflow:hidden;box-sizing:border-box}
        .input-field{background:var(--bg-input);border:1px solid var(--border-color);color:var(--text-primary)}
        .input-field:focus{border-color:var(--accent-primary);outline:none}
        .input-field::placeholder{color:var(--text-muted)}
        
        /* Fix select/dropdown styling for all themes */
        select.input-field{appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");background-position:right 0.5rem center;background-repeat:no-repeat;background-size:1.5em 1.5em;padding-right:2.5rem}
        select.input-field option{background:var(--bg-card);color:var(--text-primary);padding:8px}
        select.input-field optgroup{background:var(--bg-sidebar);color:var(--text-secondary);font-weight:600}
        .btn-primary{background:var(--accent-gradient);color:#ffffff}
        .btn-secondary{background:var(--bg-input);color:var(--text-primary)}
        .btn-success{background:var(--success);color:#ffffff}
        .btn-danger{background:var(--danger);color:#ffffff}
        .step-active{background:var(--accent-primary);color:white}
        .step-done{background:var(--success);color:white}
        .step-pending{background:var(--bg-input);color:var(--text-muted)}
        
        /* New Wizard Progress Styles */
        .wizard-progress-step{display:flex;flex-direction:column;align-items:center;gap:4px}
        .wizard-step-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;background:#374151;color:#9ca3af;border:2px solid transparent}
        .wizard-step-dot:hover{background:#4b5563}
        .wizard-step-dot.active{background:#3b82f6;color:white;border-color:#3b82f6}
        .wizard-step-dot.completed{background:#10b981;color:white;border-color:#10b981}
        .wizard-step-dot.clickable{background:#4b5563;color:#e5e7eb;cursor:pointer}
        .wizard-step-dot.clickable:hover{background:#6b7280;border-color:#9ca3af}
        .wizard-step-label{font-size:10px;color:#9ca3af;white-space:nowrap}
        .wizard-progress-line{flex:1;height:2px;background:#374151;min-width:20px;max-width:60px}
        .wizard-progress-line.completed{background:#10b981}
        .drop-zone{border:2px dashed var(--border-color);transition:all 0.3s}
        .drop-zone.dragover{border-color:var(--accent-primary);background:rgba(139,92,246,0.1)}
        .modal-backdrop{background:rgba(0,0,0,0.8);backdrop-filter:blur(4px)}
        .status-ready{color:var(--success)}
        .status-processing{color:var(--warning)}
        .status-error{color:var(--danger)}
        .status-pending{color:var(--warning)}
        .status-processed{color:var(--success)}
        .status-draft{background:var(--warning);color:#000}
        .status-published{background:var(--success);color:#000}
        .chat-content h1,.chat-content h2,.chat-content h3{font-weight:600;margin:1rem 0 0.5rem 0;color:var(--text-primary)}
        .chat-content h1{font-size:1.25rem}
        .chat-content h2{font-size:1.125rem}
        .chat-content h3{font-size:1rem;color:var(--accent-primary)}
        .chat-content p{margin:0.5rem 0;line-height:1.6}
        .chat-content ul,.chat-content ol{margin:0.5rem 0;padding-left:1.5rem}
        .chat-content li{margin:0.25rem 0}
        .chat-content strong{color:var(--accent-primary);font-weight:600}
        .chat-content code{background:var(--bg-secondary);padding:0.125rem 0.375rem;border-radius:0.25rem;font-family:monospace;color:var(--success);font-size:0.875rem}
        .chat-content pre{background:var(--bg-secondary);padding:1rem;border-radius:0.5rem;overflow-x:auto;margin:0.5rem 0}
        .chat-content pre code{background:none;padding:0}
        .chat-content blockquote{border-left:3px solid var(--accent-primary);padding-left:1rem;margin:0.5rem 0;color:var(--text-secondary)}
        /* Professional table styling */
        .chat-content .table-container{overflow-x:auto;margin:0.75rem 0;border-radius:0.5rem;border:1px solid var(--border-color)}
        .chat-content table{width:100%;border-collapse:collapse;font-size:0.8rem;min-width:max-content;background:var(--bg-card)}
        
        /* ===== CHAT UI - Using Theme Variables ===== */
        
        /* Chat Page Layout */
        .chat-page{display:flex;height:100%;max-height:100%;min-height:0;background:var(--bg-primary);position:relative;overflow:hidden}
        
        /* Chat Sidebar - Compact */
        .chat-sidebar{background:var(--bg-secondary);border-right:1px solid var(--border-color);display:flex;flex-direction:column;width:280px;flex-shrink:0;height:100%;max-height:100%;overflow:hidden}
        
        /* Agent Selector */
        .agent-selector{padding:12px;border-bottom:1px solid var(--border-color)}
        .agent-selector select{width:100%;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;padding:10px 12px;color:var(--text-primary);font-size:0.875rem;cursor:pointer}
        .agent-selector select:focus{outline:none;border-color:var(--accent-primary)}
        
        /* Conversations Header */
        .conv-header{padding:10px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color)}
        .conv-header-title{font-size:0.75rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em}
        .conv-header-actions{display:flex;gap:6px}
        .conv-btn-new{background:var(--accent-primary);border:none;padding:6px 12px;border-radius:6px;font-size:0.75rem;font-weight:600;color:#fff;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:4px}
        .conv-btn-new:hover{opacity:0.9}
        .conv-btn-edit{background:transparent;border:1px solid var(--border-color);padding:6px 10px;border-radius:6px;font-size:0.75rem;color:var(--text-secondary);cursor:pointer;transition:all 0.2s}
        .conv-btn-edit:hover{background:var(--bg-tertiary);color:var(--text-primary)}
        .conv-btn-edit.active{background:var(--accent-primary);border-color:var(--accent-primary);color:#fff}
        
        /* Selection Bar */
        .conv-selection-bar{padding:8px 12px;background:rgba(239,68,68,0.1);border-bottom:1px solid rgba(239,68,68,0.2);display:flex;justify-content:space-between;align-items:center}
        .conv-select-all{background:transparent;border:none;padding:4px 8px;border-radius:4px;font-size:0.75rem;color:var(--text-secondary);cursor:pointer}
        .conv-select-all:hover{background:var(--bg-tertiary);color:var(--text-primary)}
        .conv-delete-btn{background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.3);padding:4px 10px;border-radius:4px;font-size:0.75rem;color:#fca5a5;cursor:pointer}
        .conv-delete-btn:hover:not(:disabled){background:#ef4444;color:#fff}
        .conv-delete-btn:disabled{opacity:0.4;cursor:not-allowed}
        
        /* Conversation List */
        .conv-list{flex:1;overflow-y:auto;padding:8px;min-height:0;-webkit-overflow-scrolling:touch}
        .conv-list::-webkit-scrollbar{width:4px}
        .conv-list::-webkit-scrollbar-track{background:transparent}
        .conv-list::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:2px}
        
        /* Conversation Item */
        .conv-item{padding:10px 12px;border-radius:8px;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:10px;color:var(--text-secondary);margin-bottom:4px;border:1px solid transparent}
        .conv-item:hover{background:var(--bg-tertiary)}
        .conv-item.active{background:var(--accent-primary);color:#fff}
        .conv-item.selected{background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3)}
        
        /* Checkbox */
        .conv-checkbox{width:18px;height:18px;border-radius:4px;border:2px solid var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s}
        .conv-checkbox.checked{background:#ef4444;border-color:#ef4444}
        .conv-checkbox.checked::after{content:'âœ“';color:white;font-size:11px;font-weight:bold}
        
        /* Conversation Icon */
        .conv-icon{width:32px;height:32px;border-radius:8px;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.875rem}
        .conv-item.active .conv-icon{background:rgba(255,255,255,0.2)}
        
        /* Conversation Content */
        .conv-content{flex:1;min-width:0}
        .conv-title{font-size:0.8125rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .conv-time{font-size:0.6875rem;color:var(--text-muted)}
        .conv-item.active .conv-time{color:rgba(255,255,255,0.7)}
        
        /* Empty State */
        .conv-empty{text-align:center;padding:30px 16px;color:var(--text-muted)}
        .conv-empty-icon{font-size:2rem;margin-bottom:8px;opacity:0.5}
        .conv-empty-text{font-size:0.8125rem}
        
        /* ===== MAIN CHAT AREA ===== */
        .chat-main{flex:1;display:flex;flex-direction:column;min-width:0;min-height:0;height:100%;background:var(--bg-primary)}
        
        /* Desktop Chat Header */
        .chat-header{padding:16px 20px;border-bottom:1px solid var(--border-color);background:var(--bg-secondary);display:none}
        @media(min-width:768px){.chat-header{display:flex;align-items:center;gap:12px}}
        .chat-header-avatar{width:40px;height:40px;border-radius:10px;background:var(--accent-primary);display:flex;align-items:center;justify-content:center;font-size:1.125rem}
        .chat-header-info h3{font-size:0.9375rem;font-weight:600;color:var(--text-primary);margin-bottom:2px}
        .chat-header-info p{font-size:0.75rem;color:var(--text-muted)}
        .chat-header-status{width:8px;height:8px;border-radius:50%;background:#22c55e;margin-left:8px}
        
        /* Mobile Header */
        .chat-mobile-header{padding:12px 16px;border-bottom:1px solid var(--border-color);background:var(--bg-secondary);display:flex;gap:10px;align-items:center}
        @media(min-width:768px){.chat-mobile-header{display:none}}
        .chat-mobile-header select{flex:1;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;padding:10px 12px;color:var(--text-primary);font-size:0.875rem}
        .chat-mobile-toggle{width:40px;height:40px;border-radius:8px;background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-secondary);display:flex;align-items:center;justify-content:center;cursor:pointer}
        .chat-mobile-toggle:hover{background:var(--bg-card);color:var(--text-primary)}
        
        /* Messages Container */
        .chat-messages-container{flex:1;overflow-y:auto;padding:20px;-webkit-overflow-scrolling:touch;min-height:0}
        .chat-messages-container::-webkit-scrollbar{width:6px}
        .chat-messages-container::-webkit-scrollbar-track{background:transparent}
        .chat-messages-container::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}
        
        /* Message Bubbles */
        .msg-row{display:flex;margin-bottom:12px;animation:msgSlide 0.25s ease-out}
        @keyframes msgSlide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .msg-row.user{justify-content:flex-end}
        .msg-row.assistant{justify-content:flex-start}
        
        .msg-bubble{max-width:70%;padding:12px 16px;border-radius:16px;font-size:0.875rem;line-height:1.6}
        .msg-bubble.user{background:var(--accent-primary);color:#fff;border-bottom-right-radius:4px}
        .msg-bubble.assistant{background:var(--bg-secondary);color:var(--text-primary);border-bottom-left-radius:4px;border:1px solid var(--border-color)}
        
        /* Assistant Avatar */
        .msg-avatar{width:28px;height:28px;border-radius:8px;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;margin-right:10px;flex-shrink:0;font-size:0.8125rem}
        
        /* Thinking Indicator */
        .thinking-bubble{background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-secondary);font-style:italic}
        .thinking-dot{width:6px;height:6px;border-radius:50%;background:var(--accent-primary);animation:pulse 1.5s ease-in-out infinite}
        @keyframes pulse{0%,100%{opacity:0.3;transform:scale(0.8)}50%{opacity:1;transform:scale(1)}}
        
        /* Welcome State */
        .chat-welcome{text-align:center;padding:40px 20px;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%}
        .chat-welcome-icon{width:64px;height:64px;margin-bottom:20px;border-radius:16px;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:center;font-size:2rem}
        .chat-welcome h2{font-size:1.25rem;font-weight:600;color:var(--text-primary);margin-bottom:6px}
        .chat-welcome p{font-size:0.875rem;color:var(--text-muted);max-width:320px}
        
        /* ===== INPUT AREA ===== */
        .chat-input-area{padding:16px 20px;border-top:1px solid var(--border-color);background:var(--bg-secondary);flex-shrink:0}
        .chat-input-wrapper{display:flex;gap:10px;align-items:flex-end}
        
        /* Attach Button */
        .chat-attach-btn{width:44px;height:44px;border-radius:10px;background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-secondary);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.15s;flex-shrink:0;font-size:1.125rem}
        .chat-attach-btn:hover{background:var(--bg-card);color:var(--text-primary)}
        
        /* Input Field */
        .chat-input-field{flex:1;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:12px;padding:12px 16px;color:var(--text-primary);font-size:0.875rem;transition:all 0.15s}
        .chat-input-field::placeholder{color:var(--text-muted)}
        .chat-input-field:focus{outline:none;border-color:var(--accent-primary)}
        
        /* Send Button */
        .chat-send-btn{height:44px;padding:0 20px;border-radius:10px;background:var(--accent-primary);border:none;color:#fff;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:6px;flex-shrink:0}
        .chat-send-btn:hover{opacity:0.9}
        .chat-send-btn svg{width:16px;height:16px}
        
        /* Attachments Preview */
        .chat-attachments-preview{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
        .chat-attachment-chip{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;font-size:0.75rem;color:var(--text-secondary)}
        .chat-attachment-remove{width:16px;height:16px;border-radius:50%;background:var(--bg-card);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:10px}
        .chat-attachment-remove:hover{background:rgba(239,68,68,0.2);color:#f87171}
        .chat-content th{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary,#6366f1));color:white;padding:0.625rem 0.75rem;text-align:left;font-weight:600;white-space:nowrap;border:none;text-transform:uppercase;font-size:0.7rem;letter-spacing:0.025em}
        .chat-content td{padding:0.5rem 0.75rem;border-bottom:1px solid var(--border-color);color:var(--text-primary);vertical-align:top;word-break:break-word}
        .chat-content tr:last-child td{border-bottom:none}
        .chat-content tbody tr{transition:background 0.15s ease}
        .chat-content tbody tr:nth-child(even){background:rgba(139,92,246,0.05)}
        .chat-content tbody tr:hover{background:rgba(139,92,246,0.1)}
        
        /* Ensure white text on dark backgrounds */
        .bg-gray-700, .bg-gray-800, .bg-gray-900,
        .bg-purple-400, .bg-purple-500, .bg-purple-600, .bg-purple-700, .bg-purple-800, .bg-purple-900,
        .bg-blue-500, .bg-blue-600, .bg-blue-700, .bg-blue-800, .bg-blue-900,
        .bg-indigo-500, .bg-indigo-600, .bg-indigo-700, .bg-indigo-800, .bg-indigo-900,
        .bg-violet-500, .bg-violet-600, .bg-violet-700, .bg-violet-800, .bg-violet-900 {
            color: white !important;
        }
        
        /* Gradient backgrounds always have white text */
        .bg-gradient-to-r, .bg-gradient-to-l, .bg-gradient-to-t, .bg-gradient-to-b,
        .bg-gradient-to-br, .bg-gradient-to-bl, .bg-gradient-to-tr, .bg-gradient-to-tl,
        [class*="from-purple"], [class*="from-blue"], [class*="from-indigo"], [class*="from-violet"] {
            color: white !important;
        }
        
        .source-badge{background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.4)}
        .animate-fade-in, .animate-fadeIn{animation:fadeIn 0.3s ease-out}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        
        /* Access Control Styles */
        .access-type-card{transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1)}
        .access-type-card:hover{transform:translateY(-2px)}
        .access-type-card.ac-selected{transform:translateY(-4px)}
        .access-check{display:flex !important}
        .access-type-card:not(.ac-selected) .access-check{display:none !important}
        .toggle-switch{width:44px;height:24px;background:var(--bg-input);border-radius:12px;position:relative;cursor:pointer;transition:0.3s}
        .toggle-switch.on{background:var(--accent-primary)}
        .toggle-switch::after{content:'';position:absolute;width:20px;height:20px;background:white;border-radius:50%;top:2px;left:2px;transition:0.3s}
        .toggle-switch.on::after{left:22px}
        
        /* Theme-aware backgrounds */
        .bg-theme-primary{background:var(--bg-primary)}
        .bg-theme-secondary{background:var(--bg-secondary)}
        .bg-theme-card{background:var(--bg-card)}
        .text-theme-primary{color:var(--text-primary)}
        .text-theme-secondary{color:var(--text-secondary)}
        .text-theme-muted{color:var(--text-muted)}
        .border-theme{border-color:var(--border-color)}
        
        /* Sidebar theming */
        .desktop-sidebar{background:var(--sidebar-bg) !important}
        .sidebar-item{color:var(--text-secondary)}
        .sidebar-item:hover{background:var(--bg-input)}
        
        /* Sidebar for light themes */
        [data-theme="light"] .sidebar-item,
        [data-theme="ocean"] .sidebar-item {
            color: var(--text-secondary);
        }
        
        [data-theme="light"] .sidebar-item.active,
        [data-theme="ocean"] .sidebar-item.active {
            background: var(--sidebar-active);
            color: var(--accent-primary);
            border-left: 3px solid var(--accent-primary);
        }
        
        [data-theme="light"] .sidebar-item:hover,
        [data-theme="ocean"] .sidebar-item:hover {
            background: rgba(0,0,0,0.05);
        }
        
        /* Theme selector buttons */
        .theme-btn {
            background: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .theme-btn:hover {
            border-color: var(--accent-primary);
        }
        
        /* Tab Buttons */
        .tab-btn {
            color: var(--text-muted);
            transition: all 0.2s;
        }
        
        .tab-btn:hover {
            color: var(--text-secondary);
        }
        
        .tab-btn.active {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        
        /* Navigation Icons */
        .nav-icon {
            opacity: 0.9;
        }
        
        .sidebar-item.active .nav-icon {
            opacity: 1;
        }
        
        /* In light themes, icons need to stay visible (they have dark background) */
        [data-theme="light"] .nav-icon,
        [data-theme="ocean"] .nav-icon {
            opacity: 0.9;
            border-radius: 4px;
        }
        
        [data-theme="light"] .sidebar-item.active .nav-icon,
        [data-theme="ocean"] .sidebar-item.active .nav-icon {
            opacity: 1;
        }
        
        /* === TAILWIND GRAY OVERRIDES FOR LIGHT THEMES === */
        /* These override Tailwind's gray classes to work with themes */
        
        /* Text colors - override gray text for light themes */
        [data-theme="light"] .text-gray-300,
        [data-theme="light"] .text-gray-400,
        [data-theme="ocean"] .text-gray-300,
        [data-theme="ocean"] .text-gray-400 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="light"] .text-gray-500,
        [data-theme="light"] .text-gray-600,
        [data-theme="ocean"] .text-gray-500,
        [data-theme="ocean"] .text-gray-600 {
            color: var(--text-muted) !important;
        }
        
        /* Background colors - override gray backgrounds for light themes */
        [data-theme="light"] .bg-gray-800,
        [data-theme="light"] .bg-gray-900,
        [data-theme="light"] .bg-gray-800\/50,
        [data-theme="light"] .bg-gray-800\/30,
        [data-theme="ocean"] .bg-gray-800,
        [data-theme="ocean"] .bg-gray-900,
        [data-theme="ocean"] .bg-gray-800\/50,
        [data-theme="ocean"] .bg-gray-800\/30 {
            background: var(--bg-input) !important;
        }
        
        [data-theme="light"] .bg-gray-700,
        [data-theme="ocean"] .bg-gray-700 {
            background: var(--border-color) !important;
        }
        
        /* Override text color for light themes - dark text on light backgrounds */
        [data-theme="light"] .bg-gray-700,
        [data-theme="light"] .bg-gray-800,
        [data-theme="light"] .bg-gray-900,
        [data-theme="ocean"] .bg-gray-700,
        [data-theme="ocean"] .bg-gray-800,
        [data-theme="ocean"] .bg-gray-900 {
            color: var(--text-primary) !important;
        }
        
        /* Light theme table styling */
        [data-theme="light"] .chat-content table,
        [data-theme="ocean"] .chat-content table {
            background: #ffffff !important;
        }
        [data-theme="light"] .chat-content td,
        [data-theme="ocean"] .chat-content td {
            color: #1f2937 !important;
            border-color: #e5e7eb !important;
        }
        [data-theme="light"] .chat-content tbody tr:nth-child(even),
        [data-theme="ocean"] .chat-content tbody tr:nth-child(even) {
            background: rgba(99, 102, 241, 0.05) !important;
        }
        [data-theme="light"] .chat-content tbody tr:hover,
        [data-theme="ocean"] .chat-content tbody tr:hover {
            background: rgba(99, 102, 241, 0.1) !important;
        }
        
        /* Light theme - Profile page and cards */
        [data-theme="light"] .card,
        [data-theme="ocean"] .card {
            background: #ffffff !important;
            border-color: #e5e7eb !important;
        }
        [data-theme="light"] .card label,
        [data-theme="ocean"] .card label {
            color: #4b5563 !important;
        }
        [data-theme="light"] .card p,
        [data-theme="light"] .card h3,
        [data-theme="ocean"] .card p,
        [data-theme="ocean"] .card h3 {
            color: #1f2937 !important;
        }
        [data-theme="light"] .card .text-gray-400,
        [data-theme="light"] .card .text-gray-500,
        [data-theme="ocean"] .card .text-gray-400,
        [data-theme="ocean"] .card .text-gray-500 {
            color: #6b7280 !important;
        }
        [data-theme="light"] .input-field,
        [data-theme="ocean"] .input-field {
            background: #f3f4f6 !important;
            border-color: #d1d5db !important;
            color: #1f2937 !important;
        }
        [data-theme="light"] .input-field::placeholder,
        [data-theme="ocean"] .input-field::placeholder {
            color: #9ca3af !important;
        }
        [data-theme="light"] .bg-gray-700\/30,
        [data-theme="ocean"] .bg-gray-700\/30 {
            background: #f3f4f6 !important;
        }
        
        /* Border colors */
        [data-theme="light"] .border-gray-700,
        [data-theme="light"] .border-gray-800,
        [data-theme="ocean"] .border-gray-700,
        [data-theme="ocean"] .border-gray-800 {
            border-color: var(--border-color) !important;
        }
        
        /* Hover states */
        [data-theme="light"] .hover\:bg-gray-800:hover,
        [data-theme="ocean"] .hover\:bg-gray-800:hover {
            background: rgba(203, 213, 225, 0.5) !important;
        }
        
        [data-theme="light"] .hover\:bg-gray-700:hover,
        [data-theme="ocean"] .hover\:bg-gray-700:hover {
            background: rgba(203, 213, 225, 0.8) !important;
        }
        
        /* Hover text colors for action buttons */
        [data-theme="light"] .hover\:text-green-400:hover,
        [data-theme="ocean"] .hover\:text-green-400:hover {
            color: #16a34a !important;
        }
        
        [data-theme="light"] .hover\:text-blue-400:hover,
        [data-theme="ocean"] .hover\:text-blue-400:hover {
            color: #2563eb !important;
        }
        
        [data-theme="light"] .hover\:text-red-400:hover,
        [data-theme="ocean"] .hover\:text-red-400:hover {
            color: #dc2626 !important;
        }
        
        [data-theme="light"] .hover\:text-purple-300:hover,
        [data-theme="ocean"] .hover\:text-purple-300:hover {
            color: #7c3aed !important;
        }
        
        [data-theme="light"] .hover\:text-white:hover,
        [data-theme="ocean"] .hover\:text-white:hover {
            color: var(--text-primary) !important;
        }
        
        /* Placeholder text */
        [data-theme="light"] input::placeholder,
        [data-theme="light"] textarea::placeholder,
        [data-theme="ocean"] input::placeholder,
        [data-theme="ocean"] textarea::placeholder {
            color: var(--text-muted) !important;
        }
        
        /* Select dropdowns */
        [data-theme="light"] select,
        [data-theme="ocean"] select {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Provider cards and special backgrounds */
        [data-theme="light"] .bg-green-500\/10,
        [data-theme="ocean"] .bg-green-500\/10 {
            background: rgba(34, 197, 94, 0.15) !important;
        }
        
        [data-theme="light"] .bg-purple-500\/10,
        [data-theme="light"] .bg-purple-500\/20,
        [data-theme="ocean"] .bg-purple-500\/10,
        [data-theme="ocean"] .bg-purple-500\/20 {
            background: rgba(139, 92, 246, 0.15) !important;
        }
        
        /* Provider card background */
        [data-theme="light"] .bg-gray-800\/50,
        [data-theme="ocean"] .bg-gray-800\/50 {
            background: var(--bg-input) !important;
        }
        
        [data-theme="light"] .bg-gray-800\/30,
        [data-theme="ocean"] .bg-gray-800\/30 {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color);
        }
        
        /* bg-gray-900/50 for quote boxes */
        
        /* === MODAL & WIZARD FIXES FOR LIGHT THEMES === */
        /* Wizard steps bar - override hardcoded dark bg */
        [data-theme="light"] #wizard-steps-bar,
        [data-theme="ocean"] #wizard-steps-bar {
            background: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Step indicators */
        [data-theme="light"] .wizard-step .step-label,
        [data-theme="ocean"] .wizard-step .step-label {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="light"] .wizard-step .step-num,
        [data-theme="ocean"] .wizard-step .step-num {
            color: white !important;
        }
        
        [data-theme="light"] .step-connector,
        [data-theme="ocean"] .step-connector {
            background: var(--border-color) !important;
        }
        
        /* Modal cards */
        [data-theme="light"] #modal-tool .card,
        [data-theme="light"] #modal-tool > div,
        [data-theme="ocean"] #modal-tool .card,
        [data-theme="ocean"] #modal-tool > div {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }
        
        /* Step header boxes */
        [data-theme="light"] [id^="wiz-step-"] > .flex.items-center.gap-3,
        [data-theme="ocean"] [id^="wiz-step-"] > .flex.items-center.gap-3 {
            background: var(--bg-input) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="light"] [id^="wiz-step-"] h4,
        [data-theme="light"] [id^="wiz-step-"] .font-semibold,
        [data-theme="light"] [id^="wiz-step-"] .font-medium,
        [data-theme="ocean"] [id^="wiz-step-"] h4,
        [data-theme="ocean"] [id^="wiz-step-"] .font-semibold,
        [data-theme="ocean"] [id^="wiz-step-"] .font-medium {
            color: var(--text-primary) !important;
        }
        
        /* Form labels */
        [data-theme="light"] label,
        [data-theme="ocean"] label {
            color: var(--text-secondary) !important;
        }
        
        /* Hardcoded dark backgrounds */
        [data-theme="light"] .bg-\[\#1a1a2e\],
        [data-theme="light"] .bg-\[\#0d0d1a\],
        [data-theme="light"] .bg-\[\#1a1a2e\]\/50,
        [data-theme="ocean"] .bg-\[\#1a1a2e\],
        [data-theme="ocean"] .bg-\[\#0d0d1a\],
        [data-theme="ocean"] .bg-\[\#1a1a2e\]\/50 {
            background: var(--bg-card) !important;
        }
        
        /* Tool type selection cards */
        [data-theme="light"] #wiz-step-0 button.card,
        [data-theme="ocean"] #wiz-step-0 button.card {
            background: var(--bg-input) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="light"] #wiz-step-0 button.card:hover,
        [data-theme="ocean"] #wiz-step-0 button.card:hover {
            border-color: var(--accent-primary) !important;
            background: var(--bg-card) !important;
        }
        
        [data-theme="light"] #wiz-step-0 button.card span.font-medium,
        [data-theme="ocean"] #wiz-step-0 button.card span.font-medium {
            color: var(--text-primary) !important;
        }
        
        /* Modal header text */
        [data-theme="light"] #wizard-title,
        [data-theme="light"] #wizard-subtitle,
        [data-theme="ocean"] #wizard-title,
        [data-theme="ocean"] #wizard-subtitle {
            color: var(--text-primary) !important;
        }
        
        [data-theme="light"] #wizard-subtitle,
        [data-theme="ocean"] #wizard-subtitle {
            color: var(--text-secondary) !important;
        }
        
        /* Modal close button */
        [data-theme="light"] #modal-tool button[onclick="closeWizard()"],
        [data-theme="ocean"] #modal-tool button[onclick="closeWizard()"] {
            color: var(--text-muted) !important;
        }
        
        [data-theme="light"] #modal-tool button[onclick="closeWizard()"]:hover,
        [data-theme="ocean"] #modal-tool button[onclick="closeWizard()"]:hover {
            color: var(--text-primary) !important;
        }
        
        /* Config section cards */
        [data-theme="light"] [id^="cfg-"] .card,
        [data-theme="ocean"] [id^="cfg-"] .card {
            background: var(--bg-input) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        /* All modals - ensure proper theming */
        [data-theme="light"] .modal-backdrop > div,
        [data-theme="ocean"] .modal-backdrop > div {
            background: var(--bg-card) !important;
        }
        
        /* Section headers in modals */
        [data-theme="light"] h4.text-xs.uppercase,
        [data-theme="ocean"] h4.text-xs.uppercase {
            color: var(--text-muted) !important;
        }
        
        /* File upload areas */
        [data-theme="light"] .border-dashed,
        [data-theme="ocean"] .border-dashed {
            border-color: var(--border-color) !important;
            background: var(--bg-input) !important;
        }
        
        /* Step header boxes */
        .step-header-box {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }
        
        .step-header-box h4,
        .step-header-box .font-semibold {
            color: var(--text-primary);
        }
        
        .step-header-box p {
            color: var(--text-secondary);
        }
        
        .step-header-box p.text-gray-400 {
            color: var(--text-muted) !important;
        }
        
        /* Modal content boxes */
        .modal-content-box {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .modal-content-box h3,
        .modal-content-box h4,
        .modal-content-box .font-bold,
        .modal-content-box .font-medium {
            color: var(--text-primary);
        }
        
        .modal-content-box p,
        .modal-content-box label {
            color: var(--text-secondary);
        }
        
        /* Modal buttons and borders in light themes */
        [data-theme="light"] .modal-content-box,
        [data-theme="ocean"] .modal-content-box {
            background: var(--bg-card) !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        [data-theme="light"] .modal-content-box .border-gray-700,
        [data-theme="ocean"] .modal-content-box .border-gray-700 {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="light"] .modal-content-box .bg-gray-700,
        [data-theme="ocean"] .modal-content-box .bg-gray-700 {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="light"] .modal-content-box .bg-gray-700:hover,
        [data-theme="ocean"] .modal-content-box .bg-gray-700:hover {
            background: var(--border-color) !important;
        }
        
        [data-theme="light"] .modal-content-box .hover\:bg-gray-600:hover,
        [data-theme="ocean"] .modal-content-box .hover\:bg-gray-600:hover {
            background: var(--border-color) !important;
        }
        
        [data-theme="light"] .modal-content-box .hover\:bg-gray-700:hover,
        [data-theme="ocean"] .modal-content-box .hover\:bg-gray-700:hover {
            background: var(--bg-input) !important;
        }
        
        /* All gray-700 borders in light themes */
        [data-theme="light"] .border-gray-700,
        [data-theme="ocean"] .border-gray-700 {
            border-color: var(--border-color) !important;
        }
        
        /* All gray-700/gray-600 backgrounds in light themes */
        [data-theme="light"] .bg-gray-700,
        [data-theme="ocean"] .bg-gray-700 {
            background: var(--bg-input) !important;
        }
        
        [data-theme="light"] .bg-gray-600,
        [data-theme="ocean"] .bg-gray-600 {
            background: var(--border-color) !important;
        }
        
        /* Hover states for modal buttons */
        [data-theme="light"] .hover\:bg-gray-600:hover,
        [data-theme="ocean"] .hover\:bg-gray-600:hover {
            background: #d1d5db !important;
        }
        
        /* Text colors in modals */
        [data-theme="light"] .text-purple-300,
        [data-theme="ocean"] .text-purple-300 {
            color: #7c3aed !important;
        }
        
        [data-theme="light"] .text-green-300,
        [data-theme="ocean"] .text-green-300 {
            color: #16a34a !important;
        }
        
        [data-theme="light"] .text-blue-300,
        [data-theme="ocean"] .text-blue-300 {
            color: #2563eb !important;
        }
        
        /* Upload box hover */
        .upload-box:hover {
            border-color: var(--accent-primary) !important;
        }
        
        /* OAuth cards */
        .oauth-card {
            transition: all 0.2s ease;
        }
        
        .oauth-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .oauth-card.border-green-500 {
            border-color: #22c55e !important;
        }
        
        /* === COMPREHENSIVE TEXT FIXES FOR LIGHT THEMES === */
        /* Ensure all text in modals and cards is visible */
        [data-theme="light"] .font-semibold,
        [data-theme="light"] .font-medium,
        [data-theme="light"] .font-bold,
        [data-theme="ocean"] .font-semibold,
        [data-theme="ocean"] .font-medium,
        [data-theme="ocean"] .font-bold {
            color: var(--text-primary);
        }
        
        /* Specific fixes for wizard steps */
        [data-theme="light"] #wiz-step-0 .font-medium,
        [data-theme="light"] #wiz-step-1 .font-semibold,
        [data-theme="light"] #wiz-step-2 .font-semibold,
        [data-theme="light"] #wiz-step-3 .font-semibold,
        [data-theme="light"] #wiz-step-4 .font-semibold,
        [data-theme="ocean"] #wiz-step-0 .font-medium,
        [data-theme="ocean"] #wiz-step-1 .font-semibold,
        [data-theme="ocean"] #wiz-step-2 .font-semibold,
        [data-theme="ocean"] #wiz-step-3 .font-semibold,
        [data-theme="ocean"] #wiz-step-4 .font-semibold {
            color: var(--text-primary) !important;
        }
        
        /* Input number fields in light themes */
        [data-theme="light"] input[type="number"],
        [data-theme="ocean"] input[type="number"] {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Range sliders */
        [data-theme="light"] input[type="range"],
        [data-theme="ocean"] input[type="range"] {
            background: var(--bg-input);
        }
        
        /* Checkboxes */
        [data-theme="light"] input[type="checkbox"],
        [data-theme="ocean"] input[type="checkbox"] {
            accent-color: var(--accent-primary);
        }
        
        /* Card titles and descriptions */
        [data-theme="light"] .card h3,
        [data-theme="light"] .card h4,
        [data-theme="light"] .card h5,
        [data-theme="ocean"] .card h3,
        [data-theme="ocean"] .card h4,
        [data-theme="ocean"] .card h5 {
            color: var(--text-primary) !important;
        }
        
        /* Small text */
        [data-theme="light"] .text-xs,
        [data-theme="light"] .text-\[10px\],
        [data-theme="light"] .text-\[11px\],
        [data-theme="ocean"] .text-xs,
        [data-theme="ocean"] .text-\[10px\],
        [data-theme="ocean"] .text-\[11px\] {
            color: var(--text-secondary);
        }
        
        /* Exception: keep colored small text */
        [data-theme="light"] .text-xs.text-purple-400,
        [data-theme="light"] .text-xs.text-green-400,
        [data-theme="light"] .text-xs.text-blue-400,
        [data-theme="ocean"] .text-xs.text-purple-400,
        [data-theme="ocean"] .text-xs.text-green-400,
        [data-theme="ocean"] .text-xs.text-blue-400 {
            color: inherit;
        }
        [data-theme="light"] .bg-gray-900\/50,
        [data-theme="ocean"] .bg-gray-900\/50 {
            background: var(--bg-input) !important;
        }
        
        /* Labels and headers */
        [data-theme="light"] h1, [data-theme="light"] h2, [data-theme="light"] h3, [data-theme="light"] h4,
        [data-theme="ocean"] h1, [data-theme="ocean"] h2, [data-theme="ocean"] h3, [data-theme="ocean"] h4 {
            color: var(--text-primary);
        }
        
        [data-theme="light"] label,
        [data-theme="ocean"] label {
            color: var(--text-secondary);
        }
        
        /* Cards and sections */
        [data-theme="light"] .card,
        [data-theme="ocean"] .card {
            background: var(--bg-card) !important;
            border-color: var(--border-color) !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Provider badges */
        [data-theme="light"] .bg-green-900\/50,
        [data-theme="ocean"] .bg-green-900\/50 {
            background: rgba(34, 197, 94, 0.2) !important;
        }
        
        [data-theme="light"] .bg-blue-900\/30,
        [data-theme="ocean"] .bg-blue-900\/30 {
            background: rgba(59, 130, 246, 0.15) !important;
        }
        
        [data-theme="light"] .bg-purple-900\/30,
        [data-theme="ocean"] .bg-purple-900\/30 {
            background: rgba(139, 92, 246, 0.15) !important;
        }
        
        /* Buttons for light themes */
        [data-theme="light"] .btn-secondary,
        [data-theme="ocean"] .btn-secondary {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color);
        }
        
        /* Primary buttons - ALWAYS white text on gradient */
        .btn-primary {
            color: #ffffff !important;
        }
        
        /* Success/Danger buttons - ALWAYS white text */
        .btn-success, .btn-danger {
            color: #ffffff !important;
        }
        
        /* Any element with gradient background should have white text */
        [data-theme="light"] .gradient-bg,
        [data-theme="ocean"] .gradient-bg {
            color: #ffffff !important;
        }
        
        /* Status badges should keep their colors */
        .status-draft, .status-published {
            color: #000000 !important;
        }
        
        /* Step indicators */
        .step-active, .step-done {
            color: #ffffff !important;
        }
        
        /* Tag badges */
        [data-theme="light"] .text-purple-300,
        [data-theme="light"] .text-purple-400,
        [data-theme="ocean"] .text-purple-300,
        [data-theme="ocean"] .text-purple-400 {
            color: #7c3aed !important;
        }
        
        [data-theme="light"] .text-green-400,
        [data-theme="ocean"] .text-green-400 {
            color: #16a34a !important;
        }
        
        [data-theme="light"] .text-blue-400,
        [data-theme="ocean"] .text-blue-400 {
            color: #2563eb !important;
        }
        
        [data-theme="light"] .text-yellow-400,
        [data-theme="ocean"] .text-yellow-400 {
            color: #ca8a04 !important;
        }
        
        /* Model tags - better contrast for light themes */
        [data-theme="light"] .bg-gray-700,
        [data-theme="ocean"] .bg-gray-700 {
            background: #e2e8f0 !important;
            color: #475569 !important;
        }
        
        [data-theme="light"] .text-gray-300,
        [data-theme="ocean"] .text-gray-300 {
            color: var(--text-secondary) !important;
        }
        
        /* Dividers */
        [data-theme="light"] .divide-gray-700 > * + *,
        [data-theme="ocean"] .divide-gray-700 > * + * {
            border-color: var(--border-color) !important;
        }
        
        /* Main content area */
        [data-theme="light"] main,
        [data-theme="ocean"] main {
            background: var(--bg-primary);
        }
        
        /* Progress bars - keep vibrant */
        [data-theme="light"] .bg-green-500,
        [data-theme="ocean"] .bg-green-500 {
            background: #22c55e !important;
        }
        
        /* Fix gradient text for light themes */
        [data-theme="light"] .gradient-text,
        [data-theme="ocean"] .gradient-text {
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Modal overlays - darken for light themes */
        [data-theme="light"] .modal-backdrop,
        [data-theme="ocean"] .modal-backdrop {
            background: rgba(0,0,0,0.5);
        }
        
        /* ========== LIGHT THEME TEXT CONTRAST FIXES ========== */
        
        /* Task Modal - ensure dark text on light backgrounds */
        [data-theme="light"] #modal-task,
        [data-theme="ocean"] #modal-task {
            color: #1f2937 !important;
        }
        [data-theme="light"] #modal-task .bg-gray-800,
        [data-theme="ocean"] #modal-task .bg-gray-800 {
            background: #ffffff !important;
            color: #1f2937 !important;
        }
        [data-theme="light"] #modal-task .bg-gray-900,
        [data-theme="ocean"] #modal-task .bg-gray-900 {
            background: #e5e7eb !important;
            color: #1f2937 !important;
        }
        [data-theme="light"] #modal-task .text-white,
        [data-theme="ocean"] #modal-task .text-white {
            color: #1f2937 !important;
        }
        [data-theme="light"] #modal-task .text-gray-300,
        [data-theme="light"] #modal-task .text-gray-400,
        [data-theme="ocean"] #modal-task .text-gray-300,
        [data-theme="ocean"] #modal-task .text-gray-400 {
            color: #4b5563 !important;
        }
        [data-theme="light"] #modal-task input,
        [data-theme="light"] #modal-task textarea,
        [data-theme="ocean"] #modal-task input,
        [data-theme="ocean"] #modal-task textarea {
            background: #e5e7eb !important;
            color: #1f2937 !important;
            border-color: #d1d5db !important;
        }
        [data-theme="light"] #modal-task .task-modal-inst-text,
        [data-theme="ocean"] #modal-task .task-modal-inst-text {
            color: #1f2937 !important;
        }
        
        /* API Test Modal (Tool Wizard) - use platform theme variables so it follows Settings theme */
        #api-test-modal > div {
            background: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }
        #api-test-modal > div > div:first-child {
            background: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        #api-test-modal #api-test-title,
        #api-test-modal .font-bold.text-xl {
            color: var(--text-primary) !important;
        }
        #api-test-modal > div > div:first-child p.text-sm {
            color: var(--text-secondary) !important;
        }
        #api-test-modal > div > div:first-child button[aria-label="Close"] {
            color: var(--text-secondary) !important;
        }
        #api-test-modal > div > div:first-child button[aria-label="Close"]:hover {
            color: var(--text-primary) !important;
        }
        #api-test-modal .bg-gradient-to-br.from-gray-950 {
            background: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        #api-test-modal .font-semibold.text-purple-300,
        #api-test-modal .text-purple-300,
        #api-test-modal .text-purple-200 {
            color: var(--text-primary) !important;
        }
        #api-test-modal #api-test-response .text-center.py-12,
        #api-test-modal #api-test-response .text-gray-400 {
            color: var(--text-muted) !important;
        }
        #api-test-modal > div > div:last-child {
            border-color: var(--border-color) !important;
            background: var(--bg-secondary) !important;
        }
        #api-test-modal > div > div:last-child .text-xs,
        #api-test-modal > div > div:last-child .text-gray-500 {
            color: var(--text-muted) !important;
        }
        #api-test-modal > div > div:last-child button {
            background: var(--accent-primary) !important;
            color: #fff !important;
        }
        #api-test-modal > div > div:last-child button:hover {
            filter: brightness(1.1);
        }
        #api-test-modal .w-12.h-12.rounded-xl {
            background: var(--accent-gradient) !important;
        }
        #api-test-modal input.input-field,
        #api-test-modal .input-field {
            background: var(--bg-input) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        #api-test-modal #api-test-send-btn {
            background: var(--accent-gradient) !important;
            color: #fff !important;
        }
        #api-test-modal #api-test-send-btn:hover {
            filter: brightness(1.1);
        }
        /* Dynamic content (params labels, Required/Optional, help text, table) */
        #api-test-modal .text-purple-400 {
            color: var(--accent-primary) !important;
        }
        #api-test-modal .text-gray-400,
        #api-test-modal .text-gray-300 {
            color: var(--text-secondary) !important;
        }
        #api-test-modal .text-gray-200 {
            color: var(--text-primary) !important;
        }
        #api-test-modal table thead tr {
            background: var(--bg-input) !important;
            border-color: var(--border-color) !important;
        }
        #api-test-modal table th {
            color: var(--text-primary) !important;
        }
        #api-test-modal table td {
            color: var(--text-primary) !important;
        }
        #api-test-modal table tbody tr {
            border-color: var(--border-color) !important;
        }
        #api-test-modal .bg-purple-900\/40 {
            background: var(--bg-input) !important;
        }
        #api-test-modal .border-purple-600\/50 {
            border-color: var(--border-color) !important;
        }
        #api-test-modal .bg-gray-800\/40,
        #api-test-modal .bg-gray-800\/20 {
            background: var(--bg-card) !important;
        }
        #api-test-modal .border-gray-700\/50 {
            border-color: var(--border-color) !important;
        }
        #api-test-modal pre {
            color: var(--text-primary) !important;
        }
        
        /* Tools Modal - Add Selected button white text */
        [data-theme="light"] .btn-primary,
        [data-theme="ocean"] .btn-primary {
            color: #ffffff !important;
        }
        
        /* Access Search Box - dark gray background with visible text */
        [data-theme="light"] #wizard-access-search,
        [data-theme="ocean"] #wizard-access-search {
            background: #6b7280 !important;
            color: #000000 !important;
            border-color: #4b5563 !important;
        }
        [data-theme="light"] #wizard-access-search::placeholder,
        [data-theme="ocean"] #wizard-access-search::placeholder {
            color: #d1d5db !important;
        }
        
        /* Access Search Results - lighter gray with black text */
        [data-theme="light"] #wizard-access-search-results,
        [data-theme="ocean"] #wizard-access-search-results {
            background: #d1d5db !important;
            border-color: #9ca3af !important;
        }
        [data-theme="light"] #wizard-access-search-results > div,
        [data-theme="ocean"] #wizard-access-search-results > div {
            color: #000000 !important;
        }
        [data-theme="light"] #wizard-access-search-results .text-white,
        [data-theme="ocean"] #wizard-access-search-results .text-white {
            color: #000000 !important;
        }
        [data-theme="light"] #wizard-access-search-results .text-gray-400,
        [data-theme="ocean"] #wizard-access-search-results .text-gray-400 {
            color: #4b5563 !important;
        }
        [data-theme="light"] #wizard-access-search-results .bg-gray-600,
        [data-theme="ocean"] #wizard-access-search-results .bg-gray-600 {
            background: #9ca3af !important;
            color: #1f2937 !important;
        }
        [data-theme="light"] #wizard-access-search-results > div:hover,
        [data-theme="ocean"] #wizard-access-search-results > div:hover {
            background: #c0c4cc !important;
        }
        
        /* Admin Search - same fixes */
        [data-theme="light"] #wizard-admin-search,
        [data-theme="ocean"] #wizard-admin-search {
            background: #6b7280 !important;
            color: #000000 !important;
            border-color: #4b5563 !important;
        }
        [data-theme="light"] #wizard-admin-search-results,
        [data-theme="ocean"] #wizard-admin-search-results {
            background: #d1d5db !important;
            border-color: #9ca3af !important;
        }
        [data-theme="light"] #wizard-admin-search-results > div,
        [data-theme="ocean"] #wizard-admin-search-results > div {
            color: #000000 !important;
        }
        [data-theme="light"] #wizard-admin-search-results .text-white,
        [data-theme="ocean"] #wizard-admin-search-results .text-white {
            color: #000000 !important;
        }
        
        /* Info/Alert boxes */
        [data-theme="light"] .bg-blue-500\/10,
        [data-theme="ocean"] .bg-blue-500\/10 {
            background: rgba(59, 130, 246, 0.1) !important;
        }
        
        [data-theme="light"] .bg-yellow-500\/10,
        [data-theme="ocean"] .bg-yellow-500\/10 {
            background: rgba(234, 179, 8, 0.1) !important;
        }
        
        [data-theme="light"] .bg-red-500\/10,
        [data-theme="ocean"] .bg-red-500\/10 {
            background: rgba(239, 68, 68, 0.1) !important;
        }
        
        /* Tool cards */
        [data-theme="light"] .tool-card,
        [data-theme="ocean"] .tool-card {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        /* Tool Card Styles */
        .tool-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }
        
        .tool-title {
            color: var(--text-primary);
        }
        
        .tool-type {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .tool-desc {
            color: var(--text-muted);
        }
        
        .tool-mock-badge {
            font-size: 0.65rem;
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 500;
        }
        
        [data-theme="light"] .tool-mock-badge,
        [data-theme="ocean"] .tool-mock-badge {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
        }
        
        /* Demo Lab Sidebar */
        .demo-sidebar {
            background: var(--bg-secondary);
        }
        
        [data-theme="light"] .demo-sidebar,
        [data-theme="ocean"] .demo-sidebar {
            background: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Agent cards */
        [data-theme="light"] .agent-card,
        [data-theme="ocean"] .agent-card {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        /* Agent Card Styles */
        .agent-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }
        
        .agent-title {
            color: var(--text-primary);
        }
        
        .agent-desc {
            color: var(--text-secondary);
        }
        
        .agent-stats {
            color: var(--text-muted);
        }
        
        /* Agent Status Badges */
        .agent-status-badge {
            font-size: 0.7rem;
            padding: 2px 10px;
            border-radius: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .agent-status-badge.published {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .agent-status-badge.draft {
            background: rgba(234, 179, 8, 0.15);
            color: #ca8a04;
            border: 1px solid rgba(234, 179, 8, 0.3);
        }
        
        /* Agent Action Buttons - Icon only, clean style */
        .agent-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .agent-btn.publish {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .agent-btn.publish:hover {
            background: #22c55e;
            color: white;
            border-color: #22c55e;
        }
        
        .agent-btn.edit {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        .agent-btn.edit:hover {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .agent-btn.delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .agent-btn.delete:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        
        /* Tool Action Buttons - Same style as Agent buttons */
        .tool-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .tool-btn.edit {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        .tool-btn.edit:hover {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .tool-btn.delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .tool-btn.delete:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }
        
        /* Tool Type Badge */
        .tool-type-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
            white-space: nowrap;
        }
        
        /* Demo badge */
        [data-theme="light"] .bg-purple-500,
        [data-theme="ocean"] .bg-purple-500 {
            background: #8b5cf6 !important;
            color: #ffffff !important;
        }
        
        /* Text on colored backgrounds should be white */
        [data-theme="light"] .bg-green-500 span,
        [data-theme="light"] .bg-purple-500 span,
        [data-theme="light"] .bg-blue-500 span,
        [data-theme="light"] .bg-red-500 span,
        [data-theme="ocean"] .bg-green-500 span,
        [data-theme="ocean"] .bg-purple-500 span,
        [data-theme="ocean"] .bg-blue-500 span,
        [data-theme="ocean"] .bg-red-500 span {
            color: #ffffff !important;
        }
        
        /* Mobile Bottom Nav */
        .mobile-nav{display:none}
        @media(max-width:768px){
            .desktop-sidebar{display:none}
            .mobile-nav{display:flex;position:fixed;bottom:0;left:0;right:0;background:var(--sidebar-bg);border-top:1px solid var(--border-color);z-index:100;padding:0.5rem;justify-content:space-around}
            .mobile-nav button{flex:1;display:flex;flex-direction:column;align-items:center;padding:0.5rem;color:var(--text-muted);font-size:0.625rem;gap:0.25rem}
            .mobile-nav button.active{color:var(--accent-primary)}
            .mobile-nav button span:first-child{font-size:1.25rem}
            main{padding-bottom:70px}
        }
        /* Scrollbar */
        ::-webkit-scrollbar{width:6px;height:6px}
        ::-webkit-scrollbar-track{background:var(--bg-secondary)}
        ::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}
        ::-webkit-scrollbar-thumb:hover{background:var(--border-hover)}
        /* Line clamp */
        /* Login page scroll fix */
        #page-login { position:fixed; top:0; left:0; right:0; bottom:0; overflow-y:auto !important; z-index:100; background:var(--bg-primary); display:none; }
        #page-login.visible { display:block; }
        #loading-screen { position:fixed; top:0; left:0; right:0; bottom:0; z-index:200; background:var(--bg-primary); display:flex; align-items:center; justify-content:center; flex-direction:column; }
        #loading-screen.hidden { display:none; }
        .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis}
        .line-clamp-1{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis}
        /* Grid fix for text overflow */
        .grid > * {min-width:0}
        .agent-card, .tool-card {max-width:100%;overflow:hidden}
        .agent-card *, .tool-card * {max-width:100%}
        /* Line clamp */
        .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .line-clamp-3{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
        /* Page sections height */
        main > section { flex:1; display:flex; flex-direction:column; min-height:0; overflow-y:auto; overflow-x:hidden; }
        main > section.hidden { display:none !important; }
        #page-create { overflow-y:auto !important; }
        
        /* Chat page - MUST be hidden when .hidden class is present */
        #page-chat.hidden { 
            display: none !important;
            visibility: hidden !important;
        }
        /* Chat page - flex row for sidebar + main layout (only when visible) */
        #page-chat:not(.hidden) { 
            display: flex !important;
            flex-direction: row !important;
            height: 100% !important; 
            max-height: 100% !important; 
            min-height: 0 !important;
            overflow: hidden !important;
            padding-bottom: 0 !important;
        }
        #chat-messages { 
            flex:1; 
            overflow-y:auto !important; 
            min-height:0; 
            max-height:100%;
            -webkit-overflow-scrolling: touch;
        }
        main {
            display: flex;
            flex-direction: column;
        }
        /* Mobile header spacing */
        @media (max-width: 767px) {
            #main-content { padding-top: 3.5rem; height: calc(100% - 4rem); }
            main > section { padding-bottom: 70px; }
            #page-chat { padding-bottom: 0 !important; }
        }
        @media (min-width: 768px) {
            #main-content { padding-top: 0; height: 100%; }
        }
        /* Wizard scroll */
        #page-create {
            -webkit-overflow-scrolling: touch;
        }
        [id^="wizard-step-"] {
            max-height: none;
            overflow: visible;
        }
        /* Demo Lab styles */
        .demo-sidebar-tab-active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));
            border-bottom: 2px solid #8b5cf6;
        }
        .demo-quick-btn {
            transition: all 0.2s ease;
        }
        .demo-quick-btn:hover {
            transform: translateY(-1px);
        }
        #demo-sidebar-items::-webkit-scrollbar {
            width: 4px;
        }
        #demo-sidebar-items::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        #demo-edit-modal {
            backdrop-filter: blur(4px);
        }
        
        /* Personality Sliders */
        .personality-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-input);
            outline: none;
            cursor: pointer;
        }
        [data-theme="light"] .personality-slider,
        [data-theme="ocean"] .personality-slider {
            background: #cbd5e1;
        }
        .personality-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .personality-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.6);
        }
        .personality-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
        }
        .personality-slider-group {
            padding: 8px 12px;
            background: rgba(31, 41, 55, 0.3);
            border-radius: 8px;
            transition: background 0.2s;
        }
        .personality-slider-group:hover {
            background: rgba(31, 41, 55, 0.5);
        }

        /* Tool Dropdown Menu - Theme Independent */
        .tool-dropdown-menu {
            position: absolute;
            right: 0;
            top: 2rem;
            width: 160px;
            background: #1f2937 !important;
            border: 1px solid #374151 !important;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 9999;
            padding: 4px 0;
        }
        .tool-dropdown-menu button {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 10px !important;
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            font-size: 14px;
            color: #e5e7eb !important;
            background: transparent !important;
            border: none !important;
            cursor: pointer;
            white-space: nowrap;
        }
        .tool-dropdown-menu button:hover {
            background: #374151 !important;
        }
        .tool-dropdown-menu button svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            stroke: #9ca3af;
        }
        .tool-dropdown-menu button.text-red-400 {
            color: #f87171 !important;
        }
        .tool-dropdown-menu button.text-red-400 svg {
            stroke: #f87171;
        }
        .tool-dropdown-menu .menu-divider {
            border-top: 1px solid #374151;
            margin: 4px 0;
        }

        /* Tools Action Bar - Theme Independent */
        #tools-action-bar {
            background: #1e293b !important;
            border-bottom: 1px solid #334155 !important;
        }
        #tools-action-bar button {
            color: #e2e8f0 !important;
        }
        #tools-action-bar .action-btn-view {
            background: #475569 !important;
        }
        #tools-action-bar .action-btn-view:hover {
            background: #64748b !important;
        }
        #tools-action-bar .action-btn-edit {
            background: #7c3aed !important;
        }
        #tools-action-bar .action-btn-edit:hover {
            background: #8b5cf6 !important;
        }
        #tools-action-bar .action-btn-duplicate {
            background: #475569 !important;
        }
        #tools-action-bar .action-btn-duplicate:hover {
            background: #64748b !important;
        }
        #tools-action-bar .action-btn-delete {
            background: #dc2626 !important;
        }
        #tools-action-bar .action-btn-delete:hover {
            background: #ef4444 !important;
        }
        #tools-action-bar span {
            color: #f1f5f9 !important;
        }
    </style>
</head>
<body class="text-white" style="height:100vh;overflow:hidden;margin:0;background:var(--bg-primary);color:var(--text-primary);">

<!-- Tools Action Bar -->
<div id="tools-action-bar" class="hidden fixed top-0 left-0 right-0 shadow-lg z-50 px-4 py-3">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
            <button onclick="clearToolSelection()" class="p-2 rounded-lg hover:opacity-80">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <span id="selected-tool-name" class="font-medium">Tool Selected</span>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="viewSelectedTool()" class="action-btn-view flex items-center gap-2 px-4 py-2 rounded-lg transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                <span>View</span>
            </button>
            <button data-permission="tools:edit" onclick="editSelectedTool()" class="action-btn-edit flex items-center gap-2 px-4 py-2 rounded-lg transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                <span>Edit</span>
            </button>
            <button data-permission="tools:create" onclick="duplicateSelectedTool()" class="action-btn-duplicate flex items-center gap-2 px-4 py-2 rounded-lg transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                <span>Duplicate</span>
            </button>
            <button data-permission="tools:delete" onclick="deleteSelectedTool()" class="action-btn-delete flex items-center gap-2 px-4 py-2 rounded-lg transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                <span>Delete</span>
            </button>
        </div>
    </div>
</div>
</div>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-20 h-20 rounded-xl mb-4 animate-pulse">
        <p class="text-gray-400">Loading...</p>
    </div>
    <!-- Login Page - Shown when not authenticated -->
    <section id="page-login" class="min-h-screen py-8 px-4 overflow-y-auto">
        <div id="auth-container" class="w-full max-w-md mx-auto">
            <!-- Logo -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-3 mb-4">
                    <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                    <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
                </div>
                <p class="text-gray-400">Enterprise AI Agent Platform</p>
            </div>
            
            <!-- Login Form -->
            <div class="card rounded-2xl p-8">
                <h2 class="text-xl font-bold mb-6">Welcome Back</h2>
                
                <!-- OAuth Buttons -->
                <div class="space-y-3 mb-6">
                    <button onclick="oauthLogin('google')" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg border border-gray-600 hover:bg-gray-700 transition">
                        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        <span>Continue with Google</span>
                    </button>
                    <button onclick="oauthLogin('microsoft')" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg border border-gray-600 hover:bg-gray-700 transition">
                        <svg width="20" height="20" viewBox="0 0 23 23"><path fill="#f35325" d="M1 1h10v10H1z"/><path fill="#81bc06" d="M12 1h10v10H12z"/><path fill="#05a6f0" d="M1 12h10v10H1z"/><path fill="#ffba08" d="M12 12h10v10H12z"/></svg>
                        <span>Continue with Microsoft</span>
                    </button>
                </div>
                
                <!-- Divider -->
                <div class="flex items-center gap-4 mb-6">
                    <div class="flex-1 h-px bg-gray-600"></div>
                    <span class="text-sm text-gray-400">or sign in with email</span>
                    <div class="flex-1 h-px bg-gray-600"></div>
                </div>
                
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Email</label>
                            <input type="email" id="login-email" required
                                   class="input-field w-full px-4 py-3 rounded-lg"
                                   placeholder="you@company.com">
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Password</label>
                            <div class="relative">
                                <input type="password" id="login-password" required
                                       class="input-field w-full px-4 py-3 pr-12 rounded-lg"
                                       placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                <button type="button" onclick="togglePassword('login-password', this)" 
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1">
                                    <span class="eye-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="login-remember" class="rounded">
                                <span class="text-sm text-gray-400">Remember me</span>
                            </label>
                            <button type="button" onclick="showForgotPassword()"
                                    class="text-sm text-purple-400 hover:text-purple-300">
                                Forgot password?
                            </button>
                        </div>
                        
                        <button type="submit" id="login-btn"
                                class="btn-primary w-full py-3 rounded-lg font-semibold">
                            Sign In
                        </button>
                    </div>
                </form>
                
                <!-- Register Link -->
                <p class="text-center text-gray-400 text-sm mt-6" id="register-link">
                    Don't have an account? 
                    <button onclick="showRegister()" class="text-purple-400 hover:text-purple-300">
                        Sign up
                    </button>
                </p>
            </div>
            
            <!-- Footer -->
            <p class="text-center text-gray-500 text-xs mt-8">
                AgentForge Enterprise v3.2
            </p>
        </div>
    </section>

    <!-- Main Application - Hidden until authenticated -->
    <div id="app" class="flex hidden" style="height:100vh;max-width:100vw;overflow:hidden;">
        <!-- Desktop Sidebar -->
        <aside class="desktop-sidebar w-64 border-r border-gray-800 flex-col hidden md:flex" style="background:var(--sidebar-bg);">
            <div class="p-4 border-b border-gray-800">
                <div class="flex items-center gap-3">
                    <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-10 h-10 rounded-lg">
                    <div>
                        <h1 class="text-lg font-bold gradient-text">AgentForge</h1>
                        <p class="text-xs text-gray-500">AI Agent Builder</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-3 space-y-1">
                <button onclick="navigate('chat')" id="nav-chat" data-permission="chat:use" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <span>ðŸ’¬</span><span>Chat</span>
                </button>
                <button onclick="navigate('agents')" id="nav-agents" data-permission="agents:view" class="sidebar-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAUXUlEQVR42m1aaZRdVZXee59731CVqkqqUgkJkSGBEAQiCS0GMcqghoCNMoggLAcUAZHGhQOKChq6RWy6bSKK0VawRRoVBUQQ0calAssVMGEwCQbJnMqckHo1vffuOV//OOOtskjCq/fuu/ecffb+9re/vbmST2Fmij/2NfwLIna/MTEA4vRSJiL7dcTvEhGDS/cI77O9kJgAIhCB4L6N8JF9yXExTIzwZrgtAKKMiEHpw+3n7B+HuCb7jnuMXb39bviobAJOt+QeDYp3CLdhlE0GbzG/GBA504FAsM+zd8nCnfwNUqNh4p6SExG7n7DSxIBEJERgEtiFAIhLZCIQMzMDRATYzQNufwwu7Qf2lMHE0aBuh5nzA2ee1GJhw8TW2tHeHHfjnILJOyIA71b2LyO1gFs/MxP8yp33WHMwkfFWY45nYX9hLjkM/Akg8elxPkvuKc5PMO6cQMTRLkzELDTOb8Je/F7B3jDlo3Yuyi6GvOMTUue0BvFvZeOXHCIW452YmJE4OgcjkTBHB/QBby3lwpR9wKO8GgAE7x3228wghj1IH9HRNZBsFbAxEA1DqbG8A7g7u9Vz2CISP/FL57AvZ1175hwQpmwRayMmhsAfsffl4JL2NEy6bmaGB4ks+vuEH2828U7v78hsl+ts5FxMkhgl7/3kg5i97xNZOE78yoYyCQNgcIxQ7wYEsTHOzo0j6Gbjlhxs7A0g4OSI3AUMt2n2sc4hcFG6ld0qPAJw+RQESf5AYnWKsO9vj5BD3KUhD/wDDA3nX4pw4giEYfXBrxxaOcRyHsoJyDk0stEV3AMEDjYCQGzPzB4a3G2JQcZeZ9wxgpnZbYA9UnnPhAgl9uZgzhjNRCTOYP5/ZCGIhQjWZxKYATMDhgxKDstCAMMHJzOTgTHsbQSX+cA+wCSJJxCy5Ei9M4R1h3wcchm7oOJo/tRbmETs9/zzrL8aIgaMBRufvUwC3WAPMCCxXucDxbkzQo5xDxTAsA/iMnD7lXtPAuIZMJGwPwR21zARkQgzkzCzIlEkopQAbAAhaK3JaMAQyP5LzGR0gu4BMK2bMdiwC9txecAldntdVspHgZ4Re+rB1tDOowN7i87jj0KERIgFLJzlJNIYGaNajVDQWKveUSdTsAHBAIaMIRgS8dwIkQ06RgAX4vYCi0eM6A5w72XWhA6anN8ySjlhwnLja3sUYokNs5AoUgoiulL73HUfO/kNr2emP/559Td/8L+VQpHR0Jp1QUxgImMJLpgJhjilk2HtzI6buOWYhNQCANeqUykiekBGCaELFvYMIvgM2ygXIlZuh8zEipWSSmWM5J47/7Xdai+/+2cqyz59xSWN4ZErP7WsQ9gUbegCumBLpwHAEMAAjOVAhpjIWC8Bh+xr6SAQqRKMXUIpCbA3s/cacQeCeBosQkQkTKJImKzhJWOlVF4ZHmudvfT0qT3dH77y8y++9PKq59dcfNXn5hw28/Qz3zLSakuWkcpYMogCMbGwKGKBezITi0/lnGQSKhk3+C1Iov2ImcXa3oWwXai9MbNdK7OQCCmBfRgJibBkJEKiOMtgaP68o/64eo3q7JjSO7m3d4pI/qdVa058/TEGJHlGIqwUiyJRYCFiFiYWeARzwMDWekQsxILou8wcQUYoZQSeI5BL+naJMXqJGSL2jixCzKyULQxYZaQyQ8y12kuvbl38T2/Qkh0szP5m02Tq1JNOeH79RqlVYU0uipUSlbEoG/puS9Yo4Q8Fy5I/pZBp3SJVpjpCBrXJ3IWCxO+TsMtQzCTCLMTKeg6ziMrIPj7LSGW58Lp1ryx965vOPvv0VwZ2Te/v+8YXr925Y9c377qns1oxLKwkJES2wIWIbgn35ZT1xURF5RqxVu0HS0rIPMxLREyLMCFPSaaynEVIFOxZiZDKqGgjyyuz56rZx7YO7r9yweEXnH0Gi9z7i8fu/suG2iGHtl9Z2960no3hvIp2i2DEVm66gNa6KMgUFmQZtoYznhrApzXD8VcQjFJZZ3C7YH5LJRxoisuy7rglU1k+NNpsjTZbba3zvFqvgwVjo+ro46qLl8iUqdi1XfbsePKR377uqCO27Np369e/09VZgTb5kXOz1y+kZtPsHqBqVSnVbLVHG8OtZqulTbVasQDPFJYbaT4DEQZ9kcPMmXdwn7YS8B9fmwmzUqzyoWbzzLPOOGPxyaNjzZ8++uT6v23omtRJZ76bpvS3nv099uziLM86OrIpk2uVvF6rZn29NDJc7Hyx/ddV3D+jtug0OfIY/cwTjaGR2UcefvG575jc3bly9ZoHHnq8pnKxOcrSZ2PSCiYw75AKQBAfAEjCw1fDHnl8fAurbLjVvnXZZ7943Ue27dhdGNy3fNl5Zy0embcgz3P98A/Na/u4c5J01PNq1YiICDMbbVSeU73OnV20f+/oQ/cKMDb/1DMWLfj5iq8RsPZvG97/niV3L79Fs9g86GwqSbXEE7QGYlvQwNfpIWyEo/7hD41ZKTU8NHLOe85666KTFp/7YdNskaGHHv/Dj++4edW1N+/+68p8cq8hEiZWak9jiJrNPYON+tiYGRvbM8g99Sq0RqVKWd566jfdvX1f++5XP/Hlbzz96yepVr3ne/c9/LMVV3zoom8v/35nZ1VbrkFMImQMgRLpCT5LgRLUD+VbzAzwRZavVwTt9jtOe/M9DzyGVrtv2tSpM6e9vHb9X9a8cvzsw0ZHW1meZ3neFmkU5iMXnfPwD75+1ikL37rg+Efu/vcrLzl3yHCh8qxWyav5UJsPnda3fff+p599qXfWzCmTu1S1+v37H168aKFHOQ+AEf1TqSt+lEWxChSkI2LH9dkCv/uKkKiDg0Mzp/djtAlQYYhYZs2Y9oELz35l68D6rTtJVE/v5F/cdgMM7nrwt2s3bte6mHfYzKvOf8f5Z7z54i/8x4G9+6jdOuKoWVdd+u65R86iWnVUF1UWPTwyc+b0g41hLxnZWDBJ/R6JntsJiJhUlk9KahFfUglH1mARyQJ/lm3asfsrn7l63fad6/6+qUn0yWs+cNycIzZu2X7DlZed987FB4ZGbr760m079l76yVvWbx0YGx0bbgy//PeN9z/4xBtPnPf+c04bbIzc+YVrPv6+f960dYcxOHnBcb995rmRoaFFpyz8ymeuuvn2FXt27lbCcOELK9LA19Sp+udq1Wr9EOskwuJ4JTGJxKrFZkpRYFF5ZaTVXnz6W7786Sv37d1fq1baBp9YdsfA5u3TDj906dtOOef0U7rrtbM++rnJPV1BQRFiFjkwOPirby/L8vyxPz37wON/GNiwubNn0vIvXXdo/5ShxnBff99td/3o8V8/OamSFc0moyBH78Aw0AAZx6otngKAthuYEVAKllHamkuUTQjWBnYDpFReqTRautrdNf/EE8YMXnpuda1er3fUC4PGrj0r7rxl1boNK378UO/krqLQYBZhgDOl9h8c/NjF5yw47pirP7msa1pvbnRzrDk82Jg9//juav7y2nVjjeFJudKtFnRBRjMMYJiJDOxmnEcZR2MJmkASiyBKynOvJjFzqR4A6UJ31auqMfj87qFXVVc3oSKqaLYyJjW194hD+jds2yGZgvHiliGGgTGi1Oad+448pD/r7VFAu9VWonoy3jV5xprBthoamlSv6kIndWwsxiyTZg4lTSQY4i9FpCIuhkK9Ck+H3Fd1ocmYST09NWFTFDDapnc91hoaGZ06uZsKHZIPfCiSMX09kxpDw8XoGGtNWhutdaGrjM7ubhhjtLEqhZdMrFznFD6eIIvZrUhCmEATGgUoqfilz4vREa0ytkWJgU2cf1y99sK3n2rGmplSEgQ0YaXEjDXf/bY3/Wn1Wiq009ktq2HRzaZTLqxyBRPr3yjxOypX1qdZOJAeDt2KibuF+yr82SmFgweyjm6wAACMLorOzvoPH3hsxtQpF12wdM/WgUJrYpZMaea9A7suPG/JrGl9//PgE51dncZGJ4FEpLObDh4gyShZt6c0VsLgMgFNLQmV5V1IavMoyXk2aismd0evF7HK0BzNTzip2LieCs0shpBXKq8dOCi16u3Xf7Ta1fni+g37BoearWLypPp1l7/3lo9f9l/3PfL0n1dNqld1q03GsDbIc3XsicULKwmGANIaxnj9GY4hwHCi5jIHngAiyuBh1imOzKW+Erxr2dtZuQZEItQ4aF7bVzluoVn1DNXrKlP7d+/78Ife+4UrLlnysRv+5bLzfrH8pn0Hh4hoak/337cOnHX1l37+n180Ret7/31/39TegplGD2YnnaoHD6DxGlVrpDUJEwlpDXs+ltSwcQ7nQiMs3om78DIEl9V1+BwN19ixorcVm43hSq148dnGrKOp0aDC0Fhzybnv/OaN1yy54vPPr157+YsvHzprxjGzDxdR6zdu2bJlOxFdfP0tT3zv1oHtOx998DdUrdLoMGme9MJKznJoX9Fb1cgpowDF/zxOGiQNmSxIpVH4im0JnzLYuLsZ41pHRpPKGzsGLlk0/8y7bmu1Wn9Zs/7Gaz542We/9vRTK6f0TQGwb/e+32/fBaJ6nk/urCuRlStfuPhT//atm66bOqVn4bFHdXbU//D0ynufG6jnFdYaBGhDHtPgewcheTmdwsu6dkk2E0eu5KszX8Jb51PKaakiYGGllFLDzfYdt98057BZK+79uWTZjdd8cOPA7vdd/une6f3tdjuoqggYB6pU8n0Du1Ys//LbTj5x2R3fHx4Z/cAFZ+9/7eBV1y+rKTFFm4yG0Qxy+pctykxAQlhOYcUYJpBxypzVjmJjMPS70o6G12ihhIaHRt6+9Iz5x8w57V0fIiUE/tX/PfW7++5846KFq19c11GtGG2IvPwJx8+GGsPzTjjm+LmzT7no4we2bCNRD//kl0/88u4Lz1/6kx890NlZMwHonIcYDh0CpMVAdGxJy7dSpzNqScQwHBMCCECz+eY3nvjo755SRbuvp7uvt0cPDj/30suL3nBssWc3N0fJaGMA+wcEbbg11ty75+T589a+uvnAwO6pU/t6uydloh549HeLFp5ARcGRARhYImTC+Tmf8n4CL0iSeGIKjly71EUjsotwZwoYGEPMm7ZsP2HeHD00PNYcGx4ZwejY0a+bsWl/o7L0vXzYHDCjOUojDYw00ByFsBw+Ry05f/PBkcOn91G7OTw01G63isbgguPnbd42kHoIjGHX2bEd4iDR2TrekLWKdZVqbTolEpDvXKhQB7tszUlUiECUqtQe+cl3Hv/9M9/94U+zLPvMtZcfO3f2BVfc0HH0sdnsuVzrNK0mRkdYmCtVqlTRahUb1w+tfeH+u766bWD3stu/1W4V77/gnI9cet67Lv1EY+/ejElrTcYQdCSeTL4i840/eFpKTlaZBi+cJFlMBUmdJXMxL67VxyyiVKtA34zpX73p+kP6+5SSVzdvu/G2u8Yaw0q3YQx19XBXj3ROIhaMDJnB16hxUES0KFWt3HrjtXNnH9ZutRvDIzfeeufWDZsqilEUTkpBwpwjBBnPCeCg1jpOrdoPl4BDv4iZGRwbME7JsL11WyGAJcvahtrton/WTG3M/p27qh0dmVKGWIRNAEQiq8OBhaCFqNBmbHik/9BD8kwNbN6WZaqaK90uGNqFo9HRxlbl9anLcuwY1DBcq/Y7ITHkYFYOVcVRPae8hnaTF+2sPNjWhlnleaaNRiIMM0eZ1aGeL8tFpNlqE0wlz2C0KTQRyGgn+hvt4JLKGcA2R0LzGyBGVm5wc5CQ7P4QGkvkpDrrha7SM0abtj2poqVtLR1mEcZDgW28woBgClIEIuh2y0OMAzqGAZWnL2w+MfCdKL8BBhNlPkv7sHdMioiIjWV3VrtkGJBLyQTWxMK2wwICGXbCUzyrBM4jO7SWi7Z0DRoLLNEzYlsmZEH/b1JyWTaqOtLxmURA5TDBwezGMkJKYUeuvDZgl0Wxoeor2oCFYTOgVNy0la6rdym8hqfWXgP1Omlg1ZY2AFnCfYJ6FIdRCKCS6uIYHgBmAUCGiDUr8W0hf2m0NwXe4toqsTPJHl5AwTGQNvLCVxIT+A6UlUhVlnWkPfokXku9eN828Eoql6Z/AoUNLpCOXjCIyDgvZ8dlOHiFhXmg3FlnL5yE/h84+I8PMXgXigUxBz0MIJI4IsZJ191p2ZHGhnRvh5fGBTB7ISSt79g3G8eHCryNieLqYwcbSZCCAKVUPTh37N4E7ImN14Tthd2mEFaacCKmMMwEjkwdHBeM0vpSvkYhEnwR4JsD6X7sj8pURyo5cnoIVJqLKI2mJE185tIIYArJwQfSWR6U1p3U2Rj3JhJUQTK04Yoz+zSVqQ4kEkhqcSrX2HHQw1dqruhMJq1itIV5pxgYSddinFbgKb47ZATYQph1odJoUhSr3QmUJ2qSAcO4AaSO4gM7wBkj8QEu2zbJSChnKARinzQAwFHNSt+cODBFBF/QUOjH8oS6gG35Y00hsfwJQzlhWsDuCUHTIzhBId2SRd6w2UjxA9NEkk/t3hBpXGoaInbzQnESMEx2+Jm7pMkRbMy2TjJRdQo+Dv4Hk5tB60D5XST4E/INp4JacqyweMDlaRvKgjHTwc70CX4OLp13JcAQC8HEOVzENnRwd2YuBWBJVSsHsRcg/MPghRwOsVCaUfNgEmCUE16QCFspmvL4JtUEBS+tXuExNOJpYmJKhpgD3wzRgXGDoH5toAkGUErqJbRMGjWcAGjILuWrKMmcE4ZAS/MzmNDB9nnAkgtKVLe4OfjUUQYwjlO52biZ6ZJZ3YwOfOPSTJRM/XKQdIE4DWqa8HQPOxS4U5iqRKSftmGczmtG9PDEBkycpXPiiaMT0lGzdD543Hpi7gghDnjmkcSiR/eIyBNyWeJQMn7TXBrkRpR5s+S9f+AYYYIT4wf0rYLAHq3GdXHLHs6RTLITHlD+EGlYww9VW+MgyUtxCt/f4f8BNWc7mkl0R90AAAAASUVORK5CYII=" alt="" class="w-5 h-5 nav-icon"><span>Agent Hub</span>
                </button>
                <button onclick="navigate('tools')" id="nav-tools" data-permission="tools:view" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAR50lEQVR42mVaa8xmV1V+nrXP+37fNzO9TAco7bQBKmgNtwClchMRAUFAioBVlIJggpqQcgmYECVEQEOieIshoiYm0ER+WISSAsGWqYIpBRMJRg1IUi7pgIW207l+33f2evyx1t5nv9NJO/NeznvO2uv6rGctbm0dIQFBABkv43/Ev4xXzH8BKT8jwPhYiu+XzwGAAti/yxcC4ADbMxRfaXgd35HMj9udlj9NSkFT/DAvUBcOwyn6jyBAEhl3R74jSSiOLwnxFoQBENsD44gkZMo7SiIYj/R+WcoWWovHUAjJuOiXAMFpkQ4byhzEZugjpWbJ39NAKs4c904JOeosjoFFpiY62JQVOre8Z0ooEFToFgQ9T6Bu3HjCNEo6/psCpQ7YLNKlM5BNdBDMYzcfBNk1modpjqS8h6v9sh2uGQbez9sO27SqDY9WOwAXh1fTXhqMgkgClEQaUqimYjaPh8XvSVN3vri+X5uOFIc0dodNx0m3ZNxfItO7l/tluKpH29SsqDxiuGAqNq63Jqr1i9TCFyBpmQLimnDCZpnmBSn+YOL4Uuin6raRkFpTu/lmkAo9IUxNN3FydL22dwZJEGmgDfbj4GfLgQHmVcznESYKEhcfC0G0+EK6U4gWIhKLLN0KYRQtDx9ioOfAfhYC1jRB0NpJ2SWX2pUtiLWk4h5U8Z5LeHSxMs2GOZnJdPz1EH4i6OCSnvLPhOa5S66kMQ6bwWBNDnYH607NOJgAIyM5NHkyCZCCczM/RMyAgjzspq5FOYfCJIjhLpLSN8JM+dhp8dAlCearHgzNn22pbmRGqIV9msQkXKnQSItGuPcqkvfVUL/Orz3WnujKAoANi2W68gidKfWcOZHKYLIQj8vBTM1tsnS1IIuzhXSZXdEObySIYqlRCJJC9QDlFOQaqpRntQRpxgwVb5mZITeIcG8IE5bC2bIYw2iREtJ/NCQdLGFastJZ3MJIw5I5jcbFXyXIW3oXJZnRAfNelkSD+yYOIEFl6KbtpVYrgCmdCqMnWQZcSj/iiY5zSqt0kVtJa6FCg/XibUvQyeHNueMkarjHAImKDB+qVQt5gUv4p6RhewDUpCFbNdHJdPd0bgmUQCPb8TI1USRo4f20otA4jTSaiTCy0Ko7ISPn/X3I4QY55PDw+TQ9JGaIquEyQen+AklvZ4i3nAgOXpVnyHzSEAItIwS0IY0aMhhsSb5maY2yQimllLN7e/u7dXXhof29GXt7F2wf8N2zgEugg0aJkkeagREuUIDH/QSLTNX8sCM6xRGnFDeqc4ZDpu1Weiwdo8PrpmMQMIPZkr1pMMO0AqeyKqf2/eonPuHdv/3aRx29dH9//vhn7vjIxz55CKh75+gEKXeIFOEZvjTIvXmBCMmYvhcBxDHrs0zToQWHpdDWMybMIv/kYYywtAPNUKa4ADSwsBjLxGnitCplOlv9KU9/yq0fef+xr/znRz5+63/dfc/bXv/KJ179Y5+846s7pciHFgSZPEJIjkUpMz6zRDEzOBOYkds7j2yA2Zo3mzigg+biG6LHV1YI0orMANAKpglWWKYyTadYjt30oZtvu/NDf/HRAxcdPLu7d+jIJf/+Dx962wf/5nOfue0gve7tep3hFRJqBVz5IhMupPyw/5eB7VL4WAPrCfcTDmjAkhzyj0GMc6rHgzHMaqt12dqa1lurra3VemtmedxjH3PxBQduuvWOSy572M7W6pGHLzj5o/s+cfudL3rWU5xltb1TVutpWk3TilZYJsAY6T+sit6ZLTW0Y9duuWmBIkNn1qEDIqtmYKeLZ0BbyXRkhWXianVqz+v+DHOsDOLx+0+eObe3s5rO7O5PhhkO6eDO+u7jP/LTu/dBvlcxO2o9uI4AKxQDMGRFy2Q1luIGkVpDOjWYwAZCDb2TaM5HM8GyBct6NS0eNU22Wu9P6xc+79qjRy+tIsxodnp37+GXXHTja1/2tg/89cMvOri3t3/06KW/9pLnfvifbr/+ja8+sF7JndT9P7zvn2/7Fz95KqoyEImIZEEhKgRPFEGDHHlFwvBJHUkuRWqEawyVMzNMs0MUByOtTKvVyd35da966e+/5Ya7vv7N7a1VKMxrvfNr3/ifu49vba1dAg3VP3bLscdd/vCrr7g07n3u3N7VV1357Kc9/l2/98cXTGWeHU5wXpRoBU6gprwKmyxoYmqoJmHtgoHZ2zgQEcFIxSTssZZtrXp96hOv/vjnvvTud//pdOTi2T2AjU3TZHZoa+0+F+r0yVM3vu+vBJM7VEno5OmXveYX3vG6X9RqLT/XkIBRkPdjhFcZmuIDukV9m1qsjN5vrYUlQC3xPQR0pCwrGdDTtFt9vV5Nhy84cmirZn9C0STVeYZXyQke3t4KJkBeCnHCcHBn68zuHkqBDGaoNV2cbFmUge3TfXpPo6WpTw/R2N2oEz9qJcbyPGap+mKwAivIylZmm6p79WR1hMrOqbBAqF6T7XHBMFdJMDP056QePStruH9rkRsSWhqbCWZDhY3eYgN4pvfT5FocyQpLKdNkZVXW62neG3JviRY79JxtmpE0uNNAgWYQDJpmmRmHStoSSmDu9jc8mmMOfAFJyKfGlLAjqmyFezmMYjzg4oAPZZpOnN1HwWTTfHp3331lDq8tCcYDApJbh/hmE4AfPXiKVkrhfHZvFtwFK2HYSBtw7zoONioZrrEFBwBOWS00wCQO4DlQky2IraeeE3v1upe/4A2vfvHFFx763Je/fsnFF54+eRrV5a7AxraQXMp0XESenuvv3PDK655/7aqUf7z9y2fmur2e4B4RBYqKvqojMbXsmcifNCkL9tSIl0Dl2ZQRAxOq7HTSuDQr5cHd+b2/++Ybrnvhn330U/93/4mXPffpL33uNTd+8O9Kgdc5Erkq2K0HmtGKndivf/u+tzz+qiv+/KZP1+qveeEzn/C4R/39zZ83n1migTbBw50aVdQCN0MXLl+Ytu2DVy7AIdQcxEjWWmNEGAvNYMWm6WzV055xzc0fft8zfvXt3/3Wt6ftrUr7yauuPP6DH9Z5n40sjF9ZKeG2U5nuP3P2V17+s+958/VPvv4d5x48weplvb7ysiM/uOd42dv1eR/zvuoMd7mn1iV5ldf2iZAWzgumyG6JC9CQYOtfFzRB0kyAGefTu6/4uWd++thd3/3m3Zc94vB+rbDynW9/r5QykNqMRC3UBrQ079eXPOepH/vsF8+ePHnZhQfnefa53vu94yt4KFtaqpAUoE0Ln4iBvUyYqoY0E2lnrYJZI4KUbbwtdkR1I+d5hly1BjAupdjIOLggJyB3rzUCA5JLRsIXTvXcfp0dCTvZDuIVUQ0bE9AA0GYWStV2/n4hSRsUTdrH5YiOyd3L1urWY3e99HnXXnLF5d9/8MyD5/Z/eOrsoUsOzyzjmCBDS4JcXr3WyXjLsa/8+kuec+jiC+954NS9J8+eRXn+837q8CMeNrtCc1lzWq0UGhPaaHdtUNFWpvVF2ciMoZs9rkXxSgjUauDWzs43v3PPVY+58g9ufP29p3cfcemRd/3ma/7knW/61vF7v/bf/7s9lY7ge3ECKWFna/W1b3znyVc/+j2/dX0ln/akn/jAW1//G6960RWXX3rzZ/91x7K3TJYr7rCQ1EnrbpD1UJnWFzXM3fFcVKuSCCKzG/plArbX61vu+OrsesN1z//5Zz/1G9/9/r0nTh05fNFnvnDXgZW5N4s/RJT1ZJ+4/cvn9uZX/Mw1P/6oy2/69LFb/u0/XnDtkz76qdu2NGvez85R3e+VCdU9O7JF/4LA7YNXtCpsDSFHqi1gyU+sJJSwIgFWbLWKUsD11oEDB07fe+KP/vCt02r9zvf+5eFtq7UuxE6LLpqJFknugVPnkv85c+6Xb/ilN77yBS9+3dsvrOd8rvIKSV4TCdUZqgDkDq+ReRA1PrJQ9uKdPoFgBsGlpKi7GC6gwkoQZHWeL97ZAlF8f/fQ1vZ6NdeKeQ9aB5eYPE9OmygHKJFyHD6wDgr2AetIia0cpQXayCNSgrfC2qYh7ftpaMc4uJcBkiocLESk2rgo/btCnOdKM2Ce9+bq6krKRNc586hH8rAASPcUtM77qHMDcYK7vLLPAIL/8eaNUlTptCoIYmrU0eBYjWRl1GYtc4lO/cqdrFCRLKwZTGEpNpVS4Yn8wKHb46I6gZQBhSTp7lGeAjEv7C0cXjlYg5uDR0CTgs5ekJIB1mK6RUcwcGqzuT5H8pkusqDO2ys7eWavnt69byp19mRCgyckcB6zz+YVp86c25sPrFfYOyfWzkVDLnieuA9ggWFGlWloGk+jBZX3YZRD4UKWrLEEdxnAYKMcTtN851e//v63v+nxjzm6Xk/j/YKM9YXtGTt07e7uP/bRRz/1+S9yb5crKsuNoApvfUhKophRJVLMG4hbO0eZcwpTowqD1RABK8nJZUEYcpRZVkMrLNOeTT/9rGuOHr2sSmZBMSWiUFDz0Yw3UjBeG/nAiRO3feFLOnUSdW5RFALXRmg7BMRbQHK4twmOc3vn8uRl+0ApuqeYdpmBpTUGBEvMD6zECS1xhxUr5fTuvqsB+sbLNw/oSMThLQ00+uTgylBnuKRMA2pcPDNjBtTAcqRm5CnbAYn0YXqWM064o1gOW7UwHnI13GNBxTr80LoshOnSJ3FjCup09wSsEmTwWud9uTMiV8qWsXPUGkdKmRfic0lTm4sELloGODkEEFTnhNluooOA5ZIAzOJlaGuuNUm1TrqE9WidJAx418RKeAw5O9hvkcYG4obepA/pO7BLC2TxoPr8a6kIra2g4JBxzFmZ+NgGW95CzglQBaoxFZM7MoV7rj64L4sRIBafiWZAI5XYZ2pobtQx+7Sx/tGt0+a0jRIVVBlwX2gEmkWNVKw4xNjEK1CDNWINAhreVjrSVvEnupbIs1G/QuVycBT6vK0TKXNAumaZVofGNrkPBdo8vrWmfQthuXvDWzFoaXCN4QBxzmijwkm6Ut3hgtdUUbRXWBA/N6C/2mpNz0jqWysA+gE21j24zJIb7UWDlhWLvm6gGCGy8eDjrWIXJyXr9V8t2Tew2douSILDnX38CrUa4EsoUxwI3uEAS5kMDr2fggvKbsP1VovUEJL13adkZ5qz9bMkPHJvOxFtTyXtk/V1GGmGrw+f5HnSD+OYkzqHE87QNnbYZs658SDPKTK8sX6ebCsJr7mVEQyPGv3ajtj0hw7T2r5E+lJnzhuAzQM3NLrhSFwIU5XVdHDYPeDG3lAnfYf5ah90c+zthL5PkByqu1S78siHbIBlAHhsh2x6mjC2LMNPhmjJt9OwkKPhKd4nhpstXHcSizZxGYLmvhCExb6CU9xQ8Ii8BlmlpUvsTjI6UneFRghkqZvGIfe4cINxhSqXj3KQmSBvWV1iwhLYAjMbeu4t3pI9pcWPlj2PRcqNIrCRP32zpAW1yDEl5GQ/ynNLmdanVdk5dC6v7Wo1h1qaYKYKDaxZ5jUuvSk3oRIBqy0Ugl3l0qYrPdTBCHmZyoFhC5BY9vfi7jYcdwA4jTXJDq8TMyOJ0O2cmlta9SV9YXAbjFSARo9qcDoqt8bea+qRO7C/seHTh219H0iA5UJD32NBf2TjlHIPJncam4je8m+AB9fg+Fwq7gjdYkqQNWGgp5eIWtYux73TXORA36fKTdB+k4yWzW3XhYpMbWiRaYksBZPZv9UQvI3V2ggJdSzE86XvLeWwK9m2VjUA4LZk4BgGgW3DRS3d1ozYxmNIc+PCNjpCaURnG3tlQt1woax+PuyjaSO1dBda/IRY6gjt/AS6rDxaZ0BiTagRfqaxYLn6+t3Y2y67ltpAO9iouG1vmYuhliWOgXIp07TTeOlhJYhj99DiNSuxeF45ksYN1V6FGxbCMPpq2uWySbCRJMZpfMcRC8hbtqa7ZnPE1MQfxUnIE8UhuJQRwrR1yN52ezQuA4uNBeH0RfAFGozB4Ysx2u04EKBccunmPmbbG9WSUQbwtaCoXNhVX/Nst+3BE2tWtS9f9qgdVtJ9JGUH3KIGzpeVdqo3kep7K+POVq9/ZZoOjDMxLisG5/Fcy1Jpi3adtyN+/jstdtzE9y1wh28pCUHp6SGoKRXAjRqcz/t/IY2ITnCjTaYAAAAASUVORK5CYII=" alt="" class="w-5 h-5 nav-icon"><span>Tools</span>
                </button>
                <button onclick="navigate('create')" id="nav-create" data-permission="agents:create" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAASz0lEQVR42m1aebBcZZU/v/Pd7n793svG5oIYAUtcWNywRkURsXBFFEUH1AooijrKDDgIiFtUlNIBHXRgym2mMguKU5aKKXRQoBAEghAxQgScCCJZyPqW5PVy7/nNH996H3bSye3uu3zfWX7ndxZ0OstFRAThnV+IX4HpJwj/yslIp7e/CW+SKH9hPCZFKBBQCKEIyHAKKQDJeCeEk4ur/R2qdOjfKBbG1k+IC2L8BWnp5a6YFkkBIEJAy+dSwn6Y5UAhAXgpkP6DqMAfU/zG/AGFcZlA1ZJ5Xn0SalwrvITBtEjkDaR1J0VEjQFQvxuS/pxwp7AKkiQUIsU9vD7EQDF4tTDLAIhbEmElgqA9IRdbkf+RUdpg+t1LPe6qPKIQorJIj8XvXiH+BUHQXyk4Fh+88ki0jSdog1IFVUtp1UhSj6uHP43JIpNjRD1AkJfKqOZgEgZC2k9B8hmW/7HtK+mK7A7xPAYTWrRqeYJ7ZuvPuverjmYITfsksv8HaTLYm/fL8hnwX2bIYPBstPcSRMxil4wyZSVPfPknQUCmh2SB+SOoPzOo3CsbKM8LrqmaV5Yu985IChiuYJSuFzGtwCsA6m0c4T5e/xSRahG6hfsBScCEBjD1BhxV4X1AoMGtATxhlwwnR1zJBkJQCIg4CoUWnhoWRyCiRdRgVHFCy+C41SJXKzxUiLQTf7kGd4VGv0FQhViyeCnNzCMjrW2U0UGSOKHeI9O+mfC68MOMYxEODNmEkEJGkEW5IA/KUohYEe3Mn+8kaU7CnikCvz2okAxgHw6jUXvDSBBl3oDT9UKBIoAwAAFhYNiiCKrkqCk2McI8EtgHaab9aJAtQjBCDoIK1SySHMwJodCCLflteD8Wy/7pQx6b+DhlEbej6JUQiGUYbbMAib4Ib+LJoINSoQlEol3nMAfnIgQByT1irBUDRAL0WBPQQjRGWEb7Vb/nyFtACERJ81EchW1VGZe9TXpXDFvSQH8Yfgqmm8wkniNQUQUgqgIFHFShAJRmJEVIawgTkjShwAnNPINIIVrMJCBfEQOSehDcIJgMAUhVwj7bS/fAEgXj75y+DyEMAoESAlVRB3VV1aG6UcOxsWlMaB3nep2qo9LUtTWNsKEZGSxJaGFlJJwTkmYAg/3QEAO4hxUGn/FmH7lQNBj/p1h9lDcJKIAUqqJPe0NSFXVadVl1ZwbjTr962jMOXnnIU1asWFaPx1u2Pv7HPz265/GdvV6n3+/Vw4GgEWtCnDPvSkywAxUa/ZoZuISAiYAlQkiSFaLLUyKCSVis3yVFA8QjBVCIPwEQVUAFCufMVf0V+5311tcdd+zRK5ZOD0f1zOwcoEun+91u5/cPbPrO967beN8DyyYnbTS0ekyBmImaCMUIMYloKpGAetRCINSJ/2WWjYnuAQKxHLw0gEwIXt5BC51ABE4EUIhzPhRAnXa69cTU2jVX9PqTV16z9obbfrPr4b+Ik06lnap6xtMPPvmkV5z86pf+8rbfXPr1Nd1m7JpRPRyIGWlCIw1mQgkfvdMzxDLxSEXzzCp+SYq4qppixEp4OPc44w+S5BXQuBnnolZURKAOnS7UuYnJbr9fG1/4nMNOe+0rnv2sQzdtfnzfwmjZ9NT2HbtuuuO31996z2lvOOHs009ee+vdCwsLlcLMRCySaxYEvsTtRVQTJeGJG8ioH/m9B5ZwsWYKpE4UIQaHTQpcBXUw+/X6+39x+/ob7rz395seO/LZh1909ju2zczes3HT0n5vsleNh8Nrrrvx4KccdP77Trv+V3ePBgPQAgfwpkgLviiReaCMAlxE7SBwWk1GWowQAcJSNdGi4BJQ0aiW/K9Co96Afq/TATlutj2+82e/Xn/Xg3/+p39873Dc3LXhD10QZv1e9+77/3jm299w47p7Z2dmnarFVDHFkgAp2V9LtpDjmsdHFR8+y2SAAWQytgaRg4kvqANUtIJzqCq4yu+hNjYGG406Vh840d14/0Nv//jlHzvrbYeufNrQRFSH43rlUw5asXRq+X4rZsfSdHrdyUntdlF1RFWCLCKXkRSU8mLQIjjiXDUZ7UdzdoKkSYVfvagoAM8UVKDiKlFVdXAuPhjodEUVQoEjadCXv/ioQw8+6Nqf3QIzUjpVZ+vO3Q9sevSSD51xyCFP3bp77tGtOyZ7HYEyBWMPiplf5AQ8IHuRRDhXTXs2j+y+aaPBogAVTbHWESKqUAWcKFhCari3iqKqqgXjt1efe+2Nd96y7nf7LZ32uDk1Ofnbex885ugjTvqbY153/Eu2ze576OHHOpVT52L9IoaqmMsjMeMi6fGKcK6aiqQrGB+DffuVazCngPcQV4kAGkyfSGoRAbTT80mM6/ZM3b6x/Wnn7CVnnbpjZm7dfQ+Jc0OTPfODf/jQ6cc9/znHv/uCjQ9v/trF53zv+lu6E73DD1u5fccuFdIaD00MFDCmbZFICHPBpPKMlQnkg2uW5RTGlDgWAMJNDHA+1YA3Nld5cVWdzsC4fP/l16w+96bfPfjOz1615pMfWHnwk3fOzL3l+GPX3rHhbSe+bNUnvsr+1Gte/qJ1v39o+8zC0Uc+662vP27dhoeWdoG6tqYWX6wwZeDYOXvOuSjgqmo6ZR6F+EVyHBDvXgGmFIgBGKpwlaiDBC4kAld1xnATK1b86MpPXX/H74469KknHvu8cy77zntef9xRhx/y8zs3fPmjZ7xv9VX33rPxjLe9dtXJx3/osu/u/6QDPvquk997ygnrH96yZ2bORkOra18agIA+vQyZXMgSUknJVcEHEDfhV685XQkmLoAL5gR4r4U6UQf1puUA0apiVVl/8if/8pmf3HzXV7517fW3r3/uMw7+yGmvfe/nrrp27c2337NxL/HBU0/Uie75737T+1ZftWLJ1HnvefM5p7xqott59bFHzewbbN68dW7PjHiumqsVMckuYpmX1xJhiAAiKqoi3l0jiikETqBINA4qzkmQunrzI6CuQtXZh+qHV376jrvv+8I31jz1wBVWNw8+tm3Vya+67sY7Rnv3Luv3btvw4MK4eePxL/7ct3/4yBB7ds78zy/X7RzUz336k0/4wGduvvHWvbt2STNmY7niQ6ZAQYoiV7pc1ZkOhQAPNdF5GTN1SX8FUCfOiWqwmQhT3vtdb2KmwZqvXLhl87YLLrv6wKWTZlyo6+99+ePf/NFNv7rzt1MdNxoOJ8Tu/cOmH/zvbdu27Trs2Be9aNXpW+57YPOjf5mZm/vZDbdM26geDljXCKU2ERKMhdQyQxKK0FWdJQH4WqkKI8XWnLJICMkxAKvnQqoefrp7BvU/f/bv+5W8/6Kv7L9kUhXbd8994oNnTEz2P33lmgOn+uPxmPWYZv1Kpyd63U61Z9v2lS97SdXtPHb77Tu2b597fKsNBzYeiTUBP1pkQtofKSLoTjypiGIS4JJSaMOJhihGUVEfhgF19Cer9vqTO+eHF59/9nHHHHHKBz+1pNepqmp+MD76qCOu/uy5b/y7zw9m90hdW93QGgpVXQBiV9XiJiYn6tndHC3UCwsyHlkzgpHW0JqQ5pNkQ3onplggsCKsynIIUp1Zc+WNZHDrVHL0tRBSzETR7XZ2zu5d9e5T3/zKF5+06oJJpxBpGmrHXXHROau/+YPtW7Yum+jUde0BkWZWNxATKKAKDGa202ppatZjWiMiFBNPm6Pz+owzHoawRYacOL1RFCVTW4AkA/BqrAvFV6fT2T0/eM2Jr/zYmae+8awL68Gg160U2DG396ovnHfXxj/9+PqbD5jqjgaDkF3TnIM1xobCml60ZmINrYGXt5lYrkSRY7JVI0qegFheZ07SQwmzKPql2rhXEBm3hqrTnR+Oj3j2M796yYfPPO/zWx7bvGR6SoAdM/N/+5aTnnvEYa8/5zP7TU/U41G6DyjWNGKNz2BCKmx+3QElGVkR2BRhF7HJkbDV10ZjSCvQlrEiHEJsKJ+Ez6QZVJ3T4bhZtnzZf3z1Uxdd+o2712/Yb8WyxprR2J55+MqLP/yu0y+8XBb20anVdcik/LPMJIWm8GWk1CSi5SQGEcu6vqqSEoVQR9VQpaDlHo3GyhrDdSDj5unLJICSbESu/eZl3/2vH6/96S/2X76srhsRGZPfuvT8y9f85P4NG/sV6rq26I4krRnTGtLEYn2F6bYm7SIK4IEud4CiGjNTTaVFZXbSlLKFSkDUojdMp6paVbPzC9f82xV33X3v1d/4zvInHzQY7Ov2ert3z339yxdvfGTLmv/+0f5TvdFgGLYdyzlivkZkgRbQfMSNRmHhVPN5MFNrLBmRdw5ftqBIhcU9gYA6oQqQGWyqu4g6Nzs7f+nqj8GaCy/+0tIDVozHo063t3vnnjNXveOo5zzzpFUXLO9X49Eg+qKv73obCIulx0EzocFnZF4PZknb8SDnCbHdkXpsrIJveOoX/MEoCl93KFtXFFDUYWEwfP4LjnzpC49807vOXXLA/k3TVM7Nz80f8/znnf/+d775/Ze48VAc6E0/8XhGQ6WQja+WkmFLvrIVc8tcdqC/qmjj5G4CIKRmip2dBsCijhPKeoGZTXQ7w+F439xeoXS7nbqxqSXT3778kxd86V8f+b9NE8p6NKQFfJRmLE3DuhEzkLQGZojil+gDwqbojDJ7IXK3J28hKlTbXcp2o8nSvoJFkrTGpvq9devWb/rzY9f++xV1Pd69a2bvvoX/vPqL3//pTT9f+4vl/e54sMCmYdOINWJGIxvz+0lgTwsW5Z2bNFpTOAwLx5D4fRR/Ai7SOTedqXSqBpSJMxBJrI8EpLHT7Vx3w60vfMGRl5x39mDfvtWf+MgjW3d8+vNfW7Z0cjQcSO5EFN1pitBoBkkiDyUq+L9IIBMAF5B29zzBK3MjujvxJMTKT+pQ+MZRTgxSxgMlIFDPnOfnF0448RVvP+Wk+x96+Krvfn+666xphEWTO3aCJTUtglkzCRtCX58DQIugFAUs0U+SZpBCis+Mu70DQ70tZ/EiomUFJZaH4wac83t2VXd+Yci6kapasmTSmkbKqYSWy6W3x3sg4aMvuJuJEIQvLbZtqXCJQGoYcNa3WVMZUoSkIvTUKKIhzqsWj0/1ezY2mu510O9RpBmNJDc7yLI25VlQpGKgBIxPflkexw/F/xZQk6kw7f0DJF3lplCMFkByXinJG9BirCg6fxSaNwCRopmXpCsRzpvYlvXrYGo7ZPDIybsVwJ9xKdCkROxEIFKlqkK+Hy0wCsRzvfGpRo5kcWDB/LlQjcMAJpY6I8Ys1xgac7g0/2R4CEq/mKUWrocrD4iQcp3iIdIn9ZN5+KQg1gl84AttuS3KVGfJDSC2k4dIGcmIOV5FvuzkT7ZI7oUhT8h18zjKIuJ7H8FkM1kKEAvSuWoyN3RjLbTo2iCO+0AS0sXmeorVRXzPz6ZYMcmB5Arx8WGLraEQv0RKq7Ucw9Yiu/KUztdGF5XeQ/E5zTy13SCbW4riCIV4AsHEI4nKTwqcNxRLQtNBINF+uHhwqYzKiQuKFaTIjxqUMxixybx4pCk4RtEtRtS+T/mbBt7UYurn51MSVqQ0RRCLhYF5eWbKEm0zubTkBKFPw2xaAa6c036aSEn5ceRuxSRTwY9AeUITtJg7STbACOEoR81QXJWGB1gIvsU9UzevbWxMFSPnXL9IieMucrcmZ8uxU9Yap8urKXbEaF9FnhdjFpincHIulgJ2mkfJWQRQ1lRym9jvujVuwzAOonH+jr5eJIXRhAZi2e5EKXofIwMUeMAtuisIDbyywhyPkQGtaNJLaqGSoZsWByIACCOM5vma0BXJbc74McdVLHa31j9oB6B0bNYGnNLTJGQLBUwib6bV8kBJ9hlNCGnGJbeCW/NhbXITB6ISzkAKcy+cDJmIZktjew8oV88C4bh4fBIozZahtOj6xWktytCeY1xs6MiTk2mKp3A4thwiFRnAwnqYQkHqYiTzLCCfsQORP2ZAqJitEGniNEx4MI1IMRSz6NtvqcQSn4WU1hVENGpdipFDT5tRtsCYUpXcAG6PuCIjaXG/RSNnaHU0mdBRoFrMwiwyEFoe/2xNV4J5gjGbUA4hLCYGkl1ZHszJZQz5K8ONzDKrUmpTmkkcpKX4yaI8UERa8mYUxYGonMQF4mhcEbvTCDJboSgvpqiLlGtFziSJBFnhWqduAq1RpyLUtdydkdUlU5IWmBSbFD7BfXKkl+QtMXGxkjjkaBAptIaZwZb+E/hWWDSuVQ7V+QnsVqUgtj1YAjlELI9SRRoQQwRaQZQ5Syh8w6JB5aInCn0ByUpZwBhkUSCLMTOvLPBYxMpwcCcm3hzl5AfQLZ4mbYIg7c6KZIYjwvxAtiJaO5QgnYtyRp1VHoBqq7xcIUpmQIsgY5LJRfRXcrFdsSDbOY4wkL1okmiRUMaWJIt5UoZkov36f35wZllthY/qAAAAAElFTkSuQmCC" alt="" class="w-5 h-5 nav-icon"><span>AgentForge Studio</span>
                </button>
                <button onclick="window.location.href='/lab'" id="nav-demo" data-permission="demo:access" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <span>ðŸ§ª</span><span>Lab</span>
                    <span class="ml-auto text-xs bg-green-500/20 text-green-400 px-2 py-0.5 rounded">New</span>
                </button>
                <button onclick="openApprovalDashboard()" id="nav-approvals" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <span>ðŸ“‹</span><span>Approvals</span>
                    <span id="approval-badge" class="ml-auto text-xs bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded hidden">0</span>
                </button>
                <button onclick="navigate('settings')" id="nav-settings" data-permission="system:settings" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <span>âš™ï¸</span><span>Settings</span>
                </button>
                <button onclick="navigate('security')" id="nav-security" data-permission="users:view,roles:view,system:admin" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">
                    <span>ðŸ”</span><span>Security</span>
                </button>
            </nav>
            
            <!-- User Profile -->
            <div class="p-4 border-t border-gray-800">
                <div onclick="navigate('profile')" title="View Profile" class="flex items-center gap-3 mb-3 cursor-pointer hover:bg-gray-800/50 p-2 rounded-lg transition group">
                    <div id="user-avatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center font-bold text-white">?</div>
                    <div class="flex-1 min-w-0">
                        <p id="user-name" class="text-sm font-medium truncate">Loading...</p>
                        <p id="user-email" class="text-xs text-gray-500 truncate">Click to view profile</p>
                    </div>
                    <span class="text-gray-500 group-hover:text-purple-400 transition">â–¸</span>
                </div>
                <button onclick="logout()" class="w-full text-left px-4 py-2 rounded-lg text-sm text-gray-400 hover:bg-gray-800 hover:text-white transition flex items-center gap-2">
                    <span>ðŸšª</span><span>Logout</span>
                </button>
            </div>
            
            <div class="p-4 border-t border-gray-800">
                <p class="text-xs text-gray-500 text-center">AgentForge v3.2</p>
            </div>
        </aside>

        <!-- Mobile Header -->
        <div class="md:hidden fixed top-0 left-0 right-0 border-b border-gray-800 z-50 px-4 py-3 flex items-center justify-between" style="background:var(--sidebar-bg);">
            <div class="flex items-center gap-2">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-8 h-8 rounded-lg">
                <span class="gradient-text font-bold">AgentForge</span>
            </div>
            <button onclick="navigate('create')" class="btn-primary px-3 py-1.5 rounded-lg text-sm" data-permission="agents:create">+ Create</button>
        </div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col" style="min-width:0;height:100%;max-height:100%;padding-top:0;" id="main-content">
            
            <!-- Agents Page -->
            <section id="page-agents" class="flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-6">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                    <h2 class="text-xl md:text-2xl font-bold flex items-center gap-3">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAUXUlEQVR42m1aaZRdVZXee59731CVqkqqUgkJkSGBEAQiCS0GMcqghoCNMoggLAcUAZHGhQOKChq6RWy6bSKK0VawRRoVBUQQ0calAssVMGEwCQbJnMqckHo1vffuOV//OOOtskjCq/fuu/ecffb+9re/vbmST2Fmij/2NfwLIna/MTEA4vRSJiL7dcTvEhGDS/cI77O9kJgAIhCB4L6N8JF9yXExTIzwZrgtAKKMiEHpw+3n7B+HuCb7jnuMXb39bviobAJOt+QeDYp3CLdhlE0GbzG/GBA504FAsM+zd8nCnfwNUqNh4p6SExG7n7DSxIBEJERgEtiFAIhLZCIQMzMDRATYzQNufwwu7Qf2lMHE0aBuh5nzA2ee1GJhw8TW2tHeHHfjnILJOyIA71b2LyO1gFs/MxP8yp33WHMwkfFWY45nYX9hLjkM/Akg8elxPkvuKc5PMO6cQMTRLkzELDTOb8Je/F7B3jDlo3Yuyi6GvOMTUue0BvFvZeOXHCIW452YmJE4OgcjkTBHB/QBby3lwpR9wKO8GgAE7x3228wghj1IH9HRNZBsFbAxEA1DqbG8A7g7u9Vz2CISP/FL57AvZ1175hwQpmwRayMmhsAfsffl4JL2NEy6bmaGB4ks+vuEH2828U7v78hsl+ts5FxMkhgl7/3kg5i97xNZOE78yoYyCQNgcIxQ7wYEsTHOzo0j6Gbjlhxs7A0g4OSI3AUMt2n2sc4hcFG6ld0qPAJw+RQESf5AYnWKsO9vj5BD3KUhD/wDDA3nX4pw4giEYfXBrxxaOcRyHsoJyDk0stEV3AMEDjYCQGzPzB4a3G2JQcZeZ9wxgpnZbYA9UnnPhAgl9uZgzhjNRCTOYP5/ZCGIhQjWZxKYATMDhgxKDstCAMMHJzOTgTHsbQSX+cA+wCSJJxCy5Ei9M4R1h3wcchm7oOJo/tRbmETs9/zzrL8aIgaMBRufvUwC3WAPMCCxXucDxbkzQo5xDxTAsA/iMnD7lXtPAuIZMJGwPwR21zARkQgzkzCzIlEkopQAbAAhaK3JaMAQyP5LzGR0gu4BMK2bMdiwC9txecAldntdVspHgZ4Re+rB1tDOowN7i87jj0KERIgFLJzlJNIYGaNajVDQWKveUSdTsAHBAIaMIRgS8dwIkQ06RgAX4vYCi0eM6A5w72XWhA6anN8ySjlhwnLja3sUYokNs5AoUgoiulL73HUfO/kNr2emP/559Td/8L+VQpHR0Jp1QUxgImMJLpgJhjilk2HtzI6buOWYhNQCANeqUykiekBGCaELFvYMIvgM2ygXIlZuh8zEipWSSmWM5J47/7Xdai+/+2cqyz59xSWN4ZErP7WsQ9gUbegCumBLpwHAEMAAjOVAhpjIWC8Bh+xr6SAQqRKMXUIpCbA3s/cacQeCeBosQkQkTKJImKzhJWOlVF4ZHmudvfT0qT3dH77y8y++9PKq59dcfNXn5hw28/Qz3zLSakuWkcpYMogCMbGwKGKBezITi0/lnGQSKhk3+C1Iov2ImcXa3oWwXai9MbNdK7OQCCmBfRgJibBkJEKiOMtgaP68o/64eo3q7JjSO7m3d4pI/qdVa058/TEGJHlGIqwUiyJRYCFiFiYWeARzwMDWekQsxILou8wcQUYoZQSeI5BL+naJMXqJGSL2jixCzKyULQxYZaQyQ8y12kuvbl38T2/Qkh0szP5m02Tq1JNOeH79RqlVYU0uipUSlbEoG/puS9Yo4Q8Fy5I/pZBp3SJVpjpCBrXJ3IWCxO+TsMtQzCTCLMTKeg6ziMrIPj7LSGW58Lp1ryx965vOPvv0VwZ2Te/v+8YXr925Y9c377qns1oxLKwkJES2wIWIbgn35ZT1xURF5RqxVu0HS0rIPMxLREyLMCFPSaaynEVIFOxZiZDKqGgjyyuz56rZx7YO7r9yweEXnH0Gi9z7i8fu/suG2iGHtl9Z2960no3hvIp2i2DEVm66gNa6KMgUFmQZtoYznhrApzXD8VcQjFJZZ3C7YH5LJRxoisuy7rglU1k+NNpsjTZbba3zvFqvgwVjo+ro46qLl8iUqdi1XfbsePKR377uqCO27Np369e/09VZgTb5kXOz1y+kZtPsHqBqVSnVbLVHG8OtZqulTbVasQDPFJYbaT4DEQZ9kcPMmXdwn7YS8B9fmwmzUqzyoWbzzLPOOGPxyaNjzZ8++uT6v23omtRJZ76bpvS3nv099uziLM86OrIpk2uVvF6rZn29NDJc7Hyx/ddV3D+jtug0OfIY/cwTjaGR2UcefvG575jc3bly9ZoHHnq8pnKxOcrSZ2PSCiYw75AKQBAfAEjCw1fDHnl8fAurbLjVvnXZZ7943Ue27dhdGNy3fNl5Zy0embcgz3P98A/Na/u4c5J01PNq1YiICDMbbVSeU73OnV20f+/oQ/cKMDb/1DMWLfj5iq8RsPZvG97/niV3L79Fs9g86GwqSbXEE7QGYlvQwNfpIWyEo/7hD41ZKTU8NHLOe85666KTFp/7YdNskaGHHv/Dj++4edW1N+/+68p8cq8hEiZWak9jiJrNPYON+tiYGRvbM8g99Sq0RqVKWd566jfdvX1f++5XP/Hlbzz96yepVr3ne/c9/LMVV3zoom8v/35nZ1VbrkFMImQMgRLpCT5LgRLUD+VbzAzwRZavVwTt9jtOe/M9DzyGVrtv2tSpM6e9vHb9X9a8cvzsw0ZHW1meZ3neFmkU5iMXnfPwD75+1ikL37rg+Efu/vcrLzl3yHCh8qxWyav5UJsPnda3fff+p599qXfWzCmTu1S1+v37H168aKFHOQ+AEf1TqSt+lEWxChSkI2LH9dkCv/uKkKiDg0Mzp/djtAlQYYhYZs2Y9oELz35l68D6rTtJVE/v5F/cdgMM7nrwt2s3bte6mHfYzKvOf8f5Z7z54i/8x4G9+6jdOuKoWVdd+u65R86iWnVUF1UWPTwyc+b0g41hLxnZWDBJ/R6JntsJiJhUlk9KahFfUglH1mARyQJ/lm3asfsrn7l63fad6/6+qUn0yWs+cNycIzZu2X7DlZed987FB4ZGbr760m079l76yVvWbx0YGx0bbgy//PeN9z/4xBtPnPf+c04bbIzc+YVrPv6+f960dYcxOHnBcb995rmRoaFFpyz8ymeuuvn2FXt27lbCcOELK9LA19Sp+udq1Wr9EOskwuJ4JTGJxKrFZkpRYFF5ZaTVXnz6W7786Sv37d1fq1baBp9YdsfA5u3TDj906dtOOef0U7rrtbM++rnJPV1BQRFiFjkwOPirby/L8vyxPz37wON/GNiwubNn0vIvXXdo/5ShxnBff99td/3o8V8/OamSFc0moyBH78Aw0AAZx6otngKAthuYEVAKllHamkuUTQjWBnYDpFReqTRautrdNf/EE8YMXnpuda1er3fUC4PGrj0r7rxl1boNK378UO/krqLQYBZhgDOl9h8c/NjF5yw47pirP7msa1pvbnRzrDk82Jg9//juav7y2nVjjeFJudKtFnRBRjMMYJiJDOxmnEcZR2MJmkASiyBKynOvJjFzqR4A6UJ31auqMfj87qFXVVc3oSKqaLYyJjW194hD+jds2yGZgvHiliGGgTGi1Oad+448pD/r7VFAu9VWonoy3jV5xprBthoamlSv6kIndWwsxiyTZg4lTSQY4i9FpCIuhkK9Ck+H3Fd1ocmYST09NWFTFDDapnc91hoaGZ06uZsKHZIPfCiSMX09kxpDw8XoGGtNWhutdaGrjM7ubhhjtLEqhZdMrFznFD6eIIvZrUhCmEATGgUoqfilz4vREa0ytkWJgU2cf1y99sK3n2rGmplSEgQ0YaXEjDXf/bY3/Wn1Wiq009ktq2HRzaZTLqxyBRPr3yjxOypX1qdZOJAeDt2KibuF+yr82SmFgweyjm6wAACMLorOzvoPH3hsxtQpF12wdM/WgUJrYpZMaea9A7suPG/JrGl9//PgE51dncZGJ4FEpLObDh4gyShZt6c0VsLgMgFNLQmV5V1IavMoyXk2aismd0evF7HK0BzNTzip2LieCs0shpBXKq8dOCi16u3Xf7Ta1fni+g37BoearWLypPp1l7/3lo9f9l/3PfL0n1dNqld1q03GsDbIc3XsicULKwmGANIaxnj9GY4hwHCi5jIHngAiyuBh1imOzKW+Erxr2dtZuQZEItQ4aF7bVzluoVn1DNXrKlP7d+/78Ife+4UrLlnysRv+5bLzfrH8pn0Hh4hoak/337cOnHX1l37+n180Ret7/31/39TegplGD2YnnaoHD6DxGlVrpDUJEwlpDXs+ltSwcQ7nQiMs3om78DIEl9V1+BwN19ixorcVm43hSq148dnGrKOp0aDC0Fhzybnv/OaN1yy54vPPr157+YsvHzprxjGzDxdR6zdu2bJlOxFdfP0tT3zv1oHtOx998DdUrdLoMGme9MJKznJoX9Fb1cgpowDF/zxOGiQNmSxIpVH4im0JnzLYuLsZ41pHRpPKGzsGLlk0/8y7bmu1Wn9Zs/7Gaz542We/9vRTK6f0TQGwb/e+32/fBaJ6nk/urCuRlStfuPhT//atm66bOqVn4bFHdXbU//D0ynufG6jnFdYaBGhDHtPgewcheTmdwsu6dkk2E0eu5KszX8Jb51PKaakiYGGllFLDzfYdt98057BZK+79uWTZjdd8cOPA7vdd/une6f3tdjuoqggYB6pU8n0Du1Ys//LbTj5x2R3fHx4Z/cAFZ+9/7eBV1y+rKTFFm4yG0Qxy+pctykxAQlhOYcUYJpBxypzVjmJjMPS70o6G12ihhIaHRt6+9Iz5x8w57V0fIiUE/tX/PfW7++5846KFq19c11GtGG2IvPwJx8+GGsPzTjjm+LmzT7no4we2bCNRD//kl0/88u4Lz1/6kx890NlZMwHonIcYDh0CpMVAdGxJy7dSpzNqScQwHBMCCECz+eY3nvjo755SRbuvp7uvt0cPDj/30suL3nBssWc3N0fJaGMA+wcEbbg11ty75+T589a+uvnAwO6pU/t6uydloh549HeLFp5ARcGRARhYImTC+Tmf8n4CL0iSeGIKjly71EUjsotwZwoYGEPMm7ZsP2HeHD00PNYcGx4ZwejY0a+bsWl/o7L0vXzYHDCjOUojDYw00ByFsBw+Ry05f/PBkcOn91G7OTw01G63isbgguPnbd42kHoIjGHX2bEd4iDR2TrekLWKdZVqbTolEpDvXKhQB7tszUlUiECUqtQe+cl3Hv/9M9/94U+zLPvMtZcfO3f2BVfc0HH0sdnsuVzrNK0mRkdYmCtVqlTRahUb1w+tfeH+u766bWD3stu/1W4V77/gnI9cet67Lv1EY+/ejElrTcYQdCSeTL4i840/eFpKTlaZBi+cJFlMBUmdJXMxL67VxyyiVKtA34zpX73p+kP6+5SSVzdvu/G2u8Yaw0q3YQx19XBXj3ROIhaMDJnB16hxUES0KFWt3HrjtXNnH9ZutRvDIzfeeufWDZsqilEUTkpBwpwjBBnPCeCg1jpOrdoPl4BDv4iZGRwbME7JsL11WyGAJcvahtrton/WTG3M/p27qh0dmVKGWIRNAEQiq8OBhaCFqNBmbHik/9BD8kwNbN6WZaqaK90uGNqFo9HRxlbl9anLcuwY1DBcq/Y7ITHkYFYOVcVRPae8hnaTF+2sPNjWhlnleaaNRiIMM0eZ1aGeL8tFpNlqE0wlz2C0KTQRyGgn+hvt4JLKGcA2R0LzGyBGVm5wc5CQ7P4QGkvkpDrrha7SM0abtj2poqVtLR1mEcZDgW28woBgClIEIuh2y0OMAzqGAZWnL2w+MfCdKL8BBhNlPkv7sHdMioiIjWV3VrtkGJBLyQTWxMK2wwICGXbCUzyrBM4jO7SWi7Z0DRoLLNEzYlsmZEH/b1JyWTaqOtLxmURA5TDBwezGMkJKYUeuvDZgl0Wxoeor2oCFYTOgVNy0la6rdym8hqfWXgP1Omlg1ZY2AFnCfYJ6FIdRCKCS6uIYHgBmAUCGiDUr8W0hf2m0NwXe4toqsTPJHl5AwTGQNvLCVxIT+A6UlUhVlnWkPfokXku9eN828Eoql6Z/AoUNLpCOXjCIyDgvZ8dlOHiFhXmg3FlnL5yE/h84+I8PMXgXigUxBz0MIJI4IsZJ191p2ZHGhnRvh5fGBTB7ISSt79g3G8eHCryNieLqYwcbSZCCAKVUPTh37N4E7ImN14Tthd2mEFaacCKmMMwEjkwdHBeM0vpSvkYhEnwR4JsD6X7sj8pURyo5cnoIVJqLKI2mJE185tIIYArJwQfSWR6U1p3U2Rj3JhJUQTK04Yoz+zSVqQ4kEkhqcSrX2HHQw1dqruhMJq1itIV5pxgYSddinFbgKb47ZATYQph1odJoUhSr3QmUJ2qSAcO4AaSO4gM7wBkj8QEu2zbJSChnKARinzQAwFHNSt+cODBFBF/QUOjH8oS6gG35Y00hsfwJQzlhWsDuCUHTIzhBId2SRd6w2UjxA9NEkk/t3hBpXGoaInbzQnESMEx2+Jm7pMkRbMy2TjJRdQo+Dv4Hk5tB60D5XST4E/INp4JacqyweMDlaRvKgjHTwc70CX4OLp13JcAQC8HEOVzENnRwd2YuBWBJVSsHsRcg/MPghRwOsVCaUfNgEmCUE16QCFspmvL4JtUEBS+tXuExNOJpYmJKhpgD3wzRgXGDoH5toAkGUErqJbRMGjWcAGjILuWrKMmcE4ZAS/MzmNDB9nnAkgtKVLe4OfjUUQYwjlO52biZ6ZJZ3YwOfOPSTJRM/XKQdIE4DWqa8HQPOxS4U5iqRKSftmGczmtG9PDEBkycpXPiiaMT0lGzdD543Hpi7gghDnjmkcSiR/eIyBNyWeJQMn7TXBrkRpR5s+S9f+AYYYIT4wf0rYLAHq3GdXHLHs6RTLITHlD+EGlYww9VW+MgyUtxCt/f4f8BNWc7mkl0R90AAAAASUVORK5CYII=" alt="" class="w-7 h-7">
                        <span>Agent Hub</span>
                    </h2>
                    <button onclick="navigate('create')" class="btn-primary px-4 py-2 rounded-lg hidden md:block" data-permission="agents:create">+ Create</button>
                </div>
                
                <div class="flex gap-4 mb-6 border-b border-gray-800 overflow-x-auto">
                    <button onclick="setAgentTab('published')" id="tab-published" class="tab-btn active pb-3 px-2 border-b-2 whitespace-nowrap">Published</button>
                    <button onclick="setAgentTab('draft')" id="tab-draft" class="tab-btn pb-3 px-2 border-b-2 border-transparent whitespace-nowrap">Drafts</button>
                </div>
                
                <!-- Workflow Agents Section -->
                <div id="workflow-agents-section" class="hidden mb-8">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-xl">ðŸ”„</div>
                        <div>
                            <h3 class="font-semibold text-lg">Workflow Automations</h3>
                            <p class="text-sm text-gray-400">Automated processes and approval flows</p>
                        </div>
                        <span id="workflow-count" class="ml-auto px-2 py-1 rounded-full bg-green-500/20 text-green-400 text-sm font-medium">0</span>
                    </div>
                    <div id="workflow-agents-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
                
                <!-- Conversational Agents Section -->
                <div id="conversational-agents-section" class="mb-8">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-xl">ðŸ’¬</div>
                        <div>
                            <h3 class="font-semibold text-lg">AI Assistants</h3>
                            <p class="text-sm text-gray-400">Chat-based agents for conversations</p>
                        </div>
                        <span id="conversational-count" class="ml-auto px-2 py-1 rounded-full bg-purple-500/20 text-purple-400 text-sm font-medium">0</span>
                    </div>
                    <div id="conversational-agents-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </div>
                
                <!-- Legacy grid for compatibility -->
                <div id="agents-grid" class="hidden"></div>
            </section>

            <!-- Tools Page -->
            <section id="page-tools" class="hidden flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-6">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                    <h2 class="text-xl md:text-2xl font-bold flex items-center gap-3">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAR50lEQVR42mVaa8xmV1V+nrXP+37fNzO9TAco7bQBKmgNtwClchMRAUFAioBVlIJggpqQcgmYECVEQEOieIshoiYm0ER+WISSAsGWqYIpBRMJRg1IUi7pgIW207l+33f2evyx1t5nv9NJO/NeznvO2uv6rGctbm0dIQFBABkv43/Ev4xXzH8BKT8jwPhYiu+XzwGAAti/yxcC4ADbMxRfaXgd35HMj9udlj9NSkFT/DAvUBcOwyn6jyBAEhl3R74jSSiOLwnxFoQBENsD44gkZMo7SiIYj/R+WcoWWovHUAjJuOiXAMFpkQ4byhzEZugjpWbJ39NAKs4c904JOeosjoFFpiY62JQVOre8Z0ooEFToFgQ9T6Bu3HjCNEo6/psCpQ7YLNKlM5BNdBDMYzcfBNk1modpjqS8h6v9sh2uGQbez9sO27SqDY9WOwAXh1fTXhqMgkgClEQaUqimYjaPh8XvSVN3vri+X5uOFIc0dodNx0m3ZNxfItO7l/tluKpH29SsqDxiuGAqNq63Jqr1i9TCFyBpmQLimnDCZpnmBSn+YOL4Uuin6raRkFpTu/lmkAo9IUxNN3FydL22dwZJEGmgDfbj4GfLgQHmVcznESYKEhcfC0G0+EK6U4gWIhKLLN0KYRQtDx9ioOfAfhYC1jRB0NpJ2SWX2pUtiLWk4h5U8Z5LeHSxMs2GOZnJdPz1EH4i6OCSnvLPhOa5S66kMQ6bwWBNDnYH607NOJgAIyM5NHkyCZCCczM/RMyAgjzspq5FOYfCJIjhLpLSN8JM+dhp8dAlCearHgzNn22pbmRGqIV9msQkXKnQSItGuPcqkvfVUL/Orz3WnujKAoANi2W68gidKfWcOZHKYLIQj8vBTM1tsnS1IIuzhXSZXdEObySIYqlRCJJC9QDlFOQaqpRntQRpxgwVb5mZITeIcG8IE5bC2bIYw2iREtJ/NCQdLGFastJZ3MJIw5I5jcbFXyXIW3oXJZnRAfNelkSD+yYOIEFl6KbtpVYrgCmdCqMnWQZcSj/iiY5zSqt0kVtJa6FCg/XibUvQyeHNueMkarjHAImKDB+qVQt5gUv4p6RhewDUpCFbNdHJdPd0bgmUQCPb8TI1USRo4f20otA4jTSaiTCy0Ko7ISPn/X3I4QY55PDw+TQ9JGaIquEyQen+AklvZ4i3nAgOXpVnyHzSEAItIwS0IY0aMhhsSb5maY2yQimllLN7e/u7dXXhof29GXt7F2wf8N2zgEugg0aJkkeagREuUIDH/QSLTNX8sCM6xRGnFDeqc4ZDpu1Weiwdo8PrpmMQMIPZkr1pMMO0AqeyKqf2/eonPuHdv/3aRx29dH9//vhn7vjIxz55CKh75+gEKXeIFOEZvjTIvXmBCMmYvhcBxDHrs0zToQWHpdDWMybMIv/kYYywtAPNUKa4ADSwsBjLxGnitCplOlv9KU9/yq0fef+xr/znRz5+63/dfc/bXv/KJ179Y5+846s7pciHFgSZPEJIjkUpMz6zRDEzOBOYkds7j2yA2Zo3mzigg+biG6LHV1YI0orMANAKpglWWKYyTadYjt30oZtvu/NDf/HRAxcdPLu7d+jIJf/+Dx962wf/5nOfue0gve7tep3hFRJqBVz5IhMupPyw/5eB7VL4WAPrCfcTDmjAkhzyj0GMc6rHgzHMaqt12dqa1lurra3VemtmedxjH3PxBQduuvWOSy572M7W6pGHLzj5o/s+cfudL3rWU5xltb1TVutpWk3TilZYJsAY6T+sit6ZLTW0Y9duuWmBIkNn1qEDIqtmYKeLZ0BbyXRkhWXianVqz+v+DHOsDOLx+0+eObe3s5rO7O5PhhkO6eDO+u7jP/LTu/dBvlcxO2o9uI4AKxQDMGRFy2Q1luIGkVpDOjWYwAZCDb2TaM5HM8GyBct6NS0eNU22Wu9P6xc+79qjRy+tIsxodnp37+GXXHTja1/2tg/89cMvOri3t3/06KW/9pLnfvifbr/+ja8+sF7JndT9P7zvn2/7Fz95KqoyEImIZEEhKgRPFEGDHHlFwvBJHUkuRWqEawyVMzNMs0MUByOtTKvVyd35da966e+/5Ya7vv7N7a1VKMxrvfNr3/ifu49vba1dAg3VP3bLscdd/vCrr7g07n3u3N7VV1357Kc9/l2/98cXTGWeHU5wXpRoBU6gprwKmyxoYmqoJmHtgoHZ2zgQEcFIxSTssZZtrXp96hOv/vjnvvTud//pdOTi2T2AjU3TZHZoa+0+F+r0yVM3vu+vBJM7VEno5OmXveYX3vG6X9RqLT/XkIBRkPdjhFcZmuIDukV9m1qsjN5vrYUlQC3xPQR0pCwrGdDTtFt9vV5Nhy84cmirZn9C0STVeYZXyQke3t4KJkBeCnHCcHBn68zuHkqBDGaoNV2cbFmUge3TfXpPo6WpTw/R2N2oEz9qJcbyPGap+mKwAivIylZmm6p79WR1hMrOqbBAqF6T7XHBMFdJMDP056QePStruH9rkRsSWhqbCWZDhY3eYgN4pvfT5FocyQpLKdNkZVXW62neG3JviRY79JxtmpE0uNNAgWYQDJpmmRmHStoSSmDu9jc8mmMOfAFJyKfGlLAjqmyFezmMYjzg4oAPZZpOnN1HwWTTfHp3331lDq8tCcYDApJbh/hmE4AfPXiKVkrhfHZvFtwFK2HYSBtw7zoONioZrrEFBwBOWS00wCQO4DlQky2IraeeE3v1upe/4A2vfvHFFx763Je/fsnFF54+eRrV5a7AxraQXMp0XESenuvv3PDK655/7aqUf7z9y2fmur2e4B4RBYqKvqojMbXsmcifNCkL9tSIl0Dl2ZQRAxOq7HTSuDQr5cHd+b2/++Ybrnvhn330U/93/4mXPffpL33uNTd+8O9Kgdc5Erkq2K0HmtGKndivf/u+tzz+qiv+/KZP1+qveeEzn/C4R/39zZ83n1migTbBw50aVdQCN0MXLl+Ytu2DVy7AIdQcxEjWWmNEGAvNYMWm6WzV055xzc0fft8zfvXt3/3Wt6ftrUr7yauuPP6DH9Z5n40sjF9ZKeG2U5nuP3P2V17+s+958/VPvv4d5x48weplvb7ysiM/uOd42dv1eR/zvuoMd7mn1iV5ldf2iZAWzgumyG6JC9CQYOtfFzRB0kyAGefTu6/4uWd++thd3/3m3Zc94vB+rbDynW9/r5QykNqMRC3UBrQ079eXPOepH/vsF8+ePHnZhQfnefa53vu94yt4KFtaqpAUoE0Ln4iBvUyYqoY0E2lnrYJZI4KUbbwtdkR1I+d5hly1BjAupdjIOLggJyB3rzUCA5JLRsIXTvXcfp0dCTvZDuIVUQ0bE9AA0GYWStV2/n4hSRsUTdrH5YiOyd3L1urWY3e99HnXXnLF5d9/8MyD5/Z/eOrsoUsOzyzjmCBDS4JcXr3WyXjLsa/8+kuec+jiC+954NS9J8+eRXn+837q8CMeNrtCc1lzWq0UGhPaaHdtUNFWpvVF2ciMoZs9rkXxSgjUauDWzs43v3PPVY+58g9ufP29p3cfcemRd/3ma/7knW/61vF7v/bf/7s9lY7ge3ECKWFna/W1b3znyVc/+j2/dX0ln/akn/jAW1//G6960RWXX3rzZ/91x7K3TJYr7rCQ1EnrbpD1UJnWFzXM3fFcVKuSCCKzG/plArbX61vu+OrsesN1z//5Zz/1G9/9/r0nTh05fNFnvnDXgZW5N4s/RJT1ZJ+4/cvn9uZX/Mw1P/6oy2/69LFb/u0/XnDtkz76qdu2NGvez85R3e+VCdU9O7JF/4LA7YNXtCpsDSFHqi1gyU+sJJSwIgFWbLWKUsD11oEDB07fe+KP/vCt02r9zvf+5eFtq7UuxE6LLpqJFknugVPnkv85c+6Xb/ilN77yBS9+3dsvrOd8rvIKSV4TCdUZqgDkDq+ReRA1PrJQ9uKdPoFgBsGlpKi7GC6gwkoQZHWeL97ZAlF8f/fQ1vZ6NdeKeQ9aB5eYPE9OmygHKJFyHD6wDgr2AetIia0cpQXayCNSgrfC2qYh7ftpaMc4uJcBkiocLESk2rgo/btCnOdKM2Ce9+bq6krKRNc586hH8rAASPcUtM77qHMDcYK7vLLPAIL/8eaNUlTptCoIYmrU0eBYjWRl1GYtc4lO/cqdrFCRLKwZTGEpNpVS4Yn8wKHb46I6gZQBhSTp7lGeAjEv7C0cXjlYg5uDR0CTgs5ekJIB1mK6RUcwcGqzuT5H8pkusqDO2ys7eWavnt69byp19mRCgyckcB6zz+YVp86c25sPrFfYOyfWzkVDLnieuA9ggWFGlWloGk+jBZX3YZRD4UKWrLEEdxnAYKMcTtN851e//v63v+nxjzm6Xk/j/YKM9YXtGTt07e7uP/bRRz/1+S9yb5crKsuNoApvfUhKophRJVLMG4hbO0eZcwpTowqD1RABK8nJZUEYcpRZVkMrLNOeTT/9rGuOHr2sSmZBMSWiUFDz0Yw3UjBeG/nAiRO3feFLOnUSdW5RFALXRmg7BMRbQHK4twmOc3vn8uRl+0ApuqeYdpmBpTUGBEvMD6zECS1xhxUr5fTuvqsB+sbLNw/oSMThLQ00+uTgylBnuKRMA2pcPDNjBtTAcqRm5CnbAYn0YXqWM064o1gOW7UwHnI13GNBxTr80LoshOnSJ3FjCup09wSsEmTwWud9uTMiV8qWsXPUGkdKmRfic0lTm4sELloGODkEEFTnhNluooOA5ZIAzOJlaGuuNUm1TrqE9WidJAx418RKeAw5O9hvkcYG4obepA/pO7BLC2TxoPr8a6kIra2g4JBxzFmZ+NgGW95CzglQBaoxFZM7MoV7rj64L4sRIBafiWZAI5XYZ2pobtQx+7Sx/tGt0+a0jRIVVBlwX2gEmkWNVKw4xNjEK1CDNWINAhreVjrSVvEnupbIs1G/QuVycBT6vK0TKXNAumaZVofGNrkPBdo8vrWmfQthuXvDWzFoaXCN4QBxzmijwkm6Ut3hgtdUUbRXWBA/N6C/2mpNz0jqWysA+gE21j24zJIb7UWDlhWLvm6gGCGy8eDjrWIXJyXr9V8t2Tew2douSILDnX38CrUa4EsoUxwI3uEAS5kMDr2fggvKbsP1VovUEJL13adkZ5qz9bMkPHJvOxFtTyXtk/V1GGmGrw+f5HnSD+OYkzqHE87QNnbYZs658SDPKTK8sX6ebCsJr7mVEQyPGv3ajtj0hw7T2r5E+lJnzhuAzQM3NLrhSFwIU5XVdHDYPeDG3lAnfYf5ah90c+zthL5PkByqu1S78siHbIBlAHhsh2x6mjC2LMNPhmjJt9OwkKPhKd4nhpstXHcSizZxGYLmvhCExb6CU9xQ8Ii8BlmlpUvsTjI6UneFRghkqZvGIfe4cINxhSqXj3KQmSBvWV1iwhLYAjMbeu4t3pI9pcWPlj2PRcqNIrCRP32zpAW1yDEl5GQ/ynNLmdanVdk5dC6v7Wo1h1qaYKYKDaxZ5jUuvSk3oRIBqy0Ugl3l0qYrPdTBCHmZyoFhC5BY9vfi7jYcdwA4jTXJDq8TMyOJ0O2cmlta9SV9YXAbjFSARo9qcDoqt8bea+qRO7C/seHTh219H0iA5UJD32NBf2TjlHIPJncam4je8m+AB9fg+Fwq7gjdYkqQNWGgp5eIWtYux73TXORA36fKTdB+k4yWzW3XhYpMbWiRaYksBZPZv9UQvI3V2ggJdSzE86XvLeWwK9m2VjUA4LZk4BgGgW3DRS3d1ozYxmNIc+PCNjpCaURnG3tlQt1woax+PuyjaSO1dBda/IRY6gjt/AS6rDxaZ0BiTagRfqaxYLn6+t3Y2y67ltpAO9iouG1vmYuhliWOgXIp07TTeOlhJYhj99DiNSuxeF45ksYN1V6FGxbCMPpq2uWySbCRJMZpfMcRC8hbtqa7ZnPE1MQfxUnIE8UhuJQRwrR1yN52ezQuA4uNBeH0RfAFGozB4Ysx2u04EKBccunmPmbbG9WSUQbwtaCoXNhVX/Nst+3BE2tWtS9f9qgdVtJ9JGUH3KIGzpeVdqo3kep7K+POVq9/ZZoOjDMxLisG5/Fcy1Jpi3adtyN+/jstdtzE9y1wh28pCUHp6SGoKRXAjRqcz/t/IY2ITnCjTaYAAAAASUVORK5CYII=" alt="" class="w-7 h-7">
                        <span>Tools</span>
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="deleteAllTools()" class="btn-danger px-3 py-2 rounded-lg text-sm" title="Delete all tools">ðŸ—‘ï¸ Delete All</button>
                        <button onclick="cleanupDuplicateTools()" class="btn-secondary px-3 py-2 rounded-lg text-sm" title="Remove duplicate tools">ðŸ§¹ Cleanup</button>
                        <button data-permission="tools:create" onclick="showToolModal()" class="btn-primary px-4 py-2 rounded-lg">+ Create Tool</button>
                    </div>
                </div>
                <div id="tools-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            </section>

            <!-- Tool Detail Page -->
            <section id="page-tool-detail" class="hidden flex-1 overflow-y-auto p-4 md:p-6">
                <button onclick="navigate('tools')" class="text-gray-400 hover:text-white mb-4 flex items-center gap-2">
                    <span>â†</span><span>Back to Tools</span>
                </button>
                <div id="tool-detail"></div>
            </section>

            <!-- Settings Page -->
            <section id="page-settings" class="hidden flex-1 overflow-y-auto p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-bold mb-6">âš™ï¸ Settings</h2>
                
                <div class="max-w-4xl space-y-6">
                    <!-- Theme Selection -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold flex items-center gap-2">ðŸŽ¨ Theme</h3>
                            <p class="text-sm text-gray-400 mt-1">Choose your preferred appearance</p>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                            <!-- Dark Theme -->
                            <button onclick="setTheme('dark')" class="theme-btn group relative rounded-xl p-3 border-2 transition-all hover:scale-105" data-theme-btn="dark">
                                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden" style="background: linear-gradient(135deg, #0f0f17 0%, #1e1e2e 50%, #667eea 100%)"></div>
                                <span class="text-xs font-medium">Dark</span>
                                <div class="absolute top-1 right-1 w-4 h-4 bg-green-500 rounded-full hidden items-center justify-center theme-check">
                                    <span class="text-white text-xs">âœ“</span>
                                </div>
                            </button>
                            
                            <!-- Light Theme -->
                            <button onclick="setTheme('light')" class="theme-btn group relative rounded-xl p-3 border-2 transition-all hover:scale-105" data-theme-btn="light">
                                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #7c3aed 100%)"></div>
                                <span class="text-xs font-medium">Light</span>
                                <div class="absolute top-1 right-1 w-4 h-4 bg-green-500 rounded-full hidden items-center justify-center theme-check">
                                    <span class="text-white text-xs">âœ“</span>
                                </div>
                            </button>
                            
                            <!-- Ocean Theme -->
                            <button onclick="setTheme('ocean')" class="theme-btn group relative rounded-xl p-3 border-2 transition-all hover:scale-105" data-theme-btn="ocean">
                                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden" style="background: linear-gradient(135deg, #dbeafe 0%, #bae6fd 50%, #6366f1 100%)"></div>
                                <span class="text-xs font-medium">Ocean</span>
                                <div class="absolute top-1 right-1 w-4 h-4 bg-green-500 rounded-full hidden items-center justify-center theme-check">
                                    <span class="text-white text-xs">âœ“</span>
                                </div>
                            </button>
                            
                            <!-- Sunset Theme -->
                            <button onclick="setTheme('sunset')" class="theme-btn group relative rounded-xl p-3 border-2 transition-all hover:scale-105" data-theme-btn="sunset">
                                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #f97316 100%)"></div>
                                <span class="text-xs font-medium">Sunset</span>
                                <div class="absolute top-1 right-1 w-4 h-4 bg-green-500 rounded-full hidden items-center justify-center theme-check">
                                    <span class="text-white text-xs">âœ“</span>
                                </div>
                            </button>
                            
                            <!-- Forest Theme -->
                            <button onclick="setTheme('forest')" class="theme-btn group relative rounded-xl p-3 border-2 transition-all hover:scale-105" data-theme-btn="forest">
                                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden" style="background: linear-gradient(135deg, #0f1f13 0%, #1a3320 50%, #22c55e 100%)"></div>
                                <span class="text-xs font-medium">Forest</span>
                                <div class="absolute top-1 right-1 w-4 h-4 bg-green-500 rounded-full hidden items-center justify-center theme-check">
                                    <span class="text-white text-xs">âœ“</span>
                                </div>
                            </button>
                            
                            <!-- Midnight Theme -->
                            <button onclick="setTheme('midnight')" class="theme-btn group relative rounded-xl p-3 border-2 transition-all hover:scale-105" data-theme-btn="midnight">
                                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden" style="background: linear-gradient(135deg, #020617 0%, #1e293b 50%, #3b82f6 100%)"></div>
                                <span class="text-xs font-medium">Midnight</span>
                                <div class="absolute top-1 right-1 w-4 h-4 bg-green-500 rounded-full hidden items-center justify-center theme-check">
                                    <span class="text-white text-xs">âœ“</span>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Integrations (OAuth Setup for Admin) -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold flex items-center gap-2">ðŸ”Œ Integrations</h3>
                            <p class="text-sm text-gray-400 mt-1">Connect external services for your agents</p>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- Google Integration -->
                            <div class="p-4 rounded-lg" style="background:var(--bg-input);">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg bg-white flex items-center justify-center">
                                            <svg width="24" height="24" viewBox="0 0 24 24">
                                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h5 class="font-medium" style="color:var(--text-primary);">Google</h5>
                                            <p class="text-xs" style="color:var(--text-muted);" id="google-integration-status">Not configured</p>
                                        </div>
                                    </div>
                                    <button onclick="showIntegrationSetup('google')" class="btn-secondary px-4 py-2 rounded-lg text-sm">
                                        Configure
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Microsoft Integration -->
                            <div class="p-4 rounded-lg" style="background:var(--bg-input);">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg bg-white flex items-center justify-center">
                                            <svg width="21" height="21" viewBox="0 0 21 21">
                                                <rect x="1" y="1" width="9" height="9" fill="#F25022"/>
                                                <rect x="11" y="1" width="9" height="9" fill="#7FBA00"/>
                                                <rect x="1" y="11" width="9" height="9" fill="#00A4EF"/>
                                                <rect x="11" y="11" width="9" height="9" fill="#FFB900"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h5 class="font-medium" style="color:var(--text-primary);">Microsoft</h5>
                                            <p class="text-xs" style="color:var(--text-muted);" id="microsoft-integration-status">Not configured</p>
                                        </div>
                                    </div>
                                    <button onclick="showIntegrationSetup('microsoft')" class="btn-secondary px-4 py-2 rounded-lg text-sm">
                                        Configure
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-xs mt-4" style="color:var(--text-muted);">
                            ðŸ’¡ These integrations allow users to connect their accounts with one click when creating Email tools.
                        </p>
                    </div>
                    
                    <!-- LLM Providers Management -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold flex items-center gap-2">ðŸ§  LLM Providers</h3>
                                <p class="text-sm text-gray-400 mt-1">Add and manage your AI model providers</p>
                            </div>
                        </div>
                        
                        <!-- Configured Providers Table -->
                        <div id="configured-providers-section" class="mb-6">
                            <h4 class="text-sm font-medium text-gray-300 mb-3">âœ… Configured Providers</h4>
                            <div id="configured-providers-table" class="space-y-2">
                                <!-- Will be populated dynamically -->
                                <div class="text-center py-4 text-gray-500 text-sm" id="no-providers-msg">
                                    <span class="text-2xl block mb-2">ðŸ“­</span>
                                    No providers configured yet. Add one below.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add New Provider Form -->
                        <div class="border-t border-gray-700 pt-4">
                            <h4 class="text-sm font-medium text-gray-300 mb-3">âž• Add New Provider</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                                    <select id="llm-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onLLMProviderChange()">
                                        <optgroup label="Cloud Providers">
                                            <option value="openai">OpenAI (GPT-4o, GPT-4)</option>
                                            <option value="anthropic">Anthropic (Claude)</option>
                                            <option value="google">Google (Gemini)</option>
                                            <option value="xai">xAI (Grok)</option>
                                            <option value="groq">Groq (Fast Inference)</option>
                                            <option value="mistral">Mistral AI</option>
                                            <option value="deepseek">DeepSeek</option>
                                            <option value="together">Together AI</option>
                                            <option value="perplexity">Perplexity</option>
                                            <option value="cohere">Cohere</option>
                                        </optgroup>
                                        <optgroup label="Enterprise">
                                            <option value="azure_openai">Azure OpenAI</option>
                                            <option value="aws_bedrock">AWS Bedrock</option>
                                        </optgroup>
                                        <optgroup label="Local / Self-hosted">
                                            <option value="ollama">Ollama (Local)</option>
                                            <option value="lmstudio">LM Studio</option>
                                            <option value="custom">Custom OpenAI-compatible</option>
                                        </optgroup>
                                    </select>
                            
                                </div>
                                <div id="llm-api-key-group">
                                    <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                                    <input type="password" id="llm-api-key" class="input-field w-full rounded-lg px-4 py-2" placeholder="Enter your API key...">
                                </div>
                                <div id="llm-api-base-group" class="hidden">
                                    <label class="text-sm text-gray-400 mb-1 block">API Base URL</label>
                                    <input type="text" id="llm-api-base" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://api.example.com/v1">
                                </div>
                                <div id="llm-resource-group" class="hidden">
                                    <label class="text-sm text-gray-400 mb-1 block">Resource Name / Deployment</label>
                                    <input type="text" id="llm-resource" class="input-field w-full rounded-lg px-4 py-2" placeholder="my-resource">
                                </div>
                            </div>
                            
                            <!-- Provider Info -->
                            <div id="llm-provider-info" class="mt-3 p-3 bg-gray-800/50 rounded-lg text-xs">
                                <p id="llm-provider-info-text" class="text-gray-400">Select a provider to see supported models and pricing info.</p>
                                <a id="llm-provider-link" href="#" target="_blank" class="text-purple-400 hover:text-purple-300 mt-1 inline-block hidden">Get API Key â†’</a>
                            </div>
                            
                            <!-- Supported Models Preview -->
                            <div id="llm-models-preview" class="mt-3 hidden">
                                <label class="text-xs text-gray-400 mb-2 block">Supported Models:</label>
                                <div id="llm-models-list-preview" class="flex flex-wrap gap-1">
                                    <!-- Model tags will be added here -->
                                </div>
                            </div>
                            
                            <div class="flex gap-2 mt-4">
                                <button onclick="addLLMProvider()" class="btn-primary px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                                    <span>âž•</span> Add Provider
                                </button>
                                <button onclick="testNewLLMProvider()" class="btn-secondary px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                                    <span>ðŸ§ª</span> Test Connection
                                </button>
                            </div>
                            <div id="llm-test-result" class="hidden mt-3 p-3 rounded-lg text-sm"></div>
                        </div>
                    </div>

                    <!-- Default LLM Selection -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold flex items-center gap-2">â­ Default LLM</h3>
                                <p class="text-sm text-gray-400 mt-1">Select the default model for agent chat and platform features</p>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Default Provider</label>
                                <select id="default-llm-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onDefaultProviderChange()">
                                    <option value="">-- Select Provider --</option>
                                    <!-- Populated from configured providers -->
                                </select>
                            
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Default Model</label>
                                <select id="default-llm-model" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="">-- Select Model --</option>
                                </select>
                            
                            </div>
                        </div>
                    </div>

                    <!-- Embedding Provider -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold flex items-center gap-2">ðŸ“ Embedding Provider</h3>
                                <p class="text-sm text-gray-400 mt-1">Configure embeddings for semantic search</p>
                            </div>
                            <button onclick="testEmbedding()" class="btn-secondary px-3 py-1.5 rounded-lg text-sm">ðŸ§ª Test</button>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                                <select id="emb-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onEmbeddingProviderChange()">
                                    <option value="openai">OpenAI Embeddings</option>
                                    <option value="sentence_transformers">Sentence Transformers (Local)</option>
                                    <option value="ollama">Ollama Embeddings</option>
                                </select>
                            
                            </div>
                            <div id="emb-model-group">
                                <label class="text-sm text-gray-400 mb-1 block">Model</label>
                                <select id="emb-model" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="text-embedding-3-small">text-embedding-3-small (1536 dim)</option>
                                    <option value="text-embedding-3-large">text-embedding-3-large (3072 dim)</option>
                                    <option value="text-embedding-ada-002">text-embedding-ada-002 (1536 dim)</option>
                                </select>
                            
                            </div>
                            <div id="emb-local-model-group" class="hidden">
                                <label class="text-sm text-gray-400 mb-1 block">Local Model</label>
                                <select id="emb-local-model" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="all-MiniLM-L6-v2">all-MiniLM-L6-v2 (384 dim, Fast)</option>
                                    <option value="all-mpnet-base-v2">all-mpnet-base-v2 (768 dim, Better)</option>
                                    <option value="paraphrase-multilingual-MiniLM-L12-v2">Multilingual (384 dim)</option>
                                </select>
                            
                            </div>
                            <div id="emb-api-key-group">
                                <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                                <input type="password" id="emb-api-key" class="input-field w-full rounded-lg px-4 py-2" placeholder="sk-...">
                            </div>
                        </div>
                        <div id="emb-test-result" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
                    </div>

                    <!-- Vector Database -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold flex items-center gap-2">ðŸ—„ï¸ Vector Database</h3>
                                <p class="text-sm text-gray-400 mt-1">Configure where embeddings are stored for RAG search</p>
                            </div>
                            <button onclick="reindexKnowledgeBase()" class="btn-secondary px-3 py-1.5 rounded-lg text-sm">ðŸ”„ Reindex</button>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                                <select id="vdb-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onVectorDBProviderChange()">
                                    <option value="memory">In-Memory (Keyword Search)</option>
                                    <option value="chromadb">ChromaDB (Local Vector DB)</option>
                                    <option value="pinecone">Pinecone (Cloud)</option>
                                </select>
                            
                            </div>
                            <div id="vdb-chroma-path-group" class="hidden">
                                <label class="text-sm text-gray-400 mb-1 block">Storage Path</label>
                                <input type="text" id="vdb-chroma-path" class="input-field w-full rounded-lg px-4 py-2" placeholder="./data/chromadb">
                            </div>
                            <div id="vdb-pinecone-group" class="hidden col-span-2 grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Pinecone API Key</label>
                                    <input type="password" id="vdb-pinecone-key" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Index Name</label>
                                    <input type="text" id="vdb-pinecone-index" class="input-field w-full rounded-lg px-4 py-2" placeholder="agentforge">
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-gray-800 rounded-lg">
                            <div class="flex items-center gap-2 text-sm">
                                <span id="vdb-status-icon">âšª</span>
                                <span id="vdb-status-text">Not configured</span>
                            </div>
                        </div>
                    </div>

                    <!-- RAG Settings -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">ðŸ” RAG Settings</h3>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Chunk Size</label>
                                <input type="number" id="rag-chunk-size" class="input-field w-full rounded-lg px-4 py-2" value="1000">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Chunk Overlap</label>
                                <input type="number" id="rag-chunk-overlap" class="input-field w-full rounded-lg px-4 py-2" value="200">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Search Results (Top K)</label>
                                <input type="number" id="rag-top-k" class="input-field w-full rounded-lg px-4 py-2" value="5">
                            </div>
                        </div>
                    </div>

                    <!-- Feature Toggles -->
                    <div class="card rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">ðŸŽ›ï¸ Features</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Enable RAG</p>
                                    <p class="text-sm text-gray-400">Use vector search for knowledge retrieval</p>
                                </div>
                                <div id="toggle-rag" class="toggle-switch on" onclick="toggleFeature('rag')"></div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Enable Web Scraping</p>
                                    <p class="text-sm text-gray-400">Allow scraping websites as knowledge sources</p>
                                </div>
                                <div id="toggle-scraping" class="toggle-switch on" onclick="toggleFeature('scraping')"></div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium">Enable API Tools</p>
                                    <p class="text-sm text-gray-400">Allow agents to call external APIs</p>
                                </div>
                                <div id="toggle-api" class="toggle-switch on" onclick="toggleFeature('api')"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="flex justify-end gap-4">
                        <button onclick="loadSettings()" class="btn-secondary px-6 py-2 rounded-lg">Reset</button>
                        <button onclick="saveSettings()" class="btn-primary px-6 py-2 rounded-lg">ðŸ’¾ Save Settings</button>
                    </div>
                </div>
            </section>

            <!-- Profile Page -->
            <section id="page-profile" class="hidden flex-1 overflow-y-auto p-4 md:p-6">
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                        <span>ðŸ‘¤</span><span>My Profile</span>
                    </h2>

                    <!-- Combined Profile Card -->
                    <div class="card rounded-xl p-6 mb-6">
                        <form id="update-profile-form" class="space-y-5">
                            <!-- Email (Read-only) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Email</label>
                                <div class="flex items-center gap-3">
                                    <input type="email" id="profile-email" class="flex-1 input-field rounded-lg px-4 py-2.5" readonly disabled>
                                    <span id="profile-role" class="px-3 py-1 text-xs font-medium rounded-full bg-purple-500/20 text-purple-400 border border-purple-500/30">-</span>
                                </div>
                            </div>
                            
                            <!-- Name Fields -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">First Name</label>
                                    <input type="text" id="update-first-name" class="w-full input-field rounded-lg px-4 py-2.5" placeholder="Enter first name">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Last Name</label>
                                    <input type="text" id="update-last-name" class="w-full input-field rounded-lg px-4 py-2.5" placeholder="Enter last name">
                                </div>
                            </div>
                            
                            <!-- Display Name -->
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">Display Name</label>
                                <input type="text" id="update-display-name" class="w-full input-field rounded-lg px-4 py-2.5" placeholder="How you want to be called">
                                <p class="text-xs text-gray-500 mt-1">This is the name shown in the app</p>
                            </div>
                            
                            <!-- Member Since -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-700">
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Member Since</label>
                                    <p id="profile-created" class="text-base font-medium">-</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Account Status</label>
                                    <span class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-full bg-green-500/20 text-green-400 border border-green-500/30">
                                        <span class="w-2 h-2 rounded-full bg-green-400 mr-2"></span>Active
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Save Button -->
                            <div class="flex justify-end pt-2">
                                <button type="submit" class="btn-primary px-6 py-2.5 rounded-lg font-medium">Save Profile</button>
                            </div>
                        </form>
                    </div>

                    <!-- Security Section -->
                    <div class="card rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <span>ðŸ”</span><span>Security</span>
                        </h3>
                        
                        <!-- Change Password Button -->
                        <div class="flex items-center justify-between p-4 rounded-lg bg-gray-700/30 border border-gray-600 mb-4">
                            <div>
                                <p class="font-medium">Password</p>
                                <p class="text-sm text-gray-400">Last changed: Never</p>
                            </div>
                            <button onclick="showChangePasswordModal()" class="btn-secondary px-4 py-2 rounded-lg">Change Password</button>
                        </div>

                        <!-- MFA Status -->
                        <div id="mfa-status-container" class="flex items-center justify-between p-4 rounded-lg bg-gray-700/30 border border-gray-600">
                            <div>
                                <p class="font-medium">Two-Factor Authentication</p>
                                <p id="mfa-status-text" class="text-sm text-gray-400">Loading...</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <!-- MFA Toggle Switch -->
                                <button id="mfa-toggle" onclick="toggleMFA()" class="relative inline-flex h-7 w-14 items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-800 bg-red-500" data-enabled="false">
                                    <span class="sr-only">Enable MFA</span>
                                    <span id="mfa-toggle-dot" class="inline-block h-5 w-5 transform rounded-full bg-white shadow-lg transition-transform duration-200 translate-x-1"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                        
<!-- Change Password Modal -->
                    <div id="change-password-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
                        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 border border-gray-700">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                    <span>ðŸ”’</span> Change Password
                                </h3>
                                <button onclick="hideChangePasswordModal()" class="text-gray-400 hover:text-white transition">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <form id="change-password-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Current Password</label>
                                    <input type="password" id="current-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2.5 text-white" required placeholder="Enter current password">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">New Password</label>
                                    <input type="password" id="new-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2.5 text-white" required placeholder="Enter new password">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Confirm New Password</label>
                                    <input type="password" id="confirm-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2.5 text-white" required placeholder="Confirm new password">
                                </div>
                                
                                <div id="password-error" class="hidden p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-400 text-sm"></div>
                                
                                <div class="flex gap-3 pt-2">
                                    <button type="button" onclick="hideChangePasswordModal()" class="flex-1 btn-secondary px-4 py-2.5 rounded-lg">Cancel</button>
                                    <button type="submit" class="flex-1 btn-primary px-4 py-2.5 rounded-lg">Change Password</button>
                                </div>
                            </form>
                        </div>
                    </div>
                        
                        <!-- Disable MFA Confirmation Modal -->
                        <div id="disable-mfa-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70">
                            <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 border border-gray-700">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Disable MFA</h3>
                                        <p class="text-sm text-gray-400">This will make your account less secure</p>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Enter your password to confirm</label>
                                    <div class="relative">
                                        <input type="password" id="disable-mfa-password" 
                                               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 pr-12 text-white focus:ring-2 focus:ring-red-500 focus:border-transparent" 
                                               placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                                        <button type="button" onclick="togglePasswordVisibility('disable-mfa-password')" 
                                                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition" title="Show/Hide password">
                                            <span id="disable-mfa-password-icon">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                                                </svg>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="disable-mfa-error" class="hidden mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-400 text-sm"></div>
                                
                                <div class="flex gap-3">
                                    <button onclick="hideDisableMFAModal()" class="flex-1 px-4 py-2 rounded-lg border border-gray-600 text-gray-300 hover:bg-gray-700 transition">Cancel</button>
                                    <button onclick="confirmDisableMFA()" class="flex-1 px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition">Disable MFA</button>
                                </div>
                            </div>
                        </div>

                        <!-- MFA Setup Modal Content (will be shown in modal) -->
                        <div id="mfa-setup-modal-content" class="hidden">
                            <!-- TOTP Setup -->
                            <div id="totp-setup" class="hidden">
                                <div class="text-center mb-4">
                                    <h4 class="text-lg font-semibold mb-2">Scan QR Code</h4>
                                    <p class="text-sm text-gray-400 mb-4">Scan this QR code with your authenticator app</p>
                                    <div id="qr-code-container" class="flex justify-center mb-4"></div>
                                    <p class="text-xs text-gray-500 mb-2">Or enter this key manually:</p>
                                    <code id="mfa-secret-key" class="bg-gray-700 px-3 py-1 rounded text-sm"></code>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Verification Code</label>
                                    <input type="text" id="totp-verify-code" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center text-lg tracking-wider" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                                </div>
                                <button onclick="verifyTOTPSetup()" class="btn-primary w-full py-2 rounded-lg">Verify & Enable</button>
                            </div>

                            <!-- Email Setup -->
                            <div id="email-setup" class="hidden">
                                <div class="text-center mb-4">
                                    <h4 class="text-lg font-semibold mb-2">Verify Email</h4>
                                    <p class="text-sm text-gray-400 mb-4">A verification code has been sent to your email</p>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Verification Code</label>
                                    <input type="text" id="email-verify-code" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center text-lg tracking-wider" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="resendEmailMFACode()" class="btn-secondary flex-1 py-2 rounded-lg">Resend Code</button>
                                    <button onclick="verifyEmailSetup()" class="btn-primary flex-1 py-2 rounded-lg">Verify & Enable</button>
                                </div>
                            </div>
                        </div>
                    </div>
            </section>

            <!-- Security Center Page -->
            <section id="page-security" class="hidden flex-1 overflow-y-auto p-4 md:p-6">
                <div class="max-w-7xl mx-auto">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold">ðŸ” Security Center</h2>
                            <p class="text-gray-400 text-sm">Manage users, roles, and security settings</p>
                        </div>
                        <button id="invite-user-btn" data-permission="users:invite" onclick="showInviteModal()" class="btn-primary px-4 py-2 rounded-lg">+ Invite User</button>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="card rounded-xl p-4">
                            <div class="text-2xl font-bold text-purple-400" id="sec-stat-users">0</div>
                            <div class="text-sm text-gray-400">Total Users</div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <div class="text-2xl font-bold text-green-400" id="sec-stat-active">0</div>
                            <div class="text-sm text-gray-400">Active</div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <div class="text-2xl font-bold text-blue-400" id="sec-stat-roles">0</div>
                            <div class="text-sm text-gray-400">Roles</div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <div class="text-2xl font-bold text-yellow-400" id="sec-stat-policies">0</div>
                            <div class="text-sm text-gray-400">Policies</div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <div class="text-2xl font-bold text-cyan-400" id="sec-stat-mfa">0</div>
                            <div class="text-sm text-gray-400">MFA Enabled</div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex gap-2 mb-4 border-b border-gray-700 pb-2 overflow-x-auto">
                        <button data-permission="users:view" onclick="switchSecurityTab('users')" id="sec-tab-users" class="px-4 py-2 rounded-t-lg bg-purple-600 text-white whitespace-nowrap">ðŸ‘¥ Users</button>
                        <button data-permission="roles:view" onclick="switchSecurityTab('roles')" id="sec-tab-roles" class="px-4 py-2 rounded-t-lg hover:bg-gray-700 whitespace-nowrap">ðŸŽ­ Roles</button>
                        <button data-permission="users:view" onclick="switchSecurityTab('groups')" id="sec-tab-groups" class="px-4 py-2 rounded-t-lg hover:bg-gray-700 whitespace-nowrap">ðŸ‘¥ Groups</button>
                        <button data-permission="audit:view" onclick="switchSecurityTab('audit')" id="sec-tab-audit" class="px-4 py-2 rounded-t-lg hover:bg-gray-700 whitespace-nowrap">ðŸ“‹ Audit Log</button>
                        <button onclick="switchSecurityTab('mfa')" id="sec-tab-mfa" class="px-4 py-2 rounded-t-lg hover:bg-gray-700 whitespace-nowrap">ðŸ”‘ My MFA</button>
                        <button data-permission="security:settings" onclick="switchSecurityTab('settings')" id="sec-tab-settings" class="px-4 py-2 rounded-t-lg hover:bg-gray-700 whitespace-nowrap">âš™ï¸ Settings</button>
                    </div>

                    <!-- Users Tab -->
                    <div id="sec-content-users" class="card rounded-xl" data-permission="users:view">
                        <!-- Pending Invitations -->
                        <div id="sec-invitations-section" class="p-4 border-b border-gray-700">
                            <h4 class="text-sm font-semibold text-yellow-400 mb-3">ðŸ“§ Pending Invitations</h4>
                            <div id="sec-invitations-list" class="space-y-2">
                                <p class="text-gray-500 text-sm">Loading invitations...</p>
                            </div>
                        </div>
                        <!-- Users Filter -->
                        <div class="p-4 border-b border-gray-700 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                            <input type="text" id="sec-user-search" placeholder="Search users..." 
                                   class="input-field px-4 py-2 rounded-lg w-full md:w-64" oninput="filterSecurityUsers()">
                            <select id="sec-user-filter" class="input-field px-4 py-2 rounded-lg" onchange="filterSecurityUsers()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="locked">Locked</option>
                            </select>
                            
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-800/50">
                                    <tr>
                                        <th class="text-left p-4">User</th>
                                        <th class="text-left p-4">Roles</th>
                                        <th class="text-left p-4">Status</th>
                                        <th class="text-left p-4">MFA</th>
                                        <th class="text-left p-4">Last Login</th>
                                        <th class="text-left p-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="sec-users-table">
                                    <tr><td colspan="6" class="p-8 text-center text-gray-500">Loading users...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Roles Tab -->
                    <div id="sec-content-roles" class="hidden" data-permission="roles:view">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Manage Roles</h3>
                            <button onclick="showAddRoleModal()" class="btn-primary px-4 py-2 rounded-lg" data-permission="roles:create">+ Add Role</button>
                        </div>
                        <div class="flex justify-between mb-4">
                            <h3 class="text-lg font-semibold">System & Custom Roles</h3>
                            
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="sec-roles-grid">
                            <div class="card rounded-xl p-4 text-center text-gray-500">Loading roles...</div>
                        </div>
                    </div>

                    <!-- Groups Tab -->
                    <div id="sec-content-groups" class="hidden" data-permission="users:view">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-lg font-semibold">User Groups</h3>
                                <p class="text-sm text-gray-400">Organize users into groups for easier access management</p>
                            </div>
                            <button onclick="showAddGroupModal()" class="btn-primary px-4 py-2 rounded-lg">+ Create Group</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="sec-groups-grid">
                            <div class="card rounded-xl p-4 text-center text-gray-500">Loading groups...</div>
                        </div>
                    </div>

                    <!-- Add Group Modal -->
                    <div id="add-group-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
                        <div class="modal-content-box rounded-2xl w-full max-w-lg mx-4">
                            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                                <h3 class="font-bold text-lg">ðŸ‘¥ Create User Group</h3>
                                <button onclick="closeAddGroupModal()" class="p-2 hover:bg-gray-700 rounded-lg">âœ•</button>
                            </div>
                            <div class="p-6 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Group Name *</label>
                                    <input type="text" id="group-name" class="w-full input-field rounded-lg px-4 py-2" placeholder="e.g., HR Team, Engineering, Support">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Description</label>
                                    <textarea id="group-description" class="w-full input-field rounded-lg px-4 py-2 h-20" placeholder="What is this group for?"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Add Members</label>
                                    <input type="text" id="group-member-search" class="w-full input-field rounded-lg px-4 py-2 mb-2" placeholder="ðŸ” Search users to add..." oninput="searchGroupMembers(this.value)">
                                    <div id="group-member-results" class="hidden max-h-32 overflow-y-auto rounded-lg border border-gray-600 bg-gray-800"></div>
                                    <div id="group-selected-members" class="flex flex-wrap gap-2 mt-2">
                                        <!-- Selected members will appear here -->
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 border-t border-gray-700 flex justify-end gap-3">
                                <button onclick="closeAddGroupModal()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Cancel</button>
                                <button onclick="saveGroup()" class="px-6 py-2 rounded-lg bg-purple-600 hover:bg-purple-700">Create Group</button>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Log Tab -->
                    <div id="sec-content-audit" class="hidden card rounded-xl" data-permission="audit:view">
                        <div class="p-4 border-b border-gray-700 flex items-center gap-4">
                            <select id="sec-audit-action" class="input-field px-3 py-2 rounded-lg" onchange="loadAuditLogs()">
                                <option value="">All Actions</option>
                                <option value="login">Login</option>
                                <option value="logout">Logout</option>
                                <option value="create">Create</option>
                                <option value="update">Update</option>
                                <option value="delete">Delete</option>
                            </select>
                            
                            <button data-permission="audit:export" onclick="exportAuditLogs()" class="btn-secondary px-4 py-2 rounded-lg">ðŸ“¥ Export CSV</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-800/50">
                                    <tr>
                                        <th class="text-left p-4">Time</th>
                                        <th class="text-left p-4">User</th>
                                        <th class="text-left p-4">Action</th>
                                        <th class="text-left p-4">Resource</th>
                                        <th class="text-left p-4">IP</th>
                                        <th class="text-left p-4">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="sec-audit-table">
                                    <tr><td colspan="6" class="p-8 text-center text-gray-500">Select action filter to load logs</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- MFA Tab -->
                    <div id="sec-content-mfa" class="hidden card rounded-xl p-6">
                        <div class="max-w-2xl mx-auto">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4">ðŸ”</div>
                                <h3 class="text-xl font-bold mb-2">Multi-Factor Authentication</h3>
                                <p class="text-gray-400">Secure your platform with email verification</p>
                            </div>
                            
                            <!-- Admin Controls -->
                            <div id="mfa-admin-controls" class="mb-8" data-permission="system:admin,security:settings">
                                <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-6">
                                    <h4 class="font-bold text-purple-400 mb-6 flex items-center gap-2">
                                        <span>âš™ï¸</span> Platform MFA Settings
                                    </h4>
                                    
                                    <!-- MFA Mode Selection -->
                                    <div class="space-y-3">
                                        <label class="block text-sm text-gray-400 mb-3">Choose MFA mode for your platform:</label>
                                        
                                        <label class="flex items-center p-4 rounded-lg border border-gray-700 hover:border-purple-500 cursor-pointer transition" onclick="selectMfaMode('off')">
                                            <input type="radio" name="mfa-mode" value="off" class="mr-4 accent-purple-500">
                                            <div class="flex-1">
                                                <span class="font-medium">ðŸ”“ Disabled</span>
                                                <p class="text-sm text-gray-500">MFA is turned off for all users</p>
                                            </div>
                                        </label>
                                        
                                        <label class="flex items-center p-4 rounded-lg border border-gray-700 hover:border-purple-500 cursor-pointer transition" onclick="selectMfaMode('optional')">
                                            <input type="radio" name="mfa-mode" value="optional" class="mr-4 accent-purple-500">
                                            <div class="flex-1">
                                                <span class="font-medium">ðŸ”˜ Optional</span>
                                                <p class="text-sm text-gray-500">Users can enable/disable MFA from their profile</p>
                                            </div>
                                        </label>
                                        
                                        <label class="flex items-center p-4 rounded-lg border border-gray-700 hover:border-purple-500 cursor-pointer transition" onclick="selectMfaMode('admins')">
                                            <input type="radio" name="mfa-mode" value="admins" class="mr-4 accent-purple-500">
                                            <div class="flex-1">
                                                <span class="font-medium">ðŸ‘‘ Required for Admins</span>
                                                <p class="text-sm text-gray-500">Administrators must use MFA, others optional</p>
                                            </div>
                                        </label>
                                        
                                        <label class="flex items-center p-4 rounded-lg border border-gray-700 hover:border-purple-500 cursor-pointer transition" onclick="selectMfaMode('all')">
                                            <input type="radio" name="mfa-mode" value="all" class="mr-4 accent-purple-500">
                                            <div class="flex-1">
                                                <span class="font-medium">ðŸ”’ Required for Everyone</span>
                                                <p class="text-sm text-gray-500">All users must verify with email code</p>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <div id="mfa-save-status" class="mt-4 text-sm text-green-400 hidden">âœ“ Settings saved automatically</div>
                                </div>
                            </div>
                            
                            <!-- User Status Section -->
                            <div class="bg-gray-800/50 rounded-xl p-6 mb-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-semibold mb-1">Your MFA Status</h4>
                                        <p id="mfa-status-text" class="text-sm text-gray-400">Loading...</p>
                                    </div>
                                    <div id="mfa-status-badge">
                                        <span class="px-3 py-1 rounded-full text-sm bg-gray-600 text-gray-300">Loading</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- How it works -->
                            <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 mb-6">
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl">ðŸ“§</span>
                                    <div>
                                        <h4 class="font-semibold text-blue-400 mb-1">How it works</h4>
                                        <p class="text-sm text-gray-400">When you log in, a 6-digit code will be sent to your email. Enter this code to complete sign-in.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- User MFA Toggle (shows for Optional mode) -->
                            <div id="mfa-user-toggle-section" class="hidden">
                                <div class="border border-gray-700 rounded-xl p-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="font-semibold mb-1">MFA for my account</h4>
                                            <p class="text-sm text-gray-400">Enable or disable MFA for your login</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="mfa-user-enabled" class="sr-only peer" onchange="toggleUserMFA()">
                                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="sec-content-settings" class="hidden card rounded-xl p-6" data-permission="security:settings">
                        <h3 class="text-lg font-bold mb-6">Security Settings</h3>
                        <form id="security-settings-form" class="space-y-6">
                            <!-- Authentication Settings -->
                            <div>
                                <h4 class="font-semibold mb-4 text-purple-400">ðŸ” Authentication</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Registration Mode</label>
                                        <select id="sec-setting-registration_mode" name="registration_mode" class="input-field w-full px-4 py-2 rounded-lg">
                                            <option value="open">Open Registration</option>
                                            <option value="invite_only">Invite Only</option>
                                            <option value="disabled">Disabled</option>
                                        </select>
                            
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Email Verification</label>
                                        <select id="sec-setting-email_verification" name="email_verification" class="input-field w-full px-4 py-2 rounded-lg">
                                            <option value="required">Required</option>
                                            <option value="optional">Optional</option>
                                            <option value="disabled">Disabled</option>
                                        </select>
                            
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Password Policy -->
                            <div>
                                <h4 class="font-semibold mb-4 text-purple-400">ðŸ”‘ Password Policy</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Minimum Length</label>
                                        <input type="number" id="sec-setting-password_min_length" name="password_min_length" min="8" max="32" value="8" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Password Expiry (days, 0=never)</label>
                                        <input type="number" id="sec-setting-password_expiry_days" name="password_expiry_days" min="0" value="0" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                    <div class="col-span-2 space-y-2">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="sec-setting-require_uppercase" name="require_uppercase" class="rounded">
                                            <span class="text-sm">Require uppercase letter</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="sec-setting-require_number" name="require_number" class="rounded">
                                            <span class="text-sm">Require number</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="sec-setting-require_symbol" name="require_symbol" class="rounded">
                                            <span class="text-sm">Require special character</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Session Settings -->
                            <div>
                                <h4 class="font-semibold mb-4 text-purple-400">â±ï¸ Session</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Session Timeout (minutes)</label>
                                        <input type="number" id="sec-setting-session_timeout" name="session_timeout" min="15" value="1440" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Remember Me Duration (days)</label>
                                        <input type="number" id="sec-setting-remember_me_days" name="remember_me_days" min="1" value="30" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Max Concurrent Sessions</label>
                                        <input type="number" id="sec-setting-max_sessions" name="max_sessions" min="1" value="3" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                </div>
                            </div>

                            <!-- Security Policy -->
                            <div>
                                <h4 class="font-semibold mb-4 text-purple-400">ðŸ›¡ï¸ Security</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Account Lockout After (attempts)</label>
                                        <input type="number" id="sec-setting-lockout_attempts" name="lockout_attempts" min="3" value="5" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Lockout Duration (minutes)</label>
                                        <input type="number" id="sec-setting-lockout_duration" name="lockout_duration" min="5" value="30" class="input-field w-full px-4 py-2 rounded-lg">
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end pt-4 border-t border-gray-700">
                                <button type="button" onclick="saveSecuritySettings()" class="btn-primary px-6 py-2 rounded-lg">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Create Agent Wizard - AI-Powered -->
            <section id="page-create" class="hidden flex-1 flex flex-col" style="overflow:hidden;">
                
                <!-- STICKY HEADER: Progress + Navigation -->
                <div id="wizard-sticky-header" class="hidden sticky top-0 z-40 bg-[#1a1a2e] border-b border-gray-800 px-4 py-3 shadow-lg">
                    <div class="max-w-5xl mx-auto">
                        <!-- Top Row: Title + Actions -->
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div>
                                    <h2 id="wizard-header-title" class="text-sm font-semibold text-white">Create Agent</h2>
                                    <p id="wizard-header-step" class="text-xs text-gray-400">Step 1 of 7</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="cancelEdit()" class="text-sm px-4 py-1.5 rounded border border-gray-700 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                                    Cancel
                                </button>
                                <button onclick="saveWizardProgress()" class="text-sm px-4 py-1.5 rounded border border-gray-700 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                                    Save Draft
                                </button>
                                <button onclick="prevStep()" id="wizard-btn-back" class="text-sm px-4 py-1.5 rounded border border-gray-700 text-gray-300 hover:bg-gray-800 transition disabled:opacity-50" disabled>
                                    Back
                                </button>
                                <button onclick="nextStep()" id="wizard-btn-next" class="text-sm px-4 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700 transition">
                                    Next
                                </button>
                                <button onclick="deployAgent()" id="wizard-btn-deploy" class="hidden text-sm px-4 py-1.5 rounded bg-green-600 text-white hover:bg-green-700 transition">
                                    Deploy
                                </button>
                            </div>
                        </div>
                        
                        <!-- Progress Bar - 7 Steps (Test is final with Deploy) -->
                        <div class="flex items-center gap-1">
                            <div class="wizard-progress-step" data-step="1">
                                <div class="wizard-step-dot active" onclick="goStep(1)">1</div>
                                <span class="wizard-step-label">Setup</span>
                            </div>
                            <div class="wizard-progress-line"></div>
                            <div class="wizard-progress-step" data-step="2">
                                <div class="wizard-step-dot" onclick="goStep(2)">2</div>
                                <span class="wizard-step-label">Tasks</span>
                            </div>
                            <div class="wizard-progress-line"></div>
                            <div class="wizard-progress-step" data-step="3">
                                <div class="wizard-step-dot" onclick="goStep(3)">3</div>
                                <span class="wizard-step-label">Tools</span>
                            </div>
                            <div class="wizard-progress-line"></div>
                            <div class="wizard-progress-step" data-step="4">
                                <div class="wizard-step-dot" onclick="goStep(4)">4</div>
                                <span class="wizard-step-label">Access</span>
                            </div>
                            <div class="wizard-progress-line"></div>
                            <div class="wizard-progress-step" data-step="5">
                                <div class="wizard-step-dot" onclick="goStep(5)">5</div>
                                <span class="wizard-step-label">Safety</span>
                            </div>
                            <div class="wizard-progress-line"></div>
                            <div class="wizard-progress-step" data-step="6">
                                <div class="wizard-step-dot" onclick="goStep(6)">6</div>
                                <span class="wizard-step-label">Preview</span>
                            </div>
                            <div class="wizard-progress-line"></div>
                            <div class="wizard-progress-step" data-step="7">
                                <div class="wizard-step-dot" onclick="goStep(7)">7</div>
                                <span class="wizard-step-label">Test & Deploy</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Scrollable Content Area -->
                <div id="wizard-content-area" class="flex-1 overflow-y-auto p-4 md:p-6" style="-webkit-overflow-scrolling:touch;">
                
                <!-- OLD Steps Progress Bar (hidden, kept for backward compatibility) -->
                <div id="wizard-progress" class="hidden mb-8">
                    <div class="flex items-center justify-start md:justify-center gap-1 md:gap-2 overflow-x-auto pb-2">
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-1" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-active cursor-pointer text-xs md:text-sm" onclick="goStep(1)">1</div>
                            <span class="text-xs whitespace-nowrap hidden md:inline">Basics</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-2" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(2)">2</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Tasks</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-3" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(3)">3</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Tools</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-4" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(4)">4</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Access</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-5" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(5)">5</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Safety</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-6" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(6)">6</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Preview</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-7" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(7)">7</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Test</span>
                        </div>
                        <div class="w-4 md:w-8 h-0.5 bg-gray-700 flex-shrink-0"></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div id="step-8" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center step-pending cursor-pointer text-xs md:text-sm" onclick="goStep(8)">8</div>
                            <span class="text-xs text-gray-400 whitespace-nowrap hidden md:inline">Deploy</span>
                        </div>
                    </div>
                </div>

                <!-- Step 0: Goal Input (Initial Step) -->
                <div id="wizard-step-0" class="max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center mb-4">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAASz0lEQVR42m1aebBcZZU/v/Pd7n793svG5oIYAUtcWNywRkURsXBFFEUH1AooijrKDDgIiFtUlNIBHXRgym2mMguKU5aKKXRQoBAEghAxQgScCCJZyPqW5PVy7/nNH996H3bSye3uu3zfWX7ndxZ0OstFRAThnV+IX4HpJwj/yslIp7e/CW+SKH9hPCZFKBBQCKEIyHAKKQDJeCeEk4ur/R2qdOjfKBbG1k+IC2L8BWnp5a6YFkkBIEJAy+dSwn6Y5UAhAXgpkP6DqMAfU/zG/AGFcZlA1ZJ5Xn0SalwrvITBtEjkDaR1J0VEjQFQvxuS/pxwp7AKkiQUIsU9vD7EQDF4tTDLAIhbEmElgqA9IRdbkf+RUdpg+t1LPe6qPKIQorJIj8XvXiH+BUHQXyk4Fh+88ki0jSdog1IFVUtp1UhSj6uHP43JIpNjRD1AkJfKqOZgEgZC2k9B8hmW/7HtK+mK7A7xPAYTWrRqeYJ7ZuvPuverjmYITfsksv8HaTLYm/fL8hnwX2bIYPBstPcSRMxil4wyZSVPfPknQUCmh2SB+SOoPzOo3CsbKM8LrqmaV5Yu985IChiuYJSuFzGtwCsA6m0c4T5e/xSRahG6hfsBScCEBjD1BhxV4X1AoMGtATxhlwwnR1zJBkJQCIg4CoUWnhoWRyCiRdRgVHFCy+C41SJXKzxUiLQTf7kGd4VGv0FQhViyeCnNzCMjrW2U0UGSOKHeI9O+mfC68MOMYxEODNmEkEJGkEW5IA/KUohYEe3Mn+8kaU7CnikCvz2okAxgHw6jUXvDSBBl3oDT9UKBIoAwAAFhYNiiCKrkqCk2McI8EtgHaab9aJAtQjBCDoIK1SySHMwJodCCLflteD8Wy/7pQx6b+DhlEbej6JUQiGUYbbMAib4Ib+LJoINSoQlEol3nMAfnIgQByT1irBUDRAL0WBPQQjRGWEb7Vb/nyFtACERJ81EchW1VGZe9TXpXDFvSQH8Yfgqmm8wkniNQUQUgqgIFHFShAJRmJEVIawgTkjShwAnNPINIIVrMJCBfEQOSehDcIJgMAUhVwj7bS/fAEgXj75y+DyEMAoESAlVRB3VV1aG6UcOxsWlMaB3nep2qo9LUtTWNsKEZGSxJaGFlJJwTkmYAg/3QEAO4hxUGn/FmH7lQNBj/p1h9lDcJKIAUqqJPe0NSFXVadVl1ZwbjTr962jMOXnnIU1asWFaPx1u2Pv7HPz265/GdvV6n3+/Vw4GgEWtCnDPvSkywAxUa/ZoZuISAiYAlQkiSFaLLUyKCSVis3yVFA8QjBVCIPwEQVUAFCufMVf0V+5311tcdd+zRK5ZOD0f1zOwcoEun+91u5/cPbPrO967beN8DyyYnbTS0ekyBmImaCMUIMYloKpGAetRCINSJ/2WWjYnuAQKxHLw0gEwIXt5BC51ABE4EUIhzPhRAnXa69cTU2jVX9PqTV16z9obbfrPr4b+Ik06lnap6xtMPPvmkV5z86pf+8rbfXPr1Nd1m7JpRPRyIGWlCIw1mQgkfvdMzxDLxSEXzzCp+SYq4qppixEp4OPc44w+S5BXQuBnnolZURKAOnS7UuYnJbr9fG1/4nMNOe+0rnv2sQzdtfnzfwmjZ9NT2HbtuuuO31996z2lvOOHs009ee+vdCwsLlcLMRCySaxYEvsTtRVQTJeGJG8ioH/m9B5ZwsWYKpE4UIQaHTQpcBXUw+/X6+39x+/ob7rz395seO/LZh1909ju2zczes3HT0n5vsleNh8Nrrrvx4KccdP77Trv+V3ePBgPQAgfwpkgLviiReaCMAlxE7SBwWk1GWowQAcJSNdGi4BJQ0aiW/K9Co96Afq/TATlutj2+82e/Xn/Xg3/+p39873Dc3LXhD10QZv1e9+77/3jm299w47p7Z2dmnarFVDHFkgAp2V9LtpDjmsdHFR8+y2SAAWQytgaRg4kvqANUtIJzqCq4yu+hNjYGG406Vh840d14/0Nv//jlHzvrbYeufNrQRFSH43rlUw5asXRq+X4rZsfSdHrdyUntdlF1RFWCLCKXkRSU8mLQIjjiXDUZ7UdzdoKkSYVfvagoAM8UVKDiKlFVdXAuPhjodEUVQoEjadCXv/ioQw8+6Nqf3QIzUjpVZ+vO3Q9sevSSD51xyCFP3bp77tGtOyZ7HYEyBWMPiplf5AQ8IHuRRDhXTXs2j+y+aaPBogAVTbHWESKqUAWcKFhCari3iqKqqgXjt1efe+2Nd96y7nf7LZ32uDk1Ofnbex885ugjTvqbY153/Eu2ze576OHHOpVT52L9IoaqmMsjMeMi6fGKcK6aiqQrGB+DffuVazCngPcQV4kAGkyfSGoRAbTT80mM6/ZM3b6x/Wnn7CVnnbpjZm7dfQ+Jc0OTPfODf/jQ6cc9/znHv/uCjQ9v/trF53zv+lu6E73DD1u5fccuFdIaD00MFDCmbZFICHPBpPKMlQnkg2uW5RTGlDgWAMJNDHA+1YA3Nld5cVWdzsC4fP/l16w+96bfPfjOz1615pMfWHnwk3fOzL3l+GPX3rHhbSe+bNUnvsr+1Gte/qJ1v39o+8zC0Uc+662vP27dhoeWdoG6tqYWX6wwZeDYOXvOuSjgqmo6ZR6F+EVyHBDvXgGmFIgBGKpwlaiDBC4kAld1xnATK1b86MpPXX/H74469KknHvu8cy77zntef9xRhx/y8zs3fPmjZ7xv9VX33rPxjLe9dtXJx3/osu/u/6QDPvquk997ygnrH96yZ2bORkOra18agIA+vQyZXMgSUknJVcEHEDfhV685XQkmLoAL5gR4r4U6UQf1puUA0apiVVl/8if/8pmf3HzXV7517fW3r3/uMw7+yGmvfe/nrrp27c2337NxL/HBU0/Uie75737T+1ZftWLJ1HnvefM5p7xqott59bFHzewbbN68dW7PjHiumqsVMckuYpmX1xJhiAAiKqoi3l0jiikETqBINA4qzkmQunrzI6CuQtXZh+qHV376jrvv+8I31jz1wBVWNw8+tm3Vya+67sY7Rnv3Luv3btvw4MK4eePxL/7ct3/4yBB7ds78zy/X7RzUz336k0/4wGduvvHWvbt2STNmY7niQ6ZAQYoiV7pc1ZkOhQAPNdF5GTN1SX8FUCfOiWqwmQhT3vtdb2KmwZqvXLhl87YLLrv6wKWTZlyo6+99+ePf/NFNv7rzt1MdNxoOJ8Tu/cOmH/zvbdu27Trs2Be9aNXpW+57YPOjf5mZm/vZDbdM26geDljXCKU2ERKMhdQyQxKK0FWdJQH4WqkKI8XWnLJICMkxAKvnQqoefrp7BvU/f/bv+5W8/6Kv7L9kUhXbd8994oNnTEz2P33lmgOn+uPxmPWYZv1Kpyd63U61Z9v2lS97SdXtPHb77Tu2b597fKsNBzYeiTUBP1pkQtofKSLoTjypiGIS4JJSaMOJhihGUVEfhgF19Cer9vqTO+eHF59/9nHHHHHKBz+1pNepqmp+MD76qCOu/uy5b/y7zw9m90hdW93QGgpVXQBiV9XiJiYn6tndHC3UCwsyHlkzgpHW0JqQ5pNkQ3onplggsCKsynIIUp1Zc+WNZHDrVHL0tRBSzETR7XZ2zu5d9e5T3/zKF5+06oJJpxBpGmrHXXHROau/+YPtW7Yum+jUde0BkWZWNxATKKAKDGa202ppatZjWiMiFBNPm6Pz+owzHoawRYacOL1RFCVTW4AkA/BqrAvFV6fT2T0/eM2Jr/zYmae+8awL68Gg160U2DG396ovnHfXxj/9+PqbD5jqjgaDkF3TnIM1xobCml60ZmINrYGXt5lYrkSRY7JVI0qegFheZ07SQwmzKPql2rhXEBm3hqrTnR+Oj3j2M796yYfPPO/zWx7bvGR6SoAdM/N/+5aTnnvEYa8/5zP7TU/U41G6DyjWNGKNz2BCKmx+3QElGVkR2BRhF7HJkbDV10ZjSCvQlrEiHEJsKJ+Ez6QZVJ3T4bhZtnzZf3z1Uxdd+o2712/Yb8WyxprR2J55+MqLP/yu0y+8XBb20anVdcik/LPMJIWm8GWk1CSi5SQGEcu6vqqSEoVQR9VQpaDlHo3GyhrDdSDj5unLJICSbESu/eZl3/2vH6/96S/2X76srhsRGZPfuvT8y9f85P4NG/sV6rq26I4krRnTGtLEYn2F6bYm7SIK4IEud4CiGjNTTaVFZXbSlLKFSkDUojdMp6paVbPzC9f82xV33X3v1d/4zvInHzQY7Ov2ert3z339yxdvfGTLmv/+0f5TvdFgGLYdyzlivkZkgRbQfMSNRmHhVPN5MFNrLBmRdw5ftqBIhcU9gYA6oQqQGWyqu4g6Nzs7f+nqj8GaCy/+0tIDVozHo063t3vnnjNXveOo5zzzpFUXLO9X49Eg+qKv73obCIulx0EzocFnZF4PZknb8SDnCbHdkXpsrIJveOoX/MEoCl93KFtXFFDUYWEwfP4LjnzpC49807vOXXLA/k3TVM7Nz80f8/znnf/+d775/Ze48VAc6E0/8XhGQ6WQja+WkmFLvrIVc8tcdqC/qmjj5G4CIKRmip2dBsCijhPKeoGZTXQ7w+F439xeoXS7nbqxqSXT3778kxd86V8f+b9NE8p6NKQFfJRmLE3DuhEzkLQGZojil+gDwqbojDJ7IXK3J28hKlTbXcp2o8nSvoJFkrTGpvq9devWb/rzY9f++xV1Pd69a2bvvoX/vPqL3//pTT9f+4vl/e54sMCmYdOINWJGIxvz+0lgTwsW5Z2bNFpTOAwLx5D4fRR/Ai7SOTedqXSqBpSJMxBJrI8EpLHT7Vx3w60vfMGRl5x39mDfvtWf+MgjW3d8+vNfW7Z0cjQcSO5EFN1pitBoBkkiDyUq+L9IIBMAF5B29zzBK3MjujvxJMTKT+pQ+MZRTgxSxgMlIFDPnOfnF0448RVvP+Wk+x96+Krvfn+666xphEWTO3aCJTUtglkzCRtCX58DQIugFAUs0U+SZpBCis+Mu70DQ70tZ/EiomUFJZaH4wac83t2VXd+Yci6kapasmTSmkbKqYSWy6W3x3sg4aMvuJuJEIQvLbZtqXCJQGoYcNa3WVMZUoSkIvTUKKIhzqsWj0/1ezY2mu510O9RpBmNJDc7yLI25VlQpGKgBIxPflkexw/F/xZQk6kw7f0DJF3lplCMFkByXinJG9BirCg6fxSaNwCRopmXpCsRzpvYlvXrYGo7ZPDIybsVwJ9xKdCkROxEIFKlqkK+Hy0wCsRzvfGpRo5kcWDB/LlQjcMAJpY6I8Ys1xgac7g0/2R4CEq/mKUWrocrD4iQcp3iIdIn9ZN5+KQg1gl84AttuS3KVGfJDSC2k4dIGcmIOV5FvuzkT7ZI7oUhT8h18zjKIuJ7H8FkM1kKEAvSuWoyN3RjLbTo2iCO+0AS0sXmeorVRXzPz6ZYMcmB5Arx8WGLraEQv0RKq7Ucw9Yiu/KUztdGF5XeQ/E5zTy13SCbW4riCIV4AsHEI4nKTwqcNxRLQtNBINF+uHhwqYzKiQuKFaTIjxqUMxixybx4pCk4RtEtRtS+T/mbBt7UYurn51MSVqQ0RRCLhYF5eWbKEm0zubTkBKFPw2xaAa6c036aSEn5ceRuxSRTwY9AeUITtJg7STbACOEoR81QXJWGB1gIvsU9UzevbWxMFSPnXL9IieMucrcmZ8uxU9Yap8urKXbEaF9FnhdjFpincHIulgJ2mkfJWQRQ1lRym9jvujVuwzAOonH+jr5eJIXRhAZi2e5EKXofIwMUeMAtuisIDbyywhyPkQGtaNJLaqGSoZsWByIACCOM5vma0BXJbc74McdVLHa31j9oB6B0bNYGnNLTJGQLBUwib6bV8kBJ9hlNCGnGJbeCW/NhbXITB6ISzkAKcy+cDJmIZktjew8oV88C4bh4fBIozZahtOj6xWktytCeY1xs6MiTk2mKp3A4thwiFRnAwnqYQkHqYiTzLCCfsQORP2ZAqJitEGniNEx4MI1IMRSz6NtvqcQSn4WU1hVENGpdipFDT5tRtsCYUpXcAG6PuCIjaXG/RSNnaHU0mdBRoFrMwiwyEFoe/2xNV4J5gjGbUA4hLCYGkl1ZHszJZQz5K8ONzDKrUmpTmkkcpKX4yaI8UERa8mYUxYGonMQF4mhcEbvTCDJboSgvpqiLlGtFziSJBFnhWqduAq1RpyLUtdydkdUlU5IWmBSbFD7BfXKkl+QtMXGxkjjkaBAptIaZwZb+E/hWWDSuVQ7V+QnsVqUgtj1YAjlELI9SRRoQQwRaQZQ5Syh8w6JB5aInCn0ByUpZwBhkUSCLMTOvLPBYxMpwcCcm3hzl5AfQLZ4mbYIg7c6KZIYjwvxAtiJaO5QgnYtyRp1VHoBqq7xcIUpmQIsgY5LJRfRXcrFdsSDbOY4wkL1okmiRUMaWJIt5UoZkov36f35wZllthY/qAAAAAElFTkSuQmCC" alt="" class="w-12 h-12">
                        </div>
                        <h2 class="text-2xl md:text-3xl font-bold mb-2">What would you like to create?</h2>
                        <p class="text-gray-400">Choose the type of AI solution for your needs</p>
                    </div>
                    
                    <!-- Agent Type Selection Cards -->
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <!-- Conversational AI Card -->
                        <div id="type-card-conversational" onclick="selectAgentType('conversational')" 
                             class="card rounded-xl p-5 cursor-pointer border-2 border-purple-500 hover:border-purple-400 transition-all">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-2xl">ðŸ’¬</div>
                                <div>
                                    <h3 class="font-bold">Conversational AI</h3>
                                    <p class="text-xs text-gray-400">Chat & assist users</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-300 mb-3">An AI assistant that chats with users and helps with tasks through conversation.</p>
                            <div class="flex flex-wrap gap-1 mb-2">
                                <span class="px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300 text-xs">Chat</span>
                                <span class="px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300 text-xs">Q&A</span>
                                <span class="px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300 text-xs">Support</span>
                            </div>
                            <div class="text-sm text-purple-400 font-medium">âœ“ Selected</div>
                        </div>
                        
                        <!-- Workflow Automation Card -->
                        <div id="type-card-process" onclick="selectAgentType('process')" 
                             class="card rounded-xl p-5 cursor-pointer border-2 border-transparent hover:border-green-500 transition-all">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-2xl">ðŸ”„</div>
                                <div>
                                    <h3 class="font-bold">Workflow Automation</h3>
                                    <p class="text-xs text-gray-400">Automate processes</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-300 mb-3">Automated workflows with approvals, integrations, and step-by-step processes.</p>
                            <div class="flex flex-wrap gap-1 mb-2">
                                <span class="px-2 py-0.5 rounded-full bg-green-500/20 text-green-300 text-xs">Approvals</span>
                                <span class="px-2 py-0.5 rounded-full bg-green-500/20 text-green-300 text-xs">Integrations</span>
                                <span class="px-2 py-0.5 rounded-full bg-green-500/20 text-green-300 text-xs">Automation</span>
                            </div>
                            <div class="text-sm text-gray-500">Click to select</div>
                        </div>
                    </div>
                    
                    <!-- Conversational AI Section -->
                    <div id="section-conversational" class="card rounded-xl p-6 md:p-8">
                        <label class="text-sm text-gray-400 mb-2 block">What should your assistant do? *</label>
                        <textarea id="w-initial-goal" rows="4" class="input-field w-full rounded-lg px-4 py-4 text-lg" placeholder="Example: Help customers track their orders, answer product questions, and process returns..."></textarea>
                        
                        <div class="mt-6 flex flex-col sm:flex-row gap-3">
                            <button onclick="generateAgentConfig()" id="btn-generate-config" class="btn-primary px-8 py-3 rounded-lg flex-1 flex items-center justify-center gap-2 text-lg">
                                <span>âœ¨</span> Create My Assistant
                            </button>
                        </div>
                        
                        <div class="mt-6 pt-6 border-t border-gray-700">
                            <p class="text-sm text-gray-500 mb-3">Or start with a template:</p>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="useAgentTemplate('customer_support')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition">ðŸŽ§ Customer Support</button>
                                <button onclick="useAgentTemplate('sales')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition">ðŸ’¼ Sales Assistant</button>
                                <button onclick="useAgentTemplate('hr')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition">ðŸ‘¥ HR Helper</button>
                                <button onclick="useAgentTemplate('research')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition">ðŸ”¬ Research Analyst</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Workflow Automation Section (Hidden by default) -->
                    <div id="section-process" class="hidden card rounded-xl p-6 md:p-8" style="background: linear-gradient(135deg, rgba(34,197,94,0.05), rgba(20,184,166,0.05)); border: 1px solid rgba(34,197,94,0.2);">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-3xl mb-4">ðŸ”„</div>
                            <h3 class="text-xl font-bold mb-2">Visual Workflow Builder</h3>
                            <p class="text-gray-400">Design powerful automations with drag & drop</p>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <!-- Option 1: Visual Builder -->
                            <div onclick="openVisualBuilder()" class="p-5 rounded-xl bg-gradient-to-br from-green-500/10 to-teal-500/10 border border-green-500/30 cursor-pointer hover:border-green-400 transition-all group">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-green-500 flex items-center justify-center text-xl">ðŸŽ¨</div>
                                    <div class="font-semibold">Visual Builder</div>
                                    <span class="ml-auto text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400">Recommended</span>
                                </div>
                                <p class="text-sm text-gray-400 mb-3">Drag & drop nodes, connect steps visually, configure with forms - no coding required.</p>
                                <div class="flex items-center gap-2 text-green-400 text-sm group-hover:translate-x-1 transition-transform">
                                    <span>Open Builder</span>
                                    <span>â†’</span>
                                </div>
                            </div>
                            
                            <!-- Option 2: AI Generate -->
                            <div onclick="showAIWorkflowInput()" class="p-5 rounded-xl bg-gray-800/50 border border-gray-700 cursor-pointer hover:border-purple-500 transition-all group">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-lg bg-purple-500 flex items-center justify-center text-xl">ðŸ¤–</div>
                                    <div class="font-semibold">AI Generate</div>
                                </div>
                                <p class="text-sm text-gray-400 mb-3">Describe what you need in plain English, AI creates the workflow for you.</p>
                                <div class="flex items-center gap-2 text-purple-400 text-sm group-hover:translate-x-1 transition-transform">
                                    <span>Generate with AI</span>
                                    <span>â†’</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Input (Hidden by default) -->
                        <div id="ai-workflow-input" class="hidden">
                            <label class="text-sm text-gray-400 mb-2 block">Describe your workflow *</label>
                            <textarea id="w-process-goal" rows="3" class="input-field w-full rounded-lg px-4 py-3" placeholder="When an expense over $500 is submitted, send to manager for approval..."></textarea>
                            <div class="mt-4 flex gap-3">
                                <button onclick="generateProcessConfig()" class="flex-1 px-6 py-3 rounded-lg text-white font-medium flex items-center justify-center gap-2" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);">
                                    <span>âœ¨</span> Generate Workflow
                                </button>
                                <button onclick="hideAIWorkflowInput()" class="px-4 py-3 rounded-lg bg-gray-700 text-gray-300">Cancel</button>
                            </div>
                        </div>
                        
                        <!-- Quick Templates -->
                        <div id="workflow-templates" class="mt-4 pt-4 border-t border-gray-700/50">
                            <p class="text-sm text-gray-500 mb-3">Quick start templates:</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <button onclick="openBuilderWithTemplate('approval')" class="p-3 rounded-lg bg-gray-800/50 hover:bg-gray-700 text-left transition">
                                    <span class="text-lg">âœ…</span>
                                    <div class="text-sm font-medium mt-1">Approval</div>
                                </button>
                                <button onclick="openBuilderWithTemplate('onboarding')" class="p-3 rounded-lg bg-gray-800/50 hover:bg-gray-700 text-left transition">
                                    <span class="text-lg">ðŸ‘‹</span>
                                    <div class="text-sm font-medium mt-1">Onboarding</div>
                                </button>
                                <button onclick="openBuilderWithTemplate('notification')" class="p-3 rounded-lg bg-gray-800/50 hover:bg-gray-700 text-left transition">
                                    <span class="text-lg">ðŸ””</span>
                                    <div class="text-sm font-medium mt-1">Notifications</div>
                                </button>
                                <button onclick="openBuilderWithTemplate('integration')" class="p-3 rounded-lg bg-gray-800/50 hover:bg-gray-700 text-left transition">
                                    <span class="text-lg">ðŸ”—</span>
                                    <div class="text-sm font-medium mt-1">Integration</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Generating Animation -->
                <div id="wizard-generating" class="hidden max-w-2xl mx-auto">
                    <div class="card rounded-xl p-8 text-center">
                        <div class="relative w-24 h-24 mx-auto mb-6">
                            <div class="absolute inset-0 rounded-full border-4 border-purple-500/30 animate-ping"></div>
                            <div class="absolute inset-2 rounded-full border-4 border-blue-500/30 animate-ping" style="animation-delay: 0.2s"></div>
                            <div class="absolute inset-4 rounded-full border-4 border-purple-500/30 animate-ping" style="animation-delay: 0.4s"></div>
                            <div class="relative w-full h-full rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-3xl">
                                ðŸ§ 
                            </div>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Configuring Your Agent...</h3>
                        <p class="text-gray-400 mb-6" id="generating-status">Analyzing your goal...</p>
                        <div class="space-y-2 text-left max-w-md mx-auto">
                            <div class="flex items-center gap-3 text-sm" id="gen-step-1">
                                <span class="w-5 h-5 rounded-full bg-purple-500 flex items-center justify-center animate-pulse">âœ“</span>
                                <span>Understanding your requirements</span>
                            </div>
                            <div class="flex items-center gap-3 text-sm text-gray-500" id="gen-step-2">
                                <span class="w-5 h-5 rounded-full bg-gray-700 flex items-center justify-center">â—‹</span>
                                <span>Selecting optimal AI model</span>
                            </div>
                            <div class="flex items-center gap-3 text-sm text-gray-500" id="gen-step-3">
                                <span class="w-5 h-5 rounded-full bg-gray-700 flex items-center justify-center">â—‹</span>
                                <span>Defining tasks & capabilities</span>
                            </div>
                            <div class="flex items-center gap-3 text-sm text-gray-500" id="gen-step-4">
                                <span class="w-5 h-5 rounded-full bg-gray-700 flex items-center justify-center">â—‹</span>
                                <span>Recommending tools</span>
                            </div>
                            <div class="flex items-center gap-3 text-sm text-gray-500" id="gen-step-5">
                                <span class="w-5 h-5 rounded-full bg-gray-700 flex items-center justify-center">â—‹</span>
                                <span>Setting up guardrails</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Basics (AI-Generated, Editable) -->
                <div id="wizard-step-1" class="hidden max-w-5xl mx-auto">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-xl">âš™ï¸</span>
                        <div>
                            <h3 class="text-lg font-bold">Basic Configuration</h3>
                            <p class="text-xs text-gray-400">AI-suggested settings based on your goal</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
                        <!-- Main Config - Left Side -->
                        <div class="lg:col-span-8 space-y-4">
                            <!-- Agent Identity - Compact -->
                            <div class="card rounded-xl p-4">
                                <h4 class="text-sm font-semibold mb-3 flex items-center gap-2 text-gray-300">
                                    <span>ðŸ¤–</span> Agent Identity
                                </h4>
                                <div class="flex gap-4">
                                    <!-- Icon Upload -->
                                    <div class="flex-shrink-0">
                                        <label class="text-xs text-gray-400 mb-1 block">Icon</label>
                                        <div class="relative">
                                            <div id="w-icon-preview" class="w-16 h-16 rounded-xl bg-gray-800 border-2 border-dashed border-gray-600 hover:border-purple-500 cursor-pointer flex items-center justify-center text-2xl transition-all"
                                                 onclick="document.getElementById('w-icon-upload').click()">
                                                <span id="w-icon-emoji">ðŸ¤–</span>
                                                <img id="w-icon-image" class="hidden w-full h-full object-cover rounded-xl" src="" alt="Icon">
                                            </div>
                                            <input type="file" id="w-icon-upload" class="hidden" accept="image/*" onchange="handleIconUpload(event)">
                                            <input type="hidden" id="w-icon" value="ðŸ¤–">
                                            <input type="hidden" id="w-icon-type" value="emoji">
                                            <input type="hidden" id="w-icon-data" value="">
                                            <button onclick="showIconPicker()" class="absolute -bottom-1 -right-1 w-6 h-6 bg-purple-600 rounded-full text-xs flex items-center justify-center hover:bg-purple-500 transition" title="Change icon">
                                                âœï¸
                                            </button>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 text-center">Click to upload</p>
                                    </div>
                                    <!-- Name -->
                                    <div class="flex-1">
                                        <label class="text-xs text-gray-400 mb-1 block">Name *</label>
                                        <input type="text" id="w-name" class="input-field w-full rounded-lg px-3 py-2 text-sm" placeholder="Agent Name" oninput="updateAgentNameInPersonality()">
                                        <p class="text-[10px] text-purple-400 mt-1" id="w-name-hint">âœ¨ AI suggested name based on your goal</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Enhanced Goal - Compact -->
                            <div class="card rounded-xl p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-semibold flex items-center gap-2 text-gray-300">
                                        <span>ðŸŽ¯</span> Enhanced Goal
                                        <span class="text-[10px] bg-purple-500/20 text-purple-300 px-1.5 py-0.5 rounded">AI Optimized</span>
                                    </h4>
                                    <div id="goal-update-indicator" class="hidden flex items-center gap-2">
                                        <div class="w-3 h-3 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                                        <span class="text-[10px] text-purple-400">Updating recommendations...</span>
                                    </div>
                                </div>
                                <textarea id="w-goal" rows="3" class="input-field w-full rounded-lg px-3 py-2 text-sm" placeholder="Your agent's goal..." oninput="onGoalChange()"></textarea>
                                <p class="text-[10px] text-gray-500 mt-1" id="goal-hint">Enhanced version of your goal, optimized for better AI understanding</p>
                            </div>
                            
                            <!-- Personality - Interactive Sliders -->
                            <div class="card rounded-xl p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="text-sm font-semibold flex items-center gap-2 text-gray-300">
                                        <span>ðŸŽ­</span> Personality Configuration
                                    </h4>
                                    <button onclick="resetPersonalityDefaults()" class="text-[10px] text-gray-500 hover:text-gray-300 transition">
                                        â†º Reset to Defaults
                                    </button>
                                </div>
                                
                                <!-- Personality Preview -->
                                <div class="bg-gradient-to-r from-purple-900/20 to-blue-900/20 border border-purple-500/20 rounded-lg p-3 mb-4">
                                    <div class="flex items-start gap-2">
                                        <span class="text-lg">âœ¨</span>
                                        <div class="flex-1">
                                            <p class="text-xs font-medium text-purple-300 mb-1">Personality Preview</p>
                                            <p class="text-xs text-gray-400" id="personality-preview-text">
                                                Your agent will be professional and balanced in responses.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Personality Sliders -->
                                <div class="space-y-4" id="personality-sliders">
                                    
                                    <!-- Creativity Slider -->
                                    <div class="personality-slider-group">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm">ðŸŽ¨</span>
                                                <span class="text-xs font-medium text-gray-300">Creativity</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="p-creativity-num" min="1" max="10" value="5" 
                                                       class="w-12 text-center text-xs bg-gray-800 text-white border border-gray-700 rounded px-1 py-0.5"
                                                       onchange="syncSlider('creativity', this.value)">
                                                <span class="text-[10px] text-gray-500">/10</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-gray-500 w-16">Factual</span>
                                            <input type="range" id="p-creativity" min="1" max="10" value="5" 
                                                   class="personality-slider flex-1" 
                                                   oninput="updatePersonalitySlider('creativity', this.value)">
                                            <span class="text-[10px] text-gray-500 w-16 text-right">Creative</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 ml-6" id="p-creativity-desc">
                                            Balanced between facts and creative suggestions.
                                        </p>
                                    </div>
                                    
                                    <!-- Response Length Slider -->
                                    <div class="personality-slider-group">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm">ðŸ“</span>
                                                <span class="text-xs font-medium text-gray-300">Response Length</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="p-length-num" min="1" max="10" value="5" 
                                                       class="w-12 text-center text-xs bg-gray-800 text-white border border-gray-700 rounded px-1 py-0.5"
                                                       onchange="syncSlider('length', this.value)">
                                                <span class="text-[10px] text-gray-500">/10</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-gray-500 w-16">Brief</span>
                                            <input type="range" id="p-length" min="1" max="10" value="5" 
                                                   class="personality-slider flex-1" 
                                                   oninput="updatePersonalitySlider('length', this.value)">
                                            <span class="text-[10px] text-gray-500 w-16 text-right">Detailed</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 ml-6" id="p-length-desc">
                                            Moderately detailed responses with key information.
                                        </p>
                                    </div>
                                    
                                    <!-- Formality Slider -->
                                    <div class="personality-slider-group">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm">ðŸ‘”</span>
                                                <span class="text-xs font-medium text-gray-300">Formality</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="p-formality-num" min="1" max="10" value="7" 
                                                       class="w-12 text-center text-xs bg-gray-800 text-white border border-gray-700 rounded px-1 py-0.5"
                                                       onchange="syncSlider('formality', this.value)">
                                                <span class="text-[10px] text-gray-500">/10</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-gray-500 w-16">Casual</span>
                                            <input type="range" id="p-formality" min="1" max="10" value="7" 
                                                   class="personality-slider flex-1" 
                                                   oninput="updatePersonalitySlider('formality', this.value)">
                                            <span class="text-[10px] text-gray-500 w-16 text-right">Formal</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 ml-6" id="p-formality-desc">
                                            Professional tone suitable for business communication.
                                        </p>
                                    </div>
                                    
                                    <!-- Empathy Slider -->
                                    <div class="personality-slider-group">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm">ðŸ’—</span>
                                                <span class="text-xs font-medium text-gray-300">Empathy</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="p-empathy-num" min="1" max="10" value="6" 
                                                       class="w-12 text-center text-xs bg-gray-800 text-white border border-gray-700 rounded px-1 py-0.5"
                                                       onchange="syncSlider('empathy', this.value)">
                                                <span class="text-[10px] text-gray-500">/10</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-gray-500 w-16">Direct</span>
                                            <input type="range" id="p-empathy" min="1" max="10" value="6" 
                                                   class="personality-slider flex-1" 
                                                   oninput="updatePersonalitySlider('empathy', this.value)">
                                            <span class="text-[10px] text-gray-500 w-16 text-right">Empathetic</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 ml-6" id="p-empathy-desc">
                                            Shows understanding while staying solution-focused.
                                        </p>
                                    </div>
                                    
                                    <!-- Proactivity Slider -->
                                    <div class="personality-slider-group">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm">ðŸš€</span>
                                                <span class="text-xs font-medium text-gray-300">Proactivity</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="p-proactivity-num" min="1" max="10" value="5" 
                                                       class="w-12 text-center text-xs bg-gray-800 text-white border border-gray-700 rounded px-1 py-0.5"
                                                       onchange="syncSlider('proactivity', this.value)">
                                                <span class="text-[10px] text-gray-500">/10</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-gray-500 w-16">Reactive</span>
                                            <input type="range" id="p-proactivity" min="1" max="10" value="5" 
                                                   class="personality-slider flex-1" 
                                                   oninput="updatePersonalitySlider('proactivity', this.value)">
                                            <span class="text-[10px] text-gray-500 w-16 text-right">Proactive</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 ml-6" id="p-proactivity-desc">
                                            Answers questions and occasionally suggests next steps.
                                        </p>
                                    </div>
                                    
                                    <!-- Confidence Slider -->
                                    <div class="personality-slider-group">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-sm">ðŸ’ª</span>
                                                <span class="text-xs font-medium text-gray-300">Confidence</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <input type="number" id="p-confidence-num" min="1" max="10" value="7" 
                                                       class="w-12 text-center text-xs bg-gray-800 text-white border border-gray-700 rounded px-1 py-0.5"
                                                       onchange="syncSlider('confidence', this.value)">
                                                <span class="text-[10px] text-gray-500">/10</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-gray-500 w-16">Cautious</span>
                                            <input type="range" id="p-confidence" min="1" max="10" value="7" 
                                                   class="personality-slider flex-1" 
                                                   oninput="updatePersonalitySlider('confidence', this.value)">
                                            <span class="text-[10px] text-gray-500 w-16 text-right">Confident</span>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1 ml-6" id="p-confidence-desc">
                                            Provides clear answers while acknowledging limitations when appropriate.
                                        </p>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                        
                        <!-- LLM Model Selection - Right Side -->
                        <div class="lg:col-span-4">
                            <div class="card rounded-xl p-4 sticky top-4">
                                <h4 class="text-sm font-semibold mb-3 flex items-center gap-2 text-gray-300">
                                    <span>ðŸ§ </span> AI Model
                                </h4>
                                
                                <div id="llm-models-list" class="space-y-2 max-h-[280px] overflow-y-auto pr-1">
                                    <!-- Models will be populated dynamically based on configured providers -->
                                </div>
                                
                                <!-- Model Info -->
                                <div id="model-explanation" class="mt-3 p-2 bg-gray-800/50 rounded-lg text-xs">
                                    <p class="text-gray-400" id="model-why-text">Select a model to see details</p>
                                </div>
                                
                                <!-- Configure Link -->
                                <div class="mt-2 text-center">
                                    <a href="#" onclick="navigate('settings'); return false;" class="text-[10px] text-purple-400 hover:text-purple-300">
                                        âš™ï¸ Configure API Keys in Settings
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation handled by sticky header -->
                </div>

                <!-- Icon Picker Modal -->
                <div id="icon-picker-modal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                    <div class="modal-content-box rounded-xl p-4 w-full max-w-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-sm">Choose Icon</h3>
                            <button onclick="closeIconPicker()" class="text-gray-400 hover:text-white">âœ•</button>
                        </div>
                        
                        <div class="space-y-3">
                            <!-- Upload Option -->
                            <div class="p-3 rounded-lg border-2 border-dashed cursor-pointer transition text-center upload-box"
                                 style="background:var(--bg-input);border-color:var(--border-color);"
                                 onclick="document.getElementById('w-icon-upload').click(); closeIconPicker();">
                                <span class="text-2xl">ðŸ“¤</span>
                                <p class="text-xs mt-1" style="color:var(--text-secondary);">Upload Image</p>
                                <p class="text-[10px]" style="color:var(--text-muted);">PNG, JPG, SVG (max 500KB)</p>
                            </div>
                            
                            <!-- Emoji Picker -->
                            <div>
                                <p class="text-xs mb-2" style="color:var(--text-secondary);">Or choose an emoji:</p>
                                <div id="emoji-grid" class="grid grid-cols-8 gap-1 max-h-32 overflow-y-auto">
                                    <!-- Emojis will be populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Tasks (AI-Generated, Editable) -->
                <div id="wizard-step-2" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">ðŸ“‹</span>
                            <div>
                                <h3 class="text-xl font-bold">Tasks & Capabilities</h3>
                                <p class="text-sm text-gray-400">What your agent can do. AI has suggested these based on your goal.</p>
                            </div>
                        </div>
                        <button onclick="addTask()" class="btn-primary px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                            <span>+</span> Add Task
                        </button>
                    </div>
                    
                    <div id="w-tasks" class="space-y-4">
                        <!-- Tasks will be populated by JS -->
                    </div>
                    
                    <!-- Navigation handled by sticky header -->
                </div>

                <!-- Step 3: Tools Selection -->
                <div id="wizard-step-3" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="text-2xl">ðŸ”§</span>
                        <div>
                            <h3 class="text-xl font-bold">Tools & Data Sources</h3>
                            <p class="text-sm text-gray-400">Select the tools your agent will use</p>
                        </div>
                    </div>
                    
                    <!-- Two Options -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <!-- Option 1: Select Configured Tool -->
                        <div onclick="showSelectToolModal()" class="card rounded-xl p-6 cursor-pointer hover:border-purple-500 transition-all border-2 border-transparent hover:bg-purple-500/5">
                            <div class="text-center">
                                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-purple-500/20 flex items-center justify-center">
                                    <span class="text-3xl">ðŸ“¦</span>
                                </div>
                                <h4 class="font-bold text-lg mb-2">Select Configured Tool</h4>
                                <p class="text-sm text-gray-400">Choose from existing tools you've already created</p>
                            </div>
                        </div>
                        
                        <!-- Configure New Tool option removed for cleaner UX -->
                    </div>
                    
                    <!-- Selected Tools -->
                    <div class="card rounded-xl p-5 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-medium flex items-center gap-2">
                                <span>âœ…</span> Selected Tools
                                <span id="selected-tools-count" class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded-full">0</span>
                            </h4>
                        </div>
                        <div id="w-tools-list" class="space-y-2">
                            <div class="text-center py-6 text-gray-500 text-sm">
                                <span class="text-2xl block mb-2">ðŸ”§</span>
                                No tools selected yet<br>
                                <span class="text-xs">Click one of the options above to add tools</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation handled by sticky header -->
                </div>
                
                <!-- Select Tool Modal -->
                <div id="select-tool-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
                    <div class="modal-content-box rounded-2xl w-full max-w-3xl mx-4 max-h-[85vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="font-bold text-lg">ðŸ“¦ Select Configured Tools</h3>
                            <button onclick="closeSelectToolModal()" class="p-2 hover:bg-gray-700 rounded-lg">âœ•</button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[60vh]">
                            <div id="available-tools-list" class="space-y-3">
                                <div class="text-center py-8 text-gray-500">
                                    <div class="animate-spin w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                                    <p class="text-sm">Loading tools...</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
                            <button onclick="closeSelectToolModal()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Cancel</button>
                            <button onclick="confirmToolSelection()" class="px-6 py-2 rounded-lg bg-purple-600 hover:bg-purple-500">Add Selected</button>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Access Control (Separate Step) -->
                <div id="wizard-step-4" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center gap-2 mb-6">
                        <span class="text-2xl">ðŸ”</span>
                        <div>
                            <h3 class="text-xl font-bold">Access Control</h3>
                            <p class="text-sm text-gray-400">Define who can use this agent and manage their permissions</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Access Control - Modern Design -->
                        <div id="wizard-access-control-section" class="rounded-2xl overflow-hidden" style="background: linear-gradient(145deg, rgba(139, 92, 246, 0.08) 0%, rgba(59, 130, 246, 0.05) 100%); border: 1px solid rgba(139, 92, 246, 0.2);">
                            
                            <!-- Header with ownership indicator -->
                            <div class="p-6 border-b border-purple-500/20" style="background: linear-gradient(90deg, rgba(139, 92, 246, 0.15) 0%, transparent 100%);">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-bold text-white flex items-center gap-2">
                                                Access Control
                                                <span id="ac-owner-badge" class="hidden text-xs px-2 py-1 rounded-full font-medium" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #fff;">
                                                    ðŸ‘‘ Owner
                                                </span>
                                            </h4>
                                            <p class="text-sm text-gray-400">Define who can interact with this agent and their permissions</p>
                                        </div>
                                    </div>
                                    <div id="ac-quick-stats" class="hidden md:flex items-center gap-4 text-sm">
                                        <div class="text-center px-4 py-2 rounded-lg bg-white/5">
                                            <div class="text-2xl font-bold text-purple-400" id="ac-stat-users">0</div>
                                            <div class="text-xs text-gray-500">Users</div>
                                        </div>
                                        <div class="text-center px-4 py-2 rounded-lg bg-white/5">
                                            <div class="text-2xl font-bold text-blue-400" id="ac-stat-groups">0</div>
                                            <div class="text-xs text-gray-500">Groups</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-6 space-y-8">
                                
                                <!-- Step 1: Access Level Selection -->
                                <div class="space-y-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-purple-500/20 text-purple-400 flex items-center justify-center font-bold text-sm">1</div>
                                        <div>
                                            <h5 class="font-semibold text-white">Access Level</h5>
                                            <p class="text-xs text-gray-500">Who should be able to use this agent?</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="wizard-access-type-container">
                                        <!-- Public Access -->
                                        <div class="access-type-card group cursor-pointer rounded-2xl p-5 transition-all duration-300 hover:scale-[1.02]" 
                                             data-value="public" 
                                             onclick="selectWizardAccessType('public')"
                                             style="background: rgba(34, 197, 94, 0.05); border: 2px solid rgba(34, 197, 94, 0.2);">
                                            <div class="flex items-start gap-4">
                                                <div class="w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0 transition-all group-hover:scale-110" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(34, 197, 94, 0.1) 100%);">
                                                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                    </svg>
                                                </div>
                                                <div class="flex-1">
                                                    <h6 class="font-semibold text-white mb-1">Public</h6>
                                                    <p class="text-xs text-gray-400 leading-relaxed">Anyone can access without logging in. Best for public-facing assistants.</p>
                                                </div>
                                                <div class="access-check hidden w-6 h-6 rounded-full bg-green-500 flex items-center justify-center flex-shrink-0">
                                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Authenticated Access -->
                                        <div class="access-type-card group cursor-pointer rounded-2xl p-5 transition-all duration-300 hover:scale-[1.02] ac-selected" 
                                             data-value="authenticated" 
                                             onclick="selectWizardAccessType('authenticated')"
                                             style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.05) 100%); border: 2px solid rgba(59, 130, 246, 0.5); box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);">
                                            <div class="flex items-start gap-4">
                                                <div class="w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0 transition-all group-hover:scale-110" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.3) 0%, rgba(59, 130, 246, 0.1) 100%);">
                                                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                                                    </svg>
                                                </div>
                                                <div class="flex-1">
                                                    <h6 class="font-semibold text-white mb-1">Authenticated</h6>
                                                    <p class="text-xs text-gray-400 leading-relaxed">Any logged-in user in your organization can access. Recommended for internal tools.</p>
                                                    <span class="inline-block mt-2 text-xs px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400">Recommended</span>
                                                </div>
                                                <div class="access-check w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0">
                                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Specific Users -->
                                        <div class="access-type-card group cursor-pointer rounded-2xl p-5 transition-all duration-300 hover:scale-[1.02]" 
                                             data-value="specific" 
                                             onclick="selectWizardAccessType('specific')"
                                             style="background: rgba(168, 85, 247, 0.05); border: 2px solid rgba(168, 85, 247, 0.2);">
                                            <div class="flex items-start gap-4">
                                                <div class="w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0 transition-all group-hover:scale-110" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(168, 85, 247, 0.1) 100%);">
                                                    <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                                    </svg>
                                                </div>
                                                <div class="flex-1">
                                                    <h6 class="font-semibold text-white mb-1">Specific Users</h6>
                                                    <p class="text-xs text-gray-400 leading-relaxed">Only selected users and groups can access. Maximum control over who uses this agent.</p>
                                                </div>
                                                <div class="access-check hidden w-6 h-6 rounded-full bg-purple-500 flex items-center justify-center flex-shrink-0">
                                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step 2: User/Group Selection (shown when "specific" is selected) -->
                                <div id="wizard-access-specific-section" class="hidden space-y-4 animate-fadeIn">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-purple-500/20 text-purple-400 flex items-center justify-center font-bold text-sm">2</div>
                                        <div>
                                            <h5 class="font-semibold text-white">Select Users & Groups</h5>
                                            <p class="text-xs text-gray-500">Choose who can access this agent</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Smart Search -->
                                    <div class="relative">
                                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                            </svg>
                                        </div>
                                        <input type="text" id="wizard-access-search" 
                                               class="w-full rounded-xl px-12 py-4 placeholder-gray-400 transition-all focus:ring-2 focus:ring-blue-500/50" 
                                               style="background: #1f2937; border: 2px solid #374151; color: #f3f4f6;"
                                               placeholder="Search by name, email, or group...">
                                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-xs text-gray-400 hidden md:block">
                                            Press <kbd class="px-1.5 py-0.5 rounded bg-gray-600 text-gray-200">Enter</kbd> to add
                                        </div>
                                    </div>
                                    
                                    <!-- Search Results Dropdown -->
                                    <div id="wizard-access-search-results" class="hidden mt-2 rounded-xl overflow-hidden shadow-xl" style="background: #1f2937; border: 2px solid #374151;">
                                        <!-- Results will be populated dynamically -->
                                    </div>
                                    
                                    <!-- Selected Entities -->
                                    <div id="wizard-access-selected" class="flex flex-wrap gap-3">
                                        <div class="text-sm text-gray-500 italic py-2">Select users or groups from the search above</div>
                                    </div>
                                </div>
                                
                                <!-- Step 3: Task Permissions -->
                                <div id="wizard-task-permissions-section" class="hidden space-y-4 animate-fadeIn">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full bg-purple-500/20 text-purple-400 flex items-center justify-center font-bold text-sm">3</div>
                                            <div>
                                                <h5 class="font-semibold text-white">Task Permissions</h5>
                                                <p class="text-xs text-gray-500">Fine-tune which tasks each user can perform</p>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="allowAllTasks()" class="px-3 py-1.5 text-xs rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 transition-all flex items-center gap-1">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                Allow All
                                            </button>
                                            <button onclick="denyAllTasks()" class="px-3 py-1.5 text-xs rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-all flex items-center gap-1">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                                Deny All
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="wizard-task-permissions-grid" class="space-y-3 rounded-xl p-4" style="background: rgba(0,0,0,0.2);">
                                        <p class="text-sm text-gray-500 italic text-center py-4">Define tasks in the Tasks step first</p>
                                    </div>
                                </div>
                                
                                <!-- Step 4: Delegate Admin Access (Owner Only) -->
                                <div id="wizard-delegate-admin-section" class="hidden space-y-4 animate-fadeIn">
                                    <div class="flex items-center gap-3 mb-4">
                                        <div class="w-8 h-8 rounded-full bg-amber-500/20 text-amber-400 flex items-center justify-center font-bold text-sm">4</div>
                                        <div>
                                            <h5 class="font-semibold text-white flex items-center gap-2">
                                                Delegate Agent Management
                                                <span class="text-xs px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400">Owner Only</span>
                                            </h5>
                                            <p class="text-xs text-gray-500">Grant specific permissions to other users to help manage this agent</p>
                                        </div>
                                    </div>
                                    
                                    <div class="rounded-xl p-5" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.05) 100%); border: 1px solid rgba(245, 158, 11, 0.3);">
                                        
                                        <!-- Search for admins -->
                                        <div class="mb-5">
                                            <label class="text-sm font-medium text-gray-300 mb-2 block">Add Admin</label>
                                            <div class="relative">
                                                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-amber-400/50">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                                    </svg>
                                                </div>
                                                <input type="text" id="wizard-admin-search" 
                                                       class="w-full rounded-xl px-12 py-3 placeholder-gray-400 transition-all focus:ring-2 focus:ring-amber-500/50" 
                                                       style="background: #1f2937; border: 2px solid #374151; color: #f3f4f6;"
                                                       placeholder="Search users or groups to add as admin...">
                                            </div>
                                            <div id="wizard-admin-search-results" class="hidden mt-2 rounded-xl overflow-hidden max-h-48 overflow-y-auto shadow-xl" style="background: #1f2937; border: 2px solid #374151;">
                                            </div>
                                        </div>
                                        
                                        <!-- Current Delegated Admins with Permissions -->
                                        <div class="space-y-4">
                                            <div class="flex items-center justify-between">
                                                <h6 class="text-sm font-medium text-gray-300">Delegated Admins & Permissions</h6>
                                                <button type="button" onclick="showPermissionsGuide()" class="text-xs text-amber-400 hover:text-amber-300 flex items-center gap-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                    </svg>
                                                    What do permissions mean?
                                                </button>
                                            </div>
                                            
                                            <div id="wizard-delegated-admins-list" class="space-y-3">
                                                <div class="text-sm text-gray-500 italic text-center py-4">
                                                    You are the only admin. Search above to add users or groups.
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Permissions Quick Reference (initially hidden) -->
                                        <div id="permissions-guide" class="hidden mt-5 p-4 rounded-lg" style="background: rgba(0,0,0,0.3);">
                                            <h6 class="text-sm font-medium text-amber-400 mb-3">ðŸ“‹ Permission Reference</h6>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
                                                <div class="space-y-2">
                                                    <div class="font-medium text-white">ðŸŽ¨ Configuration</div>
                                                    <div class="text-gray-400 pl-4">
                                                        <div><span class="text-blue-400">edit_basic_info:</span> Name, icon, description</div>
                                                        <div><span class="text-blue-400">edit_personality:</span> Agent personality</div>
                                                        <div><span class="text-blue-400">edit_model:</span> LLM model selection</div>
                                                        <div><span class="text-blue-400">edit_guardrails:</span> Safety settings</div>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <div class="font-medium text-white">ðŸ§© Components</div>
                                                    <div class="text-gray-400 pl-4">
                                                        <div><span class="text-purple-400">manage_tasks:</span> Add/edit/delete tasks</div>
                                                        <div><span class="text-purple-400">manage_tools:</span> Add/edit/delete tools</div>
                                                        <div><span class="text-purple-400">manage_knowledge:</span> Knowledge base</div>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <div class="font-medium text-white">ðŸ” Access Control</div>
                                                    <div class="text-gray-400 pl-4">
                                                        <div><span class="text-green-400">manage_access:</span> End-user access</div>
                                                        <div><span class="text-green-400">manage_task_permissions:</span> Task permissions</div>
                                                    </div>
                                                </div>
                                                <div class="space-y-2">
                                                    <div class="font-medium text-white">ðŸš€ Deployment</div>
                                                    <div class="text-gray-400 pl-4">
                                                        <div><span class="text-yellow-400">publish_agent:</span> Publish/unpublish</div>
                                                        <div><span class="text-red-400">delete_agent:</span> Delete (dangerous!)</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3 pt-3 border-t border-gray-700">
                                                <div class="flex items-center gap-2 text-xs text-amber-400">
                                                    <span>â­</span>
                                                    <span><strong>full_admin</strong> = All permissions except delete_agent</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation handled by sticky header -->
                </div>

                <!-- Step 5: Guardrails & Safety (Moved from Step 4) -->
                <div id="wizard-step-5" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center gap-2 mb-6">
                        <span class="text-2xl">ðŸ›¡ï¸</span>
                        <div>
                            <h3 class="text-xl font-bold">Guardrails & Safety</h3>
                            <p class="text-sm text-gray-400">Protect your agent and users with these safety settings</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Anti-Hallucination -->
                        <div class="card rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">ðŸŽ¯</span>
                                    <div>
                                        <h4 class="font-semibold">Anti-Hallucination</h4>
                                        <p class="text-sm text-gray-400">Ensure your agent only provides accurate information</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="guard-anti-hallucination" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-red-400 peer-focus:ring-2 peer-focus:ring-green-400 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                            <div id="anti-hallucination-options" class="space-y-3 pl-10">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-cite-sources" class="w-4 h-4 rounded" checked>
                                    <div>
                                        <span class="text-sm">Always cite sources</span>
                                        <p class="text-xs text-gray-500">Agent must reference where information comes from</p>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-admit-uncertainty" class="w-4 h-4 rounded" checked>
                                    <div>
                                        <span class="text-sm">Admit when uncertain</span>
                                        <p class="text-xs text-gray-500">Say "I don't know" instead of guessing</p>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-verify-facts" class="w-4 h-4 rounded" checked>
                                    <div>
                                        <span class="text-sm">Verify against knowledge base</span>
                                        <p class="text-xs text-gray-500">Cross-check answers with your data sources</p>
                                    </div>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-no-speculation" class="w-4 h-4 rounded">
                                    <div>
                                        <span class="text-sm">No speculation</span>
                                        <p class="text-xs text-gray-500">Only state confirmed facts, never hypothesize</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Content Boundaries -->
                        <div class="card rounded-xl p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-2xl">ðŸš§</span>
                                <div>
                                    <h4 class="font-semibold">Content Boundaries</h4>
                                    <p class="text-sm text-gray-400">Define what your agent should and shouldn't discuss</p>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-2 block">Topics to AVOID (one per line)</label>
                                    <textarea id="guard-avoid-topics" rows="3" class="input-field w-full rounded-lg px-4 py-3 text-sm" placeholder="Competitor pricing&#10;Legal advice&#10;Medical diagnoses"></textarea>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-2 block">Stay focused on (optional)</label>
                                    <textarea id="guard-focus-topics" rows="2" class="input-field w-full rounded-lg px-4 py-3 text-sm" placeholder="Only discuss topics related to your business"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Response Limits -->
                        <div class="card rounded-xl p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-2xl">ðŸ“</span>
                                <div>
                                    <h4 class="font-semibold">Response Limits</h4>
                                    <p class="text-sm text-gray-400">Control how your agent responds</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-2 block">Max response length</label>
                                    <select id="guard-max-length" class="input-field w-full rounded-lg px-4 py-3">
                                        <option value="short">Short (1-2 paragraphs)</option>
                                        <option value="medium" selected>Medium (3-4 paragraphs)</option>
                                        <option value="long">Long (detailed explanations)</option>
                                        <option value="unlimited">Unlimited</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-2 block">Language</label>
                                    <select id="guard-language" class="input-field w-full rounded-lg px-4 py-3">
                                        <option value="user">Match user's language</option>
                                        <option value="en">English only</option>
                                        <option value="ar">Arabic only</option>
                                        <option value="multi">Multilingual</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Escalation Rules -->
                        <div class="card rounded-xl p-6">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-2xl">ðŸš¨</span>
                                <div>
                                    <h4 class="font-semibold">Escalation Rules</h4>
                                    <p class="text-sm text-gray-400">When to hand off to a human</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-escalate-angry" class="w-4 h-4 rounded" checked>
                                    <span class="text-sm">Escalate frustrated or angry users</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-escalate-complex" class="w-4 h-4 rounded" checked>
                                    <span class="text-sm">Escalate complex issues agent can't handle</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-escalate-request" class="w-4 h-4 rounded" checked>
                                    <span class="text-sm">Escalate when user asks for human</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-escalate-sensitive" class="w-4 h-4 rounded">
                                    <span class="text-sm">Escalate sensitive topics (legal, financial)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- PII Protection -->
                        <div class="card rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">ðŸ”</span>
                                    <div>
                                        <h4 class="font-semibold">PII Protection</h4>
                                        <p class="text-sm text-gray-400">Protect personal information</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="guard-pii-protection" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-red-400 peer-focus:ring-2 peer-focus:ring-green-400 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                            <div class="space-y-3 pl-10">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-mask-pii" class="w-4 h-4 rounded" checked>
                                    <span class="text-sm">Mask sensitive data in logs (SSN, credit cards)</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="guard-no-store-pii" class="w-4 h-4 rounded" checked>
                                    <span class="text-sm">Don't store personal data in conversation history</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation handled by sticky header -->
                </div>

                <!-- Step 6: Preview -->
                <div id="wizard-step-6" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center gap-2 mb-6">
                        <span class="text-2xl">ðŸ‘ï¸</span>
                        <div>
                            <h3 class="text-xl font-bold">Review Your Agent</h3>
                            <p class="text-sm text-gray-400">Make sure everything looks good before testing</p>
                        </div>
                    </div>
                    
                    <div id="w-preview" class="space-y-4">
                        <!-- Preview content will be populated by JS -->
                    </div>
                    
                    <!-- Navigation handled by sticky header -->
                </div>

                <!-- Step 7: Test -->
                <div id="wizard-step-7" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">ðŸ§ª</span>
                            <div>
                                <h3 class="text-xl font-bold">Test Your Agent</h3>
                                <p class="text-sm text-gray-400">Try a conversation to see how your agent responds</p>
                            </div>
                        </div>
                        <button onclick="resetTestConversation()" class="btn-secondary px-4 py-2 rounded-lg text-sm flex items-center gap-2" title="Clear conversation and start fresh">
                            ðŸ”„ Reset Chat
                        </button>
                    </div>
                    
                    <div class="card rounded-xl p-4 md:p-6 mb-4">
                        <div id="test-messages" class="h-64 md:h-80 overflow-y-auto rounded-lg p-4 mb-4 space-y-3" style="background:var(--bg-primary);"></div>
                        <div id="test-attachments" class="hidden flex flex-wrap gap-2 mb-2"></div>
                        <div class="flex gap-2 items-end">
                            <button onclick="document.getElementById('test-file-input').click()" class="btn-secondary p-2 rounded-lg flex-shrink-0" title="Attach file">
                                ðŸ“Ž
                            </button>
                            <input type="file" id="test-file-input" class="hidden" accept=".pdf,.doc,.docx,.txt,.csv,.xlsx,.xls,.pptx,.ppt,.md,.png,.jpg,.jpeg,.gif,.webp,.bmp,.svg" onchange="handleTestFile(event)" multiple>
                            <input type="text" id="test-input" class="input-field flex-1 rounded-lg px-4 py-3" placeholder="Ask your agent something..." onkeypress="if(event.key==='Enter')sendTest()">
                            <button onclick="sendTest()" class="btn-primary px-6 py-3 rounded-lg">Send</button>
                        </div>
                    </div>
                    
                    <div class="card rounded-xl p-4 mb-4">
                        <h4 class="text-sm font-medium mb-3">ðŸ’¡ Try asking:</h4>
                        <div id="test-suggestions" class="flex flex-wrap gap-2">
                            <!-- Suggestions will be populated based on agent goal -->
                        </div>
                    </div>
                    
                    <!-- Deploy buttons are in sticky header - removed duplicate section -->
                </div>

                <!-- Step 8: Deploy (kept for direct navigation) -->
                <div id="wizard-step-8" class="hidden max-w-4xl mx-auto">
                    <div class="flex items-center gap-2 mb-6">
                        <span class="text-2xl">ðŸš€</span>
                        <div>
                            <h3 class="text-xl font-bold">Deploy Your Agent</h3>
                            <p class="text-sm text-gray-400">Choose how to save and deploy your agent</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Save as Draft -->
                        <div class="card rounded-xl p-6 border-2 border-transparent hover:border-gray-600 cursor-pointer transition" onclick="selectDeployOption('draft')">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 rounded-xl bg-gray-700 flex items-center justify-center text-2xl">ðŸ’¾</div>
                                <div>
                                    <h4 class="font-semibold">Save as Draft</h4>
                                    <p class="text-sm text-gray-400">Continue editing later</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500">Your agent will be saved but not active. You can come back and finish the configuration anytime.</p>
                        </div>
                        
                        <!-- Deploy Now -->
                        <div class="card rounded-xl p-6 border-2 border-purple-500 bg-purple-500/10 cursor-pointer" onclick="selectDeployOption('deploy')">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-2xl">ðŸš€</div>
                                <div>
                                    <h4 class="font-semibold">Deploy Now</h4>
                                    <p class="text-sm text-gray-400">Make your agent live</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500">Your agent will be published and ready to use immediately.</p>
                        </div>
                    </div>
                    
                    <!-- Deployment Options (shown when Deploy is selected) -->
                    <div id="deploy-options" class="hidden space-y-6">
                        <h4 class="font-semibold flex items-center gap-2">
                            <span>â˜ï¸</span> Deployment Target
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Cloud Deployment -->
                            <div class="card rounded-xl p-4 border-2 border-transparent hover:border-purple-500 cursor-pointer transition deploy-target" data-target="cloud" onclick="selectDeployTarget('cloud')">
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="text-2xl">â˜ï¸</span>
                                    <div>
                                        <h5 class="font-medium">Cloud Hosted</h5>
                                        <p class="text-xs text-gray-400">We manage everything for you</p>
                                    </div>
                                </div>
                                <ul class="text-xs text-gray-500 space-y-1">
                                    <li>âœ“ No infrastructure to manage</li>
                                    <li>âœ“ Auto-scaling</li>
                                    <li>âœ“ 99.9% uptime SLA</li>
                                </ul>
                            </div>
                            
                            <!-- On-Premises -->
                            <div class="card rounded-xl p-4 border-2 border-transparent hover:border-purple-500 cursor-pointer transition deploy-target" data-target="onprem" onclick="selectDeployTarget('onprem')">
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="text-2xl">ðŸ¢</span>
                                    <div>
                                        <h5 class="font-medium">On-Premises</h5>
                                        <p class="text-xs text-gray-400">Deploy in your own infrastructure</p>
                                    </div>
                                </div>
                                <ul class="text-xs text-gray-500 space-y-1">
                                    <li>âœ“ Full data control</li>
                                    <li>âœ“ Custom security policies</li>
                                    <li>âœ“ Air-gapped environments</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Cloud Provider Selection -->
                        <div id="cloud-providers" class="hidden">
                            <h5 class="text-sm font-medium text-gray-400 mb-3">Select Cloud Provider</h5>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div class="card rounded-lg p-3 text-center cursor-pointer border-2 border-transparent hover:border-purple-500 transition cloud-provider" data-provider="aws" onclick="selectCloudProvider('aws')">
                                    <span class="text-2xl block mb-1">ðŸŸ </span>
                                    <span class="text-sm">AWS</span>
                                </div>
                                <div class="card rounded-lg p-3 text-center cursor-pointer border-2 border-transparent hover:border-purple-500 transition cloud-provider" data-provider="azure" onclick="selectCloudProvider('azure')">
                                    <span class="text-2xl block mb-1">ðŸ”µ</span>
                                    <span class="text-sm">Azure</span>
                                </div>
                                <div class="card rounded-lg p-3 text-center cursor-pointer border-2 border-transparent hover:border-purple-500 transition cloud-provider" data-provider="gcp" onclick="selectCloudProvider('gcp')">
                                    <span class="text-2xl block mb-1">ðŸ”´</span>
                                    <span class="text-sm">Google Cloud</span>
                                </div>
                                <div class="card rounded-lg p-3 text-center cursor-pointer border-2 border-transparent hover:border-purple-500 transition cloud-provider" data-provider="oci" onclick="selectCloudProvider('oci')">
                                    <span class="text-2xl block mb-1">ðŸ”¶</span>
                                    <span class="text-sm">Oracle OCI</span>
                                </div>
                            </div>
                            
                            <!-- AWS Config -->
                            <div id="cloud-config-aws" class="hidden mt-4 card rounded-xl p-4 space-y-4">
                                <h5 class="font-medium flex items-center gap-2">ðŸŸ  AWS Configuration</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>us-east-1 (N. Virginia)</option>
                                            <option>us-west-2 (Oregon)</option>
                                            <option>eu-west-1 (Ireland)</option>
                                            <option>ap-southeast-1 (Singapore)</option>
                                        </select>
                            
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Instance Type</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>t3.medium (2 vCPU, 4 GB)</option>
                                            <option>t3.large (2 vCPU, 8 GB)</option>
                                            <option>m5.large (2 vCPU, 8 GB)</option>
                                        </select>
                            
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Access Key ID</label>
                                        <input type="password" class="input-field w-full rounded-lg px-4 py-2" placeholder="AKIA...">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Secret Access Key</label>
                                        <input type="password" class="input-field w-full rounded-lg px-4 py-2">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Azure Config -->
                            <div id="cloud-config-azure" class="hidden mt-4 card rounded-xl p-4 space-y-4">
                                <h5 class="font-medium flex items-center gap-2">ðŸ”µ Azure Configuration</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>East US</option>
                                            <option>West Europe</option>
                                            <option>Southeast Asia</option>
                                        </select>
                            
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Resource Group</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="my-resource-group">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Subscription ID</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Tenant ID</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- GCP Config -->
                            <div id="cloud-config-gcp" class="hidden mt-4 card rounded-xl p-4 space-y-4">
                                <h5 class="font-medium flex items-center gap-2">ðŸ”´ Google Cloud Configuration</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Project ID</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="my-project-id">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>us-central1</option>
                                            <option>europe-west1</option>
                                            <option>asia-east1</option>
                                        </select>
                            
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="text-sm text-gray-400 mb-1 block">Service Account JSON</label>
                                        <textarea rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste service account JSON"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- OCI Config -->
                            <div id="cloud-config-oci" class="hidden mt-4 card rounded-xl p-4 space-y-4">
                                <h5 class="font-medium flex items-center gap-2">ðŸ”¶ Oracle OCI Configuration</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>us-ashburn-1 (US East)</option>
                                            <option>us-phoenix-1 (US West)</option>
                                            <option>eu-frankfurt-1 (Germany)</option>
                                            <option>uk-london-1 (UK)</option>
                                            <option>ap-tokyo-1 (Japan)</option>
                                            <option>me-jeddah-1 (Saudi Arabia)</option>
                                            <option>me-dubai-1 (UAE)</option>
                                        </select>
                            
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Compartment OCID</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="ocid1.compartment.oc1..">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Tenancy OCID</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="ocid1.tenancy.oc1..">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">User OCID</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="ocid1.user.oc1..">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">API Key Fingerprint</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="xx:xx:xx:...">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Shape</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>VM.Standard.E4.Flex</option>
                                            <option>VM.Standard3.Flex</option>
                                            <option>VM.Standard.A1.Flex (ARM)</option>
                                        </select>
                            
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="text-sm text-gray-400 mb-1 block">Private Key (PEM)</label>
                                        <textarea rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="-----BEGIN RSA PRIVATE KEY-----"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- On-Premises Config -->
                        <div id="onprem-config" class="hidden">
                            <h5 class="text-sm font-medium text-gray-400 mb-3">On-Premises Configuration</h5>
                            <div class="card rounded-xl p-4 space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Deployment Method</label>
                                        <select id="onprem-method" class="input-field w-full rounded-lg px-4 py-2" onchange="onOnpremMethodChange()">
                                            <option value="docker">Docker Container</option>
                                            <option value="kubernetes">Kubernetes</option>
                                            <option value="vm">Virtual Machine</option>
                                            <option value="bare">Bare Metal</option>
                                        </select>
                            
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Environment</label>
                                        <select class="input-field w-full rounded-lg px-4 py-2">
                                            <option>Production</option>
                                            <option>Staging</option>
                                            <option>Development</option>
                                        </select>
                            
                                    </div>
                                </div>
                                
                                <!-- Docker Config -->
                                <div id="onprem-docker" class="space-y-4">
                                    <div class="bg-gray-800/50 rounded-lg p-4">
                                        <h6 class="text-sm font-medium mb-2">Docker Run Command</h6>
                                        <pre class="text-xs bg-black/50 p-3 rounded overflow-x-auto"><code>docker run -d \
  --name agentforge-agent \
  -p 8080:8080 \
  -e OPENAI_API_KEY=your-key \
  -e AGENT_CONFIG=/config/agent.json \
  -v ./config:/config \
  agentforge/agent:latest</code></pre>
                                        <button onclick="copyDockerCommand()" class="mt-2 text-xs text-purple-400 hover:text-purple-300">ðŸ“‹ Copy command</button>
                                    </div>
                                </div>
                                
                                <!-- Kubernetes Config -->
                                <div id="onprem-kubernetes" class="hidden space-y-4">
                                    <div class="bg-gray-800/50 rounded-lg p-4">
                                        <h6 class="text-sm font-medium mb-2">Kubernetes Manifest</h6>
                                        <pre class="text-xs bg-black/50 p-3 rounded overflow-x-auto max-h-48"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: agentforge-agent
spec:
  replicas: 2
  selector:
    matchLabels:
      app: agentforge-agent
  template:
    metadata:
      labels:
        app: agentforge-agent
    spec:
      containers:
      - name: agent
        image: agentforge/agent:latest
        ports:
        - containerPort: 8080
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: agent-secrets
              key: openai-key</code></pre>
                                        <button onclick="downloadK8sManifest()" class="mt-2 text-xs text-purple-400 hover:text-purple-300">â¬‡ï¸ Download YAML</button>
                                    </div>
                                </div>
                                
                                <!-- Server Config -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Server Host</label>
                                        <input type="text" class="input-field w-full rounded-lg px-4 py-2" placeholder="192.168.1.100 or hostname">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Port</label>
                                        <input type="number" class="input-field w-full rounded-lg px-4 py-2" value="8080">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">SSL Certificate</label>
                                        <input type="file" class="input-field w-full rounded-lg px-4 py-2" accept=".pem,.crt">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">SSL Key</label>
                                        <input type="file" class="input-field w-full rounded-lg px-4 py-2" accept=".pem,.key">
                                    </div>
                                </div>
                                
                                <!-- Resource Requirements -->
                                <div class="border-t border-gray-700 pt-4">
                                    <h6 class="text-sm font-medium mb-3">Minimum Requirements</h6>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                        <div class="text-center p-3 bg-gray-800/50 rounded-lg">
                                            <div class="text-lg font-bold text-purple-400">2</div>
                                            <div class="text-xs text-gray-500">CPU Cores</div>
                                        </div>
                                        <div class="text-center p-3 bg-gray-800/50 rounded-lg">
                                            <div class="text-lg font-bold text-purple-400">4 GB</div>
                                            <div class="text-xs text-gray-500">RAM</div>
                                        </div>
                                        <div class="text-center p-3 bg-gray-800/50 rounded-lg">
                                            <div class="text-lg font-bold text-purple-400">20 GB</div>
                                            <div class="text-xs text-gray-500">Storage</div>
                                        </div>
                                        <div class="text-center p-3 bg-gray-800/50 rounded-lg">
                                            <div class="text-lg font-bold text-purple-400">HTTPS</div>
                                            <div class="text-xs text-gray-500">Network</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navigation handled by sticky header -->
                </div>
                
                </div><!-- End wizard-content-area -->
            </section>

            <!-- Demo Lab Page - NEW DESIGN -->
            <section id="page-demo" class="hidden flex flex-col" style="height:100%;max-height:100%;min-height:0;overflow:hidden;">
                <!-- Header -->
                <div class="p-4 border-b border-gray-800 flex items-center justify-between bg-gradient-to-r from-purple-900/30 to-blue-900/30" style="flex-shrink:0;">
                    <div>
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center">ðŸ§ª</span>
                            Demo Lab
                        </h2>
                        <p class="text-sm text-gray-400 mt-1">Create demo environments with APIs, Knowledge Bases & Test Assets</p>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="flex flex-1 overflow-hidden">
                    <!-- Left Sidebar - Demo Kits List -->
                    <div class="w-72 border-r flex flex-col demo-sidebar" style="background:var(--bg-secondary);border-color:var(--border-color);">
                        <div class="p-3 border-b" style="border-color:var(--border-color);">
                            <button onclick="showCreateKitModal()" class="w-full btn-primary py-2.5 rounded-lg text-sm flex items-center justify-center gap-2">
                                <span>âœ¨</span> Create Demo Kit
                            </button>
                        </div>
                        
                        <!-- Kits List -->
                        <div id="demo-kits-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                            <div class="text-center py-8" style="color:var(--text-muted);">
                                <span class="text-3xl block mb-2">ðŸ“¦</span>
                                <p class="text-sm">No demo kits yet</p>
                                <p class="text-xs mt-1">Create one to get started!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Content Area -->
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <!-- Welcome / Kit Details -->
                        <div id="demo-content-area" class="flex-1 overflow-y-auto p-6">
                            <!-- Welcome Screen -->
                            <div id="demo-welcome" class="text-center py-12">
                                <div class="w-24 h-24 mx-auto rounded-2xl bg-gradient-to-br from-purple-500/20 to-blue-500/20 flex items-center justify-center mb-6">
                                    <span class="text-5xl">ðŸ§ª</span>
                                </div>
                                <h3 class="text-2xl font-bold mb-3">Welcome to Demo Lab</h3>
                                <p class="mb-8 max-w-lg mx-auto" style="color:var(--text-secondary);">
                                    Describe your agent's needs in plain language and we'll generate everything you need: 
                                    Mock APIs, Knowledge Bases, and sample documents for testing.
                                </p>
                                
                                <div class="max-w-2xl mx-auto">
                                    <div class="card rounded-xl p-6 text-left">
                                        <p class="text-sm font-medium mb-4" style="color:var(--accent-primary);">ðŸ’¡ Example Request:</p>
                                        <div class="rounded-lg p-4 text-sm italic" style="background:var(--bg-input);color:var(--text-secondary);">
                                            "I need tools for an HR agent that can check employee vacation balance, 
                                            submit vacation requests, process expense claims with receipt uploads, 
                                            and answer questions about HR policies including benefits and leave policies. 
                                            Also need sample invoices and receipts for testing."
                                        </div>
                                        <button onclick="useDemoKitExample()" class="mt-4 text-sm hover:underline" style="color:var(--accent-primary);">
                                            â†’ Use this example
                                        </button>
                                    </div>
                                    
                                    <div class="grid grid-cols-3 gap-4 mt-6">
                                        <div class="card rounded-lg p-4 text-center">
                                            <span class="text-2xl">ðŸ”Œ</span>
                                            <p class="text-sm font-medium mt-2">Mock APIs</p>
                                            <p class="text-xs" style="color:var(--text-muted);">Testable endpoints</p>
                                        </div>
                                        <div class="card rounded-lg p-4 text-center">
                                            <span class="text-2xl">ðŸ§ </span>
                                            <p class="text-sm font-medium mt-2">Knowledge Bases</p>
                                            <p class="text-xs" style="color:var(--text-muted);">Searchable docs</p>
                                        </div>
                                        <div class="card rounded-lg p-4 text-center">
                                            <span class="text-2xl">ðŸ“Ž</span>
                                            <p class="text-sm font-medium mt-2">Demo Assets</p>
                                            <p class="text-xs" style="color:var(--text-muted);">Test files</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Kit Details (hidden by default) -->
                            <div id="demo-kit-details" class="hidden">
                                <!-- Kit Header -->
                                <div class="flex items-start justify-between mb-6">
                                    <div>
                                        <h3 id="kit-detail-name" class="text-2xl font-bold">Kit Name</h3>
                                        <p id="kit-detail-desc" class="mt-1" style="color:var(--text-secondary);">Description</p>
                                    </div>
                                    <button onclick="deleteCurrentKit()" class="px-3 py-1.5 rounded-lg text-sm bg-red-500/20 text-red-400 hover:bg-red-500/30">
                                        ðŸ—‘ï¸ Delete Kit
                                    </button>
                                </div>
                                
                                <!-- APIs Section -->
                                <div class="mb-8">
                                    <div class="flex items-center gap-2 mb-4">
                                        <span class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center">ðŸ”Œ</span>
                                        <h4 class="text-lg font-semibold">APIs</h4>
                                        <span id="kit-api-count" class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded-full">0</span>
                                        <span class="text-xs text-gray-500 ml-2">â€¢ Available as tools in AgentForge Studio</span>
                                    </div>
                                    <div id="kit-apis-list" class="space-y-3">
                                        <!-- APIs will be rendered here -->
                                    </div>
                                </div>
                                
                                <!-- Knowledge Bases Section -->
                                <div class="mb-8">
                                    <div class="flex items-center gap-2 mb-4">
                                        <span class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center">ðŸ§ </span>
                                        <h4 class="text-lg font-semibold">Knowledge Bases</h4>
                                        <span id="kit-kb-count" class="text-xs bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded-full">0</span>
                                        <span class="text-xs text-gray-500 ml-2">â€¢ Available as tools in AgentForge Studio</span>
                                    </div>
                                    <div id="kit-kb-list" class="space-y-3">
                                        <!-- Knowledge Bases will be rendered here -->
                                    </div>
                                </div>
                                
                                <!-- Demo Assets Section -->
                                <div class="mb-8">
                                    <div class="flex items-center gap-2 mb-4">
                                        <span class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center">ðŸ“Ž</span>
                                        <h4 class="text-lg font-semibold">Demo Assets</h4>
                                        <span id="kit-asset-count" class="text-xs bg-green-500/20 text-green-300 px-2 py-0.5 rounded-full">0</span>
                                        <span class="text-xs text-gray-500 ml-2">â€¢ For testing only (not linked to agent)</span>
                                    </div>
                                    <div id="kit-assets-list" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        <!-- Assets will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Create Kit Modal -->
                <div id="create-kit-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
                    <div class="modal-content-box rounded-2xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="font-bold text-lg">âœ¨ Create Demo Kit</h3>
                            <button onclick="closeCreateKitModal()" class="p-2 hover:bg-gray-700 rounded-lg">âœ•</button>
                        </div>
                        <div class="p-6">
                            <label class="block text-sm font-medium mb-2">Kit Name (optional)</label>
                            <input type="text" id="new-kit-name" class="w-full input-field rounded-lg px-4 py-2 mb-4" placeholder="e.g., HR Assistant Tools">
                            
                            <label class="block text-sm font-medium mb-2">Describe what you need</label>
                            <textarea id="new-kit-description" class="w-full input-field rounded-lg px-4 py-3 h-40 resize-none" placeholder="Describe the APIs, knowledge bases, and test documents you need for your agent...

Example: I need an HR agent that can:
- Check employee vacation balance from HR system
- Submit vacation requests
- Process expense claims with receipts
- Answer questions about HR policies (benefits, leave, etc.)
- Need sample invoices and receipts for testing"></textarea>
                            
                            <div id="kit-generation-status" class="hidden mt-4 p-4 bg-purple-500/10 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <div class="animate-spin w-5 h-5 border-2 border-purple-500 border-t-transparent rounded-full"></div>
                                    <span class="text-sm text-purple-300">Generating your demo kit...</span>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
                            <button onclick="closeCreateKitModal()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Cancel</button>
                            <button onclick="generateDemoKit()" id="generate-kit-btn" class="px-6 py-2 rounded-lg bg-purple-600 hover:bg-purple-500 flex items-center gap-2">
                                <span>âœ¨</span> Generate Kit
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- API Test Modal (business-friendly, no technical terms) -->
                <div id="api-test-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl w-full max-w-5xl border border-purple-500/30 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div class="p-6 border-b border-purple-500/20 flex items-center justify-between bg-gradient-to-r from-purple-900/30 via-purple-800/10 to-transparent shrink-0">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-2xl shadow-lg shadow-purple-500/30">
                                    ðŸ”
                                </div>
                                <div>
                                    <h3 class="font-bold text-xl text-white" id="api-test-title">Try It Out</h3>
                                    <p class="text-sm text-purple-200 mt-0.5">Enter information to see results</p>
                                </div>
                            </div>
                            <button onclick="closeApiTestModal()" class="p-2 hover:bg-white/10 rounded-xl transition text-gray-200 hover:text-white" aria-label="Close">âœ•</button>
                        </div>
                        <div class="p-6 overflow-y-auto flex-1 min-h-0">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div id="api-test-params-wrapper" class="space-y-4">
                                        <div id="api-test-params" class="space-y-4">
                                            <!-- Parameters rendered here -->
                                        </div>
                                    </div>
                                    <textarea id="api-test-body" class="hidden w-full input-field rounded-lg px-3 py-2 text-sm font-mono h-28" placeholder="{}"></textarea>
                                    <button type="button" id="api-test-send-btn" onclick="sendApiTestRequest()" class="w-full px-6 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-500 hover:to-purple-400 text-white font-semibold flex items-center justify-center gap-2 transition shadow-lg shadow-purple-500/20">
                                        <span>âœ“</span>
                                        <span>Get Results</span>
                                    </button>
                                </div>
                                <div class="bg-gradient-to-br from-gray-950 to-gray-900 rounded-xl p-5 border-2 border-gray-700/30 shadow-inner min-h-[300px] flex flex-col">
                                    <div class="flex items-center gap-2 text-sm font-semibold text-purple-300 mb-4">
                                        <span>ðŸ“Š</span>
                                        <span>Results</span>
                                    </div>
                                    <div id="api-test-response" class="text-sm overflow-auto flex-1">
                                        <div class="text-center py-12 text-gray-400">
                                            <div class="text-4xl mb-3">ðŸ’¡</div>
                                            <p>Results will appear here</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-purple-500/20 flex justify-between items-center shrink-0 bg-gray-900/50">
                            <div class="text-xs text-gray-500">
                                <span id="api-test-method" class="hidden"></span>
                                <code id="api-test-endpoint" class="hidden"></code>
                            </div>
                            <button type="button" onclick="closeApiTestModal()" class="px-5 py-2 rounded-lg bg-purple-600 hover:bg-purple-500 text-white transition text-sm font-medium">Close</button>
                        </div>
                    </div>
                </div>
                
                <!-- Knowledge Base View Modal -->
                <div id="kb-view-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
                    <div class="modal-content-box rounded-2xl w-full max-w-4xl mx-4 max-h-[85vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="font-bold text-lg" id="kb-view-title">Knowledge Base</h3>
                            <button onclick="closeKbViewModal()" class="p-2 hover:bg-gray-700 rounded-lg">âœ•</button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <div id="kb-view-content" class="prose prose-invert max-w-none">
                                <!-- Content will be rendered here -->
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-end">
                            <button onclick="closeKbViewModal()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Close</button>
                        </div>
                    </div>
                </div>
                
                <!-- Access Control is now integrated in the Agent Wizard (Step 4: Guardrails & Safety) -->

                <!-- Edit Asset Modal (Assets don't have a Tools page) -->
                <div id="edit-asset-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
                    <div class="modal-content-box rounded-2xl w-full max-w-xl mx-4 max-h-[85vh] overflow-hidden">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="font-bold text-lg">âœï¸ Edit Asset</h3>
                            <button onclick="closeEditAssetModal()" class="p-2 hover:bg-gray-700 rounded-lg">âœ•</button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[60vh] space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Name</label>
                                <input type="text" id="edit-asset-name" class="w-full input-field rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Description</label>
                                <textarea id="edit-asset-description" class="w-full input-field rounded-lg px-4 py-2 h-16"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Type</label>
                                <select id="edit-asset-type" class="w-full input-field rounded-lg px-4 py-2">
                                    <option value="invoice">Invoice</option>
                                    <option value="receipt">Receipt</option>
                                    <option value="document">Document</option>
                                    <option value="image">Image</option>
                                </select>
                            
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
                            <button onclick="closeEditAssetModal()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Cancel</button>
                            <button onclick="saveEditAsset()" class="px-6 py-2 rounded-lg bg-purple-600 hover:bg-purple-500">Save</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Chat Page -->
            <section id="page-chat" class="hidden chat-page">
                <!-- Sidebar -->
                <div id="chat-sidebar" class="chat-sidebar hidden md:flex">
                    <!-- Agent Selector -->
                    <div class="agent-selector">
                        <select id="chat-agent" onchange="onAgentChange()">
                            <option value="">Select Agent...</option>
                        </select>
                    </div>
                    
                    <!-- Conversations Header -->
                    <div class="conv-header">
                        <span class="conv-header-title">History</span>
                        <div class="conv-header-actions">
                            <button onclick="startNewChatConversation()" class="conv-btn-new">+ New</button>
                            <button id="chat-edit-btn" onclick="toggleChatSelectionMode()" class="conv-btn-edit">Edit</button>
                        </div>
                    </div>
                    
                    <!-- Selection Actions Bar -->
                    <div id="chat-selection-bar" class="conv-selection-bar hidden">
                        <button onclick="toggleChatSelectAll()" class="conv-select-all">
                            <span id="chat-select-all-text">Select All</span>
                        </button>
                        <button id="chat-delete-selected-btn" onclick="deleteChatSelectedConvs()" disabled class="conv-delete-btn">
                            Delete (0)
                        </button>
                    </div>
                    
                    <!-- Conversations List -->
                    <div id="chat-conv-list" class="conv-list">
                        <div class="conv-empty">
                            <div class="conv-empty-icon">ðŸ’¬</div>
                            <p class="conv-empty-text">Select an agent to start</p>
                        </div>
                    </div>
                </div>
                
                <!-- Main Chat Area -->
                <div class="chat-main">
                    <!-- Desktop Header -->
                    <div id="chat-desktop-header" class="chat-header">
                        <div class="chat-header-avatar">ðŸ¤–</div>
                        <div class="chat-header-info">
                            <h3 id="chat-agent-name">Select an Agent</h3>
                            <p id="chat-agent-status">Choose an agent to start chatting</p>
                        </div>
                        <span class="chat-header-status" style="display:none" id="chat-online-dot"></span>
                    </div>
                    
                    <!-- Mobile Header -->
                    <div class="chat-mobile-header">
                        <select id="chat-agent-mobile" onchange="document.getElementById('chat-agent').value=this.value;onAgentChange()">
                            <option value="">Select Agent...</option>
                        </select>
                        <button onclick="toggleChatSidebar()" class="chat-mobile-toggle">â˜°</button>
                    </div>
                    
                    <!-- Messages Container -->
                    <div id="chat-messages" class="chat-messages-container">
                        <div class="chat-welcome">
                            <div class="chat-welcome-icon">ðŸ’¬</div>
                            <h2>Welcome to Chat</h2>
                            <p>Select an agent to start a conversation</p>
                        </div>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="chat-input-area">
                        <div id="chat-attachments" class="chat-attachments-preview hidden"></div>
                        <div class="chat-input-wrapper">
                            <button onclick="document.getElementById('chat-file-input').click()" class="chat-attach-btn" title="Attach file">ðŸ“Ž</button>
                            <input type="file" id="chat-file-input" class="hidden" accept=".pdf,.doc,.docx,.txt,.csv,.xlsx,.xls,.pptx,.ppt,.md,.png,.jpg,.jpeg,.gif,.webp,.bmp,.svg" onchange="handleChatFile(event)" multiple>
                            <input type="text" id="chat-input" class="chat-input-field" placeholder="Type your message..." onkeypress="if(event.key==='Enter')sendMsg()">
                            <button onclick="sendMsg()" class="chat-send-btn">Send</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <button onclick="navigate('chat')" id="mob-chat" data-permission="chat:use" class=""><span>ðŸ’¬</span><span>Chat</span></button>
        <button onclick="navigate('agents')" id="mob-agents" data-permission="agents:view" class="active"><span>ðŸ”—</span><span>Hub</span></button>
        <button onclick="navigate('create')" id="mob-create" data-permission="agents:create" class=""><span>ðŸ”¨</span><span>Studio</span></button>
        <button onclick="navigate('tools')" id="mob-tools" data-permission="tools:view" class=""><span>ðŸ§©</span><span>Tools</span></button>
        <button onclick="navigate('settings')" id="mob-settings" data-permission="system:settings" class=""><span>âš™ï¸</span><span>Settings</span></button>
    </nav>

    <!-- Task Modal - Clean popup for adding/editing tasks -->
    <div id="modal-task" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl w-full max-w-2xl max-h-[85vh] flex flex-col shadow-2xl border border-gray-700">
            <!-- Header -->
            <div class="p-5 flex items-center justify-between border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">ðŸ“‹</span>
                    <div>
                        <h3 class="text-lg font-bold text-white" id="task-modal-title">Add New Task</h3>
                        <p class="text-xs text-gray-400">Define what this agent can do</p>
                    </div>
                </div>
                <button onclick="closeTaskModal()" class="text-gray-400 hover:text-white text-2xl p-2 hover:bg-gray-700 rounded-lg transition">Ã—</button>
            </div>

            <!-- Content -->
            <div class="p-5 overflow-y-auto flex-1 space-y-5">
                <!-- Task Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Task Name <span class="text-red-400">*</span></label>
                    <input type="text" id="task-modal-name" 
                           class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition"
                           placeholder="e.g., Answer HR Questions, Process Leave Requests">
                </div>

                <!-- Task Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Description <span class="text-gray-500">(optional)</span></label>
                    <textarea id="task-modal-desc" rows="2"
                              class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition resize-none"
                              placeholder="Brief description of what this task does..."></textarea>
                </div>

                <!-- Instructions -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-300">Instructions</label>
                            <p class="text-xs text-gray-500">Step-by-step guide for the AI to follow</p>
                        </div>
                        <button onclick="addTaskModalInstruction()" 
                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition flex items-center gap-1">
                            <span>+</span> Add Step
                        </button>
                    </div>
                    <div id="task-modal-instructions" class="space-y-2">
                        <!-- Instructions will be added here -->
                    </div>
                    <p id="task-modal-no-instructions" class="text-sm text-gray-500 italic text-center py-4">
                        No instructions yet. Click "+ Add Step" to add instructions.
                    </p>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-5 border-t border-gray-700 flex justify-end gap-3">
                <button onclick="closeTaskModal()" 
                        class="px-5 py-2.5 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg font-medium transition">
                    Cancel
                </button>
                <button onclick="saveTaskModal()" 
                        class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">
                    Save Task
                </button>
            </div>
        </div>
    </div>

    <!-- Tool Creation Modal -->
<!-- Tool Wizard Modal -->
<div id="modal-tool" class="hidden fixed inset-0 modal-backdrop flex items-end md:items-center justify-center z-50">
    <div class="card rounded-t-xl md:rounded-xl w-full md:max-w-4xl md:mx-4 max-h-[90vh] flex flex-col">
        <!-- Header -->
        <div class="p-4 md:p-6 flex items-center justify-between shrink-0" style="border-bottom:1px solid var(--border-color)">
            <div class="flex items-center gap-3">
                <span id="wizard-icon" class="text-2xl">ðŸ”§</span>
                <div>
                    <h3 class="text-lg md:text-xl font-bold" id="wizard-title">Create Tool</h3>
                    <p class="text-xs text-gray-400" id="wizard-subtitle">Select a tool type</p>
                </div>
            </div>
            <button onclick="closeWizard()" class="text-gray-400 hover:text-white text-2xl p-2">Ã—</button>
        </div>

        <!-- Steps Indicator -->
        <div id="wizard-steps-bar" class="hidden px-4 md:px-6 py-3 border-b shrink-0" style="background:var(--bg-secondary);border-color:var(--border-color);">
            <div class="flex items-center justify-center gap-2 md:gap-4">
                <div class="wizard-step flex items-center gap-2 cursor-pointer hover:opacity-80 transition" data-step="1" onclick="goToStep(1)">
                    <div class="step-num w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-purple-600">1</div>
                    <span class="step-label text-sm hidden md:inline">Basics</span>
                </div>
                <div class="w-6 md:w-10 h-0.5 bg-gray-700 step-connector"></div>
                <div class="wizard-step flex items-center gap-2 opacity-50 cursor-pointer hover:opacity-80 transition" data-step="2" onclick="goToStep(2)">
                    <div class="step-num w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-gray-700">2</div>
                    <span class="step-label text-sm hidden md:inline">Tasks</span>
                </div>
                <div class="w-6 md:w-10 h-0.5 bg-gray-700 step-connector"></div>
                <div class="wizard-step flex items-center gap-2 opacity-50 cursor-pointer hover:opacity-80 transition" data-step="3" onclick="goToStep(3)">
                    <div class="step-num w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-gray-700">3</div>
                    <span class="step-label text-sm hidden md:inline">Tools</span>
                </div>
                <div class="w-6 md:w-10 h-0.5 bg-gray-700 step-connector"></div>
                <div class="wizard-step flex items-center gap-2 opacity-50 cursor-pointer hover:opacity-80 transition" data-step="4" onclick="goToStep(4)">
                    <div class="step-num w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-gray-700">4</div>
                    <span class="step-label text-sm hidden md:inline">Guardrails</span>
                </div>
                <div class="w-6 md:w-10 h-0.5 bg-gray-700 step-connector"></div>
                <div class="wizard-step flex items-center gap-2 opacity-50 cursor-pointer hover:opacity-80 transition" data-step="5" onclick="goToStep(5)">
                    <div class="step-num w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-gray-700">5</div>
                    <span class="step-label text-sm hidden md:inline">Preview</span>
                </div>
                <div class="w-6 md:w-10 h-0.5 bg-gray-700 step-connector"></div>
                <div class="wizard-step flex items-center gap-2 opacity-50 cursor-pointer hover:opacity-80 transition" data-step="6" onclick="goToStep(6)">
                    <div class="step-num w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-gray-700">6</div>
                    <span class="step-label text-sm hidden md:inline">Test</span>
                </div>
                <div class="w-6 md:w-10 h-0.5 bg-gray-700 step-connector"></div>
                <div class="wizard-step flex items-center gap-2 opacity-50 cursor-pointer hover:opacity-80 transition" data-step="7" onclick="goToStep(7)">
                    <div class="step-num w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold bg-gray-700">7</div>
                    <span class="step-label text-sm hidden md:inline">Deploy</span>
                </div>
            </div>
        </div>

        <!-- Content Area (Scrollable) -->
        <div class="p-4 md:p-6 overflow-y-auto flex-1">
            
            <!-- Step 0: Tool Type Selection -->
            <div id="wiz-step-0" class="space-y-4">
                <!-- Active Tools: Knowledge & Data -->
                <div>
                    <h4 class="text-xs uppercase text-gray-500 mb-2 font-semibold">ðŸ“š Knowledge & Data</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <button onclick="startWizard('knowledge')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1">ðŸ§ </span>
                            <span class="font-medium text-sm">Knowledge Base</span>
                            <p class="text-xs text-gray-500 mt-1">RAG with config</p>
                        </button>
                        <button onclick="startWizard('document')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1">ðŸ“„</span>
                            <span class="font-medium text-sm">Documents</span>
                            <p class="text-xs text-gray-500 mt-1">Upload files</p>
                        </button>
                        <button onclick="startWizard('website')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1">ðŸŒ</span>
                            <span class="font-medium text-sm">Website</span>
                            <p class="text-xs text-gray-500 mt-1">Scrape pages</p>
                        </button>
                        <button onclick="startWizard('database')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1">ðŸ—„ï¸</span>
                            <span class="font-medium text-sm">Database</span>
                            <p class="text-xs text-gray-500 mt-1">SQL, MongoDB</p>
                        </button>
                    </div>
                </div>
                
                <!-- Active Tools: Integrations -->
                <div>
                    <h4 class="text-xs uppercase text-gray-500 mb-2 font-semibold">ðŸ”Œ Integrations</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <button onclick="startWizard('api')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1">ðŸ”—</span>
                            <span class="font-medium text-sm">REST API</span>
                            <p class="text-xs text-gray-500 mt-1">HTTP endpoints</p>
                        </button>
                        <button onclick="startWizard('email')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1">ðŸ“§</span>
                            <span class="font-medium text-sm">Email</span>
                            <p class="text-xs text-gray-500 mt-1">SMTP, SendGrid</p>
                        </button>
                        <button onclick="startWizard('webhook')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1">ðŸª</span>
                            <span class="font-medium text-sm">Webhook</span>
                            <p class="text-xs text-gray-500 mt-1">HTTP callbacks</p>
                        </button>
                        <button onclick="startWizard('slack')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1">ðŸ’¬</span>
                            <span class="font-medium text-sm">Slack</span>
                            <p class="text-xs text-gray-500 mt-1">Messaging</p>
                        </button>
                        <button onclick="startWizard('websearch')" class="card p-3 rounded-lg text-center hover:border-purple-500 transition border-2 border-transparent">
                            <span class="text-xl block mb-1">ðŸ”</span>
                            <span class="font-medium text-sm">Web Search</span>
                            <p class="text-xs text-gray-500 mt-1">Tavily, Google</p>
                        </button>
                    </div>
                </div>
                
                <!-- Coming Soon -->
                <div>
                    <h4 class="text-xs uppercase text-gray-500 mb-2 font-semibold">ðŸš€ Coming Soon</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 opacity-60">
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1">ðŸ“Š</span>
                            <span class="font-medium text-sm">Spreadsheet</span>
                            <p class="text-xs text-gray-500 mt-1">Sheets, Airtable</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1">â˜ï¸</span>
                            <span class="font-medium text-sm">Cloud Storage</span>
                            <p class="text-xs text-gray-500 mt-1">S3, GCS, Azure</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1">ðŸ“…</span>
                            <span class="font-medium text-sm">Calendar</span>
                            <p class="text-xs text-gray-500 mt-1">Google, Outlook</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1">ðŸŽ¯</span>
                            <span class="font-medium text-sm">CRM</span>
                            <p class="text-xs text-gray-500 mt-1">Salesforce, HubSpot</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1">ðŸ¢</span>
                            <span class="font-medium text-sm">ERP</span>
                            <p class="text-xs text-gray-500 mt-1">SAP, Oracle</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1">ðŸŽ¨</span>
                            <span class="font-medium text-sm">Image Gen</span>
                            <p class="text-xs text-gray-500 mt-1">DALL-E, SD</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1">ðŸŽ¤</span>
                            <span class="font-medium text-sm">Speech to Text</span>
                            <p class="text-xs text-gray-500 mt-1">Whisper</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1">ðŸ”Š</span>
                            <span class="font-medium text-sm">Text to Speech</span>
                            <p class="text-xs text-gray-500 mt-1">ElevenLabs</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1">ðŸŒ</span>
                            <span class="font-medium text-sm">Translation</span>
                            <p class="text-xs text-gray-500 mt-1">DeepL, Google</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1">ðŸ“·</span>
                            <span class="font-medium text-sm">OCR / Vision</span>
                            <p class="text-xs text-gray-500 mt-1">Extract text</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1">ðŸ’»</span>
                            <span class="font-medium text-sm">Code Exec</span>
                            <p class="text-xs text-gray-500 mt-1">Python, JS</p>
                        </div>
                        <div class="card p-3 rounded-lg text-center border-2 border-dashed border-gray-600 cursor-not-allowed relative">
                            <span class="absolute top-1 right-1 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">Soon</span>
                            <span class="text-xl block mb-1">ðŸ‘¤</span>
                            <span class="font-medium text-sm">Human in Loop</span>
                            <p class="text-xs text-gray-500 mt-1">Approval</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="wiz-step-1" class="hidden space-y-4">
                <div class="flex items-center gap-3 p-3 rounded-lg step-header-box">
                    <span id="step1-icon" class="text-2xl">ðŸ”§</span>
                    <div>
                        <h4 class="font-semibold" id="step1-title">Tool Name</h4>
                        <p class="text-xs text-gray-400">Step 1 of 4: Basic Information</p>
                    </div>
                </div>
                <div>
                    <label class="text-sm text-gray-400 mb-1 block">Name *</label>
                    <input type="text" id="wiz-name" class="input-field w-full rounded-lg px-4 py-3 text-lg" placeholder="Enter a descriptive name...">
                </div>
                <div>
                    <label class="text-sm text-gray-400 mb-1 block">Description</label>
                    <textarea id="wiz-desc" rows="3" class="input-field w-full rounded-lg px-4 py-3" placeholder="What does this tool do? What data does it contain?"></textarea>
                </div>
            </div>

            <!-- Step 2: Configuration (Tool-specific) -->
            <div id="wiz-step-2" class="hidden space-y-4">
                <div class="flex items-center gap-3 p-3 rounded-lg step-header-box">
                    <span class="text-2xl">âš™ï¸</span>
                    <div>
                        <h4 class="font-semibold">Configuration</h4>
                        <p class="text-xs text-gray-400">Step 2 of 4: Tool-specific settings</p>
                    </div>
                </div>
                
                <!-- Knowledge Base Config -->
                <div id="cfg-knowledge" class="hidden space-y-4">
                    <!-- Embedding -->
                    <div class="card rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h5 class="font-medium">ðŸ“ Embedding Model</h5>
                            <label class="flex items-center gap-2 text-sm cursor-pointer">
                                <input type="checkbox" id="kb-emb-global" class="w-4 h-4" checked onchange="toggleKBEmb()">
                                <span class="text-gray-400">Use global</span>
                            </label>
                        </div>
                        <div id="kb-emb-fields" class="hidden grid md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Provider</label>
                                <select id="kb-emb-provider" class="input-field w-full rounded-lg px-3 py-2" onchange="onKBEmbChange()">
                                    <option value="openai">OpenAI</option>
                                    <option value="local">Sentence Transformers (Free)</option>
                                </select>
                            
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Model</label>
                                <select id="kb-emb-model" class="input-field w-full rounded-lg px-3 py-2">
                                    <option value="text-embedding-3-small">text-embedding-3-small</option>
                                    <option value="text-embedding-3-large">text-embedding-3-large</option>
                                </select>
                            
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search Settings -->
                    <div class="card rounded-lg p-4">
                        <h5 class="font-medium mb-3">ðŸ” Search Settings</h5>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Chunk Size</label>
                                <input type="number" id="kb-chunk" class="input-field w-full rounded-lg px-3 py-2" value="1000">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Overlap</label>
                                <input type="number" id="kb-overlap" class="input-field w-full rounded-lg px-3 py-2" value="200">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Top K</label>
                                <input type="number" id="kb-topk" class="input-field w-full rounded-lg px-3 py-2" value="5">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Search Type</label>
                                <select id="kb-search" class="input-field w-full rounded-lg px-3 py-2">
                                    <option value="hybrid">Hybrid</option>
                                    <option value="semantic">Semantic</option>
                                    <option value="keyword">Keyword</option>
                                </select>
                            
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Website Config -->
                <div id="cfg-website" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Website URL *</label>
                        <input type="url" id="web-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://example.com">
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="web-recursive" class="w-4 h-4">
                            <span class="text-sm">Recursive scraping</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-400">Max pages:</label>
                            <input type="number" id="web-max" class="input-field w-20 rounded px-2 py-1" value="10">
                        </div>
                    </div>
                    
                    <!-- Existing Scraped Pages (shown when editing) -->
                    <div id="web-scraped-pages" class="hidden">
                        <div class="border-t border-gray-700 pt-4 mt-4">
                            <div class="flex items-center justify-between mb-3">
                                <h5 class="font-medium text-sm">ðŸŒ Scraped Pages</h5>
                                <button onclick="rescrapeWebsite()" class="btn-secondary px-3 py-1 rounded text-xs">ðŸ”„ Re-scrape All</button>
                            </div>
                            <div id="web-scraped-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Database Config -->
                <div id="cfg-database" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Database Type</label>
                        <select id="db-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onDBTypeChange()">
                            <optgroup label="Relational Databases">
                                <option value="postgresql">PostgreSQL</option>
                                <option value="mysql">MySQL / MariaDB</option>
                                <option value="mssql">Microsoft SQL Server</option>
                                <option value="oracle">Oracle Database</option>
                                <option value="oracle_autonomous">Oracle Autonomous Database</option>
                                <option value="sqlite">SQLite</option>
                                <option value="db2">IBM Db2</option>
                                <option value="sybase">SAP Sybase</option>
                                <option value="teradata">Teradata</option>
                                <option value="snowflake">Snowflake</option>
                                <option value="redshift">Amazon Redshift</option>
                                <option value="bigquery">Google BigQuery</option>
                                <option value="azure_sql">Azure SQL Database</option>
                                <option value="cockroachdb">CockroachDB</option>
                                <option value="tidb">TiDB</option>
                            </optgroup>
                            <optgroup label="NoSQL Databases">
                                <option value="mongodb">MongoDB</option>
                                <option value="mongodb_atlas">MongoDB Atlas</option>
                                <option value="dynamodb">Amazon DynamoDB</option>
                                <option value="cosmosdb">Azure Cosmos DB</option>
                                <option value="firestore">Google Firestore</option>
                                <option value="couchdb">CouchDB</option>
                                <option value="cassandra">Apache Cassandra</option>
                                <option value="scylladb">ScyllaDB</option>
                                <option value="hbase">Apache HBase</option>
                            </optgroup>
                            <optgroup label="In-Memory / Cache">
                                <option value="redis">Redis</option>
                                <option value="memcached">Memcached</option>
                                <option value="elasticache">Amazon ElastiCache</option>
                            </optgroup>
                            <optgroup label="Search Engines">
                                <option value="elasticsearch">Elasticsearch</option>
                                <option value="opensearch">OpenSearch</option>
                                <option value="solr">Apache Solr</option>
                                <option value="meilisearch">Meilisearch</option>
                            </optgroup>
                            <optgroup label="Vector Databases">
                                <option value="pinecone">Pinecone</option>
                                <option value="weaviate">Weaviate</option>
                                <option value="qdrant">Qdrant</option>
                                <option value="milvus">Milvus</option>
                                <option value="chroma">ChromaDB</option>
                            </optgroup>
                            <optgroup label="Time Series">
                                <option value="influxdb">InfluxDB</option>
                                <option value="timescaledb">TimescaleDB</option>
                                <option value="questdb">QuestDB</option>
                            </optgroup>
                            <optgroup label="Graph Databases">
                                <option value="neo4j">Neo4j</option>
                                <option value="neptune">Amazon Neptune</option>
                                <option value="arangodb">ArangoDB</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    
                    <!-- Standard Connection Fields -->
                    <div id="db-standard-fields">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Host</label>
                                <input type="text" id="db-host" class="input-field w-full rounded-lg px-4 py-2" placeholder="localhost or hostname">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Port</label>
                                <input type="number" id="db-port" class="input-field w-full rounded-lg px-4 py-2" value="5432">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Database Name</label>
                                <input type="text" id="db-name" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Schema (optional)</label>
                                <input type="text" id="db-schema" class="input-field w-full rounded-lg px-4 py-2" placeholder="public">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Username</label>
                                <input type="text" id="db-user" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Password</label>
                                <input type="password" id="db-pass" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Oracle Specific Fields -->
                    <div id="db-oracle-fields" class="hidden space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Connection Type</label>
                                <select id="oracle-conn-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onOracleConnTypeChange()">
                                    <option value="basic">Basic (Host/Port/Service)</option>
                                    <option value="tns">TNS Name</option>
                                    <option value="connection_string">Connection String</option>
                                    <option value="wallet">Wallet (Cloud)</option>
                                </select>
                            
                            </div>
                            <div id="oracle-service-field">
                                <label class="text-sm text-gray-400 mb-1 block">Service Name / SID</label>
                                <input type="text" id="oracle-service" class="input-field w-full rounded-lg px-4 py-2" placeholder="ORCL or service_name">
                            </div>
                        </div>
                        <div id="oracle-tns-field" class="hidden">
                            <label class="text-sm text-gray-400 mb-1 block">TNS Name</label>
                            <input type="text" id="oracle-tns" class="input-field w-full rounded-lg px-4 py-2" placeholder="MY_TNS_ALIAS">
                        </div>
                        <div id="oracle-wallet-fields" class="hidden">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Wallet Location</label>
                                    <input type="text" id="oracle-wallet-loc" class="input-field w-full rounded-lg px-4 py-2" placeholder="/path/to/wallet">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Wallet Password</label>
                                    <input type="password" id="oracle-wallet-pass" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="text-sm text-gray-400 mb-1 block">Or Upload Wallet ZIP</label>
                                <input type="file" id="oracle-wallet-file" class="input-field w-full rounded-lg px-4 py-2" accept=".zip">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Oracle Autonomous DB Fields -->
                    <div id="db-oracle-adb-fields" class="hidden space-y-4">
                        <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 text-sm text-amber-300 mb-4">
                            â„¹ï¸ Oracle Autonomous Database requires a wallet for secure connections. Download it from OCI Console.
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">ADB Type</label>
                                <select id="oracle-adb-type" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="atp">Autonomous Transaction Processing (ATP)</option>
                                    <option value="adw">Autonomous Data Warehouse (ADW)</option>
                                    <option value="ajd">Autonomous JSON Database (AJD)</option>
                                    <option value="apex">APEX Service</option>
                                </select>
                            
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Connection Service</label>
                                <select id="oracle-adb-service" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="high">High (Parallel Queries)</option>
                                    <option value="medium">Medium (Balanced)</option>
                                    <option value="low">Low (Serial)</option>
                                    <option value="tp">TP (Transaction Processing)</option>
                                    <option value="tpurgent">TP Urgent</option>
                                </select>
                            
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Database Name</label>
                            <input type="text" id="oracle-adb-name" class="input-field w-full rounded-lg px-4 py-2" placeholder="myatp_high">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Wallet ZIP File</label>
                            <input type="file" id="oracle-adb-wallet" class="input-field w-full rounded-lg px-4 py-2" accept=".zip">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Username</label>
                                <input type="text" id="oracle-adb-user" class="input-field w-full rounded-lg px-4 py-2" placeholder="ADMIN">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Password</label>
                                <input type="password" id="oracle-adb-pass" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cloud DB Fields (BigQuery, Snowflake, etc) -->
                    <div id="db-cloud-fields" class="hidden space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Account / Project ID</label>
                                <input type="text" id="db-cloud-account" class="input-field w-full rounded-lg px-4 py-2" placeholder="my-project-id">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Warehouse / Dataset</label>
                                <input type="text" id="db-cloud-warehouse" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Service Account / API Key JSON</label>
                            <textarea id="db-cloud-creds" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste credentials JSON or API key"></textarea>
                        </div>
                        <div id="db-snowflake-extra" class="hidden grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Role</label>
                                <input type="text" id="db-snowflake-role" class="input-field w-full rounded-lg px-4 py-2" placeholder="ACCOUNTADMIN">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                <input type="text" id="db-snowflake-region" class="input-field w-full rounded-lg px-4 py-2" placeholder="us-east-1">
                            </div>
                        </div>
                    </div>
                    
                    <!-- NoSQL Fields (MongoDB, etc) -->
                    <div id="db-nosql-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Connection String</label>
                            <input type="text" id="db-nosql-uri" class="input-field w-full rounded-lg px-4 py-2" placeholder="mongodb+srv://user:pass@cluster.mongodb.net/db">
                        </div>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="db-nosql-ssl" class="w-4 h-4" checked>
                                <span class="text-sm">Use SSL/TLS</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="db-nosql-srv" class="w-4 h-4">
                                <span class="text-sm">SRV Record</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Vector DB Fields -->
                    <div id="db-vector-fields" class="hidden space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                                <input type="password" id="db-vector-key" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Environment / Region</label>
                                <input type="text" id="db-vector-env" class="input-field w-full rounded-lg px-4 py-2" placeholder="us-east-1-aws">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Index / Collection Name</label>
                            <input type="text" id="db-vector-index" class="input-field w-full rounded-lg px-4 py-2" placeholder="my-index">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Dimensions</label>
                                <input type="number" id="db-vector-dims" class="input-field w-full rounded-lg px-4 py-2" value="1536">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Metric</label>
                                <select id="db-vector-metric" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="cosine">Cosine Similarity</option>
                                    <option value="euclidean">Euclidean Distance</option>
                                    <option value="dotproduct">Dot Product</option>
                                </select>
                            
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connection Options -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">Connection Options</p>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="db-ssl" class="w-4 h-4">
                                <span class="text-sm">Use SSL/TLS</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="db-readonly" class="w-4 h-4">
                                <span class="text-sm">Read-only mode</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="db-pool" class="w-4 h-4" checked>
                                <span class="text-sm">Connection pooling</span>
                            </label>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4 mt-3">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Connection Timeout (sec)</label>
                                <input type="number" id="db-timeout" class="input-field w-full rounded-lg px-4 py-2" value="30">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Max Connections</label>
                                <input type="number" id="db-max-conn" class="input-field w-full rounded-lg px-4 py-2" value="10">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Config -->
                <div id="cfg-api" class="hidden space-y-4">
                    <div class="grid md:grid-cols-4 gap-4">
                        <div class="md:col-span-3">
                            <label class="text-sm text-gray-400 mb-1 block">Base URL *</label>
                            <input type="url" id="api-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://api.example.com">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Method</label>
                            <select id="api-method" class="input-field w-full rounded-lg px-4 py-2">
                                <option>GET</option>
                                <option>POST</option>
                                <option>PUT</option>
                                <option>DELETE</option>
                            </select>
                            
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Endpoint Path</label>
                        <input type="text" id="api-path" class="input-field w-full rounded-lg px-4 py-2" placeholder="/v1/data">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Authentication</label>
                            <select id="api-auth" class="input-field w-full rounded-lg px-4 py-2" onchange="onApiAuthChange()">
                                <option value="none">None</option>
                                <option value="api_key">API Key</option>
                                <option value="bearer">Bearer Token</option>
                            </select>
                            
                        </div>
                        <div id="api-auth-val-group" class="hidden">
                            <label class="text-sm text-gray-400 mb-1 block">Auth Value</label>
                            <input type="password" id="api-auth-val" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>

                    <!-- Parameters (optional) - non-technical: user gets list from IT -->
                    <div class="border-t border-gray-700/60 pt-4 mt-4">
                        <h5 class="text-sm font-semibold text-gray-300 mb-1">Fields this API needs <span class="text-gray-500 font-normal">(optional)</span></h5>
                        <p class="text-xs text-gray-500 mb-3">If your IT team gave you a list of fields (e.g. city, ID, date), add them here. Leave empty if the API doesnâ€™t need any.</p>
                        <div id="api-params-list" class="space-y-3 mb-3"></div>
                        <button type="button" onclick="addApiParam()" class="btn-secondary px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                            <span>+</span> Add field
                        </button>
                    </div>

                    <!-- Try API (test from wizard) -->
                    <div class="border-t border-gray-700/60 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">Check that the connection works before saving.</p>
                        <button type="button" onclick="openWizardApiTestModal()" class="btn-primary px-5 py-2.5 rounded-lg flex items-center gap-2">
                            <span>ðŸ§ª</span> Try this API
                        </button>
                    </div>
                </div>

                <!-- Email Config -->
                <div id="cfg-email" class="hidden space-y-4">
                    <!-- Super Simple - Just Connect -->
                    <div class="space-y-3">
                        <!-- Google / Gmail -->
                        <div id="gmail-connect-card" class="card rounded-xl p-5 border-2 border-transparent hover:border-purple-500 transition">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-xl bg-white flex items-center justify-center shadow-sm shrink-0">
                                    <svg width="32" height="32" viewBox="0 0 24 24">
                                        <path fill="#EA4335" d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h5 class="font-semibold text-lg" style="color:var(--text-primary);">Gmail</h5>
                                    <p class="text-sm" style="color:var(--text-muted);">Send emails from your Gmail account</p>
                                </div>
                                <button onclick="connectEmailProvider('google')" id="gmail-connect-btn" class="btn-primary px-5 py-2.5 rounded-lg flex items-center gap-2">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                    Connect
                                </button>
                            </div>
                            <!-- Connected State (hidden by default) -->
                            <div id="gmail-connected" class="hidden mt-4 pt-4 border-t" style="border-color:var(--border-color);">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center">
                                            <span class="text-green-500">âœ“</span>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium" style="color:var(--text-primary);">Connected</p>
                                            <p class="text-xs" style="color:var(--text-muted);" id="gmail-connected-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="265355435466435e474b564a430845494b">[email&#160;protected]</a></p>
                                        </div>
                                    </div>
                                    <button onclick="disconnectEmailProvider('google')" class="text-xs px-3 py-1.5 rounded-lg hover:bg-red-500/10 text-red-400">
                                        Disconnect
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Microsoft / Outlook -->
                        <div id="outlook-connect-card" class="card rounded-xl p-5 border-2 border-transparent hover:border-purple-500 transition">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-xl bg-white flex items-center justify-center shadow-sm shrink-0">
                                    <svg width="32" height="32" viewBox="0 0 24 24">
                                        <path fill="#0078D4" d="M24 7.387v10.478c0 .23-.08.424-.238.576-.158.154-.352.23-.58.23h-8.547v-6.959l1.6 1.229c.102.086.228.13.378.13.15 0 .276-.044.378-.13l6.771-5.186c.076-.056.142-.076.199-.06.057.017.086.063.086.138v10.054c0 .077-.03.14-.09.186-.06.047-.126.07-.2.07H15.91v1.14h8.908c.076 0 .14-.028.188-.084.047-.056.07-.12.07-.19V7.387z"/>
                                        <path fill="#0078D4" d="M15.635 9.807v11.57H.818c-.227 0-.42-.078-.577-.234C.083 21.013 0 20.83 0 20.604V7.387l7.818 5.642 7.817-3.222z"/>
                                        <path fill="#28A8EA" d="M15.635 2.623v7.184l-7.817 3.222L0 7.387V3.396c0-.227.083-.42.241-.577C.398 2.662.591 2.58.818 2.58h14.043c.227 0 .42.082.577.24.157.158.197.35.197.577v-.774z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h5 class="font-semibold text-lg" style="color:var(--text-primary);">Outlook</h5>
                                    <p class="text-sm" style="color:var(--text-muted);">Send emails from your Microsoft account</p>
                                </div>
                                <button onclick="connectEmailProvider('microsoft')" id="outlook-connect-btn" class="btn-secondary px-5 py-2.5 rounded-lg flex items-center gap-2">
                                    Connect
                                </button>
                            </div>
                            <!-- Connected State -->
                            <div id="outlook-connected" class="hidden mt-4 pt-4 border-t" style="border-color:var(--border-color);">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center">
                                            <span class="text-green-500">âœ“</span>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium" style="color:var(--text-primary);">Connected</p>
                                            <p class="text-xs" style="color:var(--text-muted);" id="outlook-connected-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dda8aeb8af9db8a5bcb0adb1b8f3beb2b0">[email&#160;protected]</a></p>
                                        </div>
                                    </div>
                                    <button onclick="disconnectEmailProvider('microsoft')" class="text-xs px-3 py-1.5 rounded-lg hover:bg-red-500/10 text-red-400">
                                        Disconnect
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SendGrid (for power users) -->
                        <div id="sendgrid-connect-card" class="card rounded-xl p-5 border-2 border-transparent hover:border-purple-500 transition">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-xl bg-[#1A82E2] flex items-center justify-center shadow-sm shrink-0">
                                    <span class="text-white font-bold text-xl">SG</span>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <h5 class="font-semibold text-lg" style="color:var(--text-primary);">SendGrid</h5>
                                        <span class="text-xs px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400">Pro</span>
                                    </div>
                                    <p class="text-sm" style="color:var(--text-muted);">Professional email delivery service</p>
                                </div>
                                <button onclick="toggleSendGridSetup()" id="sendgrid-setup-btn" class="btn-secondary px-5 py-2.5 rounded-lg">
                                    Setup
                                </button>
                            </div>
                            <!-- SendGrid Setup -->
                            <div id="sendgrid-setup" class="hidden mt-4 pt-4 border-t space-y-3" style="border-color:var(--border-color);">
                                <div>
                                    <label class="text-sm mb-1 block" style="color:var(--text-secondary);">API Key</label>
                                    <input type="password" id="sendgrid-api-key" class="input-field w-full rounded-lg px-4 py-2.5" placeholder="SG.xxxxxxxxxxxx">
                                </div>
                                <div>
                                    <label class="text-sm mb-1 block" style="color:var(--text-secondary);">From Email</label>
                                    <input type="email" id="sendgrid-from-email" class="input-field w-full rounded-lg px-4 py-2.5" placeholder="notifications@yourdomain.com">
                                </div>
                                <div class="flex justify-end">
                                    <button onclick="saveSendGridConfig()" class="btn-primary px-4 py-2 rounded-lg text-sm">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden field -->
                    <input type="hidden" id="email-provider" value="">
                    <input type="hidden" id="email-config-data" value="">
                </div>

                <!-- Webhook Config -->
                <div id="cfg-webhook" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Webhook URL *</label>
                        <input type="url" id="hook-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://api.example.com/webhook">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Method</label>
                            <select id="hook-method" class="input-field w-full rounded-lg px-4 py-2">
                                <option>POST</option>
                                <option>PUT</option>
                            </select>
                            
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Secret (optional)</label>
                            <input type="password" id="hook-secret" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                </div>

                <!-- Web Search Config -->
                <div id="cfg-websearch" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Search Provider</label>
                        <select id="search-provider" class="input-field w-full rounded-lg px-4 py-2">
                            <option value="tavily">Tavily (AI-optimized)</option>
                            <option value="serper">Serper (Google)</option>
                            <option value="bing">Bing Search</option>
                        </select>
                            
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">API Key *</label>
                        <input type="password" id="search-key" class="input-field w-full rounded-lg px-4 py-2">
                    </div>
                </div>

                <!-- Code Exec Config -->
                <div id="cfg-code" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Execution Mode</label>
                        <select id="code-mode" class="input-field w-full rounded-lg px-4 py-2" onchange="onCodeModeChange()">
                            <option value="execute">Execute Provided Code</option>
                            <option value="generate">Generate Code from Description (AI)</option>
                            <option value="both">Both (Generate & Execute)</option>
                        </select>
                            
                    </div>
                    
                    <!-- Code Generation Section -->
                    <div id="code-gen-section" class="hidden space-y-4">
                        <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-3 text-sm text-purple-300 mb-2">
                            âœ¨ AI will generate tool code based on your description. Describe what the tool should do and the AI will create the implementation.
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Tool Description *</label>
                            <textarea id="code-description" rows="4" class="input-field w-full rounded-lg px-4 py-2" placeholder="Describe what this tool should do in detail...

Example: A tool that fetches weather data from OpenWeatherMap API. It should accept a city name as input and return current temperature, humidity, and weather conditions. Handle API errors gracefully."></textarea>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Input Parameters</label>
                                <input type="text" id="code-inputs" class="input-field w-full rounded-lg px-4 py-2" placeholder="city: string, units: string">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Output Format</label>
                                <select id="code-output-format" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="json">JSON Object</option>
                                    <option value="text">Plain Text</option>
                                    <option value="number">Number</option>
                                    <option value="boolean">Boolean</option>
                                    <option value="array">Array</option>
                                </select>
                            
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Keys / Credentials (will be injected as env vars)</label>
                            <textarea id="code-env-vars" rows="2" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="OPENWEATHER_API_KEY=xxxxx
OTHER_API_KEY=yyyyy"></textarea>
                        </div>
                        <button onclick="generateToolCode()" class="w-full bg-purple-600 hover:bg-purple-500 rounded-lg py-3 font-medium flex items-center justify-center gap-2">
                            <span>âœ¨</span> Generate Code
                        </button>
                        <div id="generated-code-preview" class="hidden">
                            <label class="text-sm text-gray-400 mb-1 block">Generated Code (editable)</label>
                            <textarea id="code-generated" rows="12" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs"></textarea>
                        </div>
                    </div>
                    
                    <!-- Manual Code Section -->
                    <div id="code-manual-section">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Language</label>
                            <select id="code-lang" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="python">Python 3</option>
                                <option value="javascript">JavaScript (Node.js)</option>
                                <option value="typescript">TypeScript</option>
                                <option value="bash">Bash Script</option>
                                <option value="ruby">Ruby</option>
                                <option value="go">Go</option>
                                <option value="rust">Rust</option>
                            </select>
                            
                        </div>
                        <div id="code-manual-input">
                            <label class="text-sm text-gray-400 mb-1 block">Code Template (optional)</label>
                            <textarea id="code-template" rows="6" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="# Your code here
def run(input_data):
    # Process input
    result = process(input_data)
    return result"></textarea>
                        </div>
                    </div>
                    
                    <!-- Execution Settings -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">Execution Settings</p>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Timeout (seconds)</label>
                                <input type="number" id="code-timeout" class="input-field w-full rounded-lg px-4 py-2" value="30">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Memory (MB)</label>
                                <input type="number" id="code-memory" class="input-field w-full rounded-lg px-4 py-2" value="256">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Max Retries</label>
                                <input type="number" id="code-retries" class="input-field w-full rounded-lg px-4 py-2" value="3">
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4 mt-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="code-sandbox" class="w-4 h-4" checked>
                                <span class="text-sm">Run in sandbox</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="code-network" class="w-4 h-4" checked>
                                <span class="text-sm">Allow network access</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="code-filesystem" class="w-4 h-4">
                                <span class="text-sm">Allow file system</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Dependencies -->
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Dependencies / Packages</label>
                        <input type="text" id="code-deps" class="input-field w-full rounded-lg px-4 py-2" placeholder="requests, pandas, numpy (comma separated)">
                    </div>
                </div>

                <!-- Human in the Loop Config -->
                <div id="cfg-hitl" class="hidden space-y-4">
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 text-sm text-blue-300 mb-2">
                        ðŸ‘¤ Human in the Loop allows you to pause agent execution for human approval, input collection, or decision making.
                    </div>
                    
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Interaction Type</label>
                        <select id="hitl-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onHITLTypeChange()">
                            <option value="approval">Approval (Yes/No/Maybe)</option>
                            <option value="input">Text Input</option>
                            <option value="selection">Selection (Multiple Choice)</option>
                            <option value="form">Custom Form</option>
                            <option value="review">Review & Edit</option>
                            <option value="escalation">Escalation to Human</option>
                        </select>
                            
                    </div>
                    
                    <!-- Approval Fields -->
                    <div id="hitl-approval-fields" class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Approval Question</label>
                            <input type="text" id="hitl-question" class="input-field w-full rounded-lg px-4 py-2" placeholder="Should we proceed with this action?">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Options</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center gap-2"><input type="checkbox" id="hitl-opt-yes" checked> Yes</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="hitl-opt-no" checked> No</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="hitl-opt-maybe"> Maybe/Later</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="hitl-opt-custom"> Custom options</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selection Fields -->
                    <div id="hitl-selection-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Selection Prompt</label>
                            <input type="text" id="hitl-select-prompt" class="input-field w-full rounded-lg px-4 py-2" placeholder="Please select an option:">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Options (one per line)</label>
                            <textarea id="hitl-options" rows="4" class="input-field w-full rounded-lg px-4 py-2" placeholder="Option 1
Option 2
Option 3"></textarea>
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="hitl-multi-select" class="w-4 h-4">
                            <span class="text-sm">Allow multiple selections</span>
                        </label>
                    </div>
                    
                    <!-- Form Builder Fields -->
                    <div id="hitl-form-fields" class="hidden space-y-4">
                        <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-3 text-sm text-purple-300 mb-2">
                            ðŸ“ Build a custom form that will be presented to users. You can optionally deploy it as a web form.
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Form Title</label>
                            <input type="text" id="hitl-form-title" class="input-field w-full rounded-lg px-4 py-2" placeholder="Customer Feedback Form">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Form Description</label>
                            <textarea id="hitl-form-desc" rows="2" class="input-field w-full rounded-lg px-4 py-2" placeholder="Please provide your feedback..."></textarea>
                        </div>
                        
                        <!-- Form Fields Builder -->
                        <div>
                            <label class="text-sm text-gray-400 mb-2 block">Form Fields</label>
                            <div id="hitl-form-builder" class="space-y-2">
                                <!-- Dynamic form fields will be added here -->
                            </div>
                            <button onclick="addHITLFormField()" class="mt-2 text-sm text-purple-400 hover:text-purple-300 flex items-center gap-1">
                                <span>+</span> Add Field
                            </button>
                        </div>
                        
                        <!-- Form Field Template (hidden) -->
                        <template id="hitl-field-template">
                            <div class="card rounded-lg p-3 space-y-2 hitl-field-item">
                                <div class="flex items-center justify-between">
                                    <input type="text" class="input-field flex-1 rounded px-2 py-1 text-sm hitl-field-label" placeholder="Field Label">
                                    <button onclick="removeHITLFormField(this)" class="text-red-400 hover:text-red-300 p-1">ðŸ—‘ï¸</button>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <select class="input-field rounded px-2 py-1 text-sm hitl-field-type" onchange="onHITLFieldTypeChange(this)">
                                        <option value="text">Text Input</option>
                                        <option value="textarea">Text Area</option>
                                        <option value="number">Number</option>
                                        <option value="email">Email</option>
                                        <option value="phone">Phone</option>
                                        <option value="date">Date</option>
                                        <option value="time">Time</option>
                                        <option value="select">Dropdown</option>
                                        <option value="radio">Radio Buttons</option>
                                        <option value="checkbox">Checkboxes</option>
                                        <option value="file">File Upload</option>
                                        <option value="rating">Rating (1-5)</option>
                                    </select>
                            
                                    <label class="flex items-center gap-1 text-sm">
                                        <input type="checkbox" class="hitl-field-required">
                                        Required
                                    </label>
                                </div>
                                <input type="text" class="input-field w-full rounded px-2 py-1 text-sm hitl-field-options hidden" placeholder="Options (comma separated)">
                            </div>
                        </template>
                        
                        <!-- Web Form Deployment (optional) -->
                        <div class="border-t border-gray-700 pt-4 mt-4">
                            <label class="flex items-center gap-2 cursor-pointer mb-3">
                                <input type="checkbox" id="hitl-deploy-form" class="w-4 h-4" onchange="toggleHITLDeployment()">
                                <span class="text-sm font-medium">Deploy as Web Form</span>
                            </label>
                            <div id="hitl-deployment-fields" class="hidden space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Form URL Slug</label>
                                        <div class="flex items-center gap-1">
                                            <span class="text-sm text-gray-500">/forms/</span>
                                            <input type="text" id="hitl-form-slug" class="input-field flex-1 rounded-lg px-3 py-2" placeholder="customer-feedback">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Expiration</label>
                                        <select id="hitl-form-expiry" class="input-field w-full rounded-lg px-4 py-2">
                                            <option value="never">Never</option>
                                            <option value="1h">1 Hour</option>
                                            <option value="24h">24 Hours</option>
                                            <option value="7d">7 Days</option>
                                            <option value="30d">30 Days</option>
                                        </select>
                            
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="hitl-form-public" class="w-4 h-4">
                                        <span class="text-sm">Public (no auth required)</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="hitl-form-notify" class="w-4 h-4" checked>
                                        <span class="text-sm">Notify on submission</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Notification Email</label>
                                    <input type="email" id="hitl-notify-email" class="input-field w-full rounded-lg px-4 py-2" placeholder="admin@company.com">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Webhook URL (optional)</label>
                                    <input type="url" id="hitl-webhook" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://your-server.com/webhook">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Common Settings -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">Behavior Settings</p>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Timeout (minutes)</label>
                                <input type="number" id="hitl-timeout" class="input-field w-full rounded-lg px-4 py-2" value="60" placeholder="0 = no timeout">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Default Action (on timeout)</label>
                                <select id="hitl-default" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="wait">Keep Waiting</option>
                                    <option value="approve">Auto Approve</option>
                                    <option value="reject">Auto Reject</option>
                                    <option value="escalate">Escalate</option>
                                </select>
                            
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4 mt-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="hitl-notify-slack" class="w-4 h-4">
                                <span class="text-sm">Notify via Slack</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="hitl-notify-email-opt" class="w-4 h-4">
                                <span class="text-sm">Notify via Email</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="hitl-log" class="w-4 h-4" checked>
                                <span class="text-sm">Log all interactions</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Spreadsheet Config -->
                <div id="cfg-spreadsheet" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="sheet-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onSheetProvChange()">
                            <option value="google">Google Sheets</option>
                            <option value="airtable">Airtable</option>
                            <option value="excel">Excel Online</option>
                        </select>
                            
                    </div>
                    <div id="sheet-google-fields">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Spreadsheet ID</label>
                            <input type="text" id="sheet-id" class="input-field w-full rounded-lg px-4 py-2" placeholder="From URL: docs.google.com/spreadsheets/d/[ID]">
                        </div>
                        <div class="mt-3">
                            <label class="text-sm text-gray-400 mb-1 block">Service Account JSON</label>
                            <textarea id="sheet-creds" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder='{"type": "service_account", ...}'></textarea>
                        </div>
                    </div>
                    <div id="sheet-airtable-fields" class="hidden">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                            <input type="password" id="airtable-key" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div class="mt-3">
                            <label class="text-sm text-gray-400 mb-1 block">Base ID</label>
                            <input type="text" id="airtable-base" class="input-field w-full rounded-lg px-4 py-2" placeholder="appXXXXXXXXXXXXXX">
                        </div>
                    </div>
                </div>

                <!-- Cloud Storage Config -->
                <div id="cfg-storage" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Storage Type</label>
                        <select id="storage-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onStorageTypeChange()">
                            <option value="cloud">Cloud Storage</option>
                            <option value="local">Local / Network Storage</option>
                        </select>
                            
                    </div>
                    
                    <!-- Cloud Storage Providers -->
                    <div id="storage-cloud-section">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                            <select id="storage-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onStorageProvChange()">
                                <optgroup label="Amazon Web Services">
                                    <option value="s3">Amazon S3</option>
                                    <option value="s3_glacier">Amazon S3 Glacier</option>
                                    <option value="efs">Amazon EFS</option>
                                </optgroup>
                                <optgroup label="Google Cloud">
                                    <option value="gcs">Google Cloud Storage</option>
                                    <option value="gcs_nearline">GCS Nearline</option>
                                    <option value="gcs_coldline">GCS Coldline</option>
                                    <option value="gcs_archive">GCS Archive</option>
                                </optgroup>
                                <optgroup label="Microsoft Azure">
                                    <option value="azure_blob">Azure Blob Storage</option>
                                    <option value="azure_files">Azure Files</option>
                                    <option value="azure_datalake">Azure Data Lake Storage</option>
                                    <option value="azure_archive">Azure Archive Storage</option>
                                </optgroup>
                                <optgroup label="Oracle Cloud Infrastructure">
                                    <option value="oci_object">OCI Object Storage</option>
                                    <option value="oci_archive">OCI Archive Storage</option>
                                    <option value="oci_file">OCI File Storage</option>
                                    <option value="oci_block">OCI Block Volume</option>
                                </optgroup>
                                <optgroup label="Other Cloud Providers">
                                    <option value="ibm_cos">IBM Cloud Object Storage</option>
                                    <option value="alibaba_oss">Alibaba Cloud OSS</option>
                                    <option value="digitalocean_spaces">DigitalOcean Spaces</option>
                                    <option value="backblaze_b2">Backblaze B2</option>
                                    <option value="wasabi">Wasabi</option>
                                    <option value="cloudflare_r2">Cloudflare R2</option>
                                    <option value="linode_obj">Linode Object Storage</option>
                                    <option value="vultr_obj">Vultr Object Storage</option>
                                    <option value="minio">MinIO (S3 Compatible)</option>
                                </optgroup>
                            </select>
                            
                        </div>
                        
                        <!-- Standard S3-Compatible Fields -->
                        <div id="storage-s3-fields" class="mt-4 space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Bucket / Container Name</label>
                                    <input type="text" id="storage-bucket" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                    <input type="text" id="storage-region" class="input-field w-full rounded-lg px-4 py-2" placeholder="us-east-1">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Access Key ID</label>
                                <input type="password" id="storage-key" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Secret Access Key</label>
                                <input type="password" id="storage-secret" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div id="storage-endpoint-field" class="hidden">
                                <label class="text-sm text-gray-400 mb-1 block">Custom Endpoint URL</label>
                                <input type="url" id="storage-endpoint" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://s3.custom-endpoint.com">
                            </div>
                        </div>
                        
                        <!-- OCI Object Storage Fields -->
                        <div id="storage-oci-fields" class="hidden mt-4 space-y-4">
                            <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 text-sm text-orange-300 mb-2">
                                â„¹ï¸ OCI requires API Key authentication. Generate keys from OCI Console â†’ User Settings â†’ API Keys
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Namespace</label>
                                    <input type="text" id="oci-namespace" class="input-field w-full rounded-lg px-4 py-2" placeholder="your-tenancy-namespace">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Bucket Name</label>
                                    <input type="text" id="oci-bucket" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Compartment OCID</label>
                                    <input type="text" id="oci-compartment" class="input-field w-full rounded-lg px-4 py-2" placeholder="ocid1.compartment.oc1..">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                    <select id="oci-region" class="input-field w-full rounded-lg px-4 py-2">
                                        <option value="us-ashburn-1">US East (Ashburn)</option>
                                        <option value="us-phoenix-1">US West (Phoenix)</option>
                                        <option value="eu-frankfurt-1">Germany (Frankfurt)</option>
                                        <option value="eu-london-1">UK (London)</option>
                                        <option value="ap-tokyo-1">Japan (Tokyo)</option>
                                        <option value="ap-sydney-1">Australia (Sydney)</option>
                                        <option value="ap-mumbai-1">India (Mumbai)</option>
                                        <option value="me-jeddah-1">Saudi Arabia (Jeddah)</option>
                                        <option value="me-dubai-1">UAE (Dubai)</option>
                                        <option value="sa-saopaulo-1">Brazil (Sao Paulo)</option>
                                    </select>
                            
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">User OCID</label>
                                <input type="text" id="oci-user-ocid" class="input-field w-full rounded-lg px-4 py-2" placeholder="ocid1.user.oc1..">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Tenancy OCID</label>
                                <input type="text" id="oci-tenancy-ocid" class="input-field w-full rounded-lg px-4 py-2" placeholder="ocid1.tenancy.oc1..">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">API Key Fingerprint</label>
                                <input type="text" id="oci-fingerprint" class="input-field w-full rounded-lg px-4 py-2" placeholder="xx:xx:xx:xx:xx:...">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Private Key (PEM)</label>
                                <textarea id="oci-private-key" rows="4" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="-----BEGIN RSA PRIVATE KEY-----..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Azure Fields -->
                        <div id="storage-azure-fields" class="hidden mt-4 space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Storage Account Name</label>
                                    <input type="text" id="azure-account" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Container Name</label>
                                    <input type="text" id="azure-container" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Authentication Method</label>
                                <select id="azure-auth-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onAzureAuthChange()">
                                    <option value="connection_string">Connection String</option>
                                    <option value="account_key">Account Key</option>
                                    <option value="sas_token">SAS Token</option>
                                    <option value="service_principal">Service Principal</option>
                                    <option value="managed_identity">Managed Identity</option>
                                </select>
                            
                            </div>
                            <div id="azure-conn-string-field">
                                <label class="text-sm text-gray-400 mb-1 block">Connection String</label>
                                <textarea id="azure-conn-string" rows="2" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs"></textarea>
                            </div>
                            <div id="azure-sp-fields" class="hidden space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Tenant ID</label>
                                        <input type="text" id="azure-tenant" class="input-field w-full rounded-lg px-4 py-2">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400 mb-1 block">Client ID</label>
                                        <input type="text" id="azure-client" class="input-field w-full rounded-lg px-4 py-2">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Client Secret</label>
                                    <input type="password" id="azure-secret" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                        </div>
                        
                        <!-- GCS Fields -->
                        <div id="storage-gcs-fields" class="hidden mt-4 space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Project ID</label>
                                    <input type="text" id="gcs-project" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Bucket Name</label>
                                    <input type="text" id="gcs-bucket" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Service Account JSON</label>
                                <textarea id="gcs-credentials" rows="4" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste service account JSON"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Local/Network Storage Section -->
                    <div id="storage-local-section" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Storage Protocol</label>
                            <select id="local-storage-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onLocalStorageTypeChange()">
                                <option value="local">Local Filesystem</option>
                                <option value="nfs">NFS (Network File System)</option>
                                <option value="smb">SMB/CIFS (Windows Share)</option>
                                <option value="sftp">SFTP</option>
                                <option value="ftp">FTP</option>
                                <option value="webdav">WebDAV</option>
                            </select>
                            
                        </div>
                        
                        <!-- Local Path -->
                        <div id="local-path-field">
                            <label class="text-sm text-gray-400 mb-1 block">Base Path</label>
                            <input type="text" id="local-path" class="input-field w-full rounded-lg px-4 py-2" placeholder="/data/storage or C:\Storage">
                        </div>
                        
                        <!-- Network Storage Fields -->
                        <div id="network-storage-fields" class="hidden space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Host / Server</label>
                                    <input type="text" id="net-host" class="input-field w-full rounded-lg px-4 py-2" placeholder="192.168.1.100 or server.local">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Port</label>
                                    <input type="number" id="net-port" class="input-field w-full rounded-lg px-4 py-2" value="22">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Share / Path</label>
                                <input type="text" id="net-share" class="input-field w-full rounded-lg px-4 py-2" placeholder="/share or \\server\share">
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Username</label>
                                    <input type="text" id="net-user" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Password</label>
                                    <input type="password" id="net-pass" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                            <div id="sftp-key-field" class="hidden">
                                <label class="text-sm text-gray-400 mb-1 block">SSH Private Key (optional)</label>
                                <textarea id="sftp-key" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Storage Options -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">Storage Options</p>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="storage-public" class="w-4 h-4">
                                <span class="text-sm">Public access</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="storage-versioning" class="w-4 h-4">
                                <span class="text-sm">Enable versioning</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="storage-encryption" class="w-4 h-4" checked>
                                <span class="text-sm">Server-side encryption</span>
                            </label>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4 mt-3">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Prefix / Folder</label>
                                <input type="text" id="storage-prefix" class="input-field w-full rounded-lg px-4 py-2" placeholder="uploads/">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Max File Size (MB)</label>
                                <input type="number" id="storage-max-size" class="input-field w-full rounded-lg px-4 py-2" value="100">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Config -->
                <div id="cfg-calendar" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="cal-provider" class="input-field w-full rounded-lg px-4 py-2">
                            <option value="google">Google Calendar</option>
                            <option value="outlook">Microsoft Outlook</option>
                            <option value="caldav">CalDAV</option>
                        </select>
                            
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Calendar ID</label>
                        <input type="text" id="cal-id" class="input-field w-full rounded-lg px-4 py-2" placeholder="primary or specific calendar ID">
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Service Account / API Key</label>
                        <textarea id="cal-creds" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste credentials JSON"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="cal-read" class="w-4 h-4" checked>
                            <span class="text-sm">Read events</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="cal-write" class="w-4 h-4">
                            <span class="text-sm">Create/Edit events</span>
                        </label>
                    </div>
                </div>

                <!-- CRM Config -->
                <div id="cfg-crm" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Platform</label>
                        <select id="crm-platform" class="input-field w-full rounded-lg px-4 py-2" onchange="onCRMChange()">
                            <option value="salesforce">Salesforce</option>
                            <option value="hubspot">HubSpot</option>
                            <option value="zoho">Zoho CRM</option>
                            <option value="pipedrive">Pipedrive</option>
                        </select>
                            
                    </div>
                    <div id="crm-salesforce-fields">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Instance URL</label>
                                <input type="url" id="sf-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://yourorg.salesforce.com">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Consumer Key</label>
                                <input type="text" id="sf-key" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="text-sm text-gray-400 mb-1 block">Consumer Secret</label>
                            <input type="password" id="sf-secret" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    <div id="crm-hubspot-fields" class="hidden">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key / Access Token</label>
                            <input type="password" id="hs-key" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Objects to Access</label>
                        <div class="flex flex-wrap gap-3 mt-2">
                            <label class="flex items-center gap-2"><input type="checkbox" id="crm-contacts" checked> Contacts</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="crm-companies" checked> Companies</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="crm-deals"> Deals</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="crm-leads"> Leads</label>
                        </div>
                    </div>
                </div>

                <!-- ERP Config -->
                <div id="cfg-erp" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Platform</label>
                        <select id="erp-platform" class="input-field w-full rounded-lg px-4 py-2">
                            <option value="sap">SAP</option>
                            <option value="oracle">Oracle ERP</option>
                            <option value="netsuite">NetSuite</option>
                            <option value="dynamics">Microsoft Dynamics</option>
                        </select>
                            
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Server URL</label>
                        <input type="url" id="erp-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://erp.company.com">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Username / Client ID</label>
                            <input type="text" id="erp-user" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Password / Secret</label>
                            <input type="password" id="erp-pass" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    <div class="bg-yellow-900/30 border border-yellow-600 rounded-lg p-3 text-sm">
                        <p class="text-yellow-300">âš ï¸ ERP integration requires additional setup. Contact your ERP administrator.</p>
                    </div>
                </div>

                <!-- Messaging (Slack/Teams) Config -->
                <div id="cfg-slack" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Platform</label>
                        <select id="msg-platform" class="input-field w-full rounded-lg px-4 py-2" onchange="onMsgPlatformChange()">
                            <optgroup label="Business Messaging">
                                <option value="slack">Slack</option>
                                <option value="teams">Microsoft Teams</option>
                                <option value="discord">Discord</option>
                                <option value="mattermost">Mattermost</option>
                                <option value="rocket">Rocket.Chat</option>
                                <option value="google_chat">Google Chat</option>
                                <option value="webex">Cisco Webex</option>
                                <option value="zoom">Zoom Chat</option>
                            </optgroup>
                            <optgroup label="Consumer Messaging">
                                <option value="whatsapp">WhatsApp Business API</option>
                                <option value="facebook">Facebook Messenger</option>
                                <option value="instagram">Instagram Direct</option>
                                <option value="telegram">Telegram Bot</option>
                                <option value="viber">Viber</option>
                                <option value="line">LINE</option>
                                <option value="wechat">WeChat</option>
                            </optgroup>
                            <optgroup label="SMS / Voice">
                                <option value="twilio">Twilio SMS</option>
                                <option value="vonage">Vonage (Nexmo)</option>
                                <option value="plivo">Plivo</option>
                                <option value="messagebird">MessageBird</option>
                                <option value="sinch">Sinch</option>
                            </optgroup>
                            <optgroup label="Push Notifications">
                                <option value="firebase_fcm">Firebase Cloud Messaging</option>
                                <option value="onesignal">OneSignal</option>
                                <option value="pusher">Pusher</option>
                                <option value="apns">Apple Push Notifications</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    
                    <!-- Slack Fields -->
                    <div id="msg-slack-fields" class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Bot Token</label>
                            <input type="password" id="slack-token" class="input-field w-full rounded-lg px-4 py-2" placeholder="xoxb-...">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Default Channel</label>
                            <input type="text" id="slack-channel" class="input-field w-full rounded-lg px-4 py-2" placeholder="#general">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Signing Secret (for webhooks)</label>
                            <input type="password" id="slack-signing" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    
                    <!-- MS Teams Fields -->
                    <div id="msg-teams-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Integration Type</label>
                            <select id="teams-type" class="input-field w-full rounded-lg px-4 py-2" onchange="onTeamsTypeChange()">
                                <option value="webhook">Incoming Webhook</option>
                                <option value="bot">Bot Framework</option>
                                <option value="graph">Microsoft Graph API</option>
                            </select>
                            
                        </div>
                        <div id="teams-webhook-field">
                            <label class="text-sm text-gray-400 mb-1 block">Webhook URL</label>
                            <input type="url" id="teams-webhook" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div id="teams-bot-fields" class="hidden space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">App ID</label>
                                    <input type="text" id="teams-app-id" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">App Password</label>
                                    <input type="password" id="teams-app-pass" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Tenant ID</label>
                                <input type="text" id="teams-tenant" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- WhatsApp Fields -->
                    <div id="msg-whatsapp-fields" class="hidden space-y-4">
                        <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3 text-sm text-green-300 mb-2">
                            â„¹ï¸ WhatsApp Business API requires approval. You can use Meta Business Suite or a BSP like Twilio/MessageBird.
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                            <select id="whatsapp-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onWhatsAppProviderChange()">
                                <option value="meta">Meta Cloud API (Direct)</option>
                                <option value="twilio">Twilio for WhatsApp</option>
                                <option value="messagebird">MessageBird</option>
                                <option value="360dialog">360dialog</option>
                                <option value="gupshup">Gupshup</option>
                            </select>
                            
                        </div>
                        <div id="whatsapp-meta-fields" class="space-y-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Access Token</label>
                                <input type="password" id="whatsapp-token" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Phone Number ID</label>
                                    <input type="text" id="whatsapp-phone-id" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Business Account ID</label>
                                    <input type="text" id="whatsapp-business-id" class="input-field w-full rounded-lg px-4 py-2">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Webhook Verify Token</label>
                                <input type="text" id="whatsapp-verify" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Facebook Messenger Fields -->
                    <div id="msg-facebook-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Page Access Token</label>
                            <input type="password" id="fb-page-token" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">App ID</label>
                                <input type="text" id="fb-app-id" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">App Secret</label>
                                <input type="password" id="fb-app-secret" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Webhook Verify Token</label>
                            <input type="text" id="fb-verify" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    
                    <!-- Telegram Fields -->
                    <div id="msg-telegram-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Bot Token (from @BotFather)</label>
                            <input type="password" id="telegram-token" class="input-field w-full rounded-lg px-4 py-2" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Default Chat ID (optional)</label>
                            <input type="text" id="telegram-chat-id" class="input-field w-full rounded-lg px-4 py-2" placeholder="-1001234567890">
                        </div>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="telegram-webhook" class="w-4 h-4">
                                <span class="text-sm">Use Webhook (instead of polling)</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Twilio SMS Fields -->
                    <div id="msg-twilio-fields" class="hidden space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Account SID</label>
                                <input type="text" id="twilio-sid" class="input-field w-full rounded-lg px-4 py-2" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Auth Token</label>
                                <input type="password" id="twilio-token" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Phone Number (From)</label>
                            <input type="tel" id="twilio-phone" class="input-field w-full rounded-lg px-4 py-2" placeholder="+1234567890">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Messaging Service SID (optional)</label>
                            <input type="text" id="twilio-msg-sid" class="input-field w-full rounded-lg px-4 py-2" placeholder="MGxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                        </div>
                    </div>
                    
                    <!-- Discord Fields -->
                    <div id="msg-discord-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Bot Token</label>
                            <input type="password" id="discord-token" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Default Channel ID</label>
                            <input type="text" id="discord-channel" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Webhook URL (optional)</label>
                            <input type="url" id="discord-webhook" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    
                    <!-- Firebase FCM Fields -->
                    <div id="msg-firebase-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Service Account JSON</label>
                            <textarea id="fcm-credentials" rows="4" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste Firebase service account JSON"></textarea>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Default Topic (optional)</label>
                            <input type="text" id="fcm-topic" class="input-field w-full rounded-lg px-4 py-2" placeholder="all-users">
                        </div>
                    </div>
                    
                    <!-- Generic Webhook Fields (for other platforms) -->
                    <div id="msg-generic-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key / Token</label>
                            <input type="password" id="msg-api-key" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Endpoint (if custom)</label>
                            <input type="url" id="msg-endpoint" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    
                    <!-- Common Options -->
                    <div class="border-t border-gray-700 pt-4 mt-4">
                        <p class="text-sm text-gray-400 mb-3">Options</p>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="msg-receive" class="w-4 h-4" checked>
                                <span class="text-sm">Receive messages</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="msg-send" class="w-4 h-4" checked>
                                <span class="text-sm">Send messages</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="msg-attachments" class="w-4 h-4">
                                <span class="text-sm">Support attachments</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Image Gen Config -->
                <div id="cfg-imagegen" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="img-provider" class="input-field w-full rounded-lg px-4 py-2">
                            <option value="dalle">OpenAI DALL-E</option>
                            <option value="stability">Stability AI</option>
                            <option value="replicate">Replicate</option>
                        </select>
                            
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                        <input type="password" id="img-key" class="input-field w-full rounded-lg px-4 py-2">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Default Size</label>
                            <select id="img-size" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="1024x1024">1024x1024</option>
                                <option value="1792x1024">1792x1024 (Wide)</option>
                                <option value="1024x1792">1024x1792 (Tall)</option>
                            </select>
                            
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Quality</label>
                            <select id="img-quality" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="standard">Standard</option>
                                <option value="hd">HD</option>
                            </select>
                            
                        </div>
                    </div>
                </div>

                <!-- Speech to Text Config -->
                <div id="cfg-stt" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="stt-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onSTTProviderChange()">
                            <optgroup label="Cloud Providers">
                                <option value="whisper">OpenAI Whisper</option>
                                <option value="azure">Azure Speech Services</option>
                                <option value="google">Google Speech-to-Text</option>
                                <option value="aws_transcribe">Amazon Transcribe</option>
                                <option value="oci_speech">Oracle OCI Speech</option>
                                <option value="ibm_watson">IBM Watson Speech to Text</option>
                                <option value="deepgram">Deepgram</option>
                                <option value="assemblyai">AssemblyAI</option>
                                <option value="rev">Rev AI</option>
                                <option value="speechmatics">Speechmatics</option>
                            </optgroup>
                            <optgroup label="On-Premise / Self-Hosted">
                                <option value="whisper_local">Whisper (Local/Self-hosted)</option>
                                <option value="vosk">Vosk (Offline)</option>
                                <option value="deepspeech">Mozilla DeepSpeech</option>
                                <option value="kaldi">Kaldi</option>
                                <option value="coqui">Coqui STT</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    
                    <!-- Cloud API Fields -->
                    <div id="stt-cloud-fields" class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                            <input type="password" id="stt-key" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div id="stt-region-field">
                            <label class="text-sm text-gray-400 mb-1 block">Region / Endpoint</label>
                            <input type="text" id="stt-region" class="input-field w-full rounded-lg px-4 py-2" placeholder="us-east-1 or endpoint URL">
                        </div>
                    </div>
                    
                    <!-- OCI Speech Fields -->
                    <div id="stt-oci-fields" class="hidden space-y-4">
                        <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 text-sm text-orange-300 mb-2">
                            â„¹ï¸ OCI Speech supports real-time and batch transcription with Arabic, English, and other languages.
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Compartment OCID</label>
                                <input type="text" id="stt-oci-compartment" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                <select id="stt-oci-region" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="us-ashburn-1">US East (Ashburn)</option>
                                    <option value="us-phoenix-1">US West (Phoenix)</option>
                                    <option value="eu-frankfurt-1">Germany (Frankfurt)</option>
                                    <option value="uk-london-1">UK (London)</option>
                                </select>
                            
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">OCI Config File or API Key</label>
                            <textarea id="stt-oci-config" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste OCI config or API key details"></textarea>
                        </div>
                    </div>
                    
                    <!-- Azure Speech Fields -->
                    <div id="stt-azure-fields" class="hidden space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Speech Key</label>
                                <input type="password" id="stt-azure-key" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Service Region</label>
                                <input type="text" id="stt-azure-region" class="input-field w-full rounded-lg px-4 py-2" placeholder="eastus">
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Custom Endpoint (optional)</label>
                            <input type="url" id="stt-azure-endpoint" class="input-field w-full rounded-lg px-4 py-2" placeholder="For custom speech models">
                        </div>
                    </div>
                    
                    <!-- Self-hosted Fields -->
                    <div id="stt-local-fields" class="hidden space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Server URL</label>
                                <input type="url" id="stt-local-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="http://localhost:8080">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Model</label>
                                <select id="stt-local-model" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="tiny">Tiny (Fast, Less Accurate)</option>
                                    <option value="base">Base</option>
                                    <option value="small">Small</option>
                                    <option value="medium" selected>Medium (Balanced)</option>
                                    <option value="large">Large (Most Accurate)</option>
                                    <option value="large-v3">Large V3</option>
                                </select>
                            
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Model Path (for local files)</label>
                            <input type="text" id="stt-model-path" class="input-field w-full rounded-lg px-4 py-2" placeholder="/models/whisper-medium">
                        </div>
                    </div>
                    
                    <!-- Common Options -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Default Language</label>
                            <select id="stt-lang" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="auto">Auto-detect</option>
                                <option value="en">English</option>
                                <option value="ar">Arabic</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="zh">Chinese</option>
                                <option value="ja">Japanese</option>
                                <option value="ko">Korean</option>
                                <option value="pt">Portuguese</option>
                                <option value="ru">Russian</option>
                                <option value="hi">Hindi</option>
                            </select>
                            
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Audio Format</label>
                            <select id="stt-format" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="auto">Auto-detect</option>
                                <option value="wav">WAV</option>
                                <option value="mp3">MP3</option>
                                <option value="ogg">OGG</option>
                                <option value="flac">FLAC</option>
                                <option value="webm">WebM</option>
                            </select>
                            
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="stt-realtime" class="w-4 h-4">
                            <span class="text-sm">Real-time streaming</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="stt-punctuation" class="w-4 h-4" checked>
                            <span class="text-sm">Auto punctuation</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="stt-timestamps" class="w-4 h-4">
                            <span class="text-sm">Word timestamps</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="stt-diarization" class="w-4 h-4">
                            <span class="text-sm">Speaker diarization</span>
                        </label>
                    </div>
                </div>

                <!-- Text to Speech Config -->
                <div id="cfg-tts" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="tts-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onTTSProviderChange()">
                            <optgroup label="Cloud Providers">
                                <option value="elevenlabs">ElevenLabs</option>
                                <option value="openai">OpenAI TTS</option>
                                <option value="azure">Azure Speech Services</option>
                                <option value="google">Google Cloud Text-to-Speech</option>
                                <option value="aws_polly">Amazon Polly</option>
                                <option value="oci_speech">Oracle OCI Speech</option>
                                <option value="ibm_watson">IBM Watson Text to Speech</option>
                                <option value="murf">Murf AI</option>
                                <option value="play_ht">Play.ht</option>
                                <option value="resemble">Resemble AI</option>
                                <option value="wellsaid">WellSaid Labs</option>
                            </optgroup>
                            <optgroup label="On-Premise / Self-Hosted">
                                <option value="coqui_tts">Coqui TTS</option>
                                <option value="piper">Piper TTS</option>
                                <option value="espeak">eSpeak NG</option>
                                <option value="festival">Festival</option>
                                <option value="mimic">Mycroft Mimic</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    
                    <!-- Cloud API Fields -->
                    <div id="tts-cloud-fields" class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                            <input type="password" id="tts-key" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                    </div>
                    
                    <!-- OCI TTS Fields -->
                    <div id="tts-oci-fields" class="hidden space-y-4">
                        <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 text-sm text-orange-300 mb-2">
                            â„¹ï¸ OCI Speech supports multiple voices including Arabic neural voices.
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Compartment OCID</label>
                                <input type="text" id="tts-oci-compartment" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                <select id="tts-oci-region" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="us-ashburn-1">US East (Ashburn)</option>
                                    <option value="us-phoenix-1">US West (Phoenix)</option>
                                    <option value="eu-frankfurt-1">Germany (Frankfurt)</option>
                                </select>
                            
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">OCI Config</label>
                            <textarea id="tts-oci-config" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste OCI config"></textarea>
                        </div>
                    </div>
                    
                    <!-- Self-hosted Fields -->
                    <div id="tts-local-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Server URL</label>
                            <input type="url" id="tts-local-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="http://localhost:5002">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Model Path</label>
                            <input type="text" id="tts-model-path" class="input-field w-full rounded-lg px-4 py-2" placeholder="/models/tts-model">
                        </div>
                    </div>
                    
                    <!-- Voice Selection -->
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Voice</label>
                        <select id="tts-voice" class="input-field w-full rounded-lg px-4 py-2">
                            <optgroup label="OpenAI Voices">
                                <option value="alloy">Alloy (Neutral)</option>
                                <option value="echo">Echo (Male)</option>
                                <option value="fable">Fable (British)</option>
                                <option value="onyx">Onyx (Deep Male)</option>
                                <option value="nova">Nova (Female)</option>
                                <option value="shimmer">Shimmer (Female)</option>
                            </optgroup>
                            <optgroup label="Azure Neural Voices">
                                <option value="en-US-JennyNeural">Jenny (US Female)</option>
                                <option value="en-US-GuyNeural">Guy (US Male)</option>
                                <option value="en-GB-SoniaNeural">Sonia (UK Female)</option>
                                <option value="ar-SA-ZariyahNeural">Zariyah (Arabic Female)</option>
                                <option value="ar-SA-HamedNeural">Hamed (Arabic Male)</option>
                            </optgroup>
                            <optgroup label="ElevenLabs">
                                <option value="rachel">Rachel</option>
                                <option value="drew">Drew</option>
                                <option value="clyde">Clyde</option>
                                <option value="paul">Paul</option>
                                <option value="domi">Domi</option>
                                <option value="dave">Dave</option>
                                <option value="fin">Fin</option>
                                <option value="sarah">Sarah</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    
                    <!-- TTS Options -->
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Speed</label>
                            <input type="range" id="tts-speed" min="0.5" max="2" step="0.1" value="1" class="w-full">
                            <span class="text-xs text-gray-500" id="tts-speed-val">1.0x</span>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Pitch</label>
                            <input type="range" id="tts-pitch" min="-20" max="20" step="1" value="0" class="w-full">
                            <span class="text-xs text-gray-500" id="tts-pitch-val">0</span>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Output Format</label>
                            <select id="tts-format" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="mp3">MP3</option>
                                <option value="wav">WAV</option>
                                <option value="ogg">OGG</option>
                                <option value="opus">Opus</option>
                            </select>
                            
                        </div>
                    </div>
                </div>

                <!-- Translation Config -->
                <div id="cfg-translate" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="trans-provider" class="input-field w-full rounded-lg px-4 py-2">
                            <optgroup label="Cloud Providers">
                                <option value="deepl">DeepL</option>
                                <option value="google">Google Translate</option>
                                <option value="azure">Azure Translator</option>
                                <option value="aws_translate">Amazon Translate</option>
                                <option value="oci_language">Oracle OCI Language</option>
                                <option value="ibm_watson">IBM Watson Language Translator</option>
                                <option value="yandex">Yandex Translate</option>
                                <option value="papago">Naver Papago</option>
                            </optgroup>
                            <optgroup label="Self-Hosted">
                                <option value="libretranslate">LibreTranslate</option>
                                <option value="argos">Argos Translate</option>
                                <option value="opus_mt">Opus-MT (Hugging Face)</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                        <input type="password" id="trans-key" class="input-field w-full rounded-lg px-4 py-2">
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Source Language</label>
                            <select id="trans-source" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="auto">Auto-detect</option>
                                <option value="en">English</option>
                                <option value="ar">Arabic</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="zh">Chinese</option>
                                <option value="ja">Japanese</option>
                                <option value="ko">Korean</option>
                                <option value="pt">Portuguese</option>
                                <option value="ru">Russian</option>
                            </select>
                            
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Target Language</label>
                            <select id="trans-target" class="input-field w-full rounded-lg px-4 py-2">
                                <option value="en">English</option>
                                <option value="ar">Arabic</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                                <option value="zh">Chinese</option>
                                <option value="ja">Japanese</option>
                                <option value="ko">Korean</option>
                                <option value="pt">Portuguese</option>
                                <option value="ru">Russian</option>
                            </select>
                            
                        </div>
                    </div>
                </div>

                <!-- OCR / Vision Config -->
                <div id="cfg-ocr" class="hidden space-y-4">
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Provider</label>
                        <select id="ocr-provider" class="input-field w-full rounded-lg px-4 py-2" onchange="onOCRProviderChange()">
                            <optgroup label="AI Vision (Multi-modal)">
                                <option value="gpt4v">OpenAI GPT-4 Vision</option>
                                <option value="claude_vision">Anthropic Claude Vision</option>
                                <option value="gemini_vision">Google Gemini Vision</option>
                            </optgroup>
                            <optgroup label="Cloud OCR Services">
                                <option value="azure_vision">Azure Computer Vision</option>
                                <option value="azure_doc">Azure Document Intelligence</option>
                                <option value="google_vision">Google Cloud Vision</option>
                                <option value="google_doc_ai">Google Document AI</option>
                                <option value="aws_textract">Amazon Textract</option>
                                <option value="aws_rekognition">Amazon Rekognition</option>
                                <option value="oci_vision">Oracle OCI Vision</option>
                                <option value="oci_doc">Oracle OCI Document Understanding</option>
                                <option value="ibm_watson">IBM Watson Visual Recognition</option>
                            </optgroup>
                            <optgroup label="Specialized OCR">
                                <option value="abbyy">ABBYY Cloud OCR</option>
                                <option value="nanonets">Nanonets</option>
                                <option value="docparser">Docparser</option>
                                <option value="rossum">Rossum</option>
                                <option value="veryfi">Veryfi (Receipts/Invoices)</option>
                                <option value="mindee">Mindee</option>
                            </optgroup>
                            <optgroup label="On-Premise / Self-Hosted">
                                <option value="tesseract">Tesseract OCR</option>
                                <option value="paddleocr">PaddleOCR</option>
                                <option value="easyocr">EasyOCR</option>
                                <option value="doctr">docTR</option>
                                <option value="surya">Surya OCR</option>
                            </optgroup>
                        </select>
                            
                    </div>
                    
                    <!-- Cloud API Fields -->
                    <div id="ocr-cloud-fields" class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                            <input type="password" id="ocr-key" class="input-field w-full rounded-lg px-4 py-2">
                        </div>
                        <div id="ocr-endpoint-field">
                            <label class="text-sm text-gray-400 mb-1 block">Endpoint / Region</label>
                            <input type="text" id="ocr-endpoint" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://... or region name">
                        </div>
                    </div>
                    
                    <!-- OCI Vision Fields -->
                    <div id="ocr-oci-fields" class="hidden space-y-4">
                        <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 text-sm text-orange-300 mb-2">
                            â„¹ï¸ OCI Vision supports document analysis, text detection, image classification, and object detection.
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Compartment OCID</label>
                                <input type="text" id="ocr-oci-compartment" class="input-field w-full rounded-lg px-4 py-2">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Region</label>
                                <select id="ocr-oci-region" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="us-ashburn-1">US East (Ashburn)</option>
                                    <option value="us-phoenix-1">US West (Phoenix)</option>
                                    <option value="eu-frankfurt-1">Germany (Frankfurt)</option>
                                    <option value="uk-london-1">UK (London)</option>
                                    <option value="ap-tokyo-1">Japan (Tokyo)</option>
                                </select>
                            
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">OCI Config</label>
                            <textarea id="ocr-oci-config" rows="3" class="input-field w-full rounded-lg px-4 py-2 font-mono text-xs" placeholder="Paste OCI config"></textarea>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Model (optional)</label>
                            <input type="text" id="ocr-oci-model" class="input-field w-full rounded-lg px-4 py-2" placeholder="Custom model OCID">
                        </div>
                    </div>
                    
                    <!-- Self-hosted Fields -->
                    <div id="ocr-local-fields" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Server URL (if remote)</label>
                            <input type="url" id="ocr-local-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="http://localhost:8000 (leave empty for local)">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Language(s)</label>
                                <input type="text" id="ocr-langs" class="input-field w-full rounded-lg px-4 py-2" placeholder="eng+ara (Tesseract format)">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Tessdata Path</label>
                                <input type="text" id="ocr-tessdata" class="input-field w-full rounded-lg px-4 py-2" placeholder="/usr/share/tesseract-ocr/tessdata">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Capabilities -->
                    <div>
                        <label class="text-sm text-gray-400 mb-3 block">Capabilities</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-text" class="w-4 h-4" checked>
                                <span class="text-sm">Text extraction</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-tables" class="w-4 h-4">
                                <span class="text-sm">Table extraction</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-forms" class="w-4 h-4">
                                <span class="text-sm">Form fields</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-handwriting" class="w-4 h-4">
                                <span class="text-sm">Handwriting</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-labels" class="w-4 h-4">
                                <span class="text-sm">Label detection</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-faces" class="w-4 h-4">
                                <span class="text-sm">Face detection</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-objects" class="w-4 h-4">
                                <span class="text-sm">Object detection</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-barcode" class="w-4 h-4">
                                <span class="text-sm">Barcode/QR</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="ocr-pdf" class="w-4 h-4">
                                <span class="text-sm">PDF processing</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Document Types -->
                    <div>
                        <label class="text-sm text-gray-400 mb-1 block">Specialized Document Type (optional)</label>
                        <select id="ocr-doc-type" class="input-field w-full rounded-lg px-4 py-2">
                            <option value="general">General / Any</option>
                            <option value="invoice">Invoice</option>
                            <option value="receipt">Receipt</option>
                            <option value="id_card">ID Card / Passport</option>
                            <option value="business_card">Business Card</option>
                            <option value="bank_statement">Bank Statement</option>
                            <option value="medical">Medical Document</option>
                            <option value="contract">Contract / Legal</option>
                        </select>
                            
                    </div>
                </div>

                <!-- Simple tools (no config) -->
                <div id="cfg-simple" class="hidden">
                    <div class="text-center p-8 text-gray-400">
                        <span class="text-4xl block mb-3">âœ“</span>
                        <p>This tool requires no additional configuration.</p>
                        <p class="text-sm mt-2">Click Next to continue.</p>
                    </div>
                </div>
                
                <!-- Tool Access Control Section -->
                <div id="tool-access-control" class="mt-6 rounded-xl overflow-hidden" style="background: linear-gradient(145deg, rgba(139, 92, 246, 0.08) 0%, rgba(59, 130, 246, 0.05) 100%); border: 1px solid rgba(139, 92, 246, 0.2);">
                    <div class="p-4 border-b border-purple-500/20" style="background: linear-gradient(90deg, rgba(139, 92, 246, 0.15) 0%, transparent 100%);">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);">
                                <span class="text-white">ðŸ”</span>
                            </div>
                            <div>
                                <h5 class="font-semibold text-white">Access Control</h5>
                                <p class="text-xs text-gray-400">Who can view and use this tool</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        <!-- Access Type Selection -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <!-- Owner Only -->
                            <div class="tool-access-card cursor-pointer rounded-lg p-3 border-2 border-purple-500 bg-purple-500/10" 
                                 data-access="owner_only" onclick="selectToolAccessType('owner_only')">
                                <div class="flex items-center gap-2 mb-1">
                                    <span>ðŸ‘¤</span>
                                    <span class="font-medium text-sm">Owner Only</span>
                                </div>
                                <p class="text-xs text-gray-400">Only you can access</p>
                                <div class="tool-access-check mt-2 text-purple-400 text-xs">âœ“ Selected</div>
                            </div>
                            
                            <!-- Authenticated -->
                            <div class="tool-access-card cursor-pointer rounded-lg p-3 border-2 border-gray-600 hover:border-blue-500 transition" 
                                 data-access="authenticated" onclick="selectToolAccessType('authenticated')">
                                <div class="flex items-center gap-2 mb-1">
                                    <span>ðŸ”‘</span>
                                    <span class="font-medium text-sm">Logged In</span>
                                </div>
                                <p class="text-xs text-gray-400">Any logged-in user</p>
                                <div class="tool-access-check hidden mt-2 text-blue-400 text-xs">âœ“ Selected</div>
                            </div>
                            
                            <!-- Specific Users -->
                            <div class="tool-access-card cursor-pointer rounded-lg p-3 border-2 border-gray-600 hover:border-yellow-500 transition" 
                                 data-access="specific_users" onclick="selectToolAccessType('specific_users')">
                                <div class="flex items-center gap-2 mb-1">
                                    <span>ðŸ‘¥</span>
                                    <span class="font-medium text-sm">Specific Users</span>
                                </div>
                                <p class="text-xs text-gray-400">Choose who can access</p>
                                <div class="tool-access-check hidden mt-2 text-yellow-400 text-xs">âœ“ Selected</div>
                            </div>
                            
                            <!-- Public -->
                            <div class="tool-access-card cursor-pointer rounded-lg p-3 border-2 border-gray-600 hover:border-green-500 transition" 
                                 data-access="public" onclick="selectToolAccessType('public')">
                                <div class="flex items-center gap-2 mb-1">
                                    <span>ðŸŒ</span>
                                    <span class="font-medium text-sm">Public</span>
                                </div>
                                <p class="text-xs text-gray-400">Everyone can access</p>
                                <div class="tool-access-check hidden mt-2 text-green-400 text-xs">âœ“ Selected</div>
                            </div>
                        </div>
                        
                        <!-- Specific Users/Groups Selection (shown when specific_users selected) -->
                        <div id="tool-specific-access-config" class="hidden space-y-4 pt-4 border-t border-gray-700">
                            <!-- Smart Search -->
                            <div>
                                <label class="text-sm mb-2 block" style="color: #374151; font-weight: 500;">ðŸ” Search Users & Groups</label>
                                <input type="text" id="tool-access-search" 
                                       class="w-full rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500" 
                                       style="background: #f9fafb; color: #1f2937; border: 1px solid #d1d5db;"
                                       placeholder="Type to search users or groups..."
                                       oninput="filterToolAccessSearch(this.value)"
                                       onfocus="showToolAccessResults()"
                                       autocomplete="off">
                            </div>
                            
                            <!-- Search Results Dropdown -->
                            <div id="tool-access-search-results" class="hidden rounded-xl overflow-hidden max-h-48 overflow-y-auto shadow-lg" style="background: #ffffff; border: 1px solid #d1d5db;">
                                <!-- Results will be populated dynamically -->
                            </div>
                            
                            <!-- Selected Users/Groups Chips -->
                            <div>
                                <label class="text-sm mb-2 block flex items-center gap-2" style="color: #374151; font-weight: 500;">
                                    <span>ðŸ‘¥</span> Selected Users & Groups
                                    <span id="tool-access-count" class="text-xs px-2 py-0.5 rounded-full" style="background: #7c3aed; color: white;">0</span>
                                </label>
                                <div id="tool-access-selected-chips" class="flex flex-wrap gap-2 min-h-[50px] p-3 rounded-xl" style="background: #f3f4f6; border: 1px dashed #d1d5db;">
                                    <div id="tool-no-selection-msg" class="text-sm italic" style="color: #6b7280;">Click on users or groups from search to add them</div>
                                </div>
                            </div>
                            
                            <!-- Hidden selects for form data compatibility -->
                            <select id="tool-allowed-users" class="hidden" multiple></select>
                            <select id="tool-allowed-groups" class="hidden" multiple></select>
                            
                            <!-- Granular Permissions -->
                            <div class="rounded-xl p-4" style="background: #f3f4f6; border: 1px solid #e5e7eb;">
                                <h6 class="text-sm font-medium mb-3 flex items-center gap-2" style="color: #1f2937;">
                                    <span>ðŸ”</span> Granular Permissions 
                                    <span class="text-xs font-normal" style="color: #6b7280;">(Optional)</span>
                                </h6>
                                <p class="text-xs mb-3 p-2 rounded" style="background: #e5e7eb; color: #374151;">
                                    ðŸ’¡ <strong>Tip:</strong> By default, selected users/groups can <strong>view + execute</strong>. 
                                    Use the options below to grant <strong>edit or delete</strong> permissions to specific users or entire groups.
                                </p>
                                <div id="granular-permissions-empty" class="hidden text-center py-4 text-sm" style="color: #6b7280;">
                                    No users or groups selected above. Add them first to set granular permissions.
                                </div>
                                <div id="granular-permissions-grid" class="grid md:grid-cols-3 gap-4">
                                    <!-- Can Edit -->
                                    <div>
                                        <label class="text-xs block mb-2 flex items-center gap-1" style="color: #374151; font-weight: 600;">
                                            <span>âœï¸</span> Can Edit
                                        </label>
                                        <div id="tool-can-edit-chips" class="flex flex-wrap gap-1 min-h-[36px] p-2 rounded-lg mb-2" style="background: #e5e7eb; border: 1px solid #d1d5db;">
                                        </div>
                                        <select id="tool-can-edit-users" class="w-full rounded px-2 py-1.5 text-sm" 
                                            style="background: #f3f4f6; border: 1px solid #d1d5db; color: #1f2937;"
                                            onchange="addToolPermissionChip('edit', this)">
                                            <option value="">+ Add user/group</option>
                                        </select>
                                    </div>
                                    <!-- Can Delete -->
                                    <div>
                                        <label class="text-xs block mb-2 flex items-center gap-1" style="color: #374151; font-weight: 600;">
                                            <span>ðŸ—‘ï¸</span> Can Delete
                                        </label>
                                        <div id="tool-can-delete-chips" class="flex flex-wrap gap-1 min-h-[36px] p-2 rounded-lg mb-2" style="background: #e5e7eb; border: 1px solid #d1d5db;">
                                        </div>
                                        <select id="tool-can-delete-users" class="w-full rounded px-2 py-1.5 text-sm"
                                            style="background: #f3f4f6; border: 1px solid #d1d5db; color: #1f2937;"
                                            onchange="addToolPermissionChip('delete', this)">
                                            <option value="">+ Add user/group</option>
                                        </select>
                                    </div>
                                    <!-- Can Execute -->
                                    <div>
                                        <label class="text-xs block mb-2 flex items-center gap-1" style="color: #374151; font-weight: 600;">
                                            <span>ðŸš€</span> Can Use in Agents
                                        </label>
                                        <div id="tool-can-execute-chips" class="flex flex-wrap gap-1 min-h-[36px] p-2 rounded-lg mb-2" style="background: #e5e7eb; border: 1px solid #d1d5db;">
                                        </div>
                                        <select id="tool-can-execute-users" class="w-full rounded px-2 py-1.5 text-sm"
                                            style="background: #f3f4f6; border: 1px solid #d1d5db; color: #1f2937;"
                                            onchange="addToolPermissionChip('execute', this)">
                                            <option value="">+ Add user/group</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Add Sources (for data tools) -->
            <div id="wiz-step-3" class="hidden space-y-4">
                <div class="flex items-center gap-3 p-3 rounded-lg step-header-box">
                    <span class="text-2xl">ðŸ“</span>
                    <div>
                        <h4 class="font-semibold">Add Sources</h4>
                        <p class="text-xs text-gray-400">Step 3 of 4: Add content to your knowledge base</p>
                    </div>
                </div>

                <!-- Source Tabs -->
                <div id="source-tabs" class="flex flex-wrap gap-2 border-b border-gray-700">
                    <button onclick="setSourceTab('docs')" id="tab-docs" class="px-4 py-2 text-sm border-b-2 border-purple-500 text-white">ðŸ“„ Files</button>
                    <button onclick="setSourceTab('urls')" id="tab-urls" class="px-4 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-white">ðŸŒ URLs</button>
                    <button onclick="setSourceTab('text')" id="tab-text" class="px-4 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-white">âœï¸ Text</button>
                    <button onclick="setSourceTab('table')" id="tab-table" class="px-4 py-2 text-sm border-b-2 border-transparent text-gray-400 hover:text-white">ðŸ“Š Table</button>
                </div>

                <!-- Documents Upload -->
                <div id="sources-docs" class="space-y-4">
                    <div class="drop-zone rounded-lg p-8 text-center cursor-pointer border-2 border-dashed border-gray-600 hover:border-purple-500 transition" onclick="document.getElementById('wiz-files').click()">
                        <input type="file" id="wiz-files" class="hidden" multiple onchange="handleWizFiles(event)">
                        <span class="text-4xl block mb-2">ðŸ“¤</span>
                        <p class="text-gray-400">Drop files or click to browse</p>
                        <p class="text-xs text-gray-500 mt-1">PDF, Word, Excel, PowerPoint, Text, CSV</p>
                    </div>
                    <div id="wiz-files-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>

                <!-- URL Input -->
                <div id="sources-urls" class="hidden space-y-4">
                    <div class="flex gap-2">
                        <input type="url" id="wiz-url-input" class="input-field flex-1 rounded-lg px-4 py-2" placeholder="https://example.com/page">
                        <button onclick="addWizUrl()" class="btn-primary px-4 py-2 rounded-lg">Add</button>
                    </div>
                    <div id="wiz-urls-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>

                <!-- Text Entry -->
                <div id="sources-text" class="hidden space-y-4">
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Entry Title</label>
                            <input type="text" id="wiz-text-title" class="input-field w-full rounded-lg px-4 py-2" placeholder="e.g., Company Policy, FAQ">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Content</label>
                            <textarea id="wiz-text-content" class="input-field w-full rounded-lg px-4 py-3 font-mono text-sm" rows="6" placeholder="Enter text content that the agent can search..."></textarea>
                        </div>
                        <button onclick="addWizTextEntry()" class="btn-secondary w-full py-2 rounded-lg">âž• Add Text Entry</button>
                    </div>
                    <div id="wiz-text-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>

                <!-- Table Entry -->
                <div id="sources-table" class="hidden space-y-4">
                    <div class="space-y-3">
                        <div class="flex gap-3">
                            <div class="flex-1">
                                <label class="text-sm text-gray-400 mb-1 block">Table Name</label>
                                <input type="text" id="wiz-table-name" class="input-field w-full rounded-lg px-4 py-2" placeholder="e.g., Employee Directory">
                            </div>
                            <div>
                                <label class="text-sm text-gray-400 mb-1 block">Import</label>
                                <input type="file" id="wiz-table-file" class="hidden" accept=".csv,.xlsx,.xls" onchange="importWizTableFile(event)">
                                <button onclick="document.getElementById('wiz-table-file').click()" class="btn-secondary px-4 py-2 rounded-lg h-[42px]">ðŸ“ CSV/Excel</button>
                            </div>
                        </div>
                        <div class="flex gap-4 items-center">
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400">Columns:</label>
                                <button onclick="changeWizTableCols(-1)" class="btn-secondary w-8 h-8 rounded">-</button>
                                <span id="wiz-col-count" class="w-8 text-center">3</span>
                                <button onclick="changeWizTableCols(1)" class="btn-secondary w-8 h-8 rounded">+</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400">Rows:</label>
                                <button onclick="changeWizTableRows(-1)" class="btn-secondary w-8 h-8 rounded">-</button>
                                <span id="wiz-row-count" class="w-8 text-center">2</span>
                                <button onclick="changeWizTableRows(1)" class="btn-secondary w-8 h-8 rounded">+</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto max-h-48">
                            <div id="wiz-table-editor"></div>
                        </div>
                        <button onclick="addWizTableEntry()" class="btn-secondary w-full py-2 rounded-lg">âž• Add Table</button>
                    </div>
                    <div id="wiz-table-list" class="space-y-2 max-h-32 overflow-y-auto"></div>
                </div>

                <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-3 text-sm">
                    <p class="text-blue-300">ðŸ’¡ You can skip this step and add sources later from the tool detail page.</p>
                </div>
            </div>

            <!-- Step 4: Test & Create/Update -->
            <div id="wiz-step-4" class="hidden space-y-4">
                <div class="flex items-center gap-3 p-3 rounded-lg border border-green-700 bg-green-900/20">
                    <span class="text-2xl">ðŸ§ª</span>
                    <div>
                        <h4 class="font-semibold" id="step4-title">Test & Create</h4>
                        <p class="text-xs text-gray-400" id="step4-subtitle">Verify and finish</p>
                    </div>
                </div>

                <!-- Summary -->
                <div class="card rounded-lg p-4">
                    <h5 class="font-medium mb-3">ðŸ“‹ Summary</h5>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3 text-sm">
                        <div><span class="text-gray-400">Type:</span> <span id="sum-type" class="ml-2">-</span></div>
                        <div><span class="text-gray-400">Name:</span> <span id="sum-name" class="ml-2 font-medium">-</span></div>
                        <div><span class="text-gray-400">ðŸ“„ Files:</span> <span id="sum-docs" class="ml-2">0</span></div>
                        <div><span class="text-gray-400">ðŸŒ URLs:</span> <span id="sum-urls" class="ml-2">0</span></div>
                        <div><span class="text-gray-400">âœï¸ Text:</span> <span id="sum-text" class="ml-2">0</span></div>
                        <div><span class="text-gray-400">ðŸ“Š Tables:</span> <span id="sum-tables" class="ml-2">0</span></div>
                    </div>
                </div>

                <!-- Test Section -->
                <div class="card rounded-lg p-4">
                    <h5 class="font-medium mb-3">ðŸ§ª Test Tool (Optional)</h5>
                    <p class="text-xs text-gray-400 mb-3">Verify that your configuration works correctly before saving.</p>
                    <button onclick="testWizTool()" class="btn-secondary w-full py-2 rounded-lg mb-3">â–¶ Run Test</button>
                    <div id="wiz-test-result" class="hidden p-3 rounded-lg text-sm max-h-48 overflow-y-auto"></div>
                </div>

                <div class="bg-green-900/30 border border-green-600/50 rounded-lg p-3 text-sm" id="step4-ready-msg">
                    <p class="text-green-300">âœ… Ready! Click the button below to finish.</p>
                </div>
            </div>

            <!-- Step 5: Access Control (Standalone Step) -->
            <div id="wiz-step-5" class="hidden space-y-4">
                <div class="flex items-center gap-3 p-3 rounded-lg step-header-box">
                    <span class="text-2xl">ðŸ”</span>
                    <div>
                        <h4 class="font-semibold">Access Control</h4>
                        <p class="text-xs text-gray-400">Who can view and use this tool</p>
                    </div>
                </div>
                
                <!-- Access Type Selection -->
                <div class="card rounded-lg p-4">
                    <h5 class="font-medium mb-3">ðŸ”“ Access Level</h5>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <!-- Owner Only -->
                        <div class="access-step-card cursor-pointer rounded-lg p-3 border-2 border-purple-500 bg-purple-500/10" 
                             data-access="owner_only" onclick="selectToolAccessType('owner_only')">
                            <div class="flex items-center gap-2 mb-1">
                                <span>ðŸ‘¤</span>
                                <span class="font-medium text-sm">Owner Only</span>
                            </div>
                            <p class="text-xs text-gray-400">Only you can access</p>
                            <div class="access-step-check mt-2 text-purple-400 text-xs">âœ“ Selected</div>
                        </div>
                        
                        <!-- Authenticated -->
                        <div class="access-step-card cursor-pointer rounded-lg p-3 border-2 border-gray-600 hover:border-blue-500 transition" 
                             data-access="authenticated" onclick="selectToolAccessType('authenticated')">
                            <div class="flex items-center gap-2 mb-1">
                                <span>ðŸ”‘</span>
                                <span class="font-medium text-sm">Logged In</span>
                            </div>
                            <p class="text-xs text-gray-400">Any logged-in user</p>
                            <div class="access-step-check hidden mt-2 text-blue-400 text-xs">âœ“ Selected</div>
                        </div>
                        
                        <!-- Specific Users -->
                        <div class="access-step-card cursor-pointer rounded-lg p-3 border-2 border-gray-600 hover:border-yellow-500 transition" 
                             data-access="specific_users" onclick="selectToolAccessType('specific_users')">
                            <div class="flex items-center gap-2 mb-1">
                                <span>ðŸ‘¥</span>
                                <span class="font-medium text-sm">Specific Users</span>
                            </div>
                            <p class="text-xs text-gray-400">Choose who can access</p>
                            <div class="access-step-check hidden mt-2 text-yellow-400 text-xs">âœ“ Selected</div>
                        </div>
                        
                        <!-- Public -->
                        <div class="access-step-card cursor-pointer rounded-lg p-3 border-2 border-gray-600 hover:border-green-500 transition" 
                             data-access="public" onclick="selectToolAccessType('public')">
                            <div class="flex items-center gap-2 mb-1">
                                <span>ðŸŒ</span>
                                <span class="font-medium text-sm">Public</span>
                            </div>
                            <p class="text-xs text-gray-400">Everyone can access</p>
                            <div class="access-step-check hidden mt-2 text-green-400 text-xs">âœ“ Selected</div>
                        </div>
                    </div>
                </div>
                
                <!-- Specific Users/Groups Selection (shown when specific_users selected) -->
                <div id="access-step-specific-config" class="hidden card rounded-lg p-4 space-y-4">
                    <h5 class="font-medium mb-3">ðŸ‘¥ Select Users & Groups</h5>
                    <!-- Smart Search -->
                    <div>
                        <label class="text-sm mb-2 block text-gray-400">ðŸ” Search Users & Groups</label>
                        <input type="text" id="access-step-search" 
                               class="input-field w-full rounded-lg px-4 py-3" 
                               placeholder="Type to search users or groups..."
                               oninput="filterAccessStepSearch(this.value)"
                               onfocus="showAccessStepResults()"
                               autocomplete="off">
                    </div>
                    
                    <!-- Search Results Dropdown -->
                    <div id="access-step-search-results" class="hidden rounded-lg overflow-hidden max-h-48 overflow-y-auto border border-gray-600">
                        <!-- Results will be populated dynamically -->
                    </div>
                    
                    <!-- Selected Users/Groups Chips -->
                    <div>
                        <label class="text-sm mb-2 block flex items-center gap-2 text-gray-400">
                            <span>ðŸ‘¥</span> Selected Users & Groups
                            <span id="access-step-count" class="text-xs px-2 py-0.5 rounded-full bg-purple-600 text-white">0</span>
                        </label>
                        <div id="access-step-selected-chips" class="flex flex-wrap gap-2 min-h-[50px] p-3 rounded-lg border border-dashed border-gray-600 bg-gray-800/50">
                            <div id="access-step-no-selection" class="text-sm italic text-gray-500">Click on users or groups from search to add them</div>
                        </div>
                    </div>
                    
                    <!-- Granular Permissions -->
                    <div class="rounded-lg p-4 bg-gray-800/50 border border-gray-700">
                        <h6 class="text-sm font-medium mb-3 flex items-center gap-2 text-white">
                            <span>ðŸ”</span> Granular Permissions 
                            <span class="text-xs font-normal text-gray-400">(Optional)</span>
                        </h6>
                        <p class="text-xs mb-3 p-2 rounded bg-blue-900/30 text-blue-300 border border-blue-700/50">
                            ðŸ’¡ By default, selected users/groups can <strong>view + execute</strong>. 
                            Use the options below to grant <strong>edit or delete</strong> permissions.
                        </p>
                        <div class="grid md:grid-cols-3 gap-4">
                            <!-- Can Edit -->
                            <div>
                                <label class="text-xs block mb-2 flex items-center gap-1 text-gray-300 font-medium">
                                    <span>âœï¸</span> Can Edit
                                </label>
                                <div id="access-step-edit-chips" class="flex flex-wrap gap-1 min-h-[36px] p-2 rounded-lg mb-2 bg-gray-700 border border-gray-600">
                                </div>
                                <select id="access-step-edit-select" class="input-field w-full rounded px-2 py-1.5 text-sm"
                                    onchange="addAccessStepPermChip('edit', this)">
                                    <option value="">+ Add user/group</option>
                                </select>
                            </div>
                            <!-- Can Delete -->
                            <div>
                                <label class="text-xs block mb-2 flex items-center gap-1 text-gray-300 font-medium">
                                    <span>ðŸ—‘ï¸</span> Can Delete
                                </label>
                                <div id="access-step-delete-chips" class="flex flex-wrap gap-1 min-h-[36px] p-2 rounded-lg mb-2 bg-gray-700 border border-gray-600">
                                </div>
                                <select id="access-step-delete-select" class="input-field w-full rounded px-2 py-1.5 text-sm"
                                    onchange="addAccessStepPermChip('delete', this)">
                                    <option value="">+ Add user/group</option>
                                </select>
                            </div>
                            <!-- Can Execute -->
                            <div>
                                <label class="text-xs block mb-2 flex items-center gap-1 text-gray-300 font-medium">
                                    <span>ðŸš€</span> Can Use in Agents
                                </label>
                                <div id="access-step-execute-chips" class="flex flex-wrap gap-1 min-h-[36px] p-2 rounded-lg mb-2 bg-gray-700 border border-gray-600">
                                </div>
                                <select id="access-step-execute-select" class="input-field w-full rounded px-2 py-1.5 text-sm"
                                    onchange="addAccessStepPermChip('execute', this)">
                                    <option value="">+ Add user/group</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-3 text-sm">
                    <p class="text-blue-300">ðŸ’¡ You can change access control settings anytime from the tool settings.</p>
                </div>
            </div>

            <!-- Step 6: Review & Create -->
            <div id="wiz-step-6" class="hidden space-y-4">
                <div class="flex items-center gap-3 p-3 rounded-lg border border-green-700 bg-green-900/20">
                    <span class="text-2xl">ðŸ“‹</span>
                    <div>
                        <h4 class="font-semibold" id="step6-title">Review & Create</h4>
                        <p class="text-xs text-gray-400" id="step6-subtitle">Review your configuration before creating</p>
                    </div>
                </div>

                <!-- Configuration Summary -->
                <div class="card rounded-lg p-4">
                    <h5 class="font-medium mb-4">âš™ï¸ Configuration Summary</h5>
                    <div class="space-y-3 text-sm">
                        <div class="grid grid-cols-3 gap-2 items-center">
                            <span class="text-gray-400">Type:</span>
                            <span id="review-type" class="col-span-2 font-medium">-</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 items-center">
                            <span class="text-gray-400">Name:</span>
                            <span id="review-name" class="col-span-2 font-medium">-</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 items-start">
                            <span class="text-gray-400">Description:</span>
                            <span id="review-desc" class="col-span-2 text-gray-300">-</span>
                        </div>
                        <div id="review-config-details" class="pt-2 border-t border-gray-700 space-y-2">
                            <!-- Dynamic config details based on tool type -->
                        </div>
                    </div>
                </div>

                <!-- Access Control Summary -->
                <div class="card rounded-lg p-4">
                    <h5 class="font-medium mb-4">ðŸ” Access Control Summary</h5>
                    <div class="space-y-3 text-sm">
                        <div class="grid grid-cols-3 gap-2 items-center">
                            <span class="text-gray-400">Access Level:</span>
                            <span id="review-access-type" class="col-span-2 px-2 py-1 rounded bg-purple-500/20 text-purple-300 inline-block w-fit">Owner Only</span>
                        </div>
                        <div id="review-access-users" class="hidden grid grid-cols-3 gap-2 items-start">
                            <span class="text-gray-400">Allowed Users:</span>
                            <div id="review-users-list" class="col-span-2 flex flex-wrap gap-1"></div>
                        </div>
                        <div id="review-access-groups" class="hidden grid grid-cols-3 gap-2 items-start">
                            <span class="text-gray-400">Allowed Groups:</span>
                            <div id="review-groups-list" class="col-span-2 flex flex-wrap gap-1"></div>
                        </div>
                        <!-- Granular Permissions -->
                        <div id="review-permissions-section" class="hidden pt-3 border-t border-gray-700">
                            <div class="text-gray-400 mb-2 text-xs uppercase tracking-wide">Granular Permissions</div>
                            <div class="grid md:grid-cols-3 gap-3">
                                <div id="review-perm-edit" class="hidden">
                                    <div class="text-xs text-gray-500 mb-1">âœï¸ Can Edit</div>
                                    <div id="review-edit-list" class="flex flex-wrap gap-1"></div>
                                </div>
                                <div id="review-perm-delete" class="hidden">
                                    <div class="text-xs text-gray-500 mb-1">ðŸ—‘ï¸ Can Delete</div>
                                    <div id="review-delete-list" class="flex flex-wrap gap-1"></div>
                                </div>
                                <div id="review-perm-execute" class="hidden">
                                    <div class="text-xs text-gray-500 mb-1">ðŸš€ Can Use in Agents</div>
                                    <div id="review-execute-list" class="flex flex-wrap gap-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sources Summary (for data tools) -->
                <div id="review-sources-section" class="hidden card rounded-lg p-4">
                    <h5 class="font-medium mb-4">ðŸ“ Sources Summary</h5>
                    <div class="grid grid-cols-4 gap-3 text-sm">
                        <div class="p-3 rounded bg-gray-800 text-center">
                            <div class="text-xl font-bold" id="review-files">0</div>
                            <div class="text-xs text-gray-400">ðŸ“„ Files</div>
                        </div>
                        <div class="p-3 rounded bg-gray-800 text-center">
                            <div class="text-xl font-bold" id="review-urls">0</div>
                            <div class="text-xs text-gray-400">ðŸŒ URLs</div>
                        </div>
                        <div class="p-3 rounded bg-gray-800 text-center">
                            <div class="text-xl font-bold" id="review-text">0</div>
                            <div class="text-xs text-gray-400">âœï¸ Text</div>
                        </div>
                        <div class="p-3 rounded bg-gray-800 text-center">
                            <div class="text-xl font-bold" id="review-tables">0</div>
                            <div class="text-xs text-gray-400">ðŸ“Š Tables</div>
                        </div>
                    </div>
                </div>

                <div class="bg-green-900/30 border border-green-600/50 rounded-lg p-3 text-sm">
                    <p class="text-green-300">âœ… Review complete! Click the button below to finish.</p>
                    <p class="text-xs text-gray-400 mt-2">To test an API, go back to Configuration and click "Try this API".</p>
                </div>
            </div>

        </div>

        <!-- Footer with Navigation -->
        <div id="wizard-footer" class="hidden p-4 md:p-6 border-t border-gray-800 flex justify-between shrink-0 bg-[#1e1e2e]">
            <div class="flex gap-2">
                <button onclick="cancelToolWizard()" class="px-4 py-2 rounded-lg text-red-400 hover:bg-red-500/20 transition-colors">âœ• Cancel</button>
                <button onclick="wizBack()" id="btn-back" class="btn-secondary px-6 py-2 rounded-lg">â† Back</button>
            </div>
            <div class="flex gap-2">
                <button onclick="wizSkip()" id="btn-skip" class="hidden text-gray-400 hover:text-white px-4 py-2">Skip</button>
                <button onclick="wizNext()" id="btn-next" class="btn-primary px-6 py-2 rounded-lg">Next â†’</button>
                <button onclick="wizCreate()" id="btn-create" class="hidden btn-primary px-6 py-2 rounded-lg bg-green-600 hover:bg-green-700">âœ“ Create Tool</button>
            </div>
        </div>
    </div>
</div>

    <!-- Progress Modal -->
    <div id="progress-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[60]">
        <div class="card rounded-xl w-full max-w-md mx-4 p-6">
            <h3 id="progress-title" class="text-lg font-bold mb-4">Processing...</h3>
            
            <!-- Progress Bar -->
            <div class="bg-gray-700 rounded-full h-3 mb-3 overflow-hidden">
                <div id="progress-bar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            
            <!-- Status Text -->
            <p id="progress-status" class="text-sm text-gray-300 mb-4">Starting...</p>
            
            <!-- Log Area -->
            <div id="progress-log" class="bg-gray-900 rounded-lg p-3 h-32 overflow-y-auto font-mono text-xs space-y-1"></div>
            
            <!-- Spinner -->
            <div class="flex items-center justify-center mt-4">
                <div class="animate-spin rounded-full h-6 w-6 border-2 border-purple-500 border-t-transparent"></div>
                <span class="ml-2 text-sm text-gray-400">Please wait...</span>
            </div>
        </div>
    </div>

    <!-- Data Viewer Modal -->
    <div id="data-viewer-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[70]" onclick="if(event.target===this)closeDataViewer()">
        <div class="card rounded-xl w-full max-w-5xl mx-4 max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="p-4 border-b border-gray-700 flex items-center justify-between flex-shrink-0">
                <div>
                    <h3 id="data-viewer-title" class="text-lg font-bold">ðŸ“Š Extracted Data</h3>
                    <p id="data-viewer-subtitle" class="text-sm text-gray-400"></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="copyDataContent()" class="btn-secondary px-3 py-1.5 rounded-lg text-sm">ðŸ“‹ Copy</button>
                    <button onclick="downloadDataContent()" class="btn-secondary px-3 py-1.5 rounded-lg text-sm">ðŸ’¾ Download</button>
                    <button onclick="closeDataViewer()" class="text-gray-400 hover:text-white text-xl px-2">âœ•</button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="flex gap-4 px-4 pt-3 border-b border-gray-700 flex-shrink-0">
                <button onclick="setDataTab('tables')" id="data-tab-tables" class="pb-2 px-1 border-b-2 border-purple-500 text-white text-sm">ðŸ“Š Tables</button>
                <button onclick="setDataTab('text')" id="data-tab-text" class="pb-2 px-1 border-b-2 border-transparent text-gray-400 text-sm">ðŸ“ Full Text</button>
                <button onclick="setDataTab('chunks')" id="data-tab-chunks" class="pb-2 px-1 border-b-2 border-transparent text-gray-400 text-sm">ðŸ§© Chunks</button>
            </div>
            
            <!-- Search Box -->
            <div id="data-search-box" class="hidden px-4 py-3 border-b border-gray-700 flex-shrink-0">
                <div class="flex gap-2">
                    <input type="text" id="data-search-input" class="input-field flex-1 rounded-lg px-4 py-2 text-sm" placeholder="ðŸ” Search in data... (e.g. 'file storage', 'compute', 'price')" onkeyup="if(event.key==='Enter')searchToolData()">
                    <button onclick="searchToolData()" class="btn-primary px-4 py-2 rounded-lg text-sm">Search</button>
                    <button onclick="document.getElementById('data-search-input').value='';searchToolData()" class="btn-secondary px-3 py-2 rounded-lg text-sm">Clear</button>
                </div>
            </div>
            
            <!-- Content -->
            <div id="data-viewer-content" class="flex-1 overflow-auto p-4">
                <div class="text-center text-gray-500 py-10">Loading...</div>
            </div>
            
            <!-- Footer Stats -->
            <div id="data-viewer-stats" class="p-3 border-t border-gray-700 text-xs text-gray-500 flex gap-4 flex-shrink-0">
            </div>
        </div>
    </div>

    <!-- Process Execution Modal -->
    <div id="process-execution-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[60]" onclick="if(event.target===this)closeProcessModal()">
        <div class="card rounded-xl w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col overflow-hidden" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="p-4 border-b border-gray-700 flex items-center justify-between flex-shrink-0" style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(20,184,166,0.1));">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-2xl">ðŸ”„</div>
                    <div>
                        <h3 id="process-modal-title" class="text-lg font-bold">Workflow Execution</h3>
                        <p id="process-modal-subtitle" class="text-sm" style="color: var(--text-secondary);">Submit data to run this workflow</p>
                    </div>
                </div>
                <button onclick="closeProcessModal()" class="text-gray-400 hover:text-white text-2xl px-2">âœ•</button>
            </div>
            
            <!-- How it works (short) -->
            <div class="px-6 pt-2 pb-0">
                <p class="text-xs" style="color: var(--text-muted);">
                    <strong>How it works:</strong> Fill the form â†’ Run â†’ You'll see each step by name (Processing / Waiting for Approval if needed) â†’ When <strong>Completed</strong>, the <strong>Result</strong> and summary appear below. Notifications use the same email service as password reset &amp; MFA.
                </p>
            </div>
            
            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Trigger Form Section -->
                <div id="process-trigger-form">
                    <h4 class="font-semibold mb-4 flex items-center gap-2">ðŸ“ Input Data</h4>
                    <p class="text-sm mb-4" style="color: var(--text-secondary);">Enter the data to trigger this workflow:</p>
                    
                    <!-- Dynamic Form Fields (populated by JS) -->
                    <div id="process-form-fields" class="space-y-4">
                        <!-- Example field - will be replaced dynamically -->
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Amount ($)</label>
                            <input type="number" id="pf-amount" class="input-field w-full rounded-lg px-4 py-3" placeholder="Enter amount...">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Description</label>
                            <input type="text" id="pf-description" class="input-field w-full rounded-lg px-4 py-3" placeholder="Enter description...">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Additional Notes (Optional)</label>
                            <textarea id="pf-notes" class="input-field w-full rounded-lg px-4 py-3" rows="3" placeholder="Any additional information..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="mt-6">
                        <button onclick="executeProcess()" class="w-full py-3 rounded-lg flex items-center justify-center gap-2 text-lg text-white font-medium" style="background: linear-gradient(135deg, #22c55e 0%, #14b8a6 100%);">
                            <span>â–¶ï¸</span> Run Workflow
                        </button>
                    </div>
                </div>
                
                <!-- Execution Status Section (hidden initially) -->
                <div id="process-execution-status" class="hidden">
                    <h4 class="font-semibold mb-4 flex items-center gap-2">ðŸ“Š Execution Status</h4>
                    
                    <!-- Status Badge -->
                    <div id="process-status-badge" class="mb-4 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
                        <div class="flex items-center gap-3">
                            <div class="animate-spin w-6 h-6 border-2 border-yellow-500 border-t-transparent rounded-full"></div>
                            <div>
                                <p class="font-medium text-yellow-400">Processing...</p>
                                <p class="text-sm text-gray-400">Your workflow is running</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Steps Progress -->
                    <div id="process-steps-list" class="space-y-3">
                        <!-- Steps will be populated here -->
                    </div>
                    
                    <!-- Result (when complete) â€“ business-friendly summary + optional submitted data -->
                    <div id="process-output" class="hidden mt-4 space-y-4">
                        <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
                            <p id="process-result-summary" class="font-medium text-green-400">Your request was processed successfully.</p>
                        </div>
                        <div id="process-result-body" class="hidden">
                            <h5 class="font-medium mb-2">ðŸ“‹ Result</h5>
                            <pre id="process-output-content" class="text-sm text-gray-300 whitespace-pre-wrap rounded bg-gray-800 p-3"></pre>
                        </div>
                        <div id="process-submitted-data-wrap" class="hidden">
                            <button type="button" id="process-submitted-data-toggle" class="flex items-center gap-2 text-sm text-gray-400 hover:text-white mb-2">
                                <span>â–¼</span> Submitted data
                            </button>
                            <pre id="process-submitted-data-content" class="text-sm text-gray-500 whitespace-pre-wrap rounded bg-gray-800/80 p-3 hidden"></pre>
                        </div>
                    </div>
                </div>
                
                <!-- Pending Approval Section (hidden initially) -->
                <div id="process-pending-approval" class="hidden">
                    <div class="p-4 rounded-xl border border-yellow-500/30 bg-yellow-500/5">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-xl bg-yellow-500/20 flex items-center justify-center">
                                    <span class="text-2xl">â³</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-lg">Waiting for Approval</h4>
                                    <p class="text-sm text-gray-400">Approve to continue and reach the end of the workflow.</p>
                                </div>
                            </div>
                            <button type="button" onclick="openApprovalDashboard()" class="btn-secondary px-3 py-2 rounded-lg text-sm">Open approvals</button>
                        </div>

                        <div id="process-inline-approval-details" class="mt-4 text-sm text-gray-300">
                            <div class="text-gray-500">Loading approval detailsâ€¦</div>
                        </div>

                        <div class="mt-4">
                            <label class="text-xs text-gray-500 uppercase tracking-wide mb-2 block">Comments (optional)</label>
                            <textarea id="process-inline-approval-comments" class="input-field w-full rounded-lg px-4 py-3" rows="2" placeholder="Add a note for the requesterâ€¦"></textarea>
                        </div>

                        <div class="mt-4 flex gap-3">
                            <button type="button" onclick="approveInlineApproval()" class="flex-1 py-2.5 rounded-lg bg-green-500 hover:bg-green-600 text-white font-medium transition">
                                âœ… Approve & Continue
                            </button>
                            <button type="button" onclick="rejectInlineApproval()" class="flex-1 py-2.5 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium transition">
                                âŒ Reject
                            </button>
                        </div>

                        <p id="process-inline-approval-hint" class="text-xs text-gray-500 mt-3">Tip: After approving, the workflow will automatically continue and the report will appear when it completes.</p>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="p-4 border-t border-gray-700 flex justify-between items-center flex-shrink-0">
                <button onclick="viewExecutionHistory()" class="text-sm text-gray-400 hover:text-white">ðŸ“œ View History</button>
                <button onclick="closeProcessModal()" class="btn-secondary px-4 py-2 rounded-lg">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Approval Dashboard Modal -->
    <div id="approval-dashboard-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[60]" onclick="if(event.target===this)closeApprovalDashboard()">
        <div class="card rounded-xl w-full max-w-5xl mx-4 max-h-[90vh] flex flex-col overflow-hidden" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="p-4 border-b border-gray-700 flex items-center justify-between flex-shrink-0" style="background: linear-gradient(135deg, rgba(234,179,8,0.1), rgba(249,115,22,0.1));">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-500 to-orange-500 flex items-center justify-center text-2xl">ðŸ“‹</div>
                    <div>
                        <h3 class="text-lg font-bold">Pending Approvals</h3>
                        <p id="approval-count-subtitle" class="text-sm text-gray-400">0 items waiting for your decision</p>
                    </div>
                </div>
                <button onclick="closeApprovalDashboard()" class="text-gray-400 hover:text-white text-2xl px-2">âœ•</button>
            </div>
            
            <!-- Approval List -->
            <div class="flex-1 overflow-y-auto p-4">
                <div id="approval-list" class="space-y-4">
                    <!-- Approval items will be populated here -->
                    <div class="text-center py-10 text-gray-500">
                        <span class="text-4xl mb-4 block">âœ…</span>
                        <p>No pending approvals</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Playback Modal (Business-friendly animation on process flow) -->
    <div id="process-playback-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[80]" onclick="if(event.target===this)closeProcessPlaybackModal()">
        <div class="card rounded-xl w-full max-w-6xl mx-4 max-h-[92vh] flex flex-col overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-gray-700 flex items-center justify-between flex-shrink-0" style="background: linear-gradient(135deg, rgba(99,102,241,0.10), rgba(139,92,246,0.10));">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-2xl">ðŸ§­</div>
                    <div>
                        <h3 class="text-lg font-bold">Process playback</h3>
                        <p id="process-playback-subtitle" class="text-sm text-gray-400">Showing the actual path the workflow took</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="replayProcessPlayback()" class="btn-secondary px-3 py-1.5 rounded-lg text-sm">Replay</button>
                    <button onclick="closeProcessPlaybackModal()" class="text-gray-400 hover:text-white text-2xl px-2">âœ•</button>
                </div>
            </div>
            <div class="flex-1 bg-black/30">
                <iframe id="process-playback-frame" title="Process Playback" class="w-full h-[74vh] border-0" src="about:blank"></iframe>
            </div>
        </div>
    </div>

    <!-- Process Test Report Modal (Business-friendly result summary; no raw JSON by default) -->
    <div id="process-test-report-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[85]" onclick="if(event.target===this)closeProcessTestReport()">
        <div class="card rounded-xl w-full max-w-5xl mx-4 max-h-[92vh] flex flex-col overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-gray-700 flex items-center justify-between flex-shrink-0" style="background: linear-gradient(135deg, rgba(34,197,94,0.08), rgba(20,184,166,0.08));">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-2xl">ðŸ“‹</div>
                    <div>
                        <h3 id="process-test-report-title" class="text-lg font-bold">Test report</h3>
                        <p id="process-test-report-subtitle" class="text-sm text-gray-400">Summary of what happened in this run</p>
                    </div>
                </div>
                <button onclick="closeProcessTestReport()" class="text-gray-400 hover:text-white text-2xl px-2">âœ•</button>
            </div>
            <div id="process-test-report-body" class="flex-1 overflow-y-auto p-5">
                <div class="text-center text-gray-500 py-10">Loadingâ€¦</div>
            </div>
        </div>
    </div>

    <script>
        const API='';
        
        // Debug logging: ON so you can see navigate/modal logs. Set to false to silence.
        const DEBUG_MODE = true;
        const _originalLog = console.log;
        const _originalWarn = console.warn;
        if (!DEBUG_MODE) {
            console.log = function() {};
            console.warn = function() {};
        } else {
            _originalLog('ðŸ”§ [AgentForge] Debug logs ON');
        }
        // This always shows (never silenced) so you know the app script loaded
        console.info('[AgentForge] App script loaded. DEBUG_MODE=' + DEBUG_MODE);
        
        // Utility function - define early
        function escHtml(text) {
            if(text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        let step=0,wizard={name:'',icon:'',goal:'',originalGoal:'',personality:null,tasks:[],tool_ids:[],suggestedTools:[],guardrails:{},model:'',modelReason:'',editId:null,deployTarget:'cloud',cloudProvider:''},allTools=[],toolType=null,uploadedFiles=[],agentTab='published',conv=null,testAgent=null,apiStep=1,apiParams=[],configMode='manual',chatAttachments=[],testAttachments=[];
        
        // Track current page to prevent duplicate navigation from hashchange
        let _currentPage = '';

        // Ensure modal is direct child of body so it's visible when opened from any page
        function ensureModalInBody(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return false;
            if (modal.parentElement !== document.body) document.body.appendChild(modal);
            return true;
        }

        function navigate(p, updateHash = true){
            // DEBUG: Log only create navigation
            if (p === 'create') {
                console.log('ðŸŽ¯ [CREATE] navigate("create") called', { from: _currentPage, stack: new Error().stack?.split('\n').slice(1, 4).join(' <- ') });
            }
            
            // Track current page
            _currentPage = p;
            
            // Hide all sections
            document.querySelectorAll('main>section').forEach(s => s.classList.add('hidden'));
            
            // Show target page
            const targetPage = document.getElementById('page-'+p);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                // DEBUG: Check create page visibility
                if (p === 'create') {
                    console.log('ðŸŽ¯ [CREATE] page-create shown', { 
                        display: window.getComputedStyle(targetPage).display,
                        step0Visible: !document.getElementById('wizard-step-0')?.classList.contains('hidden'),
                        goalInputExists: !!document.getElementById('w-initial-goal')
                    });
                }
            }
            
            // Update nav
            document.querySelectorAll('.sidebar-item').forEach(b=>b.classList.remove('active'));
            document.getElementById('nav-'+p)?.classList.add('active');
            document.querySelectorAll('.mobile-nav button').forEach(b=>b.classList.remove('active'));
            document.getElementById('mob-'+p)?.classList.add('active');
            
            // Update URL hash
            if (updateHash) window.location.hash = p;
            
            // Page-specific initialization
            if(p==='agents')loadAgents();
            if(p==='tools')loadTools();
            if(p==='chat') { if (!window._skipChatAgentLoad) loadChatAgents(); window._skipChatAgentLoad = false; }
            if(p==='create'){
                console.log('ðŸŽ¯ [CREATE] Calling resetWizardNew()...');
                try {
                    resetWizardNew();
                    step=0;
                    updateStepsNew();
                    console.log('ðŸŽ¯ [CREATE] resetWizardNew() completed successfully');
                } catch(e) {
                    console.error('ðŸŽ¯ [CREATE] ERROR in resetWizardNew():', e);
                }
            }
            if(p==='settings'){ loadSettings(); updateThemeButtons(localStorage.getItem('agentforge-theme') || 'dark'); }
            if(p==='profile') loadProfileInfo();
            if(p==='demo')initDemoLab();
        }
        
        // Handle browser back/forward buttons
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.slice(1); // Remove the '#'
            // Only navigate if hash changed and page exists
            // Skip if we're already on this page (prevents duplicate loading)
            if (hash && hash !== _currentPage && document.getElementById('page-' + hash)) {
                navigate(hash, false);
            }
        });
        
        // ============================================================================
        // PERSONALITY SLIDER FUNCTIONS
        // ============================================================================
        
        // Store API-provided personality descriptions (100% dynamic from LLM)
        let apiPersonalityDescriptions = {};
        
        // Update a personality slider - descriptions come from API only
        function updatePersonalitySlider(trait, value) {
            value = Math.min(10, Math.max(1, parseInt(value) || 5));
            
            // Update number input
            const numInput = document.getElementById(`p-${trait}-num`);
            const slider = document.getElementById(`p-${trait}`);
            if (numInput) numInput.value = value;
            if (slider) slider.value = value;
            
            // Update wizard personality
            if (!wizard.personality) wizard.personality = {};
            wizard.personality[trait] = value;
            
            // Update description - ONLY use API description (no fallback)
            const descEl = document.getElementById(`p-${trait}-desc`);
            if (descEl) {
                const apiDesc = apiPersonalityDescriptions[trait + 'Desc'];
                if (apiDesc) {
                    descEl.textContent = apiDesc;
                }
                // If no API description, leave as is (will be updated on next API call)
            }
            
            // Update overall preview
            updatePersonalityPreview();
        }
        
        // Sync slider from number input
        function syncSlider(trait, value) {
            value = Math.min(10, Math.max(1, parseInt(value) || 5));
            document.getElementById(`p-${trait}`).value = value;
            updatePersonalitySlider(trait, value);
        }
        
        // Update the personality preview text - uses API-provided reason
        function updatePersonalityPreview() {
            const previewEl = document.getElementById('personality-preview-text');
            if (!previewEl) return;
            
            // If we have an API-provided personality reason, use it
            if (wizard.personalityReason) {
                previewEl.textContent = wizard.personalityReason;
                return;
            }
            
            // Otherwise show a simple dynamic message
            const name = wizard.name || 'Your agent';
            previewEl.textContent = `${name}'s personality is configured above. Generate from a goal to get AI recommendations.`;
        }
        
        // Reset personality - just clears values, user must regenerate
        function resetPersonalityDefaults() {
            const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
            traits.forEach(trait => {
                const slider = document.getElementById(`p-${trait}`);
                const numInput = document.getElementById(`p-${trait}-num`);
                const descEl = document.getElementById(`p-${trait}-desc`);
                if (slider) slider.value = 5;
                if (numInput) numInput.value = 5;
                if (descEl) descEl.textContent = 'Generate from goal to get AI recommendation';
            });
            wizard.personality = null;
            wizard.personalityReason = null;
            apiPersonalityDescriptions = {};
            updatePersonalityPreview();
        }
        
        // Initialize personality sliders from wizard state
        function initPersonalitySliders() {
            if (!wizard.personality) return;
            
            const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
            traits.forEach(trait => {
                const val = wizard.personality[trait];
                if (val !== undefined) {
                    const slider = document.getElementById(`p-${trait}`);
                    const numInput = document.getElementById(`p-${trait}-num`);
                    if (slider) slider.value = val;
                    if (numInput) numInput.value = val;
                }
            });
            
            updatePersonalityPreview();
        }
        
        // Update all personality descriptions when agent name changes
        function updateAgentNameInPersonality() {
            wizard.name = document.getElementById('w-name')?.value || '';
            const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
            traits.forEach(trait => {
                const slider = document.getElementById(`p-${trait}`);
                if (slider) {
                    updatePersonalitySlider(trait, slider.value);
                }
            });
            updatePersonalityPreview();
        }
        
        // ============================================================================
        // GOAL CHANGE - REAL-TIME RECOMMENDATIONS
        // ============================================================================
        
        let goalDebounceTimer = null;
        let lastGoalText = '';
        
        // Called when goal text changes
        function onGoalChange() {
            const goal = document.getElementById('w-goal')?.value?.trim() || '';
            
            // Don't update if goal is too short or hasn't changed significantly
            if (goal.length < 20 || goal === lastGoalText) {
                return;
            }
            
            // Clear previous timer
            if (goalDebounceTimer) {
                clearTimeout(goalDebounceTimer);
            }
            
            // Show hint that we're waiting
            const hint = document.getElementById('goal-hint');
            if (hint) {
                hint.textContent = 'Keep typing... recommendations will update automatically';
                hint.className = 'text-[10px] text-purple-400 mt-1';
            }
            
            // Debounce: wait 1.5 seconds after user stops typing
            goalDebounceTimer = setTimeout(() => {
                lastGoalText = goal;
                updateRecommendationsFromGoal(goal);
            }, 1500);
        }
        
        // Fetch new recommendations from API based on goal
        async function updateRecommendationsFromGoal(goal) {
            const indicator = document.getElementById('goal-update-indicator');
            const hint = document.getElementById('goal-hint');
            
            // Show loading indicator
            if (indicator) indicator.classList.remove('hidden');
            if (hint) {
                hint.textContent = 'AI is analyzing your goal...';
                hint.className = 'text-[10px] text-purple-400 mt-1';
            }
            
            try {
                const response = await fetch(API + '/api/agents/generate-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        goal: goal,
                        update_mode: true  // Flag to indicate this is an update, not initial creation
                    })
                });
                
                if (!response.ok) throw new Error('Failed to get recommendations');
                
                const config = await response.json();
                
                // Apply recommendations with animation
                applyRecommendationsWithAnimation(config);
                
                // Show success
                if (hint) {
                    hint.textContent = 'âœ¨ Recommendations updated based on your goal';
                    hint.className = 'text-[10px] text-green-400 mt-1';
                    
                    // Reset hint after 3 seconds
                    setTimeout(() => {
                        hint.textContent = 'Edit your goal anytime - recommendations will update automatically';
                        hint.className = 'text-[10px] text-gray-500 mt-1';
                    }, 3000);
                }
                
                // Show toast
                showToast('âœ¨ AI recommendations updated!', 'success');
                
            } catch (error) {
                console.error('Error updating recommendations:', error);
                if (hint) {
                    hint.textContent = 'Could not update recommendations. Try again.';
                    hint.className = 'text-[10px] text-red-400 mt-1';
                }
            } finally {
                // Hide loading indicator
                if (indicator) indicator.classList.add('hidden');
            }
        }
        
        // Apply recommendations with smooth animation
        function applyRecommendationsWithAnimation(config) {
            // 1. Update Model with animation
            if (config.model) {
                wizard.model = config.model;
                wizard.modelReason = config.modelReason;  // Store the reason
                
                const modelContainer = document.getElementById('llm-models-list');
                if (modelContainer) {
                    modelContainer.classList.add('animate-pulse');
                    setTimeout(() => {
                        loadLLMModels();  // This will highlight the new recommended model
                        modelContainer.classList.remove('animate-pulse');
                    }, 300);
                }
                
                // Update model reason
                const modelWhyEl = document.getElementById('model-why-text');
                if (modelWhyEl && config.modelReason) {
                    modelWhyEl.textContent = config.modelReason;
                }
            }
            
            // 2. Store personality descriptions from API
            if (config.personalityDescriptions) {
                apiPersonalityDescriptions = config.personalityDescriptions;
            }
            
            // 3. Update Personality sliders with animation
            if (config.personality) {
                const slidersContainer = document.getElementById('personality-sliders');
                if (slidersContainer) {
                    slidersContainer.classList.add('animate-pulse');
                }
                
                // Update personality reason
                if (config.personalityReason) {
                    const previewEl = document.getElementById('personality-preview-text');
                    if (previewEl) {
                        previewEl.textContent = config.personalityReason;
                    }
                }
                
                setTimeout(() => {
                    // Apply each personality value
                    const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
                    traits.forEach((trait, index) => {
                        const value = config.personality[trait];
                        if (value !== undefined) {
                            // Animate slider update with slight delay for each
                            setTimeout(() => {
                                animateSliderTo(trait, value);
                                
                                // Update description from API
                                const desc = apiPersonalityDescriptions[trait + 'Desc'];
                                const descEl = document.getElementById(`p-${trait}-desc`);
                                if (desc && descEl) {
                                    descEl.textContent = desc;
                                }
                            }, index * 100);
                        }
                    });
                    
                    if (slidersContainer) {
                        slidersContainer.classList.remove('animate-pulse');
                    }
                }, 300);
                
                // Update wizard personality
                wizard.personality = { ...wizard.personality, ...config.personality };
            }
            
            // 3. Update Agent Name if provided
            if (config.name && !wizard.name) {
                const nameEl = document.getElementById('w-name');
                if (nameEl && !nameEl.value) {
                    nameEl.value = config.name;
                    wizard.name = config.name;
                }
            }
            
            // 4. Store suggested tasks for later
            if (config.tasks) {
                wizard.tasks = config.tasks;
            }
            
            // 5. Store guardrails recommendations
            if (config.guardrails) {
                wizard.guardrails = { ...wizard.guardrails, ...config.guardrails };
            }
            
            // 6. Store suggested tools
            if (config.suggestedTools) {
                wizard.suggestedTools = config.suggestedTools;
            }
            
            // Update preview text
            updatePersonalityPreview();
        }
        
        // Animate slider from current value to target value
        function animateSliderTo(trait, targetValue) {
            const slider = document.getElementById(`p-${trait}`);
            const numInput = document.getElementById(`p-${trait}-num`);
            
            if (!slider) return;
            
            const currentValue = parseInt(slider.value) || 5;
            const steps = Math.abs(targetValue - currentValue);
            const direction = targetValue > currentValue ? 1 : -1;
            
            if (steps === 0) return;
            
            let currentStep = 0;
            const interval = setInterval(() => {
                currentStep++;
                const newValue = currentValue + (direction * currentStep);
                
                slider.value = newValue;
                if (numInput) numInput.value = newValue;
                
                // Update description
                updatePersonalitySlider(trait, newValue);
                
                if (currentStep >= steps) {
                    clearInterval(interval);
                }
            }, 50);
        }
        
        // ============================================================================
        // NEW AI-POWERED WIZARD FUNCTIONS
        // ============================================================================
        
        function resetWizardNew() {
            step = 0;
            wizard = {
                name: '',
                icon: '',
                goal: '',
                originalGoal: '',
                personality: null,
                personalityReason: '',
                tasks: [],
                tool_ids: [],
                suggestedTools: [],
                guardrails: {},
                model: '',
                modelReason: '',
                editId: null,
                deployTarget: 'cloud',
                cloudProvider: '',
                accessControl: null,  // Will be set when user visits Access Control step
                userPermissions: { is_owner: true, permissions: ['full_admin'] }  // New agent = user is owner
            };
            
            // Clear API descriptions
            apiPersonalityDescriptions = {};
            lastGoalText = '';
            
            // Reset UI
            document.getElementById('wizard-step-0')?.classList.remove('hidden');
            document.getElementById('wizard-generating')?.classList.add('hidden');
            document.getElementById('wizard-progress')?.classList.add('hidden');
            for(let i=1; i<=8; i++) {
                document.getElementById('wizard-step-'+i)?.classList.add('hidden');
            }
            
            // Check if step-0 content was replaced (e.g., by showProcessEditor)
            // If so, restore the original content
            const goalInput = document.getElementById('w-initial-goal');
            if (!goalInput) {
                // Content was replaced, need to restore wizard-step-0
                restoreWizardStep0();
            } else {
                goalInput.value = '';
            }
            
            // Reset agent type selection to default
            selectedAgentType = 'conversational';
            const convCard = document.getElementById('type-card-conversational');
            const procCard = document.getElementById('type-card-process');
            const convSection = document.getElementById('section-conversational');
            const procSection = document.getElementById('section-process');
            
            if (convCard && procCard && convSection && procSection) {
                convCard.classList.add('border-purple-500');
                convCard.classList.remove('border-transparent');
                procCard.classList.remove('border-green-500');
                procCard.classList.add('border-transparent');
                convSection.classList.remove('hidden');
                procSection.classList.add('hidden');
                convCard.querySelector('.text-sm:last-child').textContent = 'âœ“ Selected';
                convCard.querySelector('.text-sm:last-child').className = 'text-sm text-purple-400 font-medium';
                procCard.querySelector('.text-sm:last-child').textContent = 'Click to select';
                procCard.querySelector('.text-sm:last-child').className = 'text-sm text-gray-500';
            }
        }
        
        // Restore wizard step 0 original content if it was replaced
        function restoreWizardStep0() {
            const step0 = document.getElementById('wizard-step-0');
            if (!step0) return;
            
            step0.innerHTML = `
                <div class="text-center mb-8">
                    <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center mb-4">
                        <img src="/AgentForge_Logo.png" alt="" class="w-12 h-12">
                    </div>
                    <h2 class="text-2xl md:text-3xl font-bold mb-2">What would you like to create?</h2>
                    <p class="text-gray-400">Choose the type of AI solution for your needs</p>
                </div>
                
                <!-- Agent Type Selection Cards -->
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <!-- Conversational AI Card -->
                    <div id="type-card-conversational" onclick="selectAgentType('conversational')" 
                         class="card rounded-xl p-5 cursor-pointer border-2 border-purple-500 hover:border-purple-400 transition-all">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-2xl">ðŸ’¬</div>
                            <div>
                                <h3 class="font-bold">Conversational AI</h3>
                                <p class="text-xs text-gray-400">Chat & assist users</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-300 mb-3">An AI assistant that chats with users and helps with tasks through conversation.</p>
                        <div class="flex flex-wrap gap-1 mb-2">
                            <span class="px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300 text-xs">Chat</span>
                            <span class="px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300 text-xs">Q&A</span>
                            <span class="px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-300 text-xs">Support</span>
                        </div>
                        <div class="text-sm text-purple-400 font-medium">âœ“ Selected</div>
                    </div>
                    
                    <!-- Workflow Automation Card -->
                    <div id="type-card-process" onclick="selectAgentType('process')" 
                         class="card rounded-xl p-5 cursor-pointer border-2 border-transparent hover:border-green-500 transition-all">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-2xl">ðŸ”„</div>
                            <div>
                                <h3 class="font-bold">Workflow Automation</h3>
                                <p class="text-xs text-gray-400">Automate processes</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-300 mb-3">Automated workflows with approvals, integrations, and step-by-step processes.</p>
                        <div class="flex flex-wrap gap-1 mb-2">
                            <span class="px-2 py-0.5 rounded-full bg-green-500/20 text-green-300 text-xs">Approvals</span>
                            <span class="px-2 py-0.5 rounded-full bg-green-500/20 text-green-300 text-xs">Integrations</span>
                            <span class="px-2 py-0.5 rounded-full bg-green-500/20 text-green-300 text-xs">Automation</span>
                        </div>
                        <div class="text-sm text-gray-500">Click to select</div>
                    </div>
                </div>
                
                <!-- Conversational AI Section -->
                <div id="section-conversational" class="card rounded-xl p-6 md:p-8">
                    <label class="text-sm text-gray-400 mb-2 block">What should your assistant do? *</label>
                    <textarea id="w-initial-goal" rows="4" class="input-field w-full rounded-lg px-4 py-4 text-lg" placeholder="Example: Help customers track their orders, answer product questions, and process returns..."></textarea>
                    
                    <div class="mt-6 flex flex-col sm:flex-row gap-3">
                        <button onclick="generateAgentConfig()" id="btn-generate-config" class="btn-primary px-8 py-3 rounded-lg flex-1 flex items-center justify-center gap-2 text-lg">
                            <span>âœ¨</span> Create My Assistant
                        </button>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-gray-700">
                        <p class="text-sm text-gray-500 mb-3">Or start with a template:</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="useAgentTemplate('customer_support')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition">ðŸŽ§ Customer Support</button>
                            <button onclick="useAgentTemplate('sales')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition">ðŸ’¼ Sales Assistant</button>
                            <button onclick="useAgentTemplate('hr')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition">ðŸ‘¥ HR Helper</button>
                            <button onclick="useAgentTemplate('research')" class="px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm transition">ðŸ”¬ Research Analyst</button>
                        </div>
                    </div>
                </div>
                
                <!-- Workflow Automation Section (Hidden by default) -->
                <div id="section-process" class="hidden card rounded-xl p-6 md:p-8" style="background: linear-gradient(135deg, rgba(34,197,94,0.05), rgba(20,184,166,0.05)); border: 1px solid rgba(34,197,94,0.2);">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-3xl mb-4">ðŸ”„</div>
                        <h3 class="text-xl font-bold mb-2">Visual Workflow Builder</h3>
                        <p class="text-gray-400">Design powerful automations with drag & drop</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <!-- Option 1: Visual Builder -->
                        <div onclick="openVisualBuilder()" class="p-5 rounded-xl bg-gradient-to-br from-green-500/10 to-teal-500/10 border border-green-500/30 cursor-pointer hover:border-green-400 transition-all group">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-lg bg-green-500 flex items-center justify-center text-xl">ðŸŽ¨</div>
                                <div class="font-semibold">Visual Builder</div>
                                <span class="ml-auto text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400">Recommended</span>
                            </div>
                            <p class="text-sm text-gray-400 mb-3">Drag & drop nodes, connect steps visually, configure with forms - no coding required.</p>
                            <div class="flex items-center gap-2 text-green-400 text-sm group-hover:translate-x-1 transition-transform">
                                <span>Open Builder</span>
                                <span>â†’</span>
                            </div>
                        </div>
                        
                        <!-- Option 2: AI Generate -->
                        <div onclick="showAIWorkflowInput()" class="p-5 rounded-xl bg-gray-800/50 border border-gray-700 cursor-pointer hover:border-purple-500 transition-all group">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-lg bg-purple-500 flex items-center justify-center text-xl">ðŸ¤–</div>
                                <div class="font-semibold">AI Generate</div>
                            </div>
                            <p class="text-sm text-gray-400 mb-3">Describe what you need in plain English, AI creates the workflow for you.</p>
                            <div class="flex items-center gap-2 text-purple-400 text-sm group-hover:translate-x-1 transition-transform">
                                <span>Generate with AI</span>
                                <span>â†’</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Input (Hidden by default) -->
                    <div id="ai-workflow-input" class="hidden">
                        <label class="text-sm text-gray-400 mb-2 block">Describe your workflow *</label>
                        <textarea id="w-process-goal" rows="3" class="input-field w-full rounded-lg px-4 py-3" placeholder="When an expense over $500 is submitted, send to manager for approval..."></textarea>
                        <div class="mt-4 flex gap-3">
                            <button onclick="generateProcessConfig()" class="flex-1 px-6 py-3 rounded-lg text-white font-medium flex items-center justify-center gap-2" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);">
                                <span>âœ¨</span> Generate Workflow
                            </button>
                            <button onclick="hideAIWorkflowInput()" class="px-4 py-3 rounded-lg bg-gray-700 text-gray-300">Cancel</button>
                        </div>
                    </div>
                    
                    <!-- Quick Templates -->
                    <div id="workflow-templates" class="mt-4 pt-4 border-t border-gray-700/50">
                        <p class="text-sm text-gray-500 mb-3">Quick start templates:</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <button onclick="openBuilderWithTemplate('approval')" class="p-3 rounded-lg bg-gray-800/50 hover:bg-gray-700 text-left transition">
                                <span class="text-lg">âœ…</span>
                                <div class="text-sm font-medium mt-1">Approval</div>
                            </button>
                            <button onclick="openBuilderWithTemplate('onboarding')" class="p-3 rounded-lg bg-gray-800/50 hover:bg-gray-700 text-left transition">
                                <span class="text-lg">ðŸ‘‹</span>
                                <div class="text-sm font-medium mt-1">Onboarding</div>
                            </button>
                            <button onclick="openBuilderWithTemplate('notification')" class="p-3 rounded-lg bg-gray-800/50 hover:bg-gray-700 text-left transition">
                                <span class="text-lg">ðŸ””</span>
                                <div class="text-sm font-medium mt-1">Notifications</div>
                            </button>
                            <button onclick="openBuilderWithTemplate('integration')" class="p-3 rounded-lg bg-gray-800/50 hover:bg-gray-700 text-left transition">
                                <span class="text-lg">ðŸ”—</span>
                                <div class="text-sm font-medium mt-1">Integration</div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function updateStepsNew() {
            console.log('=== updateStepsNew called, step:', step);
            
            // Show/hide step 0 vs other steps
            if(step === 0) {
                document.getElementById('wizard-step-0')?.classList.remove('hidden');
                document.getElementById('wizard-generating')?.classList.add('hidden');
                document.getElementById('wizard-progress')?.classList.add('hidden');
                document.getElementById('wizard-sticky-header')?.classList.add('hidden');
                for(let i=1; i<=8; i++) {
                    document.getElementById('wizard-step-'+i)?.classList.add('hidden');
                }
                return;
            }
            
            // Show progress bar and sticky header for steps 1+
            document.getElementById('wizard-step-0')?.classList.add('hidden');
            document.getElementById('wizard-generating')?.classList.add('hidden');
            // Keep old progress bar hidden - we use sticky header now
            document.getElementById('wizard-progress')?.classList.add('hidden');
            document.getElementById('wizard-sticky-header')?.classList.remove('hidden');
            
            // Update NEW sticky header
            updateWizardStickyHeader();
            
            // Update step indicators (old system)
            for(let i=1; i<=8; i++) {
                const el = document.getElementById('step-'+i);
                const content = document.getElementById('wizard-step-'+i);
                if(el) {
                    el.className = 'w-6 h-6 md:w-8 md:h-8 rounded-full flex items-center justify-center cursor-pointer text-xs md:text-sm ' + 
                        (i < step ? 'step-done' : i === step ? 'step-active' : 'step-pending');
                }
                if(content) {
                    content.classList.toggle('hidden', i !== step);
                    console.log('Step', i, 'visibility:', i === step ? 'visible' : 'hidden');
                }
            }
            
            // Load step-specific content
            console.log('Loading content for step:', step);
            if(step === 1) {
                console.log('Loading LLM models');
                loadLLMModels();
                initPersonalitySliders();
            }
            if(step === 3) {
                console.log('Loading Demo Kit Tools for selection');
                loadDemoKitToolsForSelection();
            }
            if(step === 4) {
                console.log('ðŸŸ¢ðŸŸ¢ðŸŸ¢ STEP 4: ACCESS CONTROL LOADING ðŸŸ¢ðŸŸ¢ðŸŸ¢');
                console.log('ðŸŸ¢ wizard.accessControl BEFORE load:', JSON.stringify(wizard.accessControl, null, 2));
                // Collect tasks from previous step to ensure they're available
                collectTasksNew();
                console.log('ðŸŸ¢ Tasks collected, now loading wizard access control...');
                // âœ… IMPORTANT: Load saved access control data FIRST
                await loadWizardAccessControl();
                console.log('ðŸŸ¢ loadWizardAccessControl completed');
                console.log('ðŸŸ¢ wizardAccessState.selectedEntities:', JSON.stringify(wizardAccessState.selectedEntities, null, 2));
                console.log('ðŸŸ¢ wizardAccessState.taskPermissions:', JSON.stringify(wizardAccessState.taskPermissions, null, 2));
                // Sync task permissions
                syncTaskPermissions();
                // Update access control UI
                updateWizardAccessUI();
                // Initialize access control (async - will check ownership)
                initWizardAccessControl();
                console.log('ðŸŸ¢ðŸŸ¢ðŸŸ¢ STEP 4 LOADING COMPLETE ðŸŸ¢ðŸŸ¢ðŸŸ¢');
            }
            if(step === 5) {
                console.log('Loading Guardrails');
                // Load guardrails values from wizard object if editing
                loadGuardrailsToForm();
            }
            if(step === 6) {
                console.log('Calling showPreviewNew');
                // Ensure tools are collected before preview
                collectToolsNew();
                // Reload access control to ensure task IDs match current tasks
                await loadWizardAccessControl();
                showPreviewNew();
            }
            if(step === 7) {
                console.log('Calling prepareTestSuggestions');
                prepareTestSuggestions();
                // Reset test conversation when entering test step
                resetTestConversation();
            }
            
            // âš ï¸ CRITICAL: Re-apply permission restrictions after step content is rendered
            // This ensures restrictions work on dynamically loaded elements
            console.log('ðŸ”ðŸ”ðŸ” STEP CHANGE CHECK ðŸ”ðŸ”ðŸ”');
            console.log('ðŸ” step:', step);
            console.log('ðŸ” wizard.editId:', wizard.editId);
            console.log('ðŸ” wizard.userPermissions:', wizard.userPermissions);
            console.log('ðŸ” wizard.id:', wizard.id);
            
            // Apply restrictions for delegated admins who are editing
            const isEditing = wizard.editId || wizard.id;
            const hasPerms = wizard.userPermissions;
            
            if (hasPerms && isEditing) {
                console.log('ðŸ”âœ… Will apply permission restrictions for step', step);
                // Small delay to ensure DOM is updated
                setTimeout(() => {
                    applyPermissionRestrictions(wizard.userPermissions);
                }, 100);
            } else {
                console.log('ðŸ”âŒ NOT applying restrictions - editId/id:', isEditing, 'perms:', !!hasPerms);
            }
        }
        
        // Reset test conversation
        async function resetTestConversation() {
            const messagesDiv = document.getElementById('test-messages');
            messagesDiv.innerHTML = '';
            
            // Only reset conversation, keep agent ID to prevent duplicates
            if(testAgent) {
                testAgent.convId = null; // Reset conversation but keep agent
            }
            testAttachments = [];
            renderTestAttachments();
            console.log('Test conversation reset (agent preserved)');
            
            // Show personalized welcome message
            const userName = currentUser?.first_name || currentUser?.display_name || 
                           currentUser?.email?.split('@')[0]?.replace('.', ' ') || 'there';
            const agentName = wizard.name || 'your agent';
            
            const welcomeHtml = `
                <div class="animate-fade-in">
                    <div class="text-center py-4">
                        <div class="text-4xl mb-2">ðŸ‘‹</div>
                        <h3 class="text-lg font-semibold text-white">Hi ${userName}!</h3>
                        <p class="text-sm text-gray-400 mt-1">I'm ${agentName}. Try asking me something!</p>
                        ${wizard.tasks && wizard.tasks.length > 0 ? `
                            <div class="mt-3 text-xs text-gray-500">
                                <p>Available tasks: ${wizard.tasks.map(t => t.name).slice(0, 3).join(', ')}${wizard.tasks.length > 3 ? '...' : ''}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            messagesDiv.innerHTML = welcomeHtml;
        }
        
        function goStep(s) {
            // In edit mode, allow jumping to any step
            // In create mode, only allow going back to previous steps
            const isEditing = wizard.editId || wizard.id;
            
            if (s >= 1 && s <= 7) {
                if (isEditing || s <= step) {
                    step = s;
                    updateStepsNew();
                }
            }
        }
        
        async function nextStep() {
            // Validate and collect data based on current step
            if(step === 1) {
                wizard.name = document.getElementById('w-name').value;
                wizard.icon = document.getElementById('w-icon').value || 'ðŸ¤–';
                wizard.iconType = document.getElementById('w-icon-type')?.value || 'emoji';
                wizard.iconData = document.getElementById('w-icon-data')?.value || '';
                wizard.goal = document.getElementById('w-goal').value;
                
                // Collect personality slider values (must be set by AI generation)
                const creativity = parseInt(document.getElementById('p-creativity')?.value);
                const length = parseInt(document.getElementById('p-length')?.value);
                const formality = parseInt(document.getElementById('p-formality')?.value);
                const empathy = parseInt(document.getElementById('p-empathy')?.value);
                const proactivity = parseInt(document.getElementById('p-proactivity')?.value);
                const confidence = parseInt(document.getElementById('p-confidence')?.value);
                
                // Check if personality was configured
                if (!creativity || !length || !formality || !empathy || !proactivity || !confidence) {
                    alert('Personality not configured. Please generate agent configuration first.');
                    return;
                }
                
                wizard.personality = { creativity, length, formality, empathy, proactivity, confidence };
                
                if(!wizard.name || !wizard.goal) {
                    alert('Please fill in Name and Goal');
                    return;
                }
            }
            if(step === 2) collectTasksNew();
            if(step === 3) collectToolsNew();
            if(step === 4 && typeof collectWizardAccessControl === 'function') collectWizardAccessControl();
            if(step === 5) collectGuardrails();
            
            // Auto-save to database before moving to next step
            await autoSaveWizardStep();
            
            // Also save Access Control when leaving step 4
            if(step === 4 && typeof saveAgentAccessControl === 'function') {
                const agentId = testAgent?.id || wizard.editId || wizard.id;
                if(agentId) {
                    console.log('ðŸ’¾ Auto-saving Access Control for step 4...');
                    await saveAgentAccessControl(agentId);
                }
            }
            
            step++;
            if(step > 7) step = 7;  // 7 steps total - Test & Deploy is final
            console.log('âž¡ï¸ Moving to step:', step);
            updateStepsNew();
        }
        
        // Auto-save wizard configuration to database
        async function autoSaveWizardStep() {
            // Only save if we have at least a goal (minimum to create draft)
            if (!wizard.goal) {
                console.log('â­ï¸ Skipping auto-save: no goal yet');
                return; // Skip if no goal
            }
            
            // Ensure we have minimum data
            const agentName = wizard.name || 'Untitled Agent';
            const agentGoal = wizard.goal;
            
            try {
                const agentData = {
                    name: agentName,
                    icon: wizard.icon || 'ðŸ¤–',
                    goal: agentGoal,
                    personality: wizard.personality || {tone: 'professional', voice: 'balanced', languages: ['English']},
                    personality_reason: wizard.personalityReason || '',
                    guardrails: wizard.guardrails || {},
                    tasks: wizard.tasks || [],
                    tool_ids: wizard.tool_ids || [],
                    model_id: wizard.model || 'gpt-4o',
                    model_reason: wizard.modelReason || '',
                    status: 'draft' // Always save as draft during wizard
                };
                
                console.log('ðŸ“ Auto-saving wizard step, editId:', wizard.editId, 'testAgent:', testAgent?.id);
                
                let response;
                const agentId = testAgent?.id || wizard.editId;
                const hasValidId = agentId && agentId !== 'undefined' && agentId.length > 0;
                
                if(hasValidId){
                    // Update existing agent
                    response = await fetch(API+'/api/agents/'+agentId, {
                        method: 'PUT',
                        headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
                        body: JSON.stringify(agentData)
                    });
                } else {
                    // Create new agent - MUST send auth headers for ownership
                    response = await fetch(API+'/api/agents', {
                        method: 'POST',
                        headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
                        body: JSON.stringify(agentData)
                    });
                }
                
                if(response.ok) {
                    const data = await response.json();
                    // Store agent ID for future updates
                    if(data.agent_id) {
                        wizard.editId = data.agent_id;
                        if(!testAgent) testAgent = {id: data.agent_id};
                    } else if(data.agent && data.agent.id) {
                        wizard.editId = data.agent.id;
                        if(!testAgent) testAgent = {id: data.agent.id};
                    } else if(data.agent_id === undefined && !wizard.editId) {
                        // If creating new agent, extract ID from agent object if present
                        const agentObj = data.agent || data;
                        if(agentObj && agentObj.id) {
                            wizard.editId = agentObj.id;
                            if(!testAgent) testAgent = {id: agentObj.id};
                        }
                    }
                    
                    // âœ¨ CRITICAL: Save owner_id when creating new agent
                    // This is returned from POST /api/agents and is essential for access control
                    if(data.owner_id && !wizard.owner_id) {
                        wizard.owner_id = data.owner_id;
                        wizard.created_by = data.created_by || data.owner_id;
                        console.log('ðŸ‘¤ Agent owner set:', wizard.owner_id);
                    } else if(!wizard.owner_id && currentUser?.id) {
                        // Fallback: current user is the owner since they created it
                        wizard.owner_id = currentUser.id;
                        wizard.created_by = currentUser.id;
                        console.log('ðŸ‘¤ Agent owner set from currentUser:', wizard.owner_id);
                    }
                    
                    // âœ¨ ALSO set wizard.id (needed for access control checks)
                    if (!wizard.id && wizard.editId) {
                        wizard.id = wizard.editId;
                        console.log('ðŸ”— wizard.id synced from editId:', wizard.id);
                    }
                    
                    console.log('âœ… Wizard step auto-saved to database, agent ID:', wizard.editId || testAgent?.id);
                } else {
                    console.warn('âš ï¸  Failed to auto-save wizard step:', await response.text());
                }
            } catch(e) {
                console.warn('âš ï¸  Auto-save error (non-blocking):', e);
                // Don't block wizard flow if save fails
            }
        }
        
        function prevStep() {
            if(step > 1) {
                step--;
                updateStepsNew();
            }
        }
        
        // Update the sticky header with current step info
        function updateWizardStickyHeader() {
            const stepNames = {
                1: 'Setup',
                2: 'Tasks',
                3: 'Tools',
                4: 'Access Control',
                5: 'Safety',
                6: 'Preview',
                7: 'Test & Deploy'
            };
            
            // 7 steps total
            const totalSteps = 7;
            const isEditing = wizard.editId || wizard.id;
            
            // Update title
            const titleEl = document.getElementById('wizard-header-title');
            if (titleEl) {
                titleEl.textContent = isEditing ? `Edit: ${wizard.name || 'Agent'}` : 'Create Agent';
            }
            
            // Update step info
            const stepEl = document.getElementById('wizard-header-step');
            if (stepEl) {
                stepEl.textContent = `Step ${step} of ${totalSteps}: ${stepNames[step] || ''}`;
            }
            
            // Update back button state
            const backBtn = document.getElementById('wizard-btn-back');
            if (backBtn) {
                backBtn.disabled = step <= 1;
            }
            
            // Update next/deploy button visibility
            // Step 7 (Test & Deploy) is the final step - show Deploy, hide Next
            const nextBtn = document.getElementById('wizard-btn-next');
            const deployBtn = document.getElementById('wizard-btn-deploy');
            if (nextBtn && deployBtn) {
                if (step >= 7) {
                    // Final step - hide Next, show Deploy
                    nextBtn.classList.add('hidden');
                    deployBtn.classList.remove('hidden');
                } else {
                    nextBtn.classList.remove('hidden');
                    deployBtn.classList.add('hidden');
                }
            }
            
            // Update progress dots
            const progressSteps = document.querySelectorAll('.wizard-progress-step');
            progressSteps.forEach((stepDiv) => {
                const dataStep = parseInt(stepDiv.dataset.step);
                const dot = stepDiv.querySelector('.wizard-step-dot');
                if (dot) {
                    dot.classList.remove('active', 'completed', 'clickable');
                    
                    // In edit mode, make all steps clickable
                    if (isEditing && dataStep !== step) {
                        dot.classList.add('clickable');
                    }
                    
                    // Handle step states
                    if (step === dataStep) {
                        dot.classList.add('active');
                    } else if (step > dataStep) {
                        dot.classList.add('completed');
                    }
                }
            });
            
            // Update progress lines
            const progressLines = document.querySelectorAll('.wizard-progress-line');
            progressLines.forEach((line, idx) => {
                line.classList.toggle('completed', idx < step - 1);
            });
        }
        
        // Cancel edit and restore agent to original state
        async function cancelEdit() {
            // Confirm with user
            const confirmMsg = wizard.originalStatus === 'published' 
                ? 'Are you sure you want to cancel? The agent will be restored to published state.'
                : 'Are you sure you want to cancel editing?';
            
            if (!confirm(confirmMsg)) return;
            
            // If this was a published agent being edited, restore it to published status
            const agentId = wizard.editId || wizard.id;
            if (agentId && wizard.originalStatus === 'published') {
                try {
                    // Restore to published status using PUT
                    const response = await fetch(API + '/api/agents/' + agentId, {
                        method: 'PUT',
                        headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
                        body: JSON.stringify({ status: 'published' })
                    });
                    
                    if (response.ok) {
                        showToast('Edit cancelled - agent restored to published state', 'info');
                    } else {
                        const error = await response.json();
                        console.warn('Could not restore agent status:', error);
                        showToast('Edit cancelled but could not restore status', 'warning');
                    }
                } catch (e) {
                    console.error('Error restoring agent status:', e);
                    showToast('Edit cancelled', 'info');
                }
            } else {
                showToast('Edit cancelled', 'info');
            }
            
            // Clear wizard state
            wizard.editId = null;
            wizard.id = null;
            wizard.originalStatus = null;
            testAgent = null;
            
            // Navigate back to agents list
            navigate('agents');
            loadAgents();
        }
        
        // Go to specific step (for clickable step indicators)
        async function goToStep(targetStep) {
            // Collect data from current step before navigating
            if(step === 1) {
                wizard.name = document.getElementById('w-name')?.value || wizard.name;
                wizard.icon = document.getElementById('w-icon')?.value || wizard.icon || 'ðŸ¤–';
                wizard.goal = document.getElementById('w-goal')?.value || wizard.goal;
            }
            if(step === 2) collectTasksNew();
            if(step === 3) collectToolsNew();
            if(step === 4 && typeof collectWizardAccessControl === 'function') collectWizardAccessControl();
            if(step === 5) collectGuardrails();
            
            // Navigate to target step
            step = targetStep;
            updateStepsNew();
        }
        
        // Manual save button for wizard
        async function saveWizardProgress() {
            // Collect current step data
            if(step === 1) {
                wizard.name = document.getElementById('w-name')?.value || wizard.name;
                wizard.icon = document.getElementById('w-icon')?.value || wizard.icon || 'ðŸ¤–';
                wizard.goal = document.getElementById('w-goal')?.value || wizard.goal;
                
                // Collect personality if available
                const creativity = parseInt(document.getElementById('p-creativity')?.value);
                const length = parseInt(document.getElementById('p-length')?.value);
                const formality = parseInt(document.getElementById('p-formality')?.value);
                const empathy = parseInt(document.getElementById('p-empathy')?.value);
                const proactivity = parseInt(document.getElementById('p-proactivity')?.value);
                const confidence = parseInt(document.getElementById('p-confidence')?.value);
                if(creativity && length && formality && empathy && proactivity && confidence) {
                    wizard.personality = { creativity, length, formality, empathy, proactivity, confidence };
                }
            }
            if(step === 2) collectTasksNew();
            if(step === 3) collectToolsNew();
            if(step === 4 && typeof collectWizardAccessControl === 'function') collectWizardAccessControl();
            if(step === 5) collectGuardrails();
            
            // Save to database
            await autoSaveWizardStep();
            
            // Show confirmation
            showToast('âœ… Progress saved!', 'success');
        }
        
        // ========== MODERN NOTIFICATION SYSTEM ==========
        const NotificationSystem = {
            container: null,
            notifications: [],
            maxVisible: 5,
            
            init() {
                if (this.container) return;
                this.container = document.createElement('div');
                this.container.id = 'notification-container';
                this.container.className = 'fixed top-4 right-4 z-[9999] flex flex-col gap-3 max-w-md w-full pointer-events-none';
                this.container.style.cssText = 'max-height: calc(100vh - 2rem); overflow: hidden;';
                document.body.appendChild(this.container);
            },
            
            getConfig(type) {
                const configs = {
                    success: {
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`,
                        bgClass: 'bg-gradient-to-r from-emerald-500/95 to-green-600/95',
                        borderClass: 'border-emerald-400/30',
                        iconBg: 'bg-emerald-400/20',
                        title: 'Success',
                        duration: 4000
                    },
                    error: {
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`,
                        bgClass: 'bg-gradient-to-r from-red-500/95 to-rose-600/95',
                        borderClass: 'border-red-400/30',
                        iconBg: 'bg-red-400/20',
                        title: 'Error',
                        duration: 8000
                    },
                    warning: {
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`,
                        bgClass: 'bg-gradient-to-r from-amber-500/95 to-orange-600/95',
                        borderClass: 'border-amber-400/30',
                        iconBg: 'bg-amber-400/20',
                        title: 'Warning',
                        duration: 6000
                    },
                    info: {
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                        bgClass: 'bg-gradient-to-r from-blue-500/95 to-indigo-600/95',
                        borderClass: 'border-blue-400/30',
                        iconBg: 'bg-blue-400/20',
                        title: 'Info',
                        duration: 4000
                    }
                };
                return configs[type] || configs.info;
            },
            
            show(message, type = 'info', options = {}) {
                this.init();
                const config = this.getConfig(type);
                const id = 'notif-' + Date.now() + Math.random().toString(36).substr(2, 9);
                const duration = options.duration || config.duration;
                const showProgress = options.showProgress !== false;
                
                // Clean message - remove emoji prefixes if they exist
                const cleanMessage = message.replace(/^[âœ…âŒâš ï¸â„¹ï¸âœ¨ðŸŽ‰ðŸ’¡ðŸ””]\s*/, '');
                
                const notification = document.createElement('div');
                notification.id = id;
                notification.className = `
                    ${config.bgClass} ${config.borderClass}
                    backdrop-blur-xl border rounded-xl shadow-2xl
                    transform translate-x-full opacity-0
                    transition-all duration-300 ease-out
                    pointer-events-auto overflow-hidden
                `;
                notification.style.cssText = 'box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);';
                
                notification.innerHTML = `
                    <div class="p-4">
                        <div class="flex items-start gap-3">
                            <div class="${config.iconBg} rounded-full p-2 flex-shrink-0">
                                ${config.icon}
                            </div>
                            <div class="flex-1 min-w-0 pt-0.5">
                                <p class="text-sm font-semibold text-white/90">${config.title}</p>
                                <p class="text-sm text-white/80 mt-0.5 break-words">${this.escapeHtml(cleanMessage)}</p>
                            </div>
                            <button onclick="NotificationSystem.dismiss('${id}')" 
                                class="flex-shrink-0 p-1 rounded-lg hover:bg-white/20 transition-colors text-white/60 hover:text-white">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    ${showProgress ? `<div class="h-1 bg-white/20"><div class="notif-progress h-full bg-white/40 rounded-full" style="width: 100%; transition: width ${duration}ms linear;"></div></div>` : ''}
                `;
                
                // Add to container
                this.container.insertBefore(notification, this.container.firstChild);
                this.notifications.push({ id, element: notification, timeout: null });
                
                // Animate in
                requestAnimationFrame(() => {
                    notification.classList.remove('translate-x-full', 'opacity-0');
                    notification.classList.add('translate-x-0', 'opacity-100');
                    
                    // Start progress bar animation
                    if (showProgress) {
                        const progressBar = notification.querySelector('.notif-progress');
                        if (progressBar) {
                            requestAnimationFrame(() => {
                                progressBar.style.width = '0%';
                            });
                        }
                    }
                });
                
                // Auto dismiss
                const timeout = setTimeout(() => this.dismiss(id), duration);
                const notifRecord = this.notifications.find(n => n.id === id);
                if (notifRecord) notifRecord.timeout = timeout;
                
                // Limit visible notifications
                this.enforceLimit();
                
                return id;
            },
            
            dismiss(id) {
                const index = this.notifications.findIndex(n => n.id === id);
                if (index === -1) return;
                
                const { element, timeout } = this.notifications[index];
                if (timeout) clearTimeout(timeout);
                
                // Animate out
                element.classList.add('translate-x-full', 'opacity-0');
                element.style.marginTop = `-${element.offsetHeight + 12}px`;
                
                setTimeout(() => {
                    element.remove();
                    this.notifications.splice(index, 1);
                }, 300);
            },
            
            dismissAll() {
                [...this.notifications].forEach(n => this.dismiss(n.id));
            },
            
            enforceLimit() {
                while (this.notifications.length > this.maxVisible) {
                    const oldest = this.notifications[this.notifications.length - 1];
                    this.dismiss(oldest.id);
                }
            },
            
            escapeHtml(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            
            // ========== EASY-TO-USE HELPER METHODS ==========
            success(message, options = {}) {
                return this.show(message, 'success', options);
            },
            
            error(message, options = {}) {
                return this.show(message, 'error', options);
            },
            
            warning(message, options = {}) {
                return this.show(message, 'warning', options);
            },
            
            info(message, options = {}) {
                return this.show(message, 'info', options);
            },
            
            // Promise-based notification (shows loading, then success/error)
            async promise(promise, messages = {}) {
                const loadingMsg = messages.loading || 'Loading...';
                const successMsg = messages.success || 'Success!';
                const errorMsg = messages.error || 'Something went wrong';
                
                const id = this.show(loadingMsg, 'info', { duration: 60000, showProgress: false });
                
                try {
                    const result = await promise;
                    this.dismiss(id);
                    this.success(typeof successMsg === 'function' ? successMsg(result) : successMsg);
                    return result;
                } catch (err) {
                    this.dismiss(id);
                    this.error(typeof errorMsg === 'function' ? errorMsg(err) : (err.message || errorMsg));
                    throw err;
                }
            },
            
            // Confirmation notification with action button
            confirm(message, onConfirm, options = {}) {
                const id = 'notif-confirm-' + Date.now();
                const config = this.getConfig('warning');
                
                this.init();
                
                const notification = document.createElement('div');
                notification.id = id;
                notification.className = `
                    ${config.bgClass} ${config.borderClass}
                    backdrop-blur-xl border rounded-xl shadow-2xl
                    transform translate-x-full opacity-0
                    transition-all duration-300 ease-out
                    pointer-events-auto overflow-hidden
                `;
                notification.style.cssText = 'box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);';
                
                notification.innerHTML = `
                    <div class="p-4">
                        <div class="flex items-start gap-3">
                            <div class="${config.iconBg} rounded-full p-2 flex-shrink-0">
                                ${config.icon}
                            </div>
                            <div class="flex-1 min-w-0 pt-0.5">
                                <p class="text-sm font-semibold text-white/90">${options.title || 'Confirm'}</p>
                                <p class="text-sm text-white/80 mt-0.5">${this.escapeHtml(message)}</p>
                                <div class="flex gap-2 mt-3">
                                    <button onclick="NotificationSystem.handleConfirm('${id}', true)" 
                                        class="px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-colors">
                                        ${options.confirmText || 'Confirm'}
                                    </button>
                                    <button onclick="NotificationSystem.handleConfirm('${id}', false)" 
                                        class="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition-colors">
                                        ${options.cancelText || 'Cancel'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Store callback
                this._confirmCallbacks = this._confirmCallbacks || {};
                this._confirmCallbacks[id] = onConfirm;
                
                this.container.insertBefore(notification, this.container.firstChild);
                this.notifications.push({ id, element: notification, timeout: null });
                
                requestAnimationFrame(() => {
                    notification.classList.remove('translate-x-full', 'opacity-0');
                    notification.classList.add('translate-x-0', 'opacity-100');
                });
                
                return id;
            },
            
            handleConfirm(id, confirmed) {
                const callback = this._confirmCallbacks?.[id];
                if (callback && confirmed) callback();
                delete this._confirmCallbacks?.[id];
                this.dismiss(id);
            }
        };
        
        // ========== GLOBAL SHORTHAND: notify ==========
        // Usage: notify.success('Saved!'), notify.error('Failed'), etc.
        const notify = {
            success: (msg, opts) => NotificationSystem.success(msg, opts),
            error: (msg, opts) => NotificationSystem.error(msg, opts),
            warning: (msg, opts) => NotificationSystem.warning(msg, opts),
            info: (msg, opts) => NotificationSystem.info(msg, opts),
            promise: (p, msgs) => NotificationSystem.promise(p, msgs),
            confirm: (msg, cb, opts) => NotificationSystem.confirm(msg, cb, opts),
            dismiss: (id) => NotificationSystem.dismiss(id),
            dismissAll: () => NotificationSystem.dismissAll()
        };
        
        // Backward compatible showToast function
        function showToast(message, type = 'info', options = {}) {
            return NotificationSystem.show(message, type, options);
        }
        
        // Agent Templates
        function useAgentTemplate(template) {
            const templates = {
                customer_support: "Help customers with their inquiries about orders, products, returns, and general support questions. Provide accurate information, track order status, and escalate complex issues when needed.",
                sales: "Assist potential customers in finding the right products, answer pricing questions, provide product comparisons, and help close sales. Be persuasive but honest.",
                hr: "Help employees with HR-related questions about policies, benefits, leave requests, and company procedures. Maintain confidentiality and direct sensitive matters to HR staff.",
                research: "Research topics thoroughly, analyze information from multiple sources, summarize findings, and provide well-structured reports with citations.",
                coding: "Help developers write, debug, and improve code. Explain programming concepts, suggest best practices, and assist with technical documentation."
            };
            
            document.getElementById('w-initial-goal').value = templates[template] || '';
        }
        
        // =========================================================================
        // AGENT TYPE SELECTION (Conversational vs Workflow)
        // =========================================================================
        
        let selectedAgentType = 'conversational'; // Default
        
        function selectAgentType(type) {
            console.log('ðŸŽ¯ [CREATE] selectAgentType() called with type:', type);
            selectedAgentType = type;
            
            // Update card styles
            const convCard = document.getElementById('type-card-conversational');
            const procCard = document.getElementById('type-card-process');
            const convSection = document.getElementById('section-conversational');
            const procSection = document.getElementById('section-process');
            
            if (type === 'conversational') {
                convCard?.classList.add('border-purple-500');
                convCard?.classList.remove('border-transparent');
                procCard?.classList.remove('border-green-500');
                procCard?.classList.add('border-transparent');
                convSection?.classList.remove('hidden');
                procSection?.classList.add('hidden');
                // Update selection text
                if (convCard) convCard.querySelector('.text-sm:last-child').textContent = 'âœ“ Selected';
                if (procCard) procCard.querySelector('.text-sm:last-child').textContent = 'Click to select';
                if (convCard) convCard.querySelector('.text-sm:last-child').className = 'text-sm text-purple-400 font-medium';
                if (procCard) procCard.querySelector('.text-sm:last-child').className = 'text-sm text-gray-500';
            } else {
                procCard?.classList.add('border-green-500');
                procCard?.classList.remove('border-transparent');
                convCard?.classList.remove('border-purple-500');
                convCard?.classList.add('border-transparent');
                procSection?.classList.remove('hidden');
                convSection?.classList.add('hidden');
                // Update selection text
                if (procCard) procCard.querySelector('.text-sm:last-child').textContent = 'âœ“ Selected';
                if (convCard) convCard.querySelector('.text-sm:last-child').textContent = 'Click to select';
                if (procCard) procCard.querySelector('.text-sm:last-child').className = 'text-sm text-green-400 font-medium';
                if (convCard) convCard.querySelector('.text-sm:last-child').className = 'text-sm text-gray-500';
            }
        }
        
        // Generate Process/Workflow Configuration using AI
        async function generateProcessConfig() {
            const goal = document.getElementById('w-process-goal')?.value.trim();
            if(!goal) {
                alert('Please describe what your workflow should do');
                return;
            }
            
            wizard.originalGoal = goal;
            wizard.agentType = 'process';

            // Open the visual builder immediately (prevents popup blockers) and show "waiting" state there.
            // We'll send the generated workflow via postMessage once the API returns.
            let builderWin = null;
            try {
                builderWin = window.open('/ui/process-builder.html?draft=wait', '_blank');
            } catch (_) {
                builderWin = null;
            }
            
            // Show generating animation
            document.getElementById('wizard-step-0').classList.add('hidden');
            document.getElementById('wizard-generating').classList.remove('hidden');
            document.getElementById('generating-status').textContent = 'Creating your workflow...';
            
            try {
                // Provide available tools context to the wizard (sanitized: no secrets)
                let toolsForContext = [];
                try {
                    const toolsRes = await fetch('/api/tools', {
                        headers: { 'Authorization': 'Bearer ' + (authToken || localStorage.getItem('agentforge_token')) }
                    });
                    const toolsJson = await toolsRes.json();
                    const tools = Array.isArray(toolsJson?.tools) ? toolsJson.tools : [];
                    toolsForContext = tools.slice(0, 40).map(t => {
                        const apiParams = t?.api_config?.input_parameters || t?.api_config?.inputParameters || [];
                        const safeParams = Array.isArray(apiParams) ? apiParams.map(p => ({
                            name: p?.name,
                            description: p?.description,
                            data_type: p?.data_type || p?.type,
                            required: !!p?.required,
                            location: p?.location
                        })) : [];
                        return {
                            id: t?.id,
                            name: t?.name,
                            type: t?.type,
                            description: t?.description || '',
                            input_parameters: safeParams
                        };
                    }).filter(t => t.id && t.name);
                } catch (_) { /* ignore */ }

                const response = await fetch('/process/wizard/generate', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (authToken || localStorage.getItem('agentforge_token'))
                    },
                    body: JSON.stringify({
                        goal: goal,
                        output_format: 'visual_builder',
                        context: {
                            tools: toolsForContext
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.workflow) {
                    // Store the workflow definition
                    wizard.processDefinition = data.workflow;
                    
                    // Store draft for builder fallback (if postMessage is blocked or tab was closed)
                    try {
                        sessionStorage.setItem('agentforge_process_builder_draft', JSON.stringify(data.workflow));
                        sessionStorage.setItem('agentforge_process_builder_draft_meta', JSON.stringify({
                            goal: goal,
                            name: data.workflow.name || 'My Workflow',
                            animate: true
                        }));
                    } catch (_) { /* ignore */ }
                    
                    document.getElementById('wizard-generating').classList.add('hidden');
                    document.getElementById('wizard-step-0').classList.remove('hidden');
                    
                    // Send the workflow to the builder (cinematic build starts there immediately)
                    const payload = {
                        type: 'agentforge.workflow_draft',
                        workflow: data.workflow,
                        meta: {
                            goal: goal,
                            name: data.workflow.name || 'My Workflow',
                            animate: true
                        }
                    };
                    try {
                        if (builderWin && !builderWin.closed) {
                            builderWin.postMessage(payload, window.location.origin);
                            showToast('Opening the visual builderâ€¦', 'success');
                        } else {
                            // Popup was blocked or closed â†’ open builder using stored draft
                            openVisualEditor();
                        }
                    } catch (e) {
                        // Fallback
                        openVisualEditor();
                    }
                } else {
                    alert(data.detail || 'Could not create workflow. Please try again.');
                    document.getElementById('wizard-generating').classList.add('hidden');
                    document.getElementById('wizard-step-0').classList.remove('hidden');
                }
            } catch(e) {
                console.error('Process generation error:', e);
                alert('Could not connect to the server. Please try again.');
                document.getElementById('wizard-generating').classList.add('hidden');
                document.getElementById('wizard-step-0').classList.remove('hidden');
            }
        }
        
        // Show Process Editor (using modal instead of replacing content)
        function showProcessEditor(workflow) {
            // Hide the generating state and show step 0
            document.getElementById('wizard-generating')?.classList.add('hidden');
            document.getElementById('wizard-step-0')?.classList.remove('hidden');
            
            // Create or get the process editor modal
            let modal = document.getElementById('process-editor-preview-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'process-editor-preview-modal';
                modal.className = 'fixed inset-0 z-[9999] flex items-center justify-center p-4';
                document.body.appendChild(modal);
            }
            
            const nodesHtml = (workflow.nodes || []).map((node, i) => `
                <div class="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
                    <div class="w-8 h-8 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center text-sm font-bold">${i+1}</div>
                    <div>
                        <div class="font-medium">${node.name || node.type}</div>
                        <div class="text-xs text-gray-400">${node.type}</div>
                    </div>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div class="absolute inset-0 bg-black/70" onclick="closeProcessEditorPreview()"></div>
                <div class="relative bg-gray-900 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <button onclick="closeProcessEditorPreview()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
                    
                    <div class="p-8">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center mb-4 text-4xl">
                                âœ…
                            </div>
                            <h2 class="text-2xl font-bold mb-2">Your Workflow is Ready!</h2>
                            <p class="text-gray-400">${workflow.name || 'Workflow'} has been created with ${workflow.nodes?.length || 0} steps</p>
                        </div>
                        
                        <div class="card rounded-xl p-6 mb-6 bg-gray-800/50">
                            <h3 class="font-semibold mb-4">Workflow Steps:</h3>
                            <div class="space-y-3">
                                ${nodesHtml || '<p class="text-gray-500">No steps defined</p>'}
                            </div>
                        </div>
                        
                        <div class="card rounded-xl p-6 mb-6 bg-gray-800/50">
                            <label class="text-sm text-gray-400 mb-2 block">Workflow Name</label>
                            <input type="text" id="process-name" class="input-field w-full rounded-lg px-4 py-3 bg-gray-700 border border-gray-600" value="${workflow.name || 'My Workflow'}">
                        </div>
                        
                        <div class="flex gap-4">
                            <button onclick="closeProcessEditorPreview(); openVisualEditor();" class="flex-1 px-6 py-3 rounded-lg border border-gray-600 hover:bg-gray-700 transition">
                                âœï¸ Edit Visually
                            </button>
                            <button onclick="saveProcess()" class="flex-1 px-6 py-3 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, #22c55e 0%, #14b8a6 100%);">
                                ðŸ’¾ Save & Activate
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        // Close the process editor preview modal
        function closeProcessEditorPreview() {
            const modal = document.getElementById('process-editor-preview-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        // Open Visual Editor
        function openVisualEditor(agentId = null) {
            // If we have a freshly generated workflow (not yet saved), pass it as a draft to the builder
            try {
                if (!agentId && wizard && wizard.processDefinition) {
                    sessionStorage.setItem('agentforge_process_builder_draft', JSON.stringify(wizard.processDefinition));
                    sessionStorage.setItem('agentforge_process_builder_draft_meta', JSON.stringify({
                        goal: wizard.originalGoal || wizard.config?.goal || '',
                        animate: true
                    }));
                    window.open('/ui/process-builder.html?draft=1', '_blank');
                    return;
                }
            } catch (e) {
                console.warn('Could not store draft for builder:', e);
            }
            
            // Open process builder with agent ID if editing an existing workflow
            const url = agentId ? `/ui/process-builder.html?agent=${agentId}` : '/ui/process-builder.html';
            window.open(url, '_blank');
        }
        
        // Save Process
        async function saveProcess() {
            const name = document.getElementById('process-name')?.value || 'My Workflow';
            const workflow = wizard.processDefinition;
            workflow.name = name;
            
            try {
                const response = await fetch('/api/agents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (authToken || localStorage.getItem('agentforge_token'))
                    },
                    body: JSON.stringify({
                        name: name,
                        goal: wizard.originalGoal,
                        agent_type: 'process',
                        process_definition: workflow,
                        is_published: true
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    closeProcessEditorPreview(); // Close the modal
                    showToast('Workflow saved successfully!', 'success');
                    navigate('agents'); // Go to agents list
                } else {
                    const error = await response.json();
                    showToast('Could not save: ' + (error.detail || 'Unknown error'), 'error');
                }
            } catch(e) {
                showToast('Could not save workflow. Please try again.', 'error');
            }
        }
        
        // ============================================================================
        // PROCESS EXECUTION FUNCTIONS
        // ============================================================================
        
        let currentProcessAgent = null;
        let currentExecutionId = null;
        let executionPollInterval = null;
        let executionPollStopped = false;  // stop loop on 401 so we don't keep hitting the server

        // Process playback (visual animation) + test report (business-friendly)
        const _execMilestones = {}; // { [executionId]: { waiting?: true, completed?: true, failed?: true } }
        let _pbPlayer = {
            agentId: null,
            ready: false,
            playId: null,
            pending: null, // { playId, trace, after, subtitle }
            last: null // { agentId, trace, subtitle }
        };
        let _inlineApproval = { approvalId: null, executionId: null };

        function _markMilestone(executionId, milestone) {
            if (!executionId) return false;
            if (!_execMilestones[executionId]) _execMilestones[executionId] = {};
            if (_execMilestones[executionId][milestone]) return false;
            _execMilestones[executionId][milestone] = true;
            return true;
        }

        function closeProcessPlaybackModal() {
            const modal = document.getElementById('process-playback-modal');
            if (modal) modal.classList.add('hidden');
        }

        function _setPlaybackSubtitle(text) {
            const el = document.getElementById('process-playback-subtitle');
            if (el) el.textContent = text || 'Showing the actual path the workflow took';
        }

        function _openProcessPlaybackModal(agentId, subtitle) {
            const modal = document.getElementById('process-playback-modal');
            const frame = document.getElementById('process-playback-frame');
            if (!modal || !frame) return;

            // If agent changed (or iframe not loaded yet), reload the player
            const shouldReload = !agentId || _pbPlayer.agentId !== agentId || !frame.src || frame.src === 'about:blank';
            if (shouldReload) {
                _pbPlayer.ready = false;
                _pbPlayer.agentId = agentId || null;
                const src = agentId ? `/ui/process-builder.html?agent=${encodeURIComponent(agentId)}&player=1` : '/ui/process-builder.html?player=1';
                frame.src = src;
            }

            _setPlaybackSubtitle(subtitle || '');
            modal.classList.remove('hidden');
        }

        function replayProcessPlayback() {
            if (_pbPlayer.last && _pbPlayer.last.agentId && Array.isArray(_pbPlayer.last.trace)) {
                requestProcessPlayback(_pbPlayer.last.agentId, _pbPlayer.last.trace, { subtitle: _pbPlayer.last.subtitle || '', after: null, forceOpen: true });
            }
        }

        function closeProcessTestReport() {
            const modal = document.getElementById('process-test-report-modal');
            if (modal) modal.classList.add('hidden');
        }

        function _postToPlaybackFrame(msg) {
            const frame = document.getElementById('process-playback-frame');
            const win = frame && frame.contentWindow;
            if (!win) return false;
            try {
                win.postMessage(msg, window.location.origin);
                return true;
            } catch (_) {
                return false;
            }
        }

        // Listen for messages from the embedded Process Builder player
        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) return;
            const data = event.data || {};
            if (!data || typeof data !== 'object') return;

            if (data.type === 'PB_PLAYER_READY') {
                _pbPlayer.ready = true;
                if (_pbPlayer.pending && _pbPlayer.pending.trace) {
                    const p = _pbPlayer.pending;
                    _pbPlayer.pending = null;
                    _pbPlayer.playId = p.playId || null;
                    _pbPlayer.last = { agentId: _pbPlayer.agentId, trace: p.trace, subtitle: p.subtitle || '' };
                    _postToPlaybackFrame({ type: 'PB_PLAYER_PLAY_TRACE', playId: _pbPlayer.playId, trace: p.trace });
                }
                return;
            }

            if (data.type === 'PB_PLAYER_PLAY_DONE') {
                const playId = data.playId || null;
                if (_pbPlayer.playId && playId && String(_pbPlayer.playId) !== String(playId)) return;
                const after = data.after || null;
                // Run the queued callback (if any)
                if (_pbPlayer._after && typeof _pbPlayer._after === 'function') {
                    try { _pbPlayer._after(after); } catch (_) {}
                }
                _pbPlayer._after = null;
                return;
            }
        });

        function requestProcessPlayback(agentId, trace, opts = {}) {
            const subtitle = opts.subtitle || '';
            const after = (typeof opts.after === 'function') ? opts.after : null;
            const forceOpen = !!opts.forceOpen;

            if (!agentId || !Array.isArray(trace) || trace.length === 0) {
                if (after) after(null);
                return;
            }

            // Open the modal (or keep it open)
            if (forceOpen || document.getElementById('process-playback-modal')?.classList.contains('hidden')) {
                _openProcessPlaybackModal(agentId, subtitle);
            } else {
                _setPlaybackSubtitle(subtitle);
            }

            const playId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
            _pbPlayer.playId = playId;
            _pbPlayer._after = after;
            _pbPlayer.last = { agentId, trace, subtitle };

            // If iframe already ready, play immediately; otherwise queue until PB_PLAYER_READY
            if (_pbPlayer.ready && _pbPlayer.agentId === agentId) {
                _postToPlaybackFrame({ type: 'PB_PLAYER_PLAY_TRACE', playId, trace });
            } else {
                _pbPlayer.pending = { playId, trace, after: null, subtitle };
                _openProcessPlaybackModal(agentId, subtitle);
            }
        }

        function _parseCurrentProcessDefinition() {
            const agent = currentProcessAgent;
            if (!agent) return {};
            let def = agent.process_definition;
            if (typeof def === 'string') {
                try { def = def ? JSON.parse(def) : {}; } catch (_) { def = {}; }
            }
            if (!def || typeof def !== 'object') def = {};
            return def;
        }

        function _getProcessEdges(def) {
            const raw = def.edges || def.connections || def.links || [];
            if (!Array.isArray(raw)) return [];
            return raw.map(e => ({
                from: e.from || e.source,
                to: e.to || e.target,
                type: e.type || e.edge_type || e.edgeType || 'default'
            })).filter(e => e.from && e.to);
        }

        function buildPlaybackTraceFromExecution(execution) {
            const def = _parseCurrentProcessDefinition();
            const edges = _getProcessEdges(def);
            const edgeTypeByKey = new Map(edges.map(e => [`${e.from}=>${e.to}`, e.type || 'default']));
            const lookup = getProcessNodeLookup();

            const execStatus = String(execution?.status || '').toLowerCase();
            const currentId = String(execution?.current_step || execution?.current_node_id || '').trim();
            const statusById = {};
            try {
                (execution?.completed_steps || []).forEach(id => { if (id) statusById[String(id)] = 'completed'; });
            } catch (_) {}
            if (currentId) {
                statusById[currentId] = (
                    execStatus === 'waiting' ? 'waiting' :
                    execStatus === 'failed' ? 'failed' :
                    execStatus === 'paused' ? 'paused' :
                    execStatus || 'running'
                );
            }
            const execErr = execution?.error?.message || execution?.error_message || '';

            const seq = [];
            const seen = new Set();
            const push = (id) => {
                const s = String(id || '').trim();
                if (!s) return;
                if (seen.has(s)) return;
                seen.add(s);
                seq.push(s);
            };

            // Ensure we start from the trigger/start node when available
            const startNode = Array.isArray(def.nodes)
                ? def.nodes.find(n => ['trigger', 'form', 'start'].includes(String(n?.type || '').toLowerCase()))
                : null;
            if (startNode && startNode.id) push(startNode.id);

            (execution?.completed_steps || []).forEach(push);
            if (execution?.current_step) push(execution.current_step);

            // Safety: if run stopped (waiting/failed), never animate beyond current node
            if ((execStatus === 'waiting' || execStatus === 'failed' || execStatus === 'paused' || execStatus === 'cancelled' || execStatus === 'timed_out') && currentId) {
                const cut = seq.indexOf(currentId);
                if (cut >= 0) seq.splice(cut + 1);
            }

            // Build trace for the player (nodeId + edgeType for correct branch highlighting)
            const trace = seq.map((nodeId, idx) => {
                const prevId = idx > 0 ? seq[idx - 1] : null;
                let edgeType = null;
                if (prevId && prevId !== nodeId) {
                    const t = edgeTypeByKey.get(`${prevId}=>${nodeId}`);
                    edgeType = (t && t !== 'default') ? t : null;
                }
                const info = lookup[nodeId] || {};
                return {
                    nodeId,
                    edgeType,
                    type: info.type || 'step',
                    title: info.name || 'Step',
                    status_key: statusById[nodeId] || '',
                    terminal: nodeId === currentId && (statusById[nodeId] === 'failed' || statusById[nodeId] === 'waiting' || statusById[nodeId] === 'paused' || statusById[nodeId] === 'cancelled' || statusById[nodeId] === 'timed_out'),
                    error: (nodeId === currentId && statusById[nodeId] === 'failed') ? String(execErr || '') : null
                };
            });
            return trace;
        }

        async function buildPlaybackTraceForExecution(executionId, execution) {
            const execId = String(executionId || execution?.id || execution?.execution_id || '').trim();
            if (!execId) return buildPlaybackTraceFromExecution(execution);
            try {
                const headers = getAuthHeaders();
                const res = await fetch(API + `/process/executions/${encodeURIComponent(execId)}/steps`, { headers });
                let data = null;
                try { data = await res.json(); } catch (_) { data = null; }
                const steps = (data && Array.isArray(data.steps)) ? data.steps : [];
                if (res.ok && steps.length) {
                    const def = _parseCurrentProcessDefinition();
                    const edges = _getProcessEdges(def);
                    const edgeTypeByKey = new Map(edges.map(e => [`${e.from}=>${e.to}`, e.type || 'default']));
                    const lookup = getProcessNodeLookup();
                    const sorted = steps
                        .filter(s => s && s.node_id)
                        .slice()
                        .sort((a, b) => (a.order || 0) - (b.order || 0));
                    const trace = sorted.map((s, idx) => {
                        const nodeId = String(s.node_id || '').trim();
                        const prevId = (idx > 0 && sorted[idx - 1] && sorted[idx - 1].node_id) ? String(sorted[idx - 1].node_id) : null;
                        let edgeType = null;
                        if (prevId && prevId !== nodeId) {
                            const t = edgeTypeByKey.get(`${prevId}=>${nodeId}`);
                            edgeType = (t && t !== 'default') ? t : null;
                        }
                        const info = lookup[nodeId] || {};
                        return {
                            nodeId,
                            edgeType,
                            type: info.type || String(s.node_type || 'step').toLowerCase(),
                            title: info.name || s.step_name || 'Step',
                            status: s.status || null,
                            error: s.error || null
                        };
                    });
                    return trace;
                }
            } catch (_) {
                // ignore and fall back
            }
            return buildPlaybackTraceFromExecution(execution);
        }

        function _formatMaybeDateTime(d) {
            try {
                const dt = new Date(d);
                if (isNaN(dt.getTime())) return '';
                return dt.toLocaleString();
            } catch (_) {
                return '';
            }
        }

        function _renderReportValue(v) {
            if (v == null) return 'â€”';
            if (typeof v === 'string') return v.trim() ? v : 'â€”';
            if (typeof v === 'number' || typeof v === 'boolean') return String(v);
            if (typeof v === 'object') {
                // Uploaded file reference (hide server path; show name only)
                try {
                    if (v && v.kind === 'uploadedFile' && (v.name || v.id)) {
                        const name = v.name || 'Uploaded file';
                        const size = (typeof v.size === 'number') ? `${Math.round(v.size / 1024)} KB` : '';
                        const typ = v.file_type ? String(v.file_type).toUpperCase() : '';
                        const meta = [typ, size].filter(Boolean).join(' Â· ');
                        return meta ? `${name} (${meta})` : name;
                    }
                } catch (_) {}
            }
            try {
                const s = JSON.stringify(v);
                if (!s) return 'â€”';
                return s.length > 240 ? (s.slice(0, 240) + 'â€¦') : s;
            } catch (_) {
                const s = String(v);
                return s.length > 240 ? (s.slice(0, 240) + 'â€¦') : s;
            }
        }

        function _renderIoValue(v) {
            if (v == null) return 'â€”';
            if (typeof v === 'string') return v.trim() ? escHtml(v) : 'â€”';
            if (typeof v === 'number' || typeof v === 'boolean') return escHtml(String(v));
            if (typeof v === 'object') {
                // Uploaded file reference (sanitized by API)
                if (v.kind === 'uploadedFile' && (v.name || v.id)) {
                    const name = v.name || 'Uploaded file';
                    const size = (typeof v.size === 'number') ? `${Math.round(v.size / 1024)} KB` : '';
                    const typ = v.file_type ? String(v.file_type).toUpperCase() : '';
                    const meta = [typ, size].filter(Boolean).join(' Â· ');
                    const btn = v.id ? `
                        <button
                            type="button"
                            class="text-xs px-2 py-1 rounded-lg border border-gray-700 bg-gray-800 hover:bg-gray-700 text-gray-200"
                            data-upload-file-id="${escHtml(String(v.id))}"
                            data-upload-file-name="${escHtml(String(name))}"
                        >Download</button>
                    ` : '';
                    return `${escHtml(name)}${meta ? ` <span class="text-xs text-gray-500">(${escHtml(meta)})</span>` : ''}${btn ? ` <span class="ml-2 inline-block">${btn}</span>` : ''}`;
                }
            }
            try {
                const s = JSON.stringify(v);
                if (!s) return 'â€”';
                const t = s.length > 1800 ? (s.slice(0, 1800) + 'â€¦') : s;
                return escHtml(t);
            } catch (_) {
                const s = String(v);
                const t = s.length > 1800 ? (s.slice(0, 1800) + 'â€¦') : s;
                return escHtml(t);
            }
        }

        async function downloadProcessUploadFile(fileId, filename) {
            const id = String(fileId || '').trim();
            if (!id) return;
            const name = String(filename || '').trim() || `upload-${id}`;
            try {
                const headers = getAuthHeaders();
                const res = await fetch(API + `/process/uploads/${encodeURIComponent(id)}/download`, { headers });
                if (!res.ok) {
                    let msg = res.statusText || 'Failed to download file';
                    try {
                        const data = await res.json().catch(() => null);
                        if (data && (data.detail || data.message || data.error)) msg = data.detail || data.message || data.error;
                    } catch (_) {}
                    try { showToast(String(msg || 'Failed to download file'), 'error'); } catch (_) {}
                    return;
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => { try { URL.revokeObjectURL(url); } catch (_) {} }, 1500);
            } catch (e) {
                try { showToast('Unable to download file', 'error'); } catch (_) {}
            }
        }

        async function _fetchExecutionStepsIo(executionId) {
            const execId = String(executionId || '').trim();
            if (!execId) return [];
            const headers = getAuthHeaders();
            const res = await fetch(API + `/process/executions/${encodeURIComponent(execId)}/steps?include_io=1`, { headers });
            let data = null;
            try { data = await res.json(); } catch (_) { data = null; }
            if (!res.ok) return [];
            const steps = data?.steps || [];
            return Array.isArray(steps) ? steps : [];
        }

        function _renderIoTable(obj) {
            const o = (obj && typeof obj === 'object') ? obj : {};
            const entries = Object.entries(o || {});
            if (!entries.length) return `<div class="text-sm text-gray-500">â€”</div>`;
            const rows = entries.slice(0, 28).map(([k, v]) => `
                <div class="flex items-start justify-between gap-4 py-2 border-b border-gray-700/50">
                    <div class="text-sm text-gray-400">${escHtml(humanizeFieldLabel(k) || k)}</div>
                    <div class="text-sm text-gray-200 font-medium max-w-[66%] text-right break-words">${_renderIoValue(v)}</div>
                </div>
            `).join('');
            return `<div>${rows}</div>`;
        }

        async function _loadAndRenderStepIo(executionId) {
            const el = document.getElementById('process-test-report-stepio');
            if (!el) return;
            el.innerHTML = `<div class="text-sm text-gray-500 py-4">Loading step inputs & outputsâ€¦</div>`;
            let steps = [];
            try { steps = await _fetchExecutionStepsIo(executionId); } catch (_) { steps = []; }
            if (!steps.length) {
                el.innerHTML = `<div class="text-sm text-gray-500">No step details available for this run.</div>`;
                return;
            }
            steps.sort((a, b) => (a.order || 0) - (b.order || 0));
            const cards = steps.slice(0, 80).map((s) => {
                const info = (s && typeof s.status === 'object') ? s.status : {};
                const color = String(info?.color || '').toLowerCase();
                const stKey =
                    (info && (info.key || info.status || info.value)) ? String(info.key || info.status || info.value).toLowerCase() :
                    (color === 'green') ? 'completed' :
                    (color === 'red') ? 'failed' :
                    (color === 'yellow') ? 'waiting' :
                    (color === 'orange') ? 'paused' :
                    (color === 'blue') ? 'running' :
                    '';
                const icon = stKey === 'completed' ? 'âœ…' : stKey === 'failed' ? 'âŒ' : (stKey === 'waiting' || stKey === 'paused') ? 'â³' : 'ðŸ”„';
                const badge = stKey === 'completed'
                    ? `<span class="text-xs px-2 py-0.5 rounded-full bg-green-500/20 text-green-300 border border-green-500/30 font-semibold">Completed</span>`
                    : stKey === 'failed'
                        ? `<span class="text-xs px-2 py-0.5 rounded-full bg-red-500/20 text-red-300 border border-red-500/30 font-semibold">Failed</span>`
                        : (stKey === 'waiting' || stKey === 'paused')
                            ? `<span class="text-xs px-2 py-0.5 rounded-full bg-orange-500/20 text-orange-300 border border-orange-500/30 font-semibold">Waiting</span>`
                            : `<span class="text-xs px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-300 border border-yellow-500/30 font-semibold">Running</span>`;
                const name = s.step_name || s.step_type || 'Step';
                const dur = s.duration_seconds != null ? `${s.duration_seconds}s` : '';
                const inputs = (s && s.input) ? s.input : {};
                const outputs = (s && s.output) ? s.output : {};
                return `
                    <details class="p-4 rounded-xl border border-gray-700 bg-gray-900/40">
                        <summary class="cursor-pointer select-none">
                            <div class="flex items-center justify-between gap-3">
                                <div class="flex items-center gap-3 min-w-0">
                                    <div class="text-lg">${icon}</div>
                                    <div class="min-w-0">
                                        <div class="font-semibold text-gray-100 truncate">${escHtml(name)}</div>
                                        <div class="text-xs text-gray-500">${escHtml(s.step_type || '')}${dur ? ` Â· ${escHtml(dur)}` : ''}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 flex-shrink-0">${badge}</div>
                            </div>
                        </summary>
                        <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div class="p-3 rounded-lg border border-gray-700/70 bg-black/20">
                                <div class="text-sm font-semibold text-gray-100 mb-2">Inputs</div>
                                ${_renderIoTable(inputs)}
                            </div>
                            <div class="p-3 rounded-lg border border-gray-700/70 bg-black/20">
                                <div class="text-sm font-semibold text-gray-100 mb-2">Outputs</div>
                                ${_renderIoTable(outputs)}
                            </div>
                        </div>
                    </details>
                `;
            }).join('');
            el.innerHTML = `<div class="space-y-3">${cards}</div>`;

            // Wire up authenticated downloads for uploaded file buttons
            try {
                el.querySelectorAll('button[data-upload-file-id]').forEach(btn => {
                    btn.addEventListener('click', async (ev) => {
                        try { ev.preventDefault(); ev.stopPropagation(); } catch (_) {}
                        const id = btn.getAttribute('data-upload-file-id') || '';
                        const name = btn.getAttribute('data-upload-file-name') || '';
                        await downloadProcessUploadFile(id, name);
                    });
                });
            } catch (_) {}
        }

        function showProcessTestReport(execution, stepsResolved) {
            const modal = document.getElementById('process-test-report-modal');
            const body = document.getElementById('process-test-report-body');
            const title = document.getElementById('process-test-report-title');
            const subtitle = document.getElementById('process-test-report-subtitle');
            if (!modal || !body) return;

            const status = String(execution?.status || '').toLowerCase();
            const isCompleted = status === 'completed';
            const isFailed = status === 'failed';

            const inputData = execution?.input_data ?? execution?.trigger_input ?? {};
            const output = execution?.output ?? execution?.result ?? null;
            const errorMsg = execution?.error?.message || execution?.error_message || (execution?.error && execution?.error.message) || '';

            if (title) title.textContent = isCompleted ? 'Test report' : (isFailed ? 'Test report (failed)' : 'Test report');
            if (subtitle) subtitle.textContent = execution?.created_at ? `Run started ${_formatMaybeDateTime(execution.created_at)}` : 'Summary of what happened in this run';

            const inputs = window._processInputs || [];
            const labelByKey = {};
            inputs.forEach(i => { if (i && i.id) labelByKey[i.id] = i.label || humanizeFieldLabel(i.id) || i.id; });

            const inputRows = Object.keys(inputData || {}).map(k => {
                const label = labelByKey[k] || humanizeFieldLabel(k) || k;
                const val = _renderReportValue(inputData[k]);
                return `
                    <div class="flex items-start justify-between gap-4 py-2 border-b border-gray-700/50">
                        <div class="text-sm text-gray-400">${escHtml(label)}</div>
                        <div class="text-sm text-gray-200 font-medium max-w-[60%] text-right break-words">${escHtml(val)}</div>
                    </div>
                `;
            }).join('') || `<div class="text-sm text-gray-500">No inputs.</div>`;

            const statusBadge = isCompleted
                ? `<span class="text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-300 border border-green-500/30 font-semibold">Completed</span>`
                : (isFailed
                    ? `<span class="text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-300 border border-red-500/30 font-semibold">Failed</span>`
                    : `<span class="text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-300 border border-yellow-500/30 font-semibold">In progress</span>`);

            const stepsHtml = (stepsResolved || []).map((s, idx) => {
                const icon = { completed: 'âœ…', running: 'ðŸ”„', pending: 'â³', failed: 'âŒ', skipped: 'â­ï¸' }[s.status] || 'â³';
                const cls = {
                    completed: 'border-green-500/30 bg-green-500/5',
                    running: 'border-yellow-500/30 bg-yellow-500/5',
                    pending: 'border-gray-600 bg-gray-800/50',
                    failed: 'border-red-500/30 bg-red-500/5',
                    skipped: 'border-gray-600 bg-gray-800/30'
                }[s.status] || 'border-gray-600 bg-gray-800/30';
                return `
                    <div class="p-3 rounded-xl border ${cls}">
                        <div class="flex items-center gap-3">
                            <div class="text-lg">${icon}</div>
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-gray-100 truncate">${escHtml(s.name || 'Step')}</div>
                                <div class="text-xs text-gray-500">${escHtml(s.typeLabel || s.type || 'Step')}</div>
                            </div>
                            <div class="text-xs text-gray-500">#${idx + 1}</div>
                        </div>
                    </div>
                `;
            }).join('') || `<div class="text-sm text-gray-500">No steps yet.</div>`;

            const outputHtml = isCompleted
                ? (output == null
                    ? `<div class="text-sm text-gray-500">No output was produced.</div>`
                    : (typeof output === 'string'
                        ? `<div class="text-sm text-gray-200 whitespace-pre-wrap">${escHtml(output)}</div>`
                        : (() => {
                            const entries = (output && typeof output === 'object') ? Object.entries(output) : [];
                            if (!entries.length) {
                                return `<div class="text-sm text-gray-200 whitespace-pre-wrap">${escHtml(_renderReportValue(output))}</div>`;
                            }
                            const rows = entries.slice(0, 24).map(([k, v]) => `
                                <tr class="border-b border-gray-700/50">
                                    <td class="py-2 pr-4 text-gray-400 font-medium whitespace-nowrap">${escHtml(humanizeFieldLabel(k) || k)}</td>
                                    <td class="py-2 text-gray-200">${escHtml(_renderReportValue(v))}</td>
                                </tr>
                            `).join('');
                            return `<div class="overflow-x-auto"><table class="w-full text-sm"><tbody>${rows}</tbody></table></div>`;
                        })()))
                : (isFailed
                    ? `<div class="text-sm text-red-300">${escHtml(errorMsg || 'The workflow failed. Please check configuration and try again.')}</div>`
                    : `<div class="text-sm text-gray-500">Result will appear when the workflow completes.</div>`);

            body.innerHTML = `
                <div class="flex items-start justify-between gap-3 mb-4">
                    <div>
                        <div class="text-lg font-bold text-gray-100">${escHtml(currentProcessAgent?.name || 'Workflow')}</div>
                        <div class="text-sm text-gray-400">${escHtml(currentProcessAgent?.goal || '')}</div>
                    </div>
                    <div>${statusBadge}</div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="p-4 rounded-xl border border-gray-700 bg-gray-900/40">
                        <div class="font-semibold text-gray-100 mb-3">Submitted information</div>
                        <div>${inputRows}</div>
                    </div>
                    <div class="p-4 rounded-xl border border-gray-700 bg-gray-900/40">
                        <div class="font-semibold text-gray-100 mb-3">What happened</div>
                        <div class="space-y-2">${stepsHtml}</div>
                    </div>
                </div>

                <div class="mt-4 p-4 rounded-xl border border-gray-700 bg-gray-900/40">
                    <div class="font-semibold text-gray-100 mb-2">Outcome</div>
                    ${outputHtml}
                </div>

                <div class="mt-4 p-4 rounded-xl border border-gray-700 bg-gray-900/40">
                    <div class="font-semibold text-gray-100 mb-3">Step inputs & outputs</div>
                    <div id="process-test-report-stepio" class="text-sm text-gray-500">Loadingâ€¦</div>
                </div>
            `;

            modal.classList.remove('hidden');

            // Load step I/O asynchronously (keeps UI snappy)
            const execId = execution?.id || execution?.execution_id || execution?.executionId;
            if (execId) {
                try { _loadAndRenderStepIo(execId); } catch (_) {}
            } else {
                const el = document.getElementById('process-test-report-stepio');
                if (el) el.innerHTML = `<div class="text-sm text-gray-500">Step details are not available.</div>`;
            }
        }

        async function loadInlineApprovalForExecution(executionId) {
            const detailsEl = document.getElementById('process-inline-approval-details');
            if (!detailsEl) return;
            const execId = String(executionId || '').trim();
            if (!execId) return;

            // Avoid hammering the server while polling
            const now = Date.now();
            if (_inlineApproval._loading) return;
            if (_inlineApproval._lastFetchAt && (now - _inlineApproval._lastFetchAt) < 1800) return;
            if (_inlineApproval.executionId === execId && _inlineApproval.approvalId) return;

            _inlineApproval._loading = true;
            _inlineApproval._lastFetchAt = now;
            _inlineApproval.executionId = execId;
            _inlineApproval.approvalId = null;

            detailsEl.innerHTML = `<div class="text-gray-500">Loading approval detailsâ€¦</div>`;

            try {
                const headers = getAuthHeaders();
                const [approvalRes, usersRes, rolesRes, groupsRes] = await Promise.all([
                    fetch(API + '/process/approvals?status=pending', { headers }),
                    fetch(API + '/api/security/users', { headers }).catch(() => ({ ok: false })),
                    fetch(API + '/api/security/roles', { headers }).catch(() => ({ ok: false })),
                    fetch(API + '/api/security/groups', { headers }).catch(() => ({ ok: false }))
                ]);

                if (!approvalRes.ok) {
                    detailsEl.innerHTML = `<div class="text-red-300">Could not load approval details.</div>`;
                    return;
                }

                const data = await approvalRes.json();
                const approvals = data.items || data.approvals || [];

                const getRunId = (a) => {
                    if (!a) return '';
                    return String(
                        a.process_execution_id ||
                        a.run_id ||
                        a.processExecutionId ||
                        a.runId ||
                        a.execution_id ||
                        a.executionId ||
                        ''
                    );
                };

                const match = (approvals || []).find(a => getRunId(a) === execId);
                if (!match) {
                    detailsEl.innerHTML = `<div class="text-gray-400">Approval is pending, but the approval request is not visible yet. This can take a few seconds. Please waitâ€¦</div>`;
                    return;
                }

                _inlineApproval.approvalId = match.id;

                let usersList = [], rolesList = [], groupsList = [];
                if (usersRes.ok) { const d = await usersRes.json(); usersList = Array.isArray(d) ? d : (d.users || []); }
                if (rolesRes.ok) { const d = await rolesRes.json(); rolesList = Array.isArray(d) ? d : (d.roles || []); }
                if (groupsRes.ok) { const d = await groupsRes.json(); groupsList = Array.isArray(d) ? d : (d.groups || []); }
                const userMap = Object.fromEntries(usersList.map(u => [String(u.id), u.name || u.email || u.id]));
                const roleMap = Object.fromEntries(rolesList.map(r => [String(r.id), r.name || r.id]));
                const groupMap = Object.fromEntries(groupsList.map(g => [String(g.id), g.name || g.id]));

                const assigneeType = String(match.assignee_type || '').toLowerCase();
                const u = (match.assigned_user_ids || []).map(id => userMap[String(id)] || id);
                const r = (match.assigned_role_ids || []).map(id => roleMap[String(id)] || id);
                const g = (match.assigned_group_ids || []).map(id => groupMap[String(id)] || id);
                let assignedTo = 'Anyone';
                if (assigneeType === 'user' && u.length) assignedTo = u.join(', ');
                else if (assigneeType === 'role' && r.length) assignedTo = `Role(s): ${r.join(', ')}`;
                else if (assigneeType === 'group' && g.length) assignedTo = `Group(s): ${g.join(', ')}`;
                else if ((u.length || r.length || g.length) && assigneeType) {
                    assignedTo = (u.length ? u.join(', ') : r.length ? `Role(s): ${r.join(', ')}` : `Group(s): ${g.join(', ')}`);
                }

                const urgency = match.urgency || match.priority || 'normal';
                const title = match.title || match.step_name || match.node_name || 'Approval';
                const desc = match.description || '';
                const reviewData = match.details_to_review || match.review_data || match.detailsToReview || {};

                const renderReviewData = (rd) => {
                    if (!rd) return '';
                    if (typeof rd === 'string') {
                        try { rd = JSON.parse(rd); } catch (_) { return `<div class="text-sm text-gray-200 whitespace-pre-wrap">${escHtml(rd)}</div>`; }
                    }
                    if (typeof rd !== 'object' || rd === null) return '';
                    const entries = Object.entries(rd).filter(([k, v]) => v !== undefined && v !== null && v !== '');
                    if (!entries.length) return '';
                    const rows = entries.slice(0, 24).map(([k, v]) => `
                        <tr class="border-b border-gray-700/50">
                            <td class="py-2 pr-4 text-gray-400 font-medium whitespace-nowrap">${escHtml(humanizeFieldLabel(k) || k)}</td>
                            <td class="py-2 text-gray-200">${escHtml(_renderReportValue(v))}</td>
                        </tr>
                    `).join('');
                    return `<div class="overflow-x-auto"><table class="w-full text-sm"><tbody>${rows}</tbody></table></div>`;
                };

                const reviewHtml = renderReviewData(reviewData);
                detailsEl.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <div class="font-semibold text-gray-100">${escHtml(title)}</div>
                            ${desc ? `<div class="text-sm text-gray-300 mt-1">${escHtml(desc)}</div>` : ''}
                            <div class="text-xs text-gray-500 mt-2">Assigned to: <span class="text-gray-300">${escHtml(assignedTo)}</span></div>
                        </div>
                        <span class="text-xs px-2 py-1 rounded bg-yellow-500/20 text-yellow-300 border border-yellow-500/30">${escHtml(String(urgency))}</span>
                    </div>
                    ${reviewHtml ? `
                        <div class="mt-4 p-4 rounded-lg bg-gray-900/40 border border-gray-700/60">
                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Details to review</div>
                            ${reviewHtml}
                        </div>
                    ` : ''}
                `;
            } catch (e) {
                detailsEl.innerHTML = `<div class="text-red-300">Could not load approval details.</div>`;
            } finally {
                _inlineApproval._loading = false;
            }
        }

        async function approveInlineApproval() {
            const approvalId = _inlineApproval.approvalId;
            if (!approvalId) {
                showToast('Approval details are not ready yet. Please wait a moment.', 'warning');
                return;
            }
            const comments = (document.getElementById('process-inline-approval-comments')?.value || '').trim();
            try {
                const response = await fetch(API + `/process/approvals/${approvalId}/decide`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                    body: JSON.stringify({ decision: 'approved', comments })
                });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    const msg = (err && err.detail) ? (typeof err.detail === 'string' ? err.detail : JSON.stringify(err.detail)) : 'Could not approve';
                    showToast(msg, 'error');
                    return;
                }
                showToast('Approved. Continuing workflowâ€¦', 'success');
                // Clear inline approval state; polling will update UI
                _inlineApproval.approvalId = null;
                const c = document.getElementById('process-inline-approval-comments');
                if (c) c.value = '';
            } catch (e) {
                showToast('Could not approve request', 'error');
            }
        }

        async function rejectInlineApproval() {
            const approvalId = _inlineApproval.approvalId;
            if (!approvalId) {
                showToast('Approval details are not ready yet. Please wait a moment.', 'warning');
                return;
            }
            const comments = (document.getElementById('process-inline-approval-comments')?.value || '').trim();
            if (!comments) {
                const ok = confirm('Reject without a comment?');
                if (!ok) return;
            }
            try {
                const response = await fetch(API + `/process/approvals/${approvalId}/decide`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                    body: JSON.stringify({ decision: 'rejected', comments: comments || 'Rejected' })
                });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    const msg = (err && err.detail) ? (typeof err.detail === 'string' ? err.detail : JSON.stringify(err.detail)) : 'Could not reject';
                    showToast(msg, 'error');
                    return;
                }
                showToast('Rejected.', 'success');
                _inlineApproval.approvalId = null;
                const c = document.getElementById('process-inline-approval-comments');
                if (c) c.value = '';
            } catch (e) {
                showToast('Could not reject request', 'error');
            }
        }
        
        // Open Process Execution Modal
        async function openProcessExecution(agentId) {
            try {
                // Fetch agent details
                const response = await fetch(API + '/api/agents/' + agentId, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    showToast('Could not load workflow', 'error');
                    return;
                }
                
                currentProcessAgent = await response.json();
                
                // Update modal header
                document.getElementById('process-modal-title').textContent = currentProcessAgent.name || 'Workflow';
                document.getElementById('process-modal-subtitle').textContent = currentProcessAgent.goal || 'Submit data to run this workflow';
                
                // Try LLM-enriched form fields (professional labels from process context)
                let enrichedFields = null;
                try {
                    const enrichRes = await fetch(API + '/process/enrich-form-fields', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                        body: JSON.stringify({ agent_id: agentId })
                    });
                    if (enrichRes.ok) {
                        const data = await enrichRes.json();
                        if (data.fields && data.fields.length) enrichedFields = data.fields;
                    }
                } catch (_) { /* use fallback */ }
                
                // Build dynamic form (use enriched labels if available)
                buildProcessForm(currentProcessAgent, enrichedFields);
                
                // Show trigger form, hide status
                document.getElementById('process-trigger-form').classList.remove('hidden');
                document.getElementById('process-execution-status').classList.add('hidden');
                document.getElementById('process-pending-approval').classList.add('hidden');
                try { closeProcessTestReport(); } catch (_) {}
                try { closeProcessPlaybackModal(); } catch (_) {}
                
                // Show modal
                document.getElementById('process-execution-modal').classList.remove('hidden');
                
            } catch(e) {
                console.error('Error opening process execution:', e);
                showToast('Could not load workflow: ' + e.message, 'error');
            }
        }
        
        // Build Dynamic Form from Process Definition (optionally with LLM-enriched labels)
        function humanizeFieldLabel(key) {
            if (!key) return '';
            let s = String(key);
            s = s.replace(/_/g, ' ');
            s = s.replace(/([a-z0-9])([A-Z])/g, '$1 $2');
            s = s.replace(/\s+/g, ' ').trim();
            if (!s) return '';
            return s.split(' ').map(w => w ? (w[0].toUpperCase() + w.slice(1)) : '').join(' ');
        }

        function _splitArgs(argStr) {
            const s = String(argStr || '');
            const out = [];
            let cur = '';
            let q = null;
            for (let i = 0; i < s.length; i++) {
                const ch = s[i];
                if (q) {
                    if (ch === q) { q = null; cur += ch; continue; }
                    cur += ch;
                    continue;
                }
                if (ch === '"' || ch === "'") { q = ch; cur += ch; continue; }
                if (ch === ',') { out.push(cur.trim()); cur = ''; continue; }
                cur += ch;
            }
            if (cur.trim()) out.push(cur.trim());
            return out;
        }

        function _resolveArgToken(token, values) {
            const t = String(token || '').trim();
            if (!t) return '';
            if ((t.startsWith('"') && t.endsWith('"')) || (t.startsWith("'") && t.endsWith("'"))) return t.slice(1, -1);
            if (/^-?\d+(\.\d+)?$/.test(t)) return parseFloat(t);
            const key = t.replace(/^\{\{/, '').replace(/\}\}$/, '').trim();
            return (values && key in values) ? values[key] : '';
        }

        function evaluateDerivedExpression(expression, values) {
            const expr = String(expression || '').trim();
            if (!expr) return '';
            if (/^[A-Za-z][A-Za-z0-9_]*$/.test(expr)) return (values && expr in values) ? values[expr] : '';
            const m = expr.match(/^([A-Za-z][A-Za-z0-9_]*)\s*\((.*)\)\s*$/);
            if (!m) return '';
            const fn = m[1];
            const args = _splitArgs(m[2]).map(a => _resolveArgToken(a, values));
            const toNum = (v) => {
                if (typeof v === 'number') return v;
                const n = parseFloat(String(v || '').trim());
                return Number.isFinite(n) ? n : 0;
            };
            const toStr = (v) => (v == null ? '' : String(v));
            const toDate = (v) => {
                const s = String(v || '').trim();
                if (!s) return null;
                const d = new Date(s);
                return isNaN(d.getTime()) ? null : d;
            };
            switch (fn) {
                case 'daysBetween': {
                    const d1 = toDate(args[0]);
                    const d2 = toDate(args[1]);
                    if (!d1 || !d2) return '';
                    const utc1 = Date.UTC(d1.getFullYear(), d1.getMonth(), d1.getDate());
                    const utc2 = Date.UTC(d2.getFullYear(), d2.getMonth(), d2.getDate());
                    return Math.floor((utc2 - utc1) / 86400000) + 1;
                }
                case 'concat':
                    return args.map(toStr).join('');
                case 'sum':
                    return args.reduce((acc, v) => acc + toNum(v), 0);
                case 'round': {
                    const n = toNum(args[0]);
                    const p = Math.max(0, Math.min(8, Math.floor(toNum(args[1] ?? 0))));
                    const f = Math.pow(10, p);
                    return Math.round(n * f) / f;
                }
                case 'toNumber':
                    return toNum(args[0]);
                default:
                    return '';
            }
        }

        function collectProcessFormValues(triggerInputs) {
            const values = {};
            (triggerInputs || []).forEach(input => {
                const el = document.getElementById(`pf-${input.id}`);
                values[input.id] = el ? el.value : '';
            });
            return values;
        }

        function recomputeProcessDerivedFields(triggerInputs) {
            const derivedInputs = (triggerInputs || []).filter(i => i && i.derived && i.derived.expression);
            if (!derivedInputs.length) return;
            const values = collectProcessFormValues(triggerInputs);
            derivedInputs.forEach(di => {
                const el = document.getElementById(`pf-${di.id}`);
                if (!el) return;
                const v = evaluateDerivedExpression(di.derived.expression, values);
                const text = (v == null) ? '' : String(v);
                el.value = text;
                values[di.id] = text;
            });
        }

        function getCurrentUserPrefillValue(key) {
            const k = String(key || '').trim();
            if (!currentUser) return '';
            if (k === 'email') return currentUser.email || '';
            if (k === 'name') return currentUser.name || currentUser.display_name || currentUser.profile?.name || '';
            if (k === 'id') return currentUser.id || '';
            if (k === 'orgId') return currentUser.org_id || '';
            if (k === 'roles') return Array.isArray(currentUser.roles) ? currentUser.roles.map(r => r?.name || r?.id || r).filter(Boolean).join(', ') : '';
            if (k === 'groups') return Array.isArray(currentUser.groups) ? currentUser.groups.map(g => g?.name || g?.id || g).filter(Boolean).join(', ') : '';
            return '';
        }

        function applyProcessPrefill(triggerInputs) {
            (triggerInputs || []).forEach(input => {
                if (!input || !input.prefill || input.prefill.source !== 'currentUser') return;
                const el = document.getElementById(`pf-${input.id}`);
                if (!el) return;
                const v = getCurrentUserPrefillValue(input.prefill.key);
                if (v !== '') el.value = v;
            });
        }

        function setupProcessDerivedFields(triggerInputs) {
            const derivedInputs = (triggerInputs || []).filter(i => i && i.derived && i.derived.expression);
            if (!derivedInputs.length) return;

            const recompute = () => recomputeProcessDerivedFields(triggerInputs);

            (triggerInputs || []).forEach(input => {
                if (!input || (input.derived && input.derived.expression) || input.readOnly) return;
                const el = document.getElementById(`pf-${input.id}`);
                if (!el) return;
                // Avoid duplicate listeners if this is called multiple times
                if (el.dataset && el.dataset.pbDerivedWired === '1') return;
                el.addEventListener('input', recompute);
                el.addEventListener('change', recompute);
                if (el.dataset) el.dataset.pbDerivedWired = '1';
            });

            recompute();
        }

        function buildProcessForm(agent, enrichedFields) {
            const formContainer = document.getElementById('process-form-fields');
            let triggerInputs = [];
            const startFieldMap = {};

            // Normalize: API may return process_definition as JSON string (e.g. from DB)
            let processDef = agent.process_definition;
            if (typeof processDef === 'string') {
                try { processDef = processDef ? JSON.parse(processDef) : null; } catch (_) { processDef = null; }
            }
            if (!processDef || typeof processDef !== 'object') processDef = {};

            // Process Builder: trigger or form node with config.fields (source of truth for ordering + derived fields)
            if (processDef.nodes && Array.isArray(processDef.nodes)) {
                const triggerNode = processDef.nodes.find(n => (n.type === 'trigger' || n.type === 'form' || n.type === 'start'));
                if (triggerNode) {
                    const config = triggerNode.config || {};
                    const typeConfig = config.type_config || config;
                    const fields = typeConfig.fields || config.fields || [];
                    if (Array.isArray(fields) && fields.length) {
                        triggerInputs = fields
                            .filter(f => f && (f.name || f.id))
                            .map(f => {
                                const id = f.name || f.id;
                                const label = f.label || humanizeFieldLabel(id) || id;
                                const derived = (f.derived && f.derived.expression) ? { expression: String(f.derived.expression).trim() } : null;
                                const prefill = (f.prefill && f.prefill.source === 'currentUser' && f.prefill.key)
                                    ? { source: 'currentUser', key: String(f.prefill.key).trim() }
                                    : null;
                                const readOnly = !!f.readOnly || !!derived || !!prefill;
                                const required = !!f.required && !readOnly;
                                const options = Array.isArray(f.options) ? f.options : undefined;
                                const placeholder = f.placeholder || (label ? `Enter ${label}...` : '');
                                const out = {
                                    id,
                                    label,
                                    type: f.type || 'text',
                                    required,
                                    placeholder,
                                    options,
                                    description: f.description,
                                    derived,
                                    prefill,
                                    readOnly
                                };
                                startFieldMap[id] = out;
                                return out;
                            });
                    }
                }
            }

            // Legacy: processDef.trigger.inputs
            if (!triggerInputs.length && processDef && processDef.trigger && processDef.trigger.inputs) {
                triggerInputs = processDef.trigger.inputs;
            }

            // Fallback: Use LLM-enriched fields when available (business-friendly labels)
            if (!triggerInputs.length && enrichedFields && enrichedFields.length) {
                triggerInputs = enrichedFields.map(f => ({
                    id: f.id,
                    label: f.label || humanizeFieldLabel(f.id) || f.id,
                    type: f.type || 'text',
                    required: !!f.required,
                    placeholder: f.placeholder || '',
                    options: f.options,
                    description: f.description
                }));
            }

            // Overlay enriched labels/descriptions while preserving derived/readOnly from definition
            if (enrichedFields && enrichedFields.length && triggerInputs.length) {
                const enrichedById = new Map(enrichedFields.map(f => [f.id, f]));
                triggerInputs = triggerInputs.map(base => {
                    const e = enrichedById.get(base.id);
                    if (!e) return base;
                    return {
                        ...base,
                        label: e.label || base.label || humanizeFieldLabel(base.id) || base.id,
                        placeholder: e.placeholder || base.placeholder || '',
                        description: e.description || base.description,
                        required: (e.required != null) ? (!!e.required && !(base.readOnly || (base.derived && base.derived.expression))) : base.required,
                        options: e.options || base.options
                    };
                });
            }
            
            // If no inputs defined, create a minimal business-friendly form (no hard-coded patterns)
            if (!triggerInputs.length) {
                triggerInputs = [
                    { id: 'details', label: 'Details', type: 'textarea', required: true, placeholder: 'Enter detailsâ€¦' }
                ];
            }
            
            // Build form HTML (with optional description from LLM)
            formContainer.innerHTML = triggerInputs.map(input => {
                const required = input.required ? '<span style="color: var(--danger);">*</span>' : '';
                const fieldId = `pf-${input.id}`;
                const descHtml = input.description ? `<p class="text-xs mt-0.5 mb-1" style="color: var(--text-muted);">${input.description}</p>` : '';
                
                let fieldHtml = '';
                switch(input.type) {
                    case 'textarea':
                        fieldHtml = `<textarea id="${fieldId}" class="input-field w-full rounded-lg px-4 py-3" rows="3" placeholder="${input.placeholder || ''}" ${input.required ? 'required' : ''} ${(input.readOnly || (input.derived && input.derived.expression)) ? 'readonly' : ''}></textarea>`;
                        break;
                    case 'select':
                        fieldHtml = `<select id="${fieldId}" class="input-field w-full rounded-lg px-4 py-3" ${input.required ? 'required' : ''} ${(input.readOnly || (input.derived && input.derived.expression)) ? 'disabled' : ''}>
                            <option value="">Select...</option>
                            ${(input.options || []).map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>`;
                        break;
                    case 'file':
                        fieldHtml = `<input type="file" id="${fieldId}" class="input-field w-full rounded-lg px-4 py-3" ${input.required ? 'required' : ''}>`;
                        break;
                    case 'number':
                        fieldHtml = `<input type="number" id="${fieldId}" class="input-field w-full rounded-lg px-4 py-3" placeholder="${input.placeholder || ''}" ${input.required ? 'required' : ''} ${(input.readOnly || (input.derived && input.derived.expression)) ? 'readonly' : ''}>`;
                        break;
                    case 'date':
                        fieldHtml = `<input type="date" id="${fieldId}" class="input-field w-full rounded-lg px-4 py-3" ${input.required ? 'required' : ''} ${(input.readOnly || (input.derived && input.derived.expression)) ? 'readonly' : ''}>`;
                        break;
                    case 'email':
                        fieldHtml = `<input type="email" id="${fieldId}" class="input-field w-full rounded-lg px-4 py-3" placeholder="${input.placeholder || ''}" ${input.required ? 'required' : ''} ${(input.readOnly || (input.derived && input.derived.expression)) ? 'readonly' : ''}>`;
                        break;
                    default:
                        fieldHtml = `<input type="text" id="${fieldId}" class="input-field w-full rounded-lg px-4 py-3" placeholder="${input.placeholder || ''}" ${input.required ? 'required' : ''} ${(input.readOnly || (input.derived && input.derived.expression)) ? 'readonly' : ''}>`;
                }
                
                return `
                    <div>
                        <label class="text-sm mb-1 block" style="color: var(--text-secondary);">${input.label} ${required}</label>
                        ${descHtml}
                        ${fieldHtml}
                    </div>
                `;
            }).join('');
            
            // Wire derived fields (auto-calculated) and store input config for later
            applyProcessPrefill(triggerInputs);
            setupProcessDerivedFields(triggerInputs);
            window._processInputs = triggerInputs;
        }
        
        async function uploadProcessRunFile(fileObj) {
            const tokenHeaders = getAuthHeaders();
            if (!tokenHeaders || !tokenHeaders.Authorization) {
                throw new Error('You are not signed in.');
            }
            const fd = new FormData();
            fd.append('file', fileObj);
            const res = await fetch(API + '/process/uploads', {
                method: 'POST',
                headers: {
                    ...tokenHeaders
                },
                body: fd
            });
            let data = null;
            try { data = await res.json(); } catch (_) { data = null; }
            if (!res.ok) {
                const msg = (data && (data.detail || data.message || data.error)) ? (data.detail || data.message || data.error) : (res.statusText || 'Failed to upload file');
                throw new Error(String(msg || 'Failed to upload file'));
            }
            const f = (data && data.file) ? data.file : data;
            if (!f || !f.id) throw new Error('File upload failed.');
            return f;
        }

        // Execute the Process
        async function executeProcess() {
            if (!currentProcessAgent) {
                showToast('No workflow selected', 'error');
                return;
            }
            
            // Collect form data
            const triggerData = {};
            const inputs = window._processInputs || [];

            // Ensure derived fields are up to date before collecting values
            recomputeProcessDerivedFields(inputs);
            
            for (const input of inputs) {
                const field = document.getElementById(`pf-${input.id}`);
                if (field) {
                    if (input.type === 'file') {
                        const fileObj = field.files && field.files[0] ? field.files[0] : null;
                        if (input.required && !fileObj) {
                            showToast(`Please upload: ${input.label}`, 'error');
                            field.focus();
                            return;
                        }
                        if (fileObj) {
                            try {
                                showToast(`Uploading: ${input.label}`, 'info');
                            } catch (_) {}
                            triggerData[input.id] = await uploadProcessRunFile(fileObj);
                        } else {
                            triggerData[input.id] = null;
                        }
                        continue;
                    }
                    const value = (field.value || '').trim();
                    if (input.required && !value) {
                        showToast(`Please fill in: ${input.label}`, 'error');
                        field.focus();
                        return;
                    }
                    triggerData[input.id] = input.type === 'number' ? (parseFloat(value) || 0) : value;
                }
            }
            
            // Switch to execution status view
            document.getElementById('process-trigger-form').classList.add('hidden');
            document.getElementById('process-execution-status').classList.remove('hidden');
            // Reset approval UI state (this run may or may not require approvals)
            try {
                _inlineApproval.approvalId = null;
                _inlineApproval.executionId = null;
                _inlineApproval._loading = false;
                _inlineApproval._lastFetchAt = 0;
                const detailsEl = document.getElementById('process-inline-approval-details');
                if (detailsEl) detailsEl.innerHTML = `<div class="text-gray-500">Loading approval detailsâ€¦</div>`;
                const c = document.getElementById('process-inline-approval-comments');
                if (c) c.value = '';
            } catch (_) {}
            
            // Update status badge
            updateExecutionStatus('running', 'Processing...', 'Your workflow is running');
            
            try {
                // Call execution API
                const response = await fetch(API + '/process/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        agent_id: currentProcessAgent.id,
                        trigger_input: triggerData,
                        trigger_type: 'manual'
                    })
                });
                
                if (!response.ok) {
                    const errBody = await response.json().catch(() => ({}));
                    const d = errBody.detail;
                    const msg = typeof d === 'string' ? d : (d && (d.detail || d.message || d.msg)) ? (d.detail || d.message || d.msg) : (d ? JSON.stringify(d) : 'Execution failed');
                    throw new Error(msg);
                }
                
                const execution = await response.json();
                currentExecutionId = execution.id || execution.execution_id;
                
                if (!currentExecutionId) {
                    updateExecutionStatus('failed', 'Execution Failed', 'No execution ID returned from server.');
                    return;
                }
                // Hide result section until completed; reset submitted-data toggle
                const outEl = document.getElementById('process-output');
                if (outEl) outEl.classList.add('hidden');
                const toggle = document.getElementById('process-submitted-data-toggle');
                if (toggle) { const s = toggle.querySelector('span'); if (s) s.textContent = 'â–¼'; }
                const submittedPre = document.getElementById('process-submitted-data-content');
                if (submittedPre) submittedPre.classList.add('hidden');
                // Start polling for status
                startExecutionPolling(currentExecutionId);
                
                // Show initial steps
                if (execution.nodes) {
                    updateExecutionSteps(execution.nodes);
                }
                
            } catch(e) {
                console.error('Execution error:', e);
                // Show more helpful error message
                let errorMsg = e.message || 'Something went wrong';
                if (errorMsg.includes('not found') || errorMsg.includes('404')) {
                    errorMsg = 'Workflow execution service is starting up. Please try again in a moment.';
                } else if (errorMsg.includes('Failed to fetch')) {
                    errorMsg = 'Could not connect to server. Please check your connection.';
                }
                updateExecutionStatus('failed', 'Execution Failed', errorMsg);
            }
        }
        
        // Build a lookup from node id â†’ { name, type, typeLabel } from current process definition
        function getProcessNodeLookup() {
            const agent = currentProcessAgent;
            if (!agent) return {};
            let def = agent.process_definition;
            if (typeof def === 'string') {
                try { def = def ? JSON.parse(def) : {}; } catch (_) { def = {}; }
            }
            if (!def || !Array.isArray(def.nodes)) return {};
            const typeLabels = {
                start: 'Start', trigger: 'Start', form: 'Start',
                task: 'Task', condition: 'Decision', approval: 'Approval',
                notification: 'Notification', end: 'End', human_task: 'Review'
            };
            const out = {};
            def.nodes.forEach(n => {
                const type = (n.type || 'task').toLowerCase();
                out[n.id] = {
                    name: n.name || n.id || 'Step',
                    type: type,
                    typeLabel: typeLabels[type] || 'Step'
                };
            });
            return out;
        }
        
        // Resolve step IDs to { name, type, typeLabel, status } using process definition
        function resolveStepsFromIds(completedIds, currentId) {
            const lookup = getProcessNodeLookup();
            const resolve = (id, status) => {
                const info = lookup[id];
                return {
                    name: info ? info.name : id,
                    type: info ? info.type : 'step',
                    typeLabel: info ? info.typeLabel : 'Step',
                    status
                };
            };
            const completed = (completedIds || []).map(id => resolve(id, 'completed'));
            const current = currentId ? [resolve(currentId, 'running')] : [];
            return completed.concat(current);
        }
        
        // Update Execution Status Badge
        function updateExecutionStatus(status, title, subtitle) {
            const badge = document.getElementById('process-status-badge');
            
            const statusStyles = {
                running: { bg: 'bg-yellow-500/10', border: 'border-yellow-500/30', color: 'text-yellow-400', icon: '<div class="animate-spin w-6 h-6 border-2 border-yellow-500 border-t-transparent rounded-full"></div>' },
                completed: { bg: 'bg-green-500/10', border: 'border-green-500/30', color: 'text-green-400', icon: 'âœ…' },
                failed: { bg: 'bg-red-500/10', border: 'border-red-500/30', color: 'text-red-400', icon: 'âŒ' },
                pending_approval: { bg: 'bg-orange-500/10', border: 'border-orange-500/30', color: 'text-orange-400', icon: 'â³' },
                paused: { bg: 'bg-blue-500/10', border: 'border-blue-500/30', color: 'text-blue-400', icon: 'â¸ï¸' }
            };
            
            const style = statusStyles[status] || statusStyles.running;
            
            badge.className = `mb-4 p-4 rounded-lg ${style.bg} border ${style.border}`;
            badge.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="text-2xl">${style.icon}</div>
                    <div>
                        <p class="font-medium ${style.color}">${title}</p>
                        <p class="text-sm text-gray-400">${subtitle}</p>
                    </div>
                </div>
            `;
            
            // Show pending approval section if needed
            if (status === 'pending_approval') {
                document.getElementById('process-pending-approval').classList.remove('hidden');
            } else {
                document.getElementById('process-pending-approval').classList.add('hidden');
            }
        }
        
        // Update Execution Steps List (node: name, typeLabel, status; typeLabel is business-friendly)
        function updateExecutionSteps(nodes) {
            const container = document.getElementById('process-steps-list');
            
            container.innerHTML = nodes.map((node, i) => {
                const statusIcon = {
                    completed: 'âœ…',
                    running: 'ðŸ”„',
                    pending: 'â³',
                    failed: 'âŒ',
                    skipped: 'â­ï¸'
                }[node.status] || 'â³';
                
                const statusClass = {
                    completed: 'border-green-500/30 bg-green-500/5',
                    running: 'border-yellow-500/30 bg-yellow-500/5',
                    pending: 'border-gray-600 bg-gray-800/50',
                    failed: 'border-red-500/30 bg-red-500/5',
                    skipped: 'border-gray-600 bg-gray-800/30'
                }[node.status] || 'border-gray-600';
                
                const displayName = node.name || node.type || 'Step';
                const displayType = node.typeLabel != null ? node.typeLabel : (node.type || 'Step');
                
                return `
                    <div class="p-3 rounded-lg border ${statusClass} transition-all">
                        <div class="flex items-center gap-3">
                            <span class="text-lg">${statusIcon}</span>
                            <div class="flex-1">
                                <p class="font-medium">${escHtml(displayName)}</p>
                                <p class="text-xs text-gray-500">${escHtml(displayType)}</p>
                            </div>
                            ${node.duration_ms ? `<span class="text-xs text-gray-500">${node.duration_ms}ms</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Poll for Execution Status
        function startExecutionPolling(executionId) {
            if (!executionId) return;
            executionPollStopped = false;
            // Clear any existing polling
            if (executionPollInterval) {
                clearInterval(executionPollInterval);
                executionPollInterval = null;
            }
            
            executionPollInterval = setInterval(async () => {
                if (executionPollStopped) return;
                try {
                    const response = await fetch(API + `/process/executions/${executionId}`, {
                        headers: getAuthHeaders()
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            executionPollStopped = true;
                            if (executionPollInterval) { clearInterval(executionPollInterval); executionPollInterval = null; }
                            if (typeof showToast === 'function') showToast('Session expired. Please log in again.', 'error');
                            if (typeof updateExecutionStatus === 'function') updateExecutionStatus('failed', 'Session expired', 'Please log in again to view status.');
                        }
                        return;
                    }
                    
                    const execution = await response.json();
                    
                    // Update status (show actual error message when failed)
                    // Backend sends "waiting" when at approval; treat as "Waiting for Approval"
                    const statusTitles = {
                        running: 'Processing...',
                        completed: 'Completed',
                        failed: 'Failed',
                        pending_approval: 'Waiting for Approval',
                        waiting: 'Waiting for Approval',
                        paused: 'Paused'
                    };
                    const displayStatus = execution.status === 'waiting' ? 'pending_approval' : execution.status;
                    let subtitle = execution.current_step || execution.current_node_name || '';
                    if (execution.status === 'failed' && (execution.error && execution.error.message)) {
                        subtitle = execution.error.message;
                    } else if (execution.status === 'failed' && execution.error_message) {
                        subtitle = execution.error_message;
                    }
                    updateExecutionStatus(
                        displayStatus,
                        statusTitles[execution.status] || statusTitles[displayStatus] || execution.status,
                        subtitle
                    );
                    
                    // Update steps: use node_executions if present, else build from completed_steps + current_step with resolved names
                    let resolvedStepsForReport = [];
                    if (execution.node_executions && execution.node_executions.length) {
                        const lookup = getProcessNodeLookup();
                        const resolved = execution.node_executions.map(ne => {
                            const info = lookup[ne.node_id || ne.id];
                            return {
                                name: info ? info.name : (ne.node_name || ne.node_id || ne.id || 'Step'),
                                typeLabel: info ? info.typeLabel : (ne.type || 'Step'),
                                type: ne.type,
                                status: ne.status || 'completed',
                                duration_ms: ne.duration_ms
                            };
                        });
                        updateExecutionSteps(resolved);
                        resolvedStepsForReport = resolved;
                    } else if (execution.completed_steps || execution.current_step) {
                        const steps = resolveStepsFromIds(execution.completed_steps || [], execution.current_step);
                        updateExecutionSteps(steps);
                        resolvedStepsForReport = steps;
                    }
                    
                    // Milestones: waiting for approval / completed / failed
                    if (execution.status === 'waiting') {
                        if (_markMilestone(executionId, 'waiting')) {
                            try {
                                const lookup = getProcessNodeLookup();
                                const curId = execution?.current_step || execution?.current_node_id || '';
                                const curName = (curId && lookup[curId] && lookup[curId].name) ? lookup[curId].name : 'Approval';
                                const trace = await buildPlaybackTraceForExecution(executionId, execution);
                                requestProcessPlayback(
                                    currentProcessAgent?.id,
                                    trace,
                                    {
                                        subtitle: `Stopped at: ${curName} (Waiting for approval)`,
                                        after: () => {
                                            try { loadInlineApprovalForExecution(executionId); } catch (_) {}
                                            try { closeProcessPlaybackModal(); } catch (_) {}
                                            try {
                                                setTimeout(() => {
                                                    const el = document.getElementById('process-pending-approval');
                                                    if (el && !el.classList.contains('hidden')) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                                }, 80);
                                            } catch (_) {}
                                        },
                                        forceOpen: true
                                    }
                                );
                            } catch (_) {
                                // Ignore playback errors (workflow can still be approved and resumed)
                            }
                        } else {
                            // Keep trying to load approval details if not found yet (approval may be created shortly after status flips)
                            try { loadInlineApprovalForExecution(executionId); } catch (_) {}
                        }
                    }

                    if (execution.status === 'completed') {
                        if (executionPollInterval) clearInterval(executionPollInterval);
                        executionPollInterval = null;

                        // Keep the in-modal UI business-friendly (no JSON by default)
                        const outEl = document.getElementById('process-output');
                        const summaryEl = document.getElementById('process-result-summary');
                        const resultBodyEl = document.getElementById('process-result-body');
                        const submittedWrap = document.getElementById('process-submitted-data-wrap');
                        if (outEl) outEl.classList.remove('hidden');
                        if (summaryEl) summaryEl.textContent = 'Completed successfully. A report is ready.';
                        if (resultBodyEl) resultBodyEl.classList.add('hidden');
                        if (submittedWrap) submittedWrap.classList.add('hidden');

                        if (_markMilestone(executionId, 'completed')) {
                            const snap = execution; // capture
                            const stepsSnap = resolvedStepsForReport.slice();
                            try {
                                const trace = await buildPlaybackTraceForExecution(executionId, snap);
                                requestProcessPlayback(
                                    currentProcessAgent?.id,
                                    trace,
                                    {
                                        subtitle: 'Completed path',
                                        after: () => showProcessTestReport(snap, stepsSnap),
                                        forceOpen: true
                                    }
                                );
                            } catch (_) {
                                // Fallback: show report even if playback fails
                                try { showProcessTestReport(snap, stepsSnap); } catch (_) {}
                            }
                        }
                    }

                    if (execution.status === 'failed') {
                        if (_markMilestone(executionId, 'failed')) {
                            const snap = execution;
                            const stepsSnap = resolvedStepsForReport.slice();
                            try {
                                const lookup = getProcessNodeLookup();
                                const curId = snap?.current_step || snap?.current_node_id || '';
                                const curName = (curId && lookup[curId] && lookup[curId].name) ? lookup[curId].name : 'Step';
                                const trace = await buildPlaybackTraceForExecution(executionId, snap);
                                requestProcessPlayback(
                                    currentProcessAgent?.id,
                                    trace,
                                    {
                                        subtitle: `Stopped at: ${curName} (Error)`,
                                        after: () => showProcessTestReport(snap, stepsSnap),
                                        forceOpen: true
                                    }
                                );
                            } catch (_) {
                                try { showProcessTestReport(snap, stepsSnap); } catch (_) {}
                            }
                        }
                    }
                    
                    // Stop polling on terminal states
                    if (['completed', 'failed', 'cancelled'].includes(execution.status)) {
                        if (executionPollInterval) clearInterval(executionPollInterval);
                        executionPollInterval = null;
                    }
                    
                } catch(e) {
                    console.error('Polling error:', e);
                }
            }, 2000); // Poll every 2 seconds
        }
        
        // Close Process Modal
        function closeProcessModal() {
            document.getElementById('process-execution-modal').classList.add('hidden');
            if (executionPollInterval) {
                clearInterval(executionPollInterval);
            }
            try { closeProcessTestReport(); } catch (_) {}
            try { closeProcessPlaybackModal(); } catch (_) {}
            try {
                const frame = document.getElementById('process-playback-frame');
                if (frame) frame.src = 'about:blank';
                _pbPlayer.ready = false;
                _pbPlayer.agentId = null;
                _pbPlayer.playId = null;
                _pbPlayer.pending = null;
                _pbPlayer.last = null;
            } catch (_) {}
            currentProcessAgent = null;
            currentExecutionId = null;
        }
        
        // View Execution History
        async function viewExecutionHistory() {
            if (!currentProcessAgent) return;
            
            try {
                const response = await fetch(API + `/process/executions?agent_id=${currentProcessAgent.id}&limit=10`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    showToast('Could not load history', 'error');
                    return;
                }
                
                const data = await response.json();
                const executions = data.executions || [];
                
                // Show in a simple alert for now (can be enhanced later)
                if (executions.length === 0) {
                    showToast('No execution history yet', 'info');
                } else {
                    const historyHtml = executions.map(e => 
                        `${e.status === 'completed' ? 'âœ…' : e.status === 'failed' ? 'âŒ' : 'ðŸ”„'} ${new Date(e.created_at).toLocaleString()} - ${e.status}`
                    ).join('\n');
                    alert('Execution History:\n\n' + historyHtml);
                }
            } catch(e) {
                showToast('Could not load history', 'error');
            }
        }
        
        // ============================================================================
        // APPROVAL DASHBOARD FUNCTIONS
        // ============================================================================
        
        // Open Approval Dashboard â€“ show approvals with "Assigned to" per process builder config (user/role/group)
        async function openApprovalDashboard() {
            try {
                const headers = getAuthHeaders();
                const [approvalRes, usersRes, rolesRes, groupsRes] = await Promise.all([
                    fetch(API + '/process/approvals?status=pending', { headers }),
                    fetch(API + '/api/security/users', { headers }).catch(() => ({ ok: false })),
                    fetch(API + '/api/security/roles', { headers }).catch(() => ({ ok: false })),
                    fetch(API + '/api/security/groups', { headers }).catch(() => ({ ok: false }))
                ]);
                
                if (!approvalRes.ok) {
                    showToast('Could not load approvals', 'error');
                    return;
                }
                
                const data = await approvalRes.json();
                const approvals = data.items || data.approvals || [];
                
                let usersList = [], rolesList = [], groupsList = [];
                if (usersRes.ok) { const d = await usersRes.json(); usersList = Array.isArray(d) ? d : (d.users || []); }
                if (rolesRes.ok) { const d = await rolesRes.json(); rolesList = Array.isArray(d) ? d : (d.roles || []); }
                if (groupsRes.ok) { const d = await groupsRes.json(); groupsList = Array.isArray(d) ? d : (d.groups || []); }
                
                const userMap = Object.fromEntries(usersList.map(u => [String(u.id), u.name || u.email || u.id]));
                const roleMap = Object.fromEntries(rolesList.map(r => [String(r.id), r.name || r.id]));
                const groupMap = Object.fromEntries(groupsList.map(g => [String(g.id), g.name || g.id]));
                
                function assigneeDisplay(a) {
                    const t = (a.assignee_type || 'user');
                    const u = (a.assigned_user_ids || []).map(id => userMap[id] || id);
                    const r = (a.assigned_role_ids || []).map(id => roleMap[id] || id);
                    const g = (a.assigned_group_ids || []).map(id => groupMap[id] || id);
                    if (t === 'user' && u.length) return 'Assigned to: ' + (u.join(', ') || 'â€”');
                    if (t === 'role' && r.length) return 'Assigned to role(s): ' + (r.join(', ') || 'â€”');
                    if (t === 'group' && g.length) return 'Assigned to group(s): ' + (g.join(', ') || 'â€”');
                    if (t === 'any' || (!u.length && !r.length && !g.length)) return 'Assigned to: Anyone';
                    return 'Assigned to: ' + (u.length ? u.join(', ') : r.length ? 'Role(s) ' + r.join(', ') : g.length ? 'Group(s) ' + g.join(', ') : 'â€”');
                }
                function escapeHtml(s) {
                    if (s == null) return '';
                    const div = document.createElement('div');
                    div.textContent = String(s);
                    return div.innerHTML;
                }
                function friendlyLabel(key) {
                    return String(key)
                        .replace(/_/g, ' ')
                        .replace(/\b\w/g, c => c.toUpperCase());
                }
                function renderReviewData(rd) {
                    if (!rd) return '';
                    if (typeof rd === 'string') {
                        try { rd = JSON.parse(rd); } catch (_) { return `<div class="text-gray-300 text-sm">${escapeHtml(rd)}</div>`; }
                    }
                    if (typeof rd !== 'object' || rd === null) return '';
                    const entries = Object.entries(rd).filter(([k, v]) => v !== undefined && v !== null && v !== '');
                    if (entries.length === 0) return '';
                    const rows = entries.map(([k, v]) => {
                        const val = typeof v === 'object' ? JSON.stringify(v) : String(v);
                        return `<tr class="border-b border-gray-700/50"><td class="py-2 pr-4 text-gray-400 font-medium whitespace-nowrap">${escapeHtml(friendlyLabel(k))}</td><td class="py-2 text-gray-200">${escapeHtml(val)}</td></tr>`;
                    }).join('');
                    return `<div class="overflow-x-auto"><table class="w-full text-sm"><tbody>${rows}</tbody></table></div>`;
                }
                
                document.getElementById('approval-count-subtitle').textContent = 
                    `${approvals.length} item${approvals.length !== 1 ? 's' : ''} waiting for your decision`;
                
                const container = document.getElementById('approval-list');
                
                if (approvals.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-10 text-gray-500">
                            <span class="text-4xl mb-4 block">âœ…</span>
                            <p>No pending approvals</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = approvals.map(approval => `
                        <div class="card rounded-xl p-4 border-l-4 border-l-yellow-500">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <h4 class="font-semibold">${approval.title || 'Approval'}</h4>
                                    <p class="text-sm text-gray-400">${approval.description || ''}</p>
                                    <p class="text-xs text-gray-500 mt-1">${assigneeDisplay(approval)}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded bg-yellow-500/20 text-yellow-400">${approval.priority || 'normal'}</span>
                            </div>
                            
                            ${(() => { const html = renderReviewData(approval.review_data || approval.details_to_review); return html ? `
                                <div class="bg-gray-800/80 rounded-lg p-4 mb-3 text-sm border border-gray-700/50">
                                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Details to review</div>
                                    ${html}
                                </div>
                            ` : ''; })()}
                            
                            <div class="flex gap-3">
                                <button onclick="approveRequest('${approval.id}')" class="flex-1 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white font-medium transition">
                                    âœ… Approve
                                </button>
                                <button onclick="rejectRequest('${approval.id}')" class="flex-1 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium transition">
                                    âŒ Reject
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('approval-dashboard-modal').classList.remove('hidden');
                
            } catch(e) {
                console.error('Error loading approvals:', e);
                showToast('Could not load approvals', 'error');
            }
        }
        
        // Approve Request
        async function approveRequest(approvalId) {
            const comments = prompt('Add comments (optional):');
            
            try {
                const response = await fetch(API + `/process/approvals/${approvalId}/decide`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        decision: 'approved',
                        comments: comments || ''
                    })
                });
                
                if (response.ok) {
                    showToast('Request approved', 'success');
                    openApprovalDashboard(); // Refresh list
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Could not approve', 'error');
                }
            } catch(e) {
                showToast('Could not approve request', 'error');
            }
        }
        
        // Reject Request
        async function rejectRequest(approvalId) {
            const comments = prompt('Reason for rejection:');
            if (comments === null) return; // User cancelled
            
            try {
                const response = await fetch(API + `/process/approvals/${approvalId}/decide`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        decision: 'rejected',
                        comments: comments || 'Rejected'
                    })
                });
                
                if (response.ok) {
                    showToast('Request rejected', 'success');
                    openApprovalDashboard(); // Refresh list
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Could not reject', 'error');
                }
            } catch(e) {
                showToast('Could not reject request', 'error');
            }
        }
        
        // Close Approval Dashboard
        function closeApprovalDashboard() {
            document.getElementById('approval-dashboard-modal').classList.add('hidden');
        }
        
        // ============================================================================
        // PROCESS VISUAL EDITOR
        // ============================================================================
        
        let editingProcessAgent = null;
        
        // Open Process Editor for existing workflow agent
        function openProcessEditor(agent) {
            // Open the full visual workflow builder
            window.open(`/ui/process-builder.html?agent=${agent.id}`, '_blank');
        }
        
        // Create Process Editor Modal
        function createProcessEditorModal() {
            const modalHtml = `
                <div id="process-editor-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[60]" onclick="if(event.target===this)closeProcessEditor()">
                    <div class="card rounded-xl w-full max-w-5xl mx-4 max-h-[90vh] flex flex-col overflow-hidden" onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between flex-shrink-0" style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(20,184,166,0.1));">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-2xl">âœï¸</div>
                                <div>
                                    <h3 id="process-editor-title" class="text-lg font-bold">Edit Workflow</h3>
                                    <p class="text-sm text-gray-400">Modify workflow steps and configuration</p>
                                </div>
                            </div>
                            <button onclick="closeProcessEditor()" class="text-gray-400 hover:text-white text-2xl px-2">âœ•</button>
                        </div>
                        
                        <!-- Content -->
                        <div class="flex-1 overflow-y-auto p-6">
                            <!-- Basic Info -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Workflow Name</label>
                                    <input type="text" id="process-editor-name" class="input-field w-full rounded-lg px-4 py-3" placeholder="My Workflow">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Goal / Description</label>
                                    <input type="text" id="process-editor-goal" class="input-field w-full rounded-lg px-4 py-3" placeholder="What does this workflow do?">
                                </div>
                            </div>
                            
                            <!-- Workflow Steps -->
                            <div class="mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-semibold flex items-center gap-2">ðŸ”„ Workflow Steps</h4>
                                    <button onclick="addWorkflowNode()" class="text-sm px-3 py-1.5 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 transition">
                                        + Add Step
                                    </button>
                                </div>
                                <div id="workflow-nodes-container" class="space-y-3">
                                    <!-- Nodes will be rendered here -->
                                </div>
                            </div>
                            
                            <!-- Add Node Panel (hidden by default) -->
                            <div id="add-node-panel" class="hidden mb-6 p-4 rounded-lg border border-dashed border-gray-600">
                                <h5 class="font-medium mb-3">Select Step Type</h5>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    <button onclick="insertNode('action')" class="p-3 rounded-lg bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/30 text-center transition">
                                        <span class="text-2xl block mb-1">âš¡</span>
                                        <span class="text-sm">Action</span>
                                    </button>
                                    <button onclick="insertNode('condition')" class="p-3 rounded-lg bg-yellow-500/10 hover:bg-yellow-500/20 border border-yellow-500/30 text-center transition">
                                        <span class="text-2xl block mb-1">ðŸ”€</span>
                                        <span class="text-sm">Condition</span>
                                    </button>
                                    <button onclick="insertNode('approval')" class="p-3 rounded-lg bg-orange-500/10 hover:bg-orange-500/20 border border-orange-500/30 text-center transition">
                                        <span class="text-2xl block mb-1">âœ…</span>
                                        <span class="text-sm">Approval</span>
                                    </button>
                                    <button onclick="insertNode('notification')" class="p-3 rounded-lg bg-purple-500/10 hover:bg-purple-500/20 border border-purple-500/30 text-center transition">
                                        <span class="text-2xl block mb-1">ðŸ“§</span>
                                        <span class="text-sm">Notify</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="p-4 border-t border-gray-700 flex justify-between items-center flex-shrink-0">
                            <button onclick="closeProcessEditor()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                            <div class="flex gap-3">
                                <button onclick="testWorkflow()" class="px-4 py-2 rounded-lg border border-gray-600 hover:bg-gray-700 transition">
                                    ðŸ§ª Test
                                </button>
                                <button onclick="saveProcessChanges()" class="px-6 py-2 rounded-lg text-white font-medium" style="background: linear-gradient(135deg, #22c55e 0%, #14b8a6 100%);">
                                    ðŸ’¾ Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Approval step config modal (approvers from Platform User/Role/Group or Tool) -->
                <div id="approval-config-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-[70]" onclick="if(event.target===this)closeApprovalConfigModal()">
                    <div class="card rounded-xl w-full max-w-lg mx-4 p-6" onclick="event.stopPropagation()">
                        <h3 class="text-lg font-bold mb-4">âœ… Approval Step Configuration</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Title</label>
                                <input type="text" id="approval-config-title" class="input-field w-full rounded-lg px-4 py-2" placeholder="Approval Required">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Description</label>
                                <input type="text" id="approval-config-description" class="input-field w-full rounded-lg px-4 py-2" placeholder="Optional">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Approvers from</label>
                                <select id="approval-config-source" onchange="onApprovalConfigSourceChange()" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="platform_user">Platform User</option>
                                    <option value="platform_role">Platform Role</option>
                                    <option value="platform_group">Platform Group</option>
                                    <option value="tool">Tool</option>
                                </select>
                            </div>
                            <div id="approval-config-platform-user-wrap" class="hidden">
                                <label class="block text-sm text-gray-400 mb-1">Select users</label>
                                <select id="approval-config-user-list" multiple class="input-field w-full rounded-lg px-4 py-2 h-32"></select>
                            </div>
                            <div id="approval-config-platform-role-wrap" class="hidden">
                                <label class="block text-sm text-gray-400 mb-1">Select roles</label>
                                <select id="approval-config-role-list" multiple class="input-field w-full rounded-lg px-4 py-2 h-32"></select>
                            </div>
                            <div id="approval-config-platform-group-wrap" class="hidden">
                                <label class="block text-sm text-gray-400 mb-1">Select groups</label>
                                <select id="approval-config-group-list" multiple class="input-field w-full rounded-lg px-4 py-2 h-32"></select>
                            </div>
                            <div id="approval-config-tool-wrap" class="hidden">
                                <label class="block text-sm text-gray-400 mb-1">Select tool (configured only)</label>
                                <select id="approval-config-tool" class="input-field w-full rounded-lg px-4 py-2">
                                    <option value="">â€” None â€”</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Timeout (hours)</label>
                                <input type="number" id="approval-config-timeout" class="input-field w-full rounded-lg px-4 py-2" value="24" min="1">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeApprovalConfigModal()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                            <button onclick="saveApprovalConfig()" class="btn-primary flex-1 py-2 rounded-lg">Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Render workflow nodes in editor
        function renderWorkflowNodes(workflow) {
            const container = document.getElementById('workflow-nodes-container');
            const nodes = workflow.nodes || [];
            
            if (nodes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 border border-dashed border-gray-700 rounded-lg">
                        <span class="text-3xl block mb-2">ðŸ“­</span>
                        <p>No steps yet. Click "Add Step" to begin.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = nodes.map((node, index) => {
                const typeIcons = {
                    trigger: 'ðŸŽ¯',
                    action: 'âš¡',
                    condition: 'ðŸ”€',
                    approval: 'âœ…',
                    notification: 'ðŸ“§',
                    end: 'ðŸ'
                };
                
                const typeColors = {
                    trigger: 'border-green-500/30 bg-green-500/5',
                    action: 'border-blue-500/30 bg-blue-500/5',
                    condition: 'border-yellow-500/30 bg-yellow-500/5',
                    approval: 'border-orange-500/30 bg-orange-500/5',
                    notification: 'border-purple-500/30 bg-purple-500/5',
                    end: 'border-gray-500/30 bg-gray-500/5'
                };
                
                const icon = typeIcons[node.type] || 'ðŸ“¦';
                const colorClass = typeColors[node.type] || 'border-gray-600';
                
                return `
                    <div class="p-4 rounded-lg border ${colorClass} group" data-node-index="${index}">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gray-800 flex items-center justify-center text-xl flex-shrink-0">
                                ${icon}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <input type="text" 
                                           class="input-field flex-1 rounded px-2 py-1 text-sm font-medium" 
                                           value="${node.name || node.type}" 
                                           onchange="updateNodeName(${index}, this.value)"
                                           placeholder="Step name">
                                    <span class="text-xs px-2 py-0.5 rounded bg-gray-700 text-gray-400">${node.type}</span>
                                </div>
                                ${node.config ? `
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${Object.entries(node.config).slice(0, 2).map(([k, v]) => 
                                            `<span class="mr-2">${k}: ${typeof v === 'string' ? v.substring(0, 20) : JSON.stringify(v).substring(0, 20)}...</span>`
                                        ).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="editNodeConfig(${index})" class="p-1.5 rounded hover:bg-gray-700" title="Configure">âš™ï¸</button>
                                <button onclick="moveNodeUp(${index})" class="p-1.5 rounded hover:bg-gray-700 ${index === 0 ? 'opacity-30' : ''}" title="Move Up">â¬†ï¸</button>
                                <button onclick="moveNodeDown(${index})" class="p-1.5 rounded hover:bg-gray-700 ${index === nodes.length - 1 ? 'opacity-30' : ''}" title="Move Down">â¬‡ï¸</button>
                                <button onclick="deleteNode(${index})" class="p-1.5 rounded hover:bg-red-500/20 text-red-400" title="Delete">ðŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Add new workflow node
        function addWorkflowNode() {
            const panel = document.getElementById('add-node-panel');
            panel.classList.toggle('hidden');
        }
        
        // Insert a new node of specific type
        function insertNode(type) {
            if (!editingProcessAgent) return;
            
            const workflow = editingProcessAgent.process_definition || { nodes: [], edges: [] };
            
            const newNode = {
                id: 'node_' + Date.now(),
                type: type,
                name: type.charAt(0).toUpperCase() + type.slice(1) + ' ' + (workflow.nodes.length + 1),
                config: {}
            };
            
            // Set default config based on type
            switch(type) {
                case 'action':
                    newNode.config = { action_type: 'api_call', description: '' };
                    break;
                case 'condition':
                    newNode.config = { condition: '', true_next: '', false_next: '' };
                    break;
                case 'approval':
                    newNode.config = { assignee_source: 'platform_user', assignee_type: 'user', assignee_ids: [], timeout_hours: 24 };
                    break;
                case 'notification':
                    newNode.config = { channel: 'email', template: '' };
                    break;
            }
            
            workflow.nodes.push(newNode);
            editingProcessAgent.process_definition = workflow;
            
            // Re-render and hide panel
            renderWorkflowNodes(workflow);
            document.getElementById('add-node-panel').classList.add('hidden');
            
            showToast('Step added', 'success');
        }
        
        // Update node name
        function updateNodeName(index, newName) {
            if (!editingProcessAgent) return;
            const workflow = editingProcessAgent.process_definition;
            if (workflow.nodes[index]) {
                workflow.nodes[index].name = newName;
            }
        }
        
        // Move node up
        function moveNodeUp(index) {
            if (!editingProcessAgent || index === 0) return;
            const workflow = editingProcessAgent.process_definition;
            const nodes = workflow.nodes;
            [nodes[index], nodes[index - 1]] = [nodes[index - 1], nodes[index]];
            renderWorkflowNodes(workflow);
        }
        
        // Move node down
        function moveNodeDown(index) {
            if (!editingProcessAgent) return;
            const workflow = editingProcessAgent.process_definition;
            const nodes = workflow.nodes;
            if (index >= nodes.length - 1) return;
            [nodes[index], nodes[index + 1]] = [nodes[index + 1], nodes[index]];
            renderWorkflowNodes(workflow);
        }
        
        // Delete node
        function deleteNode(index) {
            if (!editingProcessAgent) return;
            if (!confirm('Delete this step?')) return;
            
            const workflow = editingProcessAgent.process_definition;
            workflow.nodes.splice(index, 1);
            renderWorkflowNodes(workflow);
            showToast('Step deleted', 'info');
        }
        
        // Edit node configuration (approval node opens dedicated modal; others use JSON prompt)
        let approvalConfigNodeIndex = -1;
        function editNodeConfig(index) {
            if (!editingProcessAgent) return;
            const workflow = editingProcessAgent.process_definition;
            const node = workflow.nodes[index];
            if (node.type === 'approval') {
                approvalConfigNodeIndex = index;
                openApprovalConfigModal(node.config || {});
                return;
            }
            const configStr = prompt('Edit configuration (JSON):', JSON.stringify(node.config || {}, null, 2));
            if (configStr !== null) {
                try {
                    node.config = JSON.parse(configStr);
                    renderWorkflowNodes(workflow);
                    showToast('Configuration updated', 'success');
                } catch(e) {
                    showToast('Invalid JSON', 'error');
                }
            }
        }
        
        // Approval config modal: approvers from Platform User / Role / Group / Tool
        async function openApprovalConfigModal(currentConfig) {
            const modal = document.getElementById('approval-config-modal');
            if (!modal) return;
            let source = currentConfig.assignee_source || '';
            if (!source && currentConfig.assignee_type) source = 'platform_' + currentConfig.assignee_type;
            if (!source) source = 'platform_user';
            const assigneeType = currentConfig.assignee_type || 'user';
            const assigneeIds = currentConfig.assignee_ids || currentConfig.approvers || [];
            const assigneeToolId = currentConfig.assignee_tool_id || '';
            const title = currentConfig.title || 'Approval Required';
            const description = currentConfig.description || '';
            const timeoutHours = currentConfig.timeout_hours != null ? currentConfig.timeout_hours : 24;
            
            const headers = getAuthHeaders();
            let users = [], roles = [], groups = [], tools = [];
            try {
                const [uRes, rRes, gRes, tRes] = await Promise.all([
                    fetch(API + '/api/security/users', { headers }),
                    fetch(API + '/api/security/roles', { headers }),
                    fetch(API + '/api/security/groups', { headers }),
                    fetch(API + '/api/tools/accessible', { headers })
                ]);
                if (uRes.ok) { const d = await uRes.json(); users = Array.isArray(d) ? d : (d.users || []); }
                if (rRes.ok) { const d = await rRes.json(); roles = Array.isArray(d) ? d : (d.roles || []); }
                if (gRes.ok) { const d = await gRes.json(); groups = Array.isArray(d) ? d : (d.groups || []); }
                if (tRes.ok) { const d = await tRes.json(); tools = d.tools || []; }
            } catch (e) {
                console.error('Load approval options:', e);
            }
            
            const userOptions = users.map(u => `<option value="${u.id}" ${assigneeIds.includes(u.id) ? 'selected' : ''}>${(u.name || u.email || u.id).substring(0, 40)}</option>`).join('');
            const roleOptions = roles.map(r => `<option value="${r.id}" ${assigneeIds.includes(r.id) ? 'selected' : ''}>${(r.name || r.id).substring(0, 40)}</option>`).join('');
            const groupOptions = groups.map(g => `<option value="${g.id}" ${assigneeIds.includes(g.id) ? 'selected' : ''}>${(g.name || g.id).substring(0, 40)}</option>`).join('');
            const toolOptions = tools.map(t => `<option value="${t.id}" ${assigneeToolId === t.id ? 'selected' : ''}>${(t.name || t.id).substring(0, 40)}</option>`).join('');
            
            document.getElementById('approval-config-title').value = title;
            document.getElementById('approval-config-description').value = description;
            document.getElementById('approval-config-timeout').value = timeoutHours;
            document.getElementById('approval-config-source').value = source;
            document.getElementById('approval-config-user-list').innerHTML = userOptions;
            document.getElementById('approval-config-role-list').innerHTML = roleOptions;
            document.getElementById('approval-config-group-list').innerHTML = groupOptions;
            document.getElementById('approval-config-tool').innerHTML = '<option value="">â€” None â€”</option>' + (toolOptions || '');
            document.getElementById('approval-config-tool').value = assigneeToolId;
            
            document.getElementById('approval-config-platform-user-wrap').classList.toggle('hidden', source !== 'platform_user');
            document.getElementById('approval-config-platform-role-wrap').classList.toggle('hidden', source !== 'platform_role');
            document.getElementById('approval-config-platform-group-wrap').classList.toggle('hidden', source !== 'platform_group');
            document.getElementById('approval-config-tool-wrap').classList.toggle('hidden', source !== 'tool');
            
            modal.classList.remove('hidden');
        }
        function onApprovalConfigSourceChange() {
            const v = document.getElementById('approval-config-source').value;
            document.getElementById('approval-config-platform-user-wrap').classList.toggle('hidden', v !== 'platform_user');
            document.getElementById('approval-config-platform-role-wrap').classList.toggle('hidden', v !== 'platform_role');
            document.getElementById('approval-config-platform-group-wrap').classList.toggle('hidden', v !== 'platform_group');
            document.getElementById('approval-config-tool-wrap').classList.toggle('hidden', v !== 'tool');
        }
        function saveApprovalConfig() {
            if (!editingProcessAgent || approvalConfigNodeIndex < 0) return;
            const workflow = editingProcessAgent.process_definition;
            const node = workflow.nodes[approvalConfigNodeIndex];
            const source = document.getElementById('approval-config-source').value;
            const userList = document.getElementById('approval-config-user-list');
            const roleList = document.getElementById('approval-config-role-list');
            const groupList = document.getElementById('approval-config-group-list');
            const toolSelect = document.getElementById('approval-config-tool');
            const assigneeIds = [];
            if (source === 'platform_user') {
                for (let i = 0; i < userList.options.length; i++) if (userList.options[i].selected) assigneeIds.push(userList.options[i].value);
            } else if (source === 'platform_role') {
                for (let i = 0; i < roleList.options.length; i++) if (roleList.options[i].selected) assigneeIds.push(roleList.options[i].value);
            } else if (source === 'platform_group') {
                for (let i = 0; i < groupList.options.length; i++) if (groupList.options[i].selected) assigneeIds.push(groupList.options[i].value);
            }
            const assigneeType = source === 'platform_user' ? 'user' : source === 'platform_role' ? 'role' : source === 'platform_group' ? 'group' : 'user';
            node.config = {
                assignee_source: source,
                assignee_type: assigneeType,
                assignee_ids: assigneeIds,
                assignee_tool_id: source === 'tool' ? (toolSelect.value || '') : undefined,
                title: document.getElementById('approval-config-title').value.trim() || 'Approval Required',
                description: document.getElementById('approval-config-description').value.trim(),
                timeout_hours: parseInt(document.getElementById('approval-config-timeout').value, 10) || 24
            };
            document.getElementById('approval-config-modal').classList.add('hidden');
            approvalConfigNodeIndex = -1;
            renderWorkflowNodes(workflow);
            showToast('Approval configuration updated', 'success');
        }
        function closeApprovalConfigModal() {
            document.getElementById('approval-config-modal').classList.add('hidden');
            approvalConfigNodeIndex = -1;
        }
        
        // Test the workflow
        function testWorkflow() {
            if (!editingProcessAgent) return;
            closeProcessEditor();
            openProcessExecution(editingProcessAgent.id);
        }
        
        // Save process changes
        async function saveProcessChanges() {
            if (!editingProcessAgent) return;
            
            const name = document.getElementById('process-editor-name').value.trim();
            const goal = document.getElementById('process-editor-goal').value.trim();
            
            if (!name) {
                showToast('Please enter a workflow name', 'error');
                return;
            }
            
            try {
                const response = await fetch(API + '/api/agents/' + editingProcessAgent.id, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        name: name,
                        goal: goal,
                        process_definition: editingProcessAgent.process_definition
                    })
                });
                
                if (response.ok) {
                    showToast('Workflow saved!', 'success');
                    closeProcessEditor();
                    loadAgents();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Could not save', 'error');
                }
            } catch(e) {
                showToast('Could not save workflow', 'error');
            }
        }
        
        // Close process editor
        function closeProcessEditor() {
            const modal = document.getElementById('process-editor-modal');
            if (modal) modal.classList.add('hidden');
            editingProcessAgent = null;
        }
        
        // Open Visual Workflow Builder
        function openVisualBuilder() {
            // So the new tab can read the token: copy sessionStorage â†’ localStorage if needed
            const sessionToken = sessionStorage.getItem('agentforge_token');
            if (sessionToken && !localStorage.getItem('agentforge_token')) {
                localStorage.setItem('agentforge_token', sessionToken);
                const u = sessionStorage.getItem('agentforge_user');
                if (u) localStorage.setItem('agentforge_user', u);
            }
            const newWindow = window.open('/ui/process-builder.html', '_blank');
            if (!newWindow) {
                showToast('Please allow popups to open the Visual Builder', 'warning');
            }
        }
        
        // Show AI Workflow Input
        function showAIWorkflowInput() {
            document.getElementById('ai-workflow-input').classList.remove('hidden');
            document.getElementById('workflow-templates').classList.add('hidden');
        }
        
        // Hide AI Workflow Input
        function hideAIWorkflowInput() {
            document.getElementById('ai-workflow-input').classList.add('hidden');
            document.getElementById('workflow-templates').classList.remove('hidden');
        }
        
        // Open Builder with Template
        function openBuilderWithTemplate(template) {
            window.open(`/ui/process-builder.html?template=${template}`, '_blank');
        }
        
        // Process Templates (Legacy)
        function useProcessTemplate(template) {
            const templates = {
                approval: "When a request is submitted, check if the amount is over $500. If yes, send to manager for approval. Notify the requester of the decision and update the system.",
                onboarding: "When a new employee joins, create their accounts, send welcome email, schedule orientation, assign a buddy, and notify IT and HR.",
                notification: "Monitor for important events. When triggered, send notifications via email and Slack to the relevant team members.",
                data_sync: "Every hour, fetch data from the external API, validate and transform it, then update our database and log the results."
            };
            
            const goalField = document.getElementById('w-process-goal');
            if (goalField) {
                goalField.value = templates[template] || '';
            }
        }
        
        // Generate Agent Configuration using AI
        async function generateAgentConfig() {
            const goal = document.getElementById('w-initial-goal').value.trim();
            if(!goal) {
                alert('Please describe what your agent should do');
                return;
            }
            
            wizard.originalGoal = goal;
            
            // Show generating animation
            document.getElementById('wizard-step-0').classList.add('hidden');
            document.getElementById('wizard-generating').classList.remove('hidden');
            
            // Animate steps
            const steps = ['gen-step-1', 'gen-step-2', 'gen-step-3', 'gen-step-4', 'gen-step-5'];
            const statuses = [
                'Understanding your requirements...',
                'Selecting optimal AI model...',
                'Defining tasks & capabilities...',
                'Recommending tools...',
                'Setting up guardrails...'
            ];
            
            for(let i=0; i<steps.length; i++) {
                await new Promise(r => setTimeout(r, 600));
                document.getElementById('generating-status').textContent = statuses[i];
                
                // Mark previous as done
                if(i > 0) {
                    const prev = document.getElementById(steps[i-1]);
                    prev.querySelector('span').className = 'w-5 h-5 rounded-full bg-green-500 flex items-center justify-center';
                    prev.querySelector('span').textContent = 'âœ“';
                    prev.classList.remove('text-gray-500');
                }
                
                // Activate current
                const curr = document.getElementById(steps[i]);
                curr.querySelector('span').className = 'w-5 h-5 rounded-full bg-purple-500 flex items-center justify-center animate-pulse';
                curr.classList.remove('text-gray-500');
            }
            
            // Mark last as done
            await new Promise(r => setTimeout(r, 400));
            const last = document.getElementById(steps[steps.length-1]);
            last.querySelector('span').className = 'w-5 h-5 rounded-full bg-green-500 flex items-center justify-center';
            last.querySelector('span').textContent = 'âœ“';
            
            try {
                // Call AI to generate configuration - 100% dynamic, no fallback
                const response = await fetch(API + '/api/agents/generate-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ goal })
                });
                
                if(response.ok) {
                    const config = await response.json();
                    applyGeneratedConfig(config);
                } else {
                    // Show error - no local fallback
                    const error = await response.json().catch(() => ({}));
                    alert('Failed to generate agent configuration: ' + (error.detail || 'Please check your LLM settings.'));
                    document.getElementById('wizard-generating').classList.add('hidden');
                    document.getElementById('wizard-step-0').classList.remove('hidden');
                    return;
                }
            } catch(e) {
                console.error('Config generation error:', e);
                alert('Failed to connect to AI service. Please check your settings and try again.');
                document.getElementById('wizard-generating').classList.add('hidden');
                document.getElementById('wizard-step-0').classList.remove('hidden');
                return;
            }
            
            // Move to step 1
            await new Promise(r => setTimeout(r, 500));
            step = 1;
            updateStepsNew();
        }
        
        
        function applyGeneratedConfig(config) {
            console.log('=== applyGeneratedConfig called ===');
            console.log('Received config:', JSON.stringify(config, null, 2));
            
            // Set all wizard properties from API response (no defaults!)
            wizard.name = config.name;
            wizard.icon = config.icon;
            wizard.goal = config.goal;
            wizard.model = config.model;
            wizard.modelReason = config.modelReason;  // Store for display
            wizard.tasks = Array.isArray(config.tasks) ? config.tasks : [];
            wizard.suggestedTools = Array.isArray(config.suggestedTools) ? config.suggestedTools : [];
            wizard.personality = config.personality;
            wizard.guardrails = config.guardrails;
            
            // Store personality descriptions from API
            if (config.personalityDescriptions) {
                apiPersonalityDescriptions = config.personalityDescriptions;
            }
            
            // Store the goal for debounce comparison
            lastGoalText = wizard.goal;
            
            console.log('Wizard state after assignment:');
            console.log('- name:', wizard.name);
            console.log('- model:', wizard.model);
            console.log('- modelReason:', wizard.modelReason);
            console.log('- personality:', wizard.personality);
            
            // Apply to form elements
            const nameEl = document.getElementById('w-name');
            const iconEl = document.getElementById('w-icon');
            const goalEl = document.getElementById('w-goal');
            
            if(nameEl) nameEl.value = wizard.name || '';
            if(iconEl) iconEl.value = wizard.icon || 'ðŸ¤–';
            if(goalEl) goalEl.value = wizard.goal || '';
            
            // Set personality sliders from API response
            if (config.personality) {
                const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
                traits.forEach(trait => {
                    const value = config.personality[trait];
                    if (value !== undefined) {
                        const slider = document.getElementById(`p-${trait}`);
                        const numInput = document.getElementById(`p-${trait}-num`);
                        if (slider) slider.value = value;
                        if (numInput) numInput.value = value;
                    }
                });
                
                // Show personality reason if provided
                if (config.personalityReason) {
                    const previewEl = document.getElementById('personality-preview-text');
                    if (previewEl) {
                        previewEl.textContent = config.personalityReason;
                    }
                }
                
                // Update individual trait descriptions
                if (config.personalityDescriptions) {
                    traits.forEach(trait => {
                        const desc = config.personalityDescriptions[trait + 'Desc'];
                        const descEl = document.getElementById(`p-${trait}-desc`);
                        if (desc && descEl) {
                            descEl.textContent = desc;
                        }
                    });
                }
            }
            
            // Update model selection UI
            selectModel(wizard.model);
            
            // Update model explanation from API
            const modelWhyEl = document.getElementById('model-why-text');
            if(modelWhyEl && config.modelReason) {
                modelWhyEl.textContent = config.modelReason;
            }
            
            // Render tasks
            renderTasks();
            
            console.log('applyGeneratedConfig complete');
        }
        
        // ========== ICON MANAGEMENT ==========
        
        function handleIconUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 500KB)
            if (file.size > 500 * 1024) {
                alert('Image too large. Maximum size is 500KB.');
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                
                // Update preview
                document.getElementById('w-icon-emoji').classList.add('hidden');
                const imgEl = document.getElementById('w-icon-image');
                imgEl.src = base64Data;
                imgEl.classList.remove('hidden');
                
                // Store data
                document.getElementById('w-icon-type').value = 'image';
                document.getElementById('w-icon-data').value = base64Data;
                document.getElementById('w-icon').value = 'ðŸ“·'; // Fallback
                
                wizard.icon = 'ðŸ“·';
                wizard.iconType = 'image';
                wizard.iconData = base64Data;
            };
            reader.readAsDataURL(file);
        }
        
        function showIconPicker() {
            // Populate emoji grid
            const emojis = ['ðŸ¤–','ðŸŽ¯','ðŸ’¼','ðŸŽ§','ðŸ“Š','ðŸ›’','ðŸ“§','ðŸ”§','ðŸ’¡','ðŸŽ“','ðŸ¥','ðŸ¦','âœˆï¸','ðŸ”','ðŸ ','âš¡','ðŸ”’','ðŸ“±','ðŸŒ','ðŸ’¬','ðŸ“‹','ðŸŽ¨','ðŸ”¬','âš™ï¸','ðŸš€','ðŸ’°','ðŸ“ˆ','ðŸŽ®','ðŸ¤','ðŸŒŸ','ðŸ‘¨â€ðŸ’»','ðŸ‘©â€ðŸ’¼','ðŸ¢','ðŸ“¦','ðŸ› ï¸','ðŸ’³','ðŸ“ž','ðŸ—‚ï¸','ðŸ”','ðŸ“','ðŸŽª','ðŸŽ­','ðŸŽ¬','ðŸ†','ðŸŽ–ï¸','ðŸ‘”','ðŸ‘—','ðŸ›¡ï¸','âš–ï¸','ðŸ“œ'];
            const grid = document.getElementById('emoji-grid');
            if (grid) {
                grid.innerHTML = emojis.map(e => 
                    `<button onclick="selectEmoji('${e}')" class="w-8 h-8 text-lg hover:bg-gray-700 rounded transition">${e}</button>`
                ).join('');
            }
            console.log('ðŸŽ¯ [openIconPicker] Opening icon-picker-modal');
            const modal = document.getElementById('icon-picker-modal');
            if (!modal) {
                console.error('âŒ [openIconPicker] Modal not found!');
                return;
            }
            ensureModalInBody('icon-picker-modal');
            modal.classList.remove('hidden');
            console.log('âœ… [openIconPicker] Modal opened:', {
                classes: modal.className,
                display: window.getComputedStyle(modal).display,
                isVisible: modal.offsetParent !== null
            });
        }
        
        function closeIconPicker() {
            document.getElementById('icon-picker-modal').classList.add('hidden');
        }
        
        function selectEmoji(emoji) {
            // Update preview
            document.getElementById('w-icon-image').classList.add('hidden');
            const emojiEl = document.getElementById('w-icon-emoji');
            emojiEl.textContent = emoji;
            emojiEl.classList.remove('hidden');
            
            // Store data
            document.getElementById('w-icon-type').value = 'emoji';
            document.getElementById('w-icon-data').value = '';
            document.getElementById('w-icon').value = emoji;
            
            wizard.icon = emoji;
            wizard.iconType = 'emoji';
            wizard.iconData = '';
            
            closeIconPicker();
        }
        
        // ========== LLM MODEL MANAGEMENT - 100% DYNAMIC ==========
        // No hardcoded model config - everything comes from API
        
        async function loadLLMModels() {
            const container = document.getElementById('llm-models-list');
            if (!container) return;
            
            // Fetch current settings to get configured providers
            let settings = {};
            try {
                const r = await fetch(API + '/api/settings');
                const data = await r.json();
                settings = data.settings || data || {};
            } catch (e) {
                console.log('Could not fetch settings:', e);
            }
            
            const llmProviders = settings.llm_providers || [];
            
            if (llmProviders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6">
                        <span class="text-3xl">âš ï¸</span>
                        <p class="text-sm text-gray-400 mt-3">No AI models configured</p>
                        <p class="text-xs text-gray-500 mt-1">Add API keys in Settings to enable AI models</p>
                        <button onclick="navigate('settings')" class="mt-4 btn-primary px-4 py-2 rounded-lg text-sm">
                            âš™ï¸ Configure API Keys
                        </button>
                    </div>
                `;
                return;
            }
            
            // Build list of available models from configured providers
            const availableModels = [];
            for (const provider of llmProviders) {
                const providerModels = provider.models || [];
                for (const modelId of providerModels) {
                    availableModels.push({
                        id: modelId,
                        name: modelId,
                        provider: provider.provider,
                        providerName: provider.name
                    });
                }
            }
            
            // Check if wizard.model is available, if not use first available
            const currentModelAvailable = availableModels.some(m => m.id === wizard.model);
            if (!currentModelAvailable && availableModels.length > 0) {
                wizard.model = availableModels[0].id;
            }
            
            // Group models by provider
            const modelsByProvider = {};
            for (const model of availableModels) {
                const providerKey = model.providerName || model.provider;
                if (!modelsByProvider[providerKey]) {
                    modelsByProvider[providerKey] = [];
                }
                modelsByProvider[providerKey].push(model);
            }
            
            // Get provider icons
            const providerIcons = {
                'openai': 'ðŸŸ¢', 'OpenAI': 'ðŸŸ¢',
                'anthropic': 'ðŸŸ ', 'Anthropic': 'ðŸŸ ',
                'google': 'ðŸ”µ', 'Google': 'ðŸ”µ',
                'xai': 'âš«', 'xAI': 'âš«',
                'groq': 'ðŸŸ¡', 'Groq': 'ðŸŸ¡',
                'mistral': 'ðŸ”·', 'Mistral': 'ðŸ”·',
                'deepseek': 'ðŸ”¶', 'DeepSeek': 'ðŸ”¶',
                'together': 'ðŸŸ£', 'Together AI': 'ðŸŸ£',
                'perplexity': 'ðŸ”´', 'Perplexity': 'ðŸ”´',
                'cohere': 'ðŸŸ¤', 'Cohere': 'ðŸŸ¤',
                'ollama': 'ðŸ¦™', 'Ollama': 'ðŸ¦™',
                'lmstudio': 'ðŸ–¥ï¸', 'LM Studio': 'ðŸ–¥ï¸'
            };
            
            let html = '';
            
            // Show AI recommendation from API if available
            if (wizard.model && wizard.modelReason && wizard.goal) {
                html += `
                    <div class="mb-4 p-3 bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-purple-500/30 rounded-lg">
                        <div class="flex items-start gap-2">
                            <span class="text-lg">ðŸ’¡</span>
                            <div>
                                <p class="text-sm font-medium text-purple-300">AI Recommendation</p>
                                <p class="text-xs text-gray-400 mt-1">${wizard.modelReason}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Render models grouped by provider
            for (const [providerName, models] of Object.entries(modelsByProvider)) {
                const icon = providerIcons[providerName] || 'ðŸ¤–';
                
                html += `
                    <div class="mb-3">
                        <p class="text-xs text-gray-500 mb-2 flex items-center gap-1">
                            <span>${icon}</span> ${providerName}
                        </p>
                        <div class="space-y-2">
                `;
                
                for (const model of models) {
                    const isSelected = model.id === wizard.model;
                    const isRecommended = model.id === wizard.model && wizard.goal;
                    
                    const recommendedBadge = isRecommended
                        ? `<span class="text-[10px] bg-purple-500/30 text-purple-300 px-1.5 py-0.5 rounded ml-1">âœ¨ AI Selected</span>`
                        : '';
                    
                    html += `
                        <div class="p-2.5 rounded-lg cursor-pointer model-option transition-all ${isSelected ? 'border-2 border-purple-500 bg-purple-500/10' : 'border border-gray-700 hover:border-gray-500'}" 
                             data-model="${model.id}" onclick="selectModel('${model.id}')">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">${model.name}</span>
                                ${recommendedBadge}
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Update model explanation
            if (wizard.modelReason) {
                const modelWhyEl = document.getElementById('model-why-text');
                if (modelWhyEl) {
                    modelWhyEl.textContent = wizard.modelReason;
                }
            }
        }
        
        function selectModel(modelId) {
            wizard.model = modelId;
            
            // Update UI
            document.querySelectorAll('.model-option').forEach(el => {
                const isSelected = el.dataset.model === modelId;
                if (el.dataset.model) {
                    el.className = 'p-2.5 rounded-lg cursor-pointer model-option transition-all ' + 
                        (isSelected ? 'border-2 border-purple-500 bg-purple-500/10' : 'border border-gray-700 hover:border-gray-500');
                }
            });
            
            // Update explanation
            updateModelExplanation(modelId, wizard.goal);
        }
        
        function updateModelExplanation(modelId, goal) {
            const modelWhyEl = document.getElementById('model-why-text');
            if (!modelWhyEl) return;
            
            // Use the API-provided model reason (100% dynamic)
            if (wizard.modelReason) {
                modelWhyEl.textContent = wizard.modelReason;
            } else {
                // If no reason yet, show simple message
                modelWhyEl.textContent = `${modelId} selected for your agent.`;
            }
        }
        
        function renderTasks() {
            const container = document.getElementById('w-tasks');
            if(!container) return;
            
            const tasks = wizard.tasks || [];
            
            if(tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <span class="text-5xl block mb-3">ðŸ“‹</span>
                        <p class="text-lg font-medium mb-1">No tasks defined yet</p>
                        <p class="text-sm">Click "+ Add Task" to create your first task</p>
                    </div>
                `;
                return;
            }
            
            // Clean card view - click to edit via modal
            container.innerHTML = tasks.map((task, idx) => `
                <div class="card rounded-lg p-4 hover:bg-gray-800/80 transition cursor-pointer group" id="task-${idx}" data-task-idx="${idx}" onclick="editTask(${idx})">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-xl shrink-0">
                            ðŸ“‹
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-semibold text-white truncate">${escHtml(task.name || 'Untitled Task')}</h4>
                                <span class="text-xs px-2 py-0.5 rounded-full bg-gray-700 text-gray-400">
                                    ${(task.instructions || []).length} steps
                                </span>
                            </div>
                            <p class="text-sm text-gray-400 line-clamp-2">${escHtml(task.description || 'No description')}</p>
                            ${(task.instructions || []).length > 0 ? `
                                <div class="mt-2 text-xs text-gray-500">
                                    <span class="text-blue-400">1.</span> ${escHtml((task.instructions[0] || '').slice(0, 60))}${(task.instructions[0] || '').length > 60 ? '...' : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="event.stopPropagation(); editTask(${idx})" class="p-2 text-gray-400 hover:text-blue-400 hover:bg-blue-500/20 rounded-lg transition" title="Edit">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                            <button onclick="event.stopPropagation(); removeTask(${idx})" class="p-2 text-gray-400 hover:text-red-400 hover:bg-red-500/20 rounded-lg transition" title="Delete">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Auto-save task field
        function autoSaveTask(taskIdx, field, value) {
            if (wizard.tasks[taskIdx]) {
                wizard.tasks[taskIdx][field] = value;
            }
        }
        
        // Auto-save instruction
        function autoSaveInstruction(taskIdx, instIdx, value) {
            if (wizard.tasks[taskIdx] && wizard.tasks[taskIdx].instructions) {
                wizard.tasks[taskIdx].instructions[instIdx] = value;
            }
        }
        
        function addTask() {
            saveCurrentTaskEdits();  // Save current edits first
            wizard.tasks.push({ name: '', description: '', instructions: [] });
            renderTasks();
        }
        
        function removeTask(idx) {
            saveCurrentTaskEdits();  // Save current edits first
            wizard.tasks.splice(idx, 1);
            renderTasks();
        }
        
        function addInstruction(taskIdx) {
            saveCurrentTaskEdits();  // Save current edits first
            if(!wizard.tasks[taskIdx].instructions) wizard.tasks[taskIdx].instructions = [];
            wizard.tasks[taskIdx].instructions.push('');
            renderTasks();
            
            // Focus on the new instruction input
            setTimeout(() => {
                const taskEl = document.getElementById(`task-${taskIdx}`);
                if (taskEl) {
                    const inputs = taskEl.querySelectorAll('.inst-text');
                    if (inputs.length > 0) {
                        inputs[inputs.length - 1].focus();
                    }
                }
            }, 100);
        }
        
        // Drag & Drop for Instructions
        let draggedInstruction = null;
        
        function handleInstructionDragStart(e) {
            draggedInstruction = e.target.closest('.instruction-item');
            draggedInstruction.classList.add('opacity-50');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const container = e.target.closest('.insts');
            if (!container) return;
            
            const afterElement = getDragAfterElement(container, e.clientY);
            const dragging = document.querySelector('.instruction-item.opacity-50');
            if (dragging) {
                if (afterElement == null) {
                    container.appendChild(dragging);
                } else {
                    container.insertBefore(dragging, afterElement);
                }
            }
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.instruction-item:not(.opacity-50)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('opacity-50');
            draggedInstruction = null;
        }
        
        function handleInstructionDrop(e, taskIdx) {
            e.preventDefault();
            
            // Get new order from DOM
            const container = document.getElementById(`instructions-${taskIdx}`);
            const items = container.querySelectorAll('.instruction-item');
            const newInstructions = [];
            
            items.forEach(item => {
                const input = item.querySelector('.inst-text');
                if (input) {
                    newInstructions.push(input.value);
                }
            });
            
            // Update wizard data
            wizard.tasks[taskIdx].instructions = newInstructions;
            
            // Re-render to update numbers
            renderTasks();
        }

        function removeInstructionOriginal(taskIdx, instIdx) {
            saveCurrentTaskEdits();  // Save current edits first
            wizard.tasks[taskIdx].instructions.splice(instIdx, 1);
            renderTasks();
        }
        
        // Alias for backward compatibility
        function removeInstruction(taskIdx, instIdx) {
            removeInstructionOriginal(taskIdx, instIdx);
        }
        
        // Save current task edits from DOM to wizard.tasks
        function saveCurrentTaskEdits() {
            const taskElements = document.querySelectorAll('#w-tasks > div[id^="task-"]');
            
            taskElements.forEach((taskEl, idx) => {
                if (wizard.tasks[idx]) {
                    // Save task name
                    const nameInput = taskEl.querySelector('.task-name');
                    if (nameInput) wizard.tasks[idx].name = nameInput.value;
                    
                    // Save task description
                    const descInput = taskEl.querySelector('.task-desc');
                    if (descInput) wizard.tasks[idx].description = descInput.value;
                    
                    // Save instructions
                    const instInputs = taskEl.querySelectorAll('.inst-text');
                    wizard.tasks[idx].instructions = [];
                    instInputs.forEach(input => {
                        wizard.tasks[idx].instructions.push(input.value);
                    });
                }
            });
        }
        
        function collectTasksNew() {
            console.log('=== collectTasksNew called ===');
            
            // âœ¨ NEW APPROACH: Tasks are saved directly to wizard.tasks via modal
            // Just ensure tasks array exists and has valid data
            if (!wizard.tasks) {
                wizard.tasks = [];
            }
            
            // Clean up any empty tasks
            wizard.tasks = wizard.tasks.filter(task => task && task.name && task.name.trim());
            
            // Ensure all tasks have IDs
            wizard.tasks.forEach((task, idx) => {
                if (!task.id) {
                    task.id = `task_${Date.now()}_${idx}`;
                }
            });
            
            console.log('Tasks from wizard.tasks:', wizard.tasks.length);
            console.log('Task names:', wizard.tasks.map(t => t.name));
            
            // Sync task permissions - ensure all tasks have default permissions
            syncTaskPermissions();
        }
        
        // Sync task permissions with current tasks
        function syncTaskPermissions() {
            const tasks = wizard.tasks || [];
            
            // Add default permissions for new tasks
            tasks.forEach(task => {
                const taskId = task.id;
                const defaultKey = `${taskId}:default`;
                
                // If no permission exists for this task, set default to allowed
                if (wizardAccessState.taskPermissions[defaultKey] === undefined) {
                    wizardAccessState.taskPermissions[defaultKey] = true;
                }
            });
            
            console.log('Task permissions synced for', tasks.length, 'tasks');
        }
        
        // Tools with business explanations
        // Base tool info - will be customized based on agent goal
        const baseToolInfo = {
            knowledge: { icon: 'ðŸ§ ', name: 'Knowledge Base' },
            database: { icon: 'ðŸ—„ï¸', name: 'Database' },
            email: { icon: 'ðŸ“§', name: 'Email' },
            calendar: { icon: 'ðŸ“…', name: 'Calendar' },
            crm: { icon: 'ðŸŽ¯', name: 'CRM' },
            websearch: { icon: 'ðŸ”', name: 'Web Search' },
            code: { icon: 'ðŸ’»', name: 'Code Execution' },
            slack: { icon: 'ðŸ’¬', name: 'Messaging' }
        };
        
        // Generate dynamic tool info based on agent goal
        function getToolBusinessInfo(toolType) {
            const base = baseToolInfo[toolType] || { icon: 'ðŸ”§', name: toolType };
            const goal = (wizard.goal || wizard.originalGoal || '').toLowerCase();
            const agentName = wizard.name || 'Agent';
            
            // Dynamic descriptions based on goal context
            const contextualInfo = {
                knowledge: getKnowledgeInfo(goal, agentName),
                database: getDatabaseInfo(goal, agentName),
                email: getEmailInfo(goal, agentName),
                calendar: getCalendarInfo(goal, agentName),
                crm: getCrmInfo(goal, agentName),
                websearch: getWebSearchInfo(goal, agentName),
                code: getCodeInfo(goal, agentName),
                slack: getSlackInfo(goal, agentName)
            };
            
            return { ...base, ...contextualInfo[toolType] } || base;
        }
        
        function getKnowledgeInfo(goal, agentName) {
            if(goal.includes('customer') || goal.includes('support')) {
                return {
                    businessDesc: 'Access support documentation and FAQs',
                    examples: ['Support articles', 'Troubleshooting guides', 'Return policies', 'Product manuals'],
                    benefit: `${agentName} can answer customer questions using your support docs`
                };
            } else if(goal.includes('sales') || goal.includes('product')) {
                return {
                    businessDesc: 'Product information and sales materials',
                    examples: ['Product specs', 'Pricing sheets', 'Competitive analysis', 'Sales playbooks'],
                    benefit: `${agentName} can provide accurate product info to close deals`
                };
            } else if(goal.includes('hr') || goal.includes('employee')) {
                return {
                    businessDesc: 'HR policies and employee resources',
                    examples: ['Employee handbook', 'Benefits guide', 'Leave policies', 'Onboarding docs'],
                    benefit: `${agentName} can answer HR questions accurately`
                };
            } else if(goal.includes('research') || goal.includes('analysis')) {
                return {
                    businessDesc: 'Research documents and data sources',
                    examples: ['Research papers', 'Market reports', 'Data sets', 'Analysis templates'],
                    benefit: `${agentName} can reference existing research for better insights`
                };
            } else if(goal.includes('code') || goal.includes('developer')) {
                return {
                    businessDesc: 'Technical documentation and code references',
                    examples: ['API docs', 'Code standards', 'Architecture guides', 'Best practices'],
                    benefit: `${agentName} can provide consistent coding guidance`
                };
            }
            return {
                businessDesc: 'Your organization\'s documents and information',
                examples: ['Documentation', 'Guidelines', 'Procedures', 'Reference materials'],
                benefit: `${agentName} can answer questions using your content`
            };
        }
        
        function getDatabaseInfo(goal, agentName) {
            if(goal.includes('customer') || goal.includes('order')) {
                return {
                    businessDesc: 'Customer and order data access',
                    examples: ['Order status', 'Customer history', 'Shipping info', 'Payment records'],
                    benefit: `${agentName} can look up real-time order and customer info`
                };
            } else if(goal.includes('sales')) {
                return {
                    businessDesc: 'Sales and inventory data',
                    examples: ['Stock levels', 'Pricing', 'Discounts', 'Sales history'],
                    benefit: `${agentName} can check availability and pricing instantly`
                };
            } else if(goal.includes('hr') || goal.includes('employee')) {
                return {
                    businessDesc: 'Employee and HR records',
                    examples: ['Leave balances', 'Employee profiles', 'Attendance', 'Payroll info'],
                    benefit: `${agentName} can access employee data securely`
                };
            }
            return {
                businessDesc: 'Connect to your business databases',
                examples: ['Records lookup', 'Data queries', 'Status checks', 'History retrieval'],
                benefit: `${agentName} can fetch real-time data from your systems`
            };
        }
        
        function getEmailInfo(goal, agentName) {
            if(goal.includes('customer') || goal.includes('support')) {
                return {
                    businessDesc: 'Send support emails and confirmations',
                    examples: ['Ticket updates', 'Resolution confirmations', 'Follow-ups', 'Satisfaction surveys'],
                    benefit: `${agentName} can send timely support communications`
                };
            } else if(goal.includes('sales')) {
                return {
                    businessDesc: 'Sales outreach and follow-ups',
                    examples: ['Quote emails', 'Follow-up sequences', 'Meeting requests', 'Proposal delivery'],
                    benefit: `${agentName} can maintain sales momentum with timely emails`
                };
            } else if(goal.includes('hr')) {
                return {
                    businessDesc: 'HR communications and notifications',
                    examples: ['Policy updates', 'Leave approvals', 'Onboarding emails', 'Announcements'],
                    benefit: `${agentName} can handle routine HR communications`
                };
            }
            return {
                businessDesc: 'Automated email communications',
                examples: ['Notifications', 'Confirmations', 'Reports', 'Alerts'],
                benefit: `${agentName} can send emails automatically`
            };
        }
        
        function getCalendarInfo(goal, agentName) {
            if(goal.includes('sales') || goal.includes('meeting')) {
                return {
                    businessDesc: 'Schedule sales meetings and demos',
                    examples: ['Demo bookings', 'Follow-up calls', 'Team syncs', 'Client meetings'],
                    benefit: `${agentName} can book meetings without back-and-forth`
                };
            } else if(goal.includes('hr') || goal.includes('interview')) {
                return {
                    businessDesc: 'Manage interviews and HR appointments',
                    examples: ['Interview scheduling', '1:1 meetings', 'Training sessions', 'Reviews'],
                    benefit: `${agentName} can coordinate HR schedules efficiently`
                };
            }
            return {
                businessDesc: 'Schedule and manage appointments',
                examples: ['Meeting booking', 'Availability checks', 'Reminders', 'Rescheduling'],
                benefit: `${agentName} can manage calendar tasks automatically`
            };
        }
        
        function getCrmInfo(goal, agentName) {
            return {
                businessDesc: 'Customer relationship management',
                examples: ['Contact lookup', 'Deal tracking', 'Interaction history', 'Lead info'],
                benefit: `${agentName} can personalize interactions with CRM data`
            };
        }
        
        function getWebSearchInfo(goal, agentName) {
            if(goal.includes('research') || goal.includes('analysis')) {
                return {
                    businessDesc: 'Research current information online',
                    examples: ['Market data', 'News articles', 'Competitor info', 'Industry trends'],
                    benefit: `${agentName} can find up-to-date information for research`
                };
            }
            return {
                businessDesc: 'Search the web for current information',
                examples: ['Latest updates', 'External data', 'News', 'Public information'],
                benefit: `${agentName} can access current web information`
            };
        }
        
        function getCodeInfo(goal, agentName) {
            if(goal.includes('code') || goal.includes('developer') || goal.includes('programming')) {
                return {
                    businessDesc: 'Execute and test code',
                    examples: ['Code testing', 'Script execution', 'Debugging', 'Code generation'],
                    benefit: `${agentName} can run and validate code directly`
                };
            }
            return {
                businessDesc: 'Run calculations and scripts',
                examples: ['Data processing', 'Calculations', 'Transformations', 'Automation'],
                benefit: `${agentName} can perform complex computations`
            };
        }
        
        function getSlackInfo(goal, agentName) {
            return {
                businessDesc: 'Team notifications and alerts',
                examples: ['Escalations', 'Status updates', 'Alerts', 'Team notifications'],
                benefit: `${agentName} can notify your team when needed`
            };
        }
        
        // Simple object for backward compatibility
        function getAllToolBusinessInfo() {
            const result = {};
            Object.keys(baseToolInfo).forEach(key => {
                result[key] = getToolBusinessInfo(key);
            });
            return result;
        }
        
        // Selected tools for the agent - ALL types
        let selectedDemoTools = {
            apis: [],
            knowledge_bases: [],
            emails: [],
            webhooks: [],
            slacks: [],
            calendars: [],
            databases: [],
            websearches: [],
            websites: []
        };
        
        // Temporary selection in modal
        let tempToolSelection = {
            apis: [],
            knowledge_bases: [],
            emails: [],
            webhooks: [],
            slacks: [],
            calendars: [],
            databases: [],
            websearches: [],
            websites: []
        };
        
        // Flag to return to wizard after creating tool
        let returnToWizardAfterTool = false;
        
        // Auto-save agent data
        async function autoSaveAgent() {
            if (!wizard.editId) return; // Only auto-save if editing existing agent
            
            try {
                // Collect all current data
                collectToolsNew();
                collectGuardrails();
                
                const agentData = {
                    name: wizard.name || 'Untitled Agent',
                    icon: wizard.icon || 'ðŸ¤–',
                    goal: wizard.goal || '',
                    tasks: wizard.tasks || [],
                    tool_ids: wizard.tool_ids || [],
                    guardrails: wizard.guardrails || {},
                    personality: wizard.personality || {},
                    model_id: wizard.model || 'gpt-4o',
                    status: 'draft'
                };
                
                await fetch(API + `/api/agents/${wizard.editId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(agentData)
                });
                
                console.log('âœ… Agent auto-saved');
            } catch (e) {
                console.error('Auto-save failed:', e);
            }
        }
        
        // Debounced auto-save
        let autoSaveTimeout = null;
        function triggerAutoSave() {
            if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSaveAgent, 2000); // Save after 2 seconds of no changes
        }
        
        // Show select tool modal
        async function showSelectToolModal() {
            const modal = document.getElementById('select-tool-modal');
            if (!modal) return;
            ensureModalInBody('select-tool-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Reset temp selection to current selection
            tempToolSelection = {
                apis: [...selectedDemoTools.apis],
                knowledge_bases: [...selectedDemoTools.knowledge_bases],
                emails: [...selectedDemoTools.emails],
                webhooks: [...selectedDemoTools.webhooks],
                slacks: [...selectedDemoTools.slacks],
                calendars: [...selectedDemoTools.calendars],
                databases: [...selectedDemoTools.databases],
                websearches: [...selectedDemoTools.websearches],
                websites: [...selectedDemoTools.websites]
            };
            
            await loadToolsForModal();
        }
        
        // Close select tool modal
        function closeSelectToolModal() {
            document.getElementById('select-tool-modal').classList.add('hidden');
            document.getElementById('select-tool-modal').classList.remove('flex');
        }
        
        // Load tools into modal
        async function loadToolsForModal() {
            const container = document.getElementById('available-tools-list');
            
            try {
                // Use /api/tools to show all tools the user can VIEW.
                // The API also returns can_execute, so we can prevent selecting tools the user can't run.
                const response = await fetch(API + '/api/tools', { headers: getAuthHeaders() });
                let data = null;
                try { data = await response.json(); } catch (_) { data = null; }
                
                if (!response.ok) {
                    const msg = (data && (data.detail || data.message || data.error))
                        ? (data.detail || data.message || data.error)
                        : (response.status === 401 ? 'Please sign in to see your tools.' : (response.statusText || 'Failed to load tools'));
                    container.innerHTML = `
                        <div class="text-center py-6 text-red-400">
                            <p>${escHtml(String(msg || 'Failed to load tools'))}</p>
                            <button onclick="loadToolsForModal()" class="text-sm text-purple-400 mt-2">Retry</button>
                        </div>
                    `;
                    return;
                }
                
                const tools = Array.isArray(data) ? data : (data && data.tools) ? data.tools : [];
                
                if (tools.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 bg-gray-800/30 rounded-xl">
                            <span class="text-4xl block mb-3">ðŸ”§</span>
                            <p class="text-gray-400 mb-2">No tools available yet</p>
                            <p class="text-sm text-gray-500">Create tools in the Tools page or Demo Lab first</p>
                        </div>
                    `;
                    return;
                }
                
                const _normToolType = (tool) => {
                    const raw = String(tool?.type || '').toLowerCase().trim();
                    return raw.replace(/[\s_-]+/g, '');
                };
                
                // Group by type
                const apis = tools.filter(t => _normToolType(t) === 'api');
                const kbs = tools.filter(t => {
                    const nt = _normToolType(t);
                    return nt === 'knowledge' || nt === 'document' || nt === 'knowledgebase' || nt === 'kb';
                });
                const emails = tools.filter(t => _normToolType(t) === 'email');
                const webhooks = tools.filter(t => _normToolType(t) === 'webhook');
                const websearches = tools.filter(t => {
                    const nt = _normToolType(t);
                    return nt === 'websearch' || nt === 'search' || nt === 'websearchtool';
                });
                const slacks = tools.filter(t => _normToolType(t) === 'slack');
                const calendars = tools.filter(t => _normToolType(t) === 'calendar');
                const databases = tools.filter(t => {
                    const nt = _normToolType(t);
                    return nt === 'database' || nt === 'db';
                });
                const websites = tools.filter(t => _normToolType(t) === 'website');
                const otherTools = tools.filter(t => {
                    const nt = _normToolType(t);
                    return !['api','knowledge','document','knowledgebase','kb','email','webhook','websearch','search','websearchtool','slack','calendar','database','db','website'].includes(nt);
                });
                
                let html = '';
                
                // Helper function to render tool section
                const renderToolSection = (toolList, icon, title, color, typeKey) => {
                    if (toolList.length === 0) return '';
                    
                    // Map typeKey to tempToolSelection array
                    const typeToArray = {
                        'api': 'apis',
                        'kb': 'knowledge_bases',
                        'email': 'emails',
                        'webhook': 'webhooks',
                        'slack': 'slacks',
                        'calendar': 'calendars',
                        'database': 'databases',
                        'websearch': 'websearches',
                        'website': 'websites'
                    };
                    const arrayKey = typeToArray[typeKey] || 'apis';
                    
                    let sectionHtml = `
                        <div class="mb-4">
                            <h5 class="text-sm font-medium text-${color}-400 mb-3 flex items-center gap-2">
                                <span>${icon}</span> ${title}
                                <span class="text-xs bg-${color}-500/20 px-2 py-0.5 rounded-full">${toolList.length}</span>
                            </h5>
                            <div class="space-y-2">
                    `;
                    
                    for (const tool of toolList) {
                        const canExecute = (tool && Object.prototype.hasOwnProperty.call(tool, 'can_execute')) ? !!tool.can_execute : true;
                        const isSelected = (tempToolSelection[arrayKey] || []).some(t => t.id === tool.id);
                        const disabledClass = canExecute ? '' : ' opacity-60 cursor-not-allowed';
                        const badgeNoAccess = canExecute ? '' : `<span class="text-xs bg-gray-700/60 text-gray-300 px-2 py-0.5 rounded">No access</span>`;
                        sectionHtml += `
                            <div class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors ${isSelected ? 'bg-' + color + '-500/20 border border-' + color + '-500/50' : 'bg-gray-800/50 hover:bg-gray-800 border border-transparent'}${disabledClass}"
                                 onclick="toggleModalToolSelection('${typeKey}', '${tool.id}', this, '${color}')" data-tool-id="${tool.id}">
                                <input type="checkbox" class="w-4 h-4 rounded" ${isSelected ? 'checked' : ''} ${canExecute ? '' : 'disabled'}>
                                <span class="text-xl">${icon}</span>
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-sm truncate">${escHtml(tool.name)}</p>
                                    <p class="text-xs text-gray-500 truncate">${escHtml(tool.description || 'No description')}</p>
                                </div>
                                ${badgeNoAccess}
                                ${tool.config?.source === 'demo_kit' ? '<span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded">Demo</span>' : ''}
                            </div>
                        `;
                    }
                    
                    sectionHtml += `</div></div>`;
                    return sectionHtml;
                };
                
                // APIs
                html += renderToolSection(apis, 'ðŸ”Œ', 'APIs', 'purple', 'api');
                
                // Knowledge Bases
                html += renderToolSection(kbs, 'ðŸ§ ', 'Knowledge Bases', 'blue', 'kb');
                
                // Email
                html += renderToolSection(emails, 'ðŸ“§', 'Email', 'green', 'email');
                
                // Webhooks
                html += renderToolSection(webhooks, 'ðŸ”—', 'Webhooks', 'yellow', 'webhook');
                
                // Web Search
                html += renderToolSection(websearches, 'ðŸ”', 'Web Search', 'cyan', 'websearch');
                
                // Slack
                html += renderToolSection(slacks, 'ðŸ’¬', 'Slack', 'pink', 'slack');
                
                // Calendar
                html += renderToolSection(calendars, 'ðŸ“…', 'Calendar', 'orange', 'calendar');
                
                // Database
                html += renderToolSection(databases, 'ðŸ—„ï¸', 'Database', 'indigo', 'database');
                
                // Websites
                html += renderToolSection(websites, 'ðŸŒ', 'Websites', 'teal', 'website');
                
                // Other tools (still selectable if can_execute=true)
                html += renderToolSection(otherTools, 'ðŸ§©', 'Other', 'gray', 'api');
                
                container.innerHTML = html || `
                    <div class="text-center py-8 bg-gray-800/30 rounded-xl">
                        <span class="text-4xl block mb-3">ðŸ”§</span>
                        <p class="text-gray-400 mb-2">No tools matched the supported categories</p>
                        <p class="text-sm text-gray-500">Your tools are available, but their type is not recognized by the UI yet.</p>
                    </div>
                `;
                
                // Store tool data for reference
                container._toolsData = tools;
                
            } catch (e) {
                console.error('Failed to load tools:', e);
                container.innerHTML = `
                    <div class="text-center py-6 text-red-400">
                        <p>Failed to load tools</p>
                        <button onclick="loadToolsForModal()" class="text-sm text-purple-400 mt-2">Retry</button>
                    </div>
                `;
            }
        }
        
        // Toggle tool selection in modal
        function toggleModalToolSelection(type, toolId, element, color = 'purple') {
            const container = document.getElementById('available-tools-list');
            const toolsData = container._toolsData || [];
            const toolData = toolsData.find(t => t.id === toolId);
            const checkbox = element.querySelector('input[type="checkbox"]');
            
            // Prevent selecting tools the user can't execute
            try {
                if (toolData && Object.prototype.hasOwnProperty.call(toolData, 'can_execute') && toolData.can_execute === false) {
                    showToast('You do not have permission to use this tool. Ask the tool owner to grant Execute access.', 'warning');
                    return;
                }
            } catch (_) {
                // ignore
            }
            
            // Map type to correct array
            const typeToArray = {
                'api': 'apis',
                'kb': 'knowledge_bases',
                'email': 'emails',
                'webhook': 'webhooks',
                'slack': 'slacks',
                'calendar': 'calendars',
                'database': 'databases',
                'websearch': 'websearches',
                'website': 'websites'
            };
            const arrayKey = typeToArray[type] || 'apis';
            const targetArray = tempToolSelection[arrayKey];
            
            if (!targetArray) {
                console.error('Unknown tool type:', type);
                return;
            }
            
            const idx = targetArray.findIndex(t => t.id === toolId);
            if (idx >= 0) {
                // Remove
                targetArray.splice(idx, 1);
                element.className = element.className.replace(/bg-\w+-500\/20/g, 'bg-gray-800/50');
                element.className = element.className.replace(/border-\w+-500\/50/g, 'border-transparent');
                if (checkbox) checkbox.checked = false;
            } else if (toolData) {
                // Add
                targetArray.push(toolData);
                element.classList.remove('bg-gray-800/50', 'border-transparent');
                element.classList.add(`bg-${color}-500/20`, `border-${color}-500/50`);
                if (checkbox) checkbox.checked = true;
            }
        }
        
        // Confirm tool selection
        function confirmToolSelection() {
            selectedDemoTools = {
                apis: [...tempToolSelection.apis],
                knowledge_bases: [...tempToolSelection.knowledge_bases],
                emails: [...tempToolSelection.emails],
                webhooks: [...tempToolSelection.webhooks],
                slacks: [...tempToolSelection.slacks],
                calendars: [...tempToolSelection.calendars],
                databases: [...tempToolSelection.databases],
                websearches: [...tempToolSelection.websearches],
                websites: [...tempToolSelection.websites]
            };
            closeSelectToolModal();
            updateSelectedToolsList();
            
            // Update wizard.tool_ids immediately
            syncToolsToWizard();
            
            // Trigger auto-save
            triggerAutoSave();
        }
        
        // Sync selectedDemoTools to wizard.tool_ids
        function syncToolsToWizard() {
            wizard.tool_ids = [];
            
            console.log('ðŸ”„ syncToolsToWizard called');
            console.log('   selectedDemoTools:', JSON.stringify(selectedDemoTools, null, 2));
            
            // Add all tool types with their actual IDs (no prefix for non-demo tools)
            const addTools = (tools, prefix = '', typeName = '') => {
                console.log(`   Processing ${typeName}: ${tools.length} tools`);
                tools.forEach(tool => {
                    const isDemoKit = tool.config?.source === 'demo_kit' || tool.id.startsWith('kit_');
                    const toolId = isDemoKit ? `${prefix}${tool.id}` : tool.id;
                    console.log(`      Tool: ${tool.name} (${tool.id}) -> ${toolId} (isDemoKit: ${isDemoKit})`);
                    if (!wizard.tool_ids.includes(toolId)) {
                        wizard.tool_ids.push(toolId);
                    }
                });
            };
            
            addTools(selectedDemoTools.apis, 'api:', 'APIs');
            addTools(selectedDemoTools.knowledge_bases, 'kb:', 'KnowledgeBases');
            addTools(selectedDemoTools.emails, '', 'Emails');
            addTools(selectedDemoTools.webhooks, '', 'Webhooks');
            addTools(selectedDemoTools.slacks, '', 'Slacks');
            addTools(selectedDemoTools.calendars, '', 'Calendars');
            addTools(selectedDemoTools.databases, '', 'Databases');
            addTools(selectedDemoTools.websearches, '', 'WebSearches');
            addTools(selectedDemoTools.websites, '', 'Websites');
            
            console.log('âœ… Final wizard.tool_ids:', wizard.tool_ids);
        }
        
        // Go to configure new tool
        function goToConfigureNewTool() {
            returnToWizardAfterTool = true;
            showPage('tools');
            // Show create tool modal
            setTimeout(() => showToolModal(), 300);
        }
        
        // Update the selected tools list display
        function updateSelectedToolsList() {
            const container = document.getElementById('w-tools-list');
            const countEl = document.getElementById('selected-tools-count');
            
            // Count all tool types
            const totalCount = 
                selectedDemoTools.apis.length + 
                selectedDemoTools.knowledge_bases.length +
                selectedDemoTools.emails.length +
                selectedDemoTools.webhooks.length +
                selectedDemoTools.slacks.length +
                selectedDemoTools.calendars.length +
                selectedDemoTools.databases.length +
                selectedDemoTools.websearches.length +
                selectedDemoTools.websites.length;
            
            if (countEl) countEl.textContent = totalCount;
            
            if (!container) return;
            
            if (totalCount === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-gray-500 text-sm">
                        <span class="text-2xl block mb-2">ðŸ”§</span>
                        No tools selected yet<br>
                        <span class="text-xs">Click one of the options above to add tools</span>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Helper to render tool items
            const renderToolItems = (tools, icon, label, colorClass, typeKey) => {
                tools.forEach(tool => {
                    html += `
                        <div class="flex items-center gap-3 p-3 rounded-lg ${colorClass}">
                            <span class="text-xl">${icon}</span>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-sm">${escHtml(tool.name)}</p>
                                <p class="text-xs text-gray-500">${label}</p>
                            </div>
                            <button onclick="removeSelectedTool('${typeKey}', '${tool.id}')" class="text-gray-500 hover:text-red-400 p-1">âœ•</button>
                        </div>
                    `;
                });
            };
            
            renderToolItems(selectedDemoTools.apis, 'ðŸ”Œ', 'API', 'bg-purple-500/10 border border-purple-500/30', 'api');
            renderToolItems(selectedDemoTools.knowledge_bases, 'ðŸ§ ', 'Knowledge Base', 'bg-blue-500/10 border border-blue-500/30', 'kb');
            renderToolItems(selectedDemoTools.emails, 'ðŸ“§', 'Email', 'bg-green-500/10 border border-green-500/30', 'email');
            renderToolItems(selectedDemoTools.webhooks, 'ðŸ”—', 'Webhook', 'bg-yellow-500/10 border border-yellow-500/30', 'webhook');
            renderToolItems(selectedDemoTools.slacks, 'ðŸ’¬', 'Slack', 'bg-pink-500/10 border border-pink-500/30', 'slack');
            renderToolItems(selectedDemoTools.calendars, 'ðŸ“…', 'Calendar', 'bg-orange-500/10 border border-orange-500/30', 'calendar');
            renderToolItems(selectedDemoTools.databases, 'ðŸ—„ï¸', 'Database', 'bg-indigo-500/10 border border-indigo-500/30', 'database');
            renderToolItems(selectedDemoTools.websearches, 'ðŸ”', 'Web Search', 'bg-cyan-500/10 border border-cyan-500/30', 'websearch');
            renderToolItems(selectedDemoTools.websites, 'ðŸŒ', 'Website', 'bg-teal-500/10 border border-teal-500/30', 'website');
            
            container.innerHTML = html;
        }
        
        // Remove a selected tool
        function removeSelectedTool(type, toolId) {
            const typeToArray = {
                'api': 'apis',
                'kb': 'knowledge_bases',
                'email': 'emails',
                'webhook': 'webhooks',
                'slack': 'slacks',
                'calendar': 'calendars',
                'database': 'databases',
                'websearch': 'websearches',
                'website': 'websites'
            };
            const arrayKey = typeToArray[type];
            if (arrayKey && selectedDemoTools[arrayKey]) {
                selectedDemoTools[arrayKey] = selectedDemoTools[arrayKey].filter(t => t.id !== toolId);
            }
            updateSelectedToolsList();
            syncToolsToWizard();
            triggerAutoSave();
        }
        
        // Load available tools for selection in Step 3 (compatibility)
        async function loadDemoKitToolsForSelection() {
            updateSelectedToolsList();
        }
        
        function loadWizardToolsNew() {
            console.log('=== loadWizardToolsNew called ===');
            console.log('wizard.suggestedTools:', JSON.stringify(wizard.suggestedTools));
            console.log('wizard.tool_ids (existing):', JSON.stringify(wizard.tool_ids));
            
            const suggestedContainer = document.getElementById('w-tools-suggested');
            const allContainer = document.getElementById('w-tools-list');
            
            if(!suggestedContainer) {
                console.error('w-tools-suggested container not found!');
                return;
            }
            
            const suggestedTools = wizard.suggestedTools || [];
            const existingToolIds = wizard.tool_ids || [];
            
            // Check if we already have tools selected (from Demo Kit, edit mode, or manual selection)
            const hasExistingTools = existingToolIds.length > 0 || 
                selectedDemoTools.apis.length > 0 || 
                selectedDemoTools.knowledge_bases.length > 0 ||
                selectedDemoTools.emails.length > 0 ||
                selectedDemoTools.webhooks.length > 0;
            const isEditMode = wizard.editId && existingToolIds.length > 0;
            
            console.log('isEditMode:', isEditMode, 'hasExistingTools:', hasExistingTools, 'existingToolIds:', existingToolIds);
            
            // Render suggested tools based on AI recommendation
            if(suggestedTools.length > 0) {
                let html = '';
                suggestedTools.forEach(toolType => {
                    console.log('Processing tool:', toolType);
                    const info = getToolBusinessInfo(toolType);
                    if(!info || !info.name) {
                        console.warn('No info for tool type:', toolType);
                        return;
                    }
                    // Check if this tool is already selected (for edit mode)
                    const isSelected = existingToolIds.includes(toolType);
                    html += `
                        <div class="card rounded-lg p-4 border-2 ${isSelected ? 'border-purple-500/50 bg-purple-500/5' : 'border-gray-700'} cursor-pointer tool-item" 
                             data-tool-type="${toolType}" onclick="toggleToolSelection(this, '${toolType}'); showToolDetail('${toolType}');">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center text-xl flex-shrink-0">
                                    ${info.icon}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between gap-2">
                                        <h5 class="font-medium">${info.name}</h5>
                                        <span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded flex-shrink-0">Recommended</span>
                                    </div>
                                    <p class="text-sm text-gray-400 mt-1">${info.businessDesc}</p>
                                    <p class="text-xs text-gray-500 mt-2">${info.benefit}</p>
                                </div>
                                <input type="checkbox" class="w-5 h-5 rounded flex-shrink-0" ${isSelected ? 'checked' : ''}>
                            </div>
                        </div>
                    `;
                });
                
                if(html) {
                    suggestedContainer.innerHTML = html;
                    // Only initialize tool_ids with suggested tools if NO existing tools (preserve Demo Kit and manual selections)
                    if(!isEditMode && !hasExistingTools) {
                        wizard.tool_ids = [...suggestedTools];
                    }
                    console.log('Rendered suggested tools, tool_ids:', wizard.tool_ids);
                } else {
                    suggestedContainer.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <p class="text-sm">No specific tools recommended. Select from available tools below.</p>
                        </div>
                    `;
                }
            } else {
                console.log('No suggested tools, showing default message');
                suggestedContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <p class="text-sm">No specific tools recommended. Select from available tools below.</p>
                    </div>
                `;
            }
            
            // Also load all available tools from the system
            loadAvailableToolTypes();
        }
        
        function loadAvailableToolTypes() {
            const allContainer = document.getElementById('w-tools-list');
            if(!allContainer) return;
            
            // Show all tool types that are not already suggested
            const allToolTypes = Object.keys(baseToolInfo);
            const notSuggested = allToolTypes.filter(t => !(wizard.suggestedTools || []).includes(t));
            
            let html = '';
            
            // Add abstract tool types
            if(notSuggested.length > 0) {
                html += notSuggested.map(toolType => {
                    const info = getToolBusinessInfo(toolType);
                    return `
                        <div class="card rounded-lg p-4 border border-gray-700 hover:border-gray-500 cursor-pointer tool-item" 
                             data-tool-type="${toolType}" onclick="toggleToolSelection(this, '${toolType}'); showToolDetail('${toolType}');">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-lg bg-gray-700 flex items-center justify-center text-xl flex-shrink-0">
                                    ${info.icon}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h5 class="font-medium">${info.name}</h5>
                                    <p class="text-sm text-gray-400 mt-1">${info.businessDesc}</p>
                                </div>
                                <input type="checkbox" class="w-5 h-5 rounded flex-shrink-0">
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Also load actual tools from the system
            loadSystemTools(allContainer, html);
        }
        
        async function loadSystemTools(container, existingHtml) {
            try {
                const r = await fetch(API + '/api/tools');
                const d = await r.json();
                const systemTools = d.tools || [];
                
                if(systemTools.length > 0) {
                    const icons = {document:'ðŸ“„', website:'ðŸŒ', api:'ðŸ”Œ', knowledge:'ðŸ§ '};
                    const toolsHtml = systemTools.map(t => `
                        <div class="card rounded-lg p-4 border border-gray-700 hover:border-gray-500 cursor-pointer tool-item" 
                             data-tool-id="${t.id}" onclick="toggleSystemTool(this, '${t.id}');">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-xl flex-shrink-0">
                                    ${icons[t.type] || 'ðŸ”§'}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <h5 class="font-medium">${escHtml(t.name)}</h5>
                                        <span class="text-xs bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded">${t.type}</span>
                                    </div>
                                    <p class="text-sm text-gray-400 mt-1">${t.documents?.length || 0} documents</p>
                                </div>
                                <input type="checkbox" class="w-5 h-5 rounded flex-shrink-0" ${wizard.tool_ids?.includes(t.id) ? 'checked' : ''}>
                            </div>
                        </div>
                    `).join('');
                    
                    if(existingHtml) {
                        container.innerHTML = existingHtml + `
                            <div class="col-span-full mt-4 pt-4 border-t border-gray-700">
                                <h5 class="text-sm font-medium text-gray-400 mb-3">ðŸ“š Your Knowledge Bases</h5>
                            </div>
                        ` + toolsHtml;
                    } else {
                        container.innerHTML = toolsHtml;
                    }
                } else if(existingHtml) {
                    container.innerHTML = existingHtml;
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No tools available</p>';
                }
            } catch(e) {
                console.error('Error loading system tools:', e);
                if(existingHtml) {
                    container.innerHTML = existingHtml;
                }
            }
        }
        
        function toggleSystemTool(el, toolId) {
            const checkbox = el.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if(checkbox.checked) {
                el.classList.add('border-purple-500/50', 'bg-purple-500/5');
                el.classList.remove('border-gray-700');
                if(!wizard.tool_ids.includes(toolId)) {
                    wizard.tool_ids.push(toolId);
                }
            } else {
                el.classList.remove('border-purple-500/50', 'bg-purple-500/5');
                el.classList.add('border-gray-700');
                wizard.tool_ids = wizard.tool_ids.filter(id => id !== toolId);
            }
        }
        
        function showToolDetail(toolType) {
            const info = getToolBusinessInfo(toolType);
            const sidebar = document.getElementById('tool-detail-sidebar');
            if(!info || !sidebar) return;
            
            sidebar.innerHTML = `
                <div class="text-center mb-4">
                    <div class="w-16 h-16 mx-auto rounded-xl bg-purple-500/20 flex items-center justify-center text-3xl mb-3">
                        ${info.icon}
                    </div>
                    <h4 class="font-semibold">${info.name}</h4>
                    <p class="text-sm text-gray-400 mt-1">${info.businessDesc}</p>
                </div>
                
                <div class="mb-4">
                    <h5 class="text-xs font-medium text-gray-400 uppercase mb-2">What it does</h5>
                    <p class="text-sm">${info.benefit}</p>
                </div>
                
                <div>
                    <h5 class="text-xs font-medium text-gray-400 uppercase mb-2">Examples</h5>
                    <ul class="space-y-2">
                        ${(info.examples || []).map(ex => `
                            <li class="flex items-center gap-2 text-sm">
                                <span class="text-green-400">âœ“</span>
                                <span>${ex}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }
        
        function toggleToolSelection(el, toolType) {
            const checkbox = el.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if(checkbox.checked) {
                el.classList.add('border-purple-500/50', 'bg-purple-500/5');
                el.classList.remove('border-gray-700');
            } else {
                el.classList.remove('border-purple-500/50', 'bg-purple-500/5');
                el.classList.add('border-gray-700');
            }
            
            showToolDetail(toolType);
        }
        
        function collectToolsNew() {
            // Use syncToolsToWizard for consistent tool ID handling
            syncToolsToWizard();
            
            // Store references for demo tools
            wizard.demo_apis = selectedDemoTools.apis || [];
            wizard.demo_knowledge_bases = selectedDemoTools.knowledge_bases || [];
            
            // Also check for any custom tools from suggested tools UI
            document.querySelectorAll('.tool-item input[type="checkbox"]:checked').forEach(cb => {
                const toolItem = cb.closest('.tool-item');
                const toolId = toolItem?.dataset?.toolId || toolItem?.dataset?.toolType;
                if(toolId && !wizard.tool_ids.includes(toolId)) {
                    wizard.tool_ids.push(toolId);
                }
            });
            
            console.log('âœ… collectToolsNew - Final tool_ids:', wizard.tool_ids);
        }
        
        function collectGuardrails() {
            wizard.guardrails = {
                antiHallucination: document.getElementById('guard-anti-hallucination')?.checked ?? true,
                citeSources: document.getElementById('guard-cite-sources')?.checked ?? true,
                admitUncertainty: document.getElementById('guard-admit-uncertainty')?.checked ?? true,
                verifyFacts: document.getElementById('guard-verify-facts')?.checked ?? true,
                noSpeculation: document.getElementById('guard-no-speculation')?.checked ?? false,
                avoidTopics: document.getElementById('guard-avoid-topics')?.value || '',
                focusTopics: document.getElementById('guard-focus-topics')?.value || '',
                maxLength: document.getElementById('guard-max-length')?.value || 'medium',
                language: document.getElementById('guard-language')?.value || 'user',
                escalateAngry: document.getElementById('guard-escalate-angry')?.checked ?? true,
                escalateComplex: document.getElementById('guard-escalate-complex')?.checked ?? true,
                escalateRequest: document.getElementById('guard-escalate-request')?.checked ?? true,
                escalateSensitive: document.getElementById('guard-escalate-sensitive')?.checked ?? false,
                piiProtection: document.getElementById('guard-pii-protection')?.checked ?? true,
                maskPii: document.getElementById('guard-mask-pii')?.checked ?? true,
                noStorePii: document.getElementById('guard-no-store-pii')?.checked ?? true
            };
            
            // Collect Access Control settings
            collectWizardAccessControl();
        }
        
        // ========================================================================
        // WIZARD ACCESS CONTROL
        // ========================================================================
        
        // State for wizard access control
        let wizardAccessState = {
            accessType: 'authenticated',
            selectedEntities: [],
            taskPermissions: {},
            allUsers: [],
            allGroups: []
        };
        
        // Check if current user has admin permissions
        function isUserAdmin() {
            if (!currentUser) return false;
            const userPermissions = currentUser.permissions || [];
            const adminPermissions = ['admin', 'manage_agents', 'manage_users', 'manage_security'];
            return adminPermissions.some(p => userPermissions.includes(p));
        }
        
        // Check if current user is the owner of the current agent
        function isAgentOwner() {
            // For new agents (no id yet), the current user will become the owner
            if (!wizard.id) return true;
            
            if (!currentUser) return false;
            
            // Use string comparison to handle UUID formatting differences
            const ownerId = String(wizard.owner_id || '');
            const createdBy = String(wizard.created_by || '');
            const userId = String(currentUser.id || '');
            
            const isOwner = ownerId === userId || createdBy === userId;
            console.log(`ðŸ” isAgentOwner check: ownerId=${ownerId.slice(0,8)}..., userId=${userId.slice(0,8)}..., isOwner=${isOwner}`);
            return isOwner;
        }
        
        // State for agent admins with permissions
        let agentAdminState = {
            delegatedAdmins: [],  // [{entity_id, entity_type, entity_name, permissions: []}]
            isOwner: false,
            ownerId: null
        };
        
        // All available permissions
        const AGENT_PERMISSIONS = [
            { id: 'full_admin', name: 'Full Admin', icon: 'â­', desc: 'All permissions except delete', category: 'Special' },
            { id: 'edit_basic_info', name: 'Edit Info', icon: 'ðŸ“', desc: 'Name, icon, description', category: 'Config' },
            { id: 'edit_personality', name: 'Edit Personality', icon: 'ðŸŽ­', desc: 'Agent personality', category: 'Config' },
            { id: 'edit_model', name: 'Change Model', icon: 'ðŸ¤–', desc: 'LLM model selection', category: 'Config' },
            { id: 'edit_guardrails', name: 'Edit Guardrails', icon: 'ðŸ›¡ï¸', desc: 'Safety settings', category: 'Config' },
            { id: 'manage_tasks', name: 'Manage Tasks', icon: 'ðŸ“‹', desc: 'Add/edit/delete tasks', category: 'Components' },
            { id: 'manage_tools', name: 'Manage Tools', icon: 'ðŸ”§', desc: 'Add/edit/delete tools', category: 'Components' },
            { id: 'manage_knowledge', name: 'Manage Knowledge', icon: 'ðŸ“š', desc: 'Knowledge base', category: 'Components' },
            { id: 'manage_access', name: 'Manage Access', icon: 'ðŸ”', desc: 'End-user access', category: 'Access' },
            { id: 'manage_task_permissions', name: 'Task Permissions', icon: 'âœ…', desc: 'Task-level access', category: 'Access' },
            { id: 'publish_agent', name: 'Publish', icon: 'ðŸš€', desc: 'Publish/unpublish', category: 'Deploy' },
            { id: 'delete_agent', name: 'Delete Agent', icon: 'ðŸ—‘ï¸', desc: 'Delete (dangerous!)', category: 'Danger' }
        ];
        
        // Load current agent management config
        async function loadAgentAdmins(agentId) {
            if (!agentId) return;
            
            try {
                const orgId = currentUser?.org_id || 'default';
                const response = await fetch(`/api/access-control/agents/${agentId}/management?org_id=${orgId}`, {
                    headers: getAuthHeaders()
                });
                
                const section = document.getElementById('wizard-delegate-admin-section');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('ðŸ“‹ Agent management data:', data);
                    
                    agentAdminState.ownerId = data.owner_id;
                    // Compare strings to handle UUID formatting
                    const ownerIdStr = String(data.owner_id || '');
                    const currentUserIdStr = String(currentUser?.id || '');
                    agentAdminState.isOwner = ownerIdStr && currentUserIdStr && ownerIdStr === currentUserIdStr;
                    agentAdminState.delegatedAdmins = data.delegated_admins || [];
                    
                    // Enrich with names
                    agentAdminState.delegatedAdmins.forEach(admin => {
                        if (admin.entity_type === 'user') {
                            const user = wizardAccessState.allUsers.find(u => u.id === admin.entity_id);
                            admin.entity_name = user?.name || user?.email || `User ${admin.entity_id.slice(0,8)}...`;
                        } else {
                            const group = wizardAccessState.allGroups.find(g => g.id === admin.entity_id);
                            admin.entity_name = group?.name || `Group ${admin.entity_id.slice(0,8)}...`;
                        }
                    });
                    
                    // Show the delegate admin section if user is owner
                    if (section) {
                        section.style.display = agentAdminState.isOwner ? 'block' : 'none';
                        console.log(`ðŸ‘ï¸ Delegate section visibility: ${agentAdminState.isOwner ? 'VISIBLE' : 'HIDDEN'}`);
                    }
                    
                    // Show owner badge
                    const ownerBadge = document.getElementById('ac-owner-badge');
                    if (ownerBadge) {
                        ownerBadge.style.display = agentAdminState.isOwner ? 'inline-flex' : 'none';
                    }
                    
                    renderDelegatedAdmins();
                } else if (response.status === 403) {
                    // API says no access, but double-check with local data
                    const localIsOwner = isAgentOwner();
                    console.log(`âš ï¸ 403 Forbidden from API, but local isOwner check: ${localIsOwner}`);
                    
                    if (localIsOwner) {
                        // Local check says we're owner - might be a sync issue
                        console.log('ðŸ”„ Local check says owner - showing delegation section anyway');
                        agentAdminState.isOwner = true;
                        agentAdminState.delegatedAdmins = [];
                        if (section) section.style.display = 'block';
                        renderDelegatedAdmins();
                    } else {
                        agentAdminState.isOwner = false;
                        if (section) section.style.display = 'none';
                    }
                } else {
                    console.error('âŒ Failed to load agent management:', response.status);
                    // Fallback to local ownership check
                    const localIsOwner = isAgentOwner();
                    agentAdminState.isOwner = localIsOwner;
                    if (section) section.style.display = localIsOwner ? 'block' : 'none';
                    if (localIsOwner) renderDelegatedAdmins();
                }
            } catch (e) {
                console.error('Failed to load agent admins:', e);
            }
        }
        
        // Check if current user is the owner (from wizard data)
        function checkOwnershipFromWizard() {
            if (!currentUser || !wizard.id) return false;
            return wizard.owner_id === currentUser.id || wizard.created_by === currentUser.id;
        }
        
        // Render delegated admins with permission matrix
        function renderDelegatedAdmins() {
            const container = document.getElementById('wizard-delegated-admins-list');
            if (!container) return;
            
            const admins = agentAdminState.delegatedAdmins;
            
            if (admins.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:24px 16px; border-radius:12px; background:rgba(0,0,0,0.2);">
                        <div style="font-size:2rem; margin-bottom:8px;">ðŸ‘¤</div>
                        <p style="color:#9ca3af; font-size:0.875rem;">You are the only admin.</p>
                        <p style="color:#6b7280; font-size:0.75rem; margin-top:4px;">Search above to add users or groups as delegated admins.</p>
                    </div>`;
                return;
            }
            
            const tasks = wizard.tasks || [];
            
            // Track selected admin for detail panel
            const selIdx = window._daSelectedIdx != null && window._daSelectedIdx < admins.length ? window._daSelectedIdx : 0;
            const selAdmin = admins[selIdx];
            
            // ===================================================================
            // Master-Detail Split Panel for Delegated Admins
            // ===================================================================
            container.innerHTML = `
                <div style="display:flex; gap:12px; min-height:380px;">
                    <!-- LEFT: Admin List -->
                    <div style="width:240px; flex-shrink:0; display:flex; flex-direction:column; background:rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.08); border-radius:16px; overflow:hidden;">
                        <div style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.06);">
                            <input type="text" id="da-filter" oninput="daFilterAdmins(this.value)"
                                   placeholder="Filter admins..."
                                   style="width:100%; padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:#f1f5f9; font-size:0.8rem; outline:none;">
                        </div>
                        <div id="da-admin-list" style="flex:1; overflow-y:auto; padding:6px;">
                            ${admins.map((a, idx) => {
                                const icon = a.entity_type === 'user' ? 'ðŸ‘¤' : 'ðŸ‘¥';
                                const isActive = idx === selIdx;
                                const hasFA = a.permissions?.includes('full_admin');
                                const deniedCount = (a.denied_task_names || []).length;
                                const permCount = (a.permissions || []).length;
                                const activeBg = isActive ? 'rgba(245,158,11,0.2)' : 'transparent';
                                const activeBorder = isActive ? '2px solid rgba(245,158,11,0.5)' : '2px solid transparent';
                                
                                return `
                                <div class="da-admin-item" data-name="${(a.entity_name || '').toLowerCase()}"
                                     style="display:flex; align-items:center; gap:8px; padding:10px; border-radius:12px; cursor:pointer; margin-bottom:4px; background:${activeBg}; border:${activeBorder}; transition:all 0.15s;"
                                     onmouseenter="this.style.background='rgba(255,255,255,0.06)'"
                                     onmouseleave="this.style.background='${activeBg}'"
                                     onclick="daSelectAdmin(${idx})">
                                    <span style="font-size:1.1rem;">${icon}</span>
                                    <div style="flex:1; min-width:0;">
                                        <div style="font-size:0.8rem; font-weight:500; color:#f1f5f9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${a.entity_name || ''}">${a.entity_name || 'Unknown'}</div>
                                        <div style="display:flex; gap:4px; margin-top:2px; flex-wrap:wrap;">
                                            ${hasFA ? '<span style="font-size:0.6rem; padding:1px 6px; border-radius:8px; background:rgba(245,158,11,0.2); color:#fbbf24;">Full Admin</span>' : `<span style="font-size:0.6rem; padding:1px 6px; border-radius:8px; background:rgba(139,92,246,0.15); color:#a78bfa;">${permCount} perms</span>`}
                                            ${deniedCount > 0 ? `<span style="font-size:0.6rem; padding:1px 6px; border-radius:8px; background:rgba(239,68,68,0.15); color:#f87171;">${deniedCount} denied</span>` : ''}
                                        </div>
                                    </div>
                                    ${isActive ? '<div style="width:4px; height:24px; border-radius:2px; background:#f59e0b; flex-shrink:0;"></div>' : ''}
                                </div>`;
                            }).join('')}
                        </div>
                        <div style="padding:8px 10px; border-top:1px solid rgba(255,255,255,0.06); text-align:center;">
                            <span style="font-size:0.7rem; color:#6b7280;">${admins.length} admin${admins.length !== 1 ? 's' : ''}</span>
                        </div>
                    </div>
                    
                    <!-- RIGHT: Detail Panel -->
                    <div style="flex:1; display:flex; flex-direction:column; background:rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.08); border-radius:16px; overflow:hidden;">
                        ${selAdmin ? (() => {
                            const sa = selAdmin;
                            const icon = sa.entity_type === 'user' ? 'ðŸ‘¤' : 'ðŸ‘¥';
                            const hasFA = sa.permissions?.includes('full_admin');
                            const denied = sa.denied_task_names || [];
                            
                            return `
                            <!-- Header -->
                            <div style="padding:16px 20px; border-bottom:1px solid rgba(255,255,255,0.06); display:flex; align-items:center; justify-content:space-between;">
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <div style="width:42px; height:42px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.3rem; background:rgba(245,158,11,0.15);">${icon}</div>
                                    <div>
                                        <div style="font-weight:600; color:#f1f5f9; font-size:0.95rem;">${sa.entity_name || 'Unknown'}</div>
                                        <div style="font-size:0.75rem; color:#6b7280;">${sa.entity_type === 'user' ? 'User' : 'Group'}</div>
                                    </div>
                                </div>
                                <button onclick="removeAgentAdmin('${sa.entity_id}')" style="padding:6px 14px; border-radius:10px; border:1px solid rgba(239,68,68,0.4); background:rgba(239,68,68,0.1); color:#f87171; font-size:0.75rem; cursor:pointer;">Remove</button>
                            </div>
                            
                            <!-- Scrollable content -->
                            <div style="flex:1; overflow-y:auto; padding:16px 20px;">
                                <!-- Section 1: Management Permissions -->
                                <div style="margin-bottom:20px;">
                                    <div style="font-size:0.8rem; font-weight:600; color:#fbbf24; margin-bottom:10px; display:flex; align-items:center; gap:6px;">
                                        <span>ðŸ”§</span> Management Permissions
                                    </div>
                                    
                                    <!-- Full Admin Toggle -->
                                    <label style="display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:12px; cursor:pointer; margin-bottom:10px; background:${hasFA ? 'rgba(245,158,11,0.12)' : 'rgba(255,255,255,0.03)'}; border:1px solid ${hasFA ? 'rgba(245,158,11,0.4)' : 'rgba(255,255,255,0.08)'}; transition:all 0.15s;">
                                        <input type="checkbox" onchange="toggleFullAdmin(${selIdx}, this.checked)" ${hasFA ? 'checked' : ''}
                                               style="width:18px; height:18px; border-radius:5px; accent-color:#f59e0b; cursor:pointer;">
                                        <div>
                                            <div style="font-size:0.875rem; font-weight:600; color:#fbbf24;">â­ Full Admin</div>
                                            <div style="font-size:0.7rem; color:#6b7280;">All permissions except delete</div>
                                        </div>
                                    </label>
                                    
                                    <!-- Granular Permissions -->
                                    ${!hasFA ? `
                                    <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:6px;">
                                        ${AGENT_PERMISSIONS.filter(p => p.id !== 'full_admin').map(perm => {
                                            const checked = sa.permissions?.includes(perm.id);
                                            const isDanger = perm.category === 'Danger';
                                            const bg = checked ? (isDanger ? 'rgba(239,68,68,0.08)' : 'rgba(139,92,246,0.08)') : 'rgba(255,255,255,0.02)';
                                            const border = checked ? (isDanger ? 'rgba(239,68,68,0.3)' : 'rgba(139,92,246,0.25)') : 'rgba(255,255,255,0.06)';
                                            
                                            return `
                                            <label style="display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; cursor:pointer; background:${bg}; border:1px solid ${border}; transition:all 0.15s;"
                                                   onmouseenter="this.style.background='rgba(255,255,255,0.05)'" onmouseleave="this.style.background='${bg}'">
                                                <input type="checkbox" onchange="toggleAdminPermission(${selIdx}, '${perm.id}', this.checked)" ${checked ? 'checked' : ''}
                                                       style="width:16px; height:16px; border-radius:4px; accent-color:${isDanger ? '#ef4444' : '#8b5cf6'}; cursor:pointer;">
                                                <div style="min-width:0;">
                                                    <div style="font-size:0.8rem; color:${isDanger ? '#f87171' : '#e2e8f0'}; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${perm.icon} ${perm.name}</div>
                                                    <div style="font-size:0.65rem; color:#6b7280;">${perm.desc}</div>
                                                </div>
                                            </label>`;
                                        }).join('')}
                                    </div>
                                    ` : '<div style="font-size:0.75rem; color:#6b7280; padding:8px 0;">All management permissions are granted. Uncheck Full Admin to customize.</div>'}
                                </div>
                                
                                <!-- Section 2: Chat / Task Permissions -->
                                <div>
                                    <div style="font-size:0.8rem; font-weight:600; color:#a78bfa; margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;">
                                        <span style="display:flex; align-items:center; gap:6px;"><span>ðŸ’¬</span> Chat Task Permissions</span>
                                        ${tasks.length > 0 ? `
                                        <div style="display:flex; gap:6px;">
                                            <button onclick="daSetAllTasks(${selIdx}, true)" style="padding:4px 10px; border-radius:8px; border:1px solid rgba(34,197,94,0.3); background:rgba(34,197,94,0.1); color:#4ade80; font-size:0.7rem; cursor:pointer;">Allow All</button>
                                            <button onclick="daSetAllTasks(${selIdx}, false)" style="padding:4px 10px; border-radius:8px; border:1px solid rgba(239,68,68,0.3); background:rgba(239,68,68,0.1); color:#f87171; font-size:0.7rem; cursor:pointer;">Deny All</button>
                                        </div>
                                        ` : ''}
                                    </div>
                                    
                                    ${tasks.length > 0 ? `
                                    <div style="display:flex; flex-direction:column; gap:6px;">
                                        ${tasks.map(task => {
                                            const taskName = task.name || 'Unnamed Task';
                                            const isDenied = denied.includes(taskName);
                                            const bg = isDenied ? 'rgba(239,68,68,0.06)' : 'rgba(34,197,94,0.06)';
                                            const border = isDenied ? '1px solid rgba(239,68,68,0.2)' : '1px solid rgba(34,197,94,0.2)';
                                            
                                            return `
                                            <label style="display:flex; align-items:center; gap:12px; padding:11px 14px; border-radius:10px; cursor:pointer; background:${bg}; border:${border}; transition:all 0.15s;">
                                                <input type="checkbox" onchange="toggleAdminTaskAccess(${selIdx}, '${escHtml(taskName)}', this.checked)" ${!isDenied ? 'checked' : ''}
                                                       style="width:18px; height:18px; border-radius:5px; accent-color:#22c55e; cursor:pointer; flex-shrink:0;">
                                                <div style="flex:1; min-width:0;">
                                                    <div style="font-size:0.85rem; color:${isDenied ? '#f87171' : '#f1f5f9'}; ${isDenied ? 'text-decoration:line-through;' : ''}">${escHtml(taskName)}</div>
                                                    ${task.description ? '<div style="font-size:0.7rem; color:#6b7280; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">' + (task.description || '').slice(0, 70) + '</div>' : ''}
                                                </div>
                                                <span style="font-size:0.7rem; padding:3px 10px; border-radius:8px; font-weight:500; flex-shrink:0; background:${isDenied ? 'rgba(239,68,68,0.15)' : 'rgba(34,197,94,0.15)'}; color:${isDenied ? '#f87171' : '#4ade80'};">${isDenied ? 'Denied' : 'Allowed'}</span>
                                            </label>`;
                                        }).join('')}
                                    </div>
                                    ` : '<div style="font-size:0.75rem; color:#6b7280; text-align:center; padding:16px;">No tasks defined yet. Add tasks in the Tasks step.</div>'}
                                </div>
                            </div>
                            `;
                        })() : `
                            <div style="flex:1; display:flex; align-items:center; justify-content:center; color:#6b7280; font-size:0.875rem;">
                                Select an admin from the list
                            </div>
                        `}
                    </div>
                </div>
            `;
        }
        
        // Select admin in master-detail panel
        function daSelectAdmin(idx) {
            window._daSelectedIdx = idx;
            renderDelegatedAdmins();
        }
        
        // Filter admin list
        function daFilterAdmins(query) {
            const items = document.querySelectorAll('.da-admin-item');
            const q = (query || '').toLowerCase();
            items.forEach(item => {
                const name = item.getAttribute('data-name') || '';
                item.style.display = !q || name.includes(q) ? 'flex' : 'none';
            });
        }
        
        // Allow/Deny all tasks for a delegated admin
        function daSetAllTasks(index, allowed) {
            const admin = agentAdminState.delegatedAdmins[index];
            if (!admin) return;
            const tasks = wizard.tasks || [];
            if (allowed) {
                admin.denied_task_names = [];
            } else {
                admin.denied_task_names = tasks.map(t => t.name || 'Unnamed Task');
            }
            saveAgentManagement();
            renderDelegatedAdmins();
        }
        
        // Toggle task access for admin
        function toggleAdminTaskAccess(index, taskName, allowed) {
            const admin = agentAdminState.delegatedAdmins[index];
            if (!admin) return;
            
            admin.denied_task_names = admin.denied_task_names || [];
            
            if (allowed) {
                admin.denied_task_names = admin.denied_task_names.filter(t => t !== taskName);
            } else {
                if (!admin.denied_task_names.includes(taskName)) {
                    admin.denied_task_names.push(taskName);
                }
            }
            
            saveAgentManagement();
            renderDelegatedAdmins();
        }
        
        // Toggle full admin permission
        function toggleFullAdmin(index, checked) {
            const admin = agentAdminState.delegatedAdmins[index];
            if (!admin) return;
            
            if (checked) {
                admin.permissions = ['full_admin'];
            } else {
                admin.permissions = [];
            }
            
            saveAgentManagement();
            renderDelegatedAdmins();
        }
        
        // Toggle individual permission
        function toggleAdminPermission(index, permId, checked) {
            const admin = agentAdminState.delegatedAdmins[index];
            if (!admin) return;
            
            admin.permissions = admin.permissions || [];
            admin.permissions = admin.permissions.filter(p => p !== 'full_admin');
            
            if (checked) {
                if (!admin.permissions.includes(permId)) {
                    admin.permissions.push(permId);
                }
            } else {
                admin.permissions = admin.permissions.filter(p => p !== permId);
            }
            
            saveAgentManagement();
            renderDelegatedAdmins();
        }
        
        // Save management config to backend
        async function saveAgentManagement() {
            const agentId = wizard.id;
            if (!agentId) return;
            
            const orgId = currentUser?.org_id || 'default';
            
            try {
                await fetch(`/api/access-control/agents/${agentId}/management?org_id=${orgId}`, {
                    method: 'PUT',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        delegated_admins: agentAdminState.delegatedAdmins.map(a => ({
                            entity_id: a.entity_id,
                            entity_type: a.entity_type,
                            permissions: a.permissions || [],
                            denied_task_names: a.denied_task_names || []  // Chat permissions
                        }))
                    })
                });
                console.log('âœ… Agent management saved (including chat permissions)');
            } catch (e) {
                console.error('Failed to save agent management:', e);
            }
        }
        
        // Add agent admin (with default full_admin)
        async function addAgentAdmin(id, type, name) {
            const agentId = wizard.id;
            if (!agentId) {
                showToast('Save the agent first before adding admins', 'warning');
                return;
            }
            
            // Check if already exists
            if (agentAdminState.delegatedAdmins.some(a => a.entity_id === id)) {
                showToast('This user/group is already an admin', 'warning');
                return;
            }
            
            // Add to state with full_admin by default
            agentAdminState.delegatedAdmins.push({
                entity_id: id,
                entity_type: type,
                entity_name: name,
                permissions: ['full_admin']
            });
            
            await saveAgentManagement();
            renderDelegatedAdmins();
            showToast('Admin added with full permissions', 'success');
            
            // Clear search
            document.getElementById('wizard-admin-search').value = '';
            document.getElementById('wizard-admin-search-results')?.classList.add('hidden');
        }
        
        // Remove agent admin
        async function removeAgentAdmin(id) {
            agentAdminState.delegatedAdmins = agentAdminState.delegatedAdmins.filter(a => a.entity_id !== id);
            await saveAgentManagement();
            renderDelegatedAdmins();
            showToast('Admin removed', 'success');
        }
        
        // Show/hide permissions guide
        function showPermissionsGuide() {
            const guide = document.getElementById('permissions-guide');
            if (guide) {
                guide.classList.toggle('hidden');
            }
        }
        
        // Search for potential admins
        function searchPotentialAdmins(query) {
            const container = document.getElementById('wizard-admin-search-results');
            if (!container) return;
            
            if (!query || query.length < 2) {
                container.classList.add('hidden');
                return;
            }
            
            const q = query.toLowerCase();
            
            // Filter users and groups
            const matchedUsers = wizardAccessState.allUsers.filter(u => 
                (u.name && u.name.toLowerCase().includes(q)) ||
                (u.email && u.email.toLowerCase().includes(q))
            ).slice(0, 5);
            
            const matchedGroups = wizardAccessState.allGroups.filter(g =>
                g.name && g.name.toLowerCase().includes(q)
            ).slice(0, 5);
            
            // Get already added admin IDs
            const existingAdminIds = agentAdminState.delegatedAdmins.map(a => a.entity_id);
            
            // Exclude already added admins
            const results = [
                ...matchedUsers.filter(u => !existingAdminIds.includes(u.id)).map(u => ({
                    id: u.id,
                    name: u.name || u.email,
                    type: 'user',
                    icon: 'ðŸ‘¤'
                })),
                ...matchedGroups.filter(g => !existingAdminIds.includes(g.id)).map(g => ({
                    id: g.id,
                    name: g.name,
                    type: 'group',
                    icon: 'ðŸ‘¥'
                }))
            ];
            
            if (results.length === 0) {
                container.innerHTML = '<p class="p-3 text-sm text-gray-400">No results found</p>';
            } else {
                container.innerHTML = results.map(r => `
                    <div class="p-3 hover:bg-gray-600 cursor-pointer flex items-center gap-3 border-b border-gray-600 last:border-0" onclick="addAgentAdmin('${r.id}', '${r.type}', '${r.name.replace(/'/g, "\\'")}')">
                        <span class="text-xl">${r.icon}</span>
                        <div class="flex-1">
                            <div class="font-medium text-sm text-white">${r.name}</div>
                            <span class="text-xs px-2 py-0.5 rounded bg-gray-600 text-gray-300">${r.type}</span>
                        </div>
                    </div>
                `).join('');
            }
            
            container.classList.remove('hidden');
        }
        
        // Check if current user can manage access control for this agent
        async function canManageAgentAccess() {
            // For new agents, the creator will be the owner
            if (!wizard.id) return true;
            
            // Check if owner
            if (isAgentOwner()) return true;
            
            // Check if delegated admin via API
            try {
                const orgId = currentUser?.org_id || 'default';
                const response = await fetch(`/api/access-control/agents/${wizard.id}/admins?org_id=${orgId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const adminUserIds = data.admin_user_ids || [];
                    const adminGroupIds = data.admin_group_ids || [];
                    
                    // Check if current user is in admin list
                    if (adminUserIds.includes(currentUser?.id)) return true;
                    
                    // Check if any of user's groups are in admin list
                    const userGroups = currentUser?.group_ids || [];
                    if (userGroups.some(g => adminGroupIds.includes(g))) return true;
                }
            } catch (e) {
                console.error('Error checking agent admin status:', e);
            }
            
            return false;
        }
        
        // Initialize wizard access control event listeners
        async function initWizardAccessControl() {
            // SECURITY: Only show access control for OWNER or DELEGATED ADMINS
            // Even platform super admins cannot see other users' agent access control
            const accessControlSection = document.getElementById('wizard-access-control-section');
            const ownerBadge = document.getElementById('ac-owner-badge');
            const canManage = await canManageAgentAccess();
            
            // Check if current user is the owner (for badge display)
            const isOwner = isAgentOwner();
            
            if (accessControlSection) {
                accessControlSection.style.display = canManage ? 'block' : 'none';
            }
            
            // Show owner badge if user is the owner
            if (ownerBadge) {
                if (isOwner || !wizard.id) {  // New agents - creator will be owner
                    ownerBadge.classList.remove('hidden');
                    ownerBadge.style.display = 'inline-flex';
                } else {
                    ownerBadge.classList.add('hidden');
                    ownerBadge.style.display = 'none';
                }
            }
            
            // Pre-load users/groups if user can manage access
            if (authToken && canManage) {
                loadWizardAccessEntities();
            }
            
            // Search input listener for access entities
            const searchInput = document.getElementById('wizard-access-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value;
                    if (query.length >= 2) {
                        searchWizardAccessEntities(query);
                    } else {
                        document.getElementById('wizard-access-search-results')?.classList.add('hidden');
                    }
                });
            }
            
            // Search input listener for admin delegation
            const adminSearchInput = document.getElementById('wizard-admin-search');
            if (adminSearchInput) {
                adminSearchInput.addEventListener('input', (e) => {
                    const query = e.target.value;
                    if (query.length >= 2) {
                        searchPotentialAdmins(query);
                    } else {
                        document.getElementById('wizard-admin-search-results')?.classList.add('hidden');
                    }
                });
            }
            
            // Load agent admins if editing an existing agent (only for owner)
            const agentId = wizard.id || wizard.editId;
            const delegateSection = document.getElementById('wizard-delegate-admin-section');
            
            if (agentId && isAgentOwner()) {
                if (delegateSection) { delegateSection.classList.remove('hidden'); delegateSection.style.display = 'block'; }
                loadAgentAdmins(agentId);
            } else {
                if (delegateSection) delegateSection.style.display = 'none';
            }
        }
        
        // Select access type (public, authenticated, specific)
        function selectWizardAccessType(type) {
            wizardAccessState.accessType = type;
            
            // Update visual selection for new card design
            document.querySelectorAll('.access-type-card').forEach(card => {
                const cardType = card.dataset.value;
                const checkmark = card.querySelector('.access-check');
                
                // Reset all cards
                card.classList.remove('ac-selected');
                card.style.boxShadow = 'none';
                if (checkmark) checkmark.classList.add('hidden');
                
                // Style selected card
                if (cardType === type) {
                    card.classList.add('ac-selected');
                    if (checkmark) checkmark.classList.remove('hidden');
                    
                    if (type === 'public') {
                        card.style.background = 'linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%)';
                        card.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                        card.style.boxShadow = '0 4px 20px rgba(34, 197, 94, 0.2)';
                    } else if (type === 'authenticated') {
                        card.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.05) 100%)';
                        card.style.borderColor = 'rgba(59, 130, 246, 0.5)';
                        card.style.boxShadow = '0 4px 20px rgba(59, 130, 246, 0.2)';
                    } else if (type === 'specific') {
                        card.style.background = 'linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(168, 85, 247, 0.05) 100%)';
                        card.style.borderColor = 'rgba(168, 85, 247, 0.5)';
                        card.style.boxShadow = '0 4px 20px rgba(168, 85, 247, 0.2)';
                    }
                } else {
                    // Reset unselected cards
                    if (cardType === 'public') {
                        card.style.background = 'rgba(34, 197, 94, 0.05)';
                        card.style.borderColor = 'rgba(34, 197, 94, 0.2)';
                    } else if (cardType === 'authenticated') {
                        card.style.background = 'rgba(59, 130, 246, 0.05)';
                        card.style.borderColor = 'rgba(59, 130, 246, 0.2)';
                    } else if (cardType === 'specific') {
                        card.style.background = 'rgba(168, 85, 247, 0.05)';
                        card.style.borderColor = 'rgba(168, 85, 247, 0.2)';
                    }
                }
            });
            
            updateWizardAccessUI();
        }
        
        function updateWizardAccessUI() {
            const specificSection = document.getElementById('wizard-access-specific-section');
            const taskPermSection = document.getElementById('wizard-task-permissions-section');
            
            // Sync task permissions with current tasks
            syncTaskPermissions();
            
            if (wizardAccessState.accessType === 'specific') {
                specificSection?.classList.remove('hidden');
                // Load users/groups if not loaded
                if (wizardAccessState.allUsers.length === 0) {
                    loadWizardAccessEntities();
                }
                
                // Always show task permissions when specific access is selected
                // (even without selected entities - shows global permissions)
                taskPermSection?.classList.remove('hidden');
                renderWizardTaskPermissions();
            } else if (wizardAccessState.accessType === 'authenticated') {
                // For authenticated users, also allow task-level permissions
                specificSection?.classList.add('hidden');
                taskPermSection?.classList.remove('hidden');
                renderWizardTaskPermissions();
            } else {
                // Public access - no need for granular permissions
                specificSection?.classList.add('hidden');
                taskPermSection?.classList.add('hidden');
            }
            
            renderWizardSelectedEntities();
        }
        
        // Load users and groups for access control
        async function loadWizardAccessEntities() {
            try {
                const headers = getAuthHeaders();
                const [usersRes, groupsRes] = await Promise.all([
                    fetch('/api/security/users', { headers, credentials: 'include' }),
                    fetch('/api/security/groups', { headers, credentials: 'include' })
                ]);
                
                if (usersRes.ok) {
                    const usersData = await usersRes.json();
                    wizardAccessState.allUsers = Array.isArray(usersData) ? usersData : (usersData.users || []);
                }
                
                if (groupsRes.ok) {
                    const groupsData = await groupsRes.json();
                    wizardAccessState.allGroups = Array.isArray(groupsData) ? groupsData : (groupsData.groups || []);
                }
            } catch (e) {
                console.error('Failed to load users/groups:', e);
            }
        }
        
        async function searchWizardAccessEntities(query) {
            if (!query || query.length < 2) {
                document.getElementById('wizard-access-search-results')?.classList.add('hidden');
                return;
            }
            
            // Load users and groups if not already loaded
            if (wizardAccessState.allUsers.length === 0) {
                await loadWizardAccessEntities();
            }
            
            const lowerQuery = query.toLowerCase();
            const results = [];
            
            // Search users
            const users = Array.isArray(wizardAccessState.allUsers) ? wizardAccessState.allUsers : [];
            users.forEach(u => {
                const firstName = u.profile?.first_name || u.first_name || '';
                const lastName = u.profile?.last_name || u.last_name || '';
                const name = u.name || `${firstName} ${lastName}`.trim() || u.email || '';
                const email = u.email || '';
                
                if (name.toLowerCase().includes(lowerQuery) || email.toLowerCase().includes(lowerQuery)) {
                    if (!wizardAccessState.selectedEntities.find(e => e.id === u.id && e.type === 'user')) {
                        results.push({ id: u.id, name: name || email, email: email, type: 'user', icon: 'ðŸ‘¤' });
                    }
                }
            });
            
            // Search groups
            const groups = Array.isArray(wizardAccessState.allGroups) ? wizardAccessState.allGroups : [];
            groups.forEach(g => {
                const name = g.name || '';
                if (name.toLowerCase().includes(lowerQuery)) {
                    if (!wizardAccessState.selectedEntities.find(e => e.id === g.id && e.type === 'group')) {
                        results.push({ id: g.id, name: name, type: 'group', icon: 'ðŸ‘¥' });
                    }
                }
            });
            
            console.log('Search results for "' + query + '":', results.length);
            renderWizardSearchResults(results);
        }
        
        function renderWizardSearchResults(results) {
            const container = document.getElementById('wizard-access-search-results');
            if (!container) return;
            
            if (results.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.innerHTML = results.slice(0, 10).map(r => `
                <div class="p-3 hover:bg-gray-600 cursor-pointer flex items-center gap-3 border-b border-gray-600 last:border-0"
                     onclick="selectWizardAccessEntity('${r.id}', '${r.name.replace(/'/g, "\\'")}', '${r.type}', '${r.icon}')">
                    <span class="text-xl">${r.icon}</span>
                    <div class="flex-1">
                        <div class="font-medium text-sm text-white">${r.name}</div>
                        ${r.email ? `<div class="text-xs text-gray-400">${r.email}</div>` : ''}
                        <span class="text-xs px-2 py-0.5 rounded bg-gray-600 text-gray-300">${r.type}</span>
                    </div>
                </div>
            `).join('');
            container.classList.remove('hidden');
        }
        
        function selectWizardAccessEntity(id, name, type, icon) {
            wizardAccessState.selectedEntities.push({ id, name, type, icon });
            document.getElementById('wizard-access-search').value = '';
            document.getElementById('wizard-access-search-results')?.classList.add('hidden');
            updateWizardAccessUI();
        }
        
        function removeWizardAccessEntity(id) {
            wizardAccessState.selectedEntities = wizardAccessState.selectedEntities.filter(e => e.id !== id);
            updateWizardAccessUI();
        }
        
        function renderWizardSelectedEntities() {
            const container = document.getElementById('wizard-access-selected');
            if (!container) return;
            
            // Update stats
            const userCount = wizardAccessState.selectedEntities.filter(e => e.type === 'user').length;
            const groupCount = wizardAccessState.selectedEntities.filter(e => e.type === 'group').length;
            const userStat = document.getElementById('ac-stat-users');
            const groupStat = document.getElementById('ac-stat-groups');
            if (userStat) userStat.textContent = userCount;
            if (groupStat) groupStat.textContent = groupCount;
            
            // Show stats if we have specific users selected
            const statsContainer = document.getElementById('ac-quick-stats');
            if (statsContainer) {
                statsContainer.style.display = wizardAccessState.accessType === 'specific' && wizardAccessState.selectedEntities.length > 0 ? 'flex' : 'none';
            }
            
            if (wizardAccessState.selectedEntities.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500 italic py-2">Select users or groups from the search above</div>';
                return;
            }
            
            container.innerHTML = wizardAccessState.selectedEntities.map(e => {
                const isUser = e.type === 'user';
                const bgColor = isUser ? 'rgba(139, 92, 246, 0.15)' : 'rgba(59, 130, 246, 0.15)';
                const borderColor = isUser ? 'rgba(139, 92, 246, 0.4)' : 'rgba(59, 130, 246, 0.4)';
                const iconBg = isUser ? 'rgba(139, 92, 246, 0.3)' : 'rgba(59, 130, 246, 0.3)';
                
                return `
                    <div class="group inline-flex items-center gap-3 px-4 py-2.5 rounded-xl transition-all hover:scale-[1.02]" 
                         style="background: ${bgColor}; border: 1px solid ${borderColor};">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm" style="background: ${iconBg};">
                            ${isUser ? `
                                <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            ` : `
                                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                            `}
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-white">${e.name}</div>
                            <div class="text-xs text-gray-500">${isUser ? 'User' : 'Group'}</div>
                        </div>
                        <button onclick="removeWizardAccessEntity('${e.id}')" 
                                class="w-6 h-6 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-red-500/20 hover:bg-red-500/40 text-red-400">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        function renderWizardTaskPermissions() {
            const container = document.getElementById('wizard-task-permissions-grid');
            if (!container) return;
            
            const tasks = wizard.tasks || [];
            const entities = wizardAccessState.selectedEntities || [];
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-2xl flex items-center justify-center" style="background: rgba(255,255,255,0.05);">
                            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                        </div>
                        <p class="text-gray-500 text-sm">Define tasks in the Tasks step first</p>
                        <button onclick="goToStep(2)" class="mt-3 text-purple-400 text-sm hover:underline">Go to Tasks â†’</button>
                    </div>
                `;
                return;
            }
            
            if (entities.length === 0) {
                // No specific entities - show simple allow/deny per task (global default)
                container.innerHTML = `
                    <div class="flex items-center gap-3 p-4 rounded-xl mb-4" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%); border: 1px solid rgba(59, 130, 246, 0.3);">
                        <svg class="w-5 h-5 text-blue-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-sm text-blue-300">These permissions apply to all authenticated users. Select "Specific Users" above to configure per-user permissions.</p>
                    </div>
                    <div class="space-y-3">
                        ${tasks.map((task, i) => {
                            const taskId = task.id || `task-${i}`;
                            const isAllowed = getTaskPermission(taskId, 'default') !== false;
                            
                            return `
                            <div class="flex items-center justify-between p-4 rounded-xl transition-all" 
                                 style="background: ${isAllowed ? 'rgba(34, 197, 94, 0.08)' : 'rgba(239, 68, 68, 0.08)'}; 
                                        border: 1px solid ${isAllowed ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)'};">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-xl flex items-center justify-center" 
                                         style="background: ${isAllowed ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'};">
                                        <svg class="w-5 h-5 ${isAllowed ? 'text-green-400' : 'text-red-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            ${isAllowed 
                                                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
                                                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'}
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-medium text-white">${task.name || 'Unnamed Task'}</div>
                                        <div class="text-xs text-gray-500 truncate max-w-md">${(task.description || '').slice(0, 60)}${task.description?.length > 60 ? '...' : ''}</div>
                                    </div>
                                </div>
                                <button onclick="toggleWizardTaskPermission('${taskId}', 'default', ${!isAllowed}); renderWizardTaskPermissions();"
                                        class="px-5 py-2.5 rounded-xl font-medium text-sm transition-all flex items-center gap-2"
                                        style="background: ${isAllowed ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
                                               border: 1px solid ${isAllowed ? 'rgba(34, 197, 94, 0.4)' : 'rgba(239, 68, 68, 0.4)'};
                                               color: ${isAllowed ? '#4ade80' : '#f87171'};">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        ${isAllowed 
                                            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
                                            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'}
                                    </svg>
                                    ${isAllowed ? 'Allowed' : 'Denied'}
                                </button>
                            </div>
                        `}).join('')}
                    </div>
                `;
                return;
            }
            
            // ===================================================================
            // Master-Detail Split Panel (Enterprise IAM pattern)
            // Left: searchable entity list   Right: selected entity's permissions
            // Scales to 100+ users/groups with search, filter, bulk actions.
            // ===================================================================
            
            // Track which entity is selected for detail view
            const selId = window._acSelectedEntityId || entities[0]?.id || null;
            const selEntity = entities.find(e => e.id === selId) || entities[0];
            
            // Pre-compute per-entity stats
            const entityStats = {};
            entities.forEach(e => {
                let denied = 0;
                tasks.forEach((t, i) => {
                    if (getTaskPermission(t.id || `task-${i}`, e.id) === false) denied++;
                });
                entityStats[e.id] = { denied, allowed: tasks.length - denied };
            });
            
            // --- Bulk selection state ---
            const bulkSel = window._acBulkSelected || new Set();
            const hasBulk = bulkSel.size > 0;
            
            container.innerHTML = `
                <!-- Bulk Actions Bar -->
                ${hasBulk ? `
                <div class="flex items-center justify-between p-3 rounded-xl mb-3" style="background: rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.4);">
                    <span class="text-sm text-purple-300"><strong>${bulkSel.size}</strong> selected</span>
                    <div class="flex gap-2">
                        <button onclick="acBulkApply(true)" class="px-3 py-1.5 text-xs rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 font-medium">Allow All Tasks</button>
                        <button onclick="acBulkApply(false)" class="px-3 py-1.5 text-xs rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 font-medium">Deny All Tasks</button>
                        <button onclick="acBulkClear()" class="px-3 py-1.5 text-xs rounded-lg bg-gray-500/20 text-gray-400 hover:bg-gray-500/30">Clear</button>
                    </div>
                </div>
                ` : ''}
                
                <div style="display:flex; gap:12px; min-height:340px;">
                    <!-- LEFT: Entity List -->
                    <div style="width:260px; flex-shrink:0; display:flex; flex-direction:column; background:rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.08); border-radius:16px; overflow:hidden;">
                        <!-- Search -->
                        <div style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.06);">
                            <input type="text" id="ac-entity-filter" oninput="acFilterEntities(this.value)"
                                   placeholder="Filter users/groups..."
                                   style="width:100%; padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:#f1f5f9; font-size:0.8rem; outline:none;">
                        </div>
                        <!-- Scrollable list -->
                        <div id="ac-entity-list" style="flex:1; overflow-y:auto; padding:6px;">
                            ${entities.map(e => {
                                const isUser = e.type === 'user';
                                const st = entityStats[e.id] || { allowed: tasks.length, denied: 0 };
                                const isActive = selEntity && e.id === selEntity.id;
                                const isBulkChecked = bulkSel.has(e.id);
                                const activeBg = isActive ? 'rgba(139, 92, 246, 0.25)' : 'transparent';
                                const activeBorder = isActive ? '2px solid rgba(139, 92, 246, 0.6)' : '2px solid transparent';
                                
                                return `
                                <div class="ac-entity-item" data-name="${(e.name || '').toLowerCase()}" data-type="${e.type}"
                                     style="display:flex; align-items:center; gap:8px; padding:10px; border-radius:12px; cursor:pointer; margin-bottom:4px; background:${activeBg}; border:${activeBorder}; transition:all 0.15s;"
                                     onmouseenter="this.style.background='rgba(255,255,255,0.06)'"
                                     onmouseleave="this.style.background='${activeBg}'"
                                     onclick="acSelectEntity('${e.id}')">
                                    <input type="checkbox" ${isBulkChecked ? 'checked' : ''} 
                                           onclick="event.stopPropagation(); acToggleBulk('${e.id}', this.checked)"
                                           style="width:16px; height:16px; border-radius:4px; flex-shrink:0; accent-color:#8b5cf6; cursor:pointer;">
                                    <div style="flex:1; min-width:0;">
                                        <div style="display:flex; align-items:center; gap:6px;">
                                            <span style="font-size:1rem;">${isUser ? 'ðŸ‘¤' : 'ðŸ‘¥'}</span>
                                            <span style="font-size:0.8rem; font-weight:500; color:#f1f5f9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${e.name || ''}">${e.name || 'Unknown'}</span>
                                        </div>
                                        <div style="display:flex; gap:6px; margin-top:3px;">
                                            <span style="font-size:0.65rem; padding:1px 6px; border-radius:8px; background:rgba(34,197,94,0.15); color:#4ade80;">${st.allowed}</span>
                                            ${st.denied > 0 ? `<span style="font-size:0.65rem; padding:1px 6px; border-radius:8px; background:rgba(239,68,68,0.15); color:#f87171;">${st.denied}</span>` : ''}
                                        </div>
                                    </div>
                                    ${isActive ? '<div style="width:4px; height:24px; border-radius:2px; background:#8b5cf6; flex-shrink:0;"></div>' : ''}
                                </div>`;
                            }).join('')}
                        </div>
                        <div style="padding:8px 10px; border-top:1px solid rgba(255,255,255,0.06); text-align:center;">
                            <span style="font-size:0.7rem; color:#6b7280;">${entities.length} entities</span>
                        </div>
                    </div>
                    
                    <!-- RIGHT: Detail Panel -->
                    <div style="flex:1; display:flex; flex-direction:column; background:rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.08); border-radius:16px; overflow:hidden;">
                        ${selEntity ? (() => {
                            const se = selEntity;
                            const isUser = se.type === 'user';
                            const st = entityStats[se.id] || { allowed: tasks.length, denied: 0 };
                            
                            return `
                            <!-- Detail Header -->
                            <div style="padding:16px 20px; border-bottom:1px solid rgba(255,255,255,0.06); display:flex; align-items:center; justify-content:space-between;">
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <div style="width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.3rem; background:${isUser ? 'rgba(139,92,246,0.2)' : 'rgba(59,130,246,0.2)'};">
                                        ${isUser ? 'ðŸ‘¤' : 'ðŸ‘¥'}
                                    </div>
                                    <div>
                                        <div style="font-weight:600; color:#f1f5f9; font-size:0.95rem;">${se.name || 'Unknown'}</div>
                                        <div style="font-size:0.75rem; color:#6b7280;">${isUser ? 'User' : 'Group'} &middot; ${st.allowed} allowed, ${st.denied} denied</div>
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <button onclick="setAllEntityTasks('${se.id}', true)" style="padding:6px 14px; border-radius:10px; border:1px solid rgba(34,197,94,0.4); background:rgba(34,197,94,0.15); color:#4ade80; font-size:0.75rem; font-weight:600; cursor:pointer;">Allow All</button>
                                    <button onclick="setAllEntityTasks('${se.id}', false)" style="padding:6px 14px; border-radius:10px; border:1px solid rgba(239,68,68,0.4); background:rgba(239,68,68,0.15); color:#f87171; font-size:0.75rem; font-weight:600; cursor:pointer;">Deny All</button>
                                </div>
                            </div>
                            
                            <!-- Task List (scrollable) -->
                            <div style="flex:1; overflow-y:auto; padding:12px 16px;">
                                <div style="display:flex; flex-direction:column; gap:8px;">
                                    ${tasks.map((task, tIdx) => {
                                        const taskId = task.id || 'task-' + tIdx;
                                        const isAllowed = getTaskPermission(taskId, se.id) !== false;
                                        const bg = isAllowed ? 'rgba(34,197,94,0.06)' : 'rgba(239,68,68,0.06)';
                                        const border = isAllowed ? '1px solid rgba(34,197,94,0.2)' : '1px solid rgba(239,68,68,0.2)';
                                        
                                        return `
                                        <label style="display:flex; align-items:center; gap:12px; padding:12px 14px; border-radius:12px; cursor:pointer; background:${bg}; border:${border}; transition:all 0.15s;"
                                               onmouseenter="this.style.background='rgba(255,255,255,0.04)'"
                                               onmouseleave="this.style.background='${bg}'">
                                            <input type="checkbox"
                                                   onchange="toggleWizardTaskPermission('${taskId}', '${se.id}', this.checked); renderWizardTaskPermissions();"
                                                   ${isAllowed ? 'checked' : ''}
                                                   style="width:18px; height:18px; border-radius:5px; accent-color:#22c55e; cursor:pointer; flex-shrink:0;">
                                            <div style="flex:1; min-width:0;">
                                                <div style="font-size:0.875rem; font-weight:500; color:${isAllowed ? '#f1f5f9' : '#f87171'}; ${isAllowed ? '' : 'text-decoration:line-through;'}">${task.name || 'Unnamed Task'}</div>
                                                ${task.description ? `<div style="font-size:0.7rem; color:#6b7280; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${(task.description || '').slice(0, 80)}</div>` : ''}
                                            </div>
                                            <span style="font-size:0.7rem; padding:3px 10px; border-radius:8px; font-weight:500; flex-shrink:0;
                                                         background:${isAllowed ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)'}; 
                                                         color:${isAllowed ? '#4ade80' : '#f87171'};">${isAllowed ? 'Allowed' : 'Denied'}</span>
                                        </label>`;
                                    }).join('')}
                                </div>
                            </div>
                            `;
                        })() : `
                            <div style="flex:1; display:flex; align-items:center; justify-content:center; color:#6b7280; font-size:0.875rem;">
                                Select a user or group from the list
                            </div>
                        `}
                    </div>
                </div>
            `;
        }
        
        function getTaskPermission(taskId, entityId) {
            // Check specific entity permission first
            const key = `${taskId}:${entityId}`;
            if (wizardAccessState.taskPermissions[key] !== undefined) {
                return wizardAccessState.taskPermissions[key];
            }
            // Fall back to default (allowed)
            return true;
        }
        
        function toggleWizardTaskPermission(taskId, entityId, allowed) {
            const key = `${taskId}:${entityId}`;
            wizardAccessState.taskPermissions[key] = allowed;
            
            // Save immediately like delegated admins do
            saveUserTaskPermissions();
        }
        
        // Select an entity in the master-detail panel
        function acSelectEntity(entityId) {
            window._acSelectedEntityId = entityId;
            renderWizardTaskPermissions();
        }
        
        // Filter entity list by search query
        function acFilterEntities(query) {
            const items = document.querySelectorAll('.ac-entity-item');
            const q = (query || '').toLowerCase();
            items.forEach(item => {
                const name = item.getAttribute('data-name') || '';
                const type = item.getAttribute('data-type') || '';
                const match = !q || name.includes(q) || type.includes(q);
                item.style.display = match ? 'flex' : 'none';
            });
        }
        
        // Bulk selection
        function acToggleBulk(entityId, checked) {
            if (!window._acBulkSelected) window._acBulkSelected = new Set();
            if (checked) {
                window._acBulkSelected.add(entityId);
            } else {
                window._acBulkSelected.delete(entityId);
            }
            renderWizardTaskPermissions();
        }
        
        function acBulkClear() {
            window._acBulkSelected = new Set();
            renderWizardTaskPermissions();
        }
        
        // Apply permissions in bulk to all selected entities
        function acBulkApply(allowed) {
            const sel = window._acBulkSelected || new Set();
            const tasks = wizard.tasks || [];
            sel.forEach(entityId => {
                tasks.forEach((task, i) => {
                    const taskId = task.id || `task-${i}`;
                    wizardAccessState.taskPermissions[`${taskId}:${entityId}`] = allowed;
                });
            });
            saveUserTaskPermissions();
            window._acBulkSelected = new Set();
            renderWizardTaskPermissions();
        }
        
        // Allow or deny all tasks for a specific entity
        function setAllEntityTasks(entityId, allowed) {
            const tasks = wizard.tasks || [];
            tasks.forEach((task, i) => {
                const taskId = task.id || `task-${i}`;
                const key = `${taskId}:${entityId}`;
                wizardAccessState.taskPermissions[key] = allowed;
            });
            saveUserTaskPermissions();
            renderWizardTaskPermissions();
        }
        
        // Save user task permissions immediately (same pattern as saveAgentManagement)
        async function saveUserTaskPermissions() {
            const agentId = wizard.id || wizard.editId;
            if (!agentId) {
                console.log('â­ï¸ No agent ID yet, skipping task permissions save');
                return;
            }
            
            const orgId = currentUser?.org_id || 'default';
            
            // âœ¨ NEW APPROACH: Same as delegated admins
            // Save denied_task_names with each entity via /access endpoint
            const tasks = wizard.tasks || [];
            const entities = wizardAccessState.selectedEntities || [];
            
            // Build entities with denied_task_names (same as delegated admin approach)
            const entitiesWithPermissions = entities.map(e => {
                const deniedTaskNames = [];
                
                tasks.forEach((task, i) => {
                    const taskId = task.id || `task-${i}`;
                    const key = `${taskId}:${e.id}`;
                    if (wizardAccessState.taskPermissions[key] === false) {
                        deniedTaskNames.push(task.name);
                    }
                });
                
                return {
                    id: e.id,
                    type: e.type,
                    name: e.name,
                    denied_task_names: deniedTaskNames.length > 0 ? deniedTaskNames : null
                };
            });
            
            try {
                // Save via /access endpoint (same as delegated admins use /management)
                await fetch(`/api/access-control/agents/${agentId}/access?org_id=${orgId}`, {
                    method: 'PUT',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        access_type: wizardAccessState.accessType || 'specific',
                        entities: entitiesWithPermissions
                    })
                });
                console.log('âœ… User task permissions saved via /access (same as delegated admins)');
            } catch (e) {
                console.error('âŒ Failed to save user task permissions:', e);
            }
        }
        
        function toggleAllEntitiesForTask(taskId) {
            const entities = wizardAccessState.selectedEntities || [];
            // Check current state of first entity
            const firstKey = `${taskId}:${entities[0]?.id || 'default'}`;
            const currentState = wizardAccessState.taskPermissions[firstKey] !== false;
            const newState = !currentState;
            
            // Toggle all entities for this task
            entities.forEach(e => {
                wizardAccessState.taskPermissions[`${taskId}:${e.id}`] = newState;
            });
            wizardAccessState.taskPermissions[`${taskId}:default`] = newState;
            
            // Save immediately
            saveUserTaskPermissions();
            renderWizardTaskPermissions();
        }
        
        function allowAllTasks() {
            const tasks = wizard.tasks || [];
            const entities = wizardAccessState.selectedEntities || [];
            
            tasks.forEach(task => {
                const taskId = task.id || `task-${tasks.indexOf(task)}`;
                entities.forEach(e => {
                    wizardAccessState.taskPermissions[`${taskId}:${e.id}`] = true;
                });
                wizardAccessState.taskPermissions[`${taskId}:default`] = true;
            });
            
            // Save immediately
            saveUserTaskPermissions();
            renderWizardTaskPermissions();
        }
        
        function denyAllTasks() {
            const tasks = wizard.tasks || [];
            const entities = wizardAccessState.selectedEntities || [];
            
            tasks.forEach(task => {
                const taskId = task.id || `task-${tasks.indexOf(task)}`;
                entities.forEach(e => {
                    wizardAccessState.taskPermissions[`${taskId}:${e.id}`] = false;
                });
                wizardAccessState.taskPermissions[`${taskId}:default`] = false;
            });
            
            // Save immediately
            saveUserTaskPermissions();
            renderWizardTaskPermissions();
        }
        
        function collectWizardAccessControl() {
            // âœ¨ NEW APPROACH: Store denied_task_names with each entity (same as delegated admins)
            const tasks = wizard.tasks || [];
            const entities = wizardAccessState.selectedEntities || [];
            
            console.log('ðŸ“‹ ========== COLLECTING ACCESS CONTROL ==========');
            console.log('ðŸ“‹ Tasks:', tasks.map(t => ({id: t.id, name: t.name})));
            console.log('ðŸ“‹ Entities:', entities.map(e => ({id: e.id, name: e.name, type: e.type})));
            console.log('ðŸ“‹ Task Permissions State:', JSON.stringify(wizardAccessState.taskPermissions, null, 2));
            
            // Build entities with their denied_task_names
            const entitiesWithPermissions = entities.map(e => {
                const deniedTaskNames = [];
                
                tasks.forEach((task, i) => {
                    const taskId = task.id || `task-${i}`;
                    const key = `${taskId}:${e.id}`;
                    const isAllowed = wizardAccessState.taskPermissions[key];
                    
                    if (isAllowed === false) {
                        deniedTaskNames.push(task.name);
                        console.log(`   âŒ DENIED: ${e.name} for task "${task.name}"`);
                    }
                });
                
                console.log(`ðŸ“‹ Entity "${e.name}": denied_task_names=[${deniedTaskNames.join(', ')}]`);
                
                return {
                    id: e.id,
                    type: e.type,
                    name: e.name,
                    denied_task_names: deniedTaskNames.length > 0 ? deniedTaskNames : null
                };
            });
            
            wizard.accessControl = {
                accessType: wizardAccessState.accessType,
                entities: entitiesWithPermissions,
                _loaded: true  // âœ… Mark as ready for save (user explicitly modified)
            };
            
            console.log('ðŸ“‹ Final Access Control:', JSON.stringify(wizard.accessControl, null, 2));
            console.log('ðŸ“‹ ================================================');
        }
        
        async function loadAgentAccessControl(agentId) {
            // Try to load access control from the API
            try {
                const orgId = currentUser?.org_id || 'default';
                const response = await fetch(`/api/access-control/agents/${agentId}/full?org_id=${orgId}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('ðŸ”µ [API] Full access control response:', JSON.stringify(data, null, 2));
                    console.log('ðŸ”µ [API] agent_access:', JSON.stringify(data.agent_access, null, 2));
                    console.log('ðŸ”µ [API] agent_access.entities:', JSON.stringify(data.agent_access?.entities, null, 2));
                    
                    // âœ¨ NEW APPROACH: Read denied_task_names from each entity (same as delegated admins)
                    const mappedEntities = (data.agent_access?.entities || []).map(e => ({
                        id: e.entity_id || e.id,
                        type: e.entity_type || e.type,
                        name: e.name || '',
                        denied_task_names: e.denied_task_names || null  // âœ… Include denied tasks
                    }));
                    console.log('ðŸ”µ [API] Mapped entities with denied_task_names:', JSON.stringify(mappedEntities, null, 2));
                    
                    wizard.accessControl = {
                        accessType: data.agent_access?.access_type || 'authenticated',
                        entities: mappedEntities,
                        _loaded: true  // âœ… Mark as loaded from API to prevent accidental overwrite
                    };
                    
                    console.log('ðŸ”µ [API] Final wizard.accessControl:', JSON.stringify(wizard.accessControl, null, 2));
                    console.log('âœ… Access control marked as _loaded = true');
                }
            } catch (e) {
                console.error('âŒ Could not load access control from API:', e);
            }
        }
        
        async function saveAgentAccessControl(agentId) {
            // Save access control to the API
            try {
                const orgId = currentUser?.org_id || 'default';
                const userId = currentUser?.id || 'system';
                const ac = wizard.accessControl || {};
                
                // âš ï¸ CRITICAL: Check if user has permission to save access control
                const perms = wizard.userPermissions || {};
                const canSaveAccess = perms.is_owner || perms.can_manage_access;
                const canSaveTaskPerms = perms.is_owner || perms.can_manage_task_permissions;
                
                // âš ï¸ Also check if access control was actually loaded and modified
                // Prevent accidental overwrite of existing permissions
                if (!ac._loaded) {
                    console.log('âš ï¸ Access control not loaded from API - skipping save to prevent data loss');
                    return;
                }
                
                console.log('Saving access control for agent:', agentId, ac);
                console.log('ðŸ” Permissions check - canSaveAccess:', canSaveAccess, 'canSaveTaskPerms:', canSaveTaskPerms);
                
                // âœ¨ NEW APPROACH: Save everything via /access endpoint (same as delegated admins)
                // Include denied_task_names with each entity
                if (canSaveAccess || canSaveTaskPerms) {
                    const accessBody = {
                        access_type: ac.accessType || 'authenticated',
                        entities: (ac.entities || []).map(e => ({
                            id: e.id,
                            type: e.type,
                            name: e.name || 'Unknown',
                            denied_task_names: e.denied_task_names || null  // âœ… Include denied tasks
                        }))
                    };
                    console.log('ðŸ“¤ Saving access control with denied_task_names:', JSON.stringify(accessBody, null, 2));
                    
                    const accessResponse = await fetch(`/api/access-control/agents/${agentId}/access?org_id=${orgId}&user_id=${userId}`, {
                        method: 'PUT',
                        headers: { 
                            ...getAuthHeaders(), 
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify(accessBody)
                    });
                    
                    if (!accessResponse.ok) {
                        const errorText = await accessResponse.text();
                        console.error('âŒ Failed to save access control:', accessResponse.status, errorText);
                    } else {
                        console.log('âœ… Access control saved (including task permissions)');
                    }
                } else {
                    console.log('â­ï¸ Skipping access save - no permission');
                }
                
                console.log('âœ… Access control save completed');
            } catch (e) {
                console.error('Failed to save access control:', e);
            }
        }
        
        async function loadWizardAccessControl() {
            const ac = wizard.accessControl || {};
            
            console.log('ðŸ“¥ ========== LOADING ACCESS CONTROL ==========');
            console.log('ðŸ“¥ Raw wizard.accessControl:', JSON.stringify(ac, null, 2));
            
            wizardAccessState.accessType = ac.accessType || 'authenticated';
            
            // Load all users/groups/roles first if not already loaded
            if (wizardAccessState.allUsers.length === 0) {
                await loadWizardAccessEntities();
            }
            
            // âœ¨ NEW APPROACH: Read denied_task_names from each entity (same as delegated admins)
            // Build a map of entityId -> denied_task_names
            const entityDeniedTasks = {};
            
            // Map entities and enrich with actual names
            wizardAccessState.selectedEntities = (ac.entities || []).map(e => {
                let name = e.name;
                let icon = 'ðŸ‘¤';
                
                // Store denied_task_names for this entity
                if (e.denied_task_names && e.denied_task_names.length > 0) {
                    entityDeniedTasks[e.id] = e.denied_task_names;
                    console.log(`ðŸ“¥ Entity ${e.id.slice(0, 8)}... has denied_task_names:`, e.denied_task_names);
                }
                
                // Try to find actual name from loaded data
                if (e.type === 'user') {
                    const user = wizardAccessState.allUsers.find(u => u.id === e.id);
                    if (user) {
                        name = user.name || user.email || `User ${e.id.slice(0, 8)}...`;
                    }
                    icon = 'ðŸ‘¤';
                } else if (e.type === 'group') {
                    const group = wizardAccessState.allGroups.find(g => g.id === e.id);
                    if (group) {
                        name = group.name || `Group ${e.id.slice(0, 8)}...`;
                    }
                    icon = 'ðŸ‘¥';
                } else if (e.type === 'role') {
                    const role = wizardAccessState.allRoles.find(r => r.id === e.id);
                    if (role) {
                        name = role.name || `Role ${e.id.slice(0, 8)}...`;
                    }
                    icon = 'ðŸ·ï¸';
                }
                
                return { ...e, name, icon };
            });
            
            console.log('ðŸ“¥ Selected Entities:', wizardAccessState.selectedEntities.map(e => ({id: e.id, name: e.name, type: e.type})));
            console.log('ðŸ“¥ Entity denied tasks map:', entityDeniedTasks);
            
            // Convert to internal format: taskId:entityId -> true/false
            wizardAccessState.taskPermissions = {};
            const currentTasks = wizard.tasks || [];
            
            currentTasks.forEach((task, i) => {
                const taskId = task.id || `task-${i}`;
                const taskName = task.name;
                
                // Set default permission
                wizardAccessState.taskPermissions[`${taskId}:default`] = true;
                
                // Set per-entity permissions based on denied_task_names
                wizardAccessState.selectedEntities.forEach(e => {
                    const deniedTaskNames = entityDeniedTasks[e.id] || [];
                    const isDenied = deniedTaskNames.includes(taskName);
                    wizardAccessState.taskPermissions[`${taskId}:${e.id}`] = !isDenied;
                    if (isDenied) {
                        console.log(`   âŒ DENIED: ${e.name} for task "${taskName}" (${taskId})`);
                    }
                });
            });
            
            console.log('ðŸ“¥ Final taskPermissions state:', JSON.stringify(wizardAccessState.taskPermissions, null, 2));
            console.log('ðŸ“¥ ================================================');
            
            // Update the visual selection on access type cards
            console.log('ðŸ“¥ Setting access type visual selection to:', wizardAccessState.accessType);
            selectWizardAccessType(wizardAccessState.accessType);
        }
        
        async function loadGuardrailsToForm() {
            const g = wizard.guardrails || {};
            
            const setChecked = (id, value, defaultVal = true) => {
                const el = document.getElementById(id);
                if(el) el.checked = value ?? defaultVal;
            };
            
            const setValue = (id, value, defaultVal = '') => {
                const el = document.getElementById(id);
                if(el) el.value = value ?? defaultVal;
            };
            
            setChecked('guard-anti-hallucination', g.antiHallucination, true);
            setChecked('guard-cite-sources', g.citeSources, true);
            setChecked('guard-admit-uncertainty', g.admitUncertainty, true);
            setChecked('guard-verify-facts', g.verifyFacts, true);
            setChecked('guard-no-speculation', g.noSpeculation, false);
            setValue('guard-avoid-topics', g.avoidTopics, '');
            setValue('guard-focus-topics', g.focusTopics, '');
            setValue('guard-max-length', g.maxLength, 'medium');
            setValue('guard-language', g.language, 'user');
            setChecked('guard-escalate-angry', g.escalateAngry, true);
            setChecked('guard-escalate-complex', g.escalateComplex, true);
            setChecked('guard-escalate-request', g.escalateRequest, true);
            setChecked('guard-escalate-sensitive', g.escalateSensitive, false);
            setChecked('guard-pii-protection', g.piiProtection, true);
            setChecked('guard-mask-pii', g.maskPii, true);
            setChecked('guard-no-store-pii', g.noStorePii, true);
            
            // Load access control settings (async - enriches entity names)
            await loadWizardAccessControl();
        }
        
        async function showPreviewNew() {
            console.log('=== showPreviewNew called ===');
            
            const preview = document.getElementById('w-preview');
            if(!preview) {
                console.error('Preview container #w-preview not found');
                return;
            }
            
            // Use wizard state (populated by AI generation)
            if (!wizard.name || !wizard.goal || !wizard.personality) {
                console.error('Agent not fully configured. Please generate configuration first.');
                return;
            }
            
            // Collect guardrails from form
            collectGuardrails();
            
            // Load tools from API if not loaded
            if (allTools.length === 0) {
                try {
                    const toolsResponse = await fetch(API + '/api/tools');
                    const toolsData = await toolsResponse.json();
                    allTools = toolsData.tools || [];
                    console.log('Loaded tools for preview:', allTools.length);
                } catch(e) {
                    console.error('Error loading tools:', e);
                }
            }
            
            // Debug
            console.log('Preview state:', JSON.stringify({
                name: wizard.name,
                icon: wizard.icon,
                goal: (wizard.goal || '').substring(0, 50),
                tasksCount: (wizard.tasks || []).length,
                toolsCount: (wizard.tool_ids || []).length,
                allToolsCount: allTools.length
            }));
            
            // Safe access to arrays
            const tasks = Array.isArray(wizard.tasks) ? wizard.tasks : [];
            const toolIds = Array.isArray(wizard.tool_ids) ? wizard.tool_ids : [];
            const guardrails = wizard.guardrails || {};
            
            // Safe HTML escape
            const esc = (text) => {
                if(text === null || text === undefined) return '';
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            };
            
            // Build tasks HTML with instructions
            let tasksHtml = '';
            if(tasks.length > 0) {
                tasks.forEach(task => {
                    if(!task) return;
                    const insts = Array.isArray(task.instructions) ? task.instructions : [];
                    let instsHtml = '';
                    if (insts.length > 0) {
                        instsHtml = `
                            <div class="mt-2 space-y-1">
                                ${insts.map((inst, i) => `
                                    <div class="flex gap-2 text-xs text-gray-400">
                                        <span class="text-purple-400">${i + 1}.</span>
                                        <span>${esc(inst)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    tasksHtml += `
                        <div class="bg-gray-800/50 rounded-lg p-3">
                            <div class="font-medium text-sm">${esc(task.name || 'Unnamed Task')}</div>
                            <p class="text-xs text-gray-400 mt-1">${esc(task.description || '')}</p>
                            ${instsHtml}
                        </div>
                    `;
                });
            } else {
                tasksHtml = '<p class="text-gray-500 text-sm">No tasks defined</p>';
            }
            
            // Build tools HTML - fetch fresh from API to ensure names are shown
            let toolsHtml = '';
            
            // Debug
            console.log('=== Tools Debug ===');
            console.log('toolIds:', toolIds);
            
            if (toolIds.length > 0) {
                // Fetch tools from API and match by ID
                try {
                    const response = await fetch(API + '/api/tools');
                    const data = await response.json();
                    const allToolsFromApi = data.tools || [];
                    
                    console.log('Fetched tools:', allToolsFromApi.length);
                    console.log('Tool IDs to match:', toolIds);
                    
                    // Also check selectedDemoTools for tool names
                    const allSelectedTools = [
                        ...(selectedDemoTools?.apis || []),
                        ...(selectedDemoTools?.knowledge_bases || []),
                        ...(selectedDemoTools?.websites || []),
                        ...(selectedDemoTools?.databases || []),
                        ...(selectedDemoTools?.emails || []),
                        ...(selectedDemoTools?.webhooks || []),
                        ...(selectedDemoTools?.slacks || []),
                        ...(selectedDemoTools?.calendars || []),
                        ...(selectedDemoTools?.websearches || [])
                    ];
                    
                    toolsHtml = toolIds.map(toolId => {
                        const searchId = toolId.includes(':') ? toolId.split(':')[1] : toolId;
                        
                        // Try matching from API tools
                        let tool = allToolsFromApi.find(t => t.id === toolId);
                        if (!tool) tool = allToolsFromApi.find(t => t.id === searchId);
                        
                        // Try matching from selectedDemoTools (has names!)
                        if (!tool) tool = allSelectedTools.find(t => t.id === toolId);
                        if (!tool) tool = allSelectedTools.find(t => t.id === searchId);
                        
                        // More flexible matching
                        if (!tool) tool = allToolsFromApi.find(t => t.id?.includes(searchId) || searchId?.includes(t.id));
                        if (!tool) tool = allSelectedTools.find(t => t.id?.includes(searchId) || searchId?.includes(t.id));
                        
                        console.log('Tool matching:', toolId, 'â†’', tool?.name || 'NOT FOUND');
                        
                        const isApi = tool?.type === 'api' || tool?.type === 'website' || toolId.startsWith('api:');
                        const icon = isApi ? 'ðŸ”Œ' : 'ðŸ“š';
                        const name = tool?.name || 'Unknown Tool';
                        const colorClass = isApi
                            ? 'bg-blue-900/30 border border-blue-500/30' 
                            : 'bg-purple-900/30 border border-purple-500/30';
                        
                        return `<span class="px-3 py-1.5 ${colorClass} rounded-lg text-sm">${icon} ${esc(name)}</span>`;
                    }).join('');
                } catch(e) {
                    console.error('Error fetching tools:', e);
                    toolsHtml = '<span class="text-gray-500 text-sm">Error loading tools</span>';
                }
            } else if (wizard.generatedTools && wizard.generatedTools.length > 0) {
                // Use generated tools if available
                toolsHtml = wizard.generatedTools.map(tool => {
                    const icon = tool.type === 'api' ? 'ðŸ”Œ' : 'ðŸ“š';
                    const colorClass = tool.type === 'api'
                        ? 'bg-blue-900/30 border border-blue-500/30' 
                        : 'bg-purple-900/30 border border-purple-500/30';
                    return `<span class="px-3 py-1.5 ${colorClass} rounded-lg text-sm">${icon} ${esc(tool.name)}</span>`;
                }).join('');
            } else {
                toolsHtml = '<span class="text-gray-500 text-sm">No tools selected</span>';
            }
            
            // Update toolIds count for display
            const toolsCount = wizard.generatedTools?.length || toolIds.length || 0;
            
            // Build guardrails HTML
            const hasGuardrails = guardrails.antiHallucination || guardrails.citeSources || 
                                 guardrails.piiProtection || guardrails.escalateComplex ||
                                 guardrails.escalateAngry || guardrails.escalateRequest;
            
            let guardrailsHtml = '';
            if(guardrails.antiHallucination) guardrailsHtml += '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">âœ“ Anti-Hallucination</span>';
            if(guardrails.citeSources) guardrailsHtml += '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">âœ“ Cite Sources</span>';
            if(guardrails.piiProtection) guardrailsHtml += '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">âœ“ PII Protection</span>';
            if(guardrails.escalateComplex) guardrailsHtml += '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">âœ“ Smart Escalation</span>';
            if(guardrails.escalateAngry) guardrailsHtml += '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">âœ“ Anger Detection</span>';
            if(guardrails.admitUncertainty) guardrailsHtml += '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">âœ“ Admit Uncertainty</span>';
            if(!hasGuardrails) guardrailsHtml = '<span class="text-gray-500">No guardrails configured</span>';
            
            // Set the HTML
            preview.innerHTML = `
                <!-- Agent Identity -->
                <div class="card rounded-xl p-4">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-3xl">
                            ${wizard.icon || 'ðŸ¤–'}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">${esc(wizard.name)}</h3>
                            <p class="text-sm text-gray-400">
                                Model: ${wizard.model}
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Personality Summary -->
                <div class="card rounded-xl p-4">
                    <h4 class="font-medium mb-2 flex items-center gap-2">
                        <span>ðŸŽ­</span> Personality
                    </h4>
                    <p class="text-sm text-gray-300">${wizard.personalityReason || 'AI-configured personality'}</p>
                    <div class="grid grid-cols-3 gap-2 mt-3 text-xs text-gray-400">
                        <div>Creativity: ${wizard.personality?.creativity || '-'}/10</div>
                        <div>Length: ${wizard.personality?.length || '-'}/10</div>
                        <div>Formality: ${wizard.personality?.formality || '-'}/10</div>
                        <div>Empathy: ${wizard.personality?.empathy || '-'}/10</div>
                        <div>Proactivity: ${wizard.personality?.proactivity || '-'}/10</div>
                        <div>Confidence: ${wizard.personality?.confidence || '-'}/10</div>
                    </div>
                </div>
                
                <!-- Goal -->
                <div class="card rounded-xl p-4">
                    <h4 class="font-medium mb-2 flex items-center gap-2">
                        <span>ðŸŽ¯</span> Goal
                    </h4>
                    <p class="text-sm text-gray-300 whitespace-pre-wrap">${esc(wizard.goal)}</p>
                </div>
                
                <!-- Tasks -->
                <div class="card rounded-xl p-4">
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        <span>ðŸ“‹</span> Tasks (${tasks.length})
                    </h4>
                    <div class="space-y-3">${tasksHtml}</div>
                </div>
                
                <!-- Tools -->
                <div class="card rounded-xl p-4">
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        <span>ðŸ”§</span> Tools (${toolsCount})
                    </h4>
                    <div class="flex flex-wrap gap-2">${toolsHtml}</div>
                </div>
                
                <!-- Guardrails Summary -->
                <div class="card rounded-xl p-4">
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        <span>ðŸ›¡ï¸</span> Guardrails
                    </h4>
                    <div class="flex flex-wrap gap-2 text-sm">${guardrailsHtml}</div>
                </div>
                
                <!-- User Access Control -->
                <div class="card rounded-xl p-4">
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        <span>ðŸ”</span> User Access
                    </h4>
                    ${buildUserAccessPreviewHtml()}
                </div>
                
                <!-- Delegated Admins -->
                <div class="card rounded-xl p-4">
                    <h4 class="font-medium mb-3 flex items-center gap-2">
                        <span>ðŸ‘¥</span> Delegated Admins
                    </h4>
                    ${buildDelegatedAdminsPreviewHtml()}
                </div>
            `;
            
            console.log('Preview rendered successfully');
        }
        
        // Build HTML for user access permissions in preview - DETAILED
        function buildUserAccessPreviewHtml() {
            const accessType = wizardAccessState.accessType || 'authenticated';
            const selectedEntities = wizardAccessState.selectedEntities || [];
            const taskPermissions = wizardAccessState.taskPermissions || {};
            const tasks = wizard.tasks || [];
            
            // Debug logging
            console.log('ðŸ” [PREVIEW] buildUserAccessPreviewHtml called');
            console.log('ðŸ” [PREVIEW] accessType:', accessType);
            console.log('ðŸ” [PREVIEW] selectedEntities:', selectedEntities.length, selectedEntities.map(e => ({id: e.id?.slice(0,8), name: e.name})));
            console.log('ðŸ” [PREVIEW] tasks:', tasks.map(t => ({id: t.id?.slice(0,8), name: t.name})));
            console.log('ðŸ” [PREVIEW] taskPermissions keys:', Object.keys(taskPermissions));
            console.log('ðŸ” [PREVIEW] taskPermissions full:', JSON.stringify(taskPermissions, null, 2));
            
            // Access type description
            let accessTypeHtml = '';
            if (accessType === 'public') {
                accessTypeHtml = '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-sm">ðŸŒ Public Access</span>';
            } else if (accessType === 'specific') {
                accessTypeHtml = '<span class="px-2 py-1 bg-blue-500/20 text-blue-400 rounded text-sm">ðŸ”’ Specific Users/Groups</span>';
            } else {
                accessTypeHtml = '<span class="px-2 py-1 bg-gray-500/20 text-gray-400 rounded text-sm">ðŸ” Authenticated Users</span>';
            }
            
            if (accessType !== 'specific' || selectedEntities.length === 0) {
                return `
                    <div class="mb-3">${accessTypeHtml}</div>
                    <p class="text-sm text-gray-500">${accessType === 'public' ? 'Anyone can access this agent' : accessType === 'authenticated' ? 'All logged-in users can access' : 'No specific users selected'}</p>
                `;
            }
            
            // Build entity list with DETAILED task permissions
            let entitiesHtml = selectedEntities.map(entity => {
                const icon = entity.type === 'user' ? 'ðŸ‘¤' : 'ðŸ‘¥';
                
                // Get detailed task permissions for this entity
                let taskDetailsHtml = '';
                if (tasks.length > 0) {
                    const taskItems = tasks.map((task, i) => {
                        // Key format: taskId:entityId (same as storage format)
                        const taskId = task.id || `task-${i}`;
                        const key = `${taskId}:${entity.id}`;
                        const value = taskPermissions[key];
                        const hasAccess = value !== false;
                        console.log(`ðŸ” [PREVIEW] Task "${task.name}" for ${entity.name}: key=${key}, value=${value}, hasAccess=${hasAccess}`);
                        return `
                            <div class="flex items-center gap-2 text-xs ${hasAccess ? 'text-green-400' : 'text-red-400'}">
                                <span>${hasAccess ? 'âœ“' : 'âœ—'}</span>
                                <span>${task.name}</span>
                            </div>
                        `;
                    }).join('');
                    
                    taskDetailsHtml = `
                        <div class="mt-2 pl-6 space-y-1 border-l-2 border-gray-700">
                            <div class="text-xs text-gray-500 mb-1">Task Access:</div>
                            ${taskItems}
                        </div>
                    `;
                }
                
                return `
                    <div class="bg-gray-800/50 rounded-lg p-3 mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${icon}</span>
                            <span class="font-medium">${entity.name || entity.email || 'Unknown'}</span>
                            <span class="text-xs text-gray-500">(${entity.type === 'user' ? 'User' : 'Group'})</span>
                        </div>
                        ${taskDetailsHtml}
                    </div>
                `;
            }).join('');
            
            return `
                <div class="mb-3">${accessTypeHtml}</div>
                <div class="space-y-2">${entitiesHtml}</div>
            `;
        }
        
        // Build HTML for delegated admins in preview - DETAILED
        function buildDelegatedAdminsPreviewHtml() {
            const delegatedAdmins = agentAdminState.delegatedAdmins || [];
            const tasks = wizard.tasks || [];
            
            if (delegatedAdmins.length === 0) {
                return '<p class="text-sm text-gray-500">No delegated admins - you are the only admin</p>';
            }
            
            // Permission labels for display
            const permissionLabels = {
                'full_admin': 'â­ Full Admin',
                'edit_basic_info': 'ðŸ“ Edit Info',
                'edit_personality': 'ðŸŽ­ Edit Personality',
                'edit_model': 'ðŸ¤– Change Model',
                'edit_guardrails': 'ðŸ›¡ï¸ Edit Guardrails',
                'manage_tasks': 'ðŸ“‹ Manage Tasks',
                'manage_tools': 'ðŸ”§ Manage Tools',
                'manage_knowledge': 'ðŸ“š Manage Knowledge',
                'manage_users': 'ðŸ‘¥ Manage Access',
                'view_analytics': 'ðŸ“Š View Analytics',
                'export_data': 'ðŸ“¤ Export Data'
            };
            
            return delegatedAdmins.map(admin => {
                const icon = admin.entity_type === 'user' ? 'ðŸ‘¤' : 'ðŸ‘¥';
                const hasFullAdmin = admin.permissions?.includes('full_admin');
                const deniedTasks = admin.denied_task_names || [];
                const permissions = admin.permissions || [];
                
                // Resolve actual name from loaded users/groups
                let displayName = admin.entity_name;
                if (!displayName || displayName.includes('...')) {
                    if (admin.entity_type === 'user') {
                        const user = wizardAccessState.allUsers.find(u => u.id === admin.entity_id);
                        displayName = user?.name || user?.email || admin.entity_name || 'Unknown User';
                    } else {
                        const group = wizardAccessState.allGroups.find(g => g.id === admin.entity_id);
                        displayName = group?.name || admin.entity_name || 'Unknown Group';
                    }
                }
                
                // Build DETAILED agent permissions
                let agentPermsHtml = '';
                if (hasFullAdmin) {
                    agentPermsHtml = '<span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs">â­ Full Admin (all permissions)</span>';
                } else if (permissions.length > 0) {
                    agentPermsHtml = permissions.map(p => {
                        const label = permissionLabels[p] || p;
                        return `<span class="px-2 py-0.5 bg-blue-500/20 text-blue-300 rounded text-xs">${label}</span>`;
                    }).join(' ');
                } else {
                    agentPermsHtml = '<span class="text-xs text-gray-500">No agent permissions</span>';
                }
                
                // Build DETAILED task permissions (chat access)
                let taskPermsHtml = '';
                if (tasks.length > 0) {
                    const taskItems = tasks.map(task => {
                        const isDenied = deniedTasks.includes(task.name);
                        return `
                            <div class="flex items-center gap-2 text-xs ${isDenied ? 'text-red-400' : 'text-green-400'}">
                                <span>${isDenied ? 'âœ—' : 'âœ“'}</span>
                                <span>${task.name}</span>
                            </div>
                        `;
                    }).join('');
                    
                    taskPermsHtml = `
                        <div class="mt-2 pt-2 border-t border-gray-700">
                            <div class="text-xs text-gray-500 mb-1">Chat Access (Tasks):</div>
                            <div class="pl-2 space-y-1">${taskItems}</div>
                        </div>
                    `;
                }
                
                return `
                    <div class="bg-gray-800/50 rounded-lg p-3 mb-2">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-lg">${icon}</span>
                            <span class="font-medium">${displayName}</span>
                            <span class="text-xs text-gray-500">(${admin.entity_type === 'user' ? 'User' : 'Group'})</span>
                        </div>
                        <div class="pl-6 border-l-2 border-gray-700">
                            <div class="text-xs text-gray-500 mb-1">Agent Permissions:</div>
                            <div class="flex flex-wrap gap-1 mb-2">${agentPermsHtml}</div>
                            ${taskPermsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function prepareTestSuggestions() {
            try {
                const container = document.getElementById('test-suggestions');
                if(!container) return;
                
                // Use unified test prompts if available (generated from demo data)
                let suggestions = [];
                
                if (wizard.testPrompts && wizard.testPrompts.length > 0) {
                    // Use the test prompts generated from actual demo data
                    suggestions = wizard.testPrompts.slice(0, 5).map(tp => ({
                        prompt: tp.prompt,
                        category: tp.category,
                        hasData: true  // These prompts CAN be answered
                    }));
                    console.log('Using unified test prompts:', suggestions.length);
                } else {
                    // Fallback to task-based suggestions
                    const tasks = wizard.tasks || [];
                    suggestions = tasks.slice(0, 3).map(task => ({
                        prompt: `Test: ${task.name || 'Task'}`,
                        category: task.name,
                        hasData: false
                    }));
                    
                    // Add generic suggestions
                    suggestions.push({ prompt: 'Hello, what can you help me with?', category: 'General', hasData: true });
                    suggestions.push({ prompt: 'Can you explain your capabilities?', category: 'General', hasData: true });
                }
                
                container.innerHTML = suggestions.map(s => `
                    <button onclick="document.getElementById('test-input').value='${escHtml(s.prompt)}'; sendTest();" 
                            class="px-3 py-1.5 ${s.hasData ? 'bg-green-900/30 border border-green-500/30 hover:bg-green-800/30' : 'bg-gray-800 hover:bg-gray-700'} rounded-lg text-sm transition"
                            title="${s.hasData ? 'âœ“ This prompt can be answered from demo data' : 'Generic test prompt'}">
                        ${escHtml(s.prompt)}
                    </button>
                `).join('');
                
                // Show info about prompts
                if (wizard.testPrompts && wizard.testPrompts.length > 0) {
                    container.insertAdjacentHTML('afterbegin', `
                        <div class="w-full mb-2 text-xs text-green-400 flex items-center gap-1">
                            <span>âœ“</span> These prompts are generated from your demo data - the agent can answer them!
                        </div>
                    `);
                }
                
                console.log('Test suggestions prepared');
            } catch(e) {
                console.error('Error in prepareTestSuggestions:', e);
            }
        }
        
        // ============================================================================
        // UNIFIED DEMO SYSTEM - Connected Tools, Data & Test Prompts
        // ============================================================================
        
        async function generateUnifiedDemo() {
            /**
             * Unified Demo Generation:
             * 1. Calls /api/demo/unified-setup
             * 2. Gets demo tools WITH actual data stored in knowledge base
             * 3. Gets test prompts that CAN BE ANSWERED from the data
             * 4. Everything is connected!
             */
            
            const goal = wizard.goal || wizard.originalGoal;
            if (!goal) {
                alert('Please define an agent goal first');
                return;
            }
            
            // Show loading state
            const readyEl = document.getElementById('demo-setup-ready');
            const generatingEl = document.getElementById('demo-setup-generating');
            const resultsEl = document.getElementById('demo-setup-results');
            
            if (readyEl) readyEl.classList.add('hidden');
            if (generatingEl) generatingEl.classList.remove('hidden');
            if (resultsEl) resultsEl.classList.add('hidden');
            
            try {
                // Call unified setup API
                const response = await fetch(API + '/api/demo/unified-setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        goal: goal,
                        agent_name: wizard.name,
                        tasks: wizard.tasks,
                        personality: wizard.personality
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Store the results
                    wizard.unifiedDemo = data;
                    wizard.generatedTools = data.tools || [];
                    wizard.testPrompts = data.test_prompts || [];
                    wizard.demoAssets = data.demo_assets || [];
                    wizard.demoScript = data.demo_script || [];
                    
                    // Add ALL generated tools to selectedDemoTools AND wizard.tool_ids
                    if (data.tools && data.tools.length > 0) {
                        data.tools.forEach(tool => {
                            // Add to selectedDemoTools based on type
                            addToolToSelection(tool);
                        });
                        // Sync to wizard.tool_ids
                        syncToolsToWizard();
                        console.log('[Demo] Tools added to selectedDemoTools and wizard:', wizard.tool_ids);
                    }
                    
                    console.log('[Unified Demo] Success:', {
                        domain: data.domain,
                        tools: data.tools.length,
                        testPrompts: data.test_prompts.length,
                        documents: data.sample_data_count
                    });
                    
                    // Update the tools list UI
                    updateSelectedToolsList();
                    
                    // Show results
                    if (generatingEl) generatingEl.classList.add('hidden');
                    if (resultsEl) resultsEl.classList.remove('hidden');
                    
                    renderUnifiedDemoResults(data);
                    
                } else {
                    throw new Error('API request failed');
                }
                
            } catch (e) {
                console.error('[Unified Demo] Error:', e);
                
                // Show error state
                if (generatingEl) generatingEl.classList.add('hidden');
                if (readyEl) readyEl.classList.remove('hidden');
                
                alert('Failed to generate demo. Please try again.');
            }
        }
        
        function renderUnifiedDemoResults(data) {
            const container = document.getElementById('generated-demo-tools');
            if (!container) return;
            
            // Tools already added in the main generation function
            // Just render the UI
            
            // Render API tools
            const apiTools = (data.tools || []).filter(t => t.type === 'api');
            const kbTools = (data.tools || []).filter(t => t.type === 'knowledge');
            
            let toolsHtml = '';
            
            // API Tools Section
            if (apiTools.length > 0) {
                toolsHtml += `<div class="mb-4">
                    <h5 class="text-xs font-medium text-gray-400 mb-2">ðŸ”Œ Mockup APIs Created:</h5>
                    <div class="space-y-2">`;
                
                apiTools.forEach(tool => {
                    toolsHtml += `
                    <div class="p-3 rounded-xl bg-blue-900/20 border border-blue-500/30">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-blue-300">${escHtml(tool.name)}</span>
                            <span class="text-xs text-green-400">âœ“ Ready</span>
                        </div>
                        <p class="text-xs text-gray-400 mb-2">${escHtml(tool.description)}</p>
                        <div class="text-xs font-mono bg-gray-800/50 rounded px-2 py-1 text-gray-500">
                            ${escHtml(tool.endpoint || '')}
                        </div>
                        ${tool.mock_data ? `
                        <details class="mt-2">
                            <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-400">View mock response</summary>
                            <pre class="mt-1 text-xs bg-gray-800/50 rounded p-2 overflow-x-auto text-green-400">${escHtml(JSON.stringify(tool.mock_data, null, 2))}</pre>
                        </details>` : ''}
                    </div>`;
                });
                
                toolsHtml += `</div></div>`;
            }
            
            // Knowledge Base Section
            if (kbTools.length > 0) {
                toolsHtml += `<div class="mb-4">
                    <h5 class="text-xs font-medium text-gray-400 mb-2">ðŸ“š Knowledge Bases:</h5>
                    <div class="space-y-2">`;
                
                kbTools.forEach(tool => {
                    toolsHtml += `
                    <div class="p-3 rounded-xl bg-purple-900/20 border border-purple-500/30">
                        <div class="flex items-center justify-between">
                            <span class="font-medium text-purple-300">${escHtml(tool.name)}</span>
                            <span class="text-xs text-green-400">âœ“ ${tool.documents_count || 0} docs indexed</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">${escHtml(tool.description)}</p>
                    </div>`;
                });
                
                toolsHtml += `</div></div>`;
            }
            
            // Demo Assets Section with download links
            if (data.demo_assets && data.demo_assets.length > 0) {
                toolsHtml += `<div class="mb-4">
                    <h5 class="text-xs font-medium text-gray-400 mb-2">ðŸ“Ž Demo Assets (for testing):</h5>
                    <div class="space-y-2">`;
                
                data.demo_assets.forEach(asset => {
                    const icon = asset.type === 'image' ? 'ðŸ–¼ï¸' : 'ðŸ“„';
                    const downloadBtn = asset.download_url 
                        ? `<a href="${API}${asset.download_url}" download="${asset.name}" class="text-xs text-purple-400 hover:text-purple-300 ml-2">â¬‡ï¸ Download</a>`
                        : '';
                    
                    toolsHtml += `
                    <div class="p-3 rounded-lg bg-gray-800/50 border border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span>${icon}</span>
                                <span class="text-sm font-medium">${escHtml(asset.name)}</span>
                            </div>
                            ${downloadBtn}
                        </div>
                        <p class="text-xs text-gray-400 mt-1">${escHtml(asset.description || '')}</p>
                        ${asset.purpose ? `<p class="text-xs text-gray-500 mt-1">Purpose: ${escHtml(asset.purpose)}</p>` : ''}
                        ${asset.sample_text ? `
                        <details class="mt-2">
                            <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-400">View OCR text content</summary>
                            <pre class="mt-1 text-xs bg-gray-900/50 rounded p-2 overflow-x-auto text-gray-400 whitespace-pre-wrap">${escHtml(asset.sample_text)}</pre>
                        </details>` : ''}
                    </div>`;
                });
                
                toolsHtml += `</div></div>`;
            }
            
            // Test Prompts Preview
            if (data.test_prompts && data.test_prompts.length > 0) {
                toolsHtml += `<div class="mb-4">
                    <h5 class="text-xs font-medium text-gray-400 mb-2">ðŸ§ª Test Prompts (${data.test_prompts.length}):</h5>
                    <div class="space-y-1">`;
                
                data.test_prompts.slice(0, 4).forEach(tp => {
                    toolsHtml += `
                    <div class="flex items-center gap-2 text-xs">
                        <span class="text-purple-400">ðŸ’¬</span>
                        <span class="text-gray-300">"${escHtml(tp.prompt)}"</span>
                        <span class="text-gray-600 ml-auto">${escHtml(tp.category || '')}</span>
                    </div>`;
                });
                
                if (data.test_prompts.length > 4) {
                    toolsHtml += `<p class="text-xs text-gray-500 mt-1">+ ${data.test_prompts.length - 4} more in Test step</p>`;
                }
                
                toolsHtml += `</div></div>`;
            }
            
            // Demo Script
            if (data.demo_script && data.demo_script.length > 0) {
                toolsHtml += `
                <details class="mt-4 pt-4 border-t border-gray-700">
                    <summary class="text-sm font-medium text-gray-400 cursor-pointer hover:text-white">ðŸ“‹ Demo Setup Script</summary>
                    <div class="mt-2 p-3 bg-gray-800/50 rounded-lg text-xs font-mono space-y-1">
                        ${data.demo_script.map(line => `<div class="${line.startsWith('âœ“') ? 'text-green-400' : 'text-gray-400'}">${escHtml(line)}</div>`).join('')}
                    </div>
                </details>`;
            }
            
            // Summary
            if (data.summary) {
                toolsHtml += `
                <div class="mt-4 p-3 bg-green-500/10 border border-green-500/20 rounded-lg">
                    <div class="flex items-center gap-4 text-xs">
                        <span class="text-green-400">âœ“ Demo Ready</span>
                        <span class="text-gray-400">${data.summary.apis_created} APIs</span>
                        <span class="text-gray-400">${data.summary.knowledge_bases} KB</span>
                        <span class="text-gray-400">${data.summary.documents_indexed} docs</span>
                        <span class="text-gray-400">${data.summary.demo_assets} assets</span>
                    </div>
                </div>`;
            }
            
            container.innerHTML = toolsHtml;
            
            // Update the Agent's Tools list
            updateAgentToolsList();
        }
        
        function updateAgentToolsList() {
            const container = document.getElementById('w-tools-list');
            if (!container) return;
            
            if (wizard.tool_ids.length === 0) {
                container.innerHTML = `<div class="text-center py-4 text-gray-500 text-sm">
                    Generate demo environment above to add tools automatically
                </div>`;
                return;
            }
            
            // Fetch and display the actual tools
            fetch(API + '/api/tools')
                .then(r => r.json())
                .then(data => {
                    const tools = data.tools || [];
                    const selectedTools = tools.filter(t => wizard.tool_ids.includes(t.id));
                    
                    if (selectedTools.length === 0) {
                        container.innerHTML = `<div class="text-center py-4 text-gray-500 text-sm">
                            No tools added yet
                        </div>`;
                        return;
                    }
                    
                    container.innerHTML = selectedTools.map(tool => {
                        const icon = tool.type === 'api' ? 'ðŸ”Œ' : tool.type === 'knowledge' ? 'ðŸ“š' : 'ðŸ”§';
                        let bgClass = 'bg-gray-800/50';
                        let borderClass = 'border-gray-700';
                        if (tool.type === 'api') {
                            bgClass = 'bg-blue-900/20';
                            borderClass = 'border-blue-500/30';
                        } else if (tool.type === 'knowledge') {
                            bgClass = 'bg-purple-900/20';
                            borderClass = 'border-purple-500/30';
                        }
                        return `
                        <div class="flex items-center gap-3 p-3 rounded-lg ${bgClass} border ${borderClass}">
                            <span class="text-lg">${icon}</span>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-sm truncate">${escHtml(tool.name)}</div>
                                <div class="text-xs text-gray-500 truncate">${escHtml(tool.description || tool.type)}</div>
                            </div>
                            <button onclick="removeToolFromWizard('${tool.id}')" class="text-gray-500 hover:text-red-400 text-sm">âœ•</button>
                        </div>`;
                    }).join('');
                })
                .catch(e => {
                    console.error('Error loading tools:', e);
                });
        }
        
        function removeToolFromWizard(toolId) {
            wizard.tool_ids = wizard.tool_ids.filter(id => id !== toolId);
            
            // Also remove from selectedDemoTools
            const cleanId = toolId.replace(/^(api:|kb:)/, '');
            Object.keys(selectedDemoTools).forEach(key => {
                selectedDemoTools[key] = selectedDemoTools[key].filter(t => t.id !== toolId && t.id !== cleanId);
            });
            
            updateAgentToolsList();
            updateSelectedToolsList();
        }
        
        async function refineUnifiedDemo() {
            const input = document.getElementById('demo-refine-input');
            const refinement = input?.value?.trim();
            if (!refinement) return;
            
            input.value = '';
            input.disabled = true;
            
            try {
                const response = await fetch(API + '/api/demo/refine-unified', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        knowledge_base_id: wizard.knowledgeBaseId,
                        refinement_prompt: refinement,
                        goal: wizard.goal
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    wizard.unifiedDemo = data;
                    wizard.testPrompts = data.test_prompts || wizard.testPrompts;
                    renderUnifiedDemoResults(data);
                }
            } catch (e) {
                console.error('Refine error:', e);
            }
            
            input.disabled = false;
        }
        
        function regenerateUnifiedDemo() {
            // Reset UI state
            const readyEl = document.getElementById('demo-setup-ready');
            const resultsEl = document.getElementById('demo-setup-results');
            
            if (resultsEl) resultsEl.classList.add('hidden');
            if (readyEl) readyEl.classList.remove('hidden');
            
            // Clear previous data
            wizard.unifiedDemo = null;
            wizard.testPrompts = [];
            wizard.knowledgeBaseId = null;
            
            // Regenerate
            generateUnifiedDemo();
        }
        
        // ============================================================================
        // AI Configure Tools & Demo Data Generation
        // ============================================================================
        
        function toggleDemoGenerator() {
            const content = document.getElementById('demo-gen-content');
            const toggle = document.getElementById('demo-gen-toggle');
            if(content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggle.textContent = 'â–¼';
            } else {
                content.classList.add('hidden');
                toggle.textContent = 'â–¶';
            }
        }
        
        async function aiConfigureTools() {
            const goal = wizard.goal || wizard.originalGoal;
            if(!goal) {
                alert('Please define an agent goal first (Step 1)');
                return;
            }
            
            // Show loading
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse">â³</span> Analyzing...';
            btn.disabled = true;
            
            try {
                const response = await fetch(API + '/api/agents/configure-tools', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        goal: goal,
                        agent_name: wizard.name,
                        tasks: wizard.tasks 
                    })
                });
                
                if(response.ok) {
                    const data = await response.json();
                    wizard.suggestedTools = data.tools || [];
                    wizard.demoSuggestions = data.demo_suggestions || {};
                    loadWizardToolsNew();
                    
                    // Show demo suggestions if any
                    if(data.demo_suggestions) {
                        updateDemoSuggestions(data.demo_suggestions);
                    }
                    
                    alert(`âœ… AI recommended ${wizard.suggestedTools.length} tools for your agent!`);
                } else {
                    // Fallback to local
                    wizard.suggestedTools = getLocalToolRecommendations(goal);
                    loadWizardToolsNew();
                }
            } catch(e) {
                console.error('AI configure tools error:', e);
                wizard.suggestedTools = getLocalToolRecommendations(goal);
                loadWizardToolsNew();
            }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        
        function getLocalToolRecommendations(goal) {
            const goalLower = goal.toLowerCase();
            
            if(goalLower.includes('customer') || goalLower.includes('support')) {
                return ['knowledge', 'database', 'email'];
            } else if(goalLower.includes('sales') || goalLower.includes('product')) {
                return ['database', 'crm', 'knowledge'];
            } else if(goalLower.includes('hr') || goalLower.includes('employee')) {
                return ['knowledge', 'calendar', 'database'];
            } else if(goalLower.includes('research') || goalLower.includes('analysis')) {
                return ['websearch', 'knowledge', 'code'];
            } else if(goalLower.includes('code') || goalLower.includes('developer')) {
                return ['code', 'websearch', 'knowledge'];
            }
            return ['knowledge', 'websearch'];
        }
        
        function updateDemoSuggestions(suggestions) {
            // Store suggestions for later use
            wizard.demoSuggestions = suggestions;
        }
        
        async function generateDemoAPIs() {
            const statusEl = document.getElementById('demo-apis-status');
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<span class="animate-pulse text-purple-400">Generating APIs...</span>';
            
            try {
                const response = await fetch(API + '/api/demo-lab/generate-for-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'apis',
                        agent_goal: wizard.goal,
                        agent_name: wizard.name,
                        tasks: wizard.tasks
                    })
                });
                
                if(response.ok) {
                    const data = await response.json();
                    statusEl.innerHTML = `<span class="text-green-400">âœ“ ${data.count || 1} APIs created!</span>`;
                    addGeneratedItem('api', data.items || [{ name: 'Mock API', endpoint: '/api/mock' }]);
                } else {
                    statusEl.innerHTML = '<span class="text-yellow-400">âš ï¸ Using demo data</span>';
                    // Create sample mock API
                    createSampleMockAPI();
                }
            } catch(e) {
                console.error('Generate APIs error:', e);
                statusEl.innerHTML = '<span class="text-yellow-400">âš ï¸ Using demo data</span>';
                createSampleMockAPI();
            }
        }
        
        async function generateDemoDocs() {
            const statusEl = document.getElementById('demo-docs-status');
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<span class="animate-pulse text-purple-400">Generating documents...</span>';
            
            try {
                const response = await fetch(API + '/api/demo-lab/generate-for-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'documents',
                        agent_goal: wizard.goal,
                        agent_name: wizard.name,
                        tasks: wizard.tasks
                    })
                });
                
                if(response.ok) {
                    const data = await response.json();
                    statusEl.innerHTML = `<span class="text-green-400">âœ“ ${data.count || 1} documents created!</span>`;
                    addGeneratedItem('document', data.items || []);
                } else {
                    statusEl.innerHTML = '<span class="text-yellow-400">âš ï¸ Using demo data</span>';
                    createSampleDocument();
                }
            } catch(e) {
                console.error('Generate docs error:', e);
                statusEl.innerHTML = '<span class="text-yellow-400">âš ï¸ Using demo data</span>';
                createSampleDocument();
            }
        }
        
        async function generateDemoImages() {
            const statusEl = document.getElementById('demo-images-status');
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<span class="animate-pulse text-purple-400">Generating images...</span>';
            
            try {
                const response = await fetch(API + '/api/demo-lab/generate-for-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'images',
                        agent_goal: wizard.goal,
                        agent_name: wizard.name,
                        tasks: wizard.tasks
                    })
                });
                
                if(response.ok) {
                    const data = await response.json();
                    statusEl.innerHTML = `<span class="text-green-400">âœ“ ${data.count || 1} images created!</span>`;
                    addGeneratedItem('image', data.items || []);
                } else {
                    statusEl.innerHTML = '<span class="text-yellow-400">âš ï¸ Placeholder images</span>';
                }
            } catch(e) {
                console.error('Generate images error:', e);
                statusEl.innerHTML = '<span class="text-yellow-400">âš ï¸ Placeholder images</span>';
            }
        }
        
        async function generateAllDemoData() {
            const btn = event.target;
            btn.innerHTML = '<span class="animate-pulse">â³</span> Generating all demo data...';
            btn.disabled = true;
            
            await generateDemoAPIs();
            await new Promise(r => setTimeout(r, 500));
            await generateDemoDocs();
            await new Promise(r => setTimeout(r, 500));
            await generateDemoImages();
            
            btn.innerHTML = '<span>ðŸš€</span> Generate All Demo Data';
            btn.disabled = false;
        }
        
        function addGeneratedItem(type, items) {
            const container = document.getElementById('generated-demo-items');
            const list = document.getElementById('demo-items-list');
            container.classList.remove('hidden');
            
            const icons = { api: 'ðŸ”Œ', document: 'ðŸ“„', image: 'ðŸ–¼ï¸' };
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-800/50 rounded px-3 py-2';
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>${icons[type] || 'ðŸ“¦'}</span>
                        <span class="text-sm">${item.name || type}</span>
                    </div>
                    <span class="text-xs text-green-400">âœ“</span>
                `;
                list.appendChild(div);
            });
        }
        
        async function createSampleMockAPI() {
            // Create a sample mock API based on agent goal
            const goalLower = (wizard.goal || '').toLowerCase();
            let apiName = 'Sample API';
            let endpoint = '/api/sample';
            
            if(goalLower.includes('customer') || goalLower.includes('order')) {
                apiName = 'Orders API';
                endpoint = '/api/orders';
            } else if(goalLower.includes('product') || goalLower.includes('catalog')) {
                apiName = 'Products API';
                endpoint = '/api/products';
            } else if(goalLower.includes('employee') || goalLower.includes('hr')) {
                apiName = 'Employees API';
                endpoint = '/api/employees';
            }
            
            addGeneratedItem('api', [{ name: apiName, endpoint: endpoint }]);
        }
        
        async function createSampleDocument() {
            const goalLower = (wizard.goal || '').toLowerCase();
            let docName = 'Sample Document';
            
            if(goalLower.includes('customer')) {
                docName = 'Customer Support FAQ';
            } else if(goalLower.includes('product')) {
                docName = 'Product Catalog';
            } else if(goalLower.includes('hr') || goalLower.includes('employee')) {
                docName = 'HR Policies';
            }
            
            addGeneratedItem('document', [{ name: docName }]);
        }
        
        // Deploy Options
        function selectDeployOption(option) {
            if(option === 'draft') {
                saveAgent('draft');
            } else {
                document.getElementById('deploy-options').classList.remove('hidden');
            }
        }
        
        function selectDeployTarget(target) {
            wizard.deployTarget = target;
            
            document.querySelectorAll('.deploy-target').forEach(el => {
                el.classList.toggle('border-purple-500', el.dataset.target === target);
                el.classList.toggle('bg-purple-500/10', el.dataset.target === target);
            });
            
            document.getElementById('cloud-providers').classList.toggle('hidden', target !== 'cloud');
            document.getElementById('onprem-config').classList.toggle('hidden', target !== 'onprem');
        }
        
        function selectCloudProvider(provider) {
            wizard.cloudProvider = provider;
            
            document.querySelectorAll('.cloud-provider').forEach(el => {
                el.classList.toggle('border-purple-500', el.dataset.provider === provider);
                el.classList.toggle('bg-purple-500/10', el.dataset.provider === provider);
            });
            
            ['aws', 'azure', 'gcp', 'oci'].forEach(p => {
                document.getElementById('cloud-config-' + p)?.classList.toggle('hidden', p !== provider);
            });
        }
        
        function onOnpremMethodChange() {
            const method = document.getElementById('onprem-method').value;
            document.getElementById('onprem-docker').classList.toggle('hidden', method !== 'docker');
            document.getElementById('onprem-kubernetes').classList.toggle('hidden', method !== 'kubernetes');
        }
        
        function copyDockerCommand() {
            const code = document.querySelector('#onprem-docker pre code').textContent;
            navigator.clipboard.writeText(code);
            alert('Docker command copied!');
        }
        
        function downloadK8sManifest() {
            const code = document.querySelector('#onprem-kubernetes pre code').textContent;
            const blob = new Blob([code], { type: 'text/yaml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'agent-deployment.yaml';
            a.click();
        }
        
        // Quick deploy from Test step
        async function deployAgentNow() {
            if (!confirm('Deploy this agent now? It will be published and available for use.')) {
                return;
            }
            await deployAgent();
        }
        
        // Save as draft from Test step
        async function saveAsDraft() {
            collectGuardrails();
            
            // Collect Access Control settings
            if (typeof collectWizardAccessControl === 'function') {
                collectWizardAccessControl();
            }
            
            const agentData = {
                name: wizard.name,
                icon: wizard.icon,
                iconType: wizard.iconType || 'emoji',
                iconData: wizard.iconData || '',
                goal: wizard.goal,
                model: wizard.model,
                personality: wizard.personality,
                tasks: wizard.tasks,
                tool_ids: wizard.tool_ids,
                guardrails: wizard.guardrails,
                status: 'draft',
                access_control: wizard.accessControl
            };
            
            try {
                const url = wizard.editId || wizard.id 
                    ? `${API}/api/agents/${wizard.editId || wizard.id}`
                    : `${API}/api/agents`;
                const method = wizard.editId || wizard.id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
                    body: JSON.stringify(agentData)
                });
                
                if (response.ok) {
                    showToast('Agent saved as draft!', 'success');
                    navigate('agents');
                    loadAgents();
                } else {
                    const error = await response.json();
                    showToast('Failed to save: ' + (error.detail || 'Unknown error'), 'error');
                }
            } catch(e) {
                console.error('Save draft error:', e);
                showToast('Failed to save draft', 'error');
            }
        }
        
        async function deployAgent() {
            // Collect all data and deploy
            collectGuardrails();
            
            // âœ¨ Collect Access Control settings before deploy
            if (typeof collectWizardAccessControl === 'function') {
                collectWizardAccessControl();
            }
            
            // Get user permissions
            const perms = wizard.userPermissions || {};
            const isOwner = perms.is_owner;
            const hasFullAdmin = perms.permissions?.includes('full_admin');
            
            // Build deploy data based on permissions
            // Only include fields the user has permission to modify
            const deployData = {};
            
            // Always include status for publish
            if (isOwner || hasFullAdmin || perms.can_publish) {
                deployData.status = 'published';
            }
            
            // Basic info (name, icon, goal)
            if (isOwner || hasFullAdmin || perms.can_edit_basic_info) {
                deployData.name = wizard.name;
                deployData.icon = wizard.icon;
                deployData.goal = wizard.goal;
            }
            
            // Personality
            if (isOwner || hasFullAdmin || perms.can_edit_personality) {
                deployData.personality = wizard.personality;
            }
            
            // Guardrails
            if (isOwner || hasFullAdmin || perms.can_edit_guardrails) {
                deployData.guardrails = wizard.guardrails || {};
            }
            
            // Tasks
            if (isOwner || hasFullAdmin || perms.can_manage_tasks) {
                deployData.tasks = wizard.tasks || [];
            }
            
            // Tools
            if (isOwner || hasFullAdmin || perms.can_manage_tools) {
                deployData.tool_ids = wizard.tool_ids || [];
            }
            
            // Model
            if (isOwner || hasFullAdmin || perms.can_edit_model) {
                deployData.model_id = wizard.model;
            }
            
            console.log('ðŸš€ Deploying agent with permission-filtered data...');
            console.log('ðŸ“¦ Deploy data keys:', Object.keys(deployData));
            console.log('ðŸ“¦ Deploy data:', JSON.stringify(deployData, null, 2));
            console.log('ðŸ” User permissions:', JSON.stringify(perms, null, 2));
            console.log('ðŸ” isOwner:', isOwner, 'hasFullAdmin:', hasFullAdmin, 'can_publish:', perms.can_publish);
            
            // Safety check: if no fields to update, show error
            if (Object.keys(deployData).length === 0) {
                showToast('Error: No permissions to update this agent', 'error');
                return;
            }
            
            try {
                let response;
                const agentId = testAgent?.id || wizard.editId || wizard.id;
                
                console.log('Agent ID for deploy:', agentId);
                
                if (agentId) {
                    // Update existing agent - only send fields user can modify
                    response = await fetch(API + '/api/agents/' + agentId, {
                        method: 'PUT',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(deployData)
                    });
                } else {
                    // Create new agent - need full data
                    const fullData = {
                        name: wizard.name,
                        icon: wizard.icon,
                        goal: wizard.goal,
                        personality: wizard.personality,
                        guardrails: wizard.guardrails || {},
                        tasks: wizard.tasks || [],
                        tool_ids: wizard.tool_ids || [],
                        model_id: wizard.model,
                        status: 'published'
                    };
                    response = await fetch(API + '/api/agents', {
                        method: 'POST',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(fullData)
                    });
                }
                
                console.log('Deploy response status:', response.status);
                
                if(response.ok) {
                    const result = await response.json();
                    console.log('Deploy success:', result);
                    
                    // âœ¨ CRITICAL: Save Access Control settings when deploying
                    const savedAgentId = result.agent_id || result.agent?.id || agentId;
                    if (savedAgentId && wizard.accessControl) {
                        console.log('ðŸ“‹ Saving access control for deployed agent:', savedAgentId);
                        await saveAgentAccessControl(savedAgentId);
                    }
                    
                    showToast('ðŸš€ Agent deployed successfully!', 'success');
                    wizard.editId = null;
                    wizard.id = null;
                    testAgent = null;
                    navigate('agents');
                    setAgentTab('published');
                } else {
                    const err = await response.json();
                    console.error('Deploy error response:', err);
                    showToast('Error: ' + (err.detail || 'Failed to deploy'), 'error');
                }
            } catch(e) {
                console.error('Deploy error:', e);
                showToast('Error deploying agent: ' + e.message, 'error');
            }
        }

        // ============================================================================
        // DEMO LAB FUNCTIONS
        // ============================================================================
        
        let demoTab = 'api';
        let demoItems = { apis: [], docs: [], images: [] };
        let demoConversation = [];
        let demoCurrentMode = 'api';
        let demoSidebarTab = 'all';
        let demoEditingItem = null;
        let demoKits = [];
        let currentKitId = null;
        let currentTestApi = null;
        let apiTestFromWizard = false;

        // Initialize Demo Lab
        function initDemoLab() {
            loadDemoKits();
        }

        // Load demo kits from server
        async function loadDemoKits() {
            try {
                const response = await fetch(API + '/api/demo-kits');
                const data = await response.json();
                demoKits = data.kits || [];
                renderDemoKitsList();
            } catch (e) {
                console.error('Failed to load demo kits:', e);
            }
        }

        // Render demo kits list in sidebar
        function renderDemoKitsList() {
            const container = document.getElementById('demo-kits-list');
            if (!container) return;
            
            if (demoKits.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="text-3xl block mb-2">ðŸ“¦</span>
                        <p class="text-sm">No demo kits yet</p>
                        <p class="text-xs mt-1">Create one to get started!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = demoKits.map(kit => `
                <div onclick="selectDemoKit('${kit.id}')" class="p-3 rounded-lg cursor-pointer transition-colors ${currentKitId === kit.id ? 'bg-purple-500/20 border border-purple-500/50' : 'bg-gray-800/50 hover:bg-gray-800 border border-transparent'}">
                    <div class="flex items-start gap-2">
                        <span class="text-xl">ðŸ“¦</span>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-sm truncate">${escHtml(kit.name)}</p>
                            <p class="text-xs text-gray-500 truncate">${escHtml(kit.description || '')}</p>
                            <div class="flex gap-2 mt-2 text-xs">
                                <span class="px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-300">${kit.api_count} APIs</span>
                                <span class="px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-300">${kit.kb_count} KBs</span>
                                <span class="px-1.5 py-0.5 rounded bg-green-500/20 text-green-300">${kit.asset_count} Assets</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Select a demo kit to view details
        async function selectDemoKit(kitId) {
            currentKitId = kitId;
            renderDemoKitsList();
            
            try {
                const response = await fetch(API + `/api/demo-kits/${kitId}`);
                const kit = await response.json();
                renderKitDetails(kit);
            } catch (e) {
                console.error('Failed to load kit details:', e);
                alert('Failed to load kit details');
            }
        }

        // Render kit details
        function renderKitDetails(kit) {
            document.getElementById('demo-welcome').classList.add('hidden');
            document.getElementById('demo-kit-details').classList.remove('hidden');
            
            document.getElementById('kit-detail-name').textContent = kit.name;
            document.getElementById('kit-detail-desc').textContent = kit.description;
            document.getElementById('kit-api-count').textContent = kit.apis?.length || 0;
            document.getElementById('kit-kb-count').textContent = kit.knowledge_bases?.length || 0;
            document.getElementById('kit-asset-count').textContent = kit.assets?.length || 0;
            
            // Render APIs
            const apisContainer = document.getElementById('kit-apis-list');
            if (kit.apis && kit.apis.length > 0) {
                apisContainer.innerHTML = kit.apis.map(api => `
                    <div class="card rounded-lg p-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-0.5 rounded text-xs font-bold ${api.method === 'GET' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}">${api.method}</span>
                                    <code class="text-sm text-gray-300">${escHtml(api.endpoint)}</code>
                                </div>
                                <p class="font-medium">${escHtml(api.name)}</p>
                                <p class="text-sm text-gray-400 mt-1">${escHtml(api.description)}</p>
                                ${api.parameters && api.parameters.length > 0 ? `
                                    <div class="mt-2 text-xs text-gray-500">
                                        Parameters: ${api.parameters.map(p => p.name).join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="goToToolPage('${api.id}')" class="px-3 py-1.5 rounded-lg text-sm bg-gray-700 text-gray-300 hover:bg-gray-600">
                                    âœï¸ Edit
                                </button>
                                <button onclick="testDemoApi('${kit.id}', '${api.id}')" class="px-3 py-1.5 rounded-lg text-sm bg-green-500/20 text-green-400 hover:bg-green-500/30">
                                    â–¶ Test
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                apisContainer.innerHTML = '<p class="text-gray-500 text-sm">No APIs in this kit</p>';
            }
            
            // Render Knowledge Bases
            const kbContainer = document.getElementById('kit-kb-list');
            if (kit.knowledge_bases && kit.knowledge_bases.length > 0) {
                kbContainer.innerHTML = kit.knowledge_bases.map(kb => `
                    <div class="card rounded-lg p-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-medium">${escHtml(kb.name)}</p>
                                <p class="text-sm text-gray-400 mt-1">${escHtml(kb.description)}</p>
                                <div class="mt-2 text-xs text-gray-500">
                                    ${kb.sections?.length || 0} sections
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="goToToolPage('${kb.id}')" class="px-3 py-1.5 rounded-lg text-sm bg-gray-700 text-gray-300 hover:bg-gray-600">
                                    âœï¸ Edit
                                </button>
                                <button onclick="viewKnowledgeBase('${kit.id}', '${kb.id}')" class="px-3 py-1.5 rounded-lg text-sm bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                    ðŸ‘ View
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                kbContainer.innerHTML = '<p class="text-gray-500 text-sm">No knowledge bases in this kit</p>';
            }
            
            // Render Assets (assets don't have a Tools page, keep edit modal)
            const assetsContainer = document.getElementById('kit-assets-list');
            if (kit.assets && kit.assets.length > 0) {
                assetsContainer.innerHTML = kit.assets.map(asset => `
                    <div class="card rounded-lg p-4 text-center">
                        <div class="w-12 h-12 mx-auto mb-2 rounded-lg bg-gray-700 flex items-center justify-center">
                            ${asset.asset_type === 'invoice' ? 'ðŸ§¾' : asset.asset_type === 'receipt' ? 'ðŸ§¾' : 'ðŸ“„'}
                        </div>
                        <p class="font-medium text-sm truncate">${escHtml(asset.name)}</p>
                        <p class="text-xs text-gray-500 capitalize">${asset.asset_type}</p>
                        <div class="flex gap-1 mt-3 justify-center flex-wrap">
                            <button onclick="editDemoAsset('${kit.id}', '${asset.id}')" class="px-2 py-1 rounded text-xs bg-gray-700 text-gray-300 hover:bg-gray-600">
                                âœï¸
                            </button>
                            <button onclick="generateAssetFile('${kit.id}', '${asset.id}')" class="px-2 py-1 rounded text-xs bg-green-500/20 text-green-400 hover:bg-green-500/30">
                                Generate
                            </button>
                            ${asset.file_url ? `
                                <a href="${API}${asset.file_url}" download class="px-2 py-1 rounded text-xs bg-blue-500/20 text-blue-400 hover:bg-blue-500/30">
                                    â¬‡
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                assetsContainer.innerHTML = '<p class="text-gray-500 text-sm col-span-3 text-center">No demo assets in this kit</p>';
            }
        }
        
        // Navigate to Tool page for editing
        function goToToolPage(toolId) {
            showPage('tools');
            setTimeout(() => viewTool(toolId), 100);
        }

        // Show create kit modal
        function showCreateKitModal() {
            const modal = document.getElementById('create-kit-modal');
            if (!modal) return;
            ensureModalInBody('create-kit-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('new-kit-description').focus();
        }

        // Close create kit modal
        function closeCreateKitModal() {
            document.getElementById('create-kit-modal').classList.add('hidden');
            document.getElementById('create-kit-modal').classList.remove('flex');
            document.getElementById('kit-generation-status').classList.add('hidden');
            document.getElementById('generate-kit-btn').disabled = false;
        }

        // Generate demo kit
        async function generateDemoKit() {
            const name = document.getElementById('new-kit-name').value.trim();
            const description = document.getElementById('new-kit-description').value.trim();
            
            if (!description) {
                alert('Please describe what you need');
                return;
            }
            
            // Show loading
            document.getElementById('kit-generation-status').classList.remove('hidden');
            document.getElementById('generate-kit-btn').disabled = true;
            
            try {
                const response = await fetch(API + '/api/demo-kits/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description: description,
                        kit_name: name || null
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate kit');
                }
                
                const kit = await response.json();
                
                // Close modal and refresh
                closeCreateKitModal();
                document.getElementById('new-kit-name').value = '';
                document.getElementById('new-kit-description').value = '';
                
                // Reload kits and select the new one
                await loadDemoKits();
                selectDemoKit(kit.id);
                
            } catch (e) {
                console.error('Failed to generate kit:', e);
                alert('Failed to generate demo kit: ' + e.message);
                document.getElementById('kit-generation-status').classList.add('hidden');
                document.getElementById('generate-kit-btn').disabled = false;
            }
        }

        // Delete current kit
        async function deleteCurrentKit() {
            if (!currentKitId) return;
            if (!confirm('Are you sure you want to delete this demo kit?')) return;
            
            try {
                await fetch(API + `/api/demo-kits/${currentKitId}`, { method: 'DELETE' });
                currentKitId = null;
                document.getElementById('demo-welcome').classList.remove('hidden');
                document.getElementById('demo-kit-details').classList.add('hidden');
                await loadDemoKits();
            } catch (e) {
                alert('Failed to delete kit');
            }
        }

        // Test API
        function testDemoApi(kitId, apiId) {
            const kit = demoKits.find(k => k.id === kitId);
            if (!kit) return;
            
            // Load full kit data to get API details
            fetch(API + `/api/demo-kits/${kitId}`)
                .then(r => r.json())
                .then(fullKit => {
                    const api = fullKit.apis.find(a => a.id === apiId);
                    if (!api) return;
                    
                    currentTestApi = { kitId, apiId, api };
                    apiTestFromWizard = false;
                    
                    document.getElementById('api-test-title').textContent = `Test: ${api.name}`;
                    document.getElementById('api-test-method').textContent = api.method;
                    document.getElementById('api-test-method').className = `px-2 py-0.5 rounded text-xs font-bold ${api.method === 'GET' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}`;
                    document.getElementById('api-test-endpoint').textContent = api.endpoint;
                    
                    // Render parameters
                    const paramsContainer = document.getElementById('api-test-params');
                    if (api.parameters && api.parameters.length > 0) {
                        paramsContainer.innerHTML = api.parameters.map(p => `
                            <div class="flex items-center gap-2">
                                <label class="text-xs text-gray-400 w-24">${p.name}${p.required ? '*' : ''}</label>
                                <input type="text" class="api-param-input flex-1 input-field rounded px-2 py-1 text-sm" 
                                       data-param="${p.name}" placeholder="${p.type || 'string'}">
                            </div>
                        `).join('');
                    } else {
                        paramsContainer.innerHTML = '<p class="text-xs text-gray-500">No parameters</p>';
                    }
                    
                    // Show/hide body for POST
                    const bodyEl = document.getElementById('api-test-body');
                    if (api.method === 'POST' || api.method === 'PUT') {
                        bodyEl.classList.remove('hidden');
                        bodyEl.value = api.sample_request ? JSON.stringify(api.sample_request, null, 2) : '{}';
                    } else {
                        bodyEl.classList.add('hidden');
                    }
                    
                    // Reset response
                    document.getElementById('api-test-response').textContent = '// Click "Send Request" to test';
                    ensureModalInBody('api-test-modal');
                    document.getElementById('api-test-modal').classList.remove('hidden');
                    document.getElementById('api-test-modal').classList.add('flex');
                });
        }

        // Close API test modal
        function closeApiTestModal() {
            document.getElementById('api-test-modal').classList.add('hidden');
            document.getElementById('api-test-modal').classList.remove('flex');
            currentTestApi = null;
            apiTestFromWizard = false;
        }

        // Open API test modal from tool wizard (Try this API)
        // Business-friendly display: table for arrays, structured for objects
        function renderBusinessFriendlyResponse(data) {
            if (!data) return '<p class="text-gray-400 text-sm">No data returned</p>';
            
            // Array of objects â†’ Table
            if (Array.isArray(data) && data.length > 0 && typeof data[0] === 'object') {
                const keys = Object.keys(data[0]);
                let html = `<div class="overflow-x-auto"><table class="w-full text-sm border-collapse">
                    <thead><tr class="bg-purple-900/40 border-b border-purple-600/50">`;
                keys.forEach(k => {
                    html += `<th class="px-3 py-2 text-left font-semibold text-purple-200">${k}</th>`;
                });
                html += `</tr></thead><tbody>`;
                data.forEach((row, idx) => {
                    html += `<tr class="${idx % 2 === 0 ? 'bg-gray-800/40' : 'bg-gray-800/20'} border-b border-gray-700/50">`;
                    keys.forEach(k => {
                        const val = row[k];
                        const display = val != null ? String(val) : '-';
                        html += `<td class="px-3 py-2 text-gray-200">${display}</td>`;
                    });
                    html += `</tr>`;
                });
                html += `</tbody></table></div>`;
                html += `<p class="text-xs text-gray-400 mt-2">${data.length} record${data.length !== 1 ? 's' : ''}</p>`;
                return html;
            }
            
            // Single object â†’ Structured view
            if (typeof data === 'object' && !Array.isArray(data)) {
                let html = '<div class="space-y-2">';
                Object.entries(data).forEach(([k, v]) => {
                    const display = v != null ? (typeof v === 'object' ? JSON.stringify(v, null, 2) : String(v)) : '-';
                    html += `<div class="flex items-start gap-3 border-b border-gray-700/30 pb-2">
                        <span class="font-semibold text-purple-200 min-w-[120px]">${k}:</span>
                        <span class="text-gray-200 break-all">${display}</span>
                    </div>`;
                });
                html += '</div>';
                return html;
            }
            
            // Fallback: simple value or JSON
            return `<pre class="text-gray-200 text-sm whitespace-pre-wrap break-words">${typeof data === 'object' ? JSON.stringify(data, null, 2) : String(data)}</pre>`;
        }

        function openWizardApiTestModal() {
            const baseUrl = (document.getElementById('api-base-url') || document.getElementById('api-url'))?.value?.trim() || '';
            const path = document.getElementById('api-path')?.value?.trim() || '';
            const method = document.getElementById('api-method')?.value || 'GET';
            const name = document.getElementById('wiz-name')?.value?.trim() || 'API';
            if (!baseUrl) {
                alert('Please enter the Base URL first.');
                return;
            }
            apiTestFromWizard = true;
            currentTestApi = null;
            document.getElementById('api-test-title').textContent = name;
            document.getElementById('api-test-method').textContent = method;
            document.getElementById('api-test-method').className = 'hidden';
            document.getElementById('api-test-endpoint').textContent = (baseUrl.replace(/\/$/, '') + '/' + path.replace(/^\//, '')) || baseUrl;
            document.getElementById('api-test-endpoint').className = 'hidden';
            document.getElementById('api-test-response').innerHTML = '<p class="text-gray-500 text-center py-8">Results will appear here...</p>';
            if (typeof renderTestParams === 'function') renderTestParams();
            const bodyEl = document.getElementById('api-test-body');
            if (bodyEl) {
                bodyEl.classList.add('hidden');
                bodyEl.value = '{}';
            }
            ensureModalInBody('api-test-modal');
            document.getElementById('api-test-modal').classList.remove('hidden');
            document.getElementById('api-test-modal').classList.add('flex');
        }

        // Send API test request (wizard mode or demo kit mode)
        async function sendApiTestRequest() {
            const responseEl = document.getElementById('api-test-response');
            const sendBtn = document.getElementById('api-test-send-btn');
            if (!responseEl) return;

            // Wizard mode: test from tool create form
            if (apiTestFromWizard) {
                const params = {};
                (apiParams || []).forEach((p, i) => {
                    const key = (p.name || '').trim() || ('param_' + i);
                    const el = document.getElementById('test-param-' + (p.id != null ? p.id : i));
                    if (el && el.value !== undefined && el.value !== '') params[key] = el.value;
                });
                const baseUrl = (document.getElementById('api-base-url') || document.getElementById('api-url'))?.value?.trim() || '';
                const body = {
                    base_url: baseUrl,
                    http_method: document.getElementById('api-method')?.value || 'GET',
                    endpoint_path: document.getElementById('api-path')?.value || '',
                    auth_type: document.getElementById('api-auth')?.value || 'none',
                    auth_value: (document.getElementById('api-auth-value') || document.getElementById('api-auth-val'))?.value || '',
                    api_key_name: document.getElementById('api-key-name')?.value || '',
                    api_key_location: document.getElementById('api-key-loc')?.value || '',
                    parameters: params
                };
                if (sendBtn) { sendBtn.disabled = true; sendBtn.innerHTML = 'Sending...'; }
                responseEl.innerHTML = '<p class="text-gray-400 text-center py-8">â³ Loading...</p>';
                try {
                    const r = await fetch(API + '/api/tools/test-api', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...(typeof getAuthHeaders === 'function' ? getAuthHeaders() : {}) },
                        body: JSON.stringify(body)
                    });
                    const d = await r.json();
                    if (d.success) {
                        responseEl.innerHTML = renderBusinessFriendlyResponse(d.data);
                        responseEl.className = 'text-sm overflow-auto max-h-64 m-0';
                    } else {
                        responseEl.innerHTML = `<p class="text-red-400 text-sm">âŒ Error: ${d.error || 'Request failed'}</p>`;
                        responseEl.className = 'text-sm overflow-auto max-h-64 m-0';
                    }
                } catch (e) {
                    responseEl.innerHTML = `<p class="text-red-400 text-sm">âŒ Error: ${e.message}</p>`;
                    responseEl.className = 'text-sm overflow-auto max-h-64 m-0';
                }
                if (sendBtn) { sendBtn.disabled = false; sendBtn.innerHTML = '<span>âœ“</span> Get Results'; }
                return;
            }

            if (!currentTestApi) return;
            const { kitId, apiId, api } = currentTestApi;

            const params = {};
            document.querySelectorAll('.api-param-input').forEach(input => {
                if (input.value && input.dataset.param) params[input.dataset.param] = input.value;
            });
            let body = {};
            if (api.method === 'POST' || api.method === 'PUT') {
                try {
                    body = JSON.parse(document.getElementById('api-test-body').value || '{}');
                } catch (e) {
                    alert('Invalid JSON in request body');
                    return;
                }
            }
            if (sendBtn) { sendBtn.disabled = true; sendBtn.innerHTML = 'Sending...'; }
            responseEl.innerHTML = '<p class="text-gray-400 text-center py-8">â³ Loading...</p>';
            try {
                const response = await fetch(API + `/api/demo-kits/${kitId}/api/${apiId}/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...params, ...body })
                });
                const result = await response.json();
                responseEl.innerHTML = renderBusinessFriendlyResponse(result.response || result);
                responseEl.className = 'text-sm overflow-auto max-h-64 m-0';
            } catch (e) {
                responseEl.innerHTML = `<p class="text-red-400 text-sm">âŒ Error: ${e.message}</p>`;
                responseEl.className = 'text-sm overflow-auto max-h-64 m-0';
            }
            if (sendBtn) { sendBtn.disabled = false; sendBtn.innerHTML = '<span>âœ“</span> Get Results'; }
        }

        // View Knowledge Base
        function viewKnowledgeBase(kitId, kbId) {
            fetch(API + `/api/demo-kits/${kitId}`)
                .then(r => r.json())
                .then(kit => {
                    const kb = kit.knowledge_bases.find(k => k.id === kbId);
                    if (!kb) return;
                    
                    document.getElementById('kb-view-title').textContent = kb.name;
                    
                    // Render content with sections
                    let html = `<p class="text-gray-400 mb-4">${escHtml(kb.description)}</p>`;
                    
                    if (kb.sections && kb.sections.length > 0) {
                        html += kb.sections.map(s => `
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-purple-400 mb-2">${escHtml(s.title)}</h3>
                                <div class="text-gray-300 whitespace-pre-wrap">${escHtml(s.content)}</div>
                            </div>
                        `).join('');
                    } else if (kb.content) {
                        html += `<div class="text-gray-300 whitespace-pre-wrap">${escHtml(kb.content)}</div>`;
                    }
                    
                    document.getElementById('kb-view-content').innerHTML = html;
                    ensureModalInBody('kb-view-modal');
                    document.getElementById('kb-view-modal').classList.remove('hidden');
                    document.getElementById('kb-view-modal').classList.add('flex');
                });
        }

        // Close KB view modal
        function closeKbViewModal() {
            document.getElementById('kb-view-modal').classList.add('hidden');
            document.getElementById('kb-view-modal').classList.remove('flex');
        }

        // ============================================================
        // ACCESS CONTROL MODULE - Now integrated in Agent Wizard (Step 4)
        // Old standalone modal removed for cleaner UX
        // ============================================================
        
        // Legacy state - kept for any remaining references
        let accessControlState = {
            agentId: null,
            agentName: '',
            accessType: 'authenticated',
            entities: [],
            tasks: [],
            tools: [],
            taskDefault: 'allow',
            toolDefault: 'allow',
            allUsers: [],
            allGroups: [],
            allRoles: []
        };
        
        async function openAccessControl(agentId, agentName) {
            console.log('ðŸ” Opening Access Control for:', agentId, agentName);
            
            accessControlState.agentId = agentId;
            accessControlState.agentName = agentName;
            
            document.getElementById('access-control-agent-name').textContent = agentName;
            
            // Show modal
            const modal = document.getElementById('access-control-modal');
            if (!modal) {
                console.error('âŒ Access control modal not found!');
                showToast('Access Control modal not found', 'error');
                return;
            }
            ensureModalInBody('access-control-modal');
            modal.style.display = 'flex';
            
            console.log('âœ… Modal opened and moved to body. Display:', modal.style.display);
            
            // Reset to first tab
            switchAccessTab(1);
            
            // Load data
            await loadAccessControlData();
        }
        
        function closeAccessControlModal() {
            const modal = document.getElementById('access-control-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function switchAccessTab(tab) {
            // Update tab buttons
            for(let i = 1; i <= 3; i++) {
                const btn = document.getElementById('access-tab-' + i);
                const content = document.getElementById('access-content-' + i);
                
                if(i === tab) {
                    btn.classList.add('border-purple-500', 'text-white', 'font-medium');
                    btn.classList.remove('border-transparent', 'text-gray-400');
                    content.classList.remove('hidden');
                } else {
                    btn.classList.remove('border-purple-500', 'text-white', 'font-medium');
                    btn.classList.add('border-transparent', 'text-gray-400');
                    content.classList.add('hidden');
                }
            }
        }
        
        async function loadAccessControlData() {
            try {
                // Get current org_id from session
                const orgId = currentUser?.org_id || 'default';
                const headers = getAuthHeaders();
                
                // Load full access config
                const response = await fetch(`${API}/api/access-control/agents/${accessControlState.agentId}/full?org_id=${orgId}`, { headers });
                
                if(response.ok) {
                    const data = await response.json();
                    
                    // Set access type
                    accessControlState.accessType = data.agent_access?.access_type || 'authenticated';
                    accessControlState.entities = data.agent_access?.entities || [];
                    accessControlState.tasks = data.task_access?.task_permissions || [];
                    accessControlState.tools = data.tool_access?.tool_permissions || [];
                    accessControlState.taskDefault = data.task_access?.allow_all_by_default ? 'allow' : 'deny';
                    accessControlState.toolDefault = data.tool_access?.allow_all_by_default ? 'allow' : 'deny';
                }
                
                // Load agent details for tasks/tools
                const agentResponse = await fetch(`${API}/api/agents/${accessControlState.agentId}`, { headers });
                if(agentResponse.ok) {
                    const agent = await agentResponse.json();
                    
                    // Parse tasks
                    let tasks = [];
                    if(typeof agent.tasks === 'string') {
                        try { tasks = JSON.parse(agent.tasks); } catch(e) {}
                    } else if(Array.isArray(agent.tasks)) {
                        tasks = agent.tasks;
                    }
                    accessControlState.tasks = tasks.map(t => ({
                        task_id: t.id,
                        task_name: t.name,
                        allowed_entity_ids: [],
                        denied_entity_ids: []
                    }));
                    
                    // Parse tools
                    let toolIds = [];
                    if(typeof agent.tool_ids === 'string') {
                        try { toolIds = JSON.parse(agent.tool_ids); } catch(e) {}
                    } else if(Array.isArray(agent.tool_ids)) {
                        toolIds = agent.tool_ids;
                    }
                    
                    // Load tool names
                    const toolsResponse = await fetch(`${API}/api/tools`, { headers });
                    if(toolsResponse.ok) {
                        const allTools = await toolsResponse.json();
                        accessControlState.tools = toolIds.map(tid => {
                            const tool = allTools.find(t => t.id === tid);
                            return {
                                tool_id: tid,
                                tool_name: tool?.name || 'Unknown Tool',
                                allowed_entity_ids: [],
                                denied_entity_ids: []
                            };
                        });
                    }
                }
                
                // Load users, groups, roles for entity selector
                await loadAccessEntities();
                
                // Render UI
                renderAccessType();
                renderTasksMatrix();
                renderToolsMatrix();
                
            } catch(e) {
                console.error('Error loading access control data:', e);
                showToast('Failed to load access control data', 'error');
            }
        }
        
        async function loadAccessEntities() {
            try {
                const headers = getAuthHeaders();
                
                // Load users
                const usersRes = await fetch(`${API}/api/security/users`, { headers });
                if(usersRes.ok) {
                    const usersData = await usersRes.json();
                    accessControlState.allUsers = Array.isArray(usersData) ? usersData : (usersData.users || []);
                    console.log('âœ… Loaded users for access control:', accessControlState.allUsers.length, accessControlState.allUsers);
                }
                
                // Load roles
                const rolesRes = await fetch(`${API}/api/security/roles`, { headers });
                if(rolesRes.ok) {
                    const rolesData = await rolesRes.json();
                    accessControlState.allRoles = Array.isArray(rolesData) ? rolesData : (rolesData.roles || []);
                }
                
                // Load groups
                const groupsRes = await fetch(`${API}/api/security/groups`, { headers });
                if(groupsRes.ok) {
                    const groupsData = await groupsRes.json();
                    accessControlState.allGroups = Array.isArray(groupsData) ? groupsData : (groupsData.groups || []);
                    console.log('âœ… Loaded groups for access control:', accessControlState.allGroups.length, accessControlState.allGroups);
                }
                
                // Enrich entities with proper names from loaded data
                enrichEntitiesWithNames();
                
            } catch(e) {
                console.error('Error loading entities:', e);
            }
        }
        
        function enrichEntitiesWithNames() {
            // Enrich each entity with its proper name from loaded users/groups/roles
            accessControlState.entities = accessControlState.entities.map(e => {
                if (e.name && !e.name.includes('...') && e.name.length > 10) {
                    // Already has a good name
                    return e;
                }
                
                // Try to find the entity's real name
                if (e.type === 'user') {
                    const user = accessControlState.allUsers.find(u => u.id === e.id);
                    if (user) {
                        return { ...e, name: user.name || user.email || `User ${e.id.slice(0, 8)}` };
                    }
                } else if (e.type === 'group') {
                    const group = accessControlState.allGroups.find(g => g.id === e.id);
                    if (group) {
                        return { ...e, name: group.name || `Group ${e.id.slice(0, 8)}` };
                    }
                } else if (e.type === 'role') {
                    const role = accessControlState.allRoles.find(r => r.id === e.id);
                    if (role) {
                        return { ...e, name: role.name || `Role ${e.id.slice(0, 8)}` };
                    }
                }
                
                return e;
            });
            
            console.log('âœ… Enriched entities:', accessControlState.entities);
            
            // Re-render to show updated names
            renderSelectedEntities();
            renderTasksMatrix();
            renderToolsMatrix();
        }
        
        function selectAccessType(type) {
            accessControlState.accessType = type;
            renderAccessType();
        }
        
        function renderAccessType() {
            const types = ['public', 'authenticated', 'specific'];
            
            types.forEach(t => {
                const el = document.getElementById('access-type-' + t);
                if(t === accessControlState.accessType) {
                    el.classList.add('border-purple-500', 'bg-purple-500/10');
                    el.classList.remove('border-gray-600');
                } else {
                    el.classList.remove('border-purple-500', 'bg-purple-500/10');
                    el.classList.add('border-gray-600');
                }
            });
            
            // Show/hide entity selector
            const selector = document.getElementById('access-entity-selector');
            if(accessControlState.accessType === 'specific') {
                selector.classList.remove('hidden');
                renderSelectedEntities();
            } else {
                selector.classList.add('hidden');
            }
        }
        
        function searchAccessEntities(query) {
            const resultsEl = document.getElementById('access-entity-results');
            
            if(!query || query.length < 2) {
                resultsEl.classList.add('hidden');
                return;
            }
            
            query = query.toLowerCase();
            let results = [];
            
            // Search users - API returns 'name' field directly or nested in profile
            accessControlState.allUsers.filter(u => {
                const displayName = u.name || `${u.profile?.first_name || u.first_name || ''} ${u.profile?.last_name || u.last_name || ''}`.trim() || '';
                const email = u.email || '';
                return email.toLowerCase().includes(query) || 
                       displayName.toLowerCase().includes(query);
            }).slice(0, 5).forEach(u => {
                const displayName = u.name || `${u.profile?.first_name || u.first_name || ''} ${u.profile?.last_name || u.last_name || ''}`.trim() || u.email || `User ${u.id.slice(0, 8)}`;
                results.push({
                    id: u.id,
                    type: 'user',
                    name: displayName,
                    sub: u.email || ''
                });
            });
            
            // Search roles
            accessControlState.allRoles.filter(r => 
                r.name?.toLowerCase().includes(query)
            ).slice(0, 5).forEach(r => {
                results.push({
                    id: r.id,
                    type: 'role',
                    name: r.name || `Role ${r.id.slice(0, 8)}`,
                    sub: `${r.permissions?.length || 0} permissions`
                });
            });
            
            // Search groups
            accessControlState.allGroups.filter(g => 
                (g.name || '').toLowerCase().includes(query) ||
                (g.description || '').toLowerCase().includes(query)
            ).slice(0, 5).forEach(g => {
                results.push({
                    id: g.id,
                    type: 'group',
                    name: g.name || `Group ${g.id.slice(0, 8)}`,
                    sub: `${(g.member_ids || g.user_ids || []).length} members`
                });
            });
            
            if(results.length === 0) {
                resultsEl.innerHTML = '<div class="p-3 text-gray-500 text-sm">No results found</div>';
            } else {
                resultsEl.innerHTML = results.map(r => `
                    <div onclick="addAccessEntity('${r.id}', '${r.type}', '${r.name.replace(/'/g, "\\'")}')" 
                         class="p-3 hover:bg-gray-700 cursor-pointer border-b border-gray-700 last:border-b-0">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${r.type === 'user' ? 'ðŸ‘¤' : r.type === 'role' ? 'ðŸ·ï¸' : 'ðŸ‘¥'}</span>
                            <div>
                                <div class="font-medium">${r.name}</div>
                                <div class="text-xs text-gray-400">${r.sub}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            resultsEl.classList.remove('hidden');
        }
        
        function addAccessEntity(id, type, name) {
            // Check if already added
            if(accessControlState.entities.find(e => e.id === id)) {
                showToast('Already added', 'info');
                return;
            }
            
            accessControlState.entities.push({ id, type, name });
            renderSelectedEntities();
            
            // Update matrices to show new entity columns
            renderTasksMatrix();
            renderToolsMatrix();
            
            // Clear search
            document.getElementById('access-entity-search').value = '';
            document.getElementById('access-entity-results').classList.add('hidden');
        }
        
        function removeAccessEntity(id) {
            accessControlState.entities = accessControlState.entities.filter(e => e.id !== id);
            renderSelectedEntities();
            
            // Also remove this entity from all task/tool denied lists
            accessControlState.tasks.forEach(t => {
                if (t.denied_entity_ids) {
                    t.denied_entity_ids = t.denied_entity_ids.filter(eid => eid !== id);
                }
            });
            accessControlState.tools.forEach(t => {
                if (t.denied_entity_ids) {
                    t.denied_entity_ids = t.denied_entity_ids.filter(eid => eid !== id);
                }
            });
            
            // Update matrices
            renderTasksMatrix();
            renderToolsMatrix();
        }
        
        function renderSelectedEntities() {
            const container = document.getElementById('access-selected-entities');
            
            if(accessControlState.entities.length === 0) {
                container.innerHTML = '<span class="text-gray-500 text-sm italic">No specific access configured - all authenticated users have access</span>';
                return;
            }
            
            container.innerHTML = accessControlState.entities.map(e => `
                <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm"
                      style="background: ${e.type === 'user' ? 'rgba(59, 130, 246, 0.2)' : e.type === 'role' ? 'rgba(139, 92, 246, 0.2)' : 'rgba(16, 185, 129, 0.2)'}">
                    ${e.type === 'user' ? 'ðŸ‘¤' : e.type === 'role' ? 'ðŸ·ï¸' : 'ðŸ‘¥'}
                    ${e.name}
                    <button onclick="removeAccessEntity('${e.id}')" class="hover:text-red-400 ml-1">âœ•</button>
                </span>
            `).join('');
        }
        
        function renderTasksMatrix() {
            const container = document.getElementById('access-tasks-matrix');
            const entities = accessControlState.entities;
            const tasks = accessControlState.tasks;
            
            if(tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ðŸ“‹</div>
                        <p>No tasks configured for this agent</p>
                    </div>
                `;
                return;
            }
            
            if(entities.length === 0) {
                // No specific entities - show simple allow/deny for each task
                container.innerHTML = `
                    <div class="text-sm text-gray-400 mb-4 p-3 bg-blue-500/10 rounded-lg border border-blue-500/30">
                        ðŸ’¡ <strong>Tip:</strong> Add specific users, groups, or roles in "Agent Access" tab to configure per-entity task permissions.
                    </div>
                    ${tasks.map((task, idx) => `
                        <div class="flex items-center justify-between p-4 rounded-lg bg-gray-800/50 hover:bg-gray-800 mb-2">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ðŸ“‹</span>
                                <div>
                                    <div class="font-medium">${task.task_name}</div>
                                </div>
                            </div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="accent-green-500 w-5 h-5" 
                                       ${!task.denied_all ? 'checked' : ''}
                                       onchange="toggleTaskGlobal(${idx}, this.checked)">
                                <span class="text-sm">${!task.denied_all ? 'âœ… Allowed' : 'âŒ Denied'}</span>
                            </label>
                        </div>
                    `).join('')}
                `;
                return;
            }
            
            // Show permission matrix: rows = tasks, columns = entities
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="text-left p-3 font-medium">Task</th>
                                ${entities.map(e => `
                                    <th class="p-3 text-center">
                                        <div class="flex flex-col items-center gap-1">
                                            <span>${e.type === 'user' ? 'ðŸ‘¤' : e.type === 'role' ? 'ðŸ·ï¸' : 'ðŸ‘¥'}</span>
                                            <span class="text-xs font-normal truncate max-w-[80px]" title="${e.name}">${e.name}</span>
                                        </div>
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${tasks.map((task, tIdx) => `
                                <tr class="border-b border-gray-700/50 hover:bg-gray-800/30">
                                    <td class="p-3">
                                        <div class="flex items-center gap-2">
                                            <span>ðŸ“‹</span>
                                            <span class="font-medium">${task.task_name}</span>
                                        </div>
                                    </td>
                                    ${entities.map((e, eIdx) => {
                                        const allowed = isTaskAllowedForEntity(tIdx, e.id);
                                        return `
                                            <td class="p-3 text-center">
                                                <button onclick="toggleTaskEntityAccess(${tIdx}, '${e.id}')" 
                                                        class="w-10 h-10 rounded-lg transition-all ${allowed ? 'bg-green-500/20 hover:bg-green-500/30 text-green-400' : 'bg-red-500/20 hover:bg-red-500/30 text-red-400'}">
                                                    ${allowed ? 'âœ…' : 'âŒ'}
                                                </button>
                                            </td>
                                        `;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function isTaskAllowedForEntity(taskIdx, entityId) {
            const task = accessControlState.tasks[taskIdx];
            if (!task) return true;
            const denied = task.denied_entity_ids || [];
            return !denied.includes(entityId) && !denied.includes('all');
        }
        
        function toggleTaskGlobal(idx, allowed) {
            accessControlState.tasks[idx].denied_all = !allowed;
            accessControlState.tasks[idx].denied_entity_ids = allowed ? [] : ['all'];
            renderTasksMatrix();
        }
        
        function toggleTaskEntityAccess(taskIdx, entityId) {
            const task = accessControlState.tasks[taskIdx];
            if (!task.denied_entity_ids) task.denied_entity_ids = [];
            
            const idx = task.denied_entity_ids.indexOf(entityId);
            if (idx > -1) {
                // Currently denied, remove from denied list (allow)
                task.denied_entity_ids.splice(idx, 1);
            } else {
                // Currently allowed, add to denied list (deny)
                task.denied_entity_ids.push(entityId);
            }
            // Remove 'all' if individual permissions are being set
            const allIdx = task.denied_entity_ids.indexOf('all');
            if (allIdx > -1) task.denied_entity_ids.splice(allIdx, 1);
            
            renderTasksMatrix();
        }
        
        function renderToolsMatrix() {
            const container = document.getElementById('access-tools-matrix');
            const entities = accessControlState.entities;
            const tools = accessControlState.tools;
            
            if(tools.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ðŸ”§</div>
                        <p>No tools configured for this agent</p>
                    </div>
                `;
                return;
            }
            
            if(entities.length === 0) {
                // No specific entities - show simple allow/deny for each tool
                container.innerHTML = `
                    <div class="text-sm text-gray-400 mb-4 p-3 bg-blue-500/10 rounded-lg border border-blue-500/30">
                        ðŸ’¡ <strong>Tip:</strong> Add specific users, groups, or roles in "Agent Access" tab to configure per-entity tool permissions.
                    </div>
                    ${tools.map((tool, idx) => `
                        <div class="flex items-center justify-between p-4 rounded-lg bg-gray-800/50 hover:bg-gray-800 mb-2">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">ðŸ”§</span>
                                <div>
                                    <div class="font-medium">${tool.tool_name}</div>
                                </div>
                            </div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="accent-green-500 w-5 h-5" 
                                       ${!tool.denied_all ? 'checked' : ''}
                                       onchange="toggleToolGlobal(${idx}, this.checked)">
                                <span class="text-sm">${!tool.denied_all ? 'âœ… Allowed' : 'âŒ Denied'}</span>
                            </label>
                        </div>
                    `).join('')}
                `;
                return;
            }
            
            // Show permission matrix: rows = tools, columns = entities
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="text-left p-3 font-medium">Tool</th>
                                ${entities.map(e => `
                                    <th class="p-3 text-center">
                                        <div class="flex flex-col items-center gap-1">
                                            <span>${e.type === 'user' ? 'ðŸ‘¤' : e.type === 'role' ? 'ðŸ·ï¸' : 'ðŸ‘¥'}</span>
                                            <span class="text-xs font-normal truncate max-w-[80px]" title="${e.name}">${e.name}</span>
                                        </div>
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${tools.map((tool, tIdx) => `
                                <tr class="border-b border-gray-700/50 hover:bg-gray-800/30">
                                    <td class="p-3">
                                        <div class="flex items-center gap-2">
                                            <span>ðŸ”§</span>
                                            <span class="font-medium">${tool.tool_name}</span>
                                        </div>
                                    </td>
                                    ${entities.map((e, eIdx) => {
                                        const allowed = isToolAllowedForEntity(tIdx, e.id);
                                        return `
                                            <td class="p-3 text-center">
                                                <button onclick="toggleToolEntityAccess(${tIdx}, '${e.id}')" 
                                                        class="w-10 h-10 rounded-lg transition-all ${allowed ? 'bg-green-500/20 hover:bg-green-500/30 text-green-400' : 'bg-red-500/20 hover:bg-red-500/30 text-red-400'}">
                                                    ${allowed ? 'âœ…' : 'âŒ'}
                                                </button>
                                            </td>
                                        `;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function isToolAllowedForEntity(toolIdx, entityId) {
            const tool = accessControlState.tools[toolIdx];
            if (!tool) return true;
            const denied = tool.denied_entity_ids || [];
            return !denied.includes(entityId) && !denied.includes('all');
        }
        
        function toggleToolGlobal(idx, allowed) {
            accessControlState.tools[idx].denied_all = !allowed;
            accessControlState.tools[idx].denied_entity_ids = allowed ? [] : ['all'];
            renderToolsMatrix();
        }
        
        function toggleToolEntityAccess(toolIdx, entityId) {
            const tool = accessControlState.tools[toolIdx];
            if (!tool.denied_entity_ids) tool.denied_entity_ids = [];
            
            const idx = tool.denied_entity_ids.indexOf(entityId);
            if (idx > -1) {
                // Currently denied, remove from denied list (allow)
                tool.denied_entity_ids.splice(idx, 1);
            } else {
                // Currently allowed, add to denied list (deny)
                tool.denied_entity_ids.push(entityId);
            }
            // Remove 'all' if individual permissions are being set
            const allIdx = tool.denied_entity_ids.indexOf('all');
            if (allIdx > -1) tool.denied_entity_ids.splice(allIdx, 1);
            
            renderToolsMatrix();
        }
        
        function updateTaskDefault(mode) {
            accessControlState.taskDefault = mode;
        }
        
        function updateToolDefault(mode) {
            accessControlState.toolDefault = mode;
        }
        
        async function applyAccessTemplate(templateId) {
            if(!templateId) return;
            
            const orgId = currentUser?.org_id || 'default';
            const headers = getAuthHeaders();
            
            try {
                const response = await fetch(
                    `${API}/api/access-control/agents/${accessControlState.agentId}/apply-template?template_id=${templateId}&org_id=${orgId}&user_id=${currentUser?.id || 'system'}`,
                    { method: 'POST', headers }
                );
                
                if(response.ok) {
                    showToast(`Template "${templateId}" applied!`, 'success');
                    await loadAccessControlData();
                } else {
                    throw new Error('Failed to apply template');
                }
            } catch(e) {
                showToast('Failed to apply template', 'error');
            }
            
            // Reset select
            document.getElementById('access-template-select').value = '';
        }
        
        function previewAccessAsUser() {
            showToast('Preview feature coming soon!', 'info');
        }
        
        async function saveAccessControl() {
            const orgId = currentUser?.org_id || 'default';
            const userId = currentUser?.id || 'system';
            const authHeaders = getAuthHeaders();
            
            try {
                // Save Level 1: Agent Access
                await fetch(
                    `${API}/api/access-control/agents/${accessControlState.agentId}/access?org_id=${orgId}&user_id=${userId}`,
                    {
                        method: 'PUT',
                        headers: { ...authHeaders, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            access_type: accessControlState.accessType,
                            entities: accessControlState.entities
                        })
                    }
                );
                
                // Save Level 2: Task Access
                await fetch(
                    `${API}/api/access-control/agents/${accessControlState.agentId}/tasks?org_id=${orgId}&user_id=${userId}`,
                    {
                        method: 'PUT',
                        headers: { ...authHeaders, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            allow_all_by_default: accessControlState.taskDefault === 'allow',
                            task_permissions: accessControlState.tasks
                        })
                    }
                );
                
                // Save Level 3: Tool Access
                await fetch(
                    `${API}/api/access-control/agents/${accessControlState.agentId}/tools?org_id=${orgId}&user_id=${userId}`,
                    {
                        method: 'PUT',
                        headers: { ...authHeaders, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            allow_all_by_default: accessControlState.toolDefault === 'allow',
                            tool_permissions: accessControlState.tools
                        })
                    }
                );
                
                showToast('Access control saved successfully!', 'success');
                closeAccessControlModal();
                
            } catch(e) {
                console.error('Error saving access control:', e);
                showToast('Failed to save access control', 'error');
            }
        }
        
        // ============================================================
        // END ACCESS CONTROL MODULE
        // ============================================================

        // Generate asset file
        async function generateAssetFile(kitId, assetId) {
            try {
                const response = await fetch(API + `/api/demo-kits/${kitId}/assets/${assetId}/generate`, {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Failed to generate');
                
                const result = await response.json();
                alert('Asset generated! You can now download it.');
                
                // Refresh kit details
                selectDemoKit(kitId);
            } catch (e) {
                alert('Failed to generate asset file: ' + e.message);
            }
        }
        
        // ========== EDIT FUNCTIONS ==========
        let currentEditKitId = null;
        let currentEditItemId = null;
        
        // Edit Asset (only Assets need modal - APIs and KBs go to Tools page)
        function editDemoAsset(kitId, assetId) {
            currentEditKitId = kitId;
            currentEditItemId = assetId;
            
            fetch(API + `/api/demo-kits/${kitId}`)
                .then(r => r.json())
                .then(kit => {
                    const asset = kit.assets.find(a => a.id === assetId);
                    if (!asset) return;
                    
                    document.getElementById('edit-asset-name').value = asset.name || '';
                    document.getElementById('edit-asset-description').value = asset.description || '';
                    document.getElementById('edit-asset-type').value = asset.asset_type || 'document';
                    ensureModalInBody('edit-asset-modal');
                    document.getElementById('edit-asset-modal').classList.remove('hidden');
                    document.getElementById('edit-asset-modal').classList.add('flex');
                });
        }
        
        function closeEditAssetModal() {
            document.getElementById('edit-asset-modal').classList.add('hidden');
            document.getElementById('edit-asset-modal').classList.remove('flex');
        }
        
        async function saveEditAsset() {
            try {
                const response = await fetch(API + `/api/demo-kits/${currentEditKitId}/asset/${currentEditItemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('edit-asset-name').value,
                        description: document.getElementById('edit-asset-description').value,
                        asset_type: document.getElementById('edit-asset-type').value
                    })
                });
                
                if (!response.ok) throw new Error('Failed to update');
                
                closeEditAssetModal();
                selectDemoKit(currentEditKitId);
            } catch (e) {
                alert('Failed to save: ' + e.message);
            }
        }

        // Use example text in modal
        function useDemoKitExample() {
            showCreateKitModal();
            document.getElementById('new-kit-description').value = `I need tools for an HR agent that can check employee vacation balance, submit vacation requests, process expense claims with receipt uploads, and answer questions about HR policies including benefits and leave policies. Also need sample invoices and receipts for testing.`;
        }

        async function loadDemoItems() {
            try {
                const r = await fetch(API + '/api/demo/items');
                const d = await r.json();
                demoItems = d;
                renderDemoSidebar();
                updateDemoCounts();
            } catch(e) {
                console.log('Demo items not loaded:', e);
            }
        }

        function updateDemoCounts() {
            const apis = demoItems.apis || [];
            const docs = demoItems.docs || [];
            const images = demoItems.images || [];
            const all = apis.length + docs.length + images.length;
            
            document.getElementById('count-all').textContent = all;
            document.getElementById('count-api').textContent = apis.length;
            document.getElementById('count-document').textContent = docs.length;
            document.getElementById('count-image').textContent = images.length;
        }

        function renderDemoSidebar() {
            const container = document.getElementById('demo-sidebar-items');
            let items = [];
            
            // Get items based on tab filter
            if (demoSidebarTab === 'all') {
                items = [
                    ...(demoItems.apis || []).map(i => ({...i, itemType: 'api'})),
                    ...(demoItems.docs || []).map(i => ({...i, itemType: 'document'})),
                    ...(demoItems.images || []).map(i => ({...i, itemType: 'image'}))
                ];
            } else if (demoSidebarTab === 'api') {
                items = (demoItems.apis || []).map(i => ({...i, itemType: 'api'}));
            } else if (demoSidebarTab === 'document') {
                items = (demoItems.docs || []).map(i => ({...i, itemType: 'document'}));
            } else if (demoSidebarTab === 'image') {
                items = (demoItems.images || []).map(i => ({...i, itemType: 'image'}));
            }
            
            if (!items.length) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="text-3xl block mb-2">ðŸ“­</span>
                        <p class="text-sm">No items yet</p>
                        <p class="text-xs mt-1">Generate something to get started!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = items.map(item => {
                const icons = { api: 'ðŸ”—', document: 'ðŸ“„', image: 'ðŸ–¼ï¸' };
                const colors = { api: 'purple', document: 'blue', image: 'green' };
                const icon = icons[item.itemType] || 'ðŸ“„';
                const color = colors[item.itemType] || 'gray';
                
                return `
                    <div class="group bg-gray-800/50 hover:bg-gray-800 rounded-lg p-3 transition-all border border-transparent hover:border-${color}-500/30 cursor-pointer" onclick="viewDemoItem('${item.id}', '${item.itemType}')">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex items-center gap-2 min-w-0 flex-1">
                                <span class="w-8 h-8 rounded-lg bg-${color}-500/20 flex items-center justify-center text-sm flex-shrink-0">${icon}</span>
                                <div class="min-w-0 flex-1">
                                    <p class="font-medium text-sm truncate">${item.name || 'Untitled'}</p>
                                    <p class="text-xs text-gray-500 truncate">${item.description || item.itemType}</p>
                                </div>
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="event.stopPropagation(); editDemoItem('${item.id}', '${item.itemType}')" class="p-1.5 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="Edit">
                                    âœï¸
                                </button>
                                <button onclick="event.stopPropagation(); deleteDemoItem('${item.id}', '${item.itemType}')" class="p-1.5 hover:bg-red-900/50 rounded text-gray-400 hover:text-red-400" title="Delete">
                                    ðŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                        ${item.url ? `
                            <div class="mt-2 pt-2 border-t border-gray-700/50 flex gap-2">
                                <a href="${item.url.startsWith('http') ? item.url : API + item.url}" target="_blank" onclick="event.stopPropagation()" class="text-xs text-${color}-400 hover:underline flex items-center gap-1">
                                    ${item.itemType === 'api' ? 'ðŸ”— Test API' : item.itemType === 'image' ? 'ðŸ‘ï¸ View' : 'â¬‡ï¸ Download'}
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // View item details
        function viewDemoItem(id, type) {
            const items = type === 'api' ? demoItems.apis : type === 'document' ? demoItems.docs : demoItems.images;
            const item = items?.find(i => i.id === id);
            if (!item) return;
            
            const url = item.url ? (item.url.startsWith('http') ? item.url : API + item.url) : null;
            
            if (type === 'api' && url) {
                window.open(url, '_blank');
            } else if (url) {
                window.open(url, '_blank');
            }
        }

        // Edit item
        function editDemoItem(id, type) {
            const items = type === 'api' ? demoItems.apis : type === 'document' ? demoItems.docs : demoItems.images;
            const item = items?.find(i => i.id === id);
            if (!item) return;
            
            demoEditingItem = { id, type, item };
            ensureModalInBody('demo-edit-modal');
            const modal = document.getElementById('demo-edit-modal');
            const title = document.getElementById('edit-modal-title');
            const content = document.getElementById('edit-modal-content');
            
            const icons = { api: 'ðŸ”—', document: 'ðŸ“„', image: 'ðŸ–¼ï¸' };
            title.textContent = `${icons[type]} Edit ${item.name || 'Item'}`;
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Name</label>
                        <input type="text" id="edit-item-name" class="input-field w-full rounded-lg px-3 py-2" value="${item.name || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Description</label>
                        <textarea id="edit-item-description" class="input-field w-full rounded-lg px-3 py-2 h-24">${item.description || ''}</textarea>
                    </div>
                    ${type === 'api' ? `
                        <div>
                            <label class="block text-sm font-medium mb-2">API URL</label>
                            <input type="text" id="edit-item-url" class="input-field w-full rounded-lg px-3 py-2 bg-gray-700" value="${item.url || ''}" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Endpoints</label>
                            <div class="bg-gray-800 rounded-lg p-3 text-sm font-mono max-h-40 overflow-y-auto">
                                ${(item.endpoints || []).map(e => `<div class="text-gray-300">${e.method} ${e.path}</div>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeDemoEditModal() {
            const modal = document.getElementById('demo-edit-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            demoEditingItem = null;
        }

        async function saveDemoEdit() {
            if (!demoEditingItem) return;
            
            const name = document.getElementById('edit-item-name')?.value;
            const description = document.getElementById('edit-item-description')?.value;
            
            try {
                const response = await fetch(API + '/api/demo/items/' + demoEditingItem.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: demoEditingItem.type,
                        name,
                        description
                    })
                });
                
                if (response.ok) {
                    closeDemoEditModal();
                    loadDemoItems();
                    addDemoMessage('assistant', `âœ… Updated "${name}" successfully!`);
                } else {
                    alert('Failed to save changes');
                }
            } catch (e) {
                console.error('Save error:', e);
                alert('Error saving: ' + e.message);
            }
        }

        // Delete item
        async function deleteDemoItem(id, type) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            try {
                const response = await fetch(API + '/api/demo/items/' + id + '?type=' + type, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadDemoItems();
                    addDemoMessage('assistant', 'ðŸ—‘ï¸ Item deleted successfully.');
                } else {
                    alert('Failed to delete item');
                }
            } catch (e) {
                console.error('Delete error:', e);
                alert('Error deleting: ' + e.message);
            }
        }

        // Clear all demo history
        async function clearDemoHistory() {
            if (!confirm('Are you sure you want to clear all generated items? This cannot be undone.')) return;
            
            try {
                const response = await fetch(API + '/api/demo/items/clear', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    demoItems = { apis: [], docs: [], images: [] };
                    demoConversation = [];
                    renderDemoSidebar();
                    updateDemoCounts();
                    clearDemoChat();
                }
            } catch (e) {
                console.error('Clear error:', e);
            }
        }

        async function sendDemoMessage() {
            const input = document.getElementById('demo-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            
            // Remove welcome message
            const welcome = document.getElementById('demo-welcome');
            if (welcome) welcome.remove();
            
            // Add user message
            addDemoMessage('user', message);
            
            // Add thinking indicator
            const thinkingId = addDemoMessage('assistant', `<span class="animate-pulse">ðŸ§ª Generating ${demoCurrentMode}...</span>`, true);
            
            try {
                const response = await fetch(API + '/api/demo/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message, 
                        conversation: demoConversation,
                        mode_hint: demoCurrentMode  // Pass the current mode as a hint
                    })
                });
                
                const data = await response.json();
                
                // Remove thinking indicator
                document.getElementById(thinkingId)?.remove();
                
                // Add assistant response
                addDemoMessage('assistant', data.response);
                
                // If there's a generated item, show action buttons
                if (data.generated) {
                    addDemoActionButtons(data.generated);
                }
                
                // Save to conversation
                demoConversation.push({ role: 'user', content: message });
                demoConversation.push({ role: 'assistant', content: data.response });
                
                // Refresh items list
                loadDemoItems();
                
            } catch (e) {
                document.getElementById(thinkingId)?.remove();
                addDemoMessage('assistant', 'âŒ Error: ' + e.message);
            }
        }

        function addDemoMessage(role, content, isTemp = false) {
            const container = document.getElementById('demo-chat-messages');
            const id = 'demo-msg-' + Date.now();
            
            const msgDiv = document.createElement('div');
            msgDiv.id = id;
            msgDiv.className = role === 'user' 
                ? 'flex justify-end' 
                : 'flex justify-start';
            
            const bgColor = role === 'user' ? 'bg-gradient-to-r from-purple-600 to-purple-700' : 'bg-gray-800';
            
            msgDiv.innerHTML = `
                <div class="${bgColor} rounded-2xl px-4 py-3 max-w-[80%] shadow-lg">
                    ${role === 'assistant' ? '<span class="text-lg mr-2">ðŸ¤–</span>' : ''}
                    <div class="text-sm ${role === 'user' ? '' : 'prose prose-invert prose-sm max-w-none'}">${content}</div>
                </div>
            `;
            
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            
            return id;
        }

        function addDemoActionButtons(generated) {
            const container = document.getElementById('demo-chat-messages');
            
            console.log('[Demo Lab] Generated item:', generated);
            
            if (!generated) {
                console.log('[Demo Lab] No generated item');
                return;
            }
            
            // For documents/images, check if URL exists
            if ((generated.type === 'document' || generated.type === 'image') && !generated.url) {
                console.log('[Demo Lab] No URL for generated item:', generated);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'flex justify-start';
                errorDiv.innerHTML = `
                    <div class="bg-red-900/30 border border-red-500/30 rounded-xl px-4 py-3 text-sm text-red-300 mt-2">
                        âš ï¸ Generation may have failed. Check server logs for details.
                    </div>
                `;
                container.appendChild(errorDiv);
                return;
            }
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex justify-start';
            
            let buttons = '';
            const fullUrl = generated.url ? (generated.url.startsWith('http') ? generated.url : API + generated.url) : '';
            
            if (generated.type === 'api') {
                const apiUrl = generated.url ? (generated.url.startsWith('http') ? generated.url : API + generated.url) : API + '/demo-api/' + generated.name;
                buttons = `
                    <button onclick="createToolFromDemo('${generated.id}')" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded-xl text-sm font-medium transition-colors">
                        âœ¨ Create API Tool
                    </button>
                    <a href="${apiUrl}" target="_blank" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-xl text-sm font-medium transition-colors">
                        ðŸ”— Test API
                    </a>
                `;
            } else if (generated.type === 'document') {
                buttons = `
                    <a href="${fullUrl}" download class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl text-sm font-medium flex items-center gap-2 transition-colors">
                        â¬‡ï¸ Download ${generated.name || 'Document'}
                    </a>
                    <a href="${fullUrl}" target="_blank" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-xl text-sm font-medium transition-colors">
                        ðŸ‘ï¸ Preview
                    </a>
                `;
            } else if (generated.type === 'image') {
                buttons = `
                    <a href="${fullUrl}" download class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-xl text-sm font-medium transition-colors">
                        â¬‡ï¸ Download Image
                    </a>
                    <a href="${fullUrl}" target="_blank" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-xl text-sm font-medium transition-colors">
                        ðŸ‘ï¸ View Full Size
                    </a>
                `;
            }
            
            actionsDiv.innerHTML = `
                <div class="flex gap-2 mt-3 ml-2">
                    ${buttons}
                </div>
            `;
            
            container.appendChild(actionsDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function createToolFromDemo(demoApiId) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (typeof getAuthHeaders === 'function') Object.assign(headers, getAuthHeaders());
                const response = await fetch(API + '/api/demo/create-tool', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ demo_id: demoApiId })
                });
                
                const data = await response.json();
                
                if (response.status === 401) {
                    addDemoMessage('assistant', 'âš ï¸ ' + (data.detail || 'Please sign in to create a tool from Demo Lab. You will be the owner and can edit or delete it later.'));
                    return;
                }
                if (data.success) {
                    addDemoMessage('assistant', `âœ… API Tool "${data.tool_name}" created successfully! You can now assign it to any agent and you are the owner (you can edit or delete it).`);
                    loadTools();
                } else {
                    addDemoMessage('assistant', 'âŒ Failed to create tool: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                addDemoMessage('assistant', 'âŒ Error: ' + e.message);
            }
        }

        async function createDocToolFromDemo(demoDocId) {
            addDemoMessage('assistant', 'ðŸ“„ To add this document to a tool, go to Tools and upload it there.');
        }

        function clearDemoChat() {
            demoConversation = [];
            const container = document.getElementById('demo-chat-messages');
            container.innerHTML = `
                <div class="text-center text-gray-500 py-6" id="demo-welcome">
                    <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-purple-500/20 to-blue-500/20 flex items-center justify-center mb-4">
                        <span class="text-4xl">ðŸ§ª</span>
                    </div>
                    <p class="text-lg font-medium mb-2">Welcome to Demo Lab!</p>
                    <p class="text-sm mb-6 text-gray-400">Generate instant mock APIs, professional documents & images</p>
                    <p class="text-xs text-gray-500">Select a mode above and type your request below</p>
                </div>
            `;
        }
        // ============================================================================
        // END DEMO LAB FUNCTIONS
        // ============================================================================

        function setAgentTab(t){
            agentTab=t;
            document.getElementById('tab-published').className='tab-btn pb-3 px-2 border-b-2 whitespace-nowrap '+(t==='published'?'active border-purple-500':'border-transparent');
            document.getElementById('tab-draft').className='tab-btn pb-3 px-2 border-b-2 whitespace-nowrap '+(t==='draft'?'active border-purple-500':'border-transparent');
            loadAgents();
        }

        async function loadAgents(){
            const r=await fetch(API+'/api/agents?status='+agentTab, {
                headers: getAuthHeaders()
            });
            const d=await r.json();
            
            // Separate agents by type
            const workflowAgents = d.agents.filter(a => a.agent_type === 'process');
            const conversationalAgents = d.agents.filter(a => a.agent_type !== 'process');
            
            // Get containers
            const workflowSection = document.getElementById('workflow-agents-section');
            const workflowGrid = document.getElementById('workflow-agents-grid');
            const conversationalSection = document.getElementById('conversational-agents-section');
            const conversationalGrid = document.getElementById('conversational-agents-grid');
            
            // Update counts
            document.getElementById('workflow-count').textContent = workflowAgents.length;
            document.getElementById('conversational-count').textContent = conversationalAgents.length;
            
            // Handle empty state
            if(!d.agents.length){
                workflowSection.classList.add('hidden');
                conversationalGrid.innerHTML=`<div class="col-span-full text-center py-10 md:py-20 text-gray-500">
                    <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-20 h-20 mx-auto mb-4 opacity-50">
                    <p class="mb-4">No ${agentTab} agents yet</p>
                    <button onclick="navigate('create')" class="btn-primary px-4 py-2 rounded-lg">Create Your First Agent</button>
                </div>`;
                return;
            }
            
            // Render Workflow Agents (different card design)
            if (workflowAgents.length > 0) {
                workflowSection.classList.remove('hidden');
                workflowGrid.innerHTML = workflowAgents.map(a => `
                    <div class="card rounded-xl overflow-hidden hover:shadow-lg hover:shadow-green-500/10 transition-all cursor-pointer group" 
                         style="background: linear-gradient(135deg, rgba(34,197,94,0.05), rgba(20,184,166,0.05)); border: 1px solid rgba(34,197,94,0.2);"
                         onclick="openAgent('${a.id}', '${a.status}', 'process')">
                        <!-- Header with gradient -->
                        <div class="p-4" style="background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(20,184,166,0.15));">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-2xl shadow-lg">
                                    ðŸ”„
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-semibold text-white truncate">${a.name}</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-xs px-2 py-0.5 rounded-full bg-green-500/20 text-green-400">Workflow</span>
                                        <span class="text-xs px-2 py-0.5 rounded-full ${a.status === 'published' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">${a.status}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Body -->
                        <div class="p-4">
                            <p class="text-sm text-gray-400 line-clamp-2 mb-4">${a.goal}</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4 text-xs text-gray-500">
                                    <span>âš¡ Automation</span>
                                    <span>ðŸ”§ ${a.tools_count} tools</span>
                                </div>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                    ${a.status === 'published' ? `<button onclick="event.stopPropagation();openProcessExecution('${a.id}')" class="p-2 rounded-lg bg-green-500 hover:bg-green-600 text-white text-sm" title="Run">â–¶ï¸</button>` : ''}
                                    <button onclick="event.stopPropagation();editAgent('${a.id}')" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-sm" title="Edit">âœï¸</button>
                                    ${a.is_owner ? `<button onclick="event.stopPropagation();deleteAgent('${a.id}')" class="p-2 rounded-lg bg-red-500/20 hover:bg-red-500/40 text-red-400 text-sm" title="Delete">ðŸ—‘ï¸</button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                workflowSection.classList.add('hidden');
            }
            
            // Render Conversational Agents (original design with purple theme)
            if (conversationalAgents.length > 0) {
                conversationalSection.classList.remove('hidden');
                conversationalGrid.innerHTML = conversationalAgents.map(a => `
                    <div class="card agent-card rounded-xl p-4 hover:border-purple-500 hover:shadow-lg hover:shadow-purple-500/10 transition-all cursor-pointer group" 
                         style="min-width:0;overflow:visible;"
                         onclick="openAgent('${a.id}', '${a.status}', 'conversational')">
                        <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-2xl flex-shrink-0">
                                ${a.icon || 'ðŸ¤–'}
                            </div>
                            <div style="flex:1;min-width:0;overflow:hidden;width:100%;">
                                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                                    <h3 class="agent-title" style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0;">${a.name}</h3>
                                    <span class="text-xs px-2 py-0.5 rounded-full ${a.status === 'published' ? 'bg-purple-500/20 text-purple-400' : 'bg-yellow-500/20 text-yellow-400'}">${a.status}</span>
                                </div>
                                <p class="agent-desc text-sm text-gray-400 mt-1 line-clamp-2">${a.goal}</p>
                            </div>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border-color);padding-top:12px;margin-top:8px;">
                            <div class="agent-stats" style="display:flex;gap:16px;font-size:0.75rem;color:var(--text-secondary);">
                                <span>ðŸ“‹ ${a.tasks_count} tasks</span>
                                <span>ðŸ”§ ${a.tools_count} tools</span>
                            </div>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                ${a.status === 'published' ? `<button onclick="event.stopPropagation();openAgent('${a.id}', 'published', 'conversational')" class="p-2 rounded-lg bg-purple-500 hover:bg-purple-600 text-white text-sm" title="Chat">ðŸ’¬</button>` : ''}
                                ${a.status === 'draft' ? `<button data-permission="agents:publish" onclick="event.stopPropagation();publishAgent('${a.id}')" class="p-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm" title="Publish">ðŸš€</button>` : ''}
                                <button data-permission="agents:edit" onclick="event.stopPropagation();editAgent('${a.id}')" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-sm" title="Edit">âœï¸</button>
                                ${a.is_owner ? `<button data-permission="agents:delete" onclick="event.stopPropagation();deleteAgent('${a.id}')" class="p-2 rounded-lg bg-red-500/20 hover:bg-red-500/40 text-red-400 text-sm" title="Delete">ðŸ—‘ï¸</button>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                conversationalGrid.innerHTML = `<div class="col-span-full text-center py-6 text-gray-500">
                    <p>No conversational agents yet</p>
                </div>`;
            }
        }

        async function openAgent(id, status, agentType = 'conversational'){
            try {
                // For process/workflow agents, open the process execution UI
                if (agentType === 'process' && status === 'published') {
                    openProcessExecution(id);
                    return;
                }
                
                if(status === 'published'){
                    // Open chat for published conversational agents
                    // Skip auto-load in navigate, we'll load manually
                    window._skipChatAgentLoad = true;
                    navigate('chat', true);
                    // Flag is cleared by navigate() after checking
                    
                    // Wait for agents to load before selecting
                    const agents = await loadChatAgents();
                    
                    // Set the agent value
                    const agentSelect = document.getElementById('chat-agent');
                    if (agentSelect) {
                        agentSelect.value = id;
                        // Verify the value was set
                        if (agentSelect.value !== id) {
                            // Agent not in accessible list - this can happen if user doesn't have chat access
                            // Try to add it manually or show error
                            const agentInList = agents && agents.find(a => a.id === id);
                            if (!agentInList) {
                                showToast('You do not have access to chat with this agent', 'error');
                                return;
                            }
                            // If agent is in list but value didn't set, try again
                            agentSelect.value = id;
                        }
                        // Trigger change and start chat
                        await onAgentChange();
                    } else {
                        showToast('Chat interface not ready. Please try again.', 'error');
                    }
                } else {
                    // Open edit for draft agents
                    editAgent(id);
                }
            } catch (err) {
                console.error('openAgent error:', err);
                showToast('Failed to open agent: ' + err.message, 'error');
            }
        }
        
        async function editAgent(id){
            // Fetch agent details with auth
            const r = await fetch(API+'/api/agents/'+id, {
                headers: getAuthHeaders()
            });
            const agent = await r.json();
            
            console.log('ðŸ“ Editing agent:', id);
            console.log('ðŸ“ Agent type:', agent.agent_type);
            console.log('ðŸ“ Full agent:', agent);
            
            // For process/workflow agents, open the visual process editor
            if (agent.agent_type === 'process') {
                console.log('ðŸ“ Opening Process Editor for workflow agent');
                openProcessEditor(agent);
                return;
            }
            
            console.log('ðŸ“ Opening Conversational Wizard for agent');
            
            // Fetch user's permissions for this agent
            let userPermissions = null;
            console.log('ðŸ”ðŸ”ðŸ” FETCHING USER PERMISSIONS ðŸ”ðŸ”ðŸ”');
            console.log('ðŸ” Agent ID:', id);
            console.log('ðŸ” Current User:', currentUser?.id, currentUser?.email);
            try {
                const permUrl = API+'/api/agents/'+id+'/my-permissions';
                console.log('ðŸ” Fetching permissions from:', permUrl);
                const permRes = await fetch(permUrl, {
                    headers: getAuthHeaders()
                });
                console.log('ðŸ” Permissions response status:', permRes.status);
                if (permRes.ok) {
                    userPermissions = await permRes.json();
                    console.log('ðŸ”ðŸ”ðŸ” USER PERMISSIONS RECEIVED ðŸ”ðŸ”ðŸ”');
                    console.log('ðŸ” Full permissions object:', JSON.stringify(userPermissions, null, 2));
                    console.log('ðŸ” is_owner:', userPermissions.is_owner);
                    console.log('ðŸ” permissions array:', userPermissions.permissions);
                    console.log('ðŸ” can_edit_model:', userPermissions.can_edit_model);
                    console.log('ðŸ” can_edit_guardrails:', userPermissions.can_edit_guardrails);
                    console.log('ðŸ” can_manage_tools:', userPermissions.can_manage_tools);
                    console.log('ðŸ” can_publish:', userPermissions.can_publish);
                } else if (permRes.status === 403) {
                    // User doesn't have any access - show read-only
                    console.warn('âš ï¸ No management access to this agent - read-only mode');
                    userPermissions = {
                        is_owner: false,
                        is_admin: false,
                        permissions: [],
                        can_edit_basic_info: false,
                        can_edit_personality: false,
                        can_edit_model: false,
                        can_edit_guardrails: false,
                        can_manage_tasks: false,
                        can_manage_tools: false,
                        can_manage_knowledge: false,
                        can_manage_access: false,
                        can_manage_task_permissions: false,
                        can_publish: false,
                        can_delete: false,
                        _read_only: true
                    };
                    showToast('You have read-only access to this agent', 'warning');
                } else {
                    console.warn('âš ï¸ Could not fetch permissions, response:', permRes.status);
                    // Still try to use agent owner/created_by to determine if owner
                    const currentUserId = currentUser?.id || '';
                    const isOwner = agent.owner_id === currentUserId || agent.created_by === currentUserId;
                    if (isOwner) {
                        userPermissions = {
                            is_owner: true,
                            permissions: ['full_admin'],
                            can_edit_basic_info: true,
                            can_edit_personality: true,
                            can_edit_model: true,
                            can_edit_guardrails: true,
                            can_manage_tasks: true,
                            can_manage_tools: true,
                            can_manage_knowledge: true,
                            can_manage_access: true,
                            can_manage_task_permissions: true,
                            can_publish: true,
                            can_delete: true
                        };
                    } else {
                        // Not owner and can't get permissions - read-only
                        userPermissions = {
                            is_owner: false,
                            permissions: [],
                            can_edit_basic_info: false,
                            can_edit_personality: false,
                            can_edit_model: false,
                            can_edit_guardrails: false,
                            can_manage_tasks: false,
                            can_manage_tools: false,
                            can_manage_knowledge: false,
                            can_manage_access: false,
                            can_manage_task_permissions: false,
                            can_publish: false,
                            can_delete: false,
                            _read_only: true
                        };
                    }
                }
            } catch (e) {
                console.error('âŒ Error fetching permissions:', e);
                // Check if owner from agent data
                const currentUserId = currentUser?.id || '';
                const isOwner = agent.owner_id === currentUserId || agent.created_by === currentUserId;
                userPermissions = isOwner 
                    ? { is_owner: true, permissions: ['full_admin'], can_edit_basic_info: true, can_edit_personality: true, can_edit_model: true, can_edit_guardrails: true, can_manage_tasks: true, can_manage_tools: true, can_manage_knowledge: true, can_manage_access: true, can_manage_task_permissions: true, can_publish: true, can_delete: true }
                    : { is_owner: false, permissions: [], can_edit_basic_info: false, can_edit_personality: false, can_edit_model: false, can_edit_guardrails: false, can_manage_tasks: false, can_manage_tools: false, can_manage_knowledge: false, can_manage_access: false, can_manage_task_permissions: false, can_publish: false, can_delete: false, _read_only: true };
            }
            
            // First, show the create page WITHOUT resetting
            // Hide all pages
            document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-create').classList.remove('hidden');
            
            // Update nav
            document.querySelectorAll('.sidebar-item, .mobile-nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-create')?.classList.add('active');
            
            // Process tasks - convert instruction objects to strings
            const tasks = (agent.tasks || []).map(task => ({
                name: task.name || '',
                description: task.description || '',
                instructions: (task.instructions || []).map(inst => 
                    typeof inst === 'string' ? inst : (inst.text || '')
                )
            }));
            
            // Store agent ID for update
            wizard.editId = id;
            wizard.id = id;  // Also store as id for access control functions
            wizard.owner_id = agent.owner_id || null;  // For ownership check
            wizard.created_by = agent.created_by || null;  // For ownership check
            wizard.userPermissions = userPermissions;  // Store user permissions
            wizard.originalStatus = agent.status || 'draft';  // Store original status for cancel
            wizard.name = agent.name || '';
            wizard.icon = agent.icon || '';
            wizard.goal = agent.goal || '';
            wizard.model = agent.model_id || '';
            wizard.modelReason = agent.model_reason || '';
            wizard.tasks = tasks;
            wizard.tool_ids = agent.tool_ids || [];
            wizard.generatedTools = [];
            wizard.guardrails = agent.guardrails || {};
            wizard.accessControl = agent.access_control || null;
            
            // Also load access control from API if available
            await loadAgentAccessControl(id);
            
            // Load agent admins (for delegation UI)
            await loadAgentAdmins(id);
            
            // Load personality from agent
            wizard.personality = agent.personality || null;
            wizard.personalityReason = agent.personality_reason || '';
            
            // Load tools into selectedDemoTools for UI display
            await loadAgentToolsToSelection(agent.tool_ids || [], agent.tools || []);
            
            // Set basic info in form
            document.getElementById('w-name').value = wizard.name;
            document.getElementById('w-icon').value = wizard.icon;
            document.getElementById('w-goal').value = wizard.goal;
            
            // Apply personality to sliders if exists
            if (wizard.personality) {
                const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
                traits.forEach(trait => {
                    const val = wizard.personality[trait];
                    if (val !== undefined) {
                        const slider = document.getElementById(`p-${trait}`);
                        const numInput = document.getElementById(`p-${trait}-num`);
                        if (slider) slider.value = val;
                        if (numInput) numInput.value = val;
                    }
                });
            }
            
            if(document.getElementById('w-model')) {
                document.getElementById('w-model').value = wizard.model;
            }
            
            // Update testAgent to point to existing agent
            testAgent = { id: id, convId: null };
            
            // Go to step 1 (Basics) to show the loaded data
            step = 1;
            updateStepsNew();
            
            // Render tasks
            renderTasks();
            
            // Load guardrails to form (for when user navigates to step 4)
            loadGuardrailsToForm();
            
            // Apply permission-based restrictions to UI
            applyPermissionRestrictions(userPermissions);
            
            console.log('Editing agent:', id, wizard, 'permissions:', userPermissions);
        }
        
        // Apply permission-based restrictions to UI elements
        function applyPermissionRestrictions(perms) {
            if (!perms) {
                console.log('ðŸ”’ðŸ”’ðŸ”’ applyPermissionRestrictions called with NULL perms - SKIPPING');
                return;
            }
            
            console.log('ðŸ”’ðŸ”’ðŸ”’ APPLYING PERMISSION RESTRICTIONS ðŸ”’ðŸ”’ðŸ”’');
            console.log('ðŸ”’ is_owner:', perms.is_owner);
            console.log('ðŸ”’ is_admin:', perms.is_admin);
            console.log('ðŸ”’ permissions:', perms.permissions);
            console.log('ðŸ”’ can_edit_basic_info:', perms.can_edit_basic_info);
            console.log('ðŸ”’ can_edit_personality:', perms.can_edit_personality);
            console.log('ðŸ”’ can_edit_model:', perms.can_edit_model);
            console.log('ðŸ”’ can_edit_guardrails:', perms.can_edit_guardrails);
            console.log('ðŸ”’ can_manage_tasks:', perms.can_manage_tasks);
            console.log('ðŸ”’ can_manage_tools:', perms.can_manage_tools);
            console.log('ðŸ”’ can_manage_knowledge:', perms.can_manage_knowledge);
            console.log('ðŸ”’ can_manage_access:', perms.can_manage_access);
            console.log('ðŸ”’ can_publish:', perms.can_publish);
            console.log('ðŸ”’ can_delete:', perms.can_delete);
            
            // Helper function to disable a section
            const disableSection = (selector, message = 'You do not have permission to edit this section') => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    // Add visual indicator
                    el.style.opacity = '0.5';
                    el.style.pointerEvents = 'none';
                    el.style.position = 'relative';
                    
                    // Disable all inputs within
                    el.querySelectorAll('input, textarea, select, button').forEach(input => {
                        input.disabled = true;
                    });
                });
            };
            
            // Helper to add "No Permission" overlay
            const addNoPermissionOverlay = (elementId, permName) => {
                const el = document.getElementById(elementId);
                if (!el) return;
                
                // Create overlay
                const overlay = document.createElement('div');
                overlay.className = 'no-permission-overlay';
                overlay.innerHTML = `
                    <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:100;border-radius:8px;">
                        <div style="text-align:center;color:#ff6b6b;">
                            <div style="font-size:2rem;">ðŸ”’</div>
                            <div style="font-size:0.9rem;margin-top:0.5rem;">No Permission</div>
                            <div style="font-size:0.75rem;color:#888;margin-top:0.25rem;">Requires: ${permName}</div>
                        </div>
                    </div>
                `;
                el.style.position = 'relative';
                el.appendChild(overlay);
                
                // Disable inputs
                el.querySelectorAll('input, textarea, select, button').forEach(input => {
                    input.disabled = true;
                });
            };
            
            // If owner or full_admin, no restrictions
            const hasFullAdmin = perms.permissions && perms.permissions.includes('full_admin');
            console.log('ðŸ”’ Checking if should skip restrictions:');
            console.log('ðŸ”’   perms.is_owner:', perms.is_owner);
            console.log('ðŸ”’   hasFullAdmin:', hasFullAdmin);
            
            if (perms.is_owner || hasFullAdmin) {
                console.log('âœ… Owner/Full Admin - SKIPPING restrictions (no restrictions applied)');
                return;
            }
            
            console.log('ðŸ”’ NOT owner/full_admin - APPLYING restrictions now...');
            
            // Apply restrictions based on specific permissions
            
            // Step 1: Basic Info (name, icon, goal)
            if (!perms.can_edit_basic_info) {
                console.log('ðŸ”’ Restricting: Basic Info (can_edit_basic_info=false)');
                const basicFields = ['w-name', 'w-icon', 'w-goal'];
                basicFields.forEach(fieldId => {
                    const el = document.getElementById(fieldId);
                    console.log('ðŸ”’   Field', fieldId, ':', el ? 'FOUND - disabling' : 'NOT FOUND');
                    if (el) {
                        el.disabled = true;
                        el.style.opacity = '0.6';
                        el.style.backgroundColor = 'rgba(255,0,0,0.1)';
                        el.title = 'No permission to edit (requires: edit_basic_info)';
                    }
                });
            } else {
                console.log('âœ… Basic Info: ALLOWED');
            }
            
            // Step 2: Personality sliders
            if (!perms.can_edit_personality) {
                console.log('ðŸ”’ Restricting: Personality (can_edit_personality=false)');
                const traits = ['creativity', 'length', 'formality', 'empathy', 'proactivity', 'confidence'];
                traits.forEach(trait => {
                    const slider = document.getElementById(`p-${trait}`);
                    const numInput = document.getElementById(`p-${trait}-num`);
                    console.log('ðŸ”’   Slider p-'+trait+':', slider ? 'FOUND' : 'NOT FOUND');
                    if (slider) { slider.disabled = true; slider.style.opacity = '0.6'; }
                    if (numInput) { numInput.disabled = true; numInput.style.opacity = '0.6'; }
                });
            } else {
                console.log('âœ… Personality: ALLOWED');
            }
            
            // Step 3: Tasks
            if (!perms.can_manage_tasks) {
                console.log('ðŸ”’ Restricting: Tasks (can_manage_tasks=false)');
                const taskContainer = document.getElementById('w-tasks');
                console.log('ðŸ”’   w-tasks:', taskContainer ? 'FOUND' : 'NOT FOUND');
                if (taskContainer) {
                    taskContainer.style.opacity = '0.6';
                    taskContainer.style.pointerEvents = 'none';
                }
                // Hide add task button
                const addTaskBtns = document.querySelectorAll('[onclick*="addTask"], [onclick*="addNewTask"]');
                console.log('ðŸ”’   Add task buttons found:', addTaskBtns.length);
                addTaskBtns.forEach(btn => {
                    btn.style.display = 'none';
                });
            } else {
                console.log('âœ… Tasks: ALLOWED');
            }
            
            // Step 3: Tools - disable tool-related elements but keep navigation working
            if (!perms.can_manage_tools) {
                console.log('ðŸ”’ Restricting: Tools (can_manage_tools=false)');
                const toolsStep = document.getElementById('wizard-step-3');
                console.log('ðŸ”’   wizard-step-3:', toolsStep ? 'FOUND' : 'NOT FOUND');
                if (toolsStep) {
                    // Disable tool-related elements but NOT navigation buttons
                    toolsStep.querySelectorAll('[onclick], button, .card').forEach(el => {
                        const onclick = el.getAttribute('onclick') || '';
                        // Skip navigation buttons (nextStep, prevStep, goStep, saveWizardProgress)
                        if (onclick.includes('nextStep') || onclick.includes('prevStep') || 
                            onclick.includes('goStep') || onclick.includes('saveWizardProgress')) {
                            return; // Don't disable navigation
                        }
                        el.style.pointerEvents = 'none';
                        el.style.opacity = '0.5';
                    });
                    // Add visual overlay
                    if (!toolsStep.querySelector('.permission-overlay')) {
                        const overlay = document.createElement('div');
                        overlay.className = 'permission-overlay';
                        overlay.innerHTML = `<div style="background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.3);border-radius:8px;padding:1rem;margin-bottom:1rem;text-align:center;"><span style="color:#ff6b6b;">ðŸ”’ You don't have permission to manage tools</span></div>`;
                        toolsStep.insertBefore(overlay, toolsStep.firstChild);
                    }
                }
                // Disable tool selection buttons throughout page
                document.querySelectorAll('.tool-select-btn, .demo-tool-card, [onclick*="showSelectToolModal"], [onclick*="showAddToolModal"]').forEach(el => {
                    el.style.pointerEvents = 'none';
                    el.style.opacity = '0.5';
                });
            } else {
                console.log('âœ… Tools: ALLOWED');
            }
            
            // Step 3: Knowledge Base
            if (!perms.can_manage_knowledge) {
                console.log('ðŸ”’ Restricting: Knowledge Base (can_manage_knowledge=false)');
                const kbSection = document.getElementById('wizard-kb-section');
                if (kbSection) {
                    kbSection.style.opacity = '0.6';
                    kbSection.style.pointerEvents = 'none';
                }
            } else {
                console.log('âœ… Knowledge Base: ALLOWED');
            }
            
            // Step 1: LLM Model (model selection is in step 1, right side)
            if (!perms.can_edit_model) {
                console.log('ðŸ”’ Restricting: LLM Model (can_edit_model=false)');
                // The model list is in #llm-models-list
                const modelList = document.getElementById('llm-models-list');
                console.log('ðŸ”’   llm-models-list:', modelList ? 'FOUND' : 'NOT FOUND');
                if (modelList) {
                    modelList.style.pointerEvents = 'none';
                    modelList.style.opacity = '0.5';
                    // Add notice above model list
                    const parent = modelList.parentElement;
                    if (parent && !parent.querySelector('.model-permission-notice')) {
                        const notice = document.createElement('div');
                        notice.className = 'model-permission-notice';
                        notice.innerHTML = `<div style="background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.3);border-radius:8px;padding:0.5rem;margin-bottom:0.5rem;text-align:center;font-size:0.75rem;"><span style="color:#ff6b6b;">ðŸ”’ No permission to change model</span></div>`;
                        parent.insertBefore(notice, modelList);
                    }
                }
                // Also disable all model options
                document.querySelectorAll('.model-option').forEach(el => {
                    el.style.pointerEvents = 'none';
                    el.style.opacity = '0.5';
                    el.onclick = null;
                });
            } else {
                console.log('âœ… LLM Model: ALLOWED');
            }
            
            // Step 5: Guardrails (wizard-step-5)
            if (!perms.can_edit_guardrails) {
                console.log('ðŸ”’ Restricting: Guardrails (can_edit_guardrails=false)');
                const guardrailStep = document.getElementById('wizard-step-5');
                console.log('ðŸ”’   wizard-step-5:', guardrailStep ? 'FOUND' : 'NOT FOUND');
                if (guardrailStep) {
                    // Disable guardrail inputs but keep navigation working
                    guardrailStep.querySelectorAll('input, button, label, .card').forEach(el => {
                        const onclick = el.getAttribute('onclick') || '';
                        // Skip navigation buttons
                        if (onclick.includes('nextStep') || onclick.includes('prevStep') || 
                            onclick.includes('goStep') || onclick.includes('saveWizardProgress')) {
                            return;
                        }
                        if (el.tagName === 'INPUT') {
                            el.disabled = true;
                        }
                        el.style.pointerEvents = 'none';
                        el.style.opacity = '0.5';
                    });
                    // Add visual overlay
                    if (!guardrailStep.querySelector('.permission-overlay')) {
                        const overlay = document.createElement('div');
                        overlay.className = 'permission-overlay';
                        overlay.innerHTML = `<div style="background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.3);border-radius:8px;padding:1rem;margin-bottom:1rem;text-align:center;"><span style="color:#ff6b6b;">ðŸ”’ You don't have permission to edit guardrails</span></div>`;
                        guardrailStep.insertBefore(overlay, guardrailStep.firstChild);
                    }
                }
            } else {
                console.log('âœ… Guardrails: ALLOWED');
            }
            
            // Step 4: Access Control (End-User Access) - wizard-step-4
            if (!perms.can_manage_access) {
                console.log('ðŸ”’ Restricting: Access Control (End-User)');
                const accessStep = document.getElementById('wizard-step-4');
                console.log('ðŸ”’   wizard-step-4:', accessStep ? 'FOUND' : 'NOT FOUND');
                if (accessStep) {
                    // Find the main access control section (Level 1)
                    const accessControlSection = document.getElementById('wizard-access-control-section');
                    if (accessControlSection) {
                        accessControlSection.querySelectorAll('input, button, [onclick]').forEach(el => {
                            const onclick = el.getAttribute('onclick') || '';
                            // Skip navigation buttons
                            if (onclick.includes('nextStep') || onclick.includes('prevStep') || 
                                onclick.includes('goStep') || onclick.includes('saveWizardProgress')) {
                                return;
                            }
                            if (el.tagName === 'INPUT') el.disabled = true;
                            el.style.pointerEvents = 'none';
                            el.style.opacity = '0.5';
                        });
                        // Add notice
                        if (!accessControlSection.querySelector('.permission-overlay')) {
                            const overlay = document.createElement('div');
                            overlay.className = 'permission-overlay';
                            overlay.innerHTML = `<div style="background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.3);border-radius:8px;padding:0.75rem;margin:0.5rem;text-align:center;"><span style="color:#ff6b6b;">ðŸ”’ No permission to manage end-user access</span></div>`;
                            accessControlSection.insertBefore(overlay, accessControlSection.firstChild);
                        }
                    }
                }
                // Disable access type cards anywhere
                document.querySelectorAll('.access-type-card').forEach(card => {
                    card.style.pointerEvents = 'none';
                    card.style.opacity = '0.5';
                });
            }
            
            // Step 5: Task Permissions
            if (!perms.can_manage_task_permissions) {
                console.log('ðŸ”’ Restricting: Task Permissions');
                const taskPermSection = document.getElementById('wizard-task-permissions-section');
                if (taskPermSection) {
                    taskPermSection.style.opacity = '0.6';
                    taskPermSection.style.pointerEvents = 'none';
                }
                // Disable task-level access toggles
                document.querySelectorAll('[data-task-permission]').forEach(el => {
                    el.style.pointerEvents = 'none';
                    el.style.opacity = '0.5';
                });
            }
            
            // Step 5: Delegation (Admin Management)
            if (!perms.is_owner) {
                console.log('ðŸ”’ Restricting: Delegation (only owner can delegate)');
                const delegateSection = document.getElementById('wizard-delegate-admin-section');
                if (delegateSection) {
                    delegateSection.style.opacity = '0.6';
                    delegateSection.style.pointerEvents = 'none';
                    // Add overlay message if not already added
                    if (!delegateSection.querySelector('.no-permission-overlay-msg')) {
                        const overlay = document.createElement('div');
                        overlay.className = 'no-permission-overlay-msg';
                        overlay.innerHTML = `
                            <div style="background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.3);border-radius:8px;padding:1rem;margin-bottom:1rem;text-align:center;">
                                <span style="color:#ff6b6b;">ðŸ”’ Only the agent owner can delegate admin access</span>
                            </div>
                        `;
                        delegateSection.insertBefore(overlay, delegateSection.firstChild);
                    }
                }
            }
            
            // Publish/Deploy button
            if (!perms.can_publish) {
                console.log('ðŸ”’ Restricting: Publish/Deploy');
                // Select all publish/deploy related buttons
                const publishBtns = document.querySelectorAll(
                    '[onclick*="publishAgent"], [onclick*="deployAgent"], .publish-btn, #btn-deploy'
                );
                publishBtns.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.pointerEvents = 'none';
                    btn.title = 'No permission to publish (requires: publish_agent)';
                });
                
                // Also disable the Save as Published option
                const savePublishBtns = document.querySelectorAll('button[onclick*="published"]');
                savePublishBtns.forEach(btn => {
                    if (btn.textContent?.toLowerCase().includes('publish')) {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        btn.style.pointerEvents = 'none';
                        btn.title = 'No permission to publish';
                    }
                });
            }
            
            // Delete button
            if (!perms.can_delete) {
                console.log('ðŸ”’ Restricting: Delete');
                const deleteBtns = document.querySelectorAll('[onclick*="deleteAgent"], .delete-btn');
                deleteBtns.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.title = 'No permission to delete';
                });
            }
            
            // Step 7: Test - Only allow if user has at least SOME edit permission
            // If user only has publish permission, they shouldn't be editing/testing
            const hasAnyEditPerm = perms.can_edit_basic_info || perms.can_edit_personality || 
                                   perms.can_edit_model || perms.can_edit_guardrails || 
                                   perms.can_manage_tasks || perms.can_manage_tools;
            if (!hasAnyEditPerm && !perms.is_owner) {
                console.log('ðŸ”’ Restricting: Test (no edit permissions)');
                const testStep = document.getElementById('wizard-step-7');
                if (testStep) {
                    testStep.querySelectorAll('input, button, textarea').forEach(el => {
                        const onclick = el.getAttribute('onclick') || '';
                        // Skip navigation buttons
                        if (onclick.includes('nextStep') || onclick.includes('prevStep') || 
                            onclick.includes('goStep') || onclick.includes('saveWizardProgress') ||
                            onclick.includes('saveAgent') || onclick.includes('deployAgent')) {
                            return;
                        }
                        el.disabled = true;
                        el.style.pointerEvents = 'none';
                        el.style.opacity = '0.5';
                    });
                    // Add notice
                    if (!testStep.querySelector('.permission-overlay')) {
                        const overlay = document.createElement('div');
                        overlay.className = 'permission-overlay';
                        overlay.innerHTML = `<div style="background:rgba(255,107,107,0.1);border:1px solid rgba(255,107,107,0.3);border-radius:8px;padding:1rem;margin-bottom:1rem;text-align:center;"><span style="color:#ff6b6b;">ðŸ”’ You don't have permission to test this agent (requires edit permissions)</span></div>`;
                        testStep.insertBefore(overlay, testStep.firstChild);
                    }
                }
            }
            
            // Show a banner indicating restricted access
            if (!perms.is_owner && perms.is_admin) {
                const wizardHeader = document.querySelector('.wizard-header, #page-create > div:first-child');
                if (wizardHeader && !document.getElementById('restricted-access-banner')) {
                    // Build list of granted permissions
                    const grantedPerms = [];
                    if (perms.can_edit_basic_info) grantedPerms.push('ðŸ“ Basic Info');
                    if (perms.can_edit_personality) grantedPerms.push('ðŸŽ­ Personality');
                    if (perms.can_edit_model) grantedPerms.push('ðŸ¤– Model');
                    if (perms.can_edit_guardrails) grantedPerms.push('ðŸ›¡ï¸ Guardrails');
                    if (perms.can_manage_tasks) grantedPerms.push('ðŸ“‹ Tasks');
                    if (perms.can_manage_tools) grantedPerms.push('ðŸ”§ Tools');
                    if (perms.can_manage_knowledge) grantedPerms.push('ðŸ“š Knowledge');
                    if (perms.can_manage_access) grantedPerms.push('ðŸ” Access Control');
                    if (perms.can_publish) grantedPerms.push('ðŸš€ Publish');
                    if (perms.can_delete) grantedPerms.push('ðŸ—‘ï¸ Delete');
                    
                    const banner = document.createElement('div');
                    banner.id = 'restricted-access-banner';
                    banner.innerHTML = `
                        <div style="background:linear-gradient(135deg, rgba(255,193,7,0.15), rgba(255,152,0,0.15));border:1px solid rgba(255,193,7,0.4);border-radius:8px;padding:0.75rem 1rem;margin-bottom:1rem;">
                            <div style="display:flex;align-items:center;gap:0.75rem;">
                                <span style="font-size:1.25rem;">ðŸ”</span>
                                <div style="flex:1;">
                                    <div style="color:#ffc107;font-weight:600;">Delegated Admin Access</div>
                                    <div style="color:#888;font-size:0.85rem;">You can only edit sections you have permission for.</div>
                                </div>
                            </div>
                            ${grantedPerms.length > 0 ? `
                            <div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid rgba(255,193,7,0.2);">
                                <div style="font-size:0.75rem;color:#888;margin-bottom:0.25rem;">Your permissions:</div>
                                <div style="display:flex;flex-wrap:wrap;gap:0.25rem;">
                                    ${grantedPerms.map(p => `<span style="font-size:0.7rem;padding:2px 6px;background:rgba(255,193,7,0.2);border-radius:4px;color:#ffc107;">${p}</span>`).join('')}
                                </div>
                            </div>
                            ` : `
                            <div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid rgba(255,193,7,0.2);">
                                <div style="font-size:0.85rem;color:#ff6b6b;">âš ï¸ You have no edit permissions - read-only access</div>
                            </div>
                            `}
                        </div>
                    `;
                    wizardHeader.parentNode.insertBefore(banner, wizardHeader);
                }
            } else if (perms._read_only) {
                // Read-only mode banner
                const wizardHeader = document.querySelector('.wizard-header, #page-create > div:first-child');
                if (wizardHeader && !document.getElementById('restricted-access-banner')) {
                    const banner = document.createElement('div');
                    banner.id = 'restricted-access-banner';
                    banner.innerHTML = `
                        <div style="background:linear-gradient(135deg, rgba(255,107,107,0.15), rgba(255,87,87,0.15));border:1px solid rgba(255,107,107,0.4);border-radius:8px;padding:0.75rem 1rem;margin-bottom:1rem;display:flex;align-items:center;gap:0.75rem;">
                            <span style="font-size:1.25rem;">ðŸ”’</span>
                            <div>
                                <div style="color:#ff6b6b;font-weight:600;">Read-Only Access</div>
                                <div style="color:#888;font-size:0.85rem;">You can view this agent but cannot make changes.</div>
                            </div>
                        </div>
                    `;
                    wizardHeader.parentNode.insertBefore(banner, wizardHeader);
                    
                    // Disable ALL inputs in read-only mode
                    document.querySelectorAll('#page-create input, #page-create textarea, #page-create select, #page-create button').forEach(el => {
                        if (!el.classList.contains('nav-btn')) {
                            el.disabled = true;
                            el.style.opacity = '0.5';
                        }
                    });
                }
            }
            
            console.log('ðŸ”’ðŸ”’ðŸ”’ PERMISSION RESTRICTIONS APPLIED SUCCESSFULLY ðŸ”’ðŸ”’ðŸ”’');
        }
        
        // Load agent's tools into selectedDemoTools for display
        async function loadAgentToolsToSelection(toolIds, toolsData) {
            // Reset selectedDemoTools
            selectedDemoTools = {
                apis: [],
                knowledge_bases: [],
                emails: [],
                webhooks: [],
                slacks: [],
                calendars: [],
                databases: [],
                websearches: [],
                websites: []
            };
            
            // If we have tools data from the agent response, use it
            if (toolsData && toolsData.length > 0) {
                toolsData.forEach(tool => {
                    addToolToSelection(tool);
                });
            } else if (toolIds && toolIds.length > 0) {
                // Otherwise, fetch tools from API
                try {
                    const response = await fetch(API + '/api/tools');
                    const data = await response.json();
                    const allTools = data.tools || [];
                    
                    toolIds.forEach(tid => {
                        // Handle prefixed IDs (api:xxx, kb:xxx)
                        const cleanId = tid.replace(/^(api:|kb:)/, '');
                        const tool = allTools.find(t => t.id === tid || t.id === cleanId);
                        if (tool) {
                            addToolToSelection(tool);
                        }
                    });
                } catch (e) {
                    console.error('Failed to load tools for agent:', e);
                }
            }
            
            // Update UI
            updateSelectedToolsList();
            console.log('âœ… Loaded tools to selection:', selectedDemoTools);
        }
        
        // Add a tool to the correct category in selectedDemoTools
        function addToolToSelection(tool) {
            const typeToArray = {
                'api': 'apis',
                'knowledge': 'knowledge_bases',
                'document': 'knowledge_bases',
                'email': 'emails',
                'webhook': 'webhooks',
                'slack': 'slacks',
                'calendar': 'calendars',
                'database': 'databases',
                'websearch': 'websearches',
                'website': 'websites'
            };
            
            const arrayKey = typeToArray[tool.type] || 'apis';
            if (selectedDemoTools[arrayKey] && !selectedDemoTools[arrayKey].some(t => t.id === tool.id)) {
                selectedDemoTools[arrayKey].push(tool);
            }
        }
        
        async function deleteAgent(id){
            if(!confirm('Are you sure you want to delete this agent?')) return;
            
            try {
                console.log('ðŸ—‘ï¸ [DELETE] Attempting to delete agent:', id);
                const response = await fetch(API+'/api/agents/'+id, { 
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                console.log('ðŸ—‘ï¸ [DELETE] Response status:', response.status);
                
                if (!response.ok) {
                    let errorMsg = 'Failed to delete agent';
                    try {
                        const error = await response.json();
                        errorMsg = error.detail || errorMsg;
                    } catch(jsonErr) {
                        errorMsg = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    console.error('ðŸ—‘ï¸ [DELETE] Error:', errorMsg);
                    alert('Failed to delete agent: ' + errorMsg);
                    return;
                }
                
                showToast('Agent deleted successfully', 'success');
                loadAgents();
            } catch(e) {
                console.error('ðŸ—‘ï¸ [DELETE] Exception:', e);
                alert('Failed to delete agent: ' + e.message);
            }
        }
        
        async function publishAgent(id){
            try {
                const response = await fetch(API+'/api/agents/'+id, {
                    method: 'PUT',
                    headers: {...getAuthHeaders(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: 'published' })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to publish');
                }
                
                showToast('Agent published successfully!', 'success');
                loadAgents();
                setAgentTab('published');
            } catch(e) {
                console.error('Publish error:', e);
                showToast('Failed to publish agent: ' + e.message, 'error');
            }
        }

        function resetWizard(){
            step=1;
            wizard={name:'',icon:'',goal:'',personality:null,personalityReason:'',tasks:[],tool_ids:[],model:'',modelReason:'',editId:null};
            
            // Reset selectedDemoTools
            selectedDemoTools = {
                apis: [],
                knowledge_bases: [],
                emails: [],
                webhooks: [],
                slacks: [],
                calendars: [],
                databases: [],
                websearches: [],
                websites: []
            };
            tempToolSelection = {
                apis: [],
                knowledge_bases: [],
                emails: [],
                webhooks: [],
                slacks: [],
                calendars: [],
                databases: [],
                websearches: [],
                websites: []
            };
            
            updateSteps();
            document.getElementById('w-name').value='';
            document.getElementById('w-icon').value='';
            document.getElementById('w-goal').value='';
            
            // Reset personality sliders
            resetPersonalityDefaults();
            
            document.getElementById('w-tasks').innerHTML=`
                <div class="text-center py-8 text-gray-500">
                    <span class="text-4xl block mb-2">ðŸ“</span>
                    <p>No tasks yet. Click "+ Add Task" to create one.</p>
                    <p class="text-xs mt-2">Each task should have clear instructions for the LLM.</p>
                </div>
            `;
            document.getElementById('test-messages').innerHTML='';
            testAgent=null;
            
            // Update tools list display
            updateSelectedToolsList();
        }

        // Old wizard functions removed - using new 7-step wizard functions instead
        // updateStepsNew, nextStep, prevStep, collectTasksNew, loadWizardToolsNew, collectToolsNew, showPreviewNew

        // Task Modal State
        let taskModalEditIndex = null; // null = new task, number = editing existing task
        
        function addTask(){
            // Open modal for new task
            openTaskModal();
        }
        
        function openTaskModal(editIndex = null) {
            const modal = document.getElementById('modal-task');
            if (!modal) return;
            ensureModalInBody('modal-task');
            taskModalEditIndex = editIndex;
            const titleEl = document.getElementById('task-modal-title');
            const nameEl = document.getElementById('task-modal-name');
            const descEl = document.getElementById('task-modal-desc');
            const instructionsEl = document.getElementById('task-modal-instructions');
            const noInstructionsEl = document.getElementById('task-modal-no-instructions');
            
            // Reset modal
            instructionsEl.innerHTML = '';
            
            if (editIndex !== null && wizard.tasks && wizard.tasks[editIndex]) {
                // Edit mode
                const task = wizard.tasks[editIndex];
                titleEl.textContent = 'Edit Task';
                nameEl.value = task.name || '';
                descEl.value = task.description || '';
                
                // Load instructions
                if (task.instructions && task.instructions.length > 0) {
                    noInstructionsEl.classList.add('hidden');
                    task.instructions.forEach((inst, i) => {
                        addTaskModalInstructionWithValue(inst, i + 1);
                    });
                } else {
                    noInstructionsEl.classList.remove('hidden');
                }
            } else {
                // New task mode
                titleEl.textContent = 'Add New Task';
                nameEl.value = '';
                descEl.value = '';
                noInstructionsEl.classList.remove('hidden');
            }
            
            modal.classList.remove('hidden');
            nameEl.focus();
        }
        
        function closeTaskModal() {
            document.getElementById('modal-task').classList.add('hidden');
            taskModalEditIndex = null;
        }
        
        function addTaskModalInstruction() {
            const container = document.getElementById('task-modal-instructions');
            const noInstructionsEl = document.getElementById('task-modal-no-instructions');
            noInstructionsEl.classList.add('hidden');
            
            const stepNum = container.children.length + 1;
            addTaskModalInstructionWithValue('', stepNum);
        }
        
        function addTaskModalInstructionWithValue(value, stepNum) {
            const container = document.getElementById('task-modal-instructions');
            const instId = Date.now() + Math.random();
            container.insertAdjacentHTML('beforeend', `
                <div class="flex gap-2 items-center bg-gray-900 rounded-lg p-3 group" data-inst-id="${instId}">
                    <span class="text-blue-400 text-sm font-bold w-6">${stepNum}.</span>
                    <input type="text" 
                           class="task-modal-inst-text flex-1 bg-transparent border-none text-white placeholder-gray-500 focus:outline-none"
                           value="${escHtml(value)}"
                           placeholder="e.g., Greet the user and ask how you can help">
                    <button onclick="removeTaskModalInstruction(this)" 
                            class="text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition p-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `);
        }
        
        function removeTaskModalInstruction(btn) {
            const instDiv = btn.closest('[data-inst-id]');
            const container = document.getElementById('task-modal-instructions');
            instDiv.remove();
            
            // Renumber remaining instructions
            const remaining = container.querySelectorAll('[data-inst-id]');
            remaining.forEach((el, i) => {
                el.querySelector('.text-blue-400').textContent = (i + 1) + '.';
            });
            
            // Show empty message if no instructions
            if (remaining.length === 0) {
                document.getElementById('task-modal-no-instructions').classList.remove('hidden');
            }
        }
        
        function saveTaskModal() {
            const name = document.getElementById('task-modal-name').value.trim();
            const desc = document.getElementById('task-modal-desc').value.trim();
            const instructionInputs = document.querySelectorAll('#task-modal-instructions .task-modal-inst-text');
            
            if (!name) {
                document.getElementById('task-modal-name').focus();
                document.getElementById('task-modal-name').classList.add('border-red-500');
                setTimeout(() => document.getElementById('task-modal-name').classList.remove('border-red-500'), 2000);
                return;
            }
            
            const instructions = [];
            instructionInputs.forEach(input => {
                const val = input.value.trim();
                if (val) instructions.push(val);
            });
            
            const taskData = {
                id: taskModalEditIndex !== null ? wizard.tasks[taskModalEditIndex].id : `task-${Date.now()}`,
                name: name,
                description: desc,
                instructions: instructions
            };
            
            if (!wizard.tasks) wizard.tasks = [];
            
            if (taskModalEditIndex !== null) {
                // Update existing task
                wizard.tasks[taskModalEditIndex] = taskData;
            } else {
                // Add new task
                wizard.tasks.push(taskData);
            }
            
            closeTaskModal();
            renderTasks();
            showToast(taskModalEditIndex !== null ? 'Task updated' : 'Task added', 'success');
        }
        
        function editTask(idx) {
            openTaskModal(idx);
        }

        function addInst(tid){
            const container = document.querySelector('#task-'+tid+' .insts');
            const emptyMsg = document.querySelector('#task-'+tid+' .inst-empty');
            if(emptyMsg) emptyMsg.style.display = 'none';
            
            const stepNum = container.children.length + 1;
            container.insertAdjacentHTML('beforeend',`
                <div class="flex gap-2 items-start bg-gray-900/50 rounded p-2" id="inst-${Date.now()}">
                    <span class="text-purple-400 text-xs font-bold mt-1">${stepNum}.</span>
                    <input type="text" class="inst-text input-field flex-1 rounded px-2 py-1 text-sm" placeholder="e.g., First, greet the user politely">
                    <button onclick="removeInst(this)" class="text-gray-500 hover:text-red-400 text-sm">âœ•</button>
                </div>
            `);
        }
        
        function removeInst(btn){
            const instDiv = btn.parentElement;
            const container = instDiv.parentElement;
            const taskDiv = container.closest('[id^=task-]');
            instDiv.remove();
            
            // Update step numbers
            container.querySelectorAll('[id^=inst-]').forEach((inst, i) => {
                inst.querySelector('span').textContent = (i+1) + '.';
            });
            
            // Show empty message if no instructions
            if(container.children.length === 0){
                const emptyMsg = taskDiv.querySelector('.inst-empty');
                if(emptyMsg) emptyMsg.style.display = 'block';
            }
        }

        // Old collectTasks, loadWizardTools, collectTools, showReview removed
        // Using new functions: collectTasksNew, loadWizardToolsNew, collectToolsNew, showPreviewNew

        async function sendTest(){
            const inp=document.getElementById('test-input');
            const m=inp.value.trim();
            if(!m && testAttachments.length === 0)return;
            inp.value='';
            
            // Get user's timezone
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            // Show message with attachments
            let displayMsg = m;
            if(testAttachments.length > 0){
                displayMsg += '\n\nðŸ“Ž Attachments: ' + testAttachments.map(f => f.name).join(', ');
            }
            addTestMsg('user', displayMsg);
            
            // Use existing agent ID if available (from auto-save or previous test)
            const existingAgentId = testAgent?.id || wizard.editId;
            
            if(!existingAgentId){
                // Create new agent only if we don't have one
                console.log('ðŸ”§ Creating new test agent...');
                const r=await fetch(API+'/api/agents',{
                    method:'POST',
                    headers: {...getAuthHeaders(), 'Content-Type':'application/json'},
                    body:JSON.stringify({name:wizard.name || 'Untitled Agent',goal:wizard.goal,personality:wizard.personality || {},tasks:wizard.tasks || [],tool_ids:wizard.tool_ids || [],model_id:wizard.model || 'gpt-4o',status:'draft'})
                });
                const d=await r.json();
                const newAgentId = d.agent_id || d.agent?.id;
                testAgent={id: newAgentId};
                wizard.editId = newAgentId; // Sync with wizard
                console.log('âœ… Created test agent:', newAgentId);
            } else if(!testAgent) {
                // Use existing agent from wizard
                testAgent = {id: existingAgentId};
                console.log('ðŸ“Œ Using existing agent for test:', existingAgentId);
            }
            try{
                if(testAttachments.length > 0){
                    // Send with FormData for file upload (non-streaming)
                    const formData = new FormData();
                    formData.append('message', m);
                    formData.append('timezone', userTimezone);
                    if(testAgent.convId) formData.append('conversation_id', testAgent.convId);
                    testAttachments.forEach(f => formData.append('files', f));
                    
                    const response = await fetch(API+'/api/agents/'+testAgent.id+'/test-chat-with-files', {
                        method:'POST', 
                        headers: {...getAuthHeaders()},
                        body: formData
                    });
                    const d=await response.json();
                    testAgent.convId=d.conversation_id;
                    addTestMsg('assistant',d.response,d.sources);
                } else {
                    // Use streaming for better UX
                    await sendTestMsgStreaming(testAgent.id, m, userTimezone);
                }
                // Clear attachments after send
                testAttachments = [];
                renderTestAttachments();
            }catch(e){addTestMsg('error','Error: '+e.message);}
        }

        function addTestMsg(role,content,sources=[]){
            const c=document.getElementById('test-messages');
            const d=document.createElement('div');
            d.className='animate-fade-in';
            if(role==='user')d.innerHTML=`<div class="flex justify-end"><div class="bg-blue-600 text-white rounded-2xl rounded-tr-sm px-4 py-2.5 max-w-[85%] text-sm shadow-md">${esc(content)}</div></div>`;
            else if(role==='assistant')d.innerHTML=`<div class="flex"><div class="bg-gray-700 text-white rounded-2xl rounded-tl-sm px-3 py-2 max-w-[85%] chat-content text-sm">${fmt(content)}</div></div>`;
            else if(role==='system')d.innerHTML=`<div class="text-center text-xs py-1 text-gray-500">${content}</div>`;
            else if(role==='thinking')d.innerHTML=`<div class="flex"><div class="bg-gray-600 text-gray-300 rounded-2xl rounded-tl-sm px-3 py-2 max-w-[85%] text-sm italic"><span class="inline-block w-2 h-2 bg-purple-400 rounded-full animate-pulse mr-2"></span>${esc(content)}</div></div>`;
            else d.innerHTML=`<div class="text-center text-red-400 text-sm">${content}</div>`;
            c.appendChild(d);
            c.scrollTop=c.scrollHeight;
            return d;
        }
        
        // Streaming test chat with real-time thinking
        async function sendTestMsgStreaming(agentId, message, timezone) {
            const c = document.getElementById('test-messages');
            
            // Add thinking placeholder
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = 'test-thinking-container';
            thinkingDiv.className = 'animate-fade-in';
            thinkingDiv.innerHTML = `
                <div class="flex">
                    <div class="bg-gray-600 text-gray-300 rounded-2xl rounded-tl-sm px-3 py-2 max-w-[85%] text-sm italic">
                        <span class="inline-block w-2 h-2 bg-purple-400 rounded-full animate-pulse mr-2"></span>
                        <span id="test-thinking-text">...</span>
                    </div>
                </div>
            `;
            c.appendChild(thinkingDiv);
            c.scrollTop = c.scrollHeight;
            
            let fullContent = '';
            let sources = [];
            let buffer = '';
            
            try {
                const response = await fetch(API + '/api/agents/' + agentId + '/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: testAgent.convId,
                        timezone: timezone
                    })
                });
                
                if (!response.ok) throw new Error('HTTP ' + response.status);
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6).trim());
                                
                                switch (data.type) {
                                    case 'thinking':
                                    case 'tool_call':
                                    case 'tool_result':
                                        const textEl = document.getElementById('test-thinking-text');
                                        if (textEl) textEl.textContent = data.content;
                                        break;
                                    case 'conversation_id':
                                        testAgent.convId = data.content;
                                        break;
                                    case 'content':
                                        fullContent += data.content;
                                        break;
                                    case 'sources':
                                        sources = data.content || [];
                                        break;
                                    case 'done':
                                        // Remove thinking and show response
                                        const container = document.getElementById('test-thinking-container');
                                        if (container) container.remove();
                                        break;
                                    case 'error':
                                        const errContainer = document.getElementById('test-thinking-container');
                                        if (errContainer) errContainer.remove();
                                        addTestMsg('error', data.content);
                                        return;
                                }
                            } catch (e) { /* skip */ }
                        }
                    }
                }
                
                // Remove thinking container
                const container = document.getElementById('test-thinking-container');
                if (container) container.remove();
                
                // Add final response
                if (fullContent) {
                    addTestMsg('assistant', fullContent, sources);
                }
                
            } catch (e) {
                console.error('Test streaming error:', e);
                const container = document.getElementById('test-thinking-container');
                if (container) container.remove();
                addTestMsg('error', 'Error: ' + e.message);
            }
        }

        async function saveAgent(status){
            // Collect current wizard data
            if(typeof collectTasksNew === 'function') collectTasksNew();
            else if(typeof collectTasks === 'function') collectTasks();
            
            if(typeof collectToolsNew === 'function') collectToolsNew();
            else if(typeof collectTools === 'function') collectTools();
            
            if(typeof collectGuardrails === 'function') collectGuardrails();
            
            // Collect access control settings
            if(typeof collectWizardAccessControl === 'function') collectWizardAccessControl();
            
            // Get user permissions
            const perms = wizard.userPermissions || {};
            const isOwner = perms.is_owner;
            const hasFullAdmin = perms.permissions?.includes('full_admin');
            const agentId = testAgent?.id || wizard.editId;
            const hasValidId = agentId && agentId !== 'undefined' && agentId.length > 0;
            
            // For NEW agents (no ID), owner can save everything
            // For EXISTING agents, only save fields user has permission to modify
            let agentData;
            
            if (!hasValidId) {
                // New agent - need personality
                if (!wizard.personality) {
                    alert('Agent personality not configured. Please generate configuration first.');
                    return;
                }
                // New agent = full access
                agentData = {
                    name: wizard.name,
                    icon: wizard.icon,
                    goal: wizard.goal,
                    personality: wizard.personality,
                    personality_reason: wizard.personalityReason,
                    guardrails: wizard.guardrails || {},
                    tasks: wizard.tasks || [],
                    tool_ids: wizard.tool_ids || [],
                    model_id: wizard.model,
                    model_reason: wizard.modelReason,
                    status: status,
                    access_control: wizard.accessControl || null
                };
            } else {
                // Existing agent - build data based on permissions
                agentData = { status: status };  // Always include status
                
                if (isOwner || hasFullAdmin || perms.can_edit_basic_info) {
                    agentData.name = wizard.name;
                    agentData.icon = wizard.icon;
                    agentData.goal = wizard.goal;
                }
                if (isOwner || hasFullAdmin || perms.can_edit_personality) {
                    agentData.personality = wizard.personality;
                    agentData.personality_reason = wizard.personalityReason;
                }
                if (isOwner || hasFullAdmin || perms.can_edit_guardrails) {
                    agentData.guardrails = wizard.guardrails || {};
                }
                if (isOwner || hasFullAdmin || perms.can_manage_tasks) {
                    agentData.tasks = wizard.tasks || [];
                }
                if (isOwner || hasFullAdmin || perms.can_manage_tools) {
                    agentData.tool_ids = wizard.tool_ids || [];
                }
                if (isOwner || hasFullAdmin || perms.can_edit_model) {
                    agentData.model_id = wizard.model;
                    agentData.model_reason = wizard.modelReason;
                }
            }
            
            console.log('Saving agent with permission-filtered data:', agentData);
            console.log('ðŸ” User permissions:', perms);
            
            try {
                let response;
                
                if(hasValidId){
                    // Update existing agent
                    console.log('Updating agent:', agentId);
                    response = await fetch(API+'/api/agents/'+agentId, {
                        method: 'PUT',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(agentData)
                    });
                } else {
                    // Create new agent
                    console.log('Creating new agent');
                    response = await fetch(API+'/api/agents', {
                        method: 'POST',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(agentData)
                    });
                }
                
                if(response.ok) {
                    const savedAgent = await response.json();
                    const savedAgentId = savedAgent.id || agentId;
                    
                    // Save access control to API
                    if (wizard.accessControl && savedAgentId) {
                        await saveAgentAccessControl(savedAgentId);
                    }
                    
                    alert(status === 'published' ? 'ðŸš€ Agent Published!' : 'ðŸ’¾ Saved as Draft!');
                    wizard.editId = null;
                    testAgent = null;
                    navigate('agents');
                    setAgentTab(status);
                } else {
                    const err = await response.json();
                    alert('Error: ' + (err.detail || 'Failed to save agent'));
                }
            } catch(e) {
                console.error('Save error:', e);
                alert('Error saving agent: ' + e.message);
            }
        }

        async function cleanupDuplicateTools() {
            if(!confirm('This will remove duplicate tools (keeping only the first of each name). Continue?')) return;
            
            try {
                console.log('Calling cleanup endpoint...');
                const r = await fetch(API + '/api/tools/cleanup-duplicates', { method: 'POST' });
                console.log('Response status:', r.status);
                
                if(!r.ok) {
                    const errorText = await r.text();
                    console.error('Cleanup error:', errorText);
                    alert('Error: ' + errorText);
                    return;
                }
                
                const data = await r.json();
                console.log('Cleanup result:', data);
                
                if(data.status === 'success') {
                    if(data.duplicates_removed > 0) {
                        alert(`âœ… Removed ${data.duplicates_removed} duplicate tools.\n\nRemaining tools: ${data.remaining_tools}`);
                    } else {
                        alert('âœ… No duplicates found. All tools have unique names.');
                    }
                    loadTools(); // Refresh
                } else {
                    alert('Error: ' + (data.error || 'Failed to cleanup'));
                }
            } catch(e) {
                console.error('Cleanup exception:', e);
                alert('Failed to cleanup: ' + e.message);
            }
        }
        
        async function deleteAllTools() {
            if(!confirm('âš ï¸ WARNING: This will DELETE ALL TOOLS permanently!\n\nAre you sure?')) return;
            if(!confirm('This action cannot be undone. Type DELETE to confirm.')) return;
            
            try {
                const r = await fetch(API + '/api/tools/all', { method: 'DELETE' });
                const data = await r.json();
                
                if(data.status === 'success') {
                    alert(`âœ… Deleted ${data.deleted_count} tools.`);
                    loadTools();
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete'));
                }
            } catch(e) {
                alert('Failed to delete: ' + e.message);
            }
        }

        async function loadTools(){
            const r=await fetch(API+'/api/tools', { headers: getAuthHeaders() });
            const d=await r.json();
            allTools=d.tools;
            const g=document.getElementById('tools-grid');
            const icons={document:'ðŸ“„',website:'ðŸŒ',api:'ðŸ”Œ',knowledge:'ðŸ§ '};
            if(!d.tools.length){
                g.innerHTML=`<div class="col-span-full text-center py-10 md:py-20 text-gray-500">
                    <span class="text-4xl md:text-6xl mb-4 block">ðŸ”§</span>
                    <p class="mb-4">No tools yet</p>
                    <button data-permission="tools:create" onclick="showToolModal()" class="btn-primary px-4 py-2 rounded-lg">Create Tool</button>
                </div>`;
                return;
            }
            g.innerHTML=d.tools.map(t=>{
                const hasMockResponse = t.config?.mock_response;
                const mockLabel = hasMockResponse ? '<span class="tool-mock-badge" title="Has mock response for testing">Mock</span>' : '';
                // Access control badges
                const accessIcon = t.access_type === 'public' ? 'ðŸŒ' : t.access_type === 'authenticated' ? 'ðŸ”‘' : t.access_type === 'specific_users' ? 'ðŸ‘¥' : 'ðŸ‘¤';
                const ownerBadge = t.is_owner ? '<span class="text-xs px-1.5 py-0.5 rounded bg-yellow-500/20 text-yellow-400" title="You own this tool">Owner</span>' : '';
                // Check permissions for buttons (based on owner-granted permissions)
                const canEdit = t.can_edit || t.is_owner;
                const canDelete = t.can_delete || t.is_owner;
                return `
                <div class="card tool-card rounded-xl p-4 hover:border-purple-500 transition" 
                     style="min-width:0;overflow:visible;"
                     data-tool-id="${t.id}"
                     data-tool-name="${escHtml(t.name)}">
                    <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;" class="cursor-pointer" onclick="viewTool('${t.id}')">
                        <span style="font-size:1.75rem;flex-shrink:0;">${icons[t.type]||'ðŸ”§'}</span>
                        <div style="flex:1;min-width:0;overflow:hidden;width:100%;">
                            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                                <h3 class="tool-title" style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0;">${escHtml(t.name)}</h3>
                                <span class="tool-type-badge">${t.type.toUpperCase()}</span>
                                ${ownerBadge}
                            </div>
                            <p class="tool-desc" style="font-size:0.875rem;margin-top:4px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;word-break:break-word;">${escHtml(t.description||'No description')}</p>
                        </div>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border-color);padding-top:12px;margin-top:8px;">
                        <div class="tool-stats" style="display:flex;gap:8px;font-size:0.75rem;color:var(--text-muted);align-items:center;">
                            <span title="Access: ${t.access_type || 'owner_only'}">${accessIcon}</span>
                            <span>ðŸ”§ ${t.type}</span>${mockLabel}
                        </div>
                        <div style="display:flex;gap:6px;">
                            ${canEdit ? `<button onclick="event.stopPropagation();editTool('${t.id}')" class="tool-btn edit" title="Edit">âœï¸</button>` : ''}
                            ${canDelete ? `<button onclick="event.stopPropagation();delToolFromCard('${t.id}', '${escHtml(t.name).replace(/'/g, "\\'")}')" class="tool-btn delete" title="Delete">ðŸ—‘ï¸</button>` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');

        }
        async function viewTool(id){
            const r=await fetch(API+'/api/tools/'+id);
            const t=await r.json();
            const icons={document:'ðŸ“„',website:'ðŸŒ',api:'ðŸ”Œ',knowledge:'ðŸ“š',email:'ðŸ“§',webhook:'ðŸ”—',websearch:'ðŸ”',slack:'ðŸ’¬',calendar:'ðŸ“…',database:'ðŸ—„ï¸'};
            
            let h=`
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
                    <div class="flex items-center gap-4 flex-1 min-w-0">
                        <span class="text-3xl md:text-4xl">${icons[t.type]||'ðŸ”§'}</span>
                        <div class="min-w-0">
                            <h2 class="text-lg md:text-xl font-bold truncate">${t.name}</h2>
                            <p class="text-gray-400 text-sm truncate">${t.type.toUpperCase()} - ${t.description||'No description'}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="navigate('tools')" class="btn-secondary px-4 py-2 rounded-lg text-sm">â† Back</button>
                        <button data-permission="tools:delete" onclick="delTool('${t.id}')" class="btn-danger px-4 py-2 rounded-lg text-sm">ðŸ—‘ï¸ Delete</button>
                    </div>
                </div>
            `;
            
            // ========== KNOWLEDGE BASE / DOCUMENT TYPE ==========
            if(t.type==='document' || t.type==='knowledge'){
                // Check if this is a Demo Kit knowledge base with embedded content
                const isDemoKb = t.config?.source === 'demo_kit';
                const demoContent = t.config?.content || '';
                const demoSections = t.config?.sections || [];
                
                h+=`<div class="card rounded-xl p-4 md:p-5 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold">ðŸ“š Knowledge Base ${isDemoKb ? '<span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-1 rounded ml-2">From Demo Lab</span>' : ''}</h3>
                        <span class="text-sm text-gray-400">${t.documents?.length || 0} document(s)</span>
                    </div>
                    
                    ${isDemoKb && demoSections.length > 0 ? `
                    <!-- Demo KB Content -->
                    <div class="mb-4 p-4 bg-gray-800/50 rounded-lg border border-purple-500/20">
                        <h4 class="text-sm font-medium text-purple-300 mb-3">ðŸ“– Embedded Content (${demoSections.length} sections)</h4>
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            ${demoSections.map((s, i) => `
                                <div class="bg-gray-800 rounded p-3">
                                    <h5 class="text-sm font-medium text-white mb-1">${escHtml(s.title || 'Section ' + (i+1))}</h5>
                                    <p class="text-xs text-gray-400 line-clamp-3">${escHtml((s.content || '').substring(0, 200))}${(s.content || '').length > 200 ? '...' : ''}</p>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="viewDemoKbFullContent('${t.id}')" class="mt-3 text-sm text-purple-400 hover:text-purple-300">View full content â†’</button>
                    </div>
                    ` : ''}
                    
                    <!-- Upload Zone -->
                    <div class="drop-zone rounded-lg p-6 text-center mb-4 cursor-pointer border-2 border-dashed border-gray-600 hover:border-purple-500 transition" 
                         onclick="document.getElementById('det-input').click()"
                         ondragover="this.classList.add('border-purple-500');event.preventDefault()" 
                         ondragleave="this.classList.remove('border-purple-500')"
                         ondrop="handleDocDrop(event,'${t.id}')">
                        <input type="file" id="det-input" class="hidden" multiple accept=".pdf,.doc,.docx,.txt,.md,.csv,.xlsx" onchange="uploadDocs('${t.id}',event)">
                        <span class="text-3xl block mb-2">ðŸ“¤</span>
                        <p class="text-gray-400 text-sm">Drop files or click to upload</p>
                        <p class="text-xs text-gray-500 mt-1">Supports: PDF, DOC, DOCX, TXT, MD, CSV, XLSX</p>
                    </div>
                    
                    <!-- Add Entry Buttons - Available for ALL knowledge bases -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                        <button onclick="showAddTextEntryModal('${t.id}')" class="btn-secondary px-3 py-2 rounded-lg text-sm border border-dashed border-gray-600 hover:border-purple-500">
                            âœï¸ Text
                        </button>
                        <button onclick="showAddTableModal('${t.id}')" class="btn-secondary px-3 py-2 rounded-lg text-sm border border-dashed border-gray-600 hover:border-green-500">
                            ðŸ“Š Table
                        </button>
                        <button onclick="showAddUrlModal('${t.id}')" class="btn-secondary px-3 py-2 rounded-lg text-sm border border-dashed border-gray-600 hover:border-blue-500">
                            ðŸŒ URL
                        </button>
                        <button onclick="document.getElementById('det-input').click()" class="btn-secondary px-3 py-2 rounded-lg text-sm border border-dashed border-gray-600 hover:border-yellow-500">
                            ðŸ“„ File
                        </button>
                    </div>
                    
                    <!-- Documents List -->
                    <div class="space-y-2" id="docs-list-${t.id}">
                        ${t.documents?.length ? t.documents.map(d=>`
                            <div class="flex items-center justify-between bg-gray-800 rounded-lg p-3 hover:bg-gray-750 transition ${d.is_demo ? 'border-l-2 border-purple-500' : ''} ${d.is_table ? 'border-l-2 border-green-500' : ''}">
                                <div class="flex items-center gap-3 min-w-0 flex-1 cursor-pointer" onclick="${d.is_table ? `viewTableEntry('${t.id}', '${escHtml(d.original_name)}')` : (d.is_demo ? `viewTextEntry('${t.id}', '${escHtml(d.original_name)}', true)` : `viewDocContent('${d.id}', '${escHtml(d.original_name)}')`)}">
                                    <span class="text-xl">${d.is_table ? 'ðŸ“Š' : (d.is_demo ? 'ðŸ“' : fileIcon(d.file_type))}</span>
                                    <div class="min-w-0">
                                        <div class="flex items-center gap-2">
                                            <p class="text-sm font-medium truncate">${d.original_name}</p>
                                            ${d.is_table ? '<span class="text-xs bg-green-500/20 text-green-300 px-1.5 py-0.5 rounded">Table</span>' : ''}
                                            ${d.is_demo && !d.is_table ? '<span class="text-xs bg-purple-500/20 text-purple-300 px-1.5 py-0.5 rounded">Text</span>' : ''}
                                        </div>
                                        <p class="text-xs text-gray-500">${d.is_table ? (d.rows_count || 0) + ' rows' : fmtSize(d.file_size)} â€¢ ${d.chunks_count || 0} chunks â€¢ <span class="status-${d.status}">${d.status}</span></p>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    ${d.is_table ? `
                                        <button onclick="viewTableEntry('${t.id}', '${escHtml(d.original_name)}')" class="p-2 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="View/Edit Table">âœï¸</button>
                                        <button onclick="deleteTextEntry('${t.id}', '${escHtml(d.original_name)}')" class="p-2 hover:bg-red-900/50 rounded text-gray-400 hover:text-red-400" title="Delete">ðŸ—‘ï¸</button>
                                    ` : d.is_demo ? `
                                        <button onclick="viewTextEntry('${t.id}', '${escHtml(d.original_name)}', true)" class="p-2 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="View/Edit">âœï¸</button>
                                        <button onclick="deleteTextEntry('${t.id}', '${escHtml(d.original_name)}')" class="p-2 hover:bg-red-900/50 rounded text-gray-400 hover:text-red-400" title="Delete">ðŸ—‘ï¸</button>
                                    ` : `
                                        <button onclick="viewDocContent('${d.id}', '${escHtml(d.original_name)}')" class="p-2 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="View Content">ðŸ‘ï¸</button>
                                        <button onclick="downloadDoc('${d.id}', '${escHtml(d.original_name)}')" class="p-2 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="Download">â¬‡ï¸</button>
                                        <button onclick="delDoc('${d.id}','${t.id}')" class="p-2 hover:bg-red-900/50 rounded text-gray-400 hover:text-red-400" title="Delete">ðŸ—‘ï¸</button>
                                    `}
                                </div>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-center py-8">No documents yet. Add content using the buttons above.</p>'}
                    </div>
                    
                    <!-- Scraped Pages List -->
                    ${t.scraped_pages?.length ? `
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <h4 class="text-sm font-medium text-gray-400 mb-2">ðŸŒ Scraped URLs (${t.scraped_pages.length})</h4>
                            <div class="space-y-2">
                                ${t.scraped_pages.map(p => `
                                    <div class="flex items-center justify-between bg-gray-800/50 rounded-lg p-2">
                                        <div class="flex items-center gap-2 min-w-0">
                                            <span>ðŸ”—</span>
                                            <a href="${escHtml(p.url)}" target="_blank" class="text-sm text-blue-400 hover:underline truncate">${escHtml(p.url)}</a>
                                        </div>
                                        <span class="text-xs text-gray-500">${p.chunks_extracted || 0} chunks</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Search/Query Section -->
                <div class="card rounded-xl p-4 md:p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold">ðŸ’¬ Ask Knowledge Base</h3>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-gray-400">Mode:</label>
                            <select id="kb-mode-${t.id}" class="input-field rounded px-2 py-1 text-xs">
                                <option value="ai">ðŸ¤– AI Answer</option>
                                <option value="raw">ðŸ“„ Raw Search</option>
                            </select>
                            
                        </div>
                    </div>
                    <div class="flex gap-3 mb-4">
                        <input type="text" id="kb-search-${t.id}" class="input-field flex-1 rounded-lg px-4 py-2" 
                               placeholder="Ask a question..." 
                               onkeypress="if(event.key==='Enter')askKnowledgeBase('${t.id}')">
                        <button onclick="askKnowledgeBase('${t.id}')" class="btn-primary px-4 py-2 rounded-lg">Ask</button>
                    </div>
                    <div id="kb-results-${t.id}" class="hidden">
                        <!-- Results will appear here -->
                    </div>
                </div>`;
            }
            
            // ========== WEBSITE TYPE ==========
            if(t.type==='website'){
                h+=`<div class="card rounded-xl p-4 md:p-5 mb-4">
                    <h3 class="font-semibold mb-4">ðŸŒ Web Scraping</h3>
                    <div class="flex flex-col sm:flex-row gap-3 mb-4">
                        <input type="text" id="scrape-url" class="input-field flex-1 rounded-lg px-4 py-2" placeholder="https://example.com" value="${t.config?.url||''}">
                        <div class="flex gap-2 items-center">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="scrape-rec" class="rounded">
                                <span>Recursive</span>
                            </label>
                            <input type="number" id="scrape-max" class="input-field w-20 rounded px-2 py-2" value="10" placeholder="Max">
                            <button onclick="scrape('${t.id}')" class="btn-primary px-4 py-2 rounded-lg">ðŸ”„ Scrape</button>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        ${t.scraped_pages?.length ? t.scraped_pages.map(p=>`
                            <div class="bg-gray-800 rounded-lg p-3 hover:bg-gray-750 transition">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="min-w-0 flex-1 cursor-pointer" onclick="viewPageContent('${p.id}')">
                                        <p class="text-sm truncate font-medium">${p.title||'Untitled'}</p>
                                        <p class="text-xs text-gray-500 truncate">${p.url}</p>
                                    </div>
                                    <div class="flex gap-1 ml-2">
                                        <button onclick="viewPageContent('${p.id}')" class="p-2 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="View Content">ðŸ‘ï¸</button>
                                        <a href="${p.url}" target="_blank" class="p-2 hover:bg-gray-700 rounded text-gray-400 hover:text-white" title="Open URL">ðŸ”—</a>
                                        <button onclick="delPage('${p.id}','${t.id}')" class="p-2 hover:bg-red-900/50 rounded text-gray-400 hover:text-red-400" title="Delete">ðŸ—‘ï¸</button>
                                    </div>
                                </div>
                                <div class="flex gap-3 text-xs text-gray-500">
                                    <span>ðŸ“ ${p.chunks?.length || 0} chunks</span>
                                    <span>ðŸ“„ ${(p.content?.length || 0).toLocaleString()} chars</span>
                                    <span class="status-${p.status}">${p.status}</span>
                                </div>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-center py-4">No pages scraped yet. Enter a URL above.</p>'}
                    </div>
                </div>`;
            }
            
            // ========== EMAIL TYPE ==========
            if(t.type==='email'){
                const emailConfig = t.config || {};
                const provider = emailConfig.provider || 'Not configured';
                const email = emailConfig.email || '';
                const isConnected = !!emailConfig.provider;
                
                h+=`<div class="card rounded-xl p-4 md:p-5 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold">ðŸ“§ Email Configuration</h3>
                        <span class="text-xs px-2 py-1 rounded ${isConnected ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                            ${isConnected ? 'âœ“ Connected' : 'âœ— Not Connected'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Provider</label>
                            <div class="input-field w-full rounded px-3 py-2 bg-gray-800">${provider === 'google' ? 'ðŸ”µ Gmail' : provider === 'sendgrid' ? 'ðŸ“¨ SendGrid' : provider === 'microsoft' ? 'ðŸ”· Outlook' : provider}</div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Email Address</label>
                            <div class="input-field w-full rounded px-3 py-2 bg-gray-800">${email || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Send Email Form -->
                <div class="card rounded-xl p-4 md:p-5 mb-4">
                    <h3 class="font-semibold mb-4">âœ‰ï¸ Send Email</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">To *</label>
                            <input type="email" id="email-to-${t.id}" class="input-field w-full rounded px-3 py-2" placeholder="recipient@example.com">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Subject *</label>
                            <input type="text" id="email-subject-${t.id}" class="input-field w-full rounded px-3 py-2" placeholder="Email subject">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Message *</label>
                            <textarea id="email-body-${t.id}" class="input-field w-full rounded px-3 py-2" rows="5" placeholder="Write your email message..."></textarea>
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="flex items-center gap-2 text-sm text-gray-400">
                                <input type="checkbox" id="email-html-${t.id}" class="w-4 h-4">
                                <span>Send as HTML</span>
                            </label>
                            <button onclick="sendEmailFromTool('${t.id}')" class="btn-primary px-6 py-2 rounded-lg flex items-center gap-2" ${!isConnected ? 'disabled' : ''}>
                                ðŸ“¤ Send Email
                            </button>
                        </div>
                    </div>
                    <div id="email-result-${t.id}" class="mt-4 hidden"></div>
                </div>`;
            }
            
            // ========== API TYPE ==========
            if(t.type==='api'){
                const apiConfig = t.api_config || {};
                const mockResponse = t.config?.mock_response ? JSON.stringify(t.config.mock_response, null, 2) : '{}';
                const isDemoMode = t.config?.demo_mode || false;
                
                h+=`<div class="card rounded-xl p-4 md:p-5 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold">ðŸ”Œ API Configuration</h3>
                        ${isDemoMode ? '<span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-1 rounded">Has Sample Response</span>' : ''}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Base URL</label>
                            <input type="text" id="api-base-url-${t.id}" class="input-field w-full rounded px-3 py-2" value="${apiConfig.base_url || ''}">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Endpoint Path</label>
                            <input type="text" id="api-endpoint-${t.id}" class="input-field w-full rounded px-3 py-2" value="${apiConfig.endpoint_path || ''}">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">HTTP Method</label>
                            <select id="api-method-${t.id}" class="input-field w-full rounded px-3 py-2">
                                <option value="GET" ${apiConfig.http_method === 'GET' ? 'selected' : ''}>GET</option>
                                <option value="POST" ${apiConfig.http_method === 'POST' ? 'selected' : ''}>POST</option>
                                <option value="PUT" ${apiConfig.http_method === 'PUT' ? 'selected' : ''}>PUT</option>
                                <option value="DELETE" ${apiConfig.http_method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                            </select>
                            
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Auth Type</label>
                            <select id="api-auth-${t.id}" class="input-field w-full rounded px-3 py-2">
                                <option value="none" ${apiConfig.auth_type === 'none' ? 'selected' : ''}>None</option>
                                <option value="api_key" ${apiConfig.auth_type === 'api_key' ? 'selected' : ''}>API Key</option>
                                <option value="bearer" ${apiConfig.auth_type === 'bearer' ? 'selected' : ''}>Bearer Token</option>
                                <option value="basic" ${apiConfig.auth_type === 'basic' ? 'selected' : ''}>Basic Auth</option>
                            </select>
                            
                        </div>
                    </div>
                    
                    <button onclick="updateApiConfig('${t.id}')" class="btn-secondary px-4 py-2 rounded-lg text-sm mb-4">ðŸ’¾ Save Configuration</button>
                    
                    <!-- Parameters -->
                    ${apiConfig.input_parameters?.length ? `
                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-300 mb-2">Parameters</h4>
                            <div class="space-y-2">
                                ${apiConfig.input_parameters.map(p=>`
                                    <div class="bg-gray-800 rounded px-3 py-2 flex items-center gap-3">
                                        <span class="text-purple-400 font-mono">{${p.name}}</span>
                                        <span class="text-xs text-gray-500">${p.data_type}</span>
                                        ${p.required ? '<span class="text-xs text-red-400">required</span>' : ''}
                                        <span class="text-xs text-gray-500 flex-1">${p.description || ''}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Sample Response Editor (for testing without real API) -->
                ${isDemoMode ? `
                <div class="card rounded-xl p-4 md:p-5 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold">ðŸ“ Sample Response</h3>
                        <button onclick="saveMockResponse('${t.id}')" class="btn-primary px-4 py-2 rounded-lg text-sm">ðŸ’¾ Save</button>
                    </div>
                    <textarea id="mock-response-${t.id}" class="input-field w-full rounded-lg px-4 py-3 font-mono text-sm" rows="12" placeholder="Enter JSON sample response...">${escHtml(mockResponse)}</textarea>
                    <p class="text-xs text-gray-500 mt-2">This JSON will be returned when the agent calls this API during testing.</p>
                </div>
                ` : ''}
                
                <!-- Output Transformation (Natural Language) -->
                <div class="card rounded-xl p-4 md:p-5 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold">âœ¨ Output Transformation</h3>
                        <button onclick="saveOutputTransform('${t.id}')" class="btn-primary px-4 py-2 rounded-lg text-sm">ðŸ’¾ Save</button>
                    </div>
                    <p class="text-sm text-gray-400 mb-3">Describe in plain English how you want the API response to be transformed:</p>
                    <textarea id="output-transform-${t.id}" class="input-field w-full rounded-lg px-4 py-3 text-sm" rows="3" 
                              placeholder="Examples:&#10;â€¢ Show only the total amount&#10;â€¢ Extract just the employee names as a list&#10;â€¢ Format as a summary with key metrics&#10;â€¢ Convert to a simple success/failure message">${escHtml(t.config?.output_transform || '')}</textarea>
                    <div class="flex items-center gap-4 mt-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="transform-enabled-${t.id}" class="w-4 h-4 rounded" ${t.config?.transform_enabled ? 'checked' : ''}>
                            <span class="text-sm text-gray-400">Enable transformation</span>
                        </label>
                        <span class="text-xs text-gray-500">When enabled, the API response will be transformed by AI based on your instructions</span>
                    </div>
                </div>
                
                <!-- Test API -->
                <div class="card rounded-xl p-4 md:p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold">ðŸ§ª Test API</h3>
                        <div class="flex gap-2">
                            ${isDemoMode ? `
                                <button onclick="analyzeApiParams('${t.id}')" class="btn-secondary px-3 py-1.5 rounded-lg text-sm" id="btn-analyze-${t.id}">
                                    ðŸ” Analyze Parameters
                                </button>
                                <button onclick="autoFillTestData('${t.id}')" class="btn-secondary px-3 py-1.5 rounded-lg text-sm">
                                    âœ¨ Auto-fill
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Parameters Container - Will be populated by LLM analysis or default -->
                    <div id="api-params-container-${t.id}">
                        ${apiConfig.input_parameters?.length ? `
                            <p class="text-sm text-gray-400 mb-3">Enter values below to try the API. Optional fields can be left empty.</p>
                            <div class="space-y-4 mb-4">
                                ${apiConfig.input_parameters.map(p => `
                                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700/50" id="param-wrapper-${p.name}">
                                    <div class="flex items-center justify-between mb-2">
                                        <label class="text-sm font-medium text-gray-200">${p.name} ${p.required ? '<span class="text-red-400">*</span>' : ''}</label>
                                        <span class="text-xs text-gray-500">${p.data_type || 'string'}</span>
                                    </div>
                                    ${p.description ? `<p class="text-xs text-gray-500 mb-2">${p.description}</p>` : ''}
                                    <div id="param-input-area-${p.name}">
                                        <input type="text" id="test-param-${p.name}" class="input-field w-full rounded-lg px-3 py-2.5 text-sm" placeholder="Enter ${p.name}..." />
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                            ${isDemoMode ? `
                            <div class="bg-blue-900/20 border border-blue-600/30 rounded-lg p-3 mb-4 text-sm" id="analyze-hint-${t.id}">
                                <p class="text-blue-300">ðŸ’¡ Click "ðŸ” Analyze Parameters" to get smart input options based on your API configuration.</p>
                            </div>
                            ` : ''}
                        ` : '<p class="text-gray-500 text-sm mb-4">This API doesn\'t need any values. Click "Test Call" to try it.</p>'}
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="testApiCall('${t.id}')" class="btn-primary px-6 py-2 rounded-lg">
                            â–¶ï¸ Test Call
                        </button>
                        ${isDemoMode ? `
                            <span class="text-xs text-purple-400 flex items-center gap-1">
                                âœ“ Sample response configured
                            </span>
                        ` : ''}
                    </div>
                    
                    <div id="api-test-result-${t.id}" class="hidden mt-4">
                        <h4 class="text-sm font-medium text-gray-300 mb-2">Response:</h4>
                        <pre class="bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm"></pre>
                    </div>
                </div>`;
            }
            
            // ========== ANY OTHER TOOL TYPE (Generic Config) ==========
            const handledTypes = ['document', 'knowledge', 'website', 'api'];
            if(!handledTypes.includes(t.type)) {
                const configJson = JSON.stringify(t.config || {}, null, 2);
                const toolIcon = {
                    'database': 'ðŸ—„ï¸',
                    'slack': 'ðŸ’¬',
                    'email': 'ðŸ“§',
                    'calendar': 'ðŸ“…',
                    'crm': 'ðŸ‘¥',
                    'code': 'ðŸ’»',
                    'websearch': 'ðŸ”',
                    'ocr': 'ðŸ“·'
                }[t.type] || 'ðŸ”§';
                
                h+=`<div class="card rounded-xl p-4 md:p-5 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold">${toolIcon} ${t.type.toUpperCase()} Configuration</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Tool Name</label>
                            <input type="text" id="tool-name-${t.id}" class="input-field w-full rounded px-3 py-2" value="${escHtml(t.name || '')}">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Description</label>
                            <textarea id="tool-desc-${t.id}" class="input-field w-full rounded px-3 py-2" rows="2">${escHtml(t.description || '')}</textarea>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Configuration (JSON)</label>
                            <textarea id="tool-config-${t.id}" class="input-field w-full rounded-lg px-4 py-3 font-mono text-sm" rows="10" placeholder="{}">${escHtml(configJson)}</textarea>
                            <p class="text-xs text-gray-500 mt-1">Edit the JSON configuration for this tool</p>
                        </div>
                        
                        <button onclick="saveToolConfig('${t.id}')" class="btn-primary px-4 py-2 rounded-lg">ðŸ’¾ Save Configuration</button>
                    </div>
                </div>
                
                <!-- Test Section -->
                <div class="card rounded-xl p-4 md:p-5">
                    <h3 class="font-semibold mb-4">ðŸ§ª Test Tool</h3>
                    <div class="space-y-3 mb-4">
                        <div>
                            <label class="text-xs text-gray-400 block mb-1">Test Input</label>
                            <textarea id="tool-test-input-${t.id}" class="input-field w-full rounded px-3 py-2 font-mono text-sm" rows="3" placeholder='{"query": "test"}'>{}</textarea>
                        </div>
                    </div>
                    <button onclick="testGenericTool('${t.id}')" class="btn-primary px-4 py-2 rounded-lg mb-4">â–¶ï¸ Test</button>
                    
                    <div id="tool-test-result-${t.id}" class="hidden">
                        <h4 class="text-sm font-medium text-gray-300 mb-2">Result:</h4>
                        <pre class="bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm"></pre>
                    </div>
                </div>`;
            }
            
            document.getElementById('tool-detail').innerHTML=h;
            document.querySelectorAll('main>section').forEach(s=>s.classList.add('hidden'));
            document.getElementById('page-tool-detail').classList.remove('hidden');
        }

        async function uploadDocs(tid,e){
            const btn = e.target;
            for(const f of e.target.files){
                const fd=new FormData();
                fd.append('file',f);
                await fetch(API+'/api/tools/'+tid+'/documents',{method:'POST',body:fd});
            }
            viewTool(tid);
        }
        
        function handleDocDrop(e, tid) {
            e.preventDefault();
            e.target.classList.remove('border-purple-500');
            const files = e.dataTransfer.files;
            if(files.length > 0) {
                uploadDocsFromDrop(tid, files);
            }
        }
        
        async function uploadDocsFromDrop(tid, files) {
            for(const f of files) {
                const fd = new FormData();
                fd.append('file', f);
                await fetch(API+'/api/tools/'+tid+'/documents', {method:'POST', body:fd});
            }
            viewTool(tid);
        }
        
        async function delDoc(docId, toolId){
            if(!confirm('Delete this document?')) return;
            await fetch(API+'/api/documents/'+docId, {
                method:'DELETE',
                headers: getAuthHeaders()
            });
            if(toolId) viewTool(toolId);
            else location.reload();
        }
        
        // View Demo KB full content
        async function viewDemoKbFullContent(toolId) {
            try {
                const r = await fetch(API + '/api/tools/' + toolId);
                const t = await r.json();
                
                const sections = t.config?.sections || [];
                const content = t.config?.content || '';
                
                let html = `<p class="text-gray-400 mb-4">${escHtml(t.description)}</p>`;
                
                if (sections.length > 0) {
                    html += sections.map(s => `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-purple-400 mb-2">${escHtml(s.title)}</h3>
                            <div class="text-gray-300 whitespace-pre-wrap">${escHtml(s.content)}</div>
                        </div>
                    `).join('');
                } else if (content) {
                    html += `<div class="text-gray-300 whitespace-pre-wrap">${escHtml(content)}</div>`;
                }
                
                document.getElementById('kb-view-title').textContent = t.name;
                document.getElementById('kb-view-content').innerHTML = html;
                ensureModalInBody('kb-view-modal');
                document.getElementById('kb-view-modal').classList.remove('hidden');
                document.getElementById('kb-view-modal').classList.add('flex');
            } catch (e) {
                alert('Failed to load content');
            }
        }

        async function viewDocContent(docId, docName) {
            try {
                const r = await fetch(API+'/api/documents/'+docId+'/content');
                const data = await r.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
                modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="bg-[#1e1e2e] rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <h3 class="font-semibold truncate">${docName}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">âœ•</button>
                        </div>
                        <div class="p-4 overflow-auto flex-1">
                            <pre class="whitespace-pre-wrap text-sm text-gray-300">${escHtml(data.content || data.text || 'No content available')}</pre>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-between text-xs text-gray-500">
                            <span>${data.chunks_count || 0} chunks indexed</span>
                            <span>${(data.content?.length || 0).toLocaleString()} characters</span>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch(e) {
                alert('Failed to load document: ' + e.message);
            }
        }
        
        async function viewTextEntry(toolId, docName, isTextEntry = false) {
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/data');
                const data = await r.json();
                
                // Find chunks for this document
                const chunks = data.chunks?.filter(c => c.source === docName) || [];
                const content = chunks.map(c => c.text).join('\n\n');
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
                modal.id = 'text-entry-modal';
                modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="bg-[#1e1e2e] rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <h3 class="font-semibold">${escHtml(docName)}</h3>
                                ${isTextEntry ? '<span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded">Text Entry</span>' : ''}
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">âœ•</button>
                        </div>
                        <div class="p-4 flex-1 overflow-auto">
                            <label class="text-sm text-gray-400 mb-2 block">${isTextEntry ? 'Edit Content:' : 'Content (Read-only for uploaded files):'}</label>
                            <textarea id="text-entry-content" class="input-field w-full rounded-lg px-4 py-3 font-mono text-sm" rows="15" ${isTextEntry ? '' : 'readonly'}>${escHtml(content)}</textarea>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-between items-center">
                            <span class="text-xs text-gray-500">${chunks.length} chunk(s) â€¢ ${content.length.toLocaleString()} characters</span>
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('text-entry-modal').remove()" class="btn-secondary px-4 py-2 rounded-lg">Close</button>
                                ${isTextEntry ? `<button onclick="saveTextEntry('${toolId}', '${escHtml(docName)}')" class="btn-primary px-4 py-2 rounded-lg">ðŸ’¾ Save Changes</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch(e) {
                alert('Failed to load document: ' + e.message);
            }
        }
        
        // Keep old function names for backward compatibility
        async function viewDemoDocContent(toolId, docName) {
            return viewTextEntry(toolId, docName, true);
        }
        
        async function saveTextEntry(toolId, docName) {
            const content = document.getElementById('text-entry-content')?.value;
            if(!content) return alert('Content cannot be empty');
            
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/demo-document', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ source: docName, content })
                });
                const data = await r.json();
                
                if(data.status === 'success') {
                    alert('âœ… Entry updated!');
                    document.getElementById('text-entry-modal')?.remove();
                    viewTool(toolId); // Refresh
                } else {
                    alert('Error: ' + (data.error || 'Failed to save'));
                }
            } catch(e) {
                alert('Failed to save: ' + e.message);
            }
        }
        
        // Keep old function name for backward compatibility
        async function saveDemoDocContent(toolId, docName) {
            return saveTextEntry(toolId, docName);
        }
        
        async function deleteTextEntry(toolId, docName) {
            if(!confirm(`Delete "${docName}"?`)) return;
            
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/demo-document/'+encodeURIComponent(docName), {
                    method: 'DELETE'
                });
                const data = await r.json();
                
                if(data.status === 'success') {
                    viewTool(toolId); // Refresh
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete'));
                }
            } catch(e) {
                alert('Failed to delete: ' + e.message);
            }
        }
        
        // Keep old function name for backward compatibility
        async function deleteDemoDoc(toolId, docName) {
            return deleteTextEntry(toolId, docName);
        }
        
        function showAddTextEntryModal(toolId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
            modal.id = 'add-text-entry-modal';
            modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div class="bg-[#1e1e2e] rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                        <h3 class="font-semibold">âœï¸ Add Text Entry</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">âœ•</button>
                    </div>
                    <div class="p-4 flex-1 overflow-auto space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Title *</label>
                            <input type="text" id="new-text-entry-title" class="input-field w-full rounded-lg px-4 py-2" placeholder="e.g., Company Policy, FAQ, Product Info">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Content *</label>
                            <textarea id="new-text-entry-content" class="input-field w-full rounded-lg px-4 py-3 font-mono text-sm" rows="12" placeholder="Enter the text content that will be searchable by the agent..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">ðŸ’¡ Tip: You can add multiple entries for different topics to organize your knowledge base.</p>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
                        <button onclick="document.getElementById('add-text-entry-modal').remove()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                        <button onclick="addTextEntry('${toolId}')" class="btn-primary px-4 py-2 rounded-lg">âœï¸ Add Entry</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Keep old function name for backward compatibility
        function showAddDemoDocModal(toolId) {
            return showAddTextEntryModal(toolId);
        }
        
        async function addTextEntry(toolId) {
            const title = document.getElementById('new-text-entry-title')?.value?.trim();
            const content = document.getElementById('new-text-entry-content')?.value?.trim();
            
            if(!title || !content) {
                return alert('Please enter both title and content');
            }
            
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/demo-document', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ source: title, content })
                });
                const data = await r.json();
                
                if(data.status === 'success') {
                    alert('âœ… Entry added!');
                    document.getElementById('add-text-entry-modal')?.remove();
                    viewTool(toolId); // Refresh
                } else {
                    alert('Error: ' + (data.error || 'Failed to add'));
                }
            } catch(e) {
                alert('Failed to add: ' + e.message);
            }
        }
        
        // Keep old function name for backward compatibility
        async function addDemoDoc(toolId) {
            return addTextEntry(toolId);
        }
        
        // ========== URL SCRAPING FUNCTIONS ==========
        function showAddUrlModal(toolId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
            modal.id = 'add-url-modal';
            modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div class="bg-[#1e1e2e] rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                        <h3 class="font-semibold">ðŸŒ Add URL / Scrape Website</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">âœ•</button>
                    </div>
                    <div class="p-4 flex-1 overflow-auto space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Website URL *</label>
                            <input type="url" id="scrape-url" class="input-field w-full rounded-lg px-4 py-2" placeholder="https://example.com/page">
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="scrape-recursive" class="w-4 h-4 rounded">
                                <span class="text-sm">Scrape linked pages (recursive)</span>
                            </label>
                        </div>
                        
                        <div id="scrape-options" class="hidden">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Max Pages</label>
                                    <input type="number" id="scrape-max" class="input-field w-full rounded-lg px-4 py-2" value="10" min="1" max="100">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400 mb-1 block">Max Depth</label>
                                    <input type="number" id="scrape-depth" class="input-field w-full rounded-lg px-4 py-2" value="2" min="1" max="5">
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-900/30 border border-blue-600/50 rounded-lg p-3 text-sm">
                            <p class="text-blue-300">ðŸ’¡ The content will be extracted and added to your knowledge base for the agent to search.</p>
                        </div>
                        
                        <div id="scrape-status" class="hidden"></div>
                    </div>
                    <div class="p-4 border-t border-gray-700 flex justify-end gap-2">
                        <button onclick="document.getElementById('add-url-modal').remove()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                        <button onclick="scrapeUrlForTool('${toolId}')" id="btn-scrape" class="btn-primary px-4 py-2 rounded-lg">ðŸŒ Scrape URL</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Toggle recursive options
            document.getElementById('scrape-recursive').onchange = (e) => {
                document.getElementById('scrape-options').classList.toggle('hidden', !e.target.checked);
            };
        }
        
        async function scrapeUrlForTool(toolId) {
            const url = document.getElementById('scrape-url')?.value?.trim();
            if (!url) return alert('Please enter a URL');
            if (!url.startsWith('http')) return alert('Please enter a valid URL starting with http:// or https://');
            
            const recursive = document.getElementById('scrape-recursive')?.checked || false;
            const maxPages = parseInt(document.getElementById('scrape-max')?.value) || 10;
            const maxDepth = parseInt(document.getElementById('scrape-depth')?.value) || 2;
            
            const statusEl = document.getElementById('scrape-status');
            const btnEl = document.getElementById('btn-scrape');
            
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<div class="flex items-center gap-2 text-blue-300"><span class="animate-spin">â³</span> Scraping website...</div>';
            btnEl.disabled = true;
            btnEl.textContent = 'Scraping...';
            
            try {
                const r = await fetch(API + '/api/tools/' + toolId + '/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        url, 
                        recursive, 
                        max_pages: maxPages,
                        max_depth: maxDepth
                    })
                });
                
                const data = await r.json();
                
                if (r.ok) {
                    statusEl.innerHTML = '<div class="text-green-300">âœ… Successfully scraped! Extracted ' + (data.chunks_extracted || 0) + ' chunks.</div>';
                    setTimeout(() => {
                        document.getElementById('add-url-modal')?.remove();
                        viewTool(toolId); // Refresh
                    }, 1500);
                } else {
                    statusEl.innerHTML = '<div class="text-red-300">âŒ ' + (data.detail || data.error || 'Failed to scrape') + '</div>';
                    btnEl.disabled = false;
                    btnEl.textContent = 'ðŸŒ Scrape URL';
                }
            } catch (e) {
                statusEl.innerHTML = '<div class="text-red-300">âŒ Error: ' + e.message + '</div>';
                btnEl.disabled = false;
                btnEl.textContent = 'ðŸŒ Scrape URL';
            }
        }
        
        // ========== TABLE FUNCTIONS ==========
        let currentTableData = { headers: [], rows: [] };
        let currentTableToolId = null;
        let currentTableName = null;
        
        function showAddTableModal(toolId) {
            currentTableToolId = toolId;
            currentTableData = { headers: ['Column 1', 'Column 2', 'Column 3'], rows: [['', '', ''], ['', '', '']] };
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
            modal.id = 'add-table-modal';
            modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div class="bg-[#1e1e2e] rounded-xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                        <h3 class="font-semibold">ðŸ“Š Add Table</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">âœ•</button>
                    </div>
                    <div class="p-4 flex-1 overflow-auto space-y-4">
                        <!-- Table Name -->
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">Table Name *</label>
                            <input type="text" id="table-name" class="input-field w-full rounded-lg px-4 py-2" placeholder="e.g., Employee Directory, Product Catalog">
                        </div>
                        
                        <!-- Import Options -->
                        <div class="flex gap-3 items-center p-3 bg-gray-800/50 rounded-lg">
                            <span class="text-sm text-gray-400">Import from:</span>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="file" id="table-file-input" class="hidden" accept=".csv,.xlsx,.xls" onchange="importTableFromFile(event)">
                                <button onclick="document.getElementById('table-file-input').click()" class="btn-secondary px-3 py-1.5 rounded text-sm">
                                    ðŸ“ CSV/Excel
                                </button>
                            </label>
                            <span class="text-gray-500">or create manually below</span>
                        </div>
                        
                        <!-- Table Size Controls -->
                        <div class="flex gap-4 items-center">
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400">Columns:</label>
                                <button onclick="changeTableCols(-1)" class="btn-secondary w-8 h-8 rounded">-</button>
                                <span id="col-count" class="w-8 text-center">3</span>
                                <button onclick="changeTableCols(1)" class="btn-secondary w-8 h-8 rounded">+</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400">Rows:</label>
                                <button onclick="changeTableRows(-1)" class="btn-secondary w-8 h-8 rounded">-</button>
                                <span id="row-count" class="w-8 text-center">2</span>
                                <button onclick="changeTableRows(1)" class="btn-secondary w-8 h-8 rounded">+</button>
                            </div>
                        </div>
                        
                        <!-- Editable Table -->
                        <div class="overflow-x-auto">
                            <div id="table-editor"></div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-700 flex justify-between items-center">
                        <span class="text-xs text-gray-500">ðŸ’¡ Click any cell to edit. Table data will be searchable by the agent.</span>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('add-table-modal').remove()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                            <button onclick="saveNewTable()" class="btn-primary px-4 py-2 rounded-lg">ðŸ“Š Add Table</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            renderTableEditor();
        }
        
        function renderTableEditor(containerId = 'table-editor') {
            const container = document.getElementById(containerId);
            if(!container) return;
            
            let html = '<table class="w-full border-collapse text-sm">';
            
            // Headers row
            html += '<tr>';
            currentTableData.headers.forEach((h, i) => {
                html += `<th class="border border-gray-600 p-0">
                    <input type="text" value="${escHtml(h)}" 
                           onchange="currentTableData.headers[${i}]=this.value" 
                           class="w-full bg-gray-700 text-white font-semibold px-3 py-2 text-center outline-none focus:bg-gray-600"
                           placeholder="Header ${i+1}">
                </th>`;
            });
            html += '</tr>';
            
            // Data rows
            currentTableData.rows.forEach((row, ri) => {
                html += '<tr>';
                row.forEach((cell, ci) => {
                    html += `<td class="border border-gray-700 p-0">
                        <input type="text" value="${escHtml(cell)}" 
                               onchange="currentTableData.rows[${ri}][${ci}]=this.value"
                               class="w-full bg-gray-800 px-3 py-2 outline-none focus:bg-gray-700"
                               placeholder="">
                    </td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            container.innerHTML = html;
            
            // Update counters
            const colCount = document.getElementById('col-count');
            const rowCount = document.getElementById('row-count');
            if(colCount) colCount.textContent = currentTableData.headers.length;
            if(rowCount) rowCount.textContent = currentTableData.rows.length;
        }
        
        function changeTableCols(delta) {
            const newCount = currentTableData.headers.length + delta;
            if(newCount < 1 || newCount > 20) return;
            
            if(delta > 0) {
                currentTableData.headers.push(`Column ${newCount}`);
                currentTableData.rows.forEach(row => row.push(''));
            } else {
                currentTableData.headers.pop();
                currentTableData.rows.forEach(row => row.pop());
            }
            renderTableEditor();
        }
        
        function changeTableRows(delta) {
            const newCount = currentTableData.rows.length + delta;
            if(newCount < 1 || newCount > 100) return;
            
            if(delta > 0) {
                currentTableData.rows.push(new Array(currentTableData.headers.length).fill(''));
            } else {
                currentTableData.rows.pop();
            }
            renderTableEditor();
        }
        
        function importTableFromFile(event) {
            const file = event.target.files[0];
            if(!file) return;
            
            const fileName = file.name.toLowerCase();
            
            if(fileName.endsWith('.csv')) {
                // Parse CSV
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    parseCSVToTable(text);
                };
                reader.readAsText(file);
            } else if(fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                // Parse Excel using SheetJS
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // Dynamic import SheetJS
                        if(!window.XLSX) {
                            const script = document.createElement('script');
                            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                            document.head.appendChild(script);
                            await new Promise(r => script.onload = r);
                        }
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        if(jsonData.length > 0) {
                            currentTableData.headers = jsonData[0].map(h => String(h || ''));
                            currentTableData.rows = jsonData.slice(1).map(row => 
                                currentTableData.headers.map((_, i) => String(row[i] || ''))
                            );
                            if(currentTableData.rows.length === 0) {
                                currentTableData.rows = [new Array(currentTableData.headers.length).fill('')];
                            }
                            renderTableEditor();
                            
                            // Auto-fill table name from filename
                            const tableName = document.getElementById('table-name');
                            if(tableName && !tableName.value) {
                                tableName.value = file.name.replace(/\.(csv|xlsx|xls)$/i, '');
                            }
                        }
                    } catch(err) {
                        alert('Failed to parse Excel file: ' + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }
        
        function parseCSVToTable(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim());
            if(lines.length === 0) return;
            
            // Simple CSV parser (handles basic cases)
            const parseRow = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for(let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if(char === '"') {
                        inQuotes = !inQuotes;
                    } else if(char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            };
            
            currentTableData.headers = parseRow(lines[0]);
            currentTableData.rows = lines.slice(1).map(line => {
                const row = parseRow(line);
                // Ensure row has same length as headers
                while(row.length < currentTableData.headers.length) row.push('');
                return row.slice(0, currentTableData.headers.length);
            });
            
            if(currentTableData.rows.length === 0) {
                currentTableData.rows = [new Array(currentTableData.headers.length).fill('')];
            }
            
            renderTableEditor();
        }
        
        async function saveNewTable() {
            const tableName = document.getElementById('table-name')?.value?.trim();
            if(!tableName) return alert('Please enter a table name');
            if(currentTableData.headers.length === 0) return alert('Table must have at least one column');
            
            // Convert table to searchable text format
            const tableContent = convertTableToText(tableName, currentTableData);
            
            try {
                const r = await fetch(API+'/api/tools/'+currentTableToolId+'/table-entry', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        source: tableName, 
                        content: tableContent,
                        table_data: currentTableData
                    })
                });
                const data = await r.json();
                
                if(data.status === 'success') {
                    alert('âœ… Table added!');
                    document.getElementById('add-table-modal')?.remove();
                    viewTool(currentTableToolId);
                } else {
                    alert('Error: ' + (data.error || 'Failed to add'));
                }
            } catch(e) {
                alert('Failed to add: ' + e.message);
            }
        }
        
        function convertTableToText(tableName, tableData) {
            let text = `## ${tableName}\n\n`;
            
            // Add as markdown table
            text += '| ' + tableData.headers.join(' | ') + ' |\n';
            text += '| ' + tableData.headers.map(() => '---').join(' | ') + ' |\n';
            tableData.rows.forEach(row => {
                text += '| ' + row.join(' | ') + ' |\n';
            });
            
            text += '\n\n### Records:\n\n';
            
            // Also add as structured text for better search
            tableData.rows.forEach((row, i) => {
                text += `**Record ${i + 1}:**\n`;
                tableData.headers.forEach((h, j) => {
                    if(row[j]) text += `- ${h}: ${row[j]}\n`;
                });
                text += '\n';
            });
            
            return text;
        }
        
        async function viewTableEntry(toolId, tableName) {
            currentTableToolId = toolId;
            currentTableName = tableName;
            
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/table-entry/'+encodeURIComponent(tableName));
                const data = await r.json();
                
                if(data.table_data) {
                    currentTableData = data.table_data;
                } else {
                    // Try to parse from content
                    currentTableData = { headers: ['Column 1'], rows: [['No data']] };
                }
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
                modal.id = 'view-table-modal';
                modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="bg-[#1e1e2e] rounded-xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <h3 class="font-semibold">${escHtml(tableName)}</h3>
                                <span class="text-xs bg-green-500/20 text-green-300 px-2 py-0.5 rounded">Table</span>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-xl">âœ•</button>
                        </div>
                        <div class="p-4 flex-1 overflow-auto space-y-4">
                            <!-- Table Size Controls -->
                            <div class="flex gap-4 items-center">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm text-gray-400">Columns:</label>
                                    <button onclick="changeTableCols(-1);renderTableEditor('view-table-editor')" class="btn-secondary w-8 h-8 rounded">-</button>
                                    <span id="col-count" class="w-8 text-center">${currentTableData.headers.length}</span>
                                    <button onclick="changeTableCols(1);renderTableEditor('view-table-editor')" class="btn-secondary w-8 h-8 rounded">+</button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm text-gray-400">Rows:</label>
                                    <button onclick="changeTableRows(-1);renderTableEditor('view-table-editor')" class="btn-secondary w-8 h-8 rounded">-</button>
                                    <span id="row-count" class="w-8 text-center">${currentTableData.rows.length}</span>
                                    <button onclick="changeTableRows(1);renderTableEditor('view-table-editor')" class="btn-secondary w-8 h-8 rounded">+</button>
                                </div>
                                <button onclick="exportTableToCSV('${escHtml(tableName)}')" class="btn-secondary px-3 py-1.5 rounded text-sm ml-auto">
                                    ðŸ“¥ Export CSV
                                </button>
                            </div>
                            
                            <!-- Editable Table -->
                            <div class="overflow-x-auto">
                                <div id="view-table-editor"></div>
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-between items-center">
                            <span class="text-xs text-gray-500">${currentTableData.headers.length} columns Ã— ${currentTableData.rows.length} rows</span>
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('view-table-modal').remove()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                                <button onclick="updateTableEntry()" class="btn-primary px-4 py-2 rounded-lg">ðŸ’¾ Save Changes</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                renderTableEditor('view-table-editor');
                
            } catch(e) {
                alert('Failed to load table: ' + e.message);
            }
        }
        
        async function updateTableEntry() {
            const tableContent = convertTableToText(currentTableName, currentTableData);
            
            try {
                const r = await fetch(API+'/api/tools/'+currentTableToolId+'/table-entry/'+encodeURIComponent(currentTableName), {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        content: tableContent,
                        table_data: currentTableData
                    })
                });
                const data = await r.json();
                
                if(data.status === 'success') {
                    alert('âœ… Table updated!');
                    document.getElementById('view-table-modal')?.remove();
                    viewTool(currentTableToolId);
                } else {
                    alert('Error: ' + (data.error || 'Failed to update'));
                }
            } catch(e) {
                alert('Failed to update: ' + e.message);
            }
        }
        
        function exportTableToCSV(tableName) {
            let csv = currentTableData.headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + '\n';
            currentTableData.rows.forEach(row => {
                csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = tableName + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function downloadDoc(docId, docName) {
            try {
                const r = await fetch(API+'/api/documents/'+docId+'/download');
                const blob = await r.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = docName;
                a.click();
                URL.revokeObjectURL(url);
            } catch(e) {
                alert('Failed to download: ' + e.message);
            }
        }
        
        // Send email using email tool
        async function sendEmailFromTool(toolId) {
            const toEl = document.getElementById(`email-to-${toolId}`);
            const subjectEl = document.getElementById(`email-subject-${toolId}`);
            const bodyEl = document.getElementById(`email-body-${toolId}`);
            const htmlEl = document.getElementById(`email-html-${toolId}`);
            const resultEl = document.getElementById(`email-result-${toolId}`);
            
            const to = toEl?.value?.trim();
            const subject = subjectEl?.value?.trim();
            const body = bodyEl?.value?.trim();
            const html = htmlEl?.checked || false;
            
            if (!to) return alert('Please enter recipient email');
            if (!subject) return alert('Please enter email subject');
            if (!body) return alert('Please enter email message');
            
            // Show loading
            resultEl.classList.remove('hidden');
            resultEl.innerHTML = `
                <div class="flex items-center gap-2 text-blue-400 p-3 bg-blue-500/10 rounded-lg">
                    <span class="animate-spin">â³</span>
                    <span>Sending email...</span>
                </div>
            `;
            
            try {
                const response = await fetch(API + `/api/tools/${toolId}/send-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to, subject, body, html })
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    resultEl.innerHTML = `
                        <div class="p-3 bg-green-500/10 border border-green-500/30 rounded-lg">
                            <div class="flex items-center gap-2 text-green-400 font-medium">
                                <span>âœ…</span>
                                <span>Email sent successfully!</span>
                            </div>
                            <p class="text-sm text-gray-400 mt-1">
                                To: ${escHtml(to)}<br>
                                Subject: ${escHtml(subject)}
                            </p>
                        </div>
                    `;
                    // Clear form
                    toEl.value = '';
                    subjectEl.value = '';
                    bodyEl.value = '';
                } else {
                    resultEl.innerHTML = `
                        <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                            <div class="flex items-center gap-2 text-red-400 font-medium">
                                <span>âŒ</span>
                                <span>Failed to send email</span>
                            </div>
                            <p class="text-sm text-gray-400 mt-1">${escHtml(data.detail || data.message || 'Unknown error')}</p>
                        </div>
                    `;
                }
            } catch (err) {
                resultEl.innerHTML = `
                    <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                        <div class="flex items-center gap-2 text-red-400">
                            <span>âŒ</span>
                            <span>Error: ${escHtml(err.message)}</span>
                        </div>
                    </div>
                `;
            }
        }
        
        async function askKnowledgeBase(toolId) {
            const query = document.getElementById('kb-search-'+toolId)?.value;
            if(!query) return alert('Please enter a question');
            
            const mode = document.getElementById('kb-mode-'+toolId)?.value || 'ai';
            const resultsDiv = document.getElementById('kb-results-'+toolId);
            
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = `
                <div class="flex items-center gap-2 text-gray-400 py-4">
                    <span class="animate-spin">â³</span>
                    <span>${mode === 'ai' ? 'Thinking...' : 'Searching...'}</span>
                </div>
            `;
            
            try {
                if (mode === 'ai') {
                    // AI-powered answer
                    const r = await fetch(API+'/api/tools/'+toolId+'/ask', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ query, top_k: 5 })
                    });
                    const data = await r.json();
                    
                    resultsDiv.innerHTML = `
                        <div class="space-y-4">
                            <!-- AI Answer -->
                            <div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-purple-500/30 rounded-lg p-4">
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl">ðŸ¤–</span>
                                    <div class="flex-1">
                                        <p class="text-gray-200 whitespace-pre-wrap">${escHtml(data.answer || 'No answer generated')}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sources -->
                            ${data.sources?.length ? `
                                <div class="pt-2 border-t border-gray-700">
                                    <p class="text-xs text-gray-500 mb-2">ðŸ“š Sources used:</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${data.sources.map(s => `
                                            <span class="text-xs bg-gray-800 text-gray-400 px-2 py-1 rounded">
                                                ${escHtml(s.source)} (${s.score}%)
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Confidence -->
                            <div class="flex items-center gap-2 text-xs text-gray-500">
                                <span>Confidence:</span>
                                <div class="flex-1 bg-gray-700 rounded-full h-2 max-w-[100px]">
                                    <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-2 rounded-full" style="width: ${data.confidence || 0}%"></div>
                                </div>
                                <span>${data.confidence || 0}%</span>
                            </div>
                        </div>
                    `;
                } else {
                    // Raw search mode
                    const r = await fetch(API+'/api/tools/'+toolId+'/search', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ query, top_k: 5 })
                    });
                    const data = await r.json();
                    
                    if(data.results?.length) {
                        resultsDiv.innerHTML = `
                            <h4 class="text-sm font-medium text-gray-300 mb-3">Found ${data.results.length} results:</h4>
                            <div class="space-y-3">
                                ${data.results.map((r, i) => `
                                    <div class="bg-gray-800 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs text-purple-400">#${i+1} - Score: ${(r.score * 100).toFixed(1)}%</span>
                                            <span class="text-xs text-gray-500">${r.source || 'Unknown source'}</span>
                                        </div>
                                        <p class="text-sm text-gray-300">${escHtml(r.text?.substring(0, 500) || '')}${r.text?.length > 500 ? '...' : ''}</p>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        resultsDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No results found. Try a different query.</p>';
                    }
                }
            } catch(e) {
                resultsDiv.innerHTML = `<p class="text-red-400">Error: ${e.message}</p>`;
            }
        }
        
        // Keep old function for backward compatibility
        async function testKnowledgeSearch(toolId) {
            document.getElementById('kb-mode-'+toolId).value = 'raw';
            return askKnowledgeBase(toolId);
        }
        
        async function viewPageContent(pageId) {
            try {
                const r = await fetch(API+'/api/scraped-pages/'+pageId);
                const data = await r.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999] p-4';
                modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="bg-[#1e1e2e] rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-gray-700">
                            <h3 class="font-semibold truncate">${data.title || 'Page Content'}</h3>
                            <a href="${data.url}" target="_blank" class="text-xs text-purple-400 hover:underline">${data.url}</a>
                        </div>
                        <div class="p-4 overflow-auto flex-1">
                            <pre class="whitespace-pre-wrap text-sm text-gray-300">${escHtml(data.content || 'No content')}</pre>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-between text-xs text-gray-500">
                            <span>${data.chunks?.length || 0} chunks</span>
                            <span>${(data.content?.length || 0).toLocaleString()} characters</span>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch(e) {
                alert('Failed to load page: ' + e.message);
            }
        }
        
        async function delPage(pageId, toolId) {
            if(!confirm('Delete this page?')) return;
            await fetch(API+'/api/scraped-pages/'+pageId, {
                method:'DELETE',
                headers: getAuthHeaders()
            });
            if(toolId) viewTool(toolId);
            else location.reload();
        }
        
        async function updateApiConfig(toolId) {
            const config = {
                base_url: document.getElementById('api-base-url-'+toolId)?.value,
                endpoint_path: document.getElementById('api-endpoint-'+toolId)?.value,
                http_method: document.getElementById('api-method-'+toolId)?.value,
                auth_type: document.getElementById('api-auth-'+toolId)?.value
            };
            
            try {
                await fetch(API+'/api/tools/'+toolId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ api_config: config })
                });
                alert('âœ… Configuration saved!');
            } catch(e) {
                alert('Failed to save: ' + e.message);
            }
        }
        
        async function saveMockResponse(toolId) {
            const textarea = document.getElementById('mock-response-'+toolId);
            if(!textarea) return;
            
            try {
                const mockResponse = JSON.parse(textarea.value);
                await fetch(API+'/api/tools/'+toolId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ config: { mock_response: mockResponse, demo_mode: true } })
                });
                alert('âœ… Mock response saved!');
            } catch(e) {
                if(e instanceof SyntaxError) {
                    alert('Invalid JSON format. Please check your input.');
                } else {
                    alert('Failed to save: ' + e.message);
                }
            }
        }
        
        async function saveOutputTransform(toolId) {
            const textarea = document.getElementById('output-transform-'+toolId);
            const checkbox = document.getElementById('transform-enabled-'+toolId);
            if(!textarea) return;
            
            const outputTransform = textarea.value.trim();
            const transformEnabled = checkbox?.checked || false;
            
            try {
                // Get current tool config first
                const r = await fetch(API+'/api/tools/'+toolId);
                const tool = await r.json();
                const currentConfig = tool.config || {};
                
                // Update with new transform settings
                await fetch(API+'/api/tools/'+toolId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        config: { 
                            ...currentConfig,
                            output_transform: outputTransform,
                            transform_enabled: transformEnabled
                        } 
                    })
                });
                alert('âœ… Output transformation saved!');
            } catch(e) {
                alert('Failed to save: ' + e.message);
            }
        }
        
        // ========== SMART API TESTING FUNCTIONS ==========
        
        async function analyzeApiParams(toolId) {
            const btn = document.getElementById('btn-analyze-' + toolId);
            const hint = document.getElementById('analyze-hint-' + toolId);
            
            if (btn) {
                btn.innerHTML = '<span class="animate-pulse">ðŸ” AI Analyzing...</span>';
                btn.disabled = true;
            }
            
            try {
                const r = await fetch(API + '/api/tools/' + toolId + '/analyze-params', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await r.json();
                const params = data.parameters;
                
                if (data.error) {
                    alert('Analysis failed: ' + data.error);
                    if (btn) {
                        btn.innerHTML = 'âŒ Failed';
                        setTimeout(() => { btn.innerHTML = 'ðŸ” Analyze Parameters'; btn.disabled = false; }, 2000);
                    }
                    return;
                }
            
                if (params && params.length > 0) {
                    // Update each parameter with smart input options
                    params.forEach(param => {
                        const inputArea = document.getElementById('param-input-area-' + param.name);
                        if (!inputArea) return;
                        
                        // Build smart input based on LLM analysis
                        let inputHtml = `
                            <div class="flex flex-wrap gap-2 mb-2">
                                <button onclick="toggleParamInputMode('${param.name}', 'text')" 
                                        id="btn-text-${param.name}" 
                                        class="text-xs px-2 py-1 rounded bg-purple-600 text-white">
                                    âœï¸ Text
                                </button>
                        `;
                        
                        // Add file upload if LLM suggests it
                        if (param.supports_file_upload) {
                            inputHtml += `
                                <button onclick="toggleParamInputMode('${param.name}', 'file')" 
                                        id="btn-file-${param.name}"
                                        class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-300 hover:bg-gray-600">
                                    ðŸ“„ ${param.file_upload_label || 'Upload File'}
                                </button>
                            `;
                        }
                        
                        // Add quick generate button
                        inputHtml += `
                                <button onclick="quickGenerate('${param.name}', '${toolId}')" 
                                        class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-300 hover:bg-gray-600">
                                    âœ¨ Generate
                                </button>
                            </div>
                        `;
                        
                        // Text input
                        inputHtml += `
                            <div id="input-text-${param.name}">
                                <textarea id="test-param-${param.name}" class="input-field w-full rounded px-3 py-2 text-sm" 
                                          rows="${param.suggested_rows || 2}" 
                                          placeholder="${param.placeholder || 'Enter ' + param.name}...">${param.sample_value || ''}</textarea>
                            </div>
                        `;
                        
                        // File upload area (if LLM suggested)
                        if (param.supports_file_upload) {
                            inputHtml += `
                                <div id="input-file-${param.name}" class="hidden">
                                    <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center hover:border-purple-500 cursor-pointer transition"
                                         onclick="document.getElementById('file-${param.name}').click()">
                                        <input type="file" id="file-${param.name}" class="hidden" 
                                               accept="${param.accepted_files || '.pdf,.doc,.docx,.txt,.csv,.xlsx,.xls,.jpg,.jpeg,.png'}"
                                               onchange="handleParamFileUpload('${param.name}', '${toolId}', event)">
                                        <span class="text-2xl block mb-1">ðŸ“¤</span>
                                        <p class="text-sm text-gray-400">${param.file_upload_hint || 'Upload file to extract data'}</p>
                                        <p class="text-xs text-gray-500">${param.accepted_file_types || 'PDF, Word, Excel, CSV, Images'}</p>
                                    </div>
                                    <div id="file-preview-${param.name}" class="hidden mt-2 bg-gray-900 rounded p-2 text-xs"></div>
                                </div>
                            `;
                        }
                        
                        // Add tip if available
                        if (param.tip) {
                            inputHtml += `<p class="text-xs text-purple-400 mt-2">ðŸ’¡ ${param.tip}</p>`;
                        }
                        
                        inputArea.innerHTML = inputHtml;
                    });
                    
                    // Hide hint
                    if (hint) hint.classList.add('hidden');
                    
                    // Update button
                    if (btn) {
                        btn.innerHTML = 'âœ… Analyzed';
                        setTimeout(() => {
                            btn.innerHTML = 'ðŸ” Re-analyze';
                            btn.disabled = false;
                        }, 2000);
                    }
                } else {
                    if (btn) {
                        btn.innerHTML = 'âŒ No results';
                        setTimeout(() => {
                            btn.innerHTML = 'ðŸ” Analyze Parameters';
                            btn.disabled = false;
                        }, 2000);
                    }
                }
            } catch (e) {
                alert('Analysis error: ' + e.message);
                if (btn) {
                    btn.innerHTML = 'âŒ Failed';
                    setTimeout(() => { btn.innerHTML = 'ðŸ” Analyze Parameters'; btn.disabled = false; }, 2000);
                }
            }
        }
        
        // Quick generate - Pure LLM
        async function quickGenerate(paramName, toolId) {
            const paramInput = document.getElementById('test-param-' + paramName);
            if (!paramInput) return;
            
            // Show loading
            const originalValue = paramInput.value;
            paramInput.value = 'âœ¨ AI Generating...';
            paramInput.disabled = true;
            
            try {
                const r = await fetch(API + '/api/tools/' + toolId + '/generate-param', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ param_name: paramName, prompt: '' })
                });
                
                const data = await r.json();
                
                if (data.generated_data) {
                    paramInput.value = typeof data.generated_data === 'string'
                        ? data.generated_data
                        : JSON.stringify(data.generated_data, null, 2);
                } else if (data.error) {
                    paramInput.value = originalValue;
                    alert('Generation failed: ' + data.error);
                } else {
                    paramInput.value = originalValue;
                    alert('Could not generate data. Check LLM configuration.');
                }
            } catch (e) {
                paramInput.value = originalValue;
                alert('Error: ' + e.message);
            }
            
            paramInput.disabled = false;
            
            // Make sure we're in text mode
            toggleParamInputMode(paramName, 'text');
        }
        
        function toggleParamInputMode(paramName, mode) {
            // Hide all input modes
            ['text', 'file', 'ai'].forEach(m => {
                const inputDiv = document.getElementById('input-' + m + '-' + paramName);
                const btn = document.getElementById('btn-' + m + '-' + paramName);
                if (inputDiv) inputDiv.classList.add('hidden');
                if (btn) {
                    btn.classList.remove('bg-purple-600', 'text-white');
                    btn.classList.add('bg-gray-700', 'text-gray-300');
                }
            });
            
            // Show selected mode
            const selectedInput = document.getElementById('input-' + mode + '-' + paramName);
            const selectedBtn = document.getElementById('btn-' + mode + '-' + paramName);
            if (selectedInput) selectedInput.classList.remove('hidden');
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-gray-700', 'text-gray-300');
                selectedBtn.classList.add('bg-purple-600', 'text-white');
            }
        }
        
        async function handleParamFileUpload(paramName, toolId, event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const previewDiv = document.getElementById('file-preview-' + paramName);
            const paramInput = document.getElementById('test-param-' + paramName);
            
            previewDiv.classList.remove('hidden');
            previewDiv.innerHTML = '<span class="animate-pulse">ðŸ“„ Processing ' + file.name + '...</span>';
            
            try {
                // Read file content
                const fileContent = await readFileContent(file);
                
                // Use LLM to extract relevant data
                const r = await fetch(API + '/api/tools/' + toolId + '/extract-param', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        param_name: paramName,
                        file_name: file.name,
                        file_content: fileContent,
                        file_type: file.type
                    })
                });
                
                const data = await r.json();
                
                if (data.extracted_data) {
                    // Set the extracted data to the parameter input
                    if (paramInput) {
                        paramInput.value = typeof data.extracted_data === 'string' 
                            ? data.extracted_data 
                            : JSON.stringify(data.extracted_data, null, 2);
                    }
                    
                    previewDiv.innerHTML = `
                        <div class="text-green-400 mb-2">âœ… Extracted from ${file.name}</div>
                        <pre class="text-xs text-gray-400 max-h-32 overflow-auto">${escHtml(paramInput?.value || '')}</pre>
                    `;
                    
                    // Switch back to text mode to show the result
                    toggleParamInputMode(paramName, 'text');
                } else {
                    previewDiv.innerHTML = '<span class="text-red-400">âŒ Could not extract data. Try manually entering.</span>';
                }
            } catch (e) {
                previewDiv.innerHTML = '<span class="text-red-400">âŒ Error: ' + e.message + '</span>';
            }
        }
        
        async function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                if (file.type.startsWith('image/')) {
                    reader.onload = () => resolve('[Image file: ' + file.name + ']');
                    reader.readAsDataURL(file);
                } else {
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                }
            });
        }
        
        async function aiGenerateParam(paramName, toolId) {
            const promptInput = document.getElementById('ai-prompt-' + paramName);
            const resultDiv = document.getElementById('ai-result-' + paramName);
            const paramInput = document.getElementById('test-param-' + paramName);
            
            const prompt = promptInput?.value || 'Generate sample data';
            
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="animate-pulse text-gray-400">âœ¨ Generating with AI...</span>';
            
            try {
                const r = await fetch(API + '/api/tools/' + toolId + '/generate-param', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        param_name: paramName,
                        prompt: prompt
                    })
                });
                
                const data = await r.json();
                
                if (data.generated_data) {
                    if (paramInput) {
                        paramInput.value = typeof data.generated_data === 'string'
                            ? data.generated_data
                            : JSON.stringify(data.generated_data, null, 2);
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="text-green-400 mb-2">âœ… Generated successfully!</div>
                        <button onclick="toggleParamInputMode('${paramName}', 'text')" class="text-xs text-purple-400 hover:underline">
                            View & Edit â†’
                        </button>
                    `;
                } else if (data.error) {
                    resultDiv.innerHTML = `<span class="text-red-400">âŒ ${data.error}</span>`;
                } else {
                    resultDiv.innerHTML = '<span class="text-red-400">âŒ Could not generate data. Check LLM configuration.</span>';
                }
            } catch (e) {
                resultDiv.innerHTML = '<span class="text-red-400">âŒ Error: ' + e.message + '</span>';
            }
        }
        
        async function autoFillTestData(toolId) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse">âœ¨ AI Generating...</span>';
            btn.disabled = true;
            
            try {
                const r = await fetch(API + '/api/tools/' + toolId + '/auto-fill-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await r.json();
                
                if (data.parameters && Object.keys(data.parameters).length > 0) {
                    // Fill in all parameters from server
                    Object.entries(data.parameters).forEach(([name, value]) => {
                        const input = document.getElementById('test-param-' + name);
                        if (input) {
                            input.value = typeof value === 'string' ? value : JSON.stringify(value, null, 2);
                        }
                    });
                    
                    btn.innerHTML = 'âœ… Filled!';
                    setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
                } else if (data.error) {
                    alert('Failed to auto-fill: ' + data.error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                } else {
                    alert('Could not generate data. Check LLM configuration.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                alert('Error: ' + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function testApiCall(toolId) {
            const resultsDiv = document.getElementById('api-test-result-'+toolId);
            const pre = resultsDiv?.querySelector('pre');
            if(!pre) return;
            
            resultsDiv.classList.remove('hidden');
            pre.textContent = 'Calling API...';
            pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm';
            
            // Collect parameters
            const params = {};
            document.querySelectorAll('[id^="test-param-"]').forEach(input => {
                const name = input.id.replace('test-param-', '');
                if(input.value) {
                    // Try to parse JSON values
                    try {
                        params[name] = JSON.parse(input.value);
                    } catch {
                        params[name] = input.value;
                    }
                }
            });
            
            // Check if output transformation is enabled
            const transformEnabled = document.getElementById('transform-enabled-'+toolId)?.checked;
            const outputTransform = document.getElementById('output-transform-'+toolId)?.value?.trim();
            
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        parameters: params,
                        apply_transform: transformEnabled && outputTransform ? true : false,
                        transform_instructions: outputTransform
                    })
                });
                const data = await r.json();
                
                // Check if there's a transformed response
                if (data.transformed_response !== undefined) {
                    // Show both original and transformed
                    resultsDiv.innerHTML = `
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-sm font-medium text-purple-400 mb-2">âœ¨ Transformed Response:</h4>
                                <pre class="bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm text-green-400">${escHtml(
                                    typeof data.transformed_response === 'string' 
                                        ? data.transformed_response 
                                        : JSON.stringify(data.transformed_response, null, 2)
                                )}</pre>
                            </div>
                            <details class="text-sm">
                                <summary class="text-gray-500 cursor-pointer hover:text-gray-300">View Original Response</summary>
                                <pre class="bg-gray-800 rounded-lg p-4 overflow-x-auto text-xs text-gray-400 mt-2">${escHtml(JSON.stringify(data.original_response || data.response, null, 2))}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    pre.textContent = JSON.stringify(data, null, 2);
                    pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm text-green-400';
                }
            } catch(e) {
                pre.textContent = 'Error: ' + e.message;
                pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm text-red-400';
            }
        }
        
        async function saveToolConfig(toolId) {
            const name = document.getElementById('tool-name-'+toolId)?.value;
            const description = document.getElementById('tool-desc-'+toolId)?.value;
            const configText = document.getElementById('tool-config-'+toolId)?.value;
            
            let config = {};
            try {
                config = JSON.parse(configText || '{}');
            } catch(e) {
                alert('Invalid JSON in configuration');
                return;
            }
            
            try {
                await fetch(API+'/api/tools/'+toolId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, description, config })
                });
                alert('âœ… Configuration saved!');
            } catch(e) {
                alert('Failed to save: ' + e.message);
            }
        }
        
        async function testGenericTool(toolId) {
            const resultsDiv = document.getElementById('tool-test-result-'+toolId);
            const pre = resultsDiv?.querySelector('pre');
            if(!pre) return;
            
            resultsDiv.classList.remove('hidden');
            pre.textContent = 'Testing...';
            pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm';
            
            const inputText = document.getElementById('tool-test-input-'+toolId)?.value || '{}';
            let input = {};
            try {
                input = JSON.parse(inputText);
            } catch(e) {
                pre.textContent = 'Invalid JSON input';
                pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm text-red-400';
                return;
            }
            
            try {
                const r = await fetch(API+'/api/tools/'+toolId+'/test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ parameters: input })
                });
                const data = await r.json();
                pre.textContent = JSON.stringify(data, null, 2);
                pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm text-green-400';
            } catch(e) {
                pre.textContent = 'Error: ' + e.message;
                pre.className = 'bg-gray-900 rounded-lg p-4 overflow-x-auto text-sm text-red-400';
            }
        }
        async function scrape(tid){
            const url=document.getElementById('scrape-url').value;
            const rec=document.getElementById('scrape-rec').checked;
            const max=parseInt(document.getElementById('scrape-max').value);
            if(!url){alert('Enter URL');return;}
            
            // Show progress modal
            showProgressModal('Scraping website...');
            
            // Check if it's a dynamic site
            const dynamicSites = ['oracle.com', 'azure.microsoft.com', 'cloud.google.com', 'aws.amazon.com'];
            const isDynamic = dynamicSites.some(site => url.includes(site));
            
            if(isDynamic) {
                // Simulate progress for dynamic sites
                const steps = [
                    'ðŸŽ­ [1/7] Launching Chromium browser...',
                    'ðŸŽ­ [2/7] Creating browser context...',
                    'ðŸŽ­ [3/7] Navigating to page...',
                    'ðŸŽ­ [4/7] Waiting for JavaScript to render...',
                    'ðŸŽ­ [5/7] Scrolling to load dynamic content...',
                    'ðŸŽ­ [6/7] Extracting rendered HTML...',
                    'ðŸ“Š Extracting tables and pricing data...'
                ];
                let stepIndex = 0;
                const progressInterval = setInterval(() => {
                    if(stepIndex < steps.length) {
                        updateProgress((stepIndex + 1) / steps.length * 90, steps[stepIndex]);
                        stepIndex++;
                    }
                }, 4000);
                
                try {
                    await fetch(API+'/api/tools/'+tid+'/scrape',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url,recursive:rec,max_pages:max})});
                    clearInterval(progressInterval);
                    updateProgress(100, 'âœ… Scraping complete!');
                    await new Promise(r => setTimeout(r, 1000));
                    hideProgressModal();
                    viewTool(tid);
                } catch(e) {
                    clearInterval(progressInterval);
                    hideProgressModal();
                    alert('Error scraping: ' + e.message);
                }
            } else {
                updateProgress(30, 'ðŸ“„ Fetching page content...');
                try {
                    await fetch(API+'/api/tools/'+tid+'/scrape',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url,recursive:rec,max_pages:max})});
                    updateProgress(100, 'âœ… Scraping complete!');
                    await new Promise(r => setTimeout(r, 1000));
                    hideProgressModal();
                    viewTool(tid);
                } catch(e) {
                    hideProgressModal();
                    alert('Error scraping: ' + e.message);
                }
            }
        }
        async function delPage(id){if(!confirm('Delete page?'))return;await fetch(API+'/api/scraped-pages/'+id,{method:'DELETE',headers:getAuthHeaders()});location.reload();}
        async function delTool(id){
            if(!confirm('Delete this tool?')) return;
            try {
                const res = await fetch(API+'/api/tools/'+id, {
                    method:'DELETE',
                    headers: getAuthHeaders()
                });
                if (!res.ok) {
                    const error = await res.json();
                    showToast(error.detail || 'Failed to delete tool', 'error');
                    return;
                }
                showToast('Tool deleted', 'success');
                navigate('tools');
            } catch(e) {
                showToast('Failed to delete: ' + e.message, 'error');
            }
        }
        
        async function delToolFromCard(id, name){
            if(!confirm('Delete tool "' + name + '"?')) return;
            try {
                const res = await fetch(API+'/api/tools/'+id, {
                    method:'DELETE',
                    headers: getAuthHeaders()
                });
                if (!res.ok) {
                    const error = await res.json();
                    showToast(error.detail || 'Failed to delete tool', 'error');
                    return;
                }
                showToast('Tool deleted', 'success');
                loadTools();
            } catch(e) {
                showToast('Failed to delete: ' + e.message, 'error');
            }
        }
        
        // Edit tool - opens wizard with existing data
        let editingToolId = null;
        
        async function editTool(id) {
            try {
                const r = await fetch(API + '/api/tools/' + id);
                if (!r.ok) {
                    showToast('Failed to load tool', 'error');
                    return;
                }
                const tool = await r.json();
                
                editingToolId = id;
                
                // Open modal and start wizard for this tool type
                showModal('modal-tool');
                startWizard(tool.type);
                
                // Update modal title to show we're editing
                const titleEl = document.getElementById('wizard-title');
                if (titleEl) {
                    titleEl.textContent = `Edit: ${tool.name}`;
                }
                const subtitleEl = document.getElementById('wizard-subtitle');
                if (subtitleEl) {
                    subtitleEl.textContent = 'Editing existing tool';
                }
                
                // Pre-fill common fields (wiz-name and wiz-desc are used in step 1)
                setTimeout(() => {
                    const nameEl = document.getElementById('wiz-name');
                    const descEl = document.getElementById('wiz-desc');
                    if (nameEl) nameEl.value = tool.name || '';
                    if (descEl) descEl.value = tool.description || '';
                    
                    // Pre-fill type-specific config in step 2
                    prefillToolConfig(tool);
                    
                    // Pre-fill access control data
                    prefillAccessControl(tool);
                    
                    // Update the Create button to say Update
                    const createBtn = document.getElementById('btn-create');
                    if (createBtn) {
                        createBtn.textContent = 'âœ“ Update Tool';
                        createBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        createBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }
                }, 100);
                
                showToast('Editing: ' + tool.name, 'info');
                
            } catch(e) {
                console.error('Error loading tool for edit:', e);
                showToast('Failed to load tool: ' + e.message, 'error');
            }
        }
        
        // Pre-fill tool-specific configuration fields
        function prefillToolConfig(tool) {
            const config = tool.config || {};
            
            switch(tool.type) {
                case 'api':
                    // API configuration can be in either api_config or config
                    // Check api_config first (proper API tools), then fall back to config
                    const apiCfg = tool.api_config || config || {};
                    
                    // API tool fields - use CORRECT element IDs from the wizard form
                    const apiBase = document.getElementById('api-url');  // NOT api-base-url!
                    const apiPath = document.getElementById('api-path');
                    const apiMethod = document.getElementById('api-method');
                    const apiAuth = document.getElementById('api-auth');
                    const apiAuthValue = document.getElementById('api-auth-val');  // NOT api-auth-value!
                    
                    // Get values from api_config first, then config
                    const baseUrl = apiCfg.base_url || config.base_url || '';
                    const endpointPath = apiCfg.endpoint_path || apiCfg.endpoint || config.endpoint_path || config.endpoint || '';
                    const httpMethod = apiCfg.http_method || apiCfg.method || config.http_method || config.method || 'GET';
                    const authType = apiCfg.auth_type || config.auth_type || 'none';
                    const authValue = apiCfg.auth_value || config.auth_value || '';
                    
                    if (apiBase) apiBase.value = baseUrl;
                    if (apiPath) apiPath.value = endpointPath;
                    if (apiMethod) apiMethod.value = httpMethod;
                    if (apiAuth) {
                        apiAuth.value = authType;
                        // Show auth value field if not 'none'
                        const authValGroup = document.getElementById('api-auth-val-group');
                        if (authValGroup && authType !== 'none') {
                            authValGroup.classList.remove('hidden');
                        }
                    }
                    if (apiAuthValue) apiAuthValue.value = authValue;
                    
                    // Load parameters from api_config or config
                    const inputParams = apiCfg.input_parameters || config.input_parameters || [];
                    if (inputParams && Array.isArray(inputParams) && inputParams.length > 0) {
                        apiParams = inputParams.map(p => ({
                            id: Date.now() + Math.random(),
                            name: p.name || '',
                            description: p.description || '',
                            data_type: p.data_type || 'string',
                            required: p.required || false,
                            location: p.location || 'query'
                        }));
                        // Render the parameters in the UI
                        setTimeout(() => {
                            if (typeof renderApiParams === 'function') renderApiParams();
                        }, 200);
                    }
                    
                    console.log('ðŸ“ Prefilled API config:', {
                        source: tool.api_config ? 'api_config' : 'config',
                        base_url: baseUrl,
                        endpoint: endpointPath,
                        method: httpMethod,
                        auth: authType,
                        params_count: inputParams.length,
                        elements_found: {
                            'api-url': !!apiBase,
                            'api-path': !!apiPath,
                            'api-method': !!apiMethod,
                            'api-auth': !!apiAuth
                        }
                    });
                    break;
                    
                case 'website':
                    const webUrl = document.getElementById('web-url');
                    const webRecursive = document.getElementById('web-recursive');
                    const webMax = document.getElementById('web-max');
                    if (webUrl) webUrl.value = config.url || config.base_url || '';
                    if (webRecursive) webRecursive.checked = config.recursive || false;
                    if (webMax) webMax.value = config.max_pages || 10;
                    
                    // Show existing scraped pages in the configuration section
                    const scrapedPages = tool.scraped_pages || [];
                    const scrapedContainer = document.getElementById('web-scraped-pages');
                    const scrapedList = document.getElementById('web-scraped-list');
                    
                    if (scrapedPages.length > 0 && scrapedContainer && scrapedList) {
                        scrapedContainer.classList.remove('hidden');
                        scrapedList.innerHTML = scrapedPages.map(p => `
                            <div class="flex items-center justify-between bg-gray-800/50 rounded-lg p-2">
                                <div class="flex items-center gap-2 min-w-0 flex-1">
                                    <span>ðŸ”—</span>
                                    <a href="${escHtml(p.url)}" target="_blank" class="text-sm text-blue-400 hover:underline truncate">${escHtml(p.url || p.title || 'Page')}</a>
                                </div>
                                <span class="text-xs text-gray-500 ml-2">${p.chunks_extracted || 0} chunks</span>
                            </div>
                        `).join('');
                    } else if (scrapedContainer) {
                        scrapedContainer.classList.add('hidden');
                    }
                    
                    console.log('ðŸ“ Prefilled Website config:', {
                        url: config.url,
                        scraped_pages: scrapedPages.length
                    });
                    break;
                    
                case 'database':
                    const dbType = document.getElementById('db-type');
                    const dbHost = document.getElementById('db-host');
                    const dbPort = document.getElementById('db-port');
                    const dbUser = document.getElementById('db-user');
                    const dbPass = document.getElementById('db-password');
                    const dbName = document.getElementById('db-database');
                    
                    if (dbType) dbType.value = config.db_type || 'postgresql';
                    if (dbHost) dbHost.value = config.host || '';
                    if (dbPort) dbPort.value = config.port || '';
                    if (dbUser) dbUser.value = config.user || config.username || '';
                    if (dbPass) dbPass.value = config.password || '';
                    if (dbName) dbName.value = config.database || '';
                    break;
                    
                case 'knowledge':
                    const kbCollection = document.getElementById('kb-collection');
                    const kbChunkSize = document.getElementById('kb-chunk-size');
                    const kbTopK = document.getElementById('kb-top-k');
                    
                    if (kbCollection) kbCollection.value = config.collection_id || '';
                    if (kbChunkSize) kbChunkSize.value = config.chunk_size || 1000;
                    if (kbTopK) kbTopK.value = config.top_k || 5;
                    break;
                    
                case 'email':
                    const emailProvider = document.getElementById('email-provider');
                    const smtpHost = document.getElementById('smtp-host');
                    const smtpPort = document.getElementById('smtp-port');
                    
                    if (emailProvider) emailProvider.value = config.provider || 'smtp';
                    if (smtpHost) smtpHost.value = config.smtp_host || config.host || '';
                    if (smtpPort) smtpPort.value = config.smtp_port || config.port || '';
                    break;
                    
                case 'webhook':
                    const webhookUrl = document.getElementById('webhook-url');
                    const webhookMethod = document.getElementById('webhook-method');
                    
                    if (webhookUrl) webhookUrl.value = config.url || '';
                    if (webhookMethod) webhookMethod.value = config.method || 'POST';
                    break;
                    
                case 'websearch':
                    const searchProvider = document.getElementById('search-provider');
                    const searchKey = document.getElementById('search-api-key');
                    
                    if (searchProvider) searchProvider.value = config.provider || 'tavily';
                    if (searchKey) searchKey.value = config.api_key || '';
                    break;
                    
                default:
                    console.log('No specific config prefill for type:', tool.type);
            }
            
            // Prefill Access Control is now handled by prefillAccessControl function
        }
        
        // Prefill Access Control when editing a tool
        async function prefillAccessControl(tool) {
            if (!tool) return;
            
            const accessType = tool.access_type || 'owner_only';
            selectedToolAccessType = accessType;
            
            // Reset selections
            toolAccessSelected = { users: [], groups: [] };
            toolPermissionChips = { edit: [], delete: [], execute: [] };
            
            // Load users and groups data first
            await loadToolAccessUsersAndGroups();
            
            // Wait for DOM to be ready
            setTimeout(() => {
                // Select the access type in UI
                selectToolAccessType(accessType);
                
                // Populate allowed users
                if (tool.allowed_user_ids && tool.allowed_user_ids.length > 0) {
                    tool.allowed_user_ids.forEach(userId => {
                        const user = toolAccessData.users.find(u => u.id === userId);
                        if (user) {
                            toolAccessSelected.users.push({
                                id: user.id,
                                name: user.full_name || user.email || user.username,
                                email: user.email || '',
                                type: 'user'
                            });
                        }
                    });
                }
                
                // Populate allowed groups
                if (tool.allowed_group_ids && tool.allowed_group_ids.length > 0) {
                    tool.allowed_group_ids.forEach(groupId => {
                        const group = toolAccessData.groups.find(g => g.id === groupId);
                        if (group) {
                            toolAccessSelected.groups.push({
                                id: group.id,
                                name: group.name,
                                email: '',
                                type: 'group'
                            });
                        }
                    });
                }
                
                // Populate granular permissions
                ['edit', 'delete', 'execute'].forEach(permType => {
                    const field = `can_${permType}_user_ids`;
                    if (tool[field] && tool[field].length > 0) {
                        tool[field].forEach(id => {
                            if (id.startsWith('group:')) {
                                const groupId = id.replace('group:', '');
                                const group = toolAccessData.groups.find(g => g.id === groupId);
                                if (group) {
                                    toolPermissionChips[permType].push({ id: group.id, name: group.name, entityType: 'group' });
                                }
                            } else {
                                const user = toolAccessData.users.find(u => u.id === id);
                                if (user) {
                                    toolPermissionChips[permType].push({ id: user.id, name: user.full_name || user.email || user.username, entityType: 'user' });
                                }
                            }
                        });
                    }
                });
                
                // Update the UI
                updateToolAccessChips();
                updateToolPermissionDropdowns();
                
                // Render permission chips
                ['edit', 'delete', 'execute'].forEach(permType => {
                    if (typeof updatePermissionChipsDisplay === 'function') {
                        updatePermissionChipsDisplay(permType);
                    }
                });
                
                console.log('ðŸ“ [PREFILL] Access Control loaded:', {
                    access_type: accessType,
                    users: toolAccessSelected.users.length,
                    groups: toolAccessSelected.groups.length,
                    editPerms: toolPermissionChips.edit.length
                });
            }, 300);
        }
        
        function toggleToolMenu(toolId) {
            closeAllToolMenus();
            const menu = document.getElementById('tool-menu-' + toolId);
            if(menu) menu.classList.toggle('hidden');
        }
        
        function closeAllToolMenus() {
            document.querySelectorAll('[id^="tool-menu-"]').forEach(m => m.classList.add('hidden'));
        }
        
        async function duplicateTool(toolId) {
            try {
                const r = await fetch(API + '/api/tools/' + toolId);
                const tool = await r.json();
                const newTool = {
                    name: tool.name + ' (Copy)',
                    description: tool.description,
                    type: tool.type,
                    config: tool.config
                };
                const resp = await fetch(API + '/api/tools', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(newTool)
                });
                if(resp.ok) {
                    showToast('Tool duplicated', 'success');
                    loadTools();
                } else {
                    showToast('Failed to duplicate', 'error');
                }
            } catch(e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

// Tool Selection Pattern
let selectedToolId = null;

function selectTool(toolId) {
    const card = document.querySelector(`[data-tool-id="${toolId}"]`);
    const toolName = card?.dataset.toolName || 'Tool';
    
    // If same tool clicked, deselect
    if (selectedToolId === toolId) {
        clearToolSelection();
        return;
    }
    
    // Clear previous selection
    document.querySelectorAll('.tool-card').forEach(c => c.classList.remove('ring-2', 'ring-purple-500'));
    
    // Select new tool
    selectedToolId = toolId;
    card?.classList.add('ring-2', 'ring-purple-500');
    
    // Show action bar
    document.getElementById('selected-tool-name').textContent = toolName;
    document.getElementById('tools-action-bar').classList.remove('hidden');
    
    // Apply permissions
    if (typeof applyPermissions === 'function') applyPermissions();
}

function clearToolSelection() {
    selectedToolId = null;
    document.querySelectorAll('.tool-card').forEach(c => c.classList.remove('ring-2', 'ring-purple-500'));
    document.getElementById('tools-action-bar').classList.add('hidden');
}

function viewSelectedTool() {
    if (selectedToolId) {
        clearToolSelection();
        viewTool(selectedToolId);
    }
}

function editSelectedTool() {
    if (selectedToolId) {
        const id = selectedToolId;
        clearToolSelection();
        openToolEditPanel(id);
    }
}

function duplicateSelectedTool() {
    if (selectedToolId) {
        const id = selectedToolId;
        clearToolSelection();
        duplicateTool(id);
    }
}

function deleteSelectedTool() {
    if (selectedToolId) {
        const card = document.querySelector(`[data-tool-id="${selectedToolId}"]`);
        const toolName = card?.dataset.toolName || 'this tool';
        const id = selectedToolId;
        clearToolSelection();
        delToolFromCard(id, toolName);
    }
}

// Clear selection when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.tool-card') && !e.target.closest('#tools-action-bar')) {
        clearToolSelection();
    }
});

// Clear selection on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') clearToolSelection();
});
        
        // Close menus when clicking outside
        document.addEventListener('click', () => closeAllToolMenus());

// Edit Tool Modal

// Tool Edit Panel Functions
let currentEditTool = null;

async function openToolEditPanel(toolId) {
    try {
        const r = await fetch(API + '/api/tools/' + toolId);
        if (!r.ok) throw new Error('Failed to load tool');
        currentEditTool = await r.json();
        
        const icons = {document:'ðŸ“„', website:'ðŸŒ', api:'ðŸ”Œ', knowledge:'ðŸ“š', email:'ðŸ“§', webhook:'ðŸ”—', websearch:'ðŸ”', database:'ðŸ—„ï¸'};
        
        // Set basic fields
        document.getElementById('edit-tool-id').value = currentEditTool.id;
        document.getElementById('edit-tool-type').value = currentEditTool.type;
        document.getElementById('edit-tool-name').value = currentEditTool.name || '';
        document.getElementById('edit-tool-desc').value = currentEditTool.description || '';
        document.getElementById('edit-tool-active').checked = currentEditTool.is_active !== false;
        document.getElementById('edit-panel-icon').textContent = icons[currentEditTool.type] || 'ðŸ”§';
        document.getElementById('edit-panel-type').textContent = currentEditTool.type.toUpperCase();
        
        // Load config fields based on type
        loadEditConfigFields(currentEditTool);
        
        // Load sources
        loadEditSources(currentEditTool);
        
        // Load access control data
        await loadEditAccessControl(currentEditTool);
        
        // Show panel with animation
        const panel = document.getElementById('tool-edit-panel');
        const slider = document.getElementById('tool-edit-slider');
        panel.classList.remove('hidden');
        setTimeout(() => slider.classList.remove('translate-x-full'), 10);
        
        // Reset to first tab
        switchEditTab('basic');
        
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

function closeToolEditPanel() {
    const panel = document.getElementById('tool-edit-panel');
    const slider = document.getElementById('tool-edit-slider');
    slider.classList.add('translate-x-full');
    setTimeout(() => panel.classList.add('hidden'), 300);
    currentEditTool = null;
}

async function loadEditAccessControl(tool) {
    // First load users and groups data
    await loadToolAccessUsersAndGroups();
    
    // Set access type
    const accessType = tool.access_type || 'owner_only';
    selectedToolAccessType = accessType;
    
    // Reset selections
    toolAccessSelected = { users: [], groups: [] };
    toolPermissionChips = { edit: [], delete: [], execute: [] };
    
    // Populate allowed users
    console.log('ðŸ” [DEBUG] tool.allowed_user_ids:', tool.allowed_user_ids);
    console.log('ðŸ” [DEBUG] toolAccessData.users:', toolAccessData.users.map(u => ({id: u.id, email: u.email})));
    
    if (tool.allowed_user_ids && tool.allowed_user_ids.length > 0) {
        tool.allowed_user_ids.forEach(userId => {
            console.log('ðŸ” [DEBUG] Looking for userId:', userId);
            const user = toolAccessData.users.find(u => u.id === userId);
            console.log('ðŸ” [DEBUG] Found user:', user);
            if (user) {
                toolAccessSelected.users.push({
                    id: user.id,
                    name: user.full_name || user.email || user.username,
                    email: user.email || '',
                    type: 'user'
                });
            }
        });
    }
    
    // Populate allowed groups
    if (tool.allowed_group_ids && tool.allowed_group_ids.length > 0) {
        tool.allowed_group_ids.forEach(groupId => {
            const group = toolAccessData.groups.find(g => g.id === groupId);
            if (group) {
                toolAccessSelected.groups.push({
                    id: group.id,
                    name: group.name,
                    email: '',
                    type: 'group'
                });
            }
        });
    }
    
    // Populate granular permissions
    ['edit', 'delete', 'execute'].forEach(permType => {
        const field = `can_${permType}_user_ids`;
        if (tool[field] && tool[field].length > 0) {
            tool[field].forEach(id => {
                if (id.startsWith('group:')) {
                    const groupId = id.replace('group:', '');
                    const group = toolAccessData.groups.find(g => g.id === groupId);
                    if (group) {
                        toolPermissionChips[permType].push({ id: group.id, name: group.name, entityType: 'group' });
                    }
                } else {
                    const user = toolAccessData.users.find(u => u.id === id);
                    if (user) {
                        toolPermissionChips[permType].push({ id: user.id, name: user.full_name || user.email || user.username, entityType: 'user' });
                    }
                }
            });
        }
    });
    
    // Update Edit Panel UI
    const isOwner = tool.is_owner === true;
    updateEditAccessUI(accessType, isOwner);
    
    console.log('ðŸ“‹ [LOAD EDIT] Access Control loaded:', { accessType, users: toolAccessSelected.users.length, groups: toolAccessSelected.groups.length, editPerms: toolPermissionChips.edit.length, isOwner });
}

// Update the Edit Panel Access UI
function updateEditAccessUI(accessType, isOwner) {
    const typeLabels = {
        'owner_only': { icon: 'ðŸ‘¤', label: 'Owner Only', desc: 'Only you can access this tool' },
        'authenticated': { icon: 'ðŸ¢', label: 'All Logged In Users', desc: 'Any authenticated user can access' },
        'specific_users': { icon: 'ðŸ‘¥', label: 'Specific Users & Groups', desc: 'Only selected users/groups can access' },
        'public': { icon: 'ðŸŒ', label: 'Public', desc: 'Everyone can access this tool' }
    };
    
    const typeInfo = typeLabels[accessType] || typeLabels['owner_only'];
    
    // Show access type display
    const typeDisplay = document.getElementById('edit-access-type-display');
    if (typeDisplay) {
        typeDisplay.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="text-2xl">${typeInfo.icon}</span>
                <div>
                    <div class="font-medium" style="color: #1f2937;">${typeInfo.label}</div>
                    <div class="text-xs" style="color: #6b7280;">${typeInfo.desc}</div>
                </div>
            </div>
        `;
    }
    
    // Show/hide entities section for specific_users
    const entitiesSection = document.getElementById('edit-access-entities');
    if (entitiesSection) {
        if (accessType === 'specific_users') {
            entitiesSection.classList.remove('hidden');
            
            // Show chips
            const chipsDisplay = document.getElementById('edit-access-chips-display');
            if (chipsDisplay) {
                const allSelected = [...toolAccessSelected.users, ...toolAccessSelected.groups];
                if (allSelected.length === 0) {
                    chipsDisplay.innerHTML = '<span class="text-sm italic" style="color: #9ca3af;">No users or groups assigned</span>';
                } else {
                    chipsDisplay.innerHTML = allSelected.map(e => `
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs" 
                              style="background: ${e.type === 'group' ? '#dbeafe' : '#ede9fe'}; color: ${e.type === 'group' ? '#1e40af' : '#5b21b6'}; border: 1px solid ${e.type === 'group' ? '#93c5fd' : '#c4b5fd'};">
                            ${e.type === 'group' ? 'ðŸ‘¥' : 'ðŸ‘¤'} ${e.name}
                        </span>
                    `).join('');
                }
            }
            
            // Show granular permissions
            ['edit', 'delete'].forEach(permType => {
                const permDiv = document.getElementById(`edit-perm-${permType}`);
                const permList = document.getElementById(`edit-perm-${permType}-list`);
                if (permDiv && permList) {
                    const perms = toolPermissionChips[permType];
                    if (perms.length > 0) {
                        permDiv.classList.remove('hidden');
                        permList.textContent = perms.map(p => `${p.entityType === 'group' ? 'ðŸ‘¥' : 'ðŸ‘¤'} ${p.name}`).join(', ');
                    } else {
                        permDiv.classList.add('hidden');
                    }
                }
            });
        } else {
            entitiesSection.classList.add('hidden');
        }
    }
    
    // Show owner controls or readonly message
    const ownerControls = document.getElementById('edit-access-owner-controls');
    const readonlyMsg = document.getElementById('edit-access-readonly-msg');
    
    if (isOwner) {
        if (ownerControls) ownerControls.classList.remove('hidden');
        if (readonlyMsg) readonlyMsg.classList.add('hidden');
        
        // Update access type cards
        document.querySelectorAll('.edit-access-card').forEach(card => {
            const cardType = card.dataset.access;
            const check = card.querySelector('.tool-access-check');
            if (cardType === accessType) {
                card.style.borderColor = '#7c3aed';
                card.style.background = '#f3e8ff';
                if (check) check.classList.remove('hidden');
            } else {
                card.style.borderColor = '#d1d5db';
                card.style.background = '#ffffff';
                if (check) check.classList.add('hidden');
            }
        });
        
        // Show/hide specific config
        const specificConfig = document.getElementById('edit-specific-config');
        if (specificConfig) {
            if (accessType === 'specific_users') {
                specificConfig.classList.remove('hidden');
                updateEditSelectedChips();
                updateEditPermDropdowns();
            } else {
                specificConfig.classList.add('hidden');
            }
        }
    } else {
        if (ownerControls) ownerControls.classList.add('hidden');
        if (readonlyMsg) readonlyMsg.classList.remove('hidden');
    }
}

// Select access type in edit panel
function selectEditAccessType(accessType) {
    selectedToolAccessType = accessType;
    updateEditAccessUI(accessType, true);
}

// Filter search in edit panel
function filterEditAccessSearch(query) {
    const resultsDiv = document.getElementById('edit-access-results');
    if (!resultsDiv) return;
    
    const q = query.toLowerCase();
    let html = '';
    
    const filteredUsers = toolAccessData.users.filter(u => {
        const name = (u.full_name || u.email || u.username || '').toLowerCase();
        return name.includes(q) || (u.email || '').toLowerCase().includes(q);
    }).slice(0, 5);
    
    const filteredGroups = toolAccessData.groups.filter(g => (g.name || '').toLowerCase().includes(q)).slice(0, 3);
    
    if (filteredUsers.length > 0) {
        html += `<div class="px-3 py-1 text-xs font-medium" style="background: #e5e7eb; color: #374151;">ðŸ‘¤ Users</div>`;
        filteredUsers.forEach(u => {
            const isSelected = toolAccessSelected.users.some(s => s.id === u.id);
            const name = u.full_name || u.email || u.username;
            html += `<div class="px-3 py-2 cursor-pointer flex items-center justify-between" style="background: ${isSelected ? '#ede9fe' : '#ffffff'};" 
                         onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='${isSelected ? '#ede9fe' : '#ffffff'}'"
                         onclick="toggleEditAccessEntity('user', '${u.id}', '${name.replace(/'/g, "\\'")}', '${(u.email || '').replace(/'/g, "\\'")}')">
                        <span class="text-sm" style="color: #1f2937;">${name}</span>
                        ${isSelected ? '<span style="color: #059669;">âœ“</span>' : '<span style="color: #9ca3af;">+</span>'}
                    </div>`;
        });
    }
    
    if (filteredGroups.length > 0) {
        html += `<div class="px-3 py-1 text-xs font-medium" style="background: #e5e7eb; color: #374151;">ðŸ‘¥ Groups</div>`;
        filteredGroups.forEach(g => {
            const isSelected = toolAccessSelected.groups.some(s => s.id === g.id);
            html += `<div class="px-3 py-2 cursor-pointer flex items-center justify-between" style="background: ${isSelected ? '#dbeafe' : '#ffffff'};"
                         onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='${isSelected ? '#dbeafe' : '#ffffff'}'"
                         onclick="toggleEditAccessEntity('group', '${g.id}', '${(g.name || '').replace(/'/g, "\\'")}', '')">
                        <span class="text-sm" style="color: #1f2937;">${g.name}</span>
                        ${isSelected ? '<span style="color: #059669;">âœ“</span>' : '<span style="color: #9ca3af;">+</span>'}
                    </div>`;
        });
    }
    
    if (!html) html = '<div class="px-3 py-4 text-center text-sm" style="color: #9ca3af;">No results</div>';
    resultsDiv.innerHTML = html;
}

function showEditAccessResults() {
    const resultsDiv = document.getElementById('edit-access-results');
    if (resultsDiv) {
        resultsDiv.classList.remove('hidden');
        filterEditAccessSearch(document.getElementById('edit-access-search')?.value || '');
    }
}

function toggleEditAccessEntity(type, id, name, email) {
    const list = type === 'user' ? toolAccessSelected.users : toolAccessSelected.groups;
    const idx = list.findIndex(e => e.id === id);
    
    if (idx >= 0) {
        list.splice(idx, 1);
    } else {
        list.push({ id, name, email, type });
    }
    
    updateEditSelectedChips();
    updateEditPermDropdowns();
    filterEditAccessSearch(document.getElementById('edit-access-search')?.value || '');
}

function updateEditSelectedChips() {
    const container = document.getElementById('edit-selected-chips');
    const countBadge = document.getElementById('edit-selected-count');
    if (!container) return;
    
    const allSelected = [...toolAccessSelected.users, ...toolAccessSelected.groups];
    
    if (allSelected.length === 0) {
        container.innerHTML = '<span class="text-sm italic" style="color: #9ca3af;">No users or groups selected</span>';
    } else {
        container.innerHTML = allSelected.map(e => `
            <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs"
                 style="background: ${e.type === 'group' ? '#dbeafe' : '#ede9fe'}; color: ${e.type === 'group' ? '#1e40af' : '#5b21b6'}; border: 1px solid ${e.type === 'group' ? '#93c5fd' : '#c4b5fd'};">
                ${e.type === 'group' ? 'ðŸ‘¥' : 'ðŸ‘¤'} ${e.name}
                <button onclick="toggleEditAccessEntity('${e.type}', '${e.id}', '', '')" style="margin-left: 4px;">Ã—</button>
            </div>
        `).join('');
    }
    
    if (countBadge) countBadge.textContent = allSelected.length;
    
    // Also update the summary view
    const summaryChips = document.getElementById('edit-access-chips-display');
    if (summaryChips && allSelected.length > 0) {
        summaryChips.innerHTML = allSelected.map(e => `
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs" 
                  style="background: ${e.type === 'group' ? '#dbeafe' : '#ede9fe'}; color: ${e.type === 'group' ? '#1e40af' : '#5b21b6'};">
                ${e.type === 'group' ? 'ðŸ‘¥' : 'ðŸ‘¤'} ${e.name}
            </span>
        `).join('');
    }
}

function updateEditPermDropdowns() {
    const allSelected = [...toolAccessSelected.users, ...toolAccessSelected.groups];
    
    ['edit', 'delete'].forEach(permType => {
        const select = document.getElementById(`edit-can-${permType}-select`);
        const chipsDiv = document.getElementById(`edit-can-${permType}-chips`);
        
        if (select) {
            let options = '<option value="">+ Add</option>';
            if (toolAccessSelected.users.length > 0) {
                options += '<optgroup label="ðŸ‘¤ Users">';
                options += toolAccessSelected.users.map(u => `<option value="user:${u.id}">${u.name}</option>`).join('');
                options += '</optgroup>';
            }
            if (toolAccessSelected.groups.length > 0) {
                options += '<optgroup label="ðŸ‘¥ Groups">';
                options += toolAccessSelected.groups.map(g => `<option value="group:${g.id}">${g.name}</option>`).join('');
                options += '</optgroup>';
            }
            select.innerHTML = options;
        }
        
        if (chipsDiv) {
            chipsDiv.innerHTML = toolPermissionChips[permType].map(e => `
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs" 
                      style="background: ${e.entityType === 'group' ? '#dbeafe' : '#ede9fe'}; color: ${e.entityType === 'group' ? '#1e40af' : '#5b21b6'};">
                    ${e.entityType === 'group' ? 'ðŸ‘¥' : 'ðŸ‘¤'} ${e.name}
                    <button onclick="removeEditPermChip('${permType}', '${e.id}', '${e.entityType}')" style="margin-left: 2px;">Ã—</button>
                </span>
            `).join('');
        }
    });
}

function addEditPermChip(permType, selectEl) {
    const value = selectEl.value;
    if (!value) return;
    
    const [type, id] = value.split(':');
    const entity = type === 'user' 
        ? toolAccessSelected.users.find(u => u.id === id)
        : toolAccessSelected.groups.find(g => g.id === id);
    
    if (!entity) return;
    
    if (!toolPermissionChips[permType].some(e => e.id === id && e.entityType === type)) {
        toolPermissionChips[permType].push({ ...entity, entityType: type });
    }
    
    updateEditPermDropdowns();
    selectEl.value = '';
}

function removeEditPermChip(permType, entityId, entityType) {
    toolPermissionChips[permType] = toolPermissionChips[permType].filter(e => !(e.id === entityId && e.entityType === entityType));
    updateEditPermDropdowns();
}

function switchEditTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.edit-tab').forEach(t => {
        t.classList.remove('active', 'border-purple-500', 'text-purple-400');
        t.classList.add('border-transparent', 'text-gray-400');
    });
    const activeTab = document.querySelector(`.edit-tab[data-tab="${tab}"]`);
    if (activeTab) {
        activeTab.classList.add('active', 'border-purple-500', 'text-purple-400');
        activeTab.classList.remove('border-transparent', 'text-gray-400');
    }
    
    // Show content
    document.querySelectorAll('.edit-tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('edit-tab-' + tab)?.classList.remove('hidden');
}

function loadEditConfigFields(tool) {
    const container = document.getElementById('edit-config-content');
    const config = tool.config || {};
    let html = '';
    
    switch(tool.type) {
        case 'website':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Website URL</label>
                        <input type="url" id="edit-cfg-url" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.url || '')}">
                    </div>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="edit-cfg-recursive" class="w-4 h-4" ${config.recursive ? 'checked' : ''}>
                            <span class="text-sm">Recursive scraping</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-400">Max pages:</label>
                            <input type="number" id="edit-cfg-maxpages" class="input-field w-20 rounded px-2 py-1" value="${config.max_pages || 10}">
                        </div>
                    </div>
                    <p class="text-xs text-yellow-400">âš ï¸ Changing URL will require re-scraping</p>
                </div>
            `;
            break;
            
        case 'document':
        case 'knowledge':
            html = `
                <div class="space-y-4">
                    <div class="card rounded-lg p-4">
                        <h5 class="font-medium mb-3">ðŸ” Search Settings</h5>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Chunk Size</label>
                                <input type="number" id="edit-cfg-chunk" class="input-field w-full rounded-lg px-3 py-2" value="${config.chunk_size || 1000}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Overlap</label>
                                <input type="number" id="edit-cfg-overlap" class="input-field w-full rounded-lg px-3 py-2" value="${config.overlap || 200}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Top K Results</label>
                                <input type="number" id="edit-cfg-topk" class="input-field w-full rounded-lg px-3 py-2" value="${config.top_k || 5}">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Search Type</label>
                                <select id="edit-cfg-search" class="input-field w-full rounded-lg px-3 py-2">
                                    <option value="hybrid" ${config.search_type === 'hybrid' ? 'selected' : ''}>Hybrid</option>
                                    <option value="semantic" ${config.search_type === 'semantic' ? 'selected' : ''}>Semantic</option>
                                    <option value="keyword" ${config.search_type === 'keyword' ? 'selected' : ''}>Keyword</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-yellow-400">âš ï¸ Changing chunk size/overlap will require re-indexing documents</p>
                </div>
            `;
            break;
            
        case 'api':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">API Base URL</label>
                        <input type="url" id="edit-cfg-apiurl" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.base_url || '')}">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">API Key</label>
                        <input type="password" id="edit-cfg-apikey" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.api_key || '')}" placeholder="Enter API key">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Headers (JSON)</label>
                        <textarea id="edit-cfg-headers" rows="3" class="input-field w-full px-4 py-2 rounded-lg font-mono text-sm">${escHtml(JSON.stringify(config.headers || {}, null, 2))}</textarea>
                    </div>
                </div>
            `;
            break;
            
        case 'database':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Database Type</label>
                        <select id="edit-cfg-dbtype" class="input-field w-full px-4 py-2 rounded-lg">
                            <option value="postgresql" ${config.db_type === 'postgresql' ? 'selected' : ''}>PostgreSQL</option>
                            <option value="mysql" ${config.db_type === 'mysql' ? 'selected' : ''}>MySQL</option>
                            <option value="mssql" ${config.db_type === 'mssql' ? 'selected' : ''}>SQL Server</option>
                            <option value="mongodb" ${config.db_type === 'mongodb' ? 'selected' : ''}>MongoDB</option>
                            <option value="sqlite" ${config.db_type === 'sqlite' ? 'selected' : ''}>SQLite</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Connection String</label>
                        <input type="password" id="edit-cfg-connstr" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.connection_string || '')}" placeholder="postgresql://user:pass@host:5432/db">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Allowed Tables (comma-separated, empty = all)</label>
                        <input type="text" id="edit-cfg-tables" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml((config.tables || []).join(', '))}" placeholder="users, orders, products">
                    </div>
                </div>
            `;
            break;
            
        case 'email':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Email Provider</label>
                        <select id="edit-cfg-emailprovider" class="input-field w-full px-4 py-2 rounded-lg">
                            <option value="smtp" ${config.provider === 'smtp' ? 'selected' : ''}>SMTP</option>
                            <option value="sendgrid" ${config.provider === 'sendgrid' ? 'selected' : ''}>SendGrid</option>
                            <option value="ses" ${config.provider === 'ses' ? 'selected' : ''}>AWS SES</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">From Email</label>
                        <input type="email" id="edit-cfg-fromemail" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.from_email || '')}" placeholder="noreply@example.com">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">API Key / Password</label>
                        <input type="password" id="edit-cfg-emailkey" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.api_key || config.password || '')}" placeholder="Enter API key or password">
                    </div>
                    <div id="smtp-fields" class="${config.provider === 'smtp' ? '' : 'hidden'}">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">SMTP Host</label>
                                <input type="text" id="edit-cfg-smtphost" class="input-field w-full px-3 py-2 rounded-lg" value="${escHtml(config.smtp_host || '')}" placeholder="smtp.gmail.com">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">SMTP Port</label>
                                <input type="number" id="edit-cfg-smtpport" class="input-field w-full px-3 py-2 rounded-lg" value="${config.smtp_port || 587}">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'webhook':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Webhook URL</label>
                        <input type="url" id="edit-cfg-webhookurl" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.url || '')}" placeholder="https://api.example.com/webhook">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">HTTP Method</label>
                        <select id="edit-cfg-webhookmethod" class="input-field w-full px-4 py-2 rounded-lg">
                            <option value="POST" ${config.method === 'POST' ? 'selected' : ''}>POST</option>
                            <option value="GET" ${config.method === 'GET' ? 'selected' : ''}>GET</option>
                            <option value="PUT" ${config.method === 'PUT' ? 'selected' : ''}>PUT</option>
                            <option value="PATCH" ${config.method === 'PATCH' ? 'selected' : ''}>PATCH</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Headers (JSON)</label>
                        <textarea id="edit-cfg-webhookheaders" rows="3" class="input-field w-full px-4 py-2 rounded-lg font-mono text-sm">${escHtml(JSON.stringify(config.headers || {}, null, 2))}</textarea>
                    </div>
                </div>
            `;
            break;
            
        case 'slack':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Bot Token</label>
                        <input type="password" id="edit-cfg-slacktoken" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.bot_token || '')}" placeholder="xoxb-...">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Default Channel</label>
                        <input type="text" id="edit-cfg-slackchannel" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.default_channel || '')}" placeholder="#general">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Allowed Channels (comma-separated, empty = all)</label>
                        <input type="text" id="edit-cfg-slackchannels" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml((config.channels || []).join(', '))}" placeholder="#general, #support">
                    </div>
                </div>
            `;
            break;
            
        case 'websearch':
            html = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Search Provider</label>
                        <select id="edit-cfg-searchprovider" class="input-field w-full px-4 py-2 rounded-lg">
                            <option value="tavily" ${config.provider === 'tavily' ? 'selected' : ''}>Tavily</option>
                            <option value="serper" ${config.provider === 'serper' ? 'selected' : ''}>Serper (Google)</option>
                            <option value="bing" ${config.provider === 'bing' ? 'selected' : ''}>Bing</option>
                            <option value="duckduckgo" ${config.provider === 'duckduckgo' ? 'selected' : ''}>DuckDuckGo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">API Key</label>
                        <input type="password" id="edit-cfg-searchkey" class="input-field w-full px-4 py-2 rounded-lg" value="${escHtml(config.api_key || '')}" placeholder="Enter API key">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Max Results</label>
                        <input type="number" id="edit-cfg-searchmax" class="input-field w-full px-4 py-2 rounded-lg" value="${config.max_results || 10}" min="1" max="50">
                    </div>
                </div>
            `;
            break;
            
        default:
            html = `
                <div class="text-center py-8 text-gray-400">
                    <p>Configuration for ${tool.type} type</p>
                    <pre class="mt-4 text-left text-xs bg-gray-800 p-4 rounded-lg overflow-auto max-h-64">${escHtml(JSON.stringify(config, null, 2))}</pre>
                </div>
            `;
    }
    
    container.innerHTML = html;
}
function loadEditSources(tool) {
    const container = document.getElementById('edit-sources-content');
    let html = '';
    
    // Documents
    const docs = tool.documents || [];
    html += `
        <div class="mb-6">
            <div class="flex items-center justify-between mb-3">
                <h5 class="font-medium">ðŸ“„ Documents (${docs.length})</h5>
            </div>
            ${docs.length > 0 ? `
                <div class="space-y-2 max-h-48 overflow-y-auto">
                    ${docs.map(d => `
                        <div class="flex items-center justify-between p-2 bg-gray-800 rounded-lg">
                            <span class="text-sm truncate flex-1">${escHtml(d.name || d.filename || 'Document')}</span>
                            <button onclick="removeEditDoc('${d.id}')" class="text-red-400 hover:text-red-300 p-1">ðŸ—‘ï¸</button>
                        </div>
                    `).join('')}
                </div>
            ` : '<p class="text-gray-500 text-sm">No documents uploaded</p>'}
        </div>
    `;
    
    // Scraped Pages (for website type)
    if (tool.type === 'website') {
        const pages = tool.scraped_pages || [];
        html += `
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h5 class="font-medium">ðŸŒ Scraped Pages (${pages.length})</h5>
                </div>
                ${pages.length > 0 ? `
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        ${pages.map(p => `
                            <div class="flex items-center justify-between p-2 bg-gray-800 rounded-lg">
                                <span class="text-sm truncate flex-1">${escHtml(p.title || p.url || 'Page')}</span>
                                <button onclick="removeEditPage('${p.id}')" class="text-red-400 hover:text-red-300 p-1">ðŸ—‘ï¸</button>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p class="text-gray-500 text-sm">No pages scraped</p>'}
            </div>
        `;
    }
    
    // Add new source button
    html += `
        <div class="pt-4 border-t border-gray-700">
            <p class="text-sm text-gray-400 mb-3">To add new sources, use the tool detail page.</p>
            <button onclick="closeToolEditPanel(); viewTool('${tool.id}')" class="btn-secondary px-4 py-2 rounded-lg text-sm">
                Open Full View â†’
            </button>
        </div>
    `;
    
    container.innerHTML = html;
}

async function saveToolChanges() {
    const toolId = document.getElementById('edit-tool-id').value;
    const toolType = document.getElementById('edit-tool-type').value;
    
    // Gather basic info
    const updates = {
        name: document.getElementById('edit-tool-name').value,
        description: document.getElementById('edit-tool-desc').value,
        is_active: document.getElementById('edit-tool-active').checked
    };
    
    // Gather config based on type
    const config = {};
    switch(toolType) {
        case 'website':
            config.url = document.getElementById('edit-cfg-url')?.value || '';
            config.recursive = document.getElementById('edit-cfg-recursive')?.checked || false;
            config.max_pages = parseInt(document.getElementById('edit-cfg-maxpages')?.value) || 10;
            break;
        case 'document':
        case 'knowledge':
            config.chunk_size = parseInt(document.getElementById('edit-cfg-chunk')?.value) || 1000;
            config.overlap = parseInt(document.getElementById('edit-cfg-overlap')?.value) || 200;
            config.top_k = parseInt(document.getElementById('edit-cfg-topk')?.value) || 5;
            config.search_type = document.getElementById('edit-cfg-search')?.value || 'hybrid';
            break;
        case 'api':
            config.base_url = document.getElementById('edit-cfg-apiurl')?.value || '';
            config.api_key = document.getElementById('edit-cfg-apikey')?.value || '';
            try {
                config.headers = JSON.parse(document.getElementById('edit-cfg-headers')?.value || '{}');
            } catch(e) {
                config.headers = {};
            }
            break;
        case 'database':
            config.db_type = document.getElementById('edit-cfg-dbtype')?.value || 'postgresql';
            config.connection_string = document.getElementById('edit-cfg-connstr')?.value || '';
            const tablesStr = document.getElementById('edit-cfg-tables')?.value || '';
            config.tables = tablesStr ? tablesStr.split(',').map(t => t.trim()).filter(t => t) : [];
            break;
        case 'email':
            config.provider = document.getElementById('edit-cfg-emailprovider')?.value || 'smtp';
            config.from_email = document.getElementById('edit-cfg-fromemail')?.value || '';
            config.api_key = document.getElementById('edit-cfg-emailkey')?.value || '';
            if (config.provider === 'smtp') {
                config.smtp_host = document.getElementById('edit-cfg-smtphost')?.value || '';
                config.smtp_port = parseInt(document.getElementById('edit-cfg-smtpport')?.value) || 587;
            }
            break;
        case 'webhook':
            config.url = document.getElementById('edit-cfg-webhookurl')?.value || '';
            config.method = document.getElementById('edit-cfg-webhookmethod')?.value || 'POST';
            try {
                config.headers = JSON.parse(document.getElementById('edit-cfg-webhookheaders')?.value || '{}');
            } catch(e) {
                config.headers = {};
            }
            break;
        case 'slack':
            config.bot_token = document.getElementById('edit-cfg-slacktoken')?.value || '';
            config.default_channel = document.getElementById('edit-cfg-slackchannel')?.value || '';
            const channelsStr = document.getElementById('edit-cfg-slackchannels')?.value || '';
            config.channels = channelsStr ? channelsStr.split(',').map(c => c.trim()).filter(c => c) : [];
            break;
        case 'websearch':
            config.provider = document.getElementById('edit-cfg-searchprovider')?.value || 'tavily';
            config.api_key = document.getElementById('edit-cfg-searchkey')?.value || '';
            config.max_results = parseInt(document.getElementById('edit-cfg-searchmax')?.value) || 10;
            break;
    }
    
    // Merge with existing config
    updates.config = { ...(currentEditTool?.config || {}), ...config };
    
    // ONLY send access control fields if user is the OWNER
    // This prevents non-owners from accidentally overwriting permissions
    const isOwner = currentEditTool?.is_owner === true;
    
    if (isOwner && typeof selectedToolAccessType !== 'undefined') {
        updates.access_type = selectedToolAccessType;
        
        if (selectedToolAccessType === 'specific_users' && typeof toolAccessSelected !== 'undefined') {
            updates.allowed_user_ids = toolAccessSelected.users.map(u => u.id);
            updates.allowed_group_ids = toolAccessSelected.groups.map(g => g.id);
            
            if (typeof toolPermissionChips !== 'undefined') {
                updates.can_edit_user_ids = toolPermissionChips.edit.map(e => 
                    e.entityType === 'group' ? `group:${e.id}` : e.id
                );
                updates.can_delete_user_ids = toolPermissionChips.delete.map(e => 
                    e.entityType === 'group' ? `group:${e.id}` : e.id
                );
                updates.can_execute_user_ids = toolPermissionChips.execute.map(e => 
                    e.entityType === 'group' ? `group:${e.id}` : e.id
                );
            }
        }
        
        console.log('ðŸ“‹ [SAVE] Access Control Updates (OWNER):', {
            access_type: updates.access_type,
            allowed_user_ids: updates.allowed_user_ids,
            allowed_group_ids: updates.allowed_group_ids,
            can_edit_user_ids: updates.can_edit_user_ids
        });
    } else if (!isOwner) {
        console.log('ðŸ“‹ [SAVE] Skipping access control (not owner)');
    }
    
    // Check if critical config changed (for re-processing)
    const oldConfig = currentEditTool?.config || {};
    let needsReprocess = false;
    let reprocessMessage = '';
    
    if (toolType === 'website' && oldConfig.url !== config.url) {
        needsReprocess = true;
        reprocessMessage = 'URL changed. You may need to re-scrape the website.';
    } else if ((toolType === 'document' || toolType === 'knowledge') && 
               (oldConfig.chunk_size !== config.chunk_size || oldConfig.overlap !== config.overlap)) {
        needsReprocess = true;
        reprocessMessage = 'Chunk settings changed. You may need to re-index documents.';
    }
    
    try {
        const r = await fetch(API + '/api/tools/' + toolId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
        });
        
        if (r.ok) {
            const result = await r.json();
            
            // Show appropriate message based on reprocess action
            if (result.reprocess_action) {
                let msg = 'Tool updated. ';
                switch(result.reprocess_action) {
                    case 'rescrape':
                        const pagesCount = result.reprocess_result?.pages_scraped || 0;
                        msg += `Re-scraped ${pagesCount} pages from new URL.`;
                        break;
                    case 'reindex':
                        const docsCount = result.reprocess_result?.documents_reindexed || 0;
                        msg += `Re-indexed ${docsCount} documents with new chunk settings.`;
                        break;
                    case 'test_connection':
                        msg += result.reprocess_result?.message || 'Configuration updated.';
                        break;
                    default:
                        msg += 'Configuration updated.';
                }
                if (result.reprocess_result?.error) {
                    showToast('Tool updated but re-processing failed: ' + result.reprocess_result.error, 'warning');
                } else {
                    showToast(msg, 'success');
                }
            } else {
                showToast('Tool updated successfully', 'success');
            }
            closeToolEditPanel();
            loadTools();
        } else {
            const err = await r.json();
            showToast(err.detail || 'Failed to update', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

function removeEditDoc(docId) {
    // This would need backend support - for now just show message
    showToast('Use full view to manage documents', 'info');
}

function removeEditPage(pageId) {
    showToast('Use full view to manage pages', 'info');
}
async function showEditToolModal(toolId) {
    try {
        const r = await fetch(API + '/api/tools/' + toolId);
        if (!r.ok) {
            showToast('Failed to load tool', 'error');
            return;
        }
        const tool = await r.json();
        
        // Create edit modal
        const modal = document.createElement('div');
        modal.id = 'edit-tool-modal';
        modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999]';
        modal.innerHTML = `
            <div class="card rounded-2xl p-6 w-full max-w-lg mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">âœï¸ Edit Tool</h3>
                    <button onclick="closeEditToolModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <form id="edit-tool-form" class="space-y-4">
                    <input type="hidden" id="edit-tool-id" value="${tool.id}">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Name</label>
                        <input type="text" id="edit-tool-name" value="${escHtml(tool.name)}" class="input-field w-full px-4 py-2 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Description</label>
                        <textarea id="edit-tool-desc" rows="3" class="input-field w-full px-4 py-2 rounded-lg">${escHtml(tool.description || '')}</textarea>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeEditToolModal()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                        <button type="submit" class="btn-primary flex-1 py-2 rounded-lg">Save Changes</button>
                    </div>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Handle form submit
        document.getElementById('edit-tool-form').onsubmit = async (e) => {
            e.preventDefault();
            await saveToolEdit();
        };
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

function closeEditToolModal() {
    document.getElementById('edit-tool-modal')?.remove();
}

async function saveToolEdit() {
    const toolId = document.getElementById('edit-tool-id').value;
    const name = document.getElementById('edit-tool-name').value;
    const description = document.getElementById('edit-tool-desc').value;
    
    try {
        const r = await fetch(API + '/api/tools/' + toolId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        });
        
        if (r.ok) {
            showToast('Tool updated successfully', 'success');
            closeEditToolModal();
            // Refresh tool view
            navigate('tools');
            setTimeout(() => showToolDetails(toolId), 100);
        } else {
            const data = await r.json();
            showToast(data.detail || 'Failed to update tool', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}


        // Data Viewer Functions
        let currentPageData = null;
        let currentToolData = null;
        let currentDataTab = 'tables';
        let dataSearchQuery = '';
        
        async function viewToolData(toolId) {
            ensureModalInBody('data-viewer-modal');
            document.getElementById('data-viewer-modal').classList.remove('hidden');
            document.getElementById('data-viewer-content').innerHTML = '<div class="text-center text-gray-500 py-10"><div class="animate-spin rounded-full h-8 w-8 border-2 border-purple-500 border-t-transparent mx-auto mb-3"></div>Loading all tool data...</div>';
            
            try {
                const r = await fetch(API + '/api/tools/' + toolId + '/data');
                const data = await r.json();
                currentToolData = data;
                currentPageData = null;
                dataSearchQuery = '';
                
                document.getElementById('data-viewer-title').textContent = 'ðŸ“Š ' + (data.name || 'Tool Data');
                document.getElementById('data-viewer-subtitle').textContent = `${data.type.toUpperCase()} - ${data.total_chunks} chunks from ${data.sources?.length || 0} sources`;
                
                // Show search box
                document.getElementById('data-search-box').classList.remove('hidden');
                document.getElementById('data-search-input').value = '';
                
                // Stats
                document.getElementById('data-viewer-stats').innerHTML = `
                    <span>ðŸ“ ${(data.total_chars || 0).toLocaleString()} total characters</span>
                    <span>ðŸ§© ${data.total_chunks || 0} chunks</span>
                    <span>ðŸ“„ ${data.sources?.length || 0} sources</span>
                `;
                
                renderToolDataTab();
            } catch (e) {
                document.getElementById('data-viewer-content').innerHTML = '<div class="text-center text-red-400 py-10">Error loading data: ' + e.message + '</div>';
            }
        }
        
        function searchToolData() {
            dataSearchQuery = document.getElementById('data-search-input').value.toLowerCase().trim();
            if (currentToolData) {
                renderToolDataTab();
            } else if (currentPageData) {
                renderDataTab();
            }
        }
        
        function renderToolDataTab() {
            const container = document.getElementById('data-viewer-content');
            if (!currentToolData) return;
            
            let chunks = currentToolData.chunks || [];
            
            // Filter by search
            if (dataSearchQuery) {
                chunks = chunks.filter(c => 
                    (c.text || '').toLowerCase().includes(dataSearchQuery) ||
                    (c.source || '').toLowerCase().includes(dataSearchQuery)
                );
            }
            
            if (currentDataTab === 'tables') {
                // Show all tables from all chunks
                let allContent = chunks.map(c => c.text || '').join('\n\n');
                const tables = extractTables(allContent);
                
                if (tables.length === 0) {
                    container.innerHTML = `<div class="text-center text-gray-500 py-10">
                        ${dataSearchQuery ? 'No tables found matching "' + escHtml(dataSearchQuery) + '"' : 'No tables found in the data.'}
                        <br><br>Switch to "Full Text" or "Chunks" tab to see content.
                    </div>`;
                    return;
                }
                
                let html = dataSearchQuery ? `<p class="text-sm text-purple-400 mb-4">Found ${tables.length} tables matching "${escHtml(dataSearchQuery)}"</p>` : '';
                tables.forEach((table, i) => {
                    html += `<div class="mb-6">
                        <h4 class="text-sm font-semibold text-purple-400 mb-2">Table ${i + 1}</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse">${table}</table>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
                
            } else if (currentDataTab === 'text') {
                // Full text view grouped by source
                const bySource = {};
                chunks.forEach(c => {
                    const src = c.source || 'Unknown';
                    if (!bySource[src]) bySource[src] = [];
                    bySource[src].push(c.text || '');
                });
                
                let html = dataSearchQuery ? `<p class="text-sm text-purple-400 mb-4">Showing results for "${escHtml(dataSearchQuery)}" (${chunks.length} chunks)</p>` : '';
                
                Object.entries(bySource).forEach(([source, texts]) => {
                    html += `<div class="mb-6">
                        <h4 class="text-sm font-semibold text-purple-400 mb-2 flex items-center gap-2">
                            <span>ðŸ“„</span> ${escHtml(source)}
                            <span class="text-gray-500 font-normal">(${texts.length} chunks)</span>
                        </h4>
                        <div class="bg-gray-900 rounded-lg p-4 font-mono text-xs whitespace-pre-wrap max-h-64 overflow-y-auto">${highlightSearch(escHtml(texts.join('\n\n---\n\n')))}</div>
                    </div>`;
                });
                
                container.innerHTML = html || '<div class="text-center text-gray-500 py-10">No content available.</div>';
                
            } else if (currentDataTab === 'chunks') {
                if (chunks.length === 0) {
                    container.innerHTML = `<div class="text-center text-gray-500 py-10">
                        ${dataSearchQuery ? 'No chunks found matching "' + escHtml(dataSearchQuery) + '"' : 'No chunks available.'}
                    </div>`;
                    return;
                }
                
                let html = dataSearchQuery ? `<p class="text-sm text-purple-400 mb-4">Found ${chunks.length} chunks matching "${escHtml(dataSearchQuery)}"</p>` : '';
                html += '<div class="space-y-4">';
                
                chunks.slice(0, 50).forEach((chunk, i) => {
                    const text = (chunk.text && typeof chunk.text === 'string') ? chunk.text : '';
                    if (!text) return; // Skip empty chunks
                    html += `
                        <div class="bg-gray-800 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-semibold text-purple-400">Chunk ${i + 1}</span>
                                <div class="flex gap-2 text-xs text-gray-500">
                                    <span>ðŸ“„ ${escHtml(chunk.source || 'Unknown')}</span>
                                    <span>${text.length} chars</span>
                                </div>
                            </div>
                            <pre class="text-sm whitespace-pre-wrap text-gray-300">${highlightSearch(escHtml(text.substring(0, 500)))}${text.length > 500 ? '...' : ''}</pre>
                        </div>
                    `;
                });
                
                if (chunks.length > 50) {
                    html += `<p class="text-center text-gray-500 py-4">Showing 50 of ${chunks.length} chunks. Use search to find specific data.</p>`;
                }
                
                html += '</div>';
                container.innerHTML = html;
            }
        }
        
        function highlightSearch(text) {
            if (!dataSearchQuery || !text) return text || '';
            const regex = new RegExp('(' + dataSearchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return String(text).replace(regex, '<mark class="bg-yellow-500/30 text-yellow-200 px-0.5 rounded">$1</mark>');
        }
        
        async function viewPageData(pageId) {
            ensureModalInBody('data-viewer-modal');
            document.getElementById('data-viewer-modal').classList.remove('hidden');
            document.getElementById('data-search-box').classList.add('hidden'); // Hide search for page data
            document.getElementById('data-viewer-content').innerHTML = '<div class="text-center text-gray-500 py-10"><div class="animate-spin rounded-full h-8 w-8 border-2 border-purple-500 border-t-transparent mx-auto mb-3"></div>Loading data...</div>';
            
            currentToolData = null; // Reset tool data
            dataSearchQuery = '';
            
            try {
                const r = await fetch(API + '/api/scraped-pages/' + pageId + '/data');
                const data = await r.json();
                currentPageData = data;
                
                document.getElementById('data-viewer-title').textContent = 'ðŸ“Š ' + (data.title || 'Extracted Data');
                document.getElementById('data-viewer-subtitle').textContent = data.url;
                
                // Stats
                document.getElementById('data-viewer-stats').innerHTML = `
                    <span>ðŸ“ ${(data.content?.length || 0).toLocaleString()} characters</span>
                    <span>ðŸ§© ${data.chunks?.length || 0} chunks</span>
                    <span>ðŸ“Š ${data.tables?.length || 0} tables found</span>
                    <span>ðŸ“… ${new Date(data.created_at).toLocaleString()}</span>
                `;
                
                renderDataTab();
            } catch (e) {
                document.getElementById('data-viewer-content').innerHTML = '<div class="text-center text-red-400 py-10">Error loading data: ' + e.message + '</div>';
            }
        }
        
        function setDataTab(tab) {
            currentDataTab = tab;
            document.querySelectorAll('[id^="data-tab-"]').forEach(btn => {
                btn.classList.toggle('border-purple-500', btn.id === 'data-tab-' + tab);
                btn.classList.toggle('text-white', btn.id === 'data-tab-' + tab);
                btn.classList.toggle('border-transparent', btn.id !== 'data-tab-' + tab);
                btn.classList.toggle('text-gray-400', btn.id !== 'data-tab-' + tab);
            });
            if (currentToolData) {
                renderToolDataTab();
            } else {
                renderDataTab();
            }
        }
        
        function renderDataTab() {
            const container = document.getElementById('data-viewer-content');
            if (!currentPageData) return;
            
            if (currentDataTab === 'tables') {
                // Extract and render tables
                const tables = extractTables(currentPageData.content || '');
                if (tables.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-10">No tables found in the extracted data.<br><br>Switch to "Full Text" tab to see all content.</div>';
                    return;
                }
                
                let html = '';
                tables.forEach((table, i) => {
                    html += `<div class="mb-6">
                        <h4 class="text-sm font-semibold text-purple-400 mb-2">Table ${i + 1}</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse">
                                ${table}
                            </table>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            } else if (currentDataTab === 'text') {
                // Full text view
                const content = currentPageData.content || 'No content';
                container.innerHTML = `
                    <div class="bg-gray-900 rounded-lg p-4 font-mono text-sm whitespace-pre-wrap overflow-x-auto" style="max-height: 60vh;">${escHtml(content)}</div>
                `;
            } else if (currentDataTab === 'chunks') {
                // Chunks view
                const chunks = currentPageData.chunks || [];
                if (chunks.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-10">No chunks available.</div>';
                    return;
                }
                
                let html = '<div class="space-y-4">';
                chunks.forEach((chunk, i) => {
                    let text = typeof chunk === 'string' ? chunk : (chunk.text || chunk.content || JSON.stringify(chunk));
                    if (!text || typeof text !== 'string') text = '';
                    html += `
                        <div class="bg-gray-800 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-semibold text-purple-400">Chunk ${i + 1}</span>
                                <span class="text-xs text-gray-500">${text.length} chars</span>
                            </div>
                            <pre class="text-sm whitespace-pre-wrap text-gray-300">${escHtml(text.substring(0, 1000))}${text.length > 1000 ? '...' : ''}</pre>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            }
        }
        
        function extractTables(content) {
            const tables = [];
            
            // Look for [TABLE] markers
            const tableMatches = content.match(/\[TABLE\]([\s\S]*?)\[\/TABLE\]/gi);
            if (tableMatches) {
                tableMatches.forEach(match => {
                    const tableContent = match.replace(/\[TABLE\]/i, '').replace(/\[\/TABLE\]/i, '').trim();
                    const rows = tableContent.split('\n').filter(r => r.trim());
                    if (rows.length > 0) {
                        let tableHtml = '';
                        rows.forEach((row, i) => {
                            const cells = row.split('|').map(c => c.trim()).filter(c => c);
                            const tag = i === 0 ? 'th' : 'td';
                            const bgClass = i === 0 ? 'bg-purple-900/30' : (i % 2 === 0 ? 'bg-gray-800' : 'bg-gray-800/50');
                            tableHtml += '<tr class="' + bgClass + '">' + cells.map(c => '<' + tag + ' class="border border-gray-700 px-3 py-2">' + escHtml(c) + '</' + tag + '>').join('') + '</tr>';
                        });
                        tables.push(tableHtml);
                    }
                });
            }
            
            // Also look for pipe-separated tables without markers
            const lines = content.split('\n');
            let currentTable = [];
            let inTable = false;
            
            lines.forEach(line => {
                if (line.includes('|') && line.split('|').length >= 3) {
                    currentTable.push(line);
                    inTable = true;
                } else if (inTable && currentTable.length > 0) {
                    // End of table
                    if (currentTable.length >= 2) {
                        let tableHtml = '';
                        currentTable.forEach((row, i) => {
                            const cells = row.split('|').map(c => c.trim()).filter(c => c && !c.match(/^-+$/));
                            if (cells.length > 0) {
                                const tag = i === 0 ? 'th' : 'td';
                                const bgClass = i === 0 ? 'bg-purple-900/30' : (i % 2 === 0 ? 'bg-gray-800' : 'bg-gray-800/50');
                                tableHtml += '<tr class="' + bgClass + '">' + cells.map(c => '<' + tag + ' class="border border-gray-700 px-3 py-2">' + escHtml(c) + '</' + tag + '>').join('') + '</tr>';
                            }
                        });
                        if (tableHtml) tables.push(tableHtml);
                    }
                    currentTable = [];
                    inTable = false;
                }
            });
            
            // Check if we ended while still in a table
            if (currentTable.length >= 2) {
                let tableHtml = '';
                currentTable.forEach((row, i) => {
                    const cells = row.split('|').map(c => c.trim()).filter(c => c && !c.match(/^-+$/));
                    if (cells.length > 0) {
                        const tag = i === 0 ? 'th' : 'td';
                        const bgClass = i === 0 ? 'bg-purple-900/30' : (i % 2 === 0 ? 'bg-gray-800' : 'bg-gray-800/50');
                        tableHtml += '<tr class="' + bgClass + '">' + cells.map(c => '<' + tag + ' class="border border-gray-700 px-3 py-2">' + escHtml(c) + '</' + tag + '>').join('') + '</tr>';
                    }
                });
                if (tableHtml) tables.push(tableHtml);
            }
            
            return tables;
        }
        
        function closeDataViewer() {
            document.getElementById('data-viewer-modal').classList.add('hidden');
            document.getElementById('data-search-box').classList.add('hidden');
            currentPageData = null;
            currentToolData = null;
            dataSearchQuery = '';
        }
        
        function copyDataContent() {
            let content = '';
            if (currentToolData) {
                content = currentToolData.chunks?.map(c => c.text).join('\n\n---\n\n') || '';
            } else if (currentPageData) {
                content = currentPageData.content || '';
            }
            if (!content) return;
            navigator.clipboard.writeText(content);
            alert('Content copied to clipboard!');
        }
        
        function downloadDataContent() {
            let content = '';
            let filename = 'data.txt';
            if (currentToolData) {
                content = currentToolData.chunks?.map(c => `[Source: ${c.source}]\n${c.text}`).join('\n\n' + '='.repeat(50) + '\n\n') || '';
                filename = (currentToolData.name || 'tool-data') + '.txt';
            } else if (currentPageData) {
                content = currentPageData.content || '';
                filename = (currentPageData.title || 'data') + '.txt';
            }
            if (!content) return;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showToolModal(){
            // Reset editing state when opening for new tool
            editingToolId = null;
            
            // Reset wizard state
            resetWizard();
            
            // Update modal title
            const titleEl = document.getElementById('wizard-title');
            if (titleEl) titleEl.textContent = 'Create Tool';
            const subtitleEl = document.getElementById('wizard-subtitle');
            if (subtitleEl) subtitleEl.textContent = 'Select a tool type';
            
            showModal('modal-tool');
        }

        function backToToolTypes(){
            document.getElementById('tool-form').classList.add('hidden');
            document.getElementById('tool-categories').classList.remove('hidden');
            document.querySelectorAll('.tool-type').forEach(b=>b.classList.remove('border-purple-500'));
        }

        function selectToolType(type){
            toolType=type;
            document.querySelectorAll('.tool-type').forEach(b=>b.classList.remove('border-purple-500'));
            document.getElementById('tool-categories').classList.add('hidden');
            document.getElementById('tool-form').classList.remove('hidden');
            
            // Hide all form types
            const formTypes2 = ['knowledge','document','website','api','database','spreadsheet','email','slack','calendar','crm','webhook','websearch','imagegen','code','calculator','storage','stt','tts','translate','ocr','hitl'];
            formTypes2.forEach(t => {
                const el = document.getElementById('form-'+t);
                if(el) el.classList.add('hidden');
            });
            
            // Show selected form
            const selectedForm = document.getElementById('form-'+type);
            if(selectedForm) selectedForm.classList.remove('hidden');
            
            if(type==='document'){
                const z=document.getElementById('doc-upload-zone');
                z.ondragover=e=>{e.preventDefault();z.classList.add('dragover');};
                z.ondragleave=()=>z.classList.remove('dragover');
                z.ondrop=e=>{e.preventDefault();z.classList.remove('dragover');handleDocFilesDrop(e.dataTransfer.files);};
            }
        }

        // Tool form helper functions
        function onDBTypeChange(){
            const t = document.getElementById('db-type').value;
            const portMap = {
                // Relational
                postgresql:'5432', mysql:'3306', mssql:'1433', sqlite:'', 
                oracle:'1521', oracle_autonomous:'1522', db2:'50000', sybase:'5000', 
                teradata:'1025', azure_sql:'1433', cockroachdb:'26257', tidb:'4000',
                // Cloud Data Warehouses
                snowflake:'443', redshift:'5439', bigquery:'443',
                // NoSQL
                mongodb:'27017', mongodb_atlas:'27017', dynamodb:'443', cosmosdb:'443',
                firestore:'443', couchdb:'5984', cassandra:'9042', scylladb:'9042', hbase:'9090',
                // In-Memory
                redis:'6379', memcached:'11211', elasticache:'6379',
                // Search
                elasticsearch:'9200', opensearch:'9200', solr:'8983', meilisearch:'7700',
                // Vector
                pinecone:'443', weaviate:'8080', qdrant:'6333', milvus:'19530', chroma:'8000',
                // Time Series
                influxdb:'8086', timescaledb:'5432', questdb:'9000',
                // Graph
                neo4j:'7687', neptune:'8182', arangodb:'8529'
            };
            document.getElementById('db-port').value = portMap[t] || '5432';
        }
        function onSheetProviderChange(){
            const p = document.getElementById('sheet-provider').value;
            document.getElementById('sheet-google-fields').classList.toggle('hidden', p !== 'google');
            document.getElementById('sheet-airtable-fields').classList.toggle('hidden', p !== 'airtable');
        }
        function onEmailProviderChange(){
            const p = document.getElementById('email-provider').value;
            document.getElementById('email-smtp-fields').classList.toggle('hidden', p !== 'smtp');
            document.getElementById('email-api-fields').classList.toggle('hidden', p === 'smtp');
        }
        function onMsgPlatformChange(){
            const p = document.getElementById('msg-platform').value;
            document.getElementById('msg-slack-fields').classList.toggle('hidden', p !== 'slack');
            document.getElementById('msg-teams-fields').classList.toggle('hidden', p !== 'teams');
            document.getElementById('msg-discord-fields').classList.toggle('hidden', p !== 'discord');
        }
        function onCalProviderChange(){}
        function onCRMPlatformChange(){
            const p = document.getElementById('crm-platform').value;
            document.getElementById('crm-salesforce-fields').classList.toggle('hidden', p !== 'salesforce');
            document.getElementById('crm-hubspot-fields').classList.toggle('hidden', p !== 'hubspot');
        }
        function onWebhookTypeChange(){
            const t = document.getElementById('hook-type').value;
            document.getElementById('hook-outgoing-fields').classList.toggle('hidden', t !== 'outgoing');
            document.getElementById('hook-incoming-fields').classList.toggle('hidden', t !== 'incoming');
        }
        function onSearchProviderChange(){
            const p = document.getElementById('search-provider').value;
            const hints = {tavily:'Get your API key from tavily.com',serper:'Get your API key from serper.dev',bing:'Get your API key from Azure Portal',brave:'Get your API key from brave.com/search/api'};
            document.getElementById('search-api-hint').textContent = hints[p] || '';
        }
        function onImageProviderChange(){}
        function testDBConnection(){alert('Database connection test coming soon!');}
        function testSheetConnection(){alert('Spreadsheet connection test coming soon!');}
        function testEmailConnection(){alert('Email connection test coming soon!');}

        // Knowledge Base helper functions
        function toggleKBEmbedding(){
            const useGlobal = document.getElementById('kb-emb-global').checked;
            document.getElementById('kb-emb-custom').classList.toggle('hidden', useGlobal);
        }
        function toggleKBVectorDB(){
            const useGlobal = document.getElementById('kb-vdb-global').checked;
            document.getElementById('kb-vdb-custom').classList.toggle('hidden', useGlobal);
        }
        function onKBEmbProviderChange(){
            const p = document.getElementById('kb-emb-provider').value;
            document.getElementById('kb-emb-model-group').classList.toggle('hidden', p === 'sentence_transformers');
            document.getElementById('kb-emb-local-group').classList.toggle('hidden', p !== 'sentence_transformers');
            document.getElementById('kb-emb-key-group').classList.toggle('hidden', p === 'sentence_transformers' || p === 'ollama');
        }
        function onKBVDBProviderChange(){
            const p = document.getElementById('kb-vdb-provider').value;
            document.getElementById('kb-vdb-pinecone-group').classList.toggle('hidden', p !== 'pinecone');
        }

        function handleDocFiles(e){handleDocFilesDrop(e.target.files);}
        function handleDocFilesDrop(files){for(const f of files)uploadedFiles.push(f);renderDocFiles();}
        function renderDocFiles(){document.getElementById('doc-files-list').innerHTML=uploadedFiles.map((f,i)=>`<div class="flex items-center justify-between bg-gray-800 rounded-lg p-2"><div class="flex items-center gap-2 min-w-0"><span>${fileIcon(f.name.split('.').pop())}</span><span class="text-sm truncate">${f.name}</span></div><button onclick="uploadedFiles.splice(${i},1);renderDocFiles()" class="text-gray-500 hover:text-red-400 p-1">âœ•</button></div>`).join('');}

        // API Tool Wizard
        function setApiStep(s){
            apiStep=s;
            for(let i=1;i<=4;i++){
                const stepEl = document.getElementById('api-step-'+i);
                const btnEl = document.getElementById('api-step-'+i+'-btn');
                if(stepEl) stepEl.classList.toggle('hidden',i!==s);
                if(btnEl) btnEl.className='api-step px-2 md:px-4 py-2 rounded-lg border text-xs md:text-sm whitespace-nowrap '+(i===s?'border-purple-500 bg-purple-500/10 text-white':'border-gray-700 text-gray-400');
            }
            if(s===4 && typeof renderTestParams==='function') renderTestParams();
        }

        function addApiParam(){
            apiParams.push({id:Date.now(),name:'',description:'',data_type:'string',required:false,location:'query'});
            renderApiParams();
        }

        function renderApiParams(){
            document.getElementById('api-params-list').innerHTML=apiParams.map((p,i)=>`
                <div class="card rounded-lg p-3 md:p-4 space-y-3" id="param-${p.id}">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div>
                            <label class="text-xs text-gray-400">Name</label>
                            <input type="text" value="${p.name}" onchange="apiParams[${i}].name=this.value.replace(/\\s/g,'')" class="input-field w-full rounded px-3 py-2 text-sm mt-1" placeholder="city">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Type</label>
                            <select onchange="apiParams[${i}].data_type=this.value" class="input-field w-full rounded px-3 py-2 text-sm mt-1">
                                <option value="string" ${p.data_type==='string'?'selected':''}>String</option>
                                <option value="integer" ${p.data_type==='integer'?'selected':''}>Integer</option>
                                <option value="boolean" ${p.data_type==='boolean'?'selected':''}>Boolean</option>
                            </select>
                            
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Location</label>
                            <select onchange="apiParams[${i}].location=this.value" class="input-field w-full rounded px-3 py-2 text-sm mt-1">
                                <option value="query" ${p.location==='query'?'selected':''}>Query</option>
                                <option value="path" ${p.location==='path'?'selected':''}>Path</option>
                                <option value="header" ${p.location==='header'?'selected':''}>Header</option>
                                <option value="body" ${p.location==='body'?'selected':''}>Body</option>
                            </select>
                            
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Description</label>
                        <input type="text" value="${p.description}" onchange="apiParams[${i}].description=this.value" class="input-field w-full rounded px-3 py-2 text-sm mt-1" placeholder="The city name">
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="toggle-switch ${p.required?'on':''}" onclick="apiParams[${i}].required=!apiParams[${i}].required;renderApiParams()"></div>
                            <span class="text-sm">Required</span>
                        </div>
                        <button onclick="apiParams.splice(${i},1);renderApiParams()" class="text-gray-500 hover:text-red-400 text-sm">Remove</button>
                    </div>
                </div>
            `).join('')||'<p class="text-gray-500 text-sm text-center py-3">No fields yet. Click "Add field" if the API needs any.</p>';
        }

        function setConfigMode(mode){
            configMode=mode;
            document.getElementById('config-manual-btn').className='card p-3 md:p-4 rounded-lg text-center'+(mode==='manual'?' border-purple-500 bg-purple-500/10':'');
            document.getElementById('config-spec-btn').className='card p-3 md:p-4 rounded-lg text-center'+(mode==='spec'?' border-purple-500 bg-purple-500/10':'');
            document.getElementById('config-manual-form').classList.toggle('hidden',mode==='spec');
            document.getElementById('config-spec-upload').classList.toggle('hidden',mode==='manual');
        }

        async function handleSpecFile(e){
            const file=e.target.files[0];if(!file)return;
            const fd=new FormData();fd.append('file',file);
            try{
                const r=await fetch(API+'/api/tools/parse-openapi',{method:'POST',body:fd});
                const d=await r.json();
                if(d.base_url){ const u=document.getElementById('api-base-url')||document.getElementById('api-url'); if(u) u.value=d.base_url; }
                if(d.endpoints?.length){
                    const ep=d.endpoints[0];
                    document.getElementById('api-method').value=ep.method;
                    document.getElementById('api-path').value=ep.path;
                    apiParams=ep.parameters.map(p=>({id:Date.now()+Math.random(),name:p.name,description:p.description,data_type:p.data_type,required:p.required,location:p.location}));
                    renderApiParams();
                }
                alert('OpenAPI spec loaded!');
                setConfigMode('manual');
            }catch(e){alert('Failed to parse spec');}
        }

        function toggleAuthFields(){
            const auth=document.getElementById('api-auth')?.value;
            const authValContainer = document.getElementById('auth-value-container') || document.getElementById('api-auth-val-group');
            const keyOptions = document.getElementById('api-key-options');
            if(authValContainer) authValContainer.classList.toggle('hidden',auth==='none');
            if(keyOptions) keyOptions.classList.toggle('hidden',auth!=='api_key');
        }

        function getBusinessFriendlyParamLabel(paramName, description) {
            if (description && description.length > 5 && !description.toLowerCase().startsWith('the ')) {
                var cleaned = description.charAt(0).toUpperCase() + description.slice(1);
                if (cleaned.endsWith('.')) cleaned = cleaned.slice(0, -1);
                return cleaned;
            }
            const lowerName = (paramName || '').toLowerCase().replace(/_/g, ' ').replace(/-/g, ' ').trim();
            const labelMap = {
                'supplier id': 'Supplier ID', 'supplierid': 'Supplier ID',
                'customer id': 'Customer ID', 'customerid': 'Customer ID',
                'order id': 'Order Number', 'orderid': 'Order Number',
                'product id': 'Product Code', 'productid': 'Product Code',
                'user id': 'User ID', 'userid': 'User ID',
                'account id': 'Account Number', 'accountid': 'Account Number',
                'invoice id': 'Invoice Number', 'invoiceid': 'Invoice Number',
                'transaction id': 'Transaction ID', 'transactionid': 'Transaction ID',
                'id': 'ID', 'name': 'Name', 'email': 'Email Address',
                'phone': 'Phone Number', 'mobile': 'Mobile Number',
                'date': 'Date', 'start date': 'Start Date', 'end date': 'End Date',
                'status': 'Status', 'type': 'Type', 'category': 'Category',
                'amount': 'Amount', 'price': 'Price', 'quantity': 'Quantity',
                'address': 'Address', 'city': 'City', 'country': 'Country',
                'code': 'Code', 'reference': 'Reference Number'
            };
            return labelMap[lowerName] || paramName.split(/[_-]/).map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
        }

        function renderTestParams(){
            const container = document.getElementById('api-test-params');
            if (!container) return;
            const hasParams = apiParams && apiParams.length > 0;
            container.innerHTML = hasParams ? apiParams.map((p,i)=> {
                const safeId = 'test-param-' + (p.id != null ? p.id : i);
                const friendlyLabel = getBusinessFriendlyParamLabel(p.name, p.description);
                const required = p.required ? '<span class="text-purple-300 text-xs ml-1 font-normal">Required</span>' : '<span class="text-gray-400 text-xs ml-1 font-normal">Optional</span>';
                const helpText = p.description && p.description.length > 5 ? `<div class="text-xs text-gray-300 mt-1">${escHtml(p.description)}</div>` : '';
                const placeholder = `Enter ${friendlyLabel.toLowerCase()}`;
                return `
                <div class="space-y-1.5">
                    <label for="${safeId}" class="flex items-baseline justify-between text-sm font-semibold text-white">
                        <span>${escHtml(friendlyLabel)}</span>
                        ${required}
                    </label>
                    ${helpText}
                    <input type="text" id="${safeId}" class="w-full bg-gray-900/80 border-2 border-purple-500/20 rounded-xl px-4 py-3.5 text-white placeholder-gray-500 focus:border-purple-400 focus:bg-gray-900 focus:ring-4 focus:ring-purple-500/10 focus:outline-none transition-all duration-200 hover:border-purple-500/30" placeholder="${escHtml(placeholder)}" data-param-key="${escHtml(p.name || '')}" data-param-id="${p.id != null ? p.id : i}">
                </div>`;
            }).join('') : '<p class="text-gray-500 text-sm py-8 text-center">No additional information needed</p>';
        }

        async function testApiConnection(){
            const btn=document.getElementById('test-api-btn');
            if(btn){ btn.disabled=true; btn.textContent='Testing...'; }
            const resultEl=document.getElementById('api-test-result');
            const statusIcon=document.getElementById('test-status-icon');
            const statusText=document.getElementById('test-status-text');
            const responsePre=document.getElementById('test-response');
            if(resultEl) resultEl.classList.remove('hidden');
            if(statusIcon) statusIcon.textContent='â³';
            if(statusText) statusText.textContent='Testing...';
            const params={};
            (apiParams||[]).forEach((p,i)=>{ const el=document.getElementById('test-param-'+(p.id!=null?p.id:i))||document.getElementById('test-param-'+p.name); if(el&&el.value) params[p.name||('param_'+i)]=el.value; });
            const baseUrlEl=document.getElementById('api-base-url')||document.getElementById('api-url');
            const authValEl=document.getElementById('api-auth-value')||document.getElementById('api-auth-val');
            try{
                const r=await fetch(API+'/api/tools/test-api',{method:'POST',headers:{'Content-Type':'application/json',...(typeof getAuthHeaders==='function'?getAuthHeaders():{})},body:JSON.stringify({
                    base_url:baseUrlEl?.value||'',
                    http_method:document.getElementById('api-method')?.value,
                    endpoint_path:document.getElementById('api-path')?.value,
                    auth_type:document.getElementById('api-auth')?.value,
                    auth_value:authValEl?.value||'',
                    api_key_name:document.getElementById('api-key-name')?.value||'',
                    api_key_location:document.getElementById('api-key-loc')?.value||'',
                    parameters:params
                })});
                const d=await r.json();
                if(d.success){
                    if(statusIcon) statusIcon.textContent='âœ…';
                    if(statusText) statusText.textContent='Success! Status: '+d.status_code;
                }else{
                    if(statusIcon) statusIcon.textContent='âŒ';
                    if(statusText) statusText.textContent='Failed: '+(d.error||'Status '+d.status_code);
                }
                if(responsePre) responsePre.textContent=JSON.stringify(d.data,null,2);
            }catch(e){
                if(statusIcon) statusIcon.textContent='âŒ';
                if(statusText) statusText.textContent='Error: '+e.message;
            }
            if(btn){ btn.disabled=false; btn.textContent='ðŸ”Œ Test Connection'; }
        }

        async function createTool(){
            if(!toolType){alert('Select tool type');return;}
            let name,desc,config={},api_config=null;
            
            // Helper function to check if name exists (skip for same tool when editing)
            function isNameDuplicate(toolName) {
                if(!allTools || !toolName) return false;
                return allTools.some(t => {
                    // When editing, skip the tool being edited
                    if (editingToolId && t.id === editingToolId) return false;
                    return t.name.toLowerCase().trim() === toolName.toLowerCase().trim();
                });
            }
            
            // Knowledge Base Tool
            if(toolType==='knowledge'){
                name=document.getElementById('kb-name').value?.trim();
                desc=document.getElementById('kb-desc').value;
                if(!name){alert('Enter knowledge base name');return;}
                if(isNameDuplicate(name)){
                    alert(`âŒ A tool named "${name}" already exists.\nPlease choose a different name.`);
                    return;
                }
                
                // Build KB config
                config = {
                    collection_id: document.getElementById('kb-collection').value || name.toLowerCase().replace(/[^a-z0-9]/g, '_'),
                    // Embedding config
                    embedding: {
                        use_global: document.getElementById('kb-emb-global').checked,
                        provider: document.getElementById('kb-emb-provider').value,
                        model: document.getElementById('kb-emb-model').value,
                        local_model: document.getElementById('kb-emb-local-model').value,
                        api_key: document.getElementById('kb-emb-api-key').value
                    },
                    // Vector DB config
                    vector_db: {
                        use_global: document.getElementById('kb-vdb-global').checked,
                        provider: document.getElementById('kb-vdb-provider').value,
                        pinecone_api_key: document.getElementById('kb-vdb-pinecone-key').value
                    },
                    // RAG Settings
                    chunk_size: parseInt(document.getElementById('kb-chunk-size').value) || 1000,
                    chunk_overlap: parseInt(document.getElementById('kb-chunk-overlap').value) || 200,
                    top_k: parseInt(document.getElementById('kb-top-k').value) || 5,
                    search_type: document.getElementById('kb-search-type').value,
                    similarity_threshold: parseInt(document.getElementById('kb-threshold').value) / 100,
                    // Advanced
                    reranking: document.getElementById('kb-rerank').value,
                    context_window: parseInt(document.getElementById('kb-context-window').value) || 4000,
                    include_metadata: document.getElementById('kb-include-metadata').checked,
                    auto_reindex: document.getElementById('kb-auto-reindex').checked
                };
            }
            else if(toolType==='document'){
                name=document.getElementById('doc-name').value?.trim();
                desc=document.getElementById('doc-desc').value;
                if(!name){alert('Enter tool name');return;}
                if(isNameDuplicate(name)){
                    alert(`âŒ A tool named "${name}" already exists.\nPlease choose a different name.`);
                    return;
                }
            }else if(toolType==='website'){
                name=document.getElementById('web-name').value?.trim();
                desc=document.getElementById('web-desc').value;
                config.url=document.getElementById('web-url').value;
                config.recursive=document.getElementById('web-recursive').checked;
                config.max_pages=parseInt(document.getElementById('web-max').value);
                if(!name){alert('Enter tool name');return;}
                if(isNameDuplicate(name)){
                    alert(`âŒ A tool named "${name}" already exists.\nPlease choose a different name.`);
                    return;
                }
                if(!config.url){alert('Enter website URL');return;}
            }else if(toolType==='api'){
                name=(document.getElementById('api-name')||document.getElementById('wiz-name'))?.value?.trim();
                desc=(document.getElementById('api-desc')||document.getElementById('wiz-desc'))?.value||'';
                if(!name){alert('Enter tool name');return;}
                if(isNameDuplicate(name)){
                    alert(`âŒ A tool named "${name}" already exists.\nPlease choose a different name.`);
                    return;
                }
                api_config={
                    base_url:(document.getElementById('api-base-url')||document.getElementById('api-url'))?.value||'',
                    http_method:document.getElementById('api-method').value,
                    endpoint_path:document.getElementById('api-path').value,
                    auth_type:document.getElementById('api-auth').value,
                    auth_value:(document.getElementById('api-auth-value')||document.getElementById('api-auth-val'))?.value||'',
                    api_key_name:document.getElementById('api-key-name')?.value||'',
                    api_key_location:document.getElementById('api-key-loc')?.value||'',
                    headers:{},
                    input_parameters:(apiParams||[]).map(p=>({name:p.name,description:p.description,data_type:p.data_type,required:p.required,location:p.location}))
                };
            }
            // Email Tool
            else if(toolType==='email'){
                name = document.getElementById('wiz-name')?.value?.trim();
                desc = document.getElementById('wiz-desc')?.value || '';
                if(!name){alert('Enter tool name');return;}
                if(isNameDuplicate(name)){
                    alert(`âŒ A tool named "${name}" already exists.\nPlease choose a different name.`);
                    return;
                }
                
                // Get email config from the form
                const emailConfigData = document.getElementById('email-config-data')?.value;
                if(emailConfigData){
                    try {
                        config = JSON.parse(emailConfigData);
                    } catch(e) {
                        config = {};
                    }
                }
                
                // If no OAuth config, check for SendGrid
                if(!config.provider){
                    const sendgridKey = document.getElementById('sendgrid-api-key')?.value;
                    const sendgridFrom = document.getElementById('sendgrid-from-email')?.value;
                    if(sendgridKey && sendgridFrom){
                        config = {
                            provider: 'sendgrid',
                            apiKey: sendgridKey,
                            fromEmail: sendgridFrom
                        };
                    }
                }
                
                if(!config.provider){
                    alert('Please connect an email provider first');
                    return;
                }
            }
            // Generic handler for other tools (webhook, websearch, etc.)
            else {
                name = document.getElementById('wiz-name')?.value?.trim();
                desc = document.getElementById('wiz-desc')?.value || '';
                if(!name){alert('Enter tool name');return;}
                if(isNameDuplicate(name)){
                    alert(`âŒ A tool named "${name}" already exists.\nPlease choose a different name.`);
                    return;
                }
            }
            
            // Show progress modal
            const isEditing = !!editingToolId;
            showProgressModal(isEditing ? 'Updating tool...' : 'Creating tool...');
            
            try {
                updateProgress(10, isEditing ? 'ðŸ“ Updating tool...' : 'ðŸ“ Creating tool...');
                
                // Use PUT for editing, POST for creating
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? API+'/api/tools/'+editingToolId : API+'/api/tools';
                
                const r=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify({type:toolType,name,description:desc,config,api_config})});
                
                // Check for errors (including duplicate name)
                if(!r.ok) {
                    const errorData = await r.json().catch(() => ({}));
                    const errorMsg = errorData.detail || errorData.message || `Error: ${r.status}`;
                    hideProgressModal();
                    alert('âŒ ' + errorMsg);
                    return;
                }
                
                const d=await r.json();
                
                if(toolType==='document'&&uploadedFiles.length){
                    updateProgress(30, 'ðŸ“„ Uploading documents...');
                    for(let i=0; i<uploadedFiles.length; i++){
                        const f = uploadedFiles[i];
                        updateProgress(30 + (i/uploadedFiles.length)*60, `ðŸ“„ Uploading ${f.name}...`);
                        const fd=new FormData();
                        fd.append('file',f);
                        await fetch(API+'/api/tools/'+d.tool_id+'/documents',{method:'POST',body:fd});
                    }
                    updateProgress(100, 'âœ… Documents uploaded!');
                }
                
                if(toolType==='website'&&config.url){
                    updateProgress(20, 'ðŸŒ Starting web scraper...');
                    
                    // Check if dynamic site
                    const domain = new URL(config.url).hostname;
                    const dynamicSites = ['oracle.com','azure.microsoft.com','cloud.google.com','aws.amazon.com','digitalocean.com','vercel.com','netlify.com','heroku.com'];
                    const isDynamic = dynamicSites.some(s => domain.includes(s));
                    
                    let progressInterval;
                    let currentProgress = 20;
                    
                    if(isDynamic){
                        updateProgress(25, 'ðŸŽ­ Detected dynamic site - launching Playwright browser...');
                        
                        // Simulate progress during long scrape
                        const progressSteps = [
                            {p: 30, msg: 'ðŸŽ­ [1/7] Launching Chromium browser...'},
                            {p: 35, msg: 'ðŸŽ­ [2/7] Creating browser context...'},
                            {p: 40, msg: 'ðŸŽ­ [3/7] Navigating to page...'},
                            {p: 50, msg: 'ðŸŽ­ [4/7] Waiting for JavaScript to render...'},
                            {p: 60, msg: 'ðŸŽ­ [5/7] Scrolling to load dynamic content...'},
                            {p: 70, msg: 'ðŸŽ­ [6/7] Extracting rendered HTML...'},
                            {p: 80, msg: 'ðŸ“Š Extracting tables and pricing data...'},
                        ];
                        let stepIndex = 0;
                        
                        progressInterval = setInterval(() => {
                            if(stepIndex < progressSteps.length){
                                updateProgress(progressSteps[stepIndex].p, progressSteps[stepIndex].msg);
                                stepIndex++;
                            }
                        }, 4000); // Every 4 seconds
                    } else {
                        updateProgress(30, 'ðŸ“„ Fetching page content...');
                        progressInterval = setInterval(() => {
                            if(currentProgress < 80){
                                currentProgress += 10;
                                updateProgress(currentProgress, 'ðŸ“„ Processing page...');
                            }
                        }, 2000);
                    }
                    
                    try {
                        const scrapeResult = await fetch(API+'/api/tools/'+d.tool_id+'/scrape',{
                            method:'POST',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({url:config.url,recursive:config.recursive,max_pages:config.max_pages})
                        });
                        
                        clearInterval(progressInterval);
                        
                        const scrapeData = await scrapeResult.json();
                        
                        if(scrapeData.pages_scraped > 0){
                            updateProgress(100, `âœ… Successfully scraped ${scrapeData.pages_scraped} page(s)!`);
                        } else {
                            updateProgress(100, 'âš ï¸ No content found on page');
                        }
                    } catch(scrapeError) {
                        clearInterval(progressInterval);
                        updateProgress(100, `âŒ Scrape failed: ${scrapeError.message}`);
                    }
                }
                
                if(toolType==='api'){
                    updateProgress(100, 'âœ… API Tool created!');
                }
                
                // Wait a moment to show success
                await new Promise(r => setTimeout(r, 1500));
                
                hideProgressModal();
                hideModal('modal-tool');
                
                // Show success notification
                const wasEditing = !!editingToolId;
                showToast(wasEditing ? 'Tool updated successfully!' : 'Tool created successfully!', 'success');
                
                // Reset editing state
                editingToolId = null;
                
                loadTools();
                loadWizardTools();
                
                // Navigate to tool detail to see the data
                viewTool(d.tool_id || d.id);
                
            } catch(error) {
                updateProgress(0, `âŒ Error: ${error.message}`);
                await new Promise(r => setTimeout(r, 2000));
                hideProgressModal();
                editingToolId = null;
            }
        }
        
        function showProgressModal(title){
            ensureModalInBody('progress-modal');
            document.getElementById('progress-modal').classList.remove('hidden');
            document.getElementById('progress-title').textContent = title;
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-status').textContent = 'Starting...';
            document.getElementById('progress-log').innerHTML = '';
            // Disable create button (check both possible IDs)
            const createBtn = document.getElementById('create-tool-btn') || document.getElementById('btn-create');
            if (createBtn) {
                createBtn.disabled = true;
                createBtn.dataset.originalText = createBtn.textContent;
                createBtn.textContent = 'Creating...';
            }
        }
        
        function updateProgress(percent, status){
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-status').textContent = status;
            // Add to log
            const log = document.getElementById('progress-log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `<div class="text-xs text-gray-400">[${time}] ${status}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function hideProgressModal(){
            document.getElementById('progress-modal').classList.add('hidden');
            document.getElementById('progress-log').innerHTML = '';
            // Re-enable create button (check both possible IDs)
            const createBtn = document.getElementById('create-tool-btn') || document.getElementById('btn-create');
            if (createBtn) {
                createBtn.disabled = false;
                createBtn.textContent = createBtn.dataset.originalText || 'Create Tool';
            }
        }

        async function loadChatAgents(){
            console.log('ðŸ” [loadChatAgents] Starting...');
            const headers = getAuthHeaders();
            console.log('ðŸ” [loadChatAgents] Auth headers:', {
                hasAuth: !!headers.Authorization,
                tokenLength: headers.Authorization ? headers.Authorization.length : 0,
                tokenPreview: headers.Authorization ? headers.Authorization.substring(0, 20) + '...' : 'none',
                currentUser: currentUser ? { id: currentUser.id, email: currentUser.email } : null,
                authTokenExists: !!authToken
            });
            
            try {
                // Use /api/agents/accessible for chat - shows agents user can CHAT with
                // (different from /api/agents which shows agents user can MANAGE)
                const r=await fetch(API+'/api/agents/accessible', {
                    headers: headers
                });
                
                console.log('ðŸ” [loadChatAgents] Response status:', r.status, r.statusText);
                
                if (!r.ok) {
                    console.error('âŒ [loadChatAgents] Request failed:', r.status, r.statusText);
                    const errorText = await r.text().catch(() => '');
                    console.error('âŒ [loadChatAgents] Error response:', errorText);
                    
                    // If unauthorized, the user might not be logged in
                    if (r.status === 401) {
                        console.error('âŒ [loadChatAgents] 401 Unauthorized - checking auth state:', {
                            authToken: authToken ? 'exists' : 'missing',
                            tokenFromStorage: localStorage.getItem('agentforge_token') ? 'exists' : 'missing',
                            currentUser: currentUser ? 'exists' : 'missing'
                        });
                        showToast('Please login to access agents', 'error');
                        // Don't navigate to dashboard if we're already on chat page
                        if (_currentPage !== 'chat') {
                            navigate('dashboard');
                        }
                        return;
                    }
                    return;
                }
                
                const d=await r.json();
                // Handle different response formats
                let agents = [];
                if (Array.isArray(d)) {
                    agents = d;
                } else if (d && Array.isArray(d.agents)) {
                    agents = d.agents;
                }

                // Chat UI should only show conversational agents.
                // Process agents are handled via Processes UI (runs/forms), not chat.
                const chatAgents = (agents || []).filter(a => {
                    const t = (a && (a.agent_type || a.type)) ? String(a.agent_type || a.type).toLowerCase() : 'conversational';
                    return t !== 'process';
                });
                
                const agentSelect = document.getElementById('chat-agent');
                if (agentSelect) {
                    agentSelect.innerHTML='<option value="">Select Agent...</option>'+chatAgents.map(a=>`<option value="${a.id}">${a.icon || 'ðŸ¤–'} ${a.name}</option>`).join('');
                }
                
                return chatAgents; // Return agents for verification
            } catch (err) {
                console.error('loadChatAgents error:', err);
                return [];
            }
        }

        async function onAgentChange(){
            try {
                const id=document.getElementById('chat-agent').value;
                if(!id) {
                    // Show default message when no agent selected
                    const msgContainer = document.getElementById('chat-messages');
                    if (msgContainer) {
                        msgContainer.innerHTML = '<div class="chat-welcome"><div class="chat-welcome-icon">ðŸ’¬</div><h2>Welcome to Chat</h2><p>Select an agent from the sidebar to start a conversation</p></div>';
                    }
                    // Update header
                    updateChatHeader(null);
                    return;
                }
                
                // Show loading state
                const msgContainer = document.getElementById('chat-messages');
                if (msgContainer) {
                    msgContainer.innerHTML = '<div class="chat-welcome"><div class="chat-welcome-icon" style="animation:pulse 1.5s infinite">â³</div><h2>Loading...</h2><p>Preparing your chat experience</p></div>';
                }
                
                // Load conversations for this agent
                const r=await fetch(API+'/api/agents/'+id+'/conversations', {
                    headers: getAuthHeaders()
                });
                
                if (!r.ok) {
                    console.error('Failed to load conversations:', r.status);
                    if (r.status === 401) {
                        showToast('Please login to access this agent', 'error');
                        return;
                    }
                }
                
                const d=await r.json();
                
                // Update conversation list sidebar
                chatConversations = d.conversations || [];
                renderChatConvList();
                
                // Sync mobile selector
                const mobileAgent = document.getElementById('chat-agent-mobile');
                if (mobileAgent) mobileAgent.value = id;
                
                // If there are existing conversations, load the most recent one
                // Otherwise, show welcome message (don't create new conversation until user sends message)
                console.log('ðŸ” [CHAT] Conversations loaded:', chatConversations.length, chatConversations.map(c => ({id: c.id?.substring(0,8), title: c.title})));
                if (chatConversations.length > 0) {
                    // Load the most recent conversation (first in list - already sorted by updated_at desc)
                    console.log('ðŸ“‚ [CHAT] Loading last conversation:', chatConversations[0].id, chatConversations[0].title);
                    await loadChatConversation(chatConversations[0].id);
                } else {
                    // No conversations - show welcome message
                    console.log('âœ¨ [CHAT] No conversations, showing welcome');
                    conv = null;
                    await startChatWithWelcome(id);
                }
            } catch (err) {
                console.error('onAgentChange error:', err);
                showToast('Failed to load chat: ' + err.message, 'error');
                const msgContainer = document.getElementById('chat-messages');
                if (msgContainer) {
                    msgContainer.innerHTML = '<div class="chat-welcome"><div class="chat-welcome-icon">âŒ</div><h2>Failed to Load</h2><p>' + esc(err.message) + '</p></div>';
                }
            }
        }
        
        // Update desktop header with agent info
        function updateChatHeader(agent) {
            const nameEl = document.getElementById('chat-agent-name');
            const statusEl = document.getElementById('chat-agent-status');
            const dotEl = document.getElementById('chat-online-dot');
            const avatarEl = document.querySelector('.chat-header-avatar');
            
            if (!agent) {
                if (nameEl) nameEl.textContent = 'Select an Agent';
                if (statusEl) statusEl.textContent = 'Choose an agent to start chatting';
                if (dotEl) dotEl.style.display = 'none';
                if (avatarEl) avatarEl.textContent = 'ðŸ¤–';
                return;
            }
            
            if (nameEl) nameEl.textContent = agent.name || 'AI Assistant';
            if (statusEl) statusEl.textContent = agent.description || 'Ready to help';
            if (dotEl) dotEl.style.display = 'inline-block';
            if (avatarEl) avatarEl.textContent = agent.icon || 'ðŸ¤–';
        }
        
        async function startChatWithWelcome(agentId){
            const msgContainer = document.getElementById('chat-messages');
            msgContainer.innerHTML = '<div class="chat-welcome"><div class="chat-welcome-icon" style="animation:pulse 1.5s infinite">â³</div><h2>Loading...</h2><p>Preparing your chat</p></div>';
            
            try {
                const response = await fetch(API+'/api/agents/'+agentId+'/start-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    }
                });
                
                if(!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('âŒ Start chat failed:', response.status, errorData);
                    let errorMsg = `Failed to start chat session (${response.status})`;
                    if(errorData.detail) {
                        if(typeof errorData.detail === 'object') {
                            errorMsg = errorData.detail.message || errorData.detail.error || JSON.stringify(errorData.detail);
                        } else {
                            errorMsg = errorData.detail;
                        }
                    } else if(errorData.message) {
                        errorMsg = errorData.message;
                    }
                    throw new Error(errorMsg);
                }
                
                const session = await response.json();
                console.log('ðŸ“¨ Start chat response:', session);
                
                // Store the conversation ID
                conv = session.conversation_id;
                
                // Update header with agent info
                updateChatHeader({ 
                    name: session.agent_name, 
                    description: session.agent_description || 'Ready to help you',
                    icon: session.agent_icon || 'ðŸ¤–'
                });
                
                // Build personalized welcome message - Modern UI
                const fullName = session.user_name || 'User';
                const firstName = fullName.split(' ')[0];
                const agentName = session.agent_name || 'Assistant';
                const tasks = session.accessible_tasks || [];
                
                let welcomeHtml = `
                    <div class="chat-welcome">
                        <div class="chat-welcome-icon">ðŸ‘‹</div>
                        <h2>Hi ${esc(firstName)}!</h2>
                        <p>I'm <strong style="color:var(--accent-primary)">${esc(agentName)}</strong>. How can I help you today?</p>
                `;
                
                if(tasks.length > 0) {
                    const visibleTasks = tasks.slice(0, 5);
                    const hiddenTasks = tasks.slice(5);
                    const hasMore = hiddenTasks.length > 0;
                    
                    welcomeHtml += `
                        <div style="margin-top:24px;text-align:left;max-width:400px;margin-left:auto;margin-right:auto;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:16px;padding:20px">
                            <p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.05em">âœ¨ What I can do for you</p>
                            <ul style="font-size:0.875rem;color:var(--text-primary);list-style:none;padding:0;margin:0">
                                ${visibleTasks.map(t => `<li style="padding:6px 0;display:flex;align-items:center;gap:8px"><span style="color:var(--accent-primary)">â†’</span> ${esc(t)}</li>`).join('')}
                                ${hasMore ? `
                                    <li id="welcome-tasks-hidden" class="hidden">
                                        ${hiddenTasks.map(t => `<span style="display:block;padding:6px 0"><span style="color:var(--accent-primary)">â†’</span> ${esc(t)}</span>`).join('')}
                                    </li>
                                    <li id="welcome-tasks-toggle" style="padding:8px 0;color:var(--accent-primary);cursor:pointer;font-size:0.75rem" onclick="toggleWelcomeTasks()">
                                        â†“ Show ${hiddenTasks.length} more capabilities
                                    </li>
                                ` : ''}
                            </ul>
                        </div>
                    `;
                }
                
                welcomeHtml += '</div>';
                msgContainer.innerHTML = welcomeHtml;
                
            } catch(err) {
                console.error('Start chat error:', err);
                msgContainer.innerHTML = '<div class="chat-welcome"><div class="chat-welcome-icon">ðŸ’¬</div><h2>Start a Conversation</h2><p>Type a message below to begin</p></div>';
            }
        }

        // onConvChange removed - now using sidebar list instead of dropdown

        // File handling for chat
        function handleChatFile(event){
            const files = Array.from(event.target.files);
            chatAttachments = [...chatAttachments, ...files];
            renderChatAttachments();
            event.target.value = '';
        }
        
        function handleTestFile(event){
            const files = Array.from(event.target.files);
            testAttachments = [...testAttachments, ...files];
            renderTestAttachments();
            event.target.value = '';
        }
        
        function renderChatAttachments(){
            const container = document.getElementById('chat-attachments');
            if(chatAttachments.length === 0){
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');
            container.innerHTML = chatAttachments.map((f, i) => `
                <div class="flex items-center gap-2 bg-gray-700 text-white rounded-lg px-3 py-1 text-sm">
                    <span>${getFileIcon(f.name)} ${f.name.substring(0, 20)}${f.name.length > 20 ? '...' : ''}</span>
                    <button onclick="removeChatAttachment(${i})" class="text-red-400 hover:text-red-300">âœ•</button>
                </div>
            `).join('');
        }
        
        function renderTestAttachments(){
            const container = document.getElementById('test-attachments');
            if(testAttachments.length === 0){
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');
            container.innerHTML = testAttachments.map((f, i) => `
                <div class="flex items-center gap-2 bg-gray-700 text-white rounded-lg px-3 py-1 text-sm">
                    <span>${getFileIcon(f.name)} ${f.name.substring(0, 20)}${f.name.length > 20 ? '...' : ''}</span>
                    <button onclick="removeTestAttachment(${i})" class="text-red-400 hover:text-red-300">âœ•</button>
                </div>
            `).join('');
        }
        
        function getFileIcon(filename){
            const ext = filename.toLowerCase().split('.').pop();
            const icons = {
                'pdf': 'ðŸ“•',
                'doc': 'ðŸ“˜', 'docx': 'ðŸ“˜',
                'xls': 'ðŸ“Š', 'xlsx': 'ðŸ“Š',
                'ppt': 'ðŸ“½ï¸', 'pptx': 'ðŸ“½ï¸',
                'csv': 'ðŸ“‹',
                'txt': 'ðŸ“', 'md': 'ðŸ“',
                'png': 'ðŸ–¼ï¸', 'jpg': 'ðŸ–¼ï¸', 'jpeg': 'ðŸ–¼ï¸', 'gif': 'ðŸ–¼ï¸', 'webp': 'ðŸ–¼ï¸', 'bmp': 'ðŸ–¼ï¸', 'svg': 'ðŸ–¼ï¸'
            };
            return icons[ext] || 'ðŸ“„';
        }
        
        function removeChatAttachment(index){
            chatAttachments.splice(index, 1);
            renderChatAttachments();
        }
        
        function removeTestAttachment(index){
            testAttachments.splice(index, 1);
            renderTestAttachments();
        }

        async function sendMsg(){
            const aid=document.getElementById('chat-agent').value;
            const inp=document.getElementById('chat-input');
            const m=inp.value.trim();
            if(!aid){alert('Please select an agent');return;}
            if(!m && chatAttachments.length === 0)return;
            inp.value='';
            
            // Get user's timezone
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            // Show message with attachments
            let displayMsg = m;
            if(chatAttachments.length > 0){
                displayMsg += '\n\nðŸ“Ž Attachments: ' + chatAttachments.map(f => f.name).join(', ');
            }
            addMsg('user', displayMsg);
            addTyping();
            
            try{
                let response;
                if(chatAttachments.length > 0){
                    // Send with FormData for file upload
                    const formData = new FormData();
                    formData.append('message', m);
                    formData.append('timezone', userTimezone);
                    if(conv) formData.append('conversation_id', conv);
                    chatAttachments.forEach(f => formData.append('files', f));
                    response = await fetch(API+'/api/agents/'+aid+'/chat-with-files', {
                        method:'POST', 
                        headers: getAuthHeaders(),
                        body: formData
                    });
                } else {
                    // Use streaming endpoint for real-time thinking display
                    await sendMsgStreaming(aid, m, userTimezone);
                    return; // streaming handles everything
                }
                const d=await response.json();
                rmTyping();
                conv=d.conversation_id;
                addMsg('assistant',d.response,d.sources);
                // Update conversation list
                updateConvDropdown(d.conversation_id, m);
                // Clear attachments after send
                chatAttachments = [];
                renderChatAttachments();
            }catch(e){rmTyping();addMsg('error','Error: '+e.message);}
        }

        // Streaming chat with real-time thinking display (inline like ChatGPT)
        let thinkingTypeTimer = null; // Track typing animation
        
        async function sendMsgStreaming(aid, message, timezone){
            const c=document.getElementById('chat-messages');
            
            // Add thinking message - Modern design
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = 'thinking-container';
            thinkingDiv.className = 'msg-row assistant';
            thinkingDiv.innerHTML = `
                <div class="msg-avatar">ðŸ¤–</div>
                <div class="msg-bubble thinking-bubble" style="display:flex;align-items:center;gap:10px;padding:14px 18px">
                    <span class="thinking-dot"></span>
                    <span id="thinking-content" style="font-style:italic">Thinking...</span>
                </div>
            `;
            c.appendChild(thinkingDiv);
            c.scrollTop = c.scrollHeight;
            
            let fullContent = '';
            let sources = [];
            let buffer = ''; // Buffer for incomplete SSE data
            
            try {
                const response = await fetch(API+'/api/agents/'+aid+'/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: conv,
                        timezone: timezone
                    })
                });
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    // Add to buffer and process complete lines
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    
                    // Keep incomplete line in buffer
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.slice(6).trim();
                                if (!jsonStr) continue;
                                const data = JSON.parse(jsonStr);
                                
                                switch (data.type) {
                                    case 'thinking':
                                        setThinkingText(data.content);
                                        break;
                                    case 'tool_call':
                                        setThinkingText(data.content);
                                        break;
                                    case 'tool_result':
                                        setThinkingText(data.content);
                                        break;
                                    case 'conversation_id':
                                        conv = data.content;
                                        break;
                                    case 'content':
                                        fullContent += data.content;
                                        break;
                                    case 'sources':
                                        sources = data.content || [];
                                        break;
                                    case 'done':
                                        finishThinkingUI(true);
                                        break;
                                    case 'error':
                                        // IMPORTANT: show the error to the user (don't remove the bubble silently)
                                        finishThinkingUI(false);
                                        addMsg('error', data.content || 'Error: failed to get a response.');
                                        return;
                                }
                            } catch (e) { 
                                // Invalid JSON, skip
                            }
                        }
                    }
                }
                
                // Add the final response
                if (fullContent) {
                    addMsg('assistant', fullContent, sources);
                    updateConvDropdown(conv, message);
                } else {
                    // Stream finished but no content was received (avoid silent failure UX)
                    addMsg('error', 'No response received. Please try again.');
                }
                
            } catch (e) {
                console.error('Streaming error:', e);
                finishThinkingUI(false);
                addMsg('error', 'Connection error. Please try again.');
            }
        }
        
        // Simple text update without complex typing animation (avoids race conditions)
        function setThinkingText(content) {
            const textEl = document.getElementById('thinking-content');
            if (!textEl || !content) return;
            
            // Cancel any previous typing animation
            if (thinkingTypeTimer) {
                clearTimeout(thinkingTypeTimer);
                thinkingTypeTimer = null;
            }
            
            // Simple fade-in effect by updating text directly
            textEl.style.opacity = '0.5';
            textEl.textContent = content;
            
            // Fade in
            setTimeout(() => {
                textEl.style.opacity = '1';
            }, 50);
            
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        }
        
        function finishThinkingUI(success) {
            // Remove thinking message
            const container = document.getElementById('thinking-container');
            if (container) {
                container.remove();
            }
            // Also remove typing indicator if still there
            rmTyping();
        }
        
        function updateConvDropdown(convId, message) {
            // Update sidebar list
            if (!chatConversations.find(c => c.id === convId)) {
                chatConversations.unshift({
                    id: convId,
                    title: message.substring(0, 30) + '...'
                });
                renderChatConvList();
            }
            conv = convId;
        }

        function addMsg(role,content,sources=[]){
            const c=document.getElementById('chat-messages');
            const d=document.createElement('div');
            d.className='msg-row ' + role;
            
            if(role==='user') {
                d.innerHTML=`<div class="msg-bubble user">${esc(content)}</div>`;
            } else if(role==='assistant'){
                d.innerHTML=`
                    <div class="msg-avatar">ðŸ¤–</div>
                    <div>
                        <div class="msg-bubble assistant chat-content">${fmt(content)}</div>
                        ${sources?.length ? `<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px">${sources.map(s=>`<span class="source-badge px-2 py-1 rounded text-xs">${s.source}</span>`).join('')}</div>` : ''}
                    </div>
                `;
            } else {
                d.className = '';
                d.innerHTML=`<div style="text-align:center;color:#f87171;font-size:0.875rem;padding:12px">${content}</div>`;
            }
            c.appendChild(d);
            c.scrollTop=c.scrollHeight;
            d.querySelectorAll('pre code').forEach(b=>hljs.highlightElement(b));
        }

        function addTyping(){
            const c=document.getElementById('chat-messages');
            const d=document.createElement('div');
            d.id='typing';
            d.className='msg-row assistant';
            d.innerHTML=`
                <div class="msg-avatar">ðŸ¤–</div>
                <div class="msg-bubble assistant" style="display:flex;align-items:center;gap:6px;padding:16px 20px">
                    <span class="thinking-dot"></span>
                    <span class="thinking-dot" style="animation-delay:0.2s"></span>
                    <span class="thinking-dot" style="animation-delay:0.4s"></span>
                </div>
            `;
            c.appendChild(d);
            c.scrollTop=c.scrollHeight;
        }

        function rmTyping(){document.getElementById('typing')?.remove();}
        
        // ============================================================================
        // CHAT CONVERSATION MANAGEMENT (with selection/bulk delete)
        // ============================================================================
        let chatConversations = [];
        let chatSelectionMode = false;
        let chatSelectedConvs = new Set();
        
        function renderChatConvList() {
            const container = document.getElementById('chat-conv-list');
            const agentId = document.getElementById('chat-agent').value;
            
            if (!agentId) {
                container.innerHTML = '<div class="conv-empty"><div class="conv-empty-icon">ðŸ¤–</div><p class="conv-empty-text">Select an agent to start</p></div>';
                return;
            }
            
            if (chatConversations.length === 0) {
                container.innerHTML = '<div class="conv-empty"><div class="conv-empty-icon">âœ¨</div><p class="conv-empty-text">No conversations yet<br><span style="font-size:0.75rem;opacity:0.6">Click "New Chat" to begin</span></p></div>';
                return;
            }
            
            container.innerHTML = chatConversations.map(c => {
                const timeAgo = formatTimeAgo(c.updated_at || c.created_at);
                return `
                <div class="conv-item ${conv === c.id ? 'active' : ''} ${chatSelectedConvs.has(c.id) ? 'selected' : ''}"
                     onclick="${chatSelectionMode ? `toggleChatConvSelection('${c.id}')` : `loadChatConversation('${c.id}')`}">
                    ${chatSelectionMode ? `<div class="conv-checkbox ${chatSelectedConvs.has(c.id) ? 'checked' : ''}" onclick="event.stopPropagation(); toggleChatConvSelection('${c.id}')"></div>` : ''}
                    <div class="conv-icon">ðŸ’¬</div>
                    <div class="conv-content">
                        <div class="conv-title">${esc(c.title || 'Untitled')}</div>
                        <div class="conv-time">${timeAgo}</div>
                    </div>
                </div>
            `}).join('');
            
            updateChatDeleteButton();
        }
        
        // Format time ago helper
        function formatTimeAgo(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
        
        async function loadChatConversations(agentId) {
            try {
                const r = await fetch(API+'/api/agents/'+agentId+'/conversations', {
                    headers: getAuthHeaders()
                });
                const d = await r.json();
                chatConversations = d.conversations || [];
                renderChatConvList();
            } catch(e) {
                console.error('Failed to load conversations:', e);
                chatConversations = [];
                renderChatConvList();
            }
        }
        
        async function loadChatConversation(convId) {
            console.log('ðŸ“¥ [loadChatConversation] Loading conversation:', convId);
            conv = convId;
            try {
                const r = await fetch(API+'/api/conversations/'+convId, {
                    headers: getAuthHeaders()
                });
                const c = await r.json();
                
                console.log('ðŸ“¥ [loadChatConversation] Loaded conversation:', {
                    id: c.id,
                    title: c.title,
                    messageCount: (c.messages || []).length,
                    messages: (c.messages || []).map(m => ({role: m.role, contentPreview: m.content?.substring(0, 50)}))
                });
                
                // Render messages - Modern UI
                const container = document.getElementById('chat-messages');
                if (!container) {
                    console.error('âŒ [loadChatConversation] chat-messages container not found!');
                    return;
                }
                
                const messagesHtml = (c.messages || []).map(m => {
                    if (m.role === 'user') {
                        return `<div class="msg-row user"><div class="msg-bubble user">${esc(m.content)}</div></div>`;
                    } else {
                        return `<div class="msg-row assistant"><div class="msg-avatar">ðŸ¤–</div><div class="msg-bubble assistant chat-content">${fmt(m.content)}</div></div>`;
                    }
                }).join('');
                
                console.log('ðŸ“¥ [loadChatConversation] Rendering', (c.messages || []).length, 'messages to container');
                container.innerHTML = messagesHtml;
                container.scrollTop = container.scrollHeight;
                
                // Highlight code blocks
                container.querySelectorAll('pre code').forEach(b=>hljs.highlightElement(b));
                
                renderChatConvList();
                console.log('âœ… [loadChatConversation] Done! Messages displayed.');
            } catch(e) {
                console.error('âŒ [loadChatConversation] Failed to load conversation:', e);
            }
        }
        
        function startNewChatConversation() {
            conv = null;
            chatSelectedConvs.clear();
            if (chatSelectionMode) toggleChatSelectionMode();
            
            const agentId = document.getElementById('chat-agent').value;
            if (agentId) {
                startChatWithWelcome(agentId);
            } else {
                clearMsgs();
            }
            renderChatConvList();
        }
        
        function toggleChatSelectionMode() {
            chatSelectionMode = !chatSelectionMode;
            chatSelectedConvs.clear();
            
            const editBtn = document.getElementById('chat-edit-btn');
            const selectionBar = document.getElementById('chat-selection-bar');
            
            if (chatSelectionMode) {
                editBtn.textContent = 'Done';
                editBtn.classList.add('active');
            } else {
                editBtn.textContent = 'Edit';
                editBtn.classList.remove('active');
            }
            
            if (selectionBar) {
                selectionBar.classList.toggle('hidden', !chatSelectionMode);
            }
            
            renderChatConvList();
        }
        
        function toggleChatConvSelection(convId) {
            if (chatSelectedConvs.has(convId)) {
                chatSelectedConvs.delete(convId);
            } else {
                chatSelectedConvs.add(convId);
            }
            renderChatConvList();
        }
        
        function toggleChatSelectAll() {
            const allIds = chatConversations.map(c => c.id);
            const allSelected = allIds.every(id => chatSelectedConvs.has(id));
            
            if (allSelected) {
                chatSelectedConvs.clear();
                document.getElementById('chat-select-all-text').textContent = 'Select All';
            } else {
                allIds.forEach(id => chatSelectedConvs.add(id));
                document.getElementById('chat-select-all-text').textContent = 'Deselect All';
            }
            
            renderChatConvList();
        }
        
        function updateChatDeleteButton() {
            const btn = document.getElementById('chat-delete-selected-btn');
            const count = chatSelectedConvs.size;
            btn.textContent = `Delete (${count})`;
            btn.disabled = count === 0;
        }
        
        async function deleteChatSelectedConvs() {
            if (chatSelectedConvs.size === 0) return;
            
            const count = chatSelectedConvs.size;
            if (!confirm(`Delete ${count} conversation${count > 1 ? 's' : ''}? This cannot be undone.`)) {
                return;
            }
            
            const btn = document.getElementById('chat-delete-selected-btn');
            btn.textContent = 'Deleting...';
            btn.disabled = true;
            
            try {
                const response = await fetch(API+'/api/conversations/bulk', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        conversation_ids: Array.from(chatSelectedConvs)
                    })
                });
                
                const result = await response.json();
                
                // Clear current if deleted
                if (conv && chatSelectedConvs.has(conv)) {
                    conv = null;
                    clearMsgs();
                }
                
                // Reload
                chatSelectedConvs.clear();
                const agentId = document.getElementById('chat-agent').value;
                if (agentId) await loadChatConversations(agentId);
                
                toggleChatSelectionMode();
                
                if (result.failed > 0) {
                    alert(`Failed to delete ${result.failed} conversation(s)`);
                }
                
            } catch(e) {
                console.error('Delete error:', e);
                alert('Failed to delete: ' + e.message);
                updateChatDeleteButton();
            }
        }
        
        function toggleChatSidebar() {
            const sidebar = document.getElementById('chat-sidebar');
            sidebar.classList.toggle('hidden');
        }
        
        async function clearChat(){
            if(conv){
                try{
                    await fetch(API+'/api/conversations/'+conv,{method:'DELETE',headers:getAuthHeaders()});
                    // Remove from list
                    chatConversations = chatConversations.filter(c => c.id !== conv);
                    renderChatConvList();
                }catch(e){console.error('Delete conversation error:',e);}
            }
            conv=null;clearMsgs();
        }
        function clearMsgs(){document.getElementById('chat-messages').innerHTML=`<div class="chat-welcome"><div class="chat-welcome-icon">ðŸ’¬</div><h2>Start a Conversation</h2><p>Type a message below to begin chatting</p></div>`;}
        
        function toggleWelcomeTasks() {
            const hidden = document.getElementById('welcome-tasks-hidden');
            const toggle = document.getElementById('welcome-tasks-toggle');
            if (hidden && toggle) {
                if (hidden.classList.contains('hidden')) {
                    hidden.classList.remove('hidden');
                    toggle.textContent = 'â–² Show less';
                } else {
                    hidden.classList.add('hidden');
                    const count = hidden.querySelectorAll('span').length;
                    toggle.textContent = `... and ${count} more`;
                }
            }
        }
        function showModal(id){document.getElementById(id).classList.remove('hidden');}
        function hideModal(id){document.getElementById(id).classList.add('hidden');}
        function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
        function fmt(t){
            // Clean LaTeX notation for better display
            if (!t || typeof t !== 'string') return '';
            let text = String(t);
            // Convert LaTeX math symbols to readable format
            text = text.replace(/\\times/g, 'Ã—');
            text = text.replace(/\\div/g, 'Ã·');
            text = text.replace(/\\pm/g, 'Â±');
            text = text.replace(/\\leq/g, 'â‰¤');
            text = text.replace(/\\geq/g, 'â‰¥');
            text = text.replace(/\\neq/g, 'â‰ ');
            text = text.replace(/\\approx/g, 'â‰ˆ');
            text = text.replace(/\\cdot/g, 'Â·');
            text = text.replace(/\\text\{([^}]+)\}/g, '$1');
            // Remove LaTeX brackets but keep content
            text = text.replace(/\\\[/g, '');
            text = text.replace(/\\\]/g, '');
            text = text.replace(/\\\(/g, '');
            text = text.replace(/\\\)/g, '');
            // Clean up display math blocks
            text = text.replace(/\[\s*([^\]]+)\s*\]/g, (match, content) => {
                // If it looks like math (has operators), format it nicely
                if(content.includes('=') || content.includes('Ã—') || content.includes('+') || content.includes('-')){
                    return '\n**' + content.trim() + '**\n';
                }
                return match;
            });
            
            if(typeof marked!=='undefined'){
                marked.setOptions({breaks:true,gfm:true});
                let html = marked.parse(text);
                // Wrap tables in responsive container
                html = html.replace(/<table>/g, '<div class="table-container"><table>');
                html = html.replace(/<\/table>/g, '</table></div>');
                return html;
            }
            return esc(text).replace(/\n/g,'<br>');
        }
        function fileIcon(ext){const i={pdf:'ðŸ“•',doc:'ðŸ“˜',docx:'ðŸ“˜',xls:'ðŸ“—',xlsx:'ðŸ“—',ppt:'ðŸ“™',pptx:'ðŸ“™',txt:'ðŸ“„',csv:'ðŸ“Š',md:'ðŸ“'};return i[ext?.toLowerCase()]||'ðŸ“„';}
        function fmtSize(b){if(b<1024)return b+' B';if(b<1024*1024)return(b/1024).toFixed(1)+' KB';return(b/1024/1024).toFixed(1)+' MB';}

        // ============================================================================
        // Theme Functions
        // ============================================================================
        
        const THEMES = ['dark', 'light', 'ocean', 'sunset', 'forest', 'midnight'];
        
        function setTheme(themeName) {
            if (!THEMES.includes(themeName)) themeName = 'dark';
            
            // Remove old theme
            document.documentElement.removeAttribute('data-theme');
            
            // Apply new theme (dark is default, so no attribute needed)
            if (themeName !== 'dark') {
                document.documentElement.setAttribute('data-theme', themeName);
            }
            
            // Save preference
            localStorage.setItem('agentforge-theme', themeName);
            
            // Update UI buttons
            updateThemeButtons(themeName);
            
            console.log('Theme changed to:', themeName);
        }
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('agentforge-theme') || 'dark';
            setTheme(savedTheme);
        }
        
        function updateThemeButtons(activeTheme) {
            document.querySelectorAll('.theme-btn').forEach(btn => {
                const btnTheme = btn.getAttribute('data-theme-btn');
                const checkmark = btn.querySelector('.theme-check');
                
                if (btnTheme === activeTheme) {
                    btn.classList.add('border-purple-500', 'bg-purple-500/10');
                    btn.classList.remove('border-gray-700', 'border-transparent');
                    if (checkmark) checkmark.classList.remove('hidden');
                    if (checkmark) checkmark.classList.add('flex');
                } else {
                    btn.classList.remove('border-purple-500', 'bg-purple-500/10');
                    btn.classList.add('border-gray-700');
                    if (checkmark) checkmark.classList.add('hidden');
                    if (checkmark) checkmark.classList.remove('flex');
                }
            });
        }
        
        // ============================================================================
        // INTEGRATION SETUP (Admin Only)
        // ============================================================================
        
        function showIntegrationSetup(provider) {
            const providerInfo = {
                google: {
                    name: 'Google',
                    icon: `<svg width="32" height="32" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>`,
                    consoleUrl: 'https://console.cloud.google.com/apis/credentials',
                    apiUrl: 'https://console.cloud.google.com/apis/library/gmail.googleapis.com',
                    scopes: 'Gmail API (gmail.send)',
                    envVars: ['GOOGLE_CLIENT_ID', 'GOOGLE_CLIENT_SECRET']
                },
                microsoft: {
                    name: 'Microsoft',
                    icon: `<svg width="32" height="32" viewBox="0 0 21 21">
                        <rect x="1" y="1" width="9" height="9" fill="#F25022"/>
                        <rect x="11" y="1" width="9" height="9" fill="#7FBA00"/>
                        <rect x="1" y="11" width="9" height="9" fill="#00A4EF"/>
                        <rect x="11" y="11" width="9" height="9" fill="#FFB900"/>
                    </svg>`,
                    consoleUrl: 'https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade',
                    apiUrl: '',
                    scopes: 'Mail.Send, User.Read',
                    envVars: ['MICROSOFT_CLIENT_ID', 'MICROSOFT_CLIENT_SECRET']
                }
            };
            
            const info = providerInfo[provider];
            const redirectUri = `${window.location.origin}/api/oauth/${provider}/callback`;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4';
            modal.id = 'integration-setup-modal';
            modal.innerHTML = `
                <div class="modal-content-box rounded-2xl w-full max-w-xl max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b flex items-center justify-between shrink-0" style="border-color:var(--border-color);">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-white flex items-center justify-center">
                                ${info.icon}
                            </div>
                            <h3 class="font-bold text-lg" style="color:var(--text-primary);">Configure ${info.name}</h3>
                        </div>
                        <button onclick="document.getElementById('integration-setup-modal').remove()" 
                                class="text-gray-400 hover:text-white text-xl">Ã—</button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto flex-1 space-y-6">
                        <!-- Steps -->
                        <div class="space-y-4">
                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center shrink-0 text-sm font-bold">1</div>
                                <div class="flex-1">
                                    <h5 class="font-medium" style="color:var(--text-primary);">Create OAuth App</h5>
                                    <p class="text-sm mt-1" style="color:var(--text-muted);">Create a new OAuth application in ${info.name} Console</p>
                                    <a href="${info.consoleUrl}" target="_blank" 
                                       class="inline-flex items-center gap-1 text-sm text-purple-400 hover:underline mt-2">
                                        Open ${info.name} Console â†’
                                    </a>
                                </div>
                            </div>
                            
                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center shrink-0 text-sm font-bold">2</div>
                                <div class="flex-1">
                                    <h5 class="font-medium" style="color:var(--text-primary);">Set Redirect URI</h5>
                                    <p class="text-sm mt-1" style="color:var(--text-muted);">Add this redirect URI to your OAuth app:</p>
                                    <div class="flex items-center gap-2 mt-2">
                                        <code class="flex-1 text-xs p-2 rounded" style="background:var(--bg-input);color:var(--text-secondary);">${redirectUri}</code>
                                        <button onclick="navigator.clipboard.writeText('${redirectUri}'); showToast('Copied!', 'success')" 
                                                class="btn-secondary px-3 py-2 rounded text-xs">Copy</button>
                                    </div>
                                </div>
                            </div>
                            
                            ${info.apiUrl ? `
                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center shrink-0 text-sm font-bold">3</div>
                                <div class="flex-1">
                                    <h5 class="font-medium" style="color:var(--text-primary);">Enable API</h5>
                                    <p class="text-sm mt-1" style="color:var(--text-muted);">Enable ${info.scopes}</p>
                                    <a href="${info.apiUrl}" target="_blank" 
                                       class="inline-flex items-center gap-1 text-sm text-purple-400 hover:underline mt-2">
                                        Enable API â†’
                                    </a>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="flex gap-4">
                                <div class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center shrink-0 text-sm font-bold">${info.apiUrl ? '4' : '3'}</div>
                                <div class="flex-1">
                                    <h5 class="font-medium" style="color:var(--text-primary);">Enter Credentials</h5>
                                    <p class="text-sm mt-1 mb-3" style="color:var(--text-muted);">Copy your Client ID and Secret from ${info.name}</p>
                                    
                                    <div class="space-y-3">
                                        <div>
                                            <label class="text-sm mb-1 block" style="color:var(--text-secondary);">Client ID</label>
                                            <input type="text" id="integration-client-id" 
                                                   class="input-field w-full rounded-lg px-4 py-2" 
                                                   placeholder="Enter Client ID">
                                        </div>
                                        <div>
                                            <label class="text-sm mb-1 block" style="color:var(--text-secondary);">Client Secret</label>
                                            <input type="password" id="integration-client-secret" 
                                                   class="input-field w-full rounded-lg px-4 py-2" 
                                                   placeholder="Enter Client Secret">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 border-t flex justify-between shrink-0" style="border-color:var(--border-color);">
                        <button onclick="document.getElementById('integration-setup-modal').remove()" 
                                class="btn-secondary px-6 py-2 rounded-lg">Cancel</button>
                        <button onclick="saveIntegration('${provider}')" 
                                class="btn-primary px-6 py-2 rounded-lg flex items-center gap-2">
                            <span>Save & Test</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function saveIntegration(provider) {
            const clientId = document.getElementById('integration-client-id')?.value;
            const clientSecret = document.getElementById('integration-client-secret')?.value;
            
            if (!clientId || !clientSecret) {
                showToast('Please fill in both Client ID and Client Secret', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/settings/integrations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, clientId, clientSecret })
                });
                
                if (res.ok) {
                    document.getElementById('integration-setup-modal')?.remove();
                    showToast(`${provider === 'google' ? 'Google' : 'Microsoft'} integration saved!`, 'success');
                    
                    // Update status
                    const statusEl = document.getElementById(`${provider}-integration-status`);
                    if (statusEl) {
                        statusEl.textContent = 'âœ“ Configured';
                        statusEl.style.color = '#22c55e';
                    }
                } else {
                    showToast('Failed to save integration', 'error');
                }
            } catch (err) {
                showToast('Error saving integration', 'error');
            }
        }
        
        // Load theme on page load
        loadTheme();

        // ============================================================================
        // Settings Functions
        // ============================================================================
        
        let currentSettings = null;
        
        async function loadSettings() {
            try {
                const r = await fetch(API + '/api/settings');
                const data = await r.json();
                currentSettings = data.settings;
                populateSettingsForm(currentSettings);
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }
        
        function populateSettingsForm(settings) {
            // Load configured LLM providers
            configuredLLMProviders = settings.llm_providers || [];
            
            // If no providers array but has legacy llm config, convert it
            if (configuredLLMProviders.length === 0 && settings.llm?.api_key) {
                const config = getProviderConfig(settings.llm.provider);
                configuredLLMProviders.push({
                    provider: settings.llm.provider,
                    name: config.name,
                    api_key: settings.llm.api_key,
                    api_base: settings.llm.api_base || '',
                    resource: settings.llm.resource || '',
                    models: config.models
                });
            }
            
            renderConfiguredProviders();
            updateDefaultProviderDropdown();
            
            // Set default provider and model
            if (settings.llm?.provider) {
                const defaultSelect = document.getElementById('default-llm-provider');
                if (defaultSelect) {
                    defaultSelect.value = settings.llm.provider;
                    onDefaultProviderChange();
                    if (settings.llm.model) {
                        document.getElementById('default-llm-model').value = settings.llm.model;
                    }
                }
            }
            
            // Initialize add provider form
            onLLMProviderChange();
            
            // Embedding
            document.getElementById('emb-provider').value = settings.embedding?.provider || 'openai';
            document.getElementById('emb-model').value = settings.embedding?.model || 'text-embedding-3-small';
            document.getElementById('emb-local-model').value = settings.embedding?.local_model || 'all-MiniLM-L6-v2';
            document.getElementById('emb-api-key').value = settings.embedding?.api_key || '';
            onEmbeddingProviderChange();
            
            // Vector DB
            document.getElementById('vdb-provider').value = settings.vector_db?.provider || 'memory';
            document.getElementById('vdb-chroma-path').value = settings.vector_db?.chroma_path || './data/chromadb';
            document.getElementById('vdb-pinecone-key').value = settings.vector_db?.pinecone_api_key || '';
            document.getElementById('vdb-pinecone-index').value = settings.vector_db?.pinecone_index || '';
            onVectorDBProviderChange();
            
            // RAG Settings
            document.getElementById('rag-chunk-size').value = settings.chunk_size || 1000;
            document.getElementById('rag-chunk-overlap').value = settings.chunk_overlap || 200;
            document.getElementById('rag-top-k').value = settings.search_top_k || 5;
            
            // Feature Toggles
            updateToggle('toggle-rag', settings.enable_rag);
            updateToggle('toggle-scraping', settings.enable_web_scraping);
            updateToggle('toggle-api', settings.enable_api_tools);
            
            updateVDBStatus();
        }
        
        function updateToggle(id, enabled) {
            const el = document.getElementById(id);
            if (enabled) {
                el.classList.add('on');
            } else {
                el.classList.remove('on');
            }
        }
        
        function toggleFeature(feature) {
            const toggleId = feature === 'rag' ? 'toggle-rag' : feature === 'scraping' ? 'toggle-scraping' : 'toggle-api';
            const el = document.getElementById(toggleId);
            el.classList.toggle('on');
        }
        
        function onLLMProviderChange() {
            const provider = document.getElementById('llm-provider').value;
            const apiKeyGroup = document.getElementById('llm-api-key-group');
            const apiBaseGroup = document.getElementById('llm-api-base-group');
            const resourceGroup = document.getElementById('llm-resource-group');
            const providerInfo = document.getElementById('llm-provider-info');
            const providerInfoText = document.getElementById('llm-provider-info-text');
            const providerLink = document.getElementById('llm-provider-link');
            const modelsPreview = document.getElementById('llm-models-preview');
            const modelsListPreview = document.getElementById('llm-models-list-preview');
            
            const config = getProviderConfig(provider);
            
            // Show/hide fields based on provider
            apiKeyGroup.classList.toggle('hidden', !config.needsApiKey);
            apiBaseGroup.classList.toggle('hidden', !config.needsApiBase);
            resourceGroup.classList.toggle('hidden', !config.needsResource);
            
            // Update placeholder
            if (config.needsApiKey) {
                document.getElementById('llm-api-key').placeholder = config.keyPlaceholder;
            }
            
            // Clear API key field when changing provider
            document.getElementById('llm-api-key').value = '';
            document.getElementById('llm-api-base').value = '';
            
            // Show provider info
            providerInfoText.textContent = config.info;
            if (config.link) {
                providerLink.href = config.link;
                providerLink.classList.remove('hidden');
            } else {
                providerLink.classList.add('hidden');
            }
            
            // Show supported models preview
            if (modelsPreview && modelsListPreview) {
                modelsPreview.classList.remove('hidden');
                modelsListPreview.innerHTML = config.models.map(m => 
                    `<span class="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded">${m}</span>`
                ).join('');
            }
            
            // Set default API base for local providers
            const apiBaseInput = document.getElementById('llm-api-base');
            if (provider === 'ollama') {
                apiBaseInput.placeholder = 'http://localhost:11434';
                apiBaseInput.value = 'http://localhost:11434';
            } else if (provider === 'lmstudio') {
                apiBaseInput.placeholder = 'http://localhost:1234/v1';
                apiBaseInput.value = 'http://localhost:1234/v1';
            } else {
                apiBaseInput.placeholder = 'https://api.example.com/v1';
            }
        }
        
        // Update the provider dropdown to hide already configured providers
        function updateProviderDropdown() {
            const select = document.getElementById('llm-provider');
            if (!select) return;
            
            const configuredProviderIds = configuredLLMProviders.map(p => p.provider);
            
            // Get all options
            const options = select.querySelectorAll('option');
            let firstAvailable = null;
            let hasAvailable = false;
            
            options.forEach(option => {
                if (option.value && configuredProviderIds.includes(option.value)) {
                    // Hide configured providers
                    option.style.display = 'none';
                } else if (option.value) {
                    option.style.display = '';
                    hasAvailable = true;
                    if (!firstAvailable) {
                        firstAvailable = option.value;
                    }
                }
            });
            
            // If current selection is configured, switch to first available
            if (configuredProviderIds.includes(select.value) && firstAvailable) {
                select.value = firstAvailable;
                onLLMProviderChange();
            }
            
            // If all providers are configured, hide the add section
            const addSection = document.querySelector('.border-t.border-gray-700.pt-4');
            if (addSection) {
                if (!hasAvailable) {
                    addSection.innerHTML = `
                        <div class="text-center py-6">
                            <span class="text-3xl">ðŸŽ‰</span>
                            <p class="text-gray-400 mt-2 font-medium">All providers configured!</p>
                            <p class="text-xs text-gray-500 mt-1">You can remove a provider above to add a different configuration.</p>
                        </div>
                    `;
                }
            }
        }
        
        // Provider configurations (shared across functions)
        function getProviderConfig(provider) {
            const providerConfigs = {
                openai: {
                    name: 'OpenAI',
                    models: ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-4', 'gpt-3.5-turbo'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'sk-...',
                    info: 'Industry-leading models with excellent reasoning capabilities',
                    link: 'https://platform.openai.com/api-keys'
                },
                anthropic: {
                    name: 'Anthropic',
                    models: ['claude-sonnet-4-20250514', 'claude-opus-4-20250514', 'claude-3-5-sonnet-20241022', 'claude-3-5-haiku-20241022'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'sk-ant-...',
                    info: 'Excellent for writing, analysis, and nuanced conversations',
                    link: 'https://console.anthropic.com/settings/keys'
                },
                google: {
                    name: 'Google',
                    models: ['gemini-2.0-flash', 'gemini-1.5-pro', 'gemini-1.5-flash'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'AIza...',
                    info: 'Multimodal models with long context support (up to 1M tokens)',
                    link: 'https://aistudio.google.com/app/apikey'
                },
                xai: {
                    name: 'xAI',
                    models: ['grok-2', 'grok-2-mini', 'grok-beta'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'xai-...',
                    info: 'Grok models by xAI with real-time knowledge',
                    link: 'https://console.x.ai/'
                },
                groq: {
                    name: 'Groq',
                    models: ['llama-3.3-70b-versatile', 'llama-3.3-70b-specdec', 'llama-3.1-8b-instant', 'gemma2-9b-it'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'gsk_...',
                    info: 'Ultra-fast inference with open-source models',
                    link: 'https://console.groq.com/keys'
                },
                mistral: {
                    name: 'Mistral',
                    models: ['mistral-large-2411', 'mistral-small-2503', 'open-mistral-nemo', 'codestral-2501', 'ministral-8b-2410'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'Your Mistral API key',
                    info: 'Efficient European AI models with strong multilingual support',
                    link: 'https://console.mistral.ai/api-keys/'
                },
                deepseek: {
                    name: 'DeepSeek',
                    models: ['deepseek-chat', 'deepseek-coder', 'deepseek-reasoner'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'sk-...',
                    info: 'Cost-effective models with strong coding capabilities',
                    link: 'https://platform.deepseek.com/api_keys'
                },
                together: {
                    name: 'Together AI',
                    models: ['meta-llama/Llama-3.3-70B-Instruct-Turbo', 'meta-llama/Llama-3.1-405B-Instruct-Turbo', 'mistralai/Mixtral-8x22B-Instruct-v0.1'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'Your Together API key',
                    info: 'Access to 100+ open-source models',
                    link: 'https://api.together.xyz/settings/api-keys'
                },
                perplexity: {
                    name: 'Perplexity',
                    models: ['sonar', 'sonar-pro', 'sonar-reasoning'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'pplx-...',
                    info: 'Models with real-time internet search capabilities',
                    link: 'https://www.perplexity.ai/settings/api'
                },
                cohere: {
                    name: 'Cohere',
                    models: ['command-a-03-2025', 'command-r-plus-08-2024', 'command-r-08-2024', 'command-r7b-12-2024'],
                    needsApiKey: true, needsApiBase: false, needsResource: false,
                    keyPlaceholder: 'Your Cohere API key',
                    info: 'Enterprise-focused models with RAG capabilities',
                    link: 'https://dashboard.cohere.com/api-keys'
                },
                azure_openai: {
                    name: 'Azure OpenAI',
                    models: ['gpt-4o', 'gpt-4', 'gpt-35-turbo'],
                    needsApiKey: true, needsApiBase: true, needsResource: true,
                    keyPlaceholder: 'Your Azure API key',
                    info: 'Enterprise Azure-hosted OpenAI models',
                    link: 'https://portal.azure.com/'
                },
                aws_bedrock: {
                    name: 'AWS Bedrock',
                    models: ['anthropic.claude-3-5-sonnet-20241022-v2:0', 'anthropic.claude-3-sonnet-20240229-v1:0', 'amazon.titan-text-premier-v1:0'],
                    needsApiKey: true, needsApiBase: true, needsResource: true,
                    keyPlaceholder: 'AWS Access Key',
                    info: 'AWS-hosted models with enterprise security',
                    link: 'https://aws.amazon.com/bedrock/'
                },
                ollama: {
                    name: 'Ollama',
                    models: ['llama3.2', 'llama3.1', 'llama3.1:70b', 'mistral', 'mixtral', 'codellama', 'phi3', 'gemma2', 'qwen2.5'],
                    needsApiKey: false, needsApiBase: true, needsResource: false,
                    keyPlaceholder: '',
                    info: 'Run open-source models locally for free',
                    link: 'https://ollama.ai/'
                },
                lmstudio: {
                    name: 'LM Studio',
                    models: ['local-model'],
                    needsApiKey: false, needsApiBase: true, needsResource: false,
                    keyPlaceholder: '',
                    info: 'Run models locally with LM Studio GUI',
                    link: 'https://lmstudio.ai/'
                },
                custom: {
                    name: 'Custom',
                    models: ['custom-model'],
                    needsApiKey: true, needsApiBase: true, needsResource: false,
                    keyPlaceholder: 'Your API key',
                    info: 'Any OpenAI-compatible API endpoint',
                    link: ''
                }
            };
            return providerConfigs[provider] || providerConfigs.openai;
        }
        
        // Configured LLM Providers storage
        let configuredLLMProviders = [];
        
        function addLLMProvider() {
            const provider = document.getElementById('llm-provider').value;
            const apiKey = document.getElementById('llm-api-key').value;
            const apiBase = document.getElementById('llm-api-base').value;
            const resource = document.getElementById('llm-resource')?.value || '';
            
            const config = getProviderConfig(provider);
            
            // Validation
            if (config.needsApiKey && !apiKey) {
                alert('Please enter an API key');
                return;
            }
            if (config.needsApiBase && !apiBase) {
                alert('Please enter an API base URL');
                return;
            }
            
            // Add new provider
            configuredLLMProviders.push({
                provider,
                name: config.name,
                api_key: apiKey,
                api_base: apiBase,
                resource: resource,
                models: config.models
            });
            
            // Clear form
            document.getElementById('llm-api-key').value = '';
            document.getElementById('llm-api-base').value = '';
            if (document.getElementById('llm-resource')) {
                document.getElementById('llm-resource').value = '';
            }
            
            // Update UI
            renderConfiguredProviders();
            updateDefaultProviderDropdown();
            
            // Auto-select as default if it's the first one
            if (configuredLLMProviders.length === 1) {
                document.getElementById('default-llm-provider').value = provider;
                onDefaultProviderChange();
            }
            
            // Auto-save
            saveSettingsQuiet();
            
            // Show success message
            showToast(`âœ… ${config.name} added successfully!`, 'success');
        }
        
        // Toast notification - uses global NotificationSystem (defined earlier)
        // showToast function is defined in the NotificationSystem section
        
        function removeLLMProvider(provider) {
            if (!confirm('Are you sure you want to remove this provider?')) {
                return;
            }
            
            configuredLLMProviders = configuredLLMProviders.filter(p => p.provider !== provider);
            renderConfiguredProviders();
            updateDefaultProviderDropdown();
            saveSettingsQuiet();
        }
        
        function renderConfiguredProviders() {
            const container = document.getElementById('configured-providers-table');
            const noProvidersMsg = document.getElementById('no-providers-msg');
            
            if (configuredLLMProviders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500 text-sm" id="no-providers-msg">
                        <span class="text-2xl block mb-2">ðŸ“­</span>
                        No providers configured yet. Add one below.
                    </div>
                `;
                updateProviderDropdown();
                return;
            }
            
            container.innerHTML = configuredLLMProviders.map((p, idx) => {
                const maskedKey = p.api_key ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + p.api_key.slice(-4) : 'No key';
                const isDefault = currentSettings?.llm?.provider === p.provider;
                
                return `
                    <div class="bg-gray-800/50 rounded-lg p-3 border ${isDefault ? 'border-purple-500' : 'border-gray-700'}" id="provider-card-${p.provider}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${getProviderIcon(p.provider)}</span>
                                <span class="font-medium">${p.name}</span>
                                ${isDefault ? '<span class="text-xs bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded">Default</span>' : ''}
                            </div>
                            <div class="flex items-center gap-1">
                                <button onclick="event.stopPropagation(); testConfiguredProvider('${p.provider}')" 
                                        class="text-xs text-gray-400 hover:text-green-400 px-2 py-1.5 rounded hover:bg-gray-700 transition-colors" 
                                        title="Test Connection">
                                    ðŸ§ª
                                </button>
                                <button onclick="event.stopPropagation(); editLLMProvider('${p.provider}')" 
                                        class="text-xs text-gray-400 hover:text-blue-400 px-2 py-1.5 rounded hover:bg-gray-700 transition-colors" 
                                        title="Edit API Key">
                                    âœï¸
                                </button>
                                <button onclick="event.stopPropagation(); removeLLMProvider('${p.provider}')" 
                                        class="text-xs text-gray-400 hover:text-red-400 px-2 py-1.5 rounded hover:bg-gray-700 transition-colors" 
                                        title="Remove Provider">
                                    ðŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">
                            API Key: <span class="text-gray-400">${maskedKey}</span>
                            ${p.api_base ? ` â€¢ Base: <span class="text-gray-400">${p.api_base}</span>` : ''}
                        </div>
                        <div class="flex flex-wrap gap-1">
                            ${p.models.slice(0, 5).map(m => 
                                `<span class="text-[10px] bg-gray-700 text-gray-300 px-1.5 py-0.5 rounded">${m}</span>`
                            ).join('')}
                            ${p.models.length > 5 ? `<span class="text-[10px] text-gray-500">+${p.models.length - 5} more</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update dropdown to hide configured providers
            updateProviderDropdown();
        }
        
        // Edit an existing LLM provider
        function editLLMProvider(providerName) {
            const providerData = configuredLLMProviders.find(p => p.provider === providerName);
            if (!providerData) return;
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.id = 'edit-provider-modal';
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold flex items-center gap-2">
                            <span>${getProviderIcon(providerName)}</span>
                            Edit ${providerData.name}
                        </h3>
                        <button onclick="closeEditModal()" class="text-gray-400 hover:text-white text-xl">&times;</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Key</label>
                            <input type="password" id="edit-api-key" class="input-field w-full rounded-lg px-4 py-2" 
                                   value="${providerData.api_key}" placeholder="Enter new API key...">
                        </div>
                        ${providerData.api_base ? `
                        <div>
                            <label class="text-sm text-gray-400 mb-1 block">API Base URL</label>
                            <input type="text" id="edit-api-base" class="input-field w-full rounded-lg px-4 py-2" 
                                   value="${providerData.api_base}" placeholder="API Base URL">
                        </div>
                        ` : ''}
                        
                        <div id="edit-test-result" class="hidden p-3 rounded-lg text-sm"></div>
                        
                        <div class="flex gap-2 pt-2">
                            <button onclick="testEditedProvider('${providerName}')" class="btn-secondary px-4 py-2 rounded-lg text-sm flex-1">
                                ðŸ§ª Test
                            </button>
                            <button onclick="saveEditedProvider('${providerName}')" class="btn-primary px-4 py-2 rounded-lg text-sm flex-1">
                                ðŸ’¾ Save
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus on input
            document.getElementById('edit-api-key').focus();
        }
        
        function closeEditModal() {
            const modal = document.getElementById('edit-provider-modal');
            if (modal) modal.remove();
        }
        
        async function testEditedProvider(providerName) {
            const apiKey = document.getElementById('edit-api-key').value;
            const apiBase = document.getElementById('edit-api-base')?.value || '';
            const config = getProviderConfig(providerName);
            
            const resultEl = document.getElementById('edit-test-result');
            resultEl.classList.remove('hidden', 'bg-green-900/50', 'bg-red-900/50');
            resultEl.classList.add('bg-gray-700');
            resultEl.innerHTML = '<span class="animate-pulse">ðŸ§ª Testing...</span>';
            
            try {
                const r = await fetch(API + '/api/settings/test-llm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: providerName,
                        model: config.models[0],
                        api_key: apiKey,
                        api_base: apiBase
                    })
                });
                
                const data = await r.json();
                resultEl.classList.remove('bg-gray-700');
                
                if (data.status === 'success') {
                    resultEl.classList.add('bg-green-900/50');
                    resultEl.innerHTML = 'âœ… Connection successful!';
                } else {
                    resultEl.classList.add('bg-red-900/50');
                    resultEl.innerHTML = 'âŒ ' + data.message;
                }
            } catch (e) {
                resultEl.classList.remove('bg-gray-700');
                resultEl.classList.add('bg-red-900/50');
                resultEl.innerHTML = 'âŒ ' + e.message;
            }
        }
        
        function saveEditedProvider(providerName) {
            const apiKey = document.getElementById('edit-api-key').value;
            const apiBase = document.getElementById('edit-api-base')?.value || '';
            
            if (!apiKey) {
                alert('Please enter an API key');
                return;
            }
            
            // Update provider
            const idx = configuredLLMProviders.findIndex(p => p.provider === providerName);
            if (idx >= 0) {
                configuredLLMProviders[idx].api_key = apiKey;
                if (apiBase) configuredLLMProviders[idx].api_base = apiBase;
            }
            
            // Close modal
            closeEditModal();
            
            // Update UI and save
            renderConfiguredProviders();
            saveSettingsQuiet();
            
            alert('âœ… Provider updated successfully!');
        }
        
        function getProviderIcon(provider) {
            const icons = {
                openai: 'ðŸŸ¢', anthropic: 'ðŸŸ ', google: 'ðŸ”µ', xai: 'âš«', groq: 'ðŸŸ¡',
                mistral: 'ðŸ”·', deepseek: 'ðŸ”¶', together: 'ðŸŸ£', perplexity: 'ðŸ”´',
                cohere: 'ðŸŸ¤', azure_openai: 'â˜ï¸', aws_bedrock: 'ðŸŒ©ï¸', ollama: 'ðŸ¦™',
                lmstudio: 'ðŸ–¥ï¸', custom: 'âš™ï¸'
            };
            return icons[provider] || 'ðŸ¤–';
        }
        
        function updateDefaultProviderDropdown() {
            const select = document.getElementById('default-llm-provider');
            if (!select) return;
            
            const currentDefault = currentSettings?.llm?.provider || '';
            
            select.innerHTML = '<option value="">-- Select Provider --</option>' +
                configuredLLMProviders.map(p => 
                    `<option value="${p.provider}" ${p.provider === currentDefault ? 'selected' : ''}>${p.name}</option>`
                ).join('');
            
            // Update model dropdown
            onDefaultProviderChange();
        }
        
        function onDefaultProviderChange() {
            const provider = document.getElementById('default-llm-provider').value;
            const modelSelect = document.getElementById('default-llm-model');
            
            if (!provider) {
                modelSelect.innerHTML = '<option value="">-- Select Model --</option>';
                return;
            }
            
            const providerData = configuredLLMProviders.find(p => p.provider === provider);
            if (!providerData) return;
            
            const currentModel = currentSettings?.llm?.model || '';
            modelSelect.innerHTML = providerData.models.map(m => 
                `<option value="${m}" ${m === currentModel ? 'selected' : ''}>${m}</option>`
            ).join('');
        }
        
        async function testNewLLMProvider() {
            const provider = document.getElementById('llm-provider').value;
            const apiKey = document.getElementById('llm-api-key').value;
            const apiBase = document.getElementById('llm-api-base').value;
            
            const resultEl = document.getElementById('llm-test-result');
            resultEl.classList.remove('hidden', 'bg-green-900/50', 'bg-red-900/50');
            resultEl.classList.add('bg-gray-800');
            resultEl.innerHTML = '<span class="animate-pulse">ðŸ§ª Testing connection...</span>';
            
            try {
                const config = getProviderConfig(provider);
                const r = await fetch(API + '/api/settings/test-llm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider,
                        model: config.models[0],
                        api_key: apiKey,
                        api_base: apiBase
                    })
                });
                
                const data = await r.json();
                resultEl.classList.remove('bg-gray-800');
                
                if (data.status === 'success') {
                    resultEl.classList.add('bg-green-900/50');
                    resultEl.innerHTML = 'âœ… <strong>Success!</strong> Connection verified.';
                } else {
                    resultEl.classList.add('bg-red-900/50');
                    resultEl.innerHTML = 'âŒ <strong>Failed:</strong> ' + data.message;
                }
            } catch (e) {
                resultEl.classList.remove('bg-gray-800');
                resultEl.classList.add('bg-red-900/50');
                resultEl.innerHTML = 'âŒ <strong>Error:</strong> ' + e.message;
            }
        }
        
        async function testConfiguredProvider(providerName) {
            const providerData = configuredLLMProviders.find(p => p.provider === providerName);
            if (!providerData) {
                alert('Provider not found');
                return;
            }
            
            // Show loading state
            const card = document.getElementById(`provider-card-${providerName}`);
            const originalBorder = card?.className;
            if (card) {
                card.classList.add('animate-pulse');
            }
            
            try {
                const r = await fetch(API + '/api/settings/test-llm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider: providerData.provider,
                        model: providerData.models[0],
                        api_key: providerData.api_key,
                        api_base: providerData.api_base || ''
                    })
                });
                
                const data = await r.json();
                
                if (card) {
                    card.classList.remove('animate-pulse');
                }
                
                if (data.status === 'success') {
                    alert(`âœ… ${providerData.name} is working!\n\nResponse: "${data.response?.substring(0, 100)}..."`);
                } else {
                    alert(`âŒ ${providerData.name} test failed:\n\n${data.message}`);
                }
            } catch (e) {
                if (card) {
                    card.classList.remove('animate-pulse');
                }
                alert(`âŒ Error testing ${providerData.name}:\n\n${e.message}`);
            }
        }
        
        async function saveSettingsQuiet() {
            // Save without showing alert
            try {
                const defaultProvider = document.getElementById('default-llm-provider')?.value || '';
                const defaultModel = document.getElementById('default-llm-model')?.value || '';
                
                const settings = {
                    llm: {
                        provider: defaultProvider,
                        model: defaultModel,
                        api_key: configuredLLMProviders.find(p => p.provider === defaultProvider)?.api_key || '',
                        api_base: configuredLLMProviders.find(p => p.provider === defaultProvider)?.api_base || '',
                    },
                    llm_providers: configuredLLMProviders,
                    embedding: {
                        provider: document.getElementById('emb-provider')?.value || 'openai',
                        model: document.getElementById('emb-model')?.value || 'text-embedding-3-small',
                        local_model: document.getElementById('emb-local-model')?.value || 'all-MiniLM-L6-v2',
                        api_key: document.getElementById('emb-api-key')?.value || '',
                    },
                    vector_db: {
                        provider: document.getElementById('vdb-provider')?.value || 'memory',
                        chroma_path: document.getElementById('vdb-chroma-path')?.value || './data/chromadb',
                        pinecone_api_key: document.getElementById('vdb-pinecone-key')?.value || '',
                        pinecone_index: document.getElementById('vdb-pinecone-index')?.value || '',
                    },
                    chunk_size: parseInt(document.getElementById('rag-chunk-size')?.value) || 1000,
                    chunk_overlap: parseInt(document.getElementById('rag-chunk-overlap')?.value) || 200,
                    search_top_k: parseInt(document.getElementById('rag-top-k')?.value) || 5,
                    enable_rag: document.getElementById('toggle-rag')?.classList.contains('on') ?? true,
                    enable_web_scraping: document.getElementById('toggle-scraping')?.classList.contains('on') ?? true,
                    enable_api_tools: document.getElementById('toggle-api')?.classList.contains('on') ?? true,
                };
                
                console.log('Saving settings with', configuredLLMProviders.length, 'providers');
                
                const response = await fetch(API + '/api/settings', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    console.log('âœ… Settings saved successfully');
                    currentSettings = settings;
                } else {
                    console.error('âŒ Failed to save settings:', data.message);
                }
            } catch (e) {
                console.error('âŒ Failed to save settings:', e);
            }
        }
        
        function onEmbeddingProviderChange() {
            const provider = document.getElementById('emb-provider').value;
            
            document.getElementById('emb-model-group').classList.toggle('hidden', provider === 'sentence_transformers');
            document.getElementById('emb-local-model-group').classList.toggle('hidden', provider !== 'sentence_transformers');
            document.getElementById('emb-api-key-group').classList.toggle('hidden', provider === 'sentence_transformers' || provider === 'ollama');
        }
        
        function onVectorDBProviderChange() {
            const provider = document.getElementById('vdb-provider').value;
            
            document.getElementById('vdb-chroma-path-group').classList.toggle('hidden', provider !== 'chromadb');
            document.getElementById('vdb-pinecone-group').classList.toggle('hidden', provider !== 'pinecone');
            
            updateVDBStatus();
        }
        
        function updateVDBStatus() {
            const provider = document.getElementById('vdb-provider').value;
            const iconEl = document.getElementById('vdb-status-icon');
            const textEl = document.getElementById('vdb-status-text');
            
            if (provider === 'memory') {
                iconEl.textContent = 'ðŸŸ¡';
                textEl.textContent = 'Using keyword search (no embeddings)';
            } else if (provider === 'chromadb') {
                iconEl.textContent = 'ðŸŸ¢';
                textEl.textContent = 'ChromaDB ready - local vector search enabled';
            } else if (provider === 'pinecone') {
                const hasKey = document.getElementById('vdb-pinecone-key').value && !document.getElementById('vdb-pinecone-key').value.startsWith('***');
                iconEl.textContent = hasKey ? 'ðŸŸ¢' : 'ðŸ”´';
                textEl.textContent = hasKey ? 'Pinecone configured' : 'API key required';
            }
        }
        
        async function saveSettings() {
            try {
                const defaultProvider = document.getElementById('default-llm-provider')?.value || '';
                const defaultModel = document.getElementById('default-llm-model')?.value || '';
                const defaultProviderData = configuredLLMProviders.find(p => p.provider === defaultProvider);
                
                const settings = {
                    llm: {
                        provider: defaultProvider,
                        model: defaultModel,
                        api_key: defaultProviderData?.api_key || '',
                        api_base: defaultProviderData?.api_base || '',
                        resource: defaultProviderData?.resource || '',
                    },
                    llm_providers: configuredLLMProviders,
                    embedding: {
                        provider: document.getElementById('emb-provider').value,
                        model: document.getElementById('emb-model').value,
                        local_model: document.getElementById('emb-local-model').value,
                        api_key: document.getElementById('emb-api-key').value,
                    },
                    vector_db: {
                        provider: document.getElementById('vdb-provider').value,
                        chroma_path: document.getElementById('vdb-chroma-path').value,
                        pinecone_api_key: document.getElementById('vdb-pinecone-key').value,
                        pinecone_index: document.getElementById('vdb-pinecone-index').value,
                    },
                    chunk_size: parseInt(document.getElementById('rag-chunk-size').value),
                    chunk_overlap: parseInt(document.getElementById('rag-chunk-overlap').value),
                    search_top_k: parseInt(document.getElementById('rag-top-k').value),
                    enable_rag: document.getElementById('toggle-rag').classList.contains('on'),
                    enable_web_scraping: document.getElementById('toggle-scraping').classList.contains('on'),
                    enable_api_tools: document.getElementById('toggle-api').classList.contains('on'),
                };
                
                const r = await fetch(API + '/api/settings', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });
                
                const data = await r.json();
                if (data.status === 'success') {
                    currentSettings = settings;
                    alert('âœ… Settings saved successfully!');
                } else {
                    alert('âŒ Failed to save: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('âŒ Error: ' + e.message);
            }
        }
        
        async function testLLM() {
            const resultEl = document.getElementById('llm-test-result');
            resultEl.classList.remove('hidden', 'bg-green-900/50', 'bg-red-900/50');
            resultEl.classList.add('bg-gray-800');
            resultEl.innerHTML = '<span class="animate-pulse">ðŸ§ª Testing LLM connection...</span>';
            
            try {
                const settings = {
                    provider: document.getElementById('llm-provider').value,
                    model: document.getElementById('llm-model').value,
                    api_key: document.getElementById('llm-api-key').value,
                    api_base: document.getElementById('llm-api-base').value,
                    ollama_host: document.getElementById('llm-ollama-host').value,
                };
                
                const r = await fetch(API + '/api/settings/test-llm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });
                
                const data = await r.json();
                resultEl.classList.remove('bg-gray-800');
                
                if (data.status === 'success') {
                    resultEl.classList.add('bg-green-900/50');
                    resultEl.innerHTML = 'âœ… <strong>Success!</strong> Response: ' + data.response.substring(0, 100);
                } else {
                    resultEl.classList.add('bg-red-900/50');
                    resultEl.innerHTML = 'âŒ <strong>Failed:</strong> ' + data.message;
                }
            } catch (e) {
                resultEl.classList.remove('bg-gray-800');
                resultEl.classList.add('bg-red-900/50');
                resultEl.innerHTML = 'âŒ <strong>Error:</strong> ' + e.message;
            }
        }
        
        async function testEmbedding() {
            const resultEl = document.getElementById('emb-test-result');
            resultEl.classList.remove('hidden', 'bg-green-900/50', 'bg-red-900/50');
            resultEl.classList.add('bg-gray-800');
            resultEl.innerHTML = '<span class="animate-pulse">ðŸ§ª Testing embedding provider...</span>';
            
            try {
                const settings = {
                    provider: document.getElementById('emb-provider').value,
                    model: document.getElementById('emb-model').value,
                    local_model: document.getElementById('emb-local-model').value,
                    api_key: document.getElementById('emb-api-key').value,
                };
                
                const r = await fetch(API + '/api/settings/test-embedding', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });
                
                const data = await r.json();
                resultEl.classList.remove('bg-gray-800');
                
                if (data.status === 'success') {
                    resultEl.classList.add('bg-green-900/50');
                    resultEl.innerHTML = `âœ… <strong>Success!</strong> Dimensions: ${data.dimensions}`;
                } else {
                    resultEl.classList.add('bg-red-900/50');
                    resultEl.innerHTML = 'âŒ <strong>Failed:</strong> ' + data.message;
                }
            } catch (e) {
                resultEl.classList.remove('bg-gray-800');
                resultEl.classList.add('bg-red-900/50');
                resultEl.innerHTML = 'âŒ <strong>Error:</strong> ' + e.message;
            }
        }
        
        async function reindexKnowledgeBase() {
            if (!confirm('This will reindex all documents with the current embedding settings. Continue?')) return;
            
            try {
                const r = await fetch(API + '/api/settings/reindex', { method: 'POST' });
                const data = await r.json();
                
                if (data.status === 'success') {
                    alert('âœ… ' + data.message);
                } else {
                    alert('âŒ ' + (data.message || 'Reindex failed'));
                }
            } catch (e) {
                alert('âŒ Error: ' + e.message);
            }
        }

        // Initial data loading moved to showApp() function
        function initAppData() {
            loadAgents();
            loadTools();
            loadSettings();
            loadPendingApprovalsCount(); // Load approval badge count
            
            // Navigate to hash page or default to agents
            const hash = window.location.hash.slice(1);
            if (hash && document.getElementById('page-' + hash)) {
                navigate(hash, false);
            } else {
                navigate('agents', true);
            }
        }
        
        // Load pending approvals count for badge
        async function loadPendingApprovalsCount() {
            try {
                const response = await fetch(API + '/process/approvals?status=pending&limit=1', {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const count = data.total ?? (data.items ? data.items.length : 0);
                    const badge = document.getElementById('approval-badge');
                    if (badge) {
                        if (count > 0) {
                            badge.textContent = count > 99 ? '99+' : count;
                            badge.classList.remove('hidden');
                        } else {
                            badge.classList.add('hidden');
                        }
                    }
                }
            } catch(e) {
                console.log('Could not load approval count:', e);
            }
        }
// ============================================================================
// TOOL WIZARD - JavaScript
// ============================================================================

// Wizard State
let wizState = {
    type: null,
    step: 0,
    maxSteps: 4,
    data: {
        name: '',
        description: '',
        config: {},
        files: [],
        urls: []
    }
};

// Tool Access Control State
let selectedToolAccessType = 'owner_only';
let toolAccessData = { users: [], groups: [] };
let toolAccessSelected = { users: [], groups: [] };
let toolPermissionChips = { edit: [], delete: [], execute: [] };

// Select Tool Access Type
function selectToolAccessType(accessType) {
    selectedToolAccessType = accessType;
    
    // Update UI for both old (wiz-step-2) and new (wiz-step-5) access cards
    document.querySelectorAll('.tool-access-card, .access-step-card').forEach(card => {
        const cardType = card.dataset.access;
        const checkmark = card.querySelector('.tool-access-check, .access-step-check');
        
        if (cardType === accessType) {
            card.classList.remove('border-gray-600');
            if (accessType === 'owner_only') card.classList.add('border-purple-500', 'bg-purple-500/10');
            else if (accessType === 'authenticated') card.classList.add('border-blue-500', 'bg-blue-500/10');
            else if (accessType === 'specific_users') card.classList.add('border-yellow-500', 'bg-yellow-500/10');
            else if (accessType === 'public') card.classList.add('border-green-500', 'bg-green-500/10');
            if (checkmark) checkmark.classList.remove('hidden');
        } else {
            card.classList.remove('border-purple-500', 'border-blue-500', 'border-yellow-500', 'border-green-500');
            card.classList.remove('bg-purple-500/10', 'bg-blue-500/10', 'bg-yellow-500/10', 'bg-green-500/10');
            card.classList.add('border-gray-600');
            if (checkmark) checkmark.classList.add('hidden');
        }
    });
    
    // Show/hide specific users config (both old and new)
    const specificConfig = document.getElementById('tool-specific-access-config');
    const accessStepConfig = document.getElementById('access-step-specific-config');
    
    if (specificConfig) {
        if (accessType === 'specific_users') {
            specificConfig.classList.remove('hidden');
            loadToolAccessUsersAndGroups();
        } else {
            specificConfig.classList.add('hidden');
        }
    }
    
    if (accessStepConfig) {
        if (accessType === 'specific_users') {
            accessStepConfig.classList.remove('hidden');
            loadToolAccessUsersAndGroups();
        } else {
            accessStepConfig.classList.add('hidden');
        }
    }
}

// Load users and groups for access control
async function loadToolAccessUsersAndGroups() {
    try {
        // Load users from security API
        const usersRes = await fetch(API + '/api/security/users', { headers: getAuthHeaders() });
        if (usersRes.ok) {
            const usersData = await usersRes.json();
            toolAccessData.users = usersData.users || usersData || [];
        }
        
        // Load groups from security API
        const groupsRes = await fetch(API + '/api/security/groups', { headers: getAuthHeaders() });
        if (groupsRes.ok) {
            const groupsData = await groupsRes.json();
            // Add members_count from member_ids or user_ids array length
            toolAccessData.groups = (groupsData.groups || groupsData || []).map(g => ({
                ...g,
                members_count: (g.member_ids || g.user_ids || []).length
            }));
        }
        
        // Populate permission dropdowns
        updateToolPermissionDropdowns();
        
        // Show initial results
        filterToolAccessSearch('');
        
    } catch (e) {
        console.error('Failed to load users/groups for access control:', e);
    }
}

// Filter and show search results
function filterToolAccessSearch(query) {
    const resultsDiv = document.getElementById('tool-access-search-results');
    if (!resultsDiv) return;
    
    const q = query.toLowerCase();
    let html = '';
    
    // Filter users
    const filteredUsers = toolAccessData.users.filter(u => {
        const name = (u.full_name || u.email || u.username || '').toLowerCase();
        const email = (u.email || '').toLowerCase();
        return name.includes(q) || email.includes(q);
    }).slice(0, 5);
    
    // Filter groups
    const filteredGroups = toolAccessData.groups.filter(g => {
        return (g.name || '').toLowerCase().includes(q);
    }).slice(0, 3);
    
    if (filteredUsers.length > 0) {
        html += `<div class="px-3 py-2 text-xs font-medium" style="background: #e5e7eb; color: #374151;">ðŸ‘¤ Users</div>`;
        filteredUsers.forEach(u => {
            const isSelected = toolAccessSelected.users.some(s => s.id === u.id);
            const name = u.full_name || u.email || u.username;
            html += `
                <div class="px-4 py-3 cursor-pointer flex items-center justify-between transition" 
                     style="background: ${isSelected ? '#ede9fe' : '#ffffff'};"
                     onmouseover="this.style.background='${isSelected ? '#ddd6fe' : '#f3f4f6'}'"
                     onmouseout="this.style.background='${isSelected ? '#ede9fe' : '#ffffff'}'"
                     onclick="toggleToolAccessEntity('user', '${u.id}', '${name.replace(/'/g, "\\'")}', '${(u.email || '').replace(/'/g, "\\'")}')">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-white text-sm font-bold">
                            ${name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div class="text-sm font-medium" style="color: #1f2937;">${name}</div>
                            <div class="text-xs" style="color: #6b7280;">${u.email || ''}</div>
                        </div>
                    </div>
                    ${isSelected ? '<span style="color: #059669;" class="text-sm font-bold">âœ“</span>' : '<span style="color: #9ca3af;" class="text-sm">+</span>'}
                </div>
            `;
        });
    }
    
    if (filteredGroups.length > 0) {
        html += `<div class="px-3 py-2 text-xs font-medium ${filteredUsers.length > 0 ? 'border-t' : ''}" style="background: #e5e7eb; color: #374151; border-color: #d1d5db;">ðŸ‘¥ Groups</div>`;
        filteredGroups.forEach(g => {
            const isSelected = toolAccessSelected.groups.some(s => s.id === g.id);
            html += `
                <div class="px-4 py-3 cursor-pointer flex items-center justify-between transition"
                     style="background: ${isSelected ? '#dbeafe' : '#ffffff'};"
                     onmouseover="this.style.background='${isSelected ? '#bfdbfe' : '#f3f4f6'}'"
                     onmouseout="this.style.background='${isSelected ? '#dbeafe' : '#ffffff'}'"
                     onclick="toggleToolAccessEntity('group', '${g.id}', '${(g.name || '').replace(/'/g, "\\'")}', '')">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white text-sm">
                            ðŸ‘¥
                        </div>
                        <div>
                            <div class="text-sm font-medium" style="color: #1f2937;">${g.name}</div>
                            <div class="text-xs" style="color: #6b7280;">${g.members_count || 0} members</div>
                        </div>
                    </div>
                    ${isSelected ? '<span style="color: #059669;" class="text-sm font-bold">âœ“</span>' : '<span style="color: #9ca3af;" class="text-sm">+</span>'}
                </div>
            `;
        });
    }
    
    if (html === '') {
        html = `<div class="px-4 py-6 text-center text-sm" style="color: #6b7280;">No results found</div>`;
    }
    
    resultsDiv.innerHTML = html;
}

// Show search results
function showToolAccessResults() {
    const resultsDiv = document.getElementById('tool-access-search-results');
    if (resultsDiv) {
        resultsDiv.classList.remove('hidden');
        filterToolAccessSearch(document.getElementById('tool-access-search')?.value || '');
    }
}

// Toggle entity selection
function toggleToolAccessEntity(type, id, name, email) {
    const list = type === 'user' ? toolAccessSelected.users : toolAccessSelected.groups;
    const existingIndex = list.findIndex(e => e.id === id);
    
    if (existingIndex >= 0) {
        // Remove
        list.splice(existingIndex, 1);
    } else {
        // Add
        list.push({ id, name, email, type });
    }
    
    // Update UI
    updateToolAccessChips();
    updateToolAccessHiddenSelects();
    updateToolPermissionDropdowns();
    filterToolAccessSearch(document.getElementById('tool-access-search')?.value || '');
}

// Update the chips display
function updateToolAccessChips() {
    const container = document.getElementById('tool-access-selected-chips');
    const countBadge = document.getElementById('tool-access-count');
    const noSelectionMsg = document.getElementById('tool-no-selection-msg');
    if (!container) return;
    
    const allSelected = [...toolAccessSelected.users, ...toolAccessSelected.groups];
    
    if (allSelected.length === 0) {
        container.innerHTML = `<div id="tool-no-selection-msg" class="text-sm italic" style="color: #6b7280;">Click on users or groups from search to add them</div>`;
    } else {
        container.innerHTML = allSelected.map(e => `
            <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm transition-all hover:scale-105"
                 style="background: ${e.type === 'user' ? '#ede9fe' : '#dbeafe'}; border: 1px solid ${e.type === 'user' ? '#c4b5fd' : '#93c5fd'};">
                <span class="text-xs">${e.type === 'user' ? 'ðŸ‘¤' : 'ðŸ‘¥'}</span>
                <span style="color: ${e.type === 'user' ? '#5b21b6' : '#1e40af'}; font-weight: 500;">${e.name}</span>
                <button onclick="toggleToolAccessEntity('${e.type}', '${e.id}', '', '')" 
                        class="w-5 h-5 rounded-full flex items-center justify-center transition"
                        style="background: ${e.type === 'user' ? '#c4b5fd' : '#93c5fd'}; color: ${e.type === 'user' ? '#5b21b6' : '#1e40af'};">
                    Ã—
                </button>
            </div>
        `).join('');
    }
    
    if (countBadge) {
        countBadge.textContent = allSelected.length;
    }
}

// Update hidden selects for form compatibility
function updateToolAccessHiddenSelects() {
    const usersSelect = document.getElementById('tool-allowed-users');
    const groupsSelect = document.getElementById('tool-allowed-groups');
    
    if (usersSelect) {
        usersSelect.innerHTML = toolAccessSelected.users.map(u => 
            `<option value="${u.id}" selected>${u.name}</option>`
        ).join('');
    }
    
    if (groupsSelect) {
        groupsSelect.innerHTML = toolAccessSelected.groups.map(g => 
            `<option value="${g.id}" selected>${g.name}</option>`
        ).join('');
    }
}

// Update permission dropdowns with selected users AND groups
function updateToolPermissionDropdowns() {
    const selectedUsers = toolAccessSelected.users;
    const selectedGroups = toolAccessSelected.groups;
    const allSelected = [...selectedUsers, ...selectedGroups];
    const selects = ['tool-can-edit-users', 'tool-can-delete-users', 'tool-can-execute-users'];
    
    // Show/hide empty message and grid based on whether anything is selected
    const emptyMsg = document.getElementById('granular-permissions-empty');
    const grid = document.getElementById('granular-permissions-grid');
    
    if (allSelected.length === 0) {
        if (emptyMsg) emptyMsg.classList.remove('hidden');
        if (grid) grid.classList.add('hidden');
    } else {
        if (emptyMsg) emptyMsg.classList.add('hidden');
        if (grid) grid.classList.remove('hidden');
    }
    
    selects.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
            const currentValues = Array.from(select.selectedOptions).map(o => o.value);
            let options = `<option value="">+ Add user/group</option>`;
            
            // Add users
            if (selectedUsers.length > 0) {
                options += `<optgroup label="ðŸ‘¤ Users">`;
                options += selectedUsers.map(u => 
                    `<option value="user:${u.id}" ${currentValues.includes('user:'+u.id) ? 'selected' : ''}>${u.name}</option>`
                ).join('');
                options += `</optgroup>`;
            }
            
            // Add groups
            if (selectedGroups.length > 0) {
                options += `<optgroup label="ðŸ‘¥ Groups">`;
                options += selectedGroups.map(g => 
                    `<option value="group:${g.id}" ${currentValues.includes('group:'+g.id) ? 'selected' : ''}>${g.name}</option>`
                ).join('');
                options += `</optgroup>`;
            }
            
            select.innerHTML = options;
        }
    });
}

// Add permission chip (handles both users and groups)
function addToolPermissionChip(permType, selectEl) {
    const value = selectEl.value;
    if (!value) return;
    
    // Parse value format: "user:id" or "group:id"
    const [type, id] = value.split(':');
    
    let entity;
    if (type === 'user') {
        entity = toolAccessSelected.users.find(u => u.id === id);
    } else if (type === 'group') {
        entity = toolAccessSelected.groups.find(g => g.id === id);
    }
    
    if (!entity) return;
    
    // Add entity type for chip display
    const chipData = { ...entity, entityType: type };
    
    // Add to chips if not already there
    if (!toolPermissionChips[permType].some(e => e.id === id && e.entityType === type)) {
        toolPermissionChips[permType].push(chipData);
    }
    
    // Update chip display
    updatePermissionChipsDisplay(permType);
    
    // Reset select
    selectEl.value = '';
}

// Update permission chips display
function updatePermissionChipsDisplay(permType) {
    const chipsContainer = document.getElementById(`tool-can-${permType}-chips`);
    if (chipsContainer) {
        chipsContainer.innerHTML = toolPermissionChips[permType].map(e => `
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs" 
                  style="background: ${e.entityType === 'group' ? '#dbeafe' : '#ede9fe'}; color: ${e.entityType === 'group' ? '#1e40af' : '#5b21b6'}; border: 1px solid ${e.entityType === 'group' ? '#93c5fd' : '#c4b5fd'};">
                ${e.entityType === 'group' ? 'ðŸ‘¥' : 'ðŸ‘¤'} ${e.name}
                <button onclick="removeToolPermissionChip('${permType}', '${e.id}', '${e.entityType}')" class="hover:text-red-600 ml-1 font-bold">Ã—</button>
            </span>
        `).join('');
    }
}

// Remove permission chip
function removeToolPermissionChip(permType, entityId, entityType) {
    toolPermissionChips[permType] = toolPermissionChips[permType].filter(e => 
        !(e.id === entityId && e.entityType === entityType)
    );
    
    // Update display
    updatePermissionChipsDisplay(permType);
}

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    const searchInput = document.getElementById('tool-access-search');
    const resultsDiv = document.getElementById('tool-access-search-results');
    if (searchInput && resultsDiv && !searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
        resultsDiv.classList.add('hidden');
    }
});

// Tool metadata
const toolMeta = {
    // Knowledge & Data
    knowledge: { icon: 'ðŸ§ ', name: 'Knowledge Base', hasConfig: true, hasSources: true, steps: ['Basics', 'RAG Config', 'Sources', 'Access', 'Review'] },
    document: { icon: 'ðŸ“„', name: 'Documents', hasConfig: false, hasSources: true, steps: ['Basics', 'Upload', 'Access', 'Review'] },
    website: { icon: 'ðŸŒ', name: 'Website', hasConfig: true, hasSources: false, steps: ['Basics', 'Configuration', 'Access', 'Review'] },
    database: { icon: 'ðŸ—„ï¸', name: 'Database', hasConfig: true, hasSources: false, steps: ['Basics', 'Connection', 'Access', 'Review'] },
    spreadsheet: { icon: 'ðŸ“Š', name: 'Spreadsheet', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    storage: { icon: 'â˜ï¸', name: 'Cloud Storage', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    // Integrations
    api: { icon: 'ðŸ”—', name: 'REST API', hasConfig: true, hasSources: false, steps: ['Basics', 'Configuration', 'Access', 'Review'] },
    email: { icon: 'ðŸ“§', name: 'Email', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    slack: { icon: 'ðŸ’¬', name: 'Messaging', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    calendar: { icon: 'ðŸ“…', name: 'Calendar', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    crm: { icon: 'ðŸŽ¯', name: 'CRM', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    webhook: { icon: 'ðŸª', name: 'Webhook', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    erp: { icon: 'ðŸ¢', name: 'ERP', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    // AI Services
    websearch: { icon: 'ðŸ”', name: 'Web Search', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    imagegen: { icon: 'ðŸŽ¨', name: 'Image Gen', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    stt: { icon: 'ðŸŽ¤', name: 'Speech to Text', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    tts: { icon: 'ðŸ”Š', name: 'Text to Speech', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    translate: { icon: 'ðŸŒ', name: 'Translation', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    ocr: { icon: 'ðŸ“·', name: 'OCR / Vision', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    code: { icon: 'ðŸ’»', name: 'Code Exec', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] },
    calculator: { icon: 'ðŸ§®', name: 'Calculator', hasConfig: false, hasSources: false, steps: ['Basics', 'Access', 'Review'] },
    hitl: { icon: 'ðŸ‘¤', name: 'Human in Loop', hasConfig: true, hasSources: false, steps: ['Basics', 'Config', 'Access', 'Review'] }
};

// Show tool modal - defined earlier in the file (search for "function showToolModal")
// This duplicate was removed to avoid confusion

// Close wizard
function closeWizard() {
    document.getElementById('modal-tool').classList.add('hidden');
    resetWizard();
}

// Reset wizard state
function resetWizard() {
    wizState = {
        type: null,
        step: 0,
        maxSteps: 4,
        data: { name: '', description: '', config: {}, files: [], urls: [] },
        tableData: null
    };
    
    // Reset editing state
    editingToolId = null;
    
    // Reset text and table entries
    wizTextEntries = [];
    wizTableEntries = [];
    
    // Reset UI
    document.getElementById('wizard-steps-bar').classList.add('hidden');
    document.getElementById('wizard-footer').classList.add('hidden');
    document.getElementById('wizard-icon').textContent = 'ðŸ”§';
    document.getElementById('wizard-title').textContent = 'Create Tool';
    document.getElementById('wizard-subtitle').textContent = 'Select a tool type';
    
    // Reset Create button to default state
    const createBtn = document.getElementById('btn-create');
    if (createBtn) {
        createBtn.textContent = 'âœ“ Create Tool';
        createBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        createBtn.classList.add('bg-green-600', 'hover:bg-green-700');
    }
    
    // Show step 0, hide others (including new steps 5 and 6)
    for (let i = 0; i <= 6; i++) {
        const el = document.getElementById('wiz-step-' + i);
        if (el) el.classList.toggle('hidden', i !== 0);
    }
    
    // Reset forms
    document.getElementById('wiz-name').value = '';
    document.getElementById('wiz-desc').value = '';
    document.getElementById('wiz-files-list').innerHTML = '';
    document.getElementById('wiz-urls-list').innerHTML = '';
    
    // Reset text/table lists
    const textList = document.getElementById('wiz-text-list');
    const tableList = document.getElementById('wiz-table-list');
    if (textList) textList.innerHTML = '';
    if (tableList) tableList.innerHTML = '';
    
    // Hide all config sections
    document.querySelectorAll('[id^="cfg-"]').forEach(el => el.classList.add('hidden'));
}

// Start wizard with tool type
function startWizard(type) {
    wizState.type = type;
    wizState.step = 1;
    
    // Reset API parameters when starting a new API tool (edit flow sets them in openToolEditor)
    if (type === 'api') apiParams = [];
    
    // Reset access control state for new tools
    selectedToolAccessType = 'owner_only';
    wizState.data = {
        name: '',
        description: '',
        config: {},
        files: [],
        urls: [],
        access_type: 'owner_only',
        allowed_user_ids: [],
        allowed_group_ids: [],
        can_edit_user_ids: [],
        can_delete_user_ids: [],
        can_execute_user_ids: []
    };
    
    // Reset access control UI
    setTimeout(() => selectToolAccessType('owner_only'), 100);
    
    const meta = toolMeta[type] || { icon: 'ðŸ”§', name: type, steps: ['Basics', 'Config', 'Test'] };
    wizState.maxSteps = meta.steps.length;
    
    // Update header
    document.getElementById('wizard-icon').textContent = meta.icon;
    document.getElementById('wizard-title').textContent = meta.name;
    document.getElementById('wizard-subtitle').textContent = 'Step 1 of ' + wizState.maxSteps;
    
    // Update step 1 header
    document.getElementById('step1-icon').textContent = meta.icon;
    document.getElementById('step1-title').textContent = meta.name;
    
    // Show steps bar and footer
    document.getElementById('wizard-steps-bar').classList.remove('hidden');
    document.getElementById('wizard-footer').classList.remove('hidden');
    
    // Update steps labels
    updateStepsBar();
    
    // Show step 1
    showStep(1);
}

// Update steps bar
function updateStepsBar() {
    const meta = toolMeta[wizState.type] || { steps: ['Basics', 'Config', 'Sources', 'Test'] };
    const steps = document.querySelectorAll('.wizard-step');
    
    steps.forEach((step, idx) => {
        const stepNum = idx + 1;
        const numEl = step.querySelector('.step-num');
        const labelEl = step.querySelector('.step-label');
        
        // Hide steps beyond max
        step.style.display = stepNum <= wizState.maxSteps ? 'flex' : 'none';
        
        // Update label
        if (labelEl && meta.steps[idx]) {
            labelEl.textContent = meta.steps[idx];
        }
        
        // Update styling
        if (stepNum < wizState.step) {
            // Completed
            step.classList.remove('opacity-50');
            numEl.classList.remove('bg-gray-700');
            numEl.classList.add('bg-green-600');
            numEl.innerHTML = 'âœ“';
        } else if (stepNum === wizState.step) {
            // Current
            step.classList.remove('opacity-50');
            numEl.classList.remove('bg-gray-700', 'bg-green-600');
            numEl.classList.add('bg-purple-600');
            numEl.textContent = stepNum;
        } else {
            // Future
            step.classList.add('opacity-50');
            numEl.classList.remove('bg-purple-600', 'bg-green-600');
            numEl.classList.add('bg-gray-700');
            numEl.textContent = stepNum;
        }
    });
    
    // Hide connectors beyond max
    const connectors = document.querySelectorAll('.step-connector');
    connectors.forEach((conn, idx) => {
        conn.style.display = (idx + 2) <= wizState.maxSteps ? 'block' : 'none';
    });
}

// Show specific step
function showStep(step) {
    wizState.step = step;
    
    // Update subtitle
    const meta = toolMeta[wizState.type] || {};
    document.getElementById('wizard-subtitle').textContent = 
        'Step ' + step + ' of ' + wizState.maxSteps + ': ' + (meta.steps?.[step-1] || '');
    
    // Hide all step contents (including new steps 5 and 6)
    for (let i = 0; i <= 6; i++) {
        const el = document.getElementById('wiz-step-' + i);
        if (el) el.classList.add('hidden');
    }
    
    // Map logical step to actual step
    const actualStep = getActualStep(step);
    document.getElementById('wiz-step-' + actualStep).classList.remove('hidden');
    
    // Show appropriate config section
    if (actualStep === 2) {
        showConfigSection();
        
        // Update step 2 header for noTestStep tools (this is their final step)
        const isLastStep = step === wizState.maxSteps;
        const step2Header = document.querySelector('#wiz-step-2 h4.font-semibold');
        const step2Desc = document.querySelector('#wiz-step-2 p.text-xs');
        if (step2Header && isLastStep && meta.noTestStep) {
            step2Header.textContent = 'Configuration';
            step2Desc.textContent = editingToolId 
                ? 'Configure and update your tool' 
                : 'Configure and create your tool';
        }
    }
    
    // Show/hide sources tabs based on tool type
    if (actualStep === 3) {
        const hasSources = toolMeta[wizState.type]?.hasSources;
        document.getElementById('source-tabs').style.display = hasSources ? 'flex' : 'none';
    }
    
    // Load access control data when entering Access step
    if (actualStep === 5) {
        loadAccessStepData();
    }
    
    // Update buttons
    updateButtons();
    updateStepsBar();
    
    // Update Review step if on last step (Review)
    if (actualStep === 6) {
        updateReviewStep();
        
        // Update step 6 title based on editing state
        const step6Title = document.getElementById('step6-title');
        const step6Subtitle = document.getElementById('step6-subtitle');
        if (step6Title) {
            step6Title.textContent = editingToolId ? 'Review & Update' : 'Review & Create';
        }
        if (step6Subtitle) {
            step6Subtitle.textContent = editingToolId ? 'Review your changes before updating' : 'Review your configuration before creating';
        }
    }
    
    // Also update old summary for compatibility
    if (step === wizState.maxSteps) {
        updateSummary();
    }
}

// Get actual step content based on tool type
function getActualStep(logicalStep) {
    const meta = toolMeta[wizState.type];
    if (!meta) return logicalStep;
    
    // Map based on tool capabilities
    // Step 1: Always Basics -> wiz-step-1
    if (logicalStep === 1) return 1;
    
    // New flow with Access Control and Review steps
    // wiz-step-1: Basics
    // wiz-step-2: Configuration
    // wiz-step-3: Sources (for data tools)
    // wiz-step-4: Old Test step (kept for compatibility but rarely used)
    // wiz-step-5: Access Control (new)
    // wiz-step-6: Review (new)
    
    if (meta.hasConfig && meta.hasSources) {
        // knowledge: Basics -> Config -> Sources -> Access -> Review
        // steps: ['Basics', 'RAG Config', 'Sources', 'Access', 'Review']
        if (logicalStep === 2) return 2; // Config
        if (logicalStep === 3) return 3; // Sources
        if (logicalStep === 4) return 5; // Access
        if (logicalStep === 5) return 6; // Review
    } else if (!meta.hasConfig && meta.hasSources) {
        // document: Basics -> Upload -> Access -> Review
        // steps: ['Basics', 'Upload', 'Access', 'Review']
        if (logicalStep === 2) return 3; // Sources/Upload
        if (logicalStep === 3) return 5; // Access
        if (logicalStep === 4) return 6; // Review
    } else if (meta.hasConfig && !meta.hasSources) {
        // api, website, database, etc: Basics -> Config -> Access -> Review
        // steps: ['Basics', 'Configuration', 'Access', 'Review']
        if (logicalStep === 2) return 2; // Config
        if (logicalStep === 3) return 5; // Access
        if (logicalStep === 4) return 6; // Review
    } else {
        // calculator (no config, no sources): Basics -> Access -> Review
        // steps: ['Basics', 'Access', 'Review']
        if (logicalStep === 2) return 5; // Access
        if (logicalStep === 3) return 6; // Review
    }
    
    return logicalStep;
}

// Show appropriate config section
function showConfigSection() {
    document.querySelectorAll('[id^="cfg-"]').forEach(el => el.classList.add('hidden'));
    
    const cfgId = 'cfg-' + wizState.type;
    const cfgEl = document.getElementById(cfgId);
    
    if (cfgEl) {
        cfgEl.classList.remove('hidden');
    } else {
        document.getElementById('cfg-simple').classList.remove('hidden');
    }
    
    // When showing API config, render the parameters list (optional section)
    if (wizState.type === 'api' && typeof renderApiParams === 'function') {
        renderApiParams();
    }
    
    // Hide the old Access Control section in step 2 (now moved to step 5)
    const oldAccessControl = document.getElementById('tool-access-control');
    if (oldAccessControl) {
        oldAccessControl.classList.add('hidden');
    }
}

// Update navigation buttons
function updateButtons() {
    const btnBack = document.getElementById('btn-back');
    const btnNext = document.getElementById('btn-next');
    const btnSkip = document.getElementById('btn-skip');
    const btnCreate = document.getElementById('btn-create');
    
    // Back button - always show if not on step 1
    btnBack.style.display = wizState.step > 1 ? 'block' : 'none';
    
    // Skip button (only on sources step)
    const actualStep = getActualStep(wizState.step);
    btnSkip.classList.toggle('hidden', actualStep !== 3);
    
    // Next vs Create/Update
    if (wizState.step >= wizState.maxSteps) {
        btnNext.classList.add('hidden');
        btnCreate.classList.remove('hidden');
        
        // Update button text based on editing state
        if (editingToolId) {
            btnCreate.textContent = 'âœ“ Update Tool';
            btnCreate.classList.remove('bg-green-600', 'hover:bg-green-700');
            btnCreate.classList.add('bg-blue-600', 'hover:bg-blue-700');
        } else {
            btnCreate.textContent = 'âœ“ Create Tool';
            btnCreate.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            btnCreate.classList.add('bg-green-600', 'hover:bg-green-700');
        }
    } else {
        btnNext.classList.remove('hidden');
        btnCreate.classList.add('hidden');
    }
}

// Navigate back
function wizBack() {
    if (wizState.step > 1) {
        showStep(wizState.step - 1);
    } else {
        // Go back to type selection
        resetWizard();
        document.getElementById('wiz-step-0').classList.remove('hidden');
    }
}

// Cancel tool edit/create
function cancelToolWizard() {
    const isEditing = !!editingToolId;
    const confirmMsg = isEditing 
        ? 'Are you sure you want to cancel editing? Changes will not be saved.'
        : 'Are you sure you want to cancel? This tool will not be created.';
    
    if (!confirm(confirmMsg)) return;
    
    // Close the modal
    hideModal('modal-tool');
    
    // Reset state
    editingToolId = null;
    resetWizard();
    
    showToast('Cancelled', 'info');
}

// Navigate next
function wizNext() {
    // Validate current step
    if (!validateStep()) return;
    
    // Save current step data
    saveStepData();
    
    if (wizState.step < wizState.maxSteps) {
        showStep(wizState.step + 1);
    }
}

// Skip step
function wizSkip() {
    if (wizState.step < wizState.maxSteps) {
        showStep(wizState.step + 1);
    }
}

// Validate current step
function validateStep() {
    if (wizState.step === 1) {
        const name = document.getElementById('wiz-name').value.trim();
        if (!name) {
            alert('Please enter a name');
            return false;
        }
    }
    
    if (getActualStep(wizState.step) === 2) {
        // Validate config based on type
        if (wizState.type === 'website') {
            const url = document.getElementById('web-url').value.trim();
            if (!url) {
                alert('Please enter a website URL');
                return false;
            }
        }
        if (wizState.type === 'api') {
            const url = document.getElementById('api-url').value.trim();
            if (!url) {
                alert('Please enter an API URL');
                return false;
            }
        }
    }
    
    return true;
}

// Save step data
function saveStepData() {
    if (wizState.step === 1) {
        wizState.data.name = document.getElementById('wiz-name').value.trim();
        wizState.data.description = document.getElementById('wiz-desc').value.trim();
    }
    
    if (getActualStep(wizState.step) === 2) {
        // Save config based on type
        const config = {};
        
        if (wizState.type === 'knowledge') {
            config.embedding = {
                use_global: document.getElementById('kb-emb-global').checked,
                provider: document.getElementById('kb-emb-provider').value,
                model: document.getElementById('kb-emb-model').value
            };
            config.chunk_size = parseInt(document.getElementById('kb-chunk').value) || 1000;
            config.chunk_overlap = parseInt(document.getElementById('kb-overlap').value) || 200;
            config.top_k = parseInt(document.getElementById('kb-topk').value) || 5;
            config.search_type = document.getElementById('kb-search').value;
        }
        
        if (wizState.type === 'website') {
            config.url = document.getElementById('web-url').value;
            config.recursive = document.getElementById('web-recursive').checked;
            config.max_pages = parseInt(document.getElementById('web-max').value) || 10;
        }
        
        if (wizState.type === 'database') {
            config.db_type = document.getElementById('db-type').value;
            config.host = document.getElementById('db-host').value;
            config.port = parseInt(document.getElementById('db-port').value);
            config.database = document.getElementById('db-name').value;
            config.username = document.getElementById('db-user').value;
            config.password = document.getElementById('db-pass').value;
        }
        
        if (wizState.type === 'api') {
            config.base_url = document.getElementById('api-url').value;
            config.method = document.getElementById('api-method').value;
            config.path = document.getElementById('api-path').value;
            config.auth_type = document.getElementById('api-auth').value;
            config.auth_value = document.getElementById('api-auth-val')?.value;
        }
        
        if (wizState.type === 'websearch') {
            config.provider = document.getElementById('search-provider').value;
            config.api_key = document.getElementById('search-key').value;
        }
        
        if (wizState.type === 'email') {
            // Get email config from hidden field or state
            const emailConfigData = document.getElementById('email-config-data')?.value;
            if (emailConfigData) {
                try {
                    const emailConfig = JSON.parse(emailConfigData);
                    Object.assign(config, emailConfig);
                } catch(e) {
                    console.error('Failed to parse email config:', e);
                }
            }
            
            // Also check if config was already set in wizState
            if (wizState.data.config && wizState.data.config.email) {
                Object.assign(config, wizState.data.config.email);
            }
            
            // Also check for SendGrid config
            const sendgridKey = document.getElementById('sendgrid-api-key')?.value;
            const sendgridFrom = document.getElementById('sendgrid-from-email')?.value;
            if (sendgridKey && sendgridFrom) {
                config.provider = 'sendgrid';
                config.apiKey = sendgridKey;
                config.fromEmail = sendgridFrom;
            }
            
            console.log('Email config:', config);
        }
        
        if (wizState.type === 'webhook') {
            config.url = document.getElementById('hook-url')?.value;
            config.method = document.getElementById('hook-method')?.value;
            config.secret = document.getElementById('hook-secret')?.value;
        }
        
        if (wizState.type === 'slack') {
            config.webhook_url = document.getElementById('slack-webhook')?.value;
        }
        
        if (wizState.type === 'calendar') {
            config.provider = document.getElementById('cal-provider')?.value;
            config.api_key = document.getElementById('cal-api-key')?.value;
        }
        
        wizState.data.config = config;
    }
    
    // Save Access Control data (from either old step 2 or new step 5)
    if (getActualStep(wizState.step) === 2 || getActualStep(wizState.step) === 5) {
        wizState.data.access_type = selectedToolAccessType || 'owner_only';
        
        if (wizState.data.access_type === 'specific_users') {
            // Read from toolAccessSelected (chips) instead of hidden selects
            wizState.data.allowed_user_ids = toolAccessSelected.users.map(u => u.id);
            wizState.data.allowed_group_ids = toolAccessSelected.groups.map(g => g.id);
            
            // Read granular permissions from toolPermissionChips
            // Format: "user:id" or "group:id" so backend can identify type
            wizState.data.can_edit_user_ids = toolPermissionChips.edit.map(e => 
                e.entityType === 'group' ? `group:${e.id}` : e.id
            );
            wizState.data.can_delete_user_ids = toolPermissionChips.delete.map(e => 
                e.entityType === 'group' ? `group:${e.id}` : e.id
            );
            wizState.data.can_execute_user_ids = toolPermissionChips.execute.map(e => 
                e.entityType === 'group' ? `group:${e.id}` : e.id
            );
            
            console.log('ðŸ“‹ [COLLECT] Access Control Data:', {
                allowed_user_ids: wizState.data.allowed_user_ids,
                allowed_group_ids: wizState.data.allowed_group_ids,
                can_edit_user_ids: wizState.data.can_edit_user_ids,
                can_delete_user_ids: wizState.data.can_delete_user_ids,
                can_execute_user_ids: wizState.data.can_execute_user_ids
            });
        } else {
            wizState.data.allowed_user_ids = [];
            wizState.data.allowed_group_ids = [];
            wizState.data.can_edit_user_ids = [];
            wizState.data.can_delete_user_ids = [];
            wizState.data.can_execute_user_ids = [];
        }
    }
}

// Update summary
function updateSummary() {
    const meta = toolMeta[wizState.type] || {};
    document.getElementById('sum-type').textContent = meta.icon + ' ' + meta.name;
    document.getElementById('sum-name').textContent = wizState.data.name || '-';
    document.getElementById('sum-docs').textContent = wizState.data.files?.length || 0;
    document.getElementById('sum-urls').textContent = wizState.data.urls?.length || 0;
    document.getElementById('sum-text').textContent = wizTextEntries?.length || 0;
    document.getElementById('sum-tables').textContent = wizTableEntries?.length || 0;
}

// ========== ACCESS STEP (Step 5) FUNCTIONS ==========

// Load data for access step
async function loadAccessStepData() {
    // Load users and groups if not already loaded
    if (!toolAccessData.users.length || !toolAccessData.groups.length) {
        await loadToolAccessUsersAndGroups();
    }
    
    // Update the chips display based on current selections
    updateAccessStepChips();
    updateAccessStepPermDropdowns();
    
    // Update access type card selection
    document.querySelectorAll('#wiz-step-5 .access-step-card').forEach(card => {
        const accessType = card.dataset.access;
        const isSelected = accessType === selectedToolAccessType;
        card.classList.toggle('border-purple-500', isSelected && accessType === 'owner_only');
        card.classList.toggle('border-blue-500', isSelected && accessType === 'authenticated');
        card.classList.toggle('border-yellow-500', isSelected && accessType === 'specific_users');
        card.classList.toggle('border-green-500', isSelected && accessType === 'public');
        card.classList.toggle('border-gray-600', !isSelected);
        card.classList.toggle('bg-purple-500/10', isSelected && accessType === 'owner_only');
        card.classList.toggle('bg-blue-500/10', isSelected && accessType === 'authenticated');
        card.classList.toggle('bg-yellow-500/10', isSelected && accessType === 'specific_users');
        card.classList.toggle('bg-green-500/10', isSelected && accessType === 'public');
        card.querySelector('.access-step-check')?.classList.toggle('hidden', !isSelected);
    });
    
    // Show/hide specific users config
    const specificConfig = document.getElementById('access-step-specific-config');
    if (specificConfig) {
        specificConfig.classList.toggle('hidden', selectedToolAccessType !== 'specific_users');
    }
}

// Filter access step search results
function filterAccessStepSearch(query) {
    const resultsEl = document.getElementById('access-step-search-results');
    if (!resultsEl) return;
    
    if (!query || query.length < 1) {
        resultsEl.classList.add('hidden');
        return;
    }
    
    const q = query.toLowerCase();
    let html = '';
    
    // Filter users
    const matchingUsers = toolAccessData.users.filter(u => 
        (u.full_name?.toLowerCase().includes(q) || 
         u.email?.toLowerCase().includes(q) ||
         u.username?.toLowerCase().includes(q)) &&
        !toolAccessSelected.users.some(su => su.id === u.id)
    ).slice(0, 5);
    
    // Filter groups
    const matchingGroups = toolAccessData.groups.filter(g => 
        g.name?.toLowerCase().includes(q) &&
        !toolAccessSelected.groups.some(sg => sg.id === g.id)
    ).slice(0, 5);
    
    if (matchingUsers.length) {
        html += '<div class="px-3 py-1 text-xs text-gray-400 bg-gray-700">Users</div>';
        matchingUsers.forEach(u => {
            html += `<div class="px-3 py-2 cursor-pointer hover:bg-gray-700 flex items-center gap-2" 
                         onclick="addAccessStepUser('${u.id}', '${escHtml(u.full_name || u.email)}', '${escHtml(u.email || '')}')">
                <span class="w-6 h-6 rounded-full bg-purple-500 flex items-center justify-center text-xs">ðŸ‘¤</span>
                <div>
                    <div class="text-sm">${escHtml(u.full_name || u.username || 'User')}</div>
                    <div class="text-xs text-gray-400">${escHtml(u.email || '')}</div>
                </div>
            </div>`;
        });
    }
    
    if (matchingGroups.length) {
        html += '<div class="px-3 py-1 text-xs text-gray-400 bg-gray-700">Groups</div>';
        matchingGroups.forEach(g => {
            html += `<div class="px-3 py-2 cursor-pointer hover:bg-gray-700 flex items-center gap-2" 
                         onclick="addAccessStepGroup('${g.id}', '${escHtml(g.name)}')">
                <span class="w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center text-xs">ðŸ‘¥</span>
                <div class="text-sm">${escHtml(g.name)}</div>
            </div>`;
        });
    }
    
    if (!html) {
        html = '<div class="px-3 py-2 text-sm text-gray-400">No results found</div>';
    }
    
    resultsEl.innerHTML = html;
    resultsEl.classList.remove('hidden');
}

function showAccessStepResults() {
    const searchInput = document.getElementById('access-step-search');
    if (searchInput && searchInput.value) {
        filterAccessStepSearch(searchInput.value);
    }
}

function addAccessStepUser(id, name, email) {
    if (!toolAccessSelected.users.some(u => u.id === id)) {
        toolAccessSelected.users.push({ id, name, email, type: 'user' });
        updateAccessStepChips();
        updateAccessStepPermDropdowns();
    }
    document.getElementById('access-step-search').value = '';
    document.getElementById('access-step-search-results').classList.add('hidden');
}

function addAccessStepGroup(id, name) {
    if (!toolAccessSelected.groups.some(g => g.id === id)) {
        toolAccessSelected.groups.push({ id, name, type: 'group' });
        updateAccessStepChips();
        updateAccessStepPermDropdowns();
    }
    document.getElementById('access-step-search').value = '';
    document.getElementById('access-step-search-results').classList.add('hidden');
}

function removeAccessStepUser(id) {
    toolAccessSelected.users = toolAccessSelected.users.filter(u => u.id !== id);
    updateAccessStepChips();
    updateAccessStepPermDropdowns();
}

function removeAccessStepGroup(id) {
    toolAccessSelected.groups = toolAccessSelected.groups.filter(g => g.id !== id);
    updateAccessStepChips();
    updateAccessStepPermDropdowns();
}

function updateAccessStepChips() {
    const chipsEl = document.getElementById('access-step-selected-chips');
    const countEl = document.getElementById('access-step-count');
    const noSelectionEl = document.getElementById('access-step-no-selection');
    
    if (!chipsEl) return;
    
    const totalCount = toolAccessSelected.users.length + toolAccessSelected.groups.length;
    
    if (countEl) countEl.textContent = totalCount;
    
    if (totalCount === 0) {
        chipsEl.innerHTML = '<div id="access-step-no-selection" class="text-sm italic text-gray-500">Click on users or groups from search to add them</div>';
        return;
    }
    
    let html = '';
    
    // User chips
    toolAccessSelected.users.forEach(u => {
        html += `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-purple-500/20 text-purple-300 border border-purple-500/30">
            ðŸ‘¤ ${escHtml(u.name)}
            <button onclick="removeAccessStepUser('${u.id}')" class="ml-1 hover:text-red-400">&times;</button>
        </span>`;
    });
    
    // Group chips
    toolAccessSelected.groups.forEach(g => {
        html += `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-blue-500/20 text-blue-300 border border-blue-500/30">
            ðŸ‘¥ ${escHtml(g.name)}
            <button onclick="removeAccessStepGroup('${g.id}')" class="ml-1 hover:text-red-400">&times;</button>
        </span>`;
    });
    
    chipsEl.innerHTML = html;
}

function updateAccessStepPermDropdowns() {
    ['edit', 'delete', 'execute'].forEach(permType => {
        const selectEl = document.getElementById('access-step-' + permType + '-select');
        if (!selectEl) return;
        
        let html = '<option value="">+ Add user/group</option>';
        
        // Add users
        toolAccessSelected.users.forEach(u => {
            if (!toolPermissionChips[permType]?.some(c => c.id === u.id && c.entityType === 'user')) {
                html += `<option value="user:${u.id}">${escHtml(u.name)}</option>`;
            }
        });
        
        // Add groups
        toolAccessSelected.groups.forEach(g => {
            if (!toolPermissionChips[permType]?.some(c => c.id === g.id && c.entityType === 'group')) {
                html += `<option value="group:${g.id}">${escHtml(g.name)}</option>`;
            }
        });
        
        selectEl.innerHTML = html;
        
        // Update chips display
        updateAccessStepPermChips(permType);
    });
}

function addAccessStepPermChip(permType, selectEl) {
    const value = selectEl.value;
    if (!value) return;
    
    const [type, id] = value.split(':');
    
    let entity;
    if (type === 'user') {
        entity = toolAccessSelected.users.find(u => u.id === id);
    } else if (type === 'group') {
        entity = toolAccessSelected.groups.find(g => g.id === id);
    }
    
    if (!entity) return;
    
    const chipData = { id: entity.id, name: entity.name, entityType: type };
    
    if (!toolPermissionChips[permType]) {
        toolPermissionChips[permType] = [];
    }
    
    if (!toolPermissionChips[permType].some(c => c.id === id && c.entityType === type)) {
        toolPermissionChips[permType].push(chipData);
    }
    
    updateAccessStepPermChips(permType);
    selectEl.value = '';
    updateAccessStepPermDropdowns();
}

function updateAccessStepPermChips(permType) {
    const chipsEl = document.getElementById('access-step-' + permType + '-chips');
    if (!chipsEl) return;
    
    const chips = toolPermissionChips[permType] || [];
    
    if (chips.length === 0) {
        chipsEl.innerHTML = '';
        return;
    }
    
    let html = '';
    chips.forEach(chip => {
        const icon = chip.entityType === 'user' ? 'ðŸ‘¤' : 'ðŸ‘¥';
        const bgColor = chip.entityType === 'user' ? 'bg-purple-500/20' : 'bg-blue-500/20';
        const textColor = chip.entityType === 'user' ? 'text-purple-300' : 'text-blue-300';
        html += `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs ${bgColor} ${textColor}">
            ${icon} ${escHtml(chip.name)}
            <button onclick="removeAccessStepPermChip('${permType}', '${chip.id}', '${chip.entityType}')" class="hover:text-red-400">&times;</button>
        </span>`;
    });
    
    chipsEl.innerHTML = html;
}

function removeAccessStepPermChip(permType, id, entityType) {
    if (toolPermissionChips[permType]) {
        toolPermissionChips[permType] = toolPermissionChips[permType].filter(c => !(c.id === id && c.entityType === entityType));
    }
    updateAccessStepPermChips(permType);
    updateAccessStepPermDropdowns();
}

// ========== REVIEW STEP (Step 6) FUNCTIONS ==========

function updateReviewStep() {
    const meta = toolMeta[wizState.type] || {};
    
    // Basic info
    document.getElementById('review-type').textContent = meta.icon + ' ' + meta.name;
    document.getElementById('review-name').textContent = wizState.data.name || document.getElementById('wiz-name')?.value || '-';
    document.getElementById('review-desc').textContent = wizState.data.description || document.getElementById('wiz-desc')?.value || '-';
    
    // Config details based on tool type
    const configDetailsEl = document.getElementById('review-config-details');
    if (configDetailsEl) {
        let configHtml = '';
        
        if (wizState.type === 'api') {
            const baseUrl = document.getElementById('api-url')?.value || '';
            const endpoint = document.getElementById('api-path')?.value || '';
            const method = document.getElementById('api-method')?.value || 'GET';
            const authType = document.getElementById('api-auth')?.value || 'none';
            configHtml = `
                <div class="grid grid-cols-3 gap-2 items-center">
                    <span class="text-gray-400">Base URL:</span>
                    <span class="col-span-2 truncate">${escHtml(baseUrl || '-')}</span>
                </div>
                <div class="grid grid-cols-3 gap-2 items-center">
                    <span class="text-gray-400">Endpoint:</span>
                    <span class="col-span-2">${escHtml(endpoint || '-')}</span>
                </div>
                <div class="grid grid-cols-3 gap-2 items-center">
                    <span class="text-gray-400">Method:</span>
                    <span class="col-span-2">${escHtml(method)}</span>
                </div>
                <div class="grid grid-cols-3 gap-2 items-center">
                    <span class="text-gray-400">Auth:</span>
                    <span class="col-span-2">${escHtml(authType === 'none' ? 'None' : authType)}</span>
                </div>
                ${(apiParams && apiParams.length > 0) ? `
                <div class="grid grid-cols-3 gap-2 items-center">
                    <span class="text-gray-400">Fields (params):</span>
                    <span class="col-span-2">${apiParams.length} field(s) â€” ${apiParams.map(p => escHtml(p.name || 'unnamed')).join(', ') || '-'}</span>
                </div>
                ` : ''}
            `;
        } else if (wizState.type === 'website') {
            const url = document.getElementById('web-url')?.value || '';
            const recursive = document.getElementById('web-recursive')?.checked || false;
            const maxPages = document.getElementById('web-max')?.value || '10';
            configHtml = `
                <div class="grid grid-cols-3 gap-2 items-center">
                    <span class="text-gray-400">URL:</span>
                    <span class="col-span-2 truncate">${escHtml(url || '-')}</span>
                </div>
                <div class="grid grid-cols-3 gap-2 items-center">
                    <span class="text-gray-400">Recursive:</span>
                    <span class="col-span-2">${recursive ? 'Yes' : 'No'}</span>
                </div>
                <div class="grid grid-cols-3 gap-2 items-center">
                    <span class="text-gray-400">Max Pages:</span>
                    <span class="col-span-2">${escHtml(maxPages)}</span>
                </div>
            `;
        } else if (wizState.type === 'database') {
            const dbType = document.getElementById('db-type')?.value || 'postgresql';
            const host = document.getElementById('db-host')?.value || '';
            configHtml = `
                <div class="grid grid-cols-3 gap-2 items-center">
                    <span class="text-gray-400">Database:</span>
                    <span class="col-span-2">${escHtml(dbType)}</span>
                </div>
                <div class="grid grid-cols-3 gap-2 items-center">
                    <span class="text-gray-400">Host:</span>
                    <span class="col-span-2">${escHtml(host || '-')}</span>
                </div>
            `;
        }
        
        configDetailsEl.innerHTML = configHtml;
    }
    
    // Access control summary
    const accessTypeLabels = {
        'owner_only': { icon: 'ðŸ‘¤', label: 'Owner Only', color: 'purple' },
        'authenticated': { icon: 'ðŸ”‘', label: 'All Logged In', color: 'blue' },
        'specific_users': { icon: 'ðŸ‘¥', label: 'Specific Users', color: 'yellow' },
        'public': { icon: 'ðŸŒ', label: 'Public', color: 'green' }
    };
    
    const accessLabel = accessTypeLabels[selectedToolAccessType] || accessTypeLabels['owner_only'];
    const accessTypeEl = document.getElementById('review-access-type');
    accessTypeEl.innerHTML = accessLabel.icon + ' ' + accessLabel.label;
    accessTypeEl.className = `px-2 py-1 rounded bg-${accessLabel.color}-500/20 text-${accessLabel.color}-300 text-xs`;
    
    // Show users/groups if specific_users
    const usersSection = document.getElementById('review-access-users');
    const groupsSection = document.getElementById('review-access-groups');
    const permsSection = document.getElementById('review-permissions-section');
    
    if (selectedToolAccessType === 'specific_users') {
        if (toolAccessSelected.users.length > 0) {
            usersSection.classList.remove('hidden');
            document.getElementById('review-users-list').innerHTML = toolAccessSelected.users.map(u => 
                `<span class="px-2 py-0.5 rounded bg-purple-500/20 text-purple-300 text-xs">ðŸ‘¤ ${escHtml(u.name)}</span>`
            ).join('');
        } else {
            usersSection.classList.add('hidden');
        }
        
        if (toolAccessSelected.groups.length > 0) {
            groupsSection.classList.remove('hidden');
            document.getElementById('review-groups-list').innerHTML = toolAccessSelected.groups.map(g => 
                `<span class="px-2 py-0.5 rounded bg-blue-500/20 text-blue-300 text-xs">ðŸ‘¥ ${escHtml(g.name)}</span>`
            ).join('');
        } else {
            groupsSection.classList.add('hidden');
        }
        
        // Show granular permissions
        const hasEditPerms = toolPermissionChips.edit && toolPermissionChips.edit.length > 0;
        const hasDeletePerms = toolPermissionChips.delete && toolPermissionChips.delete.length > 0;
        const hasExecutePerms = toolPermissionChips.execute && toolPermissionChips.execute.length > 0;
        const hasAnyPerms = hasEditPerms || hasDeletePerms || hasExecutePerms;
        
        if (hasAnyPerms && permsSection) {
            permsSection.classList.remove('hidden');
            
            // Edit permissions
            const editSection = document.getElementById('review-perm-edit');
            if (hasEditPerms) {
                editSection.classList.remove('hidden');
                document.getElementById('review-edit-list').innerHTML = toolPermissionChips.edit.map(p => {
                    const icon = p.entityType === 'user' ? 'ðŸ‘¤' : 'ðŸ‘¥';
                    const color = p.entityType === 'user' ? 'purple' : 'blue';
                    return `<span class="px-1.5 py-0.5 rounded bg-${color}-500/20 text-${color}-300 text-xs">${icon} ${escHtml(p.name)}</span>`;
                }).join('');
            } else {
                editSection.classList.add('hidden');
            }
            
            // Delete permissions
            const deleteSection = document.getElementById('review-perm-delete');
            if (hasDeletePerms) {
                deleteSection.classList.remove('hidden');
                document.getElementById('review-delete-list').innerHTML = toolPermissionChips.delete.map(p => {
                    const icon = p.entityType === 'user' ? 'ðŸ‘¤' : 'ðŸ‘¥';
                    const color = p.entityType === 'user' ? 'purple' : 'blue';
                    return `<span class="px-1.5 py-0.5 rounded bg-${color}-500/20 text-${color}-300 text-xs">${icon} ${escHtml(p.name)}</span>`;
                }).join('');
            } else {
                deleteSection.classList.add('hidden');
            }
            
            // Execute permissions
            const executeSection = document.getElementById('review-perm-execute');
            if (hasExecutePerms) {
                executeSection.classList.remove('hidden');
                document.getElementById('review-execute-list').innerHTML = toolPermissionChips.execute.map(p => {
                    const icon = p.entityType === 'user' ? 'ðŸ‘¤' : 'ðŸ‘¥';
                    const color = p.entityType === 'user' ? 'purple' : 'blue';
                    return `<span class="px-1.5 py-0.5 rounded bg-${color}-500/20 text-${color}-300 text-xs">${icon} ${escHtml(p.name)}</span>`;
                }).join('');
            } else {
                executeSection.classList.add('hidden');
            }
        } else if (permsSection) {
            permsSection.classList.add('hidden');
        }
    } else {
        usersSection.classList.add('hidden');
        groupsSection.classList.add('hidden');
        if (permsSection) permsSection.classList.add('hidden');
    }
    
    // Sources summary (show only for data tools)
    const sourcesSection = document.getElementById('review-sources-section');
    if (sourcesSection && meta.hasSources) {
        sourcesSection.classList.remove('hidden');
        document.getElementById('review-files').textContent = wizState.data.files?.length || 0;
        document.getElementById('review-urls').textContent = wizState.data.urls?.length || 0;
        document.getElementById('review-text').textContent = wizTextEntries?.length || 0;
        document.getElementById('review-tables').textContent = wizTableEntries?.length || 0;
    } else if (sourcesSection) {
        sourcesSection.classList.add('hidden');
    }
    
    // Reset test result
    const testResult = document.getElementById('review-test-result');
    if (testResult) testResult.classList.add('hidden');
}

// Re-scrape website for editing tool
async function rescrapeWebsite() {
    if (!editingToolId) {
        showToast('No tool to rescrape', 'error');
        return;
    }
    
    const url = document.getElementById('web-url')?.value?.trim();
    if (!url) {
        showToast('Please enter a URL first', 'error');
        return;
    }
    
    const recursive = document.getElementById('web-recursive')?.checked || false;
    const maxPages = parseInt(document.getElementById('web-max')?.value) || 10;
    
    if (!confirm(`This will re-scrape the website and replace existing content.\n\nURL: ${url}\nRecursive: ${recursive}\nMax Pages: ${maxPages}\n\nContinue?`)) {
        return;
    }
    
    showProgressModal('Re-scraping website...');
    updateProgress(10, 'Starting scrape...');
    
    try {
        const response = await fetch(API + '/api/tools/' + editingToolId + '/scrape', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                url: url,
                recursive: recursive,
                max_pages: maxPages
            })
        });
        
        updateProgress(80, 'Processing content...');
        
        if (response.ok) {
            const data = await response.json();
            updateProgress(100, 'Done!');
            
            setTimeout(() => {
                hideProgressModal();
                showToast(`Successfully scraped! Extracted ${data.chunks_extracted || 0} chunks.`, 'success');
                
                // Refresh the scraped pages list
                fetch(API + '/api/tools/' + editingToolId)
                    .then(r => r.json())
                    .then(tool => {
                        const scrapedPages = tool.scraped_pages || [];
                        const scrapedContainer = document.getElementById('web-scraped-pages');
                        const scrapedList = document.getElementById('web-scraped-list');
                        
                        if (scrapedPages.length > 0 && scrapedContainer && scrapedList) {
                            scrapedContainer.classList.remove('hidden');
                            scrapedList.innerHTML = scrapedPages.map(p => `
                                <div class="flex items-center justify-between bg-gray-800/50 rounded-lg p-2">
                                    <div class="flex items-center gap-2 min-w-0 flex-1">
                                        <span>ðŸ”—</span>
                                        <a href="${escHtml(p.url)}" target="_blank" class="text-sm text-blue-400 hover:underline truncate">${escHtml(p.url || p.title || 'Page')}</a>
                                    </div>
                                    <span class="text-xs text-gray-500 ml-2">${p.chunks_extracted || 0} chunks</span>
                                </div>
                            `).join('');
                        }
                    });
            }, 500);
        } else {
            const error = await response.json();
            hideProgressModal();
            showToast(error.detail || 'Failed to scrape', 'error');
        }
    } catch (e) {
        hideProgressModal();
        showToast('Error: ' + e.message, 'error');
    }
}

// Test tool (unified: API opens same modal as "Try this API", other types run inline)
async function testWizTool() {
    if (wizState.type === 'api' && typeof openWizardApiTestModal === 'function') {
        openWizardApiTestModal();
        return;
    }
    
    const resultEl = document.getElementById('wiz-test-result') || document.getElementById('review-test-result');
    const reviewResultEl = document.getElementById('review-test-result');
    
    if (resultEl) {
        resultEl.classList.remove('hidden');
        resultEl.className = 'p-3 rounded-lg text-sm bg-blue-900/30 border border-blue-600';
        resultEl.innerHTML = '<span class="animate-pulse">ðŸ”„ Testing...</span>';
    }
    if (reviewResultEl && reviewResultEl !== resultEl) {
        reviewResultEl.classList.remove('hidden');
        reviewResultEl.className = 'p-3 rounded-lg text-sm bg-blue-900/30 border border-blue-600';
        reviewResultEl.innerHTML = '<span class="animate-pulse">ðŸ”„ Testing...</span>';
    }
    
    try {
        let testResult = { success: true, message: 'Connection successful!' };
        
        if (wizState.type === 'api') {
            const baseUrl = document.getElementById('api-url')?.value;
            const endpoint = document.getElementById('api-path')?.value || '';
            const method = document.getElementById('api-method')?.value || 'GET';
            
            if (baseUrl) {
                try {
                    const testResponse = await fetch(API + '/api/tools/test-api', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                        body: JSON.stringify({
                            base_url: baseUrl,
                            endpoint_path: endpoint,
                            http_method: method,
                            auth_type: document.getElementById('api-auth')?.value || 'none',
                            auth_value: document.getElementById('api-auth-val')?.value || ''
                        })
                    });
                    const testData = await testResponse.json();
                    testResult = {
                        success: testData.success,
                        message: testData.success 
                            ? `âœ… API responded with status ${testData.status_code}` 
                            : `âŒ ${testData.error || 'Connection failed'}`,
                        data: testData.data
                    };
                } catch (e) {
                    testResult = { success: false, message: 'âŒ ' + e.message };
                }
            } else {
                testResult = { success: false, message: 'âš ï¸ Please enter a Base URL first' };
            }
        } else {
            // For other types, just simulate success
            await new Promise(r => setTimeout(r, 500));
        }
        
        // Show result
        const className = testResult.success 
            ? 'p-3 rounded-lg text-sm bg-green-900/30 border border-green-600'
            : 'p-3 rounded-lg text-sm bg-red-900/30 border border-red-600';
        
        let resultHtml = testResult.message;
        if (testResult.data) {
            resultHtml += `<pre class="mt-2 text-xs bg-gray-900 p-2 rounded overflow-x-auto max-h-32">${escHtml(JSON.stringify(testResult.data, null, 2))}</pre>`;
        }
        
        if (resultEl) {
            resultEl.className = className;
            resultEl.innerHTML = resultHtml;
        }
        if (reviewResultEl && reviewResultEl !== resultEl) {
            reviewResultEl.className = className;
            reviewResultEl.innerHTML = resultHtml;
        }
    } catch (e) {
        const errorHtml = 'âŒ Test failed: ' + e.message;
        const errorClass = 'p-3 rounded-lg text-sm bg-red-900/30 border border-red-600';
        if (resultEl) {
            resultEl.className = errorClass;
            resultEl.innerHTML = errorHtml;
        }
        if (reviewResultEl && reviewResultEl !== resultEl) {
            reviewResultEl.className = errorClass;
            reviewResultEl.innerHTML = errorHtml;
        }
    }
}

// Create or Update tool
async function wizCreate() {
    saveStepData();
    
    // Validate required data
    if (!wizState.data.name) {
        alert('Please enter a tool name');
        return;
    }
    
    // Special validation for email
    if (wizState.type === 'email') {
        const config = wizState.data.config || {};
        const emailConfigData = document.getElementById('email-config-data')?.value;
        const hasOAuthConfig = config.provider || config.email || (emailConfigData && emailConfigData.length > 2);
        const hasSendGridConfig = document.getElementById('sendgrid-api-key')?.value && document.getElementById('sendgrid-from-email')?.value;
        
        if (!hasOAuthConfig && !hasSendGridConfig) {
            alert('Please connect an email provider first (Gmail, Outlook, or SendGrid)');
            return;
        }
    }
    
    // Check if we're editing
    const isEditing = !!editingToolId;
    
    // Show progress
    showProgressModal(isEditing ? 'Updating tool...' : 'Creating tool...');
    updateProgress(10, isEditing ? 'Updating tool...' : 'Creating tool...');
    
    try {
        // Create or Update tool
        console.log(isEditing ? 'Updating tool:' : 'Creating tool:', {
            type: wizState.type,
            name: wizState.data.name,
            description: wizState.data.description,
            config: wizState.data.config
        });
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        // Use PUT for update, POST for create
        const url = isEditing ? API + '/api/tools/' + editingToolId : API + '/api/tools';
        const method = isEditing ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
            body: JSON.stringify({
                type: wizState.type,
                name: wizState.data.name,
                description: wizState.data.description,
                config: wizState.data.config,
                // Access Control
                access_type: wizState.data.access_type || 'owner_only',
                allowed_user_ids: wizState.data.allowed_user_ids || [],
                allowed_group_ids: wizState.data.allowed_group_ids || [],
                can_edit_user_ids: wizState.data.can_edit_user_ids || [],
                can_delete_user_ids: wizState.data.can_delete_user_ids || [],
                can_execute_user_ids: wizState.data.can_execute_user_ids || []
            }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || (isEditing ? 'Failed to update tool' : 'Failed to create tool'));
        }
        
        const result = await response.json();
        const toolId = isEditing ? editingToolId : result.tool_id;
        
        updateProgress(20, isEditing ? 'Tool updated!' : 'Tool created!');
        
        // Upload files if any
        if (wizState.data.files && wizState.data.files.length > 0) {
            for (let i = 0; i < wizState.data.files.length; i++) {
                const file = wizState.data.files[i];
                updateProgress(20 + (i / wizState.data.files.length) * 25, 'Uploading ' + file.name + '...');
                
                const fd = new FormData();
                fd.append('file', file);
                await fetch(API + '/api/tools/' + toolId + '/documents', { method: 'POST', body: fd });
            }
        }
        
        // Scrape URLs if any
        if (wizState.data.urls && wizState.data.urls.length > 0) {
            for (let i = 0; i < wizState.data.urls.length; i++) {
                const url = wizState.data.urls[i];
                updateProgress(45 + (i / wizState.data.urls.length) * 20, 'Scraping ' + url + '...');
                
                await fetch(API + '/api/tools/' + toolId + '/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, recursive: false, max_pages: 1 })
                });
            }
        }
        
        // Add text entries if any
        if (wizTextEntries && wizTextEntries.length > 0) {
            for (let i = 0; i < wizTextEntries.length; i++) {
                const entry = wizTextEntries[i];
                updateProgress(65 + (i / wizTextEntries.length) * 15, 'Adding text: ' + entry.title + '...');
                
                await fetch(API + '/api/tools/' + toolId + '/demo-document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source: entry.title, content: entry.content })
                });
            }
        }
        
        // Add table entries if any
        if (wizTableEntries && wizTableEntries.length > 0) {
            for (let i = 0; i < wizTableEntries.length; i++) {
                const table = wizTableEntries[i];
                updateProgress(80 + (i / wizTableEntries.length) * 15, 'Adding table: ' + table.name + '...');
                
                // Convert table to searchable text
                let tableContent = `## ${table.name}\n\n`;
                tableContent += '| ' + table.data.headers.join(' | ') + ' |\n';
                tableContent += '| ' + table.data.headers.map(() => '---').join(' | ') + ' |\n';
                table.data.rows.forEach(row => {
                    tableContent += '| ' + row.join(' | ') + ' |\n';
                });
                tableContent += '\n### Records:\n\n';
                table.data.rows.forEach((row, idx) => {
                    tableContent += `**Record ${idx + 1}:**\n`;
                    table.data.headers.forEach((h, j) => {
                        if (row[j]) tableContent += `- ${h}: ${row[j]}\n`;
                    });
                    tableContent += '\n';
                });
                
                await fetch(API + '/api/tools/' + toolId + '/table-entry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        source: table.name, 
                        content: tableContent,
                        table_data: table.data
                    })
                });
            }
        }
        
        updateProgress(100, isEditing ? 'âœ… Tool updated!' : 'âœ… Done!');
        
        // Reset wizard entries
        wizTextEntries = [];
        wizTableEntries = [];
        
        // Show success notification
        showToast(isEditing ? 'Tool updated successfully!' : 'Tool created successfully!', 'success');
        
        // Reset editing state
        const savedToolId = toolId;
        const wasEditing = isEditing;
        const meta = toolMeta[wizState.type];
        editingToolId = null;
        
        setTimeout(() => {
            hideProgressModal();
            closeWizard();
            loadTools();
            
            // For tools with noTestStep: always show tool detail for testing
            // For new tools with test step: show tool detail
            // For updates: just show success toast and stay on tools list
            if (savedToolId && (meta?.noTestStep || !wasEditing)) {
                viewTool(savedToolId);
            } else if (wasEditing) {
                showToast('Tool updated successfully!', 'success');
            }
        }, 500);
        
    } catch (e) {
        hideProgressModal();
        console.error(isEditing ? 'Error updating tool:' : 'Error creating tool:', e);
        editingToolId = null; // Reset on error too
        if (e.name === 'AbortError') {
            alert('Request timed out. Please try again.');
        } else {
            alert((isEditing ? 'Error updating tool: ' : 'Error creating tool: ') + (e.message || 'Unknown error'));
        }
    }
}

// File handling
function handleWizFiles(event) {
    const files = Array.from(event.target.files);
    wizState.data.files.push(...files);
    renderWizFiles();
}

function renderWizFiles() {
    const list = document.getElementById('wiz-files-list');
    list.innerHTML = wizState.data.files.map((f, i) => `
        <div class="flex items-center justify-between bg-gray-800 rounded-lg p-2">
            <div class="flex items-center gap-2 min-w-0">
                <span>${getFileIcon(f.name)}</span>
                <span class="text-sm truncate">${f.name}</span>
                <span class="text-xs text-gray-500">(${formatSize(f.size)})</span>
            </div>
            <button onclick="removeWizFile(${i})" class="text-gray-500 hover:text-red-400 p-1">âœ•</button>
        </div>
    `).join('');
}

function removeWizFile(idx) {
    wizState.data.files.splice(idx, 1);
    renderWizFiles();
}

function getFileIcon(name) {
    const ext = name.split('.').pop().toLowerCase();
    const icons = { pdf: 'ðŸ“•', doc: 'ðŸ“˜', docx: 'ðŸ“˜', xls: 'ðŸ“—', xlsx: 'ðŸ“—', ppt: 'ðŸ“™', pptx: 'ðŸ“™', txt: 'ðŸ“„', csv: 'ðŸ“Š', md: 'ðŸ“' };
    return icons[ext] || 'ðŸ“„';
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// URL handling
function addWizUrl() {
    const input = document.getElementById('wiz-url-input');
    const url = input.value.trim();
    if (url && url.startsWith('http')) {
        wizState.data.urls.push(url);
        input.value = '';
        renderWizUrls();
    }
}

function renderWizUrls() {
    const list = document.getElementById('wiz-urls-list');
    list.innerHTML = wizState.data.urls.map((url, i) => `
        <div class="flex items-center justify-between bg-gray-800 rounded-lg p-2">
            <div class="flex items-center gap-2 min-w-0">
                <span>ðŸ”—</span>
                <span class="text-sm truncate">${url}</span>
            </div>
            <button onclick="removeWizUrl(${i})" class="text-gray-500 hover:text-red-400 p-1">âœ•</button>
        </div>
    `).join('');
}

function removeWizUrl(idx) {
    wizState.data.urls.splice(idx, 1);
    renderWizUrls();
}

// Source tabs
function setSourceTab(tab) {
    const tabs = ['docs', 'urls', 'text', 'table'];
    
    tabs.forEach(t => {
        const tabEl = document.getElementById('tab-' + t);
        const sourceEl = document.getElementById('sources-' + t);
        
        if (tabEl) {
            tabEl.classList.toggle('border-purple-500', tab === t);
            tabEl.classList.toggle('text-white', tab === t);
            tabEl.classList.toggle('border-transparent', tab !== t);
            tabEl.classList.toggle('text-gray-400', tab !== t);
        }
        
        if (sourceEl) {
            sourceEl.classList.toggle('hidden', tab !== t);
        }
    });
    
    // Initialize table editor if switching to table tab
    if (tab === 'table' && !wizState.tableData) {
        wizState.tableData = { headers: ['Column 1', 'Column 2', 'Column 3'], rows: [['', '', ''], ['', '', '']] };
        renderWizTableEditor();
    }
}

// Wizard Text Entry functions
let wizTextEntries = [];

function addWizTextEntry() {
    const title = document.getElementById('wiz-text-title')?.value?.trim();
    const content = document.getElementById('wiz-text-content')?.value?.trim();
    
    if (!title || !content) {
        alert('Please enter both title and content');
        return;
    }
    
    wizTextEntries.push({ title, content });
    document.getElementById('wiz-text-title').value = '';
    document.getElementById('wiz-text-content').value = '';
    renderWizTextList();
}

function renderWizTextList() {
    const list = document.getElementById('wiz-text-list');
    if (!list) return;
    
    list.innerHTML = wizTextEntries.map((e, i) => `
        <div class="flex items-center justify-between bg-gray-800 rounded-lg p-3">
            <div class="flex items-center gap-2 min-w-0">
                <span>ðŸ“</span>
                <div class="min-w-0">
                    <p class="text-sm font-medium truncate">${escHtml(e.title)}</p>
                    <p class="text-xs text-gray-500">${e.content.length} characters</p>
                </div>
            </div>
            <button onclick="removeWizTextEntry(${i})" class="text-red-400 hover:text-red-300 p-1">ðŸ—‘ï¸</button>
        </div>
    `).join('');
}

function removeWizTextEntry(idx) {
    wizTextEntries.splice(idx, 1);
    renderWizTextList();
}

// Wizard Table functions
let wizTableEntries = [];

function renderWizTableEditor() {
    const container = document.getElementById('wiz-table-editor');
    if (!container || !wizState.tableData) return;
    
    let html = '<table class="w-full border-collapse text-sm">';
    
    // Headers row
    html += '<tr>';
    wizState.tableData.headers.forEach((h, i) => {
        html += `<th class="border border-gray-600 p-0">
            <input type="text" value="${escHtml(h)}" 
                   onchange="wizState.tableData.headers[${i}]=this.value" 
                   class="w-full bg-gray-700 text-white font-semibold px-2 py-1.5 text-center outline-none focus:bg-gray-600 text-xs"
                   placeholder="Header">
        </th>`;
    });
    html += '</tr>';
    
    // Data rows
    wizState.tableData.rows.forEach((row, ri) => {
        html += '<tr>';
        row.forEach((cell, ci) => {
            html += `<td class="border border-gray-700 p-0">
                <input type="text" value="${escHtml(cell)}" 
                       onchange="wizState.tableData.rows[${ri}][${ci}]=this.value"
                       class="w-full bg-gray-800 px-2 py-1.5 outline-none focus:bg-gray-700 text-xs">
            </td>`;
        });
        html += '</tr>';
    });
    
    html += '</table>';
    container.innerHTML = html;
    
    // Update counters
    const colCount = document.getElementById('wiz-col-count');
    const rowCount = document.getElementById('wiz-row-count');
    if (colCount) colCount.textContent = wizState.tableData.headers.length;
    if (rowCount) rowCount.textContent = wizState.tableData.rows.length;
}

function changeWizTableCols(delta) {
    if (!wizState.tableData) return;
    const newCount = wizState.tableData.headers.length + delta;
    if (newCount < 1 || newCount > 10) return;
    
    if (delta > 0) {
        wizState.tableData.headers.push('Column ' + newCount);
        wizState.tableData.rows.forEach(row => row.push(''));
    } else {
        wizState.tableData.headers.pop();
        wizState.tableData.rows.forEach(row => row.pop());
    }
    renderWizTableEditor();
}

function changeWizTableRows(delta) {
    if (!wizState.tableData) return;
    const newCount = wizState.tableData.rows.length + delta;
    if (newCount < 1 || newCount > 20) return;
    
    if (delta > 0) {
        wizState.tableData.rows.push(new Array(wizState.tableData.headers.length).fill(''));
    } else {
        wizState.tableData.rows.pop();
    }
    renderWizTableEditor();
}

function importWizTableFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const fileName = file.name.toLowerCase();
    
    if (fileName.endsWith('.csv')) {
        const reader = new FileReader();
        reader.onload = (e) => {
            parseWizCSV(e.target.result);
        };
        reader.readAsText(file);
    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                if (!window.XLSX) {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                    document.head.appendChild(script);
                    await new Promise(r => script.onload = r);
                }
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                
                if (jsonData.length > 0) {
                    wizState.tableData = {
                        headers: jsonData[0].map(h => String(h || '')),
                        rows: jsonData.slice(1).map(row => 
                            jsonData[0].map((_, i) => String(row[i] || ''))
                        )
                    };
                    if (wizState.tableData.rows.length === 0) {
                        wizState.tableData.rows = [new Array(wizState.tableData.headers.length).fill('')];
                    }
                    renderWizTableEditor();
                    
                    // Auto-fill table name
                    const tableName = document.getElementById('wiz-table-name');
                    if (tableName && !tableName.value) {
                        tableName.value = file.name.replace(/\.(csv|xlsx|xls)$/i, '');
                    }
                }
            } catch (err) {
                alert('Failed to parse file: ' + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }
}

function parseWizCSV(csvText) {
    const lines = csvText.split(/\r?\n/).filter(line => line.trim());
    if (lines.length === 0) return;
    
    const parseRow = (line) => {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        return result;
    };
    
    wizState.tableData = {
        headers: parseRow(lines[0]),
        rows: lines.slice(1).map(line => {
            const row = parseRow(line);
            while (row.length < wizState.tableData.headers.length) row.push('');
            return row.slice(0, wizState.tableData.headers.length);
        })
    };
    
    if (wizState.tableData.rows.length === 0) {
        wizState.tableData.rows = [new Array(wizState.tableData.headers.length).fill('')];
    }
    
    renderWizTableEditor();
}

function addWizTableEntry() {
    const tableName = document.getElementById('wiz-table-name')?.value?.trim();
    if (!tableName) {
        alert('Please enter a table name');
        return;
    }
    if (!wizState.tableData || wizState.tableData.headers.length === 0) {
        alert('Please create a table first');
        return;
    }
    
    wizTableEntries.push({
        name: tableName,
        data: JSON.parse(JSON.stringify(wizState.tableData))
    });
    
    // Reset
    document.getElementById('wiz-table-name').value = '';
    wizState.tableData = { headers: ['Column 1', 'Column 2', 'Column 3'], rows: [['', '', ''], ['', '', '']] };
    renderWizTableEditor();
    renderWizTableList();
}

function renderWizTableList() {
    const list = document.getElementById('wiz-table-list');
    if (!list) return;
    
    list.innerHTML = wizTableEntries.map((e, i) => `
        <div class="flex items-center justify-between bg-gray-800 rounded-lg p-3">
            <div class="flex items-center gap-2 min-w-0">
                <span>ðŸ“Š</span>
                <div class="min-w-0">
                    <p class="text-sm font-medium truncate">${escHtml(e.name)}</p>
                    <p class="text-xs text-gray-500">${e.data.headers.length} cols Ã— ${e.data.rows.length} rows</p>
                </div>
            </div>
            <button onclick="removeWizTableEntry(${i})" class="text-red-400 hover:text-red-300 p-1">ðŸ—‘ï¸</button>
        </div>
    `).join('');
}

function removeWizTableEntry(idx) {
    wizTableEntries.splice(idx, 1);
    renderWizTableList();
}

// Config helpers
function toggleKBEmb() {
    const useGlobal = document.getElementById('kb-emb-global').checked;
    document.getElementById('kb-emb-fields').classList.toggle('hidden', useGlobal);
}

function onKBEmbChange() {
    const provider = document.getElementById('kb-emb-provider').value;
    // Update model options based on provider
}

function onDBTypeChange() {
    const type = document.getElementById('db-type').value;
    const ports = {
        postgresql: 5432, mysql: 3306, mssql: 1433, sqlite: '', 
        oracle: 1521, oracle_autonomous: 1522, db2: 50000, sybase: 5000, 
        teradata: 1025, azure_sql: 1433, cockroachdb: 26257, tidb: 4000,
        snowflake: 443, redshift: 5439, bigquery: 443,
        mongodb: 27017, mongodb_atlas: 27017, dynamodb: 443, cosmosdb: 443,
        firestore: 443, couchdb: 5984, cassandra: 9042, scylladb: 9042, hbase: 9090,
        redis: 6379, memcached: 11211, elasticache: 6379,
        elasticsearch: 9200, opensearch: 9200, solr: 8983, meilisearch: 7700,
        pinecone: 443, weaviate: 8080, qdrant: 6333, milvus: 19530, chroma: 8000,
        influxdb: 8086, timescaledb: 5432, questdb: 9000,
        neo4j: 7687, neptune: 8182, arangodb: 8529
    };
    document.getElementById('db-port').value = ports[type] || 5432;
    
    // Show/hide specific field sections
    const isOracle = type === 'oracle';
    const isOracleADB = type === 'oracle_autonomous';
    const isCloudDW = ['snowflake', 'bigquery', 'redshift'].includes(type);
    const isNoSQL = ['mongodb', 'mongodb_atlas', 'couchdb', 'dynamodb', 'cosmosdb', 'firestore'].includes(type);
    const isVector = ['pinecone', 'weaviate', 'qdrant', 'milvus', 'chroma'].includes(type);
    
    document.getElementById('db-standard-fields')?.classList.toggle('hidden', isOracleADB || isCloudDW || isVector);
    document.getElementById('db-oracle-fields')?.classList.toggle('hidden', !isOracle);
    document.getElementById('db-oracle-adb-fields')?.classList.toggle('hidden', !isOracleADB);
    document.getElementById('db-cloud-fields')?.classList.toggle('hidden', !isCloudDW);
    document.getElementById('db-nosql-fields')?.classList.toggle('hidden', !isNoSQL);
    document.getElementById('db-vector-fields')?.classList.toggle('hidden', !isVector);
    document.getElementById('db-snowflake-extra')?.classList.toggle('hidden', type !== 'snowflake');
}

function onOracleConnTypeChange() {
    const type = document.getElementById('oracle-conn-type')?.value;
    document.getElementById('oracle-service-field')?.classList.toggle('hidden', type !== 'basic');
    document.getElementById('oracle-tns-field')?.classList.toggle('hidden', type !== 'tns');
    document.getElementById('oracle-wallet-fields')?.classList.toggle('hidden', type !== 'wallet');
}

function onApiAuthChange() {
    const auth = document.getElementById('api-auth').value;
    document.getElementById('api-auth-val-group').classList.toggle('hidden', auth === 'none');
}

// ============================================================================
// EMAIL CONFIGURATION (Simple & User-Friendly)
// ============================================================================
// EMAIL INTEGRATION - Simple OAuth Flow for End Users
// ============================================================================

// Connect email provider via OAuth
async function connectEmailProvider(provider) {
    const btnId = provider === 'google' ? 'gmail-connect-btn' : 'outlook-connect-btn';
    const btn = document.getElementById(btnId);
    if (!btn) return;
    
    const originalText = btn.innerHTML;
    
    // Show loading
    btn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div> Connecting...';
    btn.disabled = true;
    
    try {
        // Request OAuth URL from backend
        const endpoint = provider === 'google' ? '/api/oauth/google/email/url' : '/api/oauth/microsoft/email/url';
        const res = await fetch(endpoint);
        
        if (!res.ok) {
            // OAuth not configured - show admin message
            showOAuthNotConfigured(provider);
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }
        
        const data = await res.json();
        console.log("Login response:", data);
        
        // Open OAuth popup
        const popup = window.open(
            data.url, 
            `${provider} Login`, 
            'width=500,height=600,menubar=no,toolbar=no,location=no,status=no'
        );
        
        // Listen for OAuth completion
        const handleMessage = (event) => {
            if (event.data.type === `${provider}-oauth-success`) {
                window.removeEventListener('message', handleMessage);
                // Pass tokens along with email
                onEmailConnected(provider, event.data.email, {
                    access_token: event.data.access_token,
                    refresh_token: event.data.refresh_token
                });
                btn.innerHTML = originalText;
                btn.disabled = false;
            } else if (event.data.type === `${provider}-oauth-error`) {
                window.removeEventListener('message', handleMessage);
                showToast('Connection failed. Please try again.', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
        
        window.addEventListener('message', handleMessage);
        
        // Timeout after 2 minutes
        setTimeout(() => {
            window.removeEventListener('message', handleMessage);
            if (btn.disabled) {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }, 120000);
        
    } catch (err) {
        console.error('OAuth error:', err);
        showOAuthNotConfigured(provider);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Handle successful email connection
function onEmailConnected(provider, email, tokens = {}) {
    const cardId = provider === 'google' ? 'gmail' : 'outlook';
    const card = document.getElementById(`${cardId}-connect-card`);
    const btn = document.getElementById(`${cardId}-connect-btn`);
    const connected = document.getElementById(`${cardId}-connected`);
    const emailEl = document.getElementById(`${cardId}-connected-email`);
    
    if (!card || !btn || !connected || !emailEl) return;
    
    // Update UI
    card.classList.add('border-green-500');
    btn.classList.add('hidden');
    connected.classList.remove('hidden');
    emailEl.textContent = email;
    
    // Store config with tokens
    const emailConfig = { 
        provider, 
        email,
        access_token: tokens.access_token || '',
        refresh_token: tokens.refresh_token || ''
    };
    
    const providerEl = document.getElementById('email-provider');
    const configEl = document.getElementById('email-config-data');
    if (providerEl) providerEl.value = provider;
    if (configEl) configEl.value = JSON.stringify(emailConfig);
    
    // Update wizard state with tokens
    if (typeof wizState !== 'undefined' && wizState.data) {
        wizState.data.config = wizState.data.config || {};
        wizState.data.config = emailConfig;
    }
    
    console.log('Email connected:', { provider, email, hasTokens: !!tokens.access_token });
    showToast(`Connected to ${email}`, 'success');
}

// Disconnect email provider
function disconnectEmailProvider(provider) {
    const cardId = provider === 'google' ? 'gmail' : 'outlook';
    const card = document.getElementById(`${cardId}-connect-card`);
    const btn = document.getElementById(`${cardId}-connect-btn`);
    const connected = document.getElementById(`${cardId}-connected`);
    
    if (!card || !btn || !connected) return;
    
    // Reset UI
    card.classList.remove('border-green-500');
    btn.classList.remove('hidden');
    connected.classList.add('hidden');
    
    // Clear config
    const providerEl = document.getElementById('email-provider');
    const configEl = document.getElementById('email-config-data');
    if (providerEl) providerEl.value = '';
    if (configEl) configEl.value = '';
    
    showToast('Email disconnected', 'info');
}

// Show message when OAuth is not configured (for platform admin)
function showOAuthNotConfigured(provider) {
    const providerName = provider === 'google' ? 'Google' : 'Microsoft';
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4';
    modal.id = 'oauth-config-modal';
    modal.innerHTML = `
        <div class="modal-content-box rounded-2xl w-full max-w-md overflow-hidden">
            <div class="p-6 text-center">
                <div class="w-16 h-16 rounded-full bg-yellow-500/20 flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">âš™ï¸</span>
                </div>
                <h3 class="text-xl font-bold mb-2" style="color:var(--text-primary);">Setup Required</h3>
                <p class="mb-6" style="color:var(--text-secondary);">
                    ${providerName} integration needs to be configured by the administrator.
                </p>
                <p class="text-sm mb-6" style="color:var(--text-muted);">
                    Go to <strong>Settings â†’ Integrations</strong> to set up ${providerName} OAuth credentials.
                </p>
                <button onclick="document.getElementById('oauth-config-modal').remove()" 
                        class="btn-primary px-8 py-3 rounded-lg">
                    Got it
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Toggle SendGrid setup panel
function toggleSendGridSetup() {
    const setup = document.getElementById('sendgrid-setup');
    const btn = document.getElementById('sendgrid-setup-btn');
    if (!setup || !btn) return;
    
    const isHidden = setup.classList.contains('hidden');
    setup.classList.toggle('hidden');
    btn.textContent = isHidden ? 'Cancel' : 'Setup';
}

// Save SendGrid configuration
function saveSendGridConfig() {
    const apiKey = document.getElementById('sendgrid-api-key')?.value;
    const fromEmail = document.getElementById('sendgrid-from-email')?.value;
    
    if (!apiKey || !fromEmail) {
        showToast('Please fill all fields', 'error');
        return;
    }
    
    // Update UI
    const card = document.getElementById('sendgrid-connect-card');
    if (card) card.classList.add('border-green-500');
    
    // Store config
    const providerEl = document.getElementById('email-provider');
    const configEl = document.getElementById('email-config-data');
    if (providerEl) providerEl.value = 'sendgrid';
    if (configEl) configEl.value = JSON.stringify({ provider: 'sendgrid', apiKey, fromEmail });
    
    // Hide setup and show connected state
    const setup = document.getElementById('sendgrid-setup');
    const btn = document.getElementById('sendgrid-setup-btn');
    if (setup) setup.classList.add('hidden');
    if (btn) {
        btn.textContent = 'Connected âœ“';
        btn.disabled = true;
        btn.classList.remove('btn-secondary');
        btn.classList.add('bg-green-500/20', 'text-green-400', 'cursor-default');
    }
    
    // Update wizard state
    if (typeof wizState !== 'undefined' && wizState.data) {
        wizState.data.config = wizState.data.config || {};
        wizState.data.config.email = { provider: 'sendgrid', apiKey, fromEmail };
    }
    
    showToast('SendGrid configured successfully', 'success');
}

// Get email configuration (for saving tool)
function getEmailConfig() {
    const configData = document.getElementById('email-config-data')?.value;
    if (configData) {
        try {
            return JSON.parse(configData);
        } catch (e) {}
    }
    return null;
}

// Legacy functions for compatibility
function toggleEmailProvider(provider) {}
function onEmailProviderSelect() {}
function onEmailProvChange() {}

function onSheetProvChange() {
    const p = document.getElementById('sheet-provider').value;
    document.getElementById('sheet-google-fields').classList.toggle('hidden', p !== 'google');
    document.getElementById('sheet-airtable-fields').classList.toggle('hidden', p !== 'airtable');
}

function onStorageTypeChange() {
    const type = document.getElementById('storage-type')?.value;
    document.getElementById('storage-cloud-section')?.classList.toggle('hidden', type !== 'cloud');
    document.getElementById('storage-local-section')?.classList.toggle('hidden', type !== 'local');
}

function onStorageProvChange() {
    const p = document.getElementById('storage-provider')?.value;
    const isOCI = p?.startsWith('oci_');
    const isAzure = p?.startsWith('azure_');
    const isGCS = p?.startsWith('gcs');
    const needsEndpoint = ['minio', 'digitalocean_spaces', 'backblaze_b2', 'wasabi', 'cloudflare_r2', 'linode_obj', 'vultr_obj'].includes(p);
    
    document.getElementById('storage-s3-fields')?.classList.toggle('hidden', isOCI || isAzure || isGCS);
    document.getElementById('storage-oci-fields')?.classList.toggle('hidden', !isOCI);
    document.getElementById('storage-azure-fields')?.classList.toggle('hidden', !isAzure);
    document.getElementById('storage-gcs-fields')?.classList.toggle('hidden', !isGCS);
    document.getElementById('storage-endpoint-field')?.classList.toggle('hidden', !needsEndpoint);
}

function onLocalStorageTypeChange() {
    const type = document.getElementById('local-storage-type')?.value;
    const isLocal = type === 'local';
    document.getElementById('local-path-field')?.classList.toggle('hidden', !isLocal);
    document.getElementById('network-storage-fields')?.classList.toggle('hidden', isLocal);
    document.getElementById('sftp-key-field')?.classList.toggle('hidden', type !== 'sftp');
    
    // Update port based on protocol
    const ports = { nfs: 2049, smb: 445, sftp: 22, ftp: 21, webdav: 443 };
    const portEl = document.getElementById('net-port');
    if (portEl && ports[type]) portEl.value = ports[type];
}

function onAzureAuthChange() {
    const type = document.getElementById('azure-auth-type')?.value;
    const isConnString = type === 'connection_string' || type === 'account_key' || type === 'sas_token';
    document.getElementById('azure-conn-string-field')?.classList.toggle('hidden', !isConnString);
    document.getElementById('azure-sp-fields')?.classList.toggle('hidden', type !== 'service_principal');
}

function onCRMChange() {
    const p = document.getElementById('crm-platform').value;
    document.getElementById('crm-salesforce-fields')?.classList.toggle('hidden', p !== 'salesforce');
    document.getElementById('crm-hubspot-fields')?.classList.toggle('hidden', p !== 'hubspot');
}

function onMsgPlatformChange() {
    const p = document.getElementById('msg-platform').value;
    
    // Hide all platform-specific fields first
    const platforms = ['slack', 'teams', 'whatsapp', 'facebook', 'telegram', 'twilio', 'discord', 'firebase', 'generic'];
    platforms.forEach(plat => {
        document.getElementById(`msg-${plat}-fields`)?.classList.add('hidden');
    });
    
    // Show relevant fields
    if (p === 'slack') document.getElementById('msg-slack-fields')?.classList.remove('hidden');
    else if (p === 'teams') document.getElementById('msg-teams-fields')?.classList.remove('hidden');
    else if (p === 'whatsapp') document.getElementById('msg-whatsapp-fields')?.classList.remove('hidden');
    else if (p === 'facebook' || p === 'instagram') document.getElementById('msg-facebook-fields')?.classList.remove('hidden');
    else if (p === 'telegram') document.getElementById('msg-telegram-fields')?.classList.remove('hidden');
    else if (p === 'twilio' || p === 'vonage' || p === 'plivo' || p === 'messagebird' || p === 'sinch') document.getElementById('msg-twilio-fields')?.classList.remove('hidden');
    else if (p === 'discord') document.getElementById('msg-discord-fields')?.classList.remove('hidden');
    else if (p === 'firebase_fcm' || p === 'onesignal' || p === 'pusher') document.getElementById('msg-firebase-fields')?.classList.remove('hidden');
    else document.getElementById('msg-generic-fields')?.classList.remove('hidden');
}

function onTeamsTypeChange() {
    const type = document.getElementById('teams-type')?.value;
    document.getElementById('teams-webhook-field')?.classList.toggle('hidden', type !== 'webhook');
    document.getElementById('teams-bot-fields')?.classList.toggle('hidden', type !== 'bot' && type !== 'graph');
}

function onWhatsAppProviderChange() {
    const p = document.getElementById('whatsapp-provider')?.value;
    document.getElementById('whatsapp-meta-fields')?.classList.toggle('hidden', p !== 'meta');
}

function onSTTProviderChange() {
    const p = document.getElementById('stt-provider')?.value;
    const isOCI = p === 'oci_speech';
    const isAzure = p === 'azure';
    const isLocal = ['whisper_local', 'vosk', 'deepspeech', 'kaldi', 'coqui'].includes(p);
    
    document.getElementById('stt-cloud-fields')?.classList.toggle('hidden', isOCI || isAzure || isLocal);
    document.getElementById('stt-oci-fields')?.classList.toggle('hidden', !isOCI);
    document.getElementById('stt-azure-fields')?.classList.toggle('hidden', !isAzure);
    document.getElementById('stt-local-fields')?.classList.toggle('hidden', !isLocal);
}

function onTTSProviderChange() {
    const p = document.getElementById('tts-provider')?.value;
    const isOCI = p === 'oci_speech';
    const isLocal = ['coqui_tts', 'piper', 'espeak', 'festival', 'mimic'].includes(p);
    
    document.getElementById('tts-cloud-fields')?.classList.toggle('hidden', isOCI || isLocal);
    document.getElementById('tts-oci-fields')?.classList.toggle('hidden', !isOCI);
    document.getElementById('tts-local-fields')?.classList.toggle('hidden', !isLocal);
}

function onOCRProviderChange() {
    const p = document.getElementById('ocr-provider')?.value;
    const isOCI = p === 'oci_vision' || p === 'oci_doc';
    const isLocal = ['tesseract', 'paddleocr', 'easyocr', 'doctr', 'surya'].includes(p);
    
    document.getElementById('ocr-cloud-fields')?.classList.toggle('hidden', isOCI || isLocal);
    document.getElementById('ocr-oci-fields')?.classList.toggle('hidden', !isOCI);
    document.getElementById('ocr-local-fields')?.classList.toggle('hidden', !isLocal);
}

// Code Execution Functions
function onCodeModeChange() {
    const mode = document.getElementById('code-mode')?.value;
    document.getElementById('code-gen-section')?.classList.toggle('hidden', mode === 'execute');
    document.getElementById('code-manual-section')?.classList.toggle('hidden', mode === 'generate');
    document.getElementById('code-manual-input')?.classList.toggle('hidden', mode === 'generate');
}

async function generateToolCode() {
    const description = document.getElementById('code-description')?.value;
    const inputs = document.getElementById('code-inputs')?.value;
    const outputFormat = document.getElementById('code-output-format')?.value;
    const lang = document.getElementById('code-lang')?.value || 'python';
    
    if (!description) {
        alert('Please provide a tool description');
        return;
    }
    
    try {
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="animate-spin">â³</span> Generating...';
        
        const response = await fetch(API + '/api/tools/generate-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ description, inputs, output_format: outputFormat, language: lang })
        });
        
        const data = await response.json();
        
        if (data.code) {
            document.getElementById('code-generated').value = data.code;
            document.getElementById('generated-code-preview').classList.remove('hidden');
        } else {
            alert('Failed to generate code: ' + (data.error || 'Unknown error'));
        }
        
        btn.disabled = false;
        btn.innerHTML = '<span>âœ¨</span> Generate Code';
    } catch (e) {
        console.error('Code generation error:', e);
        alert('Error generating code: ' + e.message);
    }
}

// Human in the Loop Functions
function onHITLTypeChange() {
    const type = document.getElementById('hitl-type')?.value;
    
    document.getElementById('hitl-approval-fields')?.classList.toggle('hidden', type !== 'approval');
    document.getElementById('hitl-selection-fields')?.classList.toggle('hidden', type !== 'selection');
    document.getElementById('hitl-form-fields')?.classList.toggle('hidden', type !== 'form');
}

function addHITLFormField() {
    const template = document.getElementById('hitl-field-template');
    const builder = document.getElementById('hitl-form-builder');
    if (!template || !builder) return;
    
    const clone = template.content.cloneNode(true);
    builder.appendChild(clone);
}

function removeHITLFormField(btn) {
    btn.closest('.hitl-field-item')?.remove();
}

function onHITLFieldTypeChange(select) {
    const type = select.value;
    const container = select.closest('.hitl-field-item');
    const optionsField = container?.querySelector('.hitl-field-options');
    
    if (optionsField) {
        optionsField.classList.toggle('hidden', !['select', 'radio', 'checkbox'].includes(type));
    }
}

function toggleHITLDeployment() {
    const checked = document.getElementById('hitl-deploy-form')?.checked;
    document.getElementById('hitl-deployment-fields')?.classList.toggle('hidden', !checked);
}

// TTS speed/pitch display
function updateTTSDisplay() {
    const speed = document.getElementById('tts-speed')?.value || 1;
    const pitch = document.getElementById('tts-pitch')?.value || 1;
    document.getElementById('tts-speed-val').textContent = speed + 'x';
    document.getElementById('tts-pitch-val').textContent = pitch + 'x';
}

// ============================================================================
// AUTHENTICATION & SECURITY FUNCTIONS
// ============================================================================

// Auth state
let authToken = localStorage.getItem('agentforge_token') || null;
let currentUser = JSON.parse(localStorage.getItem('agentforge_user') || 'null');
let securityUsers = [];
let securityRoles = [];
// ============================================================================
// PERMISSION SYSTEM
// ============================================================================

function hasPermission(permission) {
    const hasPerm = !currentUser || !currentUser.permissions 
        ? false 
        : currentUser.permissions.includes('system:admin') 
            ? true 
            : currentUser.permissions.includes(permission);
    return hasPerm;
}

function hasAnyPermission(permissions) {
    return permissions.some(p => hasPermission(p));
}

function hasAllPermissions(permissions) {
    return permissions.every(p => hasPermission(p));
}

const MENU_PERMISSIONS = {
    "chat": "chat:use",
    "agents": "agents:view",
    "tools": "tools:view",
    "create": "agents:create",
    "demo": "demo:access",
    "settings": "system:settings",
    "security": "users:view",
};

function updateUIByPermissions() {
    if (!currentUser) return;
    
    Object.entries(MENU_PERMISSIONS).forEach(([menu, permission]) => {
        const navItem = document.getElementById('nav-' + menu);
        const mobItem = document.getElementById('mob-' + menu);
        const hasPerm = hasPermission(permission);
        
        if (hasPerm) {
            if (navItem) { navItem.classList.remove('hidden'); navItem.style.display = ''; }
            if (mobItem) { mobItem.classList.remove('hidden'); mobItem.style.display = ''; }
        } else {
            if (navItem) { navItem.classList.add('hidden'); navItem.style.display = 'none'; }
            if (mobItem) { mobItem.classList.add('hidden'); mobItem.style.display = 'none'; }
        }
    });
    
    const secNav = document.getElementById('nav-security');
    if (secNav) {
        const hasSecPerm = hasAnyPermission(['users:view', 'roles:view', 'system:admin']);
        if (hasSecPerm) { secNav.classList.remove('hidden'); secNav.style.display = ''; }
        else { secNav.classList.add('hidden'); secNav.style.display = 'none'; }
    }
    
    document.querySelectorAll('[data-permission]').forEach(el => {
        const perms = el.dataset.permission.split(',').map(p => p.trim());
        const hasPerm = hasAnyPermission(perms);
        el.style.display = hasPerm ? '' : 'none';
    });
}



// Check authentication on page load
function checkAuth() {
    // Check for OAuth token in URL hash
    const hash = window.location.hash;
    if (hash && hash.includes('token=')) {
        const params = new URLSearchParams(hash.split('?')[1]);
        const oauthToken = params.get('token');
        if (oauthToken) {
            authToken = oauthToken;
            localStorage.setItem('agentforge_token', authToken);
            window.history.replaceState(null, '', '/ui/');
        }
    }
    
    if (!authToken) {
        showLoginPage();
        return false;
    }
    
    // We have a token - show app immediately while we verify
    // This prevents the login flash
    if (currentUser && currentUser.id) {
        showApp();
        updateUserDisplay();
        updateUIByPermissions();
    }
    
    // Verify token is still valid in background
    fetch('/api/security/auth/me', {
        headers: { 'Authorization': 'Bearer ' + authToken }
    }).then(res => {
        if (!res.ok) {
            clearAuth();
            showLoginPage();
            return null;
        }
        return res.json();
    }).then(data => {
        if (data && data.id) {
            currentUser = data;
            localStorage.setItem('agentforge_user', JSON.stringify(currentUser));
            if (data.must_change_password) {
                showFirstLoginPasswordModal();
                return;
            }
            showApp();
            updateUserDisplay();
            updateUIByPermissions();
            
            // Navigate to hash if present
            const pageHash = window.location.hash.slice(1);
            if (pageHash && !pageHash.includes('token') && document.getElementById('page-' + pageHash)) {
                navigate(pageHash, false);
            }
        }
    }).catch((err) => {
        console.error('Auth check failed:', err);
        clearAuth();
        showLoginPage();
    });
    
    return true;
}

// Show login page
function showLoginPage() {
    document.getElementById('loading-screen')?.classList.add('hidden');
    document.getElementById('page-login').classList.add('visible');
    document.getElementById('app').classList.add('hidden');
}

// Show main app
function showApp() {
    document.getElementById('loading-screen')?.classList.add('hidden');
    document.getElementById('page-login').classList.remove('visible');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('app').classList.add('flex');
    // Initialize app data after showing
    if (typeof initAppData === 'function') {
        initAppData();
    }
}

// Handle login
// Check password strength
function checkPasswordStrength(password) {
    let strength = 0;
    const str1 = document.getElementById('str-1');
    const str2 = document.getElementById('str-2');
    const str3 = document.getElementById('str-3');
    const str4 = document.getElementById('str-4');
    const strText = document.getElementById('str-text');
    
    if (!str1) return; // Elements not found
    
    // Reset
    [str1, str2, str3, str4].forEach(el => el.className = 'h-1 flex-1 rounded bg-gray-600');
    
    if (password.length >= 8) strength++;
    if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
    if (password.match(/[0-9]/)) strength++;
    if (password.match(/[^a-zA-Z0-9]/)) strength++;
    
    const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500'];
    const texts = ['Weak', 'Fair', 'Good', 'Strong'];
    
    if (strength >= 1) str1.className = 'h-1 flex-1 rounded ' + colors[strength-1];
    if (strength >= 2) str2.className = 'h-1 flex-1 rounded ' + colors[strength-1];
    if (strength >= 3) str3.className = 'h-1 flex-1 rounded ' + colors[strength-1];
    if (strength >= 4) str4.className = 'h-1 flex-1 rounded ' + colors[strength-1];
    
    strText.textContent = strength > 0 ? texts[strength-1] : '';
    strText.className = 'text-xs ' + (strength > 0 ? colors[strength-1].replace('bg-', 'text-') : 'text-gray-500');
}

// OAuth login
async function oauthLogin(provider) {
    try {
        showToast('Redirecting to ' + provider + '...', 'info');
        const res = await fetch('/api/security/oauth/' + provider + '/login');
        const data = await res.json();
        console.log("Login response:", data);
        
        if (data.auth_url) {
            window.location.href = data.auth_url;
        } else {
            showToast(data.detail || 'OAuth not configured', 'error');
        }
    } catch (e) {
        showToast('OAuth error: ' + e.message, 'error');
    }
}

// Toggle password visibility
function togglePassword(inputId, btn) {
    const input = document.getElementById(inputId);
    const icon = btn.querySelector('.eye-icon');
    if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88"/></svg>';
    } else {
        input.type = 'password';
        icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>';
    }
}

async function handleLogin(event) {
    event.preventDefault();
    
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const remember = document.getElementById('login-remember')?.checked || false;
    const mfaCode = document.getElementById('login-mfa-code')?.value || '';
    
    const btn = document.getElementById('login-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin inline-block">â³</span> Signing in...';
    
    try {
        console.log("ðŸš€ [FRONTEND] Starting login request...");
        const res = await fetch('/api/security/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, remember_me: remember, mfa_code: mfaCode || undefined })
        });
        
        console.log("ðŸ“¡ [FRONTEND] Login response received, status:", res.status, res.statusText);
        
        const data = await res.json();
        console.log("ðŸ“¦ [FRONTEND] Login response data:", JSON.stringify(data, null, 2));
        console.log("   requires_mfa:", data.requires_mfa, "(type:", typeof data.requires_mfa, ")");
        console.log("   mfa_required:", data.mfa_required, "(type:", typeof data.mfa_required, ")");
        console.log("   mfa_methods:", data.mfa_methods);
        console.log("   access_token:", data.access_token ? "present" : "missing");
        
        if (!res.ok) {
            console.error("âŒ [FRONTEND] Login failed:", data);
            showToast(typeof data.detail === 'object' ? JSON.stringify(data.detail) : (data.detail || 'Login failed'), 'error');
            btn.disabled = false;
            btn.textContent = 'Sign In';
            return;
        }
        
        // Check if MFA is required (check both requires_mfa and mfa_required for backward compatibility)
        console.log("ðŸ” [FRONTEND] Checking MFA requirement...");
        console.log("   requires_mfa === true:", data.requires_mfa === true);
        console.log("   requires_mfa === 'true':", data.requires_mfa === "true");
        console.log("   mfa_required === true:", data.mfa_required === true);
        console.log("   mfa_required === 'true':", data.mfa_required === "true");
        
        const isMfaRequired = data.requires_mfa === true || 
                             data.mfa_required === true || 
                             data.requires_mfa === "true" || 
                             data.mfa_required === "true" ||
                             String(data.requires_mfa).toLowerCase() === "true" ||
                             String(data.mfa_required).toLowerCase() === "true";
        
        console.log("   isMfaRequired:", isMfaRequired);
        
        if (isMfaRequired) {
            console.log("âœ… [FRONTEND] MFA is required, showing modal...");
            btn.disabled = false;
            btn.textContent = 'Sign In';
            
            // Store credentials temporarily for MFA verification
            window.pendingLoginEmail = email;
            window.pendingLoginPassword = password;
            window.pendingLoginRemember = remember;
            window.pendingMfaMethods = data.mfa_methods || data.mfa_methods || [];
            
            console.log("ðŸ“‹ [FRONTEND] Stored pending login data:");
            console.log("   Email:", window.pendingLoginEmail);
            console.log("   MFA Methods:", window.pendingMfaMethods);
            console.log("ðŸ“± [FRONTEND] Calling showLoginMfaModal...");
            try {
                showLoginMfaModal(window.pendingMfaMethods);
                console.log("âœ… [FRONTEND] showLoginMfaModal called successfully");
                
                // Verify modal was created after a short delay
                setTimeout(() => {
                    console.log("ðŸ” [FRONTEND] Verifying modal after 200ms...");
                    const modalCheck = document.getElementById('login-mfa-modal');
                    if (modalCheck) {
                        console.log("âœ… [FRONTEND] âœ…âœ…âœ… MODAL VERIFICATION: SUCCESS âœ…âœ…âœ…");
                        console.log("   Modal is in DOM");
                        console.log("   Modal is visible:", modalCheck.offsetParent !== null);
                        const inputCheck = document.getElementById('login-mfa-code');
                        if (inputCheck) {
                            console.log("   Input field is present");
                        } else {
                            console.error("   âŒ Input field is missing!");
                        }
                    } else {
                        console.error("âŒ [FRONTEND] âŒâŒâŒ MODAL VERIFICATION: FAILED âŒâŒâŒ");
                        console.error("   Modal is NOT in DOM after 200ms!");
                        console.error("   This indicates a serious problem with modal creation!");
                    }
                }, 200);
            } catch (error) {
                console.error("âŒ [FRONTEND] âŒâŒâŒ ERROR CALLING showLoginMfaModal âŒâŒâŒ");
                console.error("   Error:", error);
                console.error("   Error message:", error.message);
                console.error("   Error stack:", error.stack);
                showToast("Error showing MFA modal: " + error.message, 'error');
            }
            return;
        } else {
            console.log("âœ… [FRONTEND] MFA not required, continuing with normal login...");
            console.log("   Full response keys:", Object.keys(data));
        }
        
        // Store auth data
        authToken = data.access_token;
        currentUser = data.user;
        
        if (remember) {
            localStorage.setItem('agentforge_token', authToken);
            localStorage.setItem('agentforge_user', JSON.stringify(currentUser));
        } else {
            sessionStorage.setItem('agentforge_token', authToken);
            sessionStorage.setItem('agentforge_user', JSON.stringify(currentUser));
        }
        
        if (data.must_change_password) { btn.disabled = false; btn.textContent = 'Sign In'; showFirstLoginPasswordModal(); return; }
        showApp();
        updateUserDisplay();
        updateUIByPermissions();
        navigate('agents');
        showToast('Welcome back, ' + (currentUser.name || currentUser.email) + '!', 'success');
        
    } catch (e) {
        showToast('Connection error: ' + e.message, 'error');
    }
    
    btn.disabled = false;
    btn.textContent = 'Sign In';
}

function showLoginMfaModal(methods) {
    console.log("ðŸŽ­ [FRONTEND] ========================================");
    console.log("ðŸŽ­ [FRONTEND] showLoginMfaModal called");
    console.log("ðŸŽ­ [FRONTEND] Methods:", methods);
    console.log("ðŸŽ­ [FRONTEND] ========================================");
    
    // Remove existing modal if present
    const existingModal = document.getElementById('login-mfa-modal');
    if (existingModal) {
        console.log("ðŸ—‘ï¸  [FRONTEND] Removing existing MFA modal");
        existingModal.remove();
    } else {
        console.log("âœ… [FRONTEND] No existing modal found (good)");
    }
    
    console.log("ðŸ“ [FRONTEND] Creating modal element...");
    const modal = document.createElement('div');
    modal.id = 'login-mfa-modal';
    modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999]';
    console.log("âœ… [FRONTEND] Modal element created, ID:", modal.id);
    console.log("âœ… [FRONTEND] Modal classes:", modal.className);
    
    // Get email to display (mask for privacy)
    const email = window.pendingMfaEmail || window.pendingLoginEmail || 'your email';
    const maskEmail = (email) => {
        if (!email || email === 'your email') return email;
        const [local, domain] = email.split('@');
        if (local.length <= 2) return email;
        const visible = local.substring(0, 2);
        const masked = '*'.repeat(Math.min(local.length - 2, 4));
        return `${visible}${masked}@${domain}`;
    };
    const displayEmail = maskEmail(email);
    
    console.log("ðŸ“ [FRONTEND] Setting modal innerHTML...");
    modal.innerHTML = `
        <div class="card rounded-2xl p-6 w-full max-w-md mx-4">
            <div class="text-center mb-6">
                <div class="text-5xl mb-3">ðŸ”</div>
                <h3 class="text-xl font-bold mb-2">Two-Factor Authentication</h3>
                <p class="text-gray-400 text-sm">Enter the 6-digit code sent to</p>
                <p class="text-purple-400 font-semibold text-sm mt-1" id="mfa-email-display" title="${email}">${displayEmail}</p>
            </div>
            
            <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 mb-6">
                <div class="flex items-center gap-3">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                        <span class="text-xl">âœ“</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-green-400 font-medium text-sm">Code sent successfully!</p>
                        <p class="text-xs text-gray-400 mt-0.5">Please check your email inbox</p>
                    </div>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Verification Code</label>
                <input 
                    type="text" 
                    id="login-mfa-code" 
                    class="input-field w-full px-4 py-4 rounded-lg text-center text-3xl tracking-[0.5em] font-mono font-semibold focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all" 
                    placeholder="000000" 
                    maxlength="6" 
                    pattern="[0-9]{6}"
                    inputmode="numeric"
                    autocomplete="one-time-code"
                    autofocus
                >
                <p class="text-xs text-gray-500 mt-2 text-center">Enter the 6-digit code from your email</p>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="closeLoginMfaModal()" class="btn-secondary flex-1 py-3 rounded-lg font-medium transition-all hover:bg-gray-700">Cancel</button>
                <button onclick="verifyLoginMfa()" id="verify-mfa-btn" class="btn-primary flex-1 py-3 rounded-lg font-medium transition-all hover:bg-purple-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="verify-btn-text">Verify</span>
                </button>
            </div>
            
            <div class="text-center mt-4 pt-4 border-t border-gray-700">
                <p class="text-xs text-gray-500 mb-2">Didn't receive the code?</p>
                <button onclick="resendLoginMfaCode()" id="resend-mfa-btn" class="text-sm text-gray-400 hover:text-purple-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:text-gray-400 px-4 py-2 rounded-lg hover:bg-gray-800/50" disabled>
                    <span id="resend-text">
                        <span class="inline-flex items-center gap-1">
                            <span>Resend code in</span>
                            <span id="resend-timer" class="font-mono font-semibold text-purple-400 min-w-[3ch]">10:00</span>
                        </span>
                    </span>
                </button>
            </div>
        </div>
    `;
    console.log("ðŸ“ [FRONTEND] Appending modal to document.body...");
    console.log("   Body children before:", document.body.children.length);
    document.body.appendChild(modal);
    console.log("âœ… [FRONTEND] Modal appended to DOM");
    console.log("   Body children after:", document.body.children.length);
    
    // Verify modal is in DOM
    const modalInDom = document.getElementById('login-mfa-modal');
    if (modalInDom) {
        console.log("âœ… [FRONTEND] Modal found in DOM by ID");
        console.log("   Modal element:", modalInDom);
        console.log("   Modal parent:", modalInDom.parentElement);
        console.log("   Modal offsetParent:", modalInDom.offsetParent);
        console.log("   Modal display:", window.getComputedStyle(modalInDom).display);
        console.log("   Modal visibility:", window.getComputedStyle(modalInDom).visibility);
        console.log("   Modal z-index:", window.getComputedStyle(modalInDom).zIndex);
        console.log("   Modal opacity:", window.getComputedStyle(modalInDom).opacity);
        
        if (modalInDom.offsetParent !== null) {
            console.log("âœ… [FRONTEND] âœ…âœ…âœ… MFA MODAL IS VISIBLE! âœ…âœ…âœ…");
        } else {
            console.error("âŒ [FRONTEND] âŒâŒâŒ MFA MODAL IS NOT VISIBLE! âŒâŒâŒ");
            console.error("   Possible reasons:");
            console.error("   1. Modal has display: none");
            console.error("   2. Modal has visibility: hidden");
            console.error("   3. Modal has opacity: 0");
            console.error("   4. Modal is positioned outside viewport");
            console.error("   5. Parent element is hidden");
        }
    } else {
        console.error("âŒ [FRONTEND] âŒâŒâŒ MODAL NOT FOUND IN DOM! âŒâŒâŒ");
        console.error("   This means the modal was not added successfully!");
    }
    
    // Start resend timer (10 minutes = 600 seconds)
    let resendTimer = 600; // 10 minutes in seconds
    const resendBtn = document.getElementById('resend-mfa-btn');
    const resendTimerSpan = document.getElementById('resend-timer');
    
    function updateResendTimer() {
        if (resendTimer > 0) {
            const minutes = Math.floor(resendTimer / 60);
            const seconds = resendTimer % 60;
            resendTimerSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            resendTimer--;
        } else {
            if (resendTimerSpan) {
                resendTimerSpan.textContent = '0:00';
            }
            if (resendBtn) {
                resendBtn.disabled = false;
                resendBtn.innerHTML = '<span id="resend-text"><span class="inline-flex items-center gap-1"><span>Resend code</span><span class="text-purple-400">â†’</span></span></span>';
            }
            clearInterval(window.mfaResendInterval);
        }
    }
    
    // Start timer
    if (window.mfaResendInterval) {
        clearInterval(window.mfaResendInterval);
    }
    window.mfaResendInterval = setInterval(updateResendTimer, 1000);
    updateResendTimer(); // Initial update
    
    // Focus on input and add auto-submit
    setTimeout(() => {
        console.log("ðŸ“ [FRONTEND] Attempting to focus on MFA code input...");
        const input = document.getElementById('login-mfa-code');
        if (input) {
            console.log("âœ… [FRONTEND] MFA code input found");
            input.focus();
            console.log("âœ… [FRONTEND] Focused on MFA code input");
            
            // Auto-submit when 6 digits are entered
            input.addEventListener('input', function(e) {
                const value = e.target.value.replace(/\D/g, ''); // Only numbers
                e.target.value = value;
                
                // Auto-submit when 6 digits entered
                if (value.length === 6) {
                    const verifyBtn = document.getElementById('verify-mfa-btn');
                    if (verifyBtn && !verifyBtn.disabled) {
                        setTimeout(() => verifyLoginMfa(), 100); // Small delay for UX
                    }
                }
            });
            
            // Prevent non-numeric input
            input.addEventListener('keypress', function(e) {
                if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
                    e.preventDefault();
                }
            });
            
            // Paste handler
            input.addEventListener('paste', function(e) {
                e.preventDefault();
                const pasted = (e.clipboardData || window.clipboardData).getData('text');
                const numbers = pasted.replace(/\D/g, '').substring(0, 6);
                e.target.value = numbers;
                if (numbers.length === 6) {
                    setTimeout(() => verifyLoginMfa(), 100);
                }
            });
        } else {
            console.error("âŒ [FRONTEND] âŒâŒâŒ MFA CODE INPUT NOT FOUND! âŒâŒâŒ");
        }
    }, 100);
    
    console.log("ðŸŽ­ [FRONTEND] ========================================");
    console.log("ðŸŽ­ [FRONTEND] showLoginMfaModal completed");
    console.log("ðŸŽ­ [FRONTEND] ========================================");
}

function closeLoginMfaModal() {
    // Clear timer
    if (window.mfaResendInterval) {
        clearInterval(window.mfaResendInterval);
        window.mfaResendInterval = null;
    }
    document.getElementById('login-mfa-modal')?.remove();
    window.pendingLoginEmail = null;
    window.pendingLoginPassword = null;
    window.pendingLoginRemember = null;
    window.pendingMfaSessionId = null;
    window.pendingMfaEmail = null;
    window.pendingMfaProvider = null;
}

async function resendLoginMfaCode() {
    const btn = document.getElementById('resend-mfa-btn');
    if (btn.disabled) {
        return; // Timer not expired yet
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span id="resend-text">Sending...</span>';
    
    try {
        // Check if this is OAuth MFA (has session_id) or regular login MFA
        if (window.pendingMfaSessionId && window.pendingMfaEmail) {
            console.log("ðŸ“§ [FRONTEND] Resending OAuth MFA code for session:", window.pendingMfaSessionId);
            // OAuth MFA resend
            const res = await fetch('/api/security/oauth/mfa/resend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: window.pendingMfaSessionId,
                    email: window.pendingMfaEmail
                })
            });
            
            if (res.ok) {
                showToast('âœ… New code sent to your email', 'success');
                
                // Reset timer (10 minutes = 600 seconds)
                let resendTimer = 600;
                const resendTimerSpan = document.getElementById('resend-timer');
                
                function updateResendTimer() {
                    if (resendTimer > 0) {
                        const minutes = Math.floor(resendTimer / 60);
                        const seconds = resendTimer % 60;
                        if (resendTimerSpan) {
                            resendTimerSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        }
                        resendTimer--;
                    } else {
                        if (resendTimerSpan) {
                            resendTimerSpan.textContent = '0:00';
                        }
                        if (btn) {
                            btn.disabled = false;
                            btn.innerHTML = '<span id="resend-text"><span class="inline-flex items-center gap-1"><span>Resend code</span><span class="text-purple-400">â†’</span></span></span>';
                        }
                        clearInterval(window.mfaResendInterval);
                    }
                }
                
                // Clear old timer and start new one
                if (window.mfaResendInterval) {
                    clearInterval(window.mfaResendInterval);
                }
                window.mfaResendInterval = setInterval(updateResendTimer, 1000);
                updateResendTimer(); // Initial update
                
                btn.innerHTML = '<span id="resend-text"><span class="inline-flex items-center gap-1"><span>Resend code in</span><span id="resend-timer" class="font-mono font-semibold text-purple-400 min-w-[3ch]">10:00</span></span></span>';
            } else {
                const data = await res.json();
                console.log("ðŸ“§ [FRONTEND] OAuth MFA resend response:", data);
                showToast(data.detail || 'Failed to send code', 'error');
                btn.disabled = false;
                btn.innerHTML = '<span id="resend-text"><span class="inline-flex items-center gap-1"><span>Resend code</span><span class="text-purple-400">â†’</span></span></span>';
            }
        } else {
            console.log("ðŸ“§ [FRONTEND] Resending regular login MFA code");
            // Regular login MFA resend
            const res = await fetch('/api/security/mfa/send-login-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: window.pendingLoginEmail,
                    password: window.pendingLoginPassword
                })
            });
            
            if (res.ok) {
                showToast('âœ… New code sent to your email', 'success');
                
                // Reset timer (10 minutes = 600 seconds)
                let resendTimer = 600;
                const resendTimerSpan = document.getElementById('resend-timer');
                
                function updateResendTimer() {
                    if (resendTimer > 0) {
                        const minutes = Math.floor(resendTimer / 60);
                        const seconds = resendTimer % 60;
                        if (resendTimerSpan) {
                            resendTimerSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        }
                        resendTimer--;
                    } else {
                        if (resendTimerSpan) {
                            resendTimerSpan.textContent = '0:00';
                        }
                        if (btn) {
                            btn.disabled = false;
                            btn.innerHTML = '<span id="resend-text"><span class="inline-flex items-center gap-1"><span>Resend code</span><span class="text-purple-400">â†’</span></span></span>';
                        }
                        clearInterval(window.mfaResendInterval);
                    }
                }
                
                // Clear old timer and start new one
                if (window.mfaResendInterval) {
                    clearInterval(window.mfaResendInterval);
                }
                window.mfaResendInterval = setInterval(updateResendTimer, 1000);
                updateResendTimer(); // Initial update
                
                btn.innerHTML = '<span id="resend-text"><span class="inline-flex items-center gap-1"><span>Resend code in</span><span id="resend-timer" class="font-mono font-semibold text-purple-400 min-w-[3ch]">10:00</span></span></span>';
            } else {
                const data = await res.json();
                console.log("ðŸ“§ [FRONTEND] Regular login MFA resend response:", data);
                showToast(data.detail || 'Failed to send code', 'error');
                btn.disabled = false;
                btn.innerHTML = '<span id="resend-text"><span class="inline-flex items-center gap-1"><span>Resend code</span><span class="text-purple-400">â†’</span></span></span>';
            }
        }
    } catch (e) {
        console.error("âŒ [FRONTEND] MFA resend error:", e);
        showToast('Error: ' + e.message, 'error');
        btn.disabled = false;
        btn.innerHTML = '<span id="resend-text">Didn\'t receive the code? <span class="text-purple-400">Resend</span></span>';
    }
}

async function verifyLoginMfa() {
    const codeInput = document.getElementById('login-mfa-code');
    const code = codeInput?.value?.replace(/\D/g, '') || '';
    
    if (!code || code.length !== 6) {
        showToast('Please enter a valid 6-digit code', 'error');
        if (codeInput) {
            codeInput.focus();
            codeInput.select();
        }
        return;
    }
    
    const btn = document.getElementById('verify-mfa-btn');
    const btnText = document.getElementById('verify-btn-text');
    if (btn) {
        btn.disabled = true;
        if (btnText) {
            btnText.textContent = 'Verifying...';
        } else {
            btn.textContent = 'Verifying...';
        }
    }
    
    try {
        // Check if this is OAuth MFA (has session_id) or regular login MFA
        if (window.pendingMfaSessionId) {
            console.log("ðŸ” [FRONTEND] Verifying OAuth MFA with session_id:", window.pendingMfaSessionId);
            // OAuth MFA verification
            const res = await fetch('/api/security/oauth/mfa/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: window.pendingMfaSessionId,
                    mfa_code: code
                })
            });
            
            const data = await res.json();
            console.log("ðŸ” [FRONTEND] OAuth MFA verification response:", data);
            
            if (!res.ok) {
                showToast(data.detail || 'Invalid code', 'error');
                const btnText = document.getElementById('verify-btn-text');
                if (btn) {
                    btn.disabled = false;
                    if (btnText) {
                        btnText.textContent = 'Verify';
                    } else {
                        btn.textContent = 'Verify';
                    }
                }
                // Clear and refocus input
                const codeInput = document.getElementById('login-mfa-code');
                if (codeInput) {
                    codeInput.value = '';
                    codeInput.focus();
                }
                return;
            }
            
            // Success - close modal and complete login
            closeLoginMfaModal();
            
            authToken = data.access_token;
            currentUser = data.user;
            
            // Clear OAuth MFA session info
            window.pendingMfaSessionId = null;
            window.pendingMfaEmail = null;
            window.pendingMfaProvider = null;
            
            // Store auth (use remember_me from OAuth if available, default to true)
            localStorage.setItem('agentforge_token', authToken);
            localStorage.setItem('agentforge_user', JSON.stringify(currentUser));
            
            if (data.must_change_password) { showFirstLoginPasswordModal(); return; }
            showApp();
            updateUserDisplay();
            updateUIByPermissions();
            navigate('agents');
            showToast('Welcome back, ' + (currentUser.name || currentUser.email) + '!', 'success');
        } else {
            console.log("ðŸ” [FRONTEND] Verifying regular login MFA");
            // Regular login MFA verification
            const res = await fetch('/api/security/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: window.pendingLoginEmail,
                    password: window.pendingLoginPassword,
                    remember_me: window.pendingLoginRemember,
                    mfa_code: code
                })
            });
            
            const data = await res.json();
            console.log("ðŸ” [FRONTEND] Regular login MFA verification response:", data);
            
            if (!res.ok) {
                showToast(data.detail || 'Invalid code', 'error');
                const btnText = document.getElementById('verify-btn-text');
                if (btn) {
                    btn.disabled = false;
                    if (btnText) {
                        btnText.textContent = 'Verify';
                    } else {
                        btn.textContent = 'Verify';
                    }
                }
                // Clear and refocus input
                const codeInput = document.getElementById('login-mfa-code');
                if (codeInput) {
                    codeInput.value = '';
                    codeInput.focus();
                }
                return;
            }
            
            // Success - close modal and complete login
            closeLoginMfaModal();
            
            authToken = data.access_token;
            currentUser = data.user;
            
            if (window.pendingLoginRemember) {
                localStorage.setItem('agentforge_token', authToken);
                localStorage.setItem('agentforge_user', JSON.stringify(currentUser));
            } else {
                sessionStorage.setItem('agentforge_token', authToken);
                sessionStorage.setItem('agentforge_user', JSON.stringify(currentUser));
            }
            
            if (data.must_change_password) { showFirstLoginPasswordModal(); return; }
            showApp();
            updateUserDisplay();
            updateUIByPermissions();
            navigate('agents');
            showToast('Welcome back, ' + (currentUser.name || currentUser.email) + '!', 'success');
        }
        
    } catch (e) {
        console.error("âŒ [FRONTEND] MFA verification error:", e);
        showToast('Error: ' + e.message, 'error');
        const btnText = document.getElementById('verify-btn-text');
        if (btn) {
            btn.disabled = false;
            if (btnText) {
                btnText.textContent = 'Verify';
            } else {
                btn.textContent = 'Verify';
            }
        }
        // Clear and refocus input
        const codeInput = document.getElementById('login-mfa-code');
        if (codeInput) {
            codeInput.value = '';
            codeInput.focus();
        }
    }
}



// Handle First Login Password Change
async function handleFirstLoginPasswordChange(event) {
    event.preventDefault();
    var newPass = document.getElementById('flp-new-password').value;
    var confirmPass = document.getElementById('flp-confirm-password').value;
    var errorDiv = document.getElementById('flp-error');
    var btn = document.getElementById('flp-submit-btn');
    errorDiv.classList.add('hidden');
    if (newPass !== confirmPass) { errorDiv.textContent = 'Passwords do not match'; errorDiv.classList.remove('hidden'); return; }
    btn.disabled = true; btn.textContent = 'Changing...';
    try {
        var res = await fetch('/api/security/auth/first-login-password-change', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken }, body: JSON.stringify({ new_password: newPass, confirm_password: confirmPass }) });
        var data = await res.json();
        if (!res.ok) { errorDiv.textContent = data.detail.message || data.detail; errorDiv.classList.remove('hidden'); btn.disabled = false; btn.textContent = 'Change Password'; return; }
        document.getElementById('first-login-password-modal').remove();
        currentUser.must_change_password = false;
        showApp(); updateUserDisplay(); navigate('agents'); showToast('Password changed successfully!', 'success');
    } catch (e) { errorDiv.textContent = 'Error: ' + e.message; errorDiv.classList.remove('hidden'); }
    btn.disabled = false; btn.textContent = 'Change Password';
}

// First Login Password Modal
function showFirstLoginPasswordModal() {
    var modal = document.createElement('div');
    modal.id = 'first-login-password-modal';
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
    modal.innerHTML = '<div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div><div class="relative card rounded-2xl p-8 w-full max-w-md mx-4"><div class="text-center mb-6"><h2 class="text-2xl font-bold mb-2">Change Your Password</h2><p class="text-gray-400">For security, you must change your temporary password.</p></div><form onsubmit="handleFirstLoginPasswordChange(event)"><div class="space-y-4"><div><label class="block text-sm text-gray-400 mb-2">New Password</label><input type="password" id="flp-new-password" required minlength="8" class="input-field w-full px-4 py-3 rounded-lg" placeholder="Enter new password"></div><div><label class="block text-sm text-gray-400 mb-2">Confirm Password</label><input type="password" id="flp-confirm-password" required minlength="8" class="input-field w-full px-4 py-3 rounded-lg" placeholder="Confirm password"></div><div id="flp-error" class="hidden bg-red-500/20 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg text-sm"></div><button type="submit" id="flp-submit-btn" class="w-full py-3 rounded-lg font-semibold text-white" style="background: var(--accent-gradient);">Change Password</button></div></form></div>';
    document.body.appendChild(modal);
}

// Show register form
function showRegister() {
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
            <p class="text-gray-400">Create your account</p>
        </div>
        <div class="card rounded-2xl p-8">
            <h2 class="text-xl font-bold mb-6">Get Started</h2>
            
            <!-- OAuth Buttons -->
            <div class="space-y-3 mb-6">
                <button onclick="oauthLogin('google')" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg border border-gray-600 hover:bg-gray-700 transition">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    <span>Continue with Google</span>
                </button>
                <button onclick="oauthLogin('microsoft')" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg border border-gray-600 hover:bg-gray-700 transition">
                    <svg width="20" height="20" viewBox="0 0 23 23"><path fill="#f35325" d="M1 1h10v10H1z"/><path fill="#81bc06" d="M12 1h10v10H12z"/><path fill="#05a6f0" d="M1 12h10v10H1z"/><path fill="#ffba08" d="M12 12h10v10H12z"/></svg>
                    <span>Continue with Microsoft</span>
                </button>
            </div>
            
            <!-- Divider -->
            <div class="flex items-center gap-4 mb-6">
                <div class="flex-1 h-px bg-gray-600"></div>
                <span class="text-sm text-gray-400">or register with email</span>
                <div class="flex-1 h-px bg-gray-600"></div>
            </div>
            
            <form onsubmit="handleRegister(event)">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">First Name</label>
                            <input type="text" id="reg-firstname" required class="input-field w-full px-4 py-3 rounded-lg" placeholder="John">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Last Name</label>
                            <input type="text" id="reg-lastname" required class="input-field w-full px-4 py-3 rounded-lg" placeholder="Doe">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Work Email</label>
                        <input type="email" id="reg-email" required class="input-field w-full px-4 py-3 rounded-lg" placeholder="you@company.com">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Password</label>
                        <div class="relative">
                            <input type="password" id="reg-password" required minlength="8" 
                                   class="input-field w-full px-4 py-3 pr-12 rounded-lg" 
                                   placeholder="Min 8 characters"
                                   oninput="checkPasswordStrength(this.value)">
                            <button type="button" onclick="togglePassword('reg-password', this)" 
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1">
                                <span class="eye-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>
                            </button>
                        </div>
                        <!-- Password Strength Indicator -->
                        <div class="mt-2">
                            <div class="flex gap-1 mb-1">
                                <div id="str-1" class="h-1 flex-1 rounded bg-gray-600"></div>
                                <div id="str-2" class="h-1 flex-1 rounded bg-gray-600"></div>
                                <div id="str-3" class="h-1 flex-1 rounded bg-gray-600"></div>
                                <div id="str-4" class="h-1 flex-1 rounded bg-gray-600"></div>
                            </div>
                            <p id="str-text" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Confirm Password</label>
                        <div class="relative">
                            <input type="password" id="reg-password2" required class="input-field w-full px-4 py-3 pr-12 rounded-lg" placeholder="Repeat password">
                            <button type="button" onclick="togglePassword('reg-password2', this)" 
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1">
                                <span class="eye-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Terms of Service -->
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="reg-terms" required class="mt-1 rounded">
                        <label for="reg-terms" class="text-sm text-gray-400">
                            I agree to the <a href="#" class="text-purple-400 hover:text-purple-300">Terms of Service</a> 
                            and <a href="#" class="text-purple-400 hover:text-purple-300">Privacy Policy</a>
                        </label>
                    </div>
                    
                    <button type="submit" id="reg-btn" class="btn-primary w-full py-3 rounded-lg font-semibold">Create Account</button>
                </div>
            </form>
            <p class="text-center text-gray-400 text-sm mt-6">
                Already have an account? <button onclick="location.reload()" class="text-purple-400 hover:text-purple-300">Sign in</button>
            </p>
        </div>
    `;
}

// Handle registration
async function handleRegister(event) {
    event.preventDefault();
    
    const password = document.getElementById('reg-password').value;
    const password2 = document.getElementById('reg-password2').value;
    const passInput1 = document.getElementById('reg-password');
    const passInput2 = document.getElementById('reg-password2');
    
    // Reset any previous error styling
    passInput1.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
    passInput2.classList.remove('border-red-500', 'ring-2', 'ring-red-500');
    
    // Validate passwords match
    if (password !== password2) {
        passInput1.classList.add('border-red-500', 'ring-2', 'ring-red-500');
        passInput2.classList.add('border-red-500', 'ring-2', 'ring-red-500');
        passInput2.focus();
        showToast('Passwords do not match. Please check and try again.', 'error');
        return;
    }
    
    // Validate password strength
    if (password.length < 8) {
        passInput1.classList.add('border-red-500', 'ring-2', 'ring-red-500');
        passInput1.focus();
        showToast('Password must be at least 8 characters long.', 'error');
        return;
    }
    
    // Validate terms accepted
    const termsCheckbox = document.getElementById('reg-terms');
    if (termsCheckbox && !termsCheckbox.checked) {
        showToast('Please accept the Terms of Service and Privacy Policy.', 'error');
        return;
    }
    
    const btn = document.getElementById('reg-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin inline-block">â³</span> Creating account...';
    
    try {
        const res = await fetch('/api/security/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: document.getElementById('reg-email').value,
                password: password,
                first_name: document.getElementById('reg-firstname').value,
                last_name: document.getElementById('reg-lastname').value
            })
        });
        
        const data = await res.json();
        console.log("Login response:", data);
        
        if (!res.ok) {
            let errorMsg = 'Registration failed. Please try again.';
            if (data.detail) {
                if (typeof data.detail === 'string') {
                    errorMsg = data.detail;
                } else if (data.detail.message) {
                    errorMsg = data.detail.message;
                }
            }
            showToast(errorMsg, 'error');
            btn.disabled = false;
            btn.textContent = 'Create Account';
            return;
        }
        
        // Show success message with email verification info
        showRegistrationSuccess(document.getElementById('reg-email').value, data.email_verification_required);
        
    } catch (e) {
        showToast('Connection error. Please check your internet and try again.', 'error');
        btn.disabled = false;
        btn.textContent = 'Create Account';
    }
}

// Show registration success with clear instructions
function showRegistrationSuccess(email, verificationRequired) {
    const container = document.getElementById('auth-container');
    
    if (verificationRequired) {
        container.innerHTML = `
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-3 mb-4">
                    <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                    <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
                </div>
            </div>
            <div class="card rounded-2xl p-8 text-center">
                <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold mb-2">Check your email</h2>
                <p class="text-gray-400 mb-4">
                    We sent a verification link to<br>
                    <strong class="text-white">${email}</strong>
                </p>
                <p class="text-sm text-gray-500 mb-6">
                    Click the link in the email to verify your account.<br>
                    If you don't see it, check your spam folder.
                </p>
                <button onclick="location.reload()" class="btn-primary w-full py-3 rounded-lg font-semibold">
                    Back to Sign In
                </button>
                <p class="text-sm text-gray-500 mt-4">
                    Didn't receive the email? 
                    <button onclick="resendVerification('${email}')" class="text-purple-400 hover:text-purple-300">Resend</button>
                </p>
            </div>
        `;
    } else {
        // No verification required - direct to login
        container.innerHTML = `
            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-3 mb-4">
                    <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                    <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
                </div>
            </div>
            <div class="card rounded-2xl p-8 text-center">
                <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold mb-2">Account Created!</h2>
                <p class="text-gray-400 mb-6">
                    Your account has been created successfully.<br>
                    You can now sign in with your credentials.
                </p>
                <button onclick="location.reload()" class="btn-primary w-full py-3 rounded-lg font-semibold">
                    Sign In Now
                </button>
            </div>
        `;
    }
}

// Resend verification email
async function resendVerification(email) {
    showToast('Sending verification email...', 'info');
    try {
        const res = await fetch('/api/security/auth/resend-verification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        if (res.ok) {
            showToast('Verification email sent! Check your inbox.', 'success');
        } else {
            showToast('Could not send email. Please try again later.', 'error');
        }
    } catch (e) {
        showToast('Connection error. Please try again.', 'error');
    }
}

// Show forgot password
function showForgotPassword() {
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
            <p class="text-gray-400">Reset your password</p>
        </div>
        <div class="card rounded-2xl p-8">
            <h2 class="text-xl font-bold mb-2">Forgot Password?</h2>
            <p class="text-gray-400 text-sm mb-6">Enter your email and we'll send you a reset link.</p>
            
            <form onsubmit="handleForgotPassword(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Email</label>
                        <input type="email" id="forgot-email" required 
                               class="input-field w-full px-4 py-3 rounded-lg"
                               placeholder="you@company.com">
                    </div>
                    
                    <button type="submit" id="forgot-btn"
                            class="btn-primary w-full py-3 rounded-lg font-semibold">
                        Send Reset Link
                    </button>
                </div>
            </form>
            
            <p class="text-center text-gray-400 text-sm mt-6">
                Remember your password? 
                <button onclick="location.reload()" class="text-purple-400 hover:text-purple-300">Sign in</button>
            </p>
        </div>
    `;
}

// Handle forgot password
async function handleForgotPassword(event) {
    event.preventDefault();
    
    const email = document.getElementById('forgot-email').value;
    const btn = document.getElementById('forgot-btn');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin inline-block">â³</span> Sending...';
    
    try {
        const res = await fetch('/api/security/auth/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        
        // Always show success (don't reveal if email exists)
        showForgotPasswordSuccess(email);
        
    } catch (e) {
        showForgotPasswordSuccess(email);
    }
}

// Show forgot password success
function showForgotPasswordSuccess(email) {
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
        </div>
        <div class="card rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
            </div>
            <h2 class="text-xl font-bold mb-2">Check your email</h2>
            <p class="text-gray-400 mb-4">
                If an account exists for<br>
                <strong class="text-white">${email}</strong><br>
                you will receive a password reset link.
            </p>
            <p class="text-sm text-gray-500 mb-6">
                Check your spam folder if you don't see it.
            </p>
            <button onclick="location.reload()" class="btn-primary w-full py-3 rounded-lg font-semibold">
                Back to Sign In
            </button>
        </div>
    `;
}

// Logout
function logout() {
    clearAuth();
    location.reload();
}

// Clear auth data
function clearAuth() {
    authToken = null;
    currentUser = null;
    localStorage.removeItem('agentforge_token');
    localStorage.removeItem('agentforge_user');
    sessionStorage.removeItem('agentforge_token');
    sessionStorage.removeItem('agentforge_user');
}

// Update user display
function updateUserDisplay() {
    if (!currentUser) return;
    
    const name = currentUser.name || currentUser.email?.split('@')[0] || 'User';
    document.getElementById('user-avatar').textContent = name[0].toUpperCase();
    document.getElementById('user-name').textContent = name;
    const emailEl = document.getElementById('user-email');
    if (emailEl) {
        emailEl.textContent = currentUser.email || 'Click to view profile';
    }
}

// Alias for profile page compatibility
async function fetchCurrentUser() {
    try {
        const res = await fetch(API + '/api/security/auth/me', {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (res.ok) {
            currentUser = await res.json();
            localStorage.setItem('agentforge_user', JSON.stringify(currentUser));
            updateUserDisplay();
        }
    } catch (e) {
        console.error('Error fetching current user:', e);
    }
}

// Get auth headers
function getAuthHeaders() {
    const headers = authToken ? { 'Authorization': 'Bearer ' + authToken } : {};
    if (!authToken) {
        console.warn('âš ï¸ [getAuthHeaders] No authToken available. Checking localStorage...');
        const storedToken = localStorage.getItem('agentforge_token');
        if (storedToken) {
            console.log('âœ… [getAuthHeaders] Found token in localStorage, updating authToken');
            authToken = storedToken;
            return { 'Authorization': 'Bearer ' + authToken };
        } else {
            console.warn('âš ï¸ [getAuthHeaders] No token found in localStorage either');
        }
    }
    return headers;
}

// ============================================================================
// SECURITY CENTER FUNCTIONS
// ============================================================================

// Initialize security page

// Load security statistics
async function loadSecurityStats() {
    // Don't make request if not authenticated (best practice)
    if (!authToken) return;
    
    try {
        const res = await fetch('/api/security/stats', {
            headers: getAuthHeaders()
        });
        if (!res.ok) return;
        const stats = await res.json();
        
        document.getElementById('sec-stat-users').textContent = stats.users?.total || 0;
        document.getElementById('sec-stat-active').textContent = stats.users?.active || 0;
        document.getElementById('sec-stat-roles').textContent = stats.roles || 0;
        document.getElementById('sec-stat-policies').textContent = stats.policies || 0;
        document.getElementById('sec-stat-mfa').textContent = stats.users?.mfa_enabled || 0;
    } catch (e) {
        console.error('Error loading security stats:', e);
    }
}

// Load security users
async function loadSecurityUsers() {
    // Don't make request if not authenticated (best practice)
    if (!authToken) return;
    
    try {
        const res = await fetch('/api/security/users', {
            headers: getAuthHeaders()
        });
        
        if (res.status === 403) {
            document.getElementById('sec-users-table').innerHTML = 
                '<tr><td colspan="6" class="p-8 text-center text-yellow-500">âš ï¸ Admin permissions required</td></tr>';
            return;
        }
        
        if (!res.ok) return;
        const data = await res.json();
        console.log("Login response:", data);
        securityUsers = data.users || [];
        renderSecurityUsers();
    } catch (e) {
        console.error('Error loading users:', e);
    }
}

// Render security users table
function renderSecurityUsers() {
    const filter = document.getElementById('sec-user-search')?.value?.toLowerCase() || '';
    const status = document.getElementById('sec-user-filter')?.value || '';
    
    let users = securityUsers.filter(u => {
        if (filter && !u.email.toLowerCase().includes(filter) && !(u.name||'').toLowerCase().includes(filter)) return false;
        if (status && u.status !== status) return false;
        return true;
    });
    
    if (!users.length) {
        document.getElementById('sec-users-table').innerHTML = 
            '<tr><td colspan="6" class="p-8 text-center text-gray-500">No users found</td></tr>';
        return;
    }
    
    document.getElementById('sec-users-table').innerHTML = users.map(u => `
        <tr class="border-t border-gray-700 hover:bg-gray-800/50">
            <td class="p-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center font-bold text-white">
                        ${(u.name || u.email)[0].toUpperCase()}
                    </div>
                    <div>
                        <div class="font-medium">${escHtml(u.name || 'No name')}</div>
                        <div class="text-sm text-gray-400">${escHtml(u.email)}</div>
                    </div>
                </div>
            </td>
            <td class="p-4">
                ${(u.roles || []).map(roleName => {
                    // Use role names directly from API response (best practice)
                    return `<span class="px-2 py-1 rounded text-xs bg-blue-600/30 text-blue-400 mr-1">${escHtml(roleName)}</span>`;
                }).join('') || (u.role_ids || []).map(roleId => {
                    // Fallback: if roles array not available, try to find in securityRoles
                    const role = securityRoles.find(r => r.id === roleId);
                    const roleName = role ? role.name : (roleId.replace('role_', '') || roleId);
                    return `<span class="px-2 py-1 rounded text-xs bg-blue-600/30 text-blue-400 mr-1">${escHtml(roleName)}</span>`;
                }).join('')}
            </td>
            <td class="p-4">
                <span class="px-2 py-1 rounded text-xs ${u.status === 'active' ? 'bg-green-600/30 text-green-400' : u.status === 'pending' ? 'bg-yellow-600/30 text-yellow-400' : 'bg-red-600/30 text-red-400'}">${u.status}</span>
            </td>
            <td class="p-4 text-center">${u.mfa_enabled ? '<span class="text-green-400">âœ“</span>' : '<span class="text-gray-500">â€”</span>'}</td>
            <td class="p-4 text-sm text-gray-400">${u.last_login ? new Date(u.last_login).toLocaleDateString() : 'Never'}</td>
            <td class="p-4 flex gap-2">
                <button data-permission="users:edit" onclick="editSecurityUser('${u.id}')" class="text-blue-400 hover:text-blue-300" title="Edit">âœï¸</button>
                ${u.status === 'pending' && !u.email_verified ? `<button onclick="resendVerificationEmail('${u.id}', '${u.email}')" class="text-yellow-400 hover:text-yellow-300" title="Resend Verification">ðŸ“§</button>` : ''}
                ${u.id !== currentUser?.id ? `<button data-permission="users:delete" onclick="deleteSecurityUser('${u.id}')" class="text-red-400 hover:text-red-300" title="Delete">ðŸ—‘ï¸</button>` : ''}
            </td>
        </tr>
    `).join('');
}

// Resend verification email to user
async function resendVerificationEmail(userId, email) {
    if (!confirm(`Send verification email to ${email}?`)) return;
    
    try {
        const res = await fetch(`/api/security/users/${userId}/resend-verification`, {
            method: 'POST',
            headers: getAuthHeaders()
        });
        
        if (res.ok) {
            showToast(`Verification email sent to ${email}`, 'success');
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to send email', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}


// Delete security user
async function deleteSecurityUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    
    try {
        const res = await fetch('/api/security/users/' + userId, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        
        if (res.ok) {
            showToast('User deleted successfully', 'success');
            loadSecurityUsers();
            loadSecurityStats();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to delete user', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

// ============================================================
// GROUP MANAGEMENT
// ============================================================

let allGroups = [];
let groupSelectedMembers = [];

async function loadGroups() {
    try {
        const res = await fetch('/api/security/groups', {
            headers: getAuthHeaders()
        });
        
        if (res.ok) {
            const data = await res.json();
            // Handle both {groups: [...]} and [...] response format
            allGroups = Array.isArray(data) ? data : (data.groups || []);
            renderGroups();
        } else {
            // If groups API not available, show empty state
            allGroups = [];
            renderGroups();
        }
    } catch (e) {
        console.log('Groups API not available:', e);
        allGroups = [];
        renderGroups();
    }
}

function renderGroups() {
    const container = document.getElementById('sec-groups-grid');
    
    if (allGroups.length === 0) {
        container.innerHTML = `
            <div class="card rounded-xl p-8 text-center col-span-full">
                <div class="text-4xl mb-3">ðŸ‘¥</div>
                <h4 class="font-semibold mb-2">No Groups Yet</h4>
                <p class="text-gray-400 text-sm mb-4">Create groups to organize users and simplify access management</p>
                <button onclick="showAddGroupModal()" class="btn-primary px-4 py-2 rounded-lg">+ Create First Group</button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = allGroups.map(g => `
        <div class="card rounded-xl p-4">
            <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-xl">ðŸ‘¥</div>
                    <div>
                        <h4 class="font-semibold">${g.name}</h4>
                        <p class="text-xs text-gray-400">${(g.member_ids || g.user_ids || []).length} members</p>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button onclick="editGroup('${g.id}')" class="p-1 hover:bg-gray-700 rounded" title="Edit">âœï¸</button>
                    <button onclick="deleteGroup('${g.id}')" class="p-1 hover:bg-gray-700 rounded text-red-400" title="Delete">ðŸ—‘ï¸</button>
                </div>
            </div>
            <p class="text-sm text-gray-400 line-clamp-2">${g.description || 'No description'}</p>
        </div>
    `).join('');
}

function showAddGroupModal() {
    ensureModalInBody('add-group-modal');
    groupSelectedMembers = [];
    document.getElementById('group-name').value = '';
    document.getElementById('group-description').value = '';
    document.getElementById('group-selected-members').innerHTML = '';
    document.getElementById('add-group-modal').classList.remove('hidden');
    document.getElementById('add-group-modal').classList.add('flex');
}

function closeAddGroupModal() {
    document.getElementById('add-group-modal').classList.add('hidden');
    document.getElementById('add-group-modal').classList.remove('flex');
}

async function searchGroupMembers(query) {
    const resultsEl = document.getElementById('group-member-results');
    
    if (!query || query.length < 2) {
        resultsEl.classList.add('hidden');
        return;
    }
    
    try {
        const res = await fetch('/api/security/users', { headers: getAuthHeaders() });
        if (!res.ok) {
            console.error('Failed to fetch users:', res.status);
            return;
        }
        
        const data = await res.json();
        // Handle both array and {users: [...]} response formats
        const users = Array.isArray(data) ? data : (data.users || []);
        
        const filtered = users.filter(u => 
            (u.email?.toLowerCase().includes(query.toLowerCase()) ||
             u.first_name?.toLowerCase().includes(query.toLowerCase()) ||
             u.last_name?.toLowerCase().includes(query.toLowerCase())) &&
            !groupSelectedMembers.find(m => m.id === u.id)
        ).slice(0, 5);
        
        if (filtered.length === 0) {
            resultsEl.innerHTML = '<div class="p-3 text-gray-500 text-sm">No users found</div>';
        } else {
            resultsEl.innerHTML = filtered.map(u => `
                <div onclick="addGroupMember('${u.id}', '${(u.first_name || '').replace(/'/g, "\\'")} ${(u.last_name || '').replace(/'/g, "\\'")}', '${(u.email || '').replace(/'/g, "\\'")}')" 
                     class="p-3 hover:bg-gray-700 cursor-pointer border-b border-gray-700 last:border-b-0">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">ðŸ‘¤</span>
                        <div>
                            <div class="font-medium">${u.first_name || ''} ${u.last_name || ''}</div>
                            <div class="text-xs text-gray-400">${u.email}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        resultsEl.classList.remove('hidden');
    } catch (e) {
        console.error('Error searching members:', e);
    }
}

function addGroupMember(id, name, email) {
    if (groupSelectedMembers.find(m => m.id === id)) return;
    
    groupSelectedMembers.push({ id, name: name.trim() || email, email });
    renderGroupSelectedMembers();
    
    document.getElementById('group-member-search').value = '';
    document.getElementById('group-member-results').classList.add('hidden');
}

function removeGroupMember(id) {
    groupSelectedMembers = groupSelectedMembers.filter(m => m.id !== id);
    renderGroupSelectedMembers();
}

function renderGroupSelectedMembers() {
    const container = document.getElementById('group-selected-members');
    
    if (groupSelectedMembers.length === 0) {
        container.innerHTML = '<span class="text-gray-500 text-sm italic">No members added yet</span>';
        return;
    }
    
    container.innerHTML = groupSelectedMembers.map(m => `
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/20 text-sm">
            ðŸ‘¤ ${m.name}
            <button onclick="removeGroupMember('${m.id}')" class="hover:text-red-400">âœ•</button>
        </span>
    `).join('');
}

async function saveGroup() {
    const name = document.getElementById('group-name').value.trim();
    const description = document.getElementById('group-description').value.trim();
    
    if (!name) {
        showToast('Please enter a group name', 'error');
        return;
    }
    
    try {
        const res = await fetch('/api/security/groups', {
            method: 'POST',
            headers: {
                ...getAuthHeaders(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name,
                description,
                member_ids: groupSelectedMembers.map(m => m.id)
            })
        });
        
        if (res.ok) {
            showToast('Group created successfully!', 'success');
            closeAddGroupModal();
            loadGroups();
        } else {
            const data = await res.json();
            showToast(data.detail || 'Failed to create group', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function deleteGroup(id) {
    if (!confirm('Are you sure you want to delete this group?')) return;
    
    try {
        const res = await fetch('/api/security/groups/' + id, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        
        if (res.ok) {
            showToast('Group deleted', 'success');
            loadGroups();
        } else {
            showToast('Failed to delete group', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

let editGroupMembers = [];

async function editGroup(id) {
    const group = allGroups.find(g => g.id === id);
    if (!group) {
        showToast('Group not found', 'error');
        return;
    }
    
    // Get current member details
    editGroupMembers = [];
    const memberIds = group.member_ids || group.user_ids || [];
    
    // Fetch user details for current members
    try {
        const res = await fetch('/api/security/users', { headers: getAuthHeaders() });
        if (res.ok) {
            const data = await res.json();
            const users = Array.isArray(data) ? data : (data.users || []);
            editGroupMembers = memberIds.map(mid => {
                const user = users.find(u => u.id === mid);
                return user ? {
                    id: user.id,
                    name: `${user.profile?.first_name || ''} ${user.profile?.last_name || ''}`.trim() || user.email,
                    email: user.email
                } : { id: mid, name: 'Unknown User', email: '' };
            });
        }
    } catch (e) {
        console.error('Error loading members:', e);
    }
    
    // Create edit modal
    const modal = document.createElement('div');
    modal.id = 'edit-group-modal';
    modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="modal-content-box rounded-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden">
            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                <h3 class="font-bold text-lg">âœï¸ Edit Group: ${group.name}</h3>
                <button onclick="document.getElementById('edit-group-modal').remove()" class="p-2 hover:bg-gray-700 rounded-lg">âœ•</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto" style="max-height: calc(90vh - 140px);">
                <div>
                    <label class="block text-sm font-medium mb-2">Group Name *</label>
                    <input type="text" id="edit-group-name" class="w-full input-field rounded-lg px-4 py-2" value="${group.name || ''}">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Description</label>
                    <textarea id="edit-group-description" class="w-full input-field rounded-lg px-4 py-2 h-20">${group.description || ''}</textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Add Members</label>
                    <input type="text" id="edit-group-member-search" class="w-full input-field rounded-lg px-4 py-2 mb-2" placeholder="ðŸ” Search users to add..." oninput="searchEditGroupMembers(this.value)">
                    <div id="edit-group-member-results" class="hidden max-h-32 overflow-y-auto rounded-lg border border-gray-600 bg-gray-800"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Current Members (${editGroupMembers.length})</label>
                    <div id="edit-group-selected-members" class="flex flex-wrap gap-2">
                        ${renderEditGroupMembers()}
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-end gap-3">
                <button onclick="document.getElementById('edit-group-modal').remove()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600">Cancel</button>
                <button onclick="updateGroup('${id}')" class="px-6 py-2 rounded-lg bg-purple-600 hover:bg-purple-700">Save Changes</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function renderEditGroupMembers() {
    if (editGroupMembers.length === 0) {
        return '<span class="text-gray-500 text-sm italic">No members yet</span>';
    }
    return editGroupMembers.map(m => `
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/20 text-sm">
            ðŸ‘¤ ${m.name}
            <button onclick="removeEditGroupMember('${m.id}')" class="hover:text-red-400">âœ•</button>
        </span>
    `).join('');
}

function updateEditGroupMembersUI() {
    const container = document.getElementById('edit-group-selected-members');
    if (container) {
        container.innerHTML = renderEditGroupMembers();
    }
}

async function searchEditGroupMembers(query) {
    const resultsEl = document.getElementById('edit-group-member-results');
    
    if (!query || query.length < 2) {
        resultsEl.classList.add('hidden');
        return;
    }
    
    try {
        const res = await fetch('/api/security/users', { headers: getAuthHeaders() });
        if (!res.ok) return;
        
        const data = await res.json();
        const users = Array.isArray(data) ? data : (data.users || []);
        
        const filtered = users.filter(u => 
            (u.email?.toLowerCase().includes(query.toLowerCase()) ||
             u.profile?.first_name?.toLowerCase().includes(query.toLowerCase()) ||
             u.profile?.last_name?.toLowerCase().includes(query.toLowerCase())) &&
            !editGroupMembers.find(m => m.id === u.id)
        ).slice(0, 5);
        
        if (filtered.length === 0) {
            resultsEl.innerHTML = '<div class="p-3 text-gray-500 text-sm">No users found</div>';
        } else {
            resultsEl.innerHTML = filtered.map(u => `
                <div onclick="addEditGroupMember('${u.id}', '${(u.profile?.first_name || '').replace(/'/g, "\\'")} ${(u.profile?.last_name || '').replace(/'/g, "\\'")}', '${(u.email || '').replace(/'/g, "\\'")}')" 
                     class="p-3 hover:bg-gray-700 cursor-pointer border-b border-gray-700 last:border-b-0">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">ðŸ‘¤</span>
                        <div>
                            <div class="font-medium">${u.profile?.first_name || ''} ${u.profile?.last_name || ''}</div>
                            <div class="text-xs text-gray-400">${u.email}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        resultsEl.classList.remove('hidden');
    } catch (e) {
        console.error('Error searching members:', e);
    }
}

function addEditGroupMember(id, name, email) {
    if (editGroupMembers.find(m => m.id === id)) return;
    
    editGroupMembers.push({ id, name: name.trim() || email, email });
    updateEditGroupMembersUI();
    
    document.getElementById('edit-group-member-search').value = '';
    document.getElementById('edit-group-member-results').classList.add('hidden');
}

function removeEditGroupMember(id) {
    editGroupMembers = editGroupMembers.filter(m => m.id !== id);
    updateEditGroupMembersUI();
}

async function updateGroup(id) {
    const name = document.getElementById('edit-group-name').value.trim();
    const description = document.getElementById('edit-group-description').value.trim();
    const memberIds = editGroupMembers.map(m => m.id);
    
    if (!name) {
        showToast('Group name is required', 'error');
        return;
    }
    
    try {
        const res = await fetch('/api/security/groups/' + id, {
            method: 'PUT',
            headers: {
                ...getAuthHeaders(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name, description, member_ids: memberIds })
        });
        
        if (res.ok) {
            showToast('Group updated successfully!', 'success');
            document.getElementById('edit-group-modal').remove();
            loadGroups();
        } else {
            const data = await res.json();
            showToast(data.detail || 'Failed to update group', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

// ============================================================
// END GROUP MANAGEMENT
// ============================================================

// Edit security user
function editSecurityUser(userId) {
    const user = securityUsers.find(u => u.id === userId);
    if (!user) return;
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm';
    modal.id = 'edit-user-modal';
    modal.innerHTML = `
        <div class="card rounded-2xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">Edit User</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Email</label>
                    <input type="email" id="edit-user-email" value="${user.email}" class="input-field w-full px-4 py-2 rounded-lg" disabled>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">First Name</label>
                        <input type="text" id="edit-user-firstname" value="${user.profile?.first_name || ''}" class="input-field w-full px-4 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Last Name</label>
                        <input type="text" id="edit-user-lastname" value="${user.profile?.last_name || ''}" class="input-field w-full px-4 py-2 rounded-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Status</label>
                    <select id="edit-user-status" class="input-field w-full px-4 py-2 rounded-lg">
                        <option value="active" ${user.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="pending" ${user.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="locked" ${user.status === 'locked' ? 'selected' : ''}>Locked</option>
                        <option value="disabled" ${user.status === 'disabled' ? 'selected' : ''}>Disabled</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Roles</label>
                    <div id="edit-user-roles" class="space-y-2">
                        ${securityRoles.map(r => `
                            <label class="flex items-center gap-2">
                                <input type="checkbox" value="${r.id}" ${(user.role_ids || []).includes(r.id) ? 'checked' : ''} class="rounded">
                                <span>${r.name}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="document.getElementById('edit-user-modal').remove()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                    <button onclick="saveUserEdit('${userId}')" class="btn-primary flex-1 py-2 rounded-lg">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Save user edit
async function saveUserEdit(userId) {
    const firstName = document.getElementById('edit-user-firstname').value?.trim() || '';
    const lastName = document.getElementById('edit-user-lastname').value?.trim() || '';
    const status = document.getElementById('edit-user-status').value;
    const roleCheckboxes = document.querySelectorAll('#edit-user-roles input[type="checkbox"]:checked');
    const roleIds = Array.from(roleCheckboxes).map(cb => cb.value);
    
    console.log('ðŸ“ Saving user edit:', { firstName, lastName, status, roleIds });
    
    try {
        const res = await fetch('/api/security/users/' + userId, {
            method: 'PUT',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({
                first_name: firstName,  // âœ… Top-level, not nested in profile
                last_name: lastName,    // âœ… Top-level, not nested in profile
                status: status,
                role_ids: roleIds
            })
        });
        
        if (res.ok) {
            showToast('User updated successfully', 'success');
            document.getElementById('edit-user-modal').remove();
            loadSecurityUsers();
        } else {
            const data = await res.json();
            console.error('Failed to update user:', data);
            showToast(data.detail || 'Failed to update user', 'error');
        }
    } catch (e) {
        console.error('Error saving user:', e);
        showToast('Error: ' + e.message, 'error');
    }
}

// Filter security users
function filterSecurityUsers() {
    renderSecurityUsers();
}

// Load security roles

// Load invitations
let securityInvitations = [];

async function loadSecurityInvitations() {
    // Don't make request if not authenticated (best practice)
    if (!authToken) return;
    
    try {
        const res = await fetch('/api/security/invitations', { headers: getAuthHeaders() });
        if (res.ok) {
            const data = await res.json();
        console.log("Login response:", data);
            securityInvitations = data.invitations || [];
            renderSecurityInvitations();
        }
    } catch (e) {
        console.error('Error loading invitations:', e);
    }
}

function renderSecurityInvitations() {
    const container = document.getElementById('sec-invitations-list');
    if (!container) return;
    
    if (!securityInvitations.length) {
        container.innerHTML = '<p class="text-gray-500 text-sm p-4">No pending invitations</p>';
        return;
    }
    
    container.innerHTML = securityInvitations.map(inv => `
        <div class="flex items-center justify-between p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-yellow-500/30 flex items-center justify-center text-yellow-400">ðŸ“§</div>
                <div>
                    <p class="font-medium">${escHtml(inv.email)}</p>
                    <p class="text-xs text-gray-400">Invited ${new Date(inv.created_at).toLocaleDateString()} Â· ${inv.roles.join(', ')}</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs px-2 py-1 rounded ${inv.status === 'expired' ? 'bg-red-500/20 text-red-400' : 'bg-yellow-500/20 text-yellow-400'}">${inv.status}</span>
                <button onclick="resendInvitation('${inv.id}')" class="text-blue-400 hover:text-blue-300 p-1" title="Resend">ðŸ”„</button>
                <button onclick="deleteInvitation('${inv.id}')" class="text-red-400 hover:text-red-300 p-1" title="Delete">ðŸ—‘ï¸</button>
            </div>
        </div>
    `).join('');
}

async function resendInvitation(invId) {
    try {
        const res = await fetch('/api/security/invitations/' + invId + '/resend', {
            method: 'POST',
            headers: getAuthHeaders()
        });
        if (res.ok) {
            showToast('Invitation resent successfully', 'success');
            loadSecurityInvitations();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to resend', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function deleteInvitation(invId) {
    if (!confirm('Delete this invitation?')) return;
    try {
        const res = await fetch('/api/security/invitations/' + invId, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        if (res.ok) {
            showToast('Invitation deleted', 'success');
            loadSecurityInvitations();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to delete', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function loadSecurityRoles() {
    // Don't make request if not authenticated (best practice)
    if (!authToken) return;
    
    try {
        const res = await fetch('/api/security/roles', {
            headers: getAuthHeaders()
        });
        if (!res.ok) return;
        const data = await res.json();
        console.log("Login response:", data);
        securityRoles = data.roles || [];
        renderSecurityRoles();
    } catch (e) {
        console.error('Error loading roles:', e);
    }
}

// Render security roles


// Toggle all permissions
function toggleAllPermissions(checked) {
    document.querySelectorAll('.role-perm').forEach(cb => cb.checked = checked);
    document.querySelectorAll('.select-cat').forEach(cb => cb.checked = checked);
}

// Toggle category permissions
function toggleCategoryPermissions(catIdx, checked) {
    document.querySelectorAll('.cat-' + catIdx).forEach(cb => cb.checked = checked);
    updateSelectAllState();
}

// Update select all checkbox state
function updateSelectAllState() {
    const allPerms = document.querySelectorAll('.role-perm');
    const checkedPerms = document.querySelectorAll('.role-perm:checked');
    const selectAll = document.getElementById('select-all-perms');
    if (selectAll) {
        selectAll.checked = allPerms.length === checkedPerms.length;
        selectAll.indeterminate = checkedPerms.length > 0 && checkedPerms.length < allPerms.length;
    }
}

// Show Add Role Modal
function showAddRoleModal() {
    const allPermissions = [
        // Security - User Management
        { category: 'ðŸ” User Management', permissions: [
            { id: 'users:view', name: 'View Users' },
            { id: 'users:edit', name: 'Edit Users' },
            { id: 'users:delete', name: 'Delete Users' },
            { id: 'users:invite', name: 'Invite Users' },
        ]},
        // Security - Role Management
        { category: 'ðŸ” Role Management', permissions: [
            { id: 'roles:view', name: 'View Roles' },
            { id: 'roles:create', name: 'Create Roles' },
            { id: 'roles:edit', name: 'Edit Roles' },
            { id: 'roles:delete', name: 'Delete Roles' },
        ]},
        // Security - Security & MFA
        { category: 'ðŸ” Security & MFA', permissions: [
            { id: 'security:settings', name: 'Security Settings' },
            { id: 'mfa:manage', name: 'Manage MFA' },
        ]},
        // AI Agent - Agents
        { category: 'ðŸ¤– AI Agents', permissions: [
            { id: 'agents:view', name: 'View Agents' },
            { id: 'agents:create', name: 'Create Agents' },
            { id: 'agents:edit', name: 'Edit Agents' },
            { id: 'agents:delete', name: 'Delete Agents' },
            { id: 'agents:publish', name: 'Publish Agents' },
        ]},
        // AI Agent - Tools
        { category: 'ðŸ¤– Tools & Integrations', permissions: [
            { id: 'tools:view', name: 'View Tools' },
            { id: 'tools:create', name: 'Create Tools' },
            { id: 'tools:edit', name: 'Edit Tools' },
            { id: 'tools:delete', name: 'Delete Tools' },
            { id: 'tools:execute', name: 'Execute Tools' },
        ]},
        // AI Agent - Chat
        { category: 'ðŸ¤– Chat', permissions: [
            { id: 'chat:use', name: 'Use Chat' },
            { id: 'chat:view_all', name: 'View All Chats' },
            { id: 'chat:delete', name: 'Delete Chats' },
        ]},
        // Analytics & Audit
        { category: 'ðŸ“Š Analytics & Audit', permissions: [
            { id: 'audit:view', name: 'View Audit Logs' },
            { id: 'audit:export', name: 'Export Audit Logs' },
            { id: 'analytics:view', name: 'View Analytics' },
            { id: 'reports:generate', name: 'Generate Reports' },
        ]},
        // Demo Lab
        { category: 'ðŸ§ª Demo Lab', permissions: [
            { id: 'demo:access', name: 'Access Demo Lab' },
            { id: 'demo:create', name: 'Create Demos' },
            { id: 'demo:share', name: 'Share Demos' },
        ]},
        // System
        { category: 'âš™ï¸ System', permissions: [
            { id: 'system:admin', name: 'Full System Admin' },
            { id: 'system:settings', name: 'System Settings' },
        ]},
    ];
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm';
    modal.id = 'role-modal';
    modal.innerHTML = `
        <div class="card rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Create New Role</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Role Name *</label>
                    <input type="text" id="role-name" class="input-field w-full px-4 py-2 rounded-lg" placeholder="e.g. Marketing Team">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Description</label>
                    <textarea id="role-description" class="input-field w-full px-4 py-2 rounded-lg" rows="2" placeholder="Role description..."></textarea>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm text-gray-400">Permissions</label>
                        <label class="flex items-center gap-2 text-sm text-green-400 cursor-pointer">
                            <input type="checkbox" id="select-all-add" onchange="document.querySelectorAll('#role-modal .role-perm').forEach(c=>c.checked=this.checked)" class="rounded">
                            <span>Select All</span>
                        </label>
                    </div>
                    ${allPermissions.map((cat, i) => `
                        <div class="mb-4 p-3 rounded-lg" style="background:rgba(139,92,246,0.1)">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-sm font-semibold text-purple-400">${cat.category}</h5>
                                <label class="flex items-center gap-1 text-xs text-gray-400 cursor-pointer">
                                    <input type="checkbox" onchange="document.querySelectorAll('#role-modal .cat-${i}').forEach(c=>c.checked=this.checked)" class="rounded">
                                    <span>All</span>
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                ${cat.permissions.map(p => `
                                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                                        <input type="checkbox" class="role-perm cat-${i} rounded" value="${p.id}">
                                        <span>${p.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="document.getElementById('role-modal').remove()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                    <button onclick="saveNewRole()" class="btn-primary flex-1 py-2 rounded-lg">Create Role</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Show Edit Role Modal
function showEditRoleModal(roleId) {
    const role = securityRoles.find(r => r.id === roleId);
    if (!role) return;
    
    const allPermissions = [
        // Security - User Management
        { category: 'ðŸ” User Management', permissions: [
            { id: 'users:view', name: 'View Users' },
            { id: 'users:edit', name: 'Edit Users' },
            { id: 'users:delete', name: 'Delete Users' },
            { id: 'users:invite', name: 'Invite Users' },
        ]},
        // Security - Role Management
        { category: 'ðŸ” Role Management', permissions: [
            { id: 'roles:view', name: 'View Roles' },
            { id: 'roles:create', name: 'Create Roles' },
            { id: 'roles:edit', name: 'Edit Roles' },
            { id: 'roles:delete', name: 'Delete Roles' },
        ]},
        // Security - Security & MFA
        { category: 'ðŸ” Security & MFA', permissions: [
            { id: 'security:settings', name: 'Security Settings' },
            { id: 'mfa:manage', name: 'Manage MFA' },
        ]},
        // AI Agent - Agents
        { category: 'ðŸ¤– AI Agents', permissions: [
            { id: 'agents:view', name: 'View Agents' },
            { id: 'agents:create', name: 'Create Agents' },
            { id: 'agents:edit', name: 'Edit Agents' },
            { id: 'agents:delete', name: 'Delete Agents' },
            { id: 'agents:publish', name: 'Publish Agents' },
        ]},
        // AI Agent - Tools
        { category: 'ðŸ¤– Tools & Integrations', permissions: [
            { id: 'tools:view', name: 'View Tools' },
            { id: 'tools:create', name: 'Create Tools' },
            { id: 'tools:edit', name: 'Edit Tools' },
            { id: 'tools:delete', name: 'Delete Tools' },
            { id: 'tools:execute', name: 'Execute Tools' },
        ]},
        // AI Agent - Chat
        { category: 'ðŸ¤– Chat', permissions: [
            { id: 'chat:use', name: 'Use Chat' },
            { id: 'chat:view_all', name: 'View All Chats' },
            { id: 'chat:delete', name: 'Delete Chats' },
        ]},
        // Analytics & Audit
        { category: 'ðŸ“Š Analytics & Audit', permissions: [
            { id: 'audit:view', name: 'View Audit Logs' },
            { id: 'audit:export', name: 'Export Audit Logs' },
            { id: 'analytics:view', name: 'View Analytics' },
            { id: 'reports:generate', name: 'Generate Reports' },
        ]},
        // Demo Lab
        { category: 'ðŸ§ª Demo Lab', permissions: [
            { id: 'demo:access', name: 'Access Demo Lab' },
            { id: 'demo:create', name: 'Create Demos' },
            { id: 'demo:share', name: 'Share Demos' },
        ]},
        // System
        { category: 'âš™ï¸ System', permissions: [
            { id: 'system:admin', name: 'Full System Admin' },
            { id: 'system:settings', name: 'System Settings' },
        ]},
    ];
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm';
    modal.id = 'role-modal';
    modal.innerHTML = `
        <div class="card rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Edit Role: ${escHtml(role.name)}</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Role Name *</label>
                    <input type="text" id="role-name" value="${escHtml(role.name)}" class="input-field w-full px-4 py-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Description</label>
                    <textarea id="role-description" class="input-field w-full px-4 py-2 rounded-lg" rows="2">${escHtml(role.description || '')}</textarea>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm text-gray-400">Permissions</label>
                        <label class="flex items-center gap-2 text-sm text-green-400 cursor-pointer">
                            <input type="checkbox" id="select-all-edit" onchange="document.querySelectorAll('#role-modal .role-perm').forEach(c=>c.checked=this.checked)" class="rounded">
                            <span>Select All</span>
                        </label>
                    </div>
                    ${allPermissions.map((cat, i) => `
                        <div class="mb-4 p-3 rounded-lg" style="background:rgba(139,92,246,0.1)">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-sm font-semibold text-purple-400">${cat.category}</h5>
                                <label class="flex items-center gap-1 text-xs text-gray-400 cursor-pointer">
                                    <input type="checkbox" onchange="document.querySelectorAll('#role-modal .cat-${i}').forEach(c=>c.checked=this.checked)" class="rounded">
                                    <span>All</span>
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                ${cat.permissions.map(p => `
                                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                                        <input type="checkbox" class="role-perm cat-${i} rounded" value="${p.id}" ${(role.permissions || []).includes(p.id) ? 'checked' : ''}>
                                        <span>${p.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="document.getElementById('role-modal').remove()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                    <button onclick="updateRole('${roleId}')" class="btn-primary flex-1 py-2 rounded-lg">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Save new role
async function saveNewRole() {
    const name = document.getElementById('role-name').value.trim();
    const description = document.getElementById('role-description').value.trim();
    const permissions = Array.from(document.querySelectorAll('.role-perm:checked')).map(cb => cb.value);
    
    if (!name) {
        showToast('Role name is required', 'error');
        return;
    }
    
    try {
        const res = await fetch('/api/security/roles', {
            method: 'POST',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, permissions })
        });
        
        if (res.ok) {
            showToast('Role created successfully', 'success');
            document.getElementById('role-modal').remove();
            loadSecurityRoles();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to create role', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

// Update existing role
async function updateRole(roleId) {
    const name = document.getElementById('role-name').value.trim();
    const description = document.getElementById('role-description').value.trim();
    const permissions = Array.from(document.querySelectorAll('.role-perm:checked')).map(cb => cb.value);
    
    if (!name) {
        showToast('Role name is required', 'error');
        return;
    }
    
    try {
        const res = await fetch('/api/security/roles/' + roleId, {
            method: 'PUT',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, permissions })
        });
        
        if (res.ok) {
            showToast('Role updated successfully', 'success');
            document.getElementById('role-modal').remove();
            loadSecurityRoles();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to update role', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

// Delete role
async function deleteRole(roleId) {
    const role = securityRoles.find(r => r.id === roleId);
    if (!role) return;
    
    if (role.is_system) {
        showToast('Cannot delete system roles', 'error');
        return;
    }
    
    if (!confirm('Are you sure you want to delete the role "' + role.name + '"?')) return;
    
    try {
        const res = await fetch('/api/security/roles/' + roleId, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        
        if (res.ok) {
            showToast('Role deleted successfully', 'success');
            loadSecurityRoles();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showToast(data.detail || 'Failed to delete role', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

function renderSecurityRoles() {
    const icons = { 'role_super_admin': 'ðŸ‘‘', 'role_admin': 'ðŸ›¡ï¸', 'role_manager': 'ðŸ“Š', 'role_user': 'ðŸ‘¤', 'role_viewer': 'ðŸ‘ï¸' };
    
    document.getElementById('sec-roles-grid').innerHTML = securityRoles.map(r => `
        <div class="card rounded-xl p-4 hover:border-purple-500/50 transition-colors">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">${icons[r.id] || 'ðŸŽ­'}</span>
                    <h4 class="font-bold">${escHtml(r.name)}</h4>
                    ${r.is_system ? '<span class="text-xs bg-gray-600 px-2 py-1 rounded ml-2">System</span>' : ''}
                </div>
                <div class="flex items-center gap-2">
                    <button data-permission="roles:edit" onclick="showEditRoleModal('${r.id}')" class="text-blue-400 hover:text-blue-300" title="Edit Permissions">âœï¸</button>
                    ${!r.is_system ? `<button data-permission="roles:delete" onclick="deleteRole('${r.id}')" class="text-red-400 hover:text-red-300" title="Delete">ðŸ—‘ï¸</button>` : ''}
                </div>
            </div>
            <p class="text-sm text-gray-400 mb-3">${escHtml(r.description || 'No description')}</p>
            <div class="flex items-center justify-between text-sm">
                <span class="text-purple-400">${(r.permissions || []).length} permissions</span>
                <span class="text-gray-500">${r.user_count || 0} users</span>
            </div>
        </div>
    `).join('');
}

// Switch security tab
function switchSecurityTab(tab) {
    const tabs = ['users', 'roles', 'groups', 'audit', 'mfa', 'settings'];
    
    // Check if requested tab is visible (has permission)
    const requestedTabBtn = document.getElementById('sec-tab-' + tab);
    if (requestedTabBtn && requestedTabBtn.style.display === 'none') {
        // Find first visible tab
        for (const t of tabs) {
            const btn = document.getElementById('sec-tab-' + t);
            if (btn && btn.style.display !== 'none') {
                tab = t;
                break;
            }
        }
    }
    
    // Hide all tabs
    tabs.forEach(t => {
        document.getElementById('sec-content-' + t)?.classList.add('hidden');
        const tabBtn = document.getElementById('sec-tab-' + t);
        if (tabBtn) {
            tabBtn.classList.remove('bg-purple-600', 'text-white');
            tabBtn.classList.add('hover:bg-gray-700');
        }
    });
    
    // Show selected tab
    document.getElementById('sec-content-' + tab)?.classList.remove('hidden');
    const activeBtn = document.getElementById('sec-tab-' + tab);
    if (activeBtn) {
        activeBtn.classList.add('bg-purple-600', 'text-white');
        activeBtn.classList.remove('hover:bg-gray-700');
    }
    
    // Load tab data
    if (tab === 'audit') loadAuditLogs();
    if (tab === 'mfa') checkMfaStatus();
    if (tab === 'settings') loadSecuritySettings();
    if (tab === 'groups') loadGroups();
}

// Initialize security page
async function initSecurityPage() {
    // Load data first - roles must be loaded before users to display role names
    await loadSecurityStats();
    await loadSecurityRoles(); // Load roles first
    await loadSecurityUsers(); // Then load users (so role names can be displayed)
    await loadSecurityInvitations();
    
    // Find first visible tab and switch to it
    const tabs = ['users', 'roles', 'audit', 'mfa', 'settings'];
    let foundTab = 'mfa'; // Default fallback
    
    for (const t of tabs) {
        const btn = document.getElementById('sec-tab-' + t);
        if (btn && btn.style.display !== 'none') {
            foundTab = t;
            break;
        }
    }
    
    switchSecurityTab(foundTab);
}

// Load audit logs
async function loadAuditLogs() {
    const action = document.getElementById('sec-audit-action')?.value || '';
    
    try {
        let url = '/api/security/audit-logs?limit=100';
        if (action) url += '&action=' + action;
        
        const res = await fetch(url, { headers: getAuthHeaders() });
        if (!res.ok) return;
        
        const data = await res.json();
        console.log("Login response:", data);
        const logs = data.logs || [];
        
        if (!logs.length) {
            document.getElementById('sec-audit-table').innerHTML = 
                '<tr><td colspan="6" class="p-8 text-center text-gray-500">No audit logs found</td></tr>';
            return;
        }
        
        document.getElementById('sec-audit-table').innerHTML = logs.map(l => `
            <tr class="border-t border-gray-700">
                <td class="p-4 text-sm">${new Date(l.timestamp).toLocaleString()}</td>
                <td class="p-4">${escHtml(l.user_email || 'System')}</td>
                <td class="p-4"><span class="px-2 py-1 rounded text-xs bg-blue-600/30 text-blue-400">${l.action}</span></td>
                <td class="p-4 text-sm">${escHtml(l.resource_type || '-')}</td>
                <td class="p-4 text-sm text-gray-400">${l.ip_address || '-'}</td>
                <td class="p-4 text-center">${l.success ? '<span class="text-green-400">âœ“</span>' : '<span class="text-red-400">âœ—</span>'}</td>
            </tr>
        `).join('');
    } catch (e) {
        console.error('Error loading audit logs:', e);
    }
}

// Export audit logs
async function exportAuditLogs() {
    showToast('Exporting audit logs...', 'info');
    try {
        const res = await fetch('/api/security/audit-logs/export', { headers: getAuthHeaders() });
        if (!res.ok) throw new Error('Export failed');
        
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'audit-logs-' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Audit logs exported', 'success');
    } catch (e) {
        showToast('Export failed: ' + e.message, 'error');
    }
}

// Check MFA status



function selectMfaMode(mode) {
    document.querySelector(`input[name="mfa-mode"][value="${mode}"]`).checked = true;
    saveMfaSettings();
}

async function saveMfaSettings() {
    const mode = document.querySelector('input[name="mfa-mode"]:checked')?.value || 'off';
    
    try {
        const res = await fetch('/api/security/settings', {
            method: 'PUT',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ mfa_enforcement: mode })
        });
        
        if (res.ok) {
            const status = document.getElementById('mfa-save-status');
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 2000);
            checkMfaStatus();
        } else {
            showToast('Failed to save settings', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

async function loadMfaAdminSettings() {
    try {
        const res = await fetch('/api/security/settings', { headers: getAuthHeaders() });
        if (!res.ok) return;
        
        const settings = await res.json();
        const mode = settings.mfa_enforcement || 'off';
        
        // Set radio button
        const radio = document.querySelector(`input[name="mfa-mode"][value="${mode}"]`);
        if (radio) radio.checked = true;
    } catch (e) {
        console.error('Error loading MFA settings:', e);
    }
}

async function checkMfaStatus() {
    // Load admin settings if admin
    loadMfaAdminSettings();
    
    try {
        // Get user info
        const userRes = await fetch('/api/security/auth/me', { headers: getAuthHeaders() });
        if (!userRes.ok) return;
        const userData = await userRes.json();
        
        // Get security settings
        const settingsRes = await fetch('/api/security/settings', { headers: getAuthHeaders() });
        const settings = settingsRes.ok ? await settingsRes.json() : {};
        
        const userMfaEnabled = userData.user?.mfa_enabled || false;
        const enforcement = settings.mfa_enforcement || 'off';
        
        // Update status badge
        const badge = document.getElementById('mfa-status-badge');
        const statusText = document.getElementById('mfa-status-text');
        
        if (badge && statusText) {
            if (enforcement === 'off') {
                badge.innerHTML = '<span class="px-3 py-1 rounded-full text-sm bg-gray-600 text-gray-300">Disabled</span>';
                statusText.textContent = 'MFA is turned off for your organization';
            } else if (enforcement === 'optional') {
                badge.innerHTML = userMfaEnabled 
                    ? '<span class="px-3 py-1 rounded-full text-sm bg-green-500/20 text-green-400">âœ“ Active</span>'
                    : '<span class="px-3 py-1 rounded-full text-sm bg-yellow-500/20 text-yellow-400">Optional</span>';
                statusText.textContent = userMfaEnabled ? 'MFA is active on your account' : 'MFA is optional - you can enable it below';
            } else if (enforcement === 'admins') {
                badge.innerHTML = '<span class="px-3 py-1 rounded-full text-sm bg-blue-500/20 text-blue-400">Admins Only</span>';
                statusText.textContent = 'MFA is required for administrators';
            } else {
                badge.innerHTML = '<span class="px-3 py-1 rounded-full text-sm bg-green-500/20 text-green-400">âœ“ Required</span>';
                statusText.textContent = 'MFA is required for all users';
            }
        }
        
        // Show user toggle only for Optional mode
        const userToggleSection = document.getElementById('mfa-user-toggle-section');
        if (userToggleSection) {
            if (enforcement === 'optional') {
                userToggleSection.classList.remove('hidden');
                const userEnabledCheckbox = document.getElementById('mfa-user-enabled');
                if (userEnabledCheckbox) userEnabledCheckbox.checked = userMfaEnabled;
            } else {
                userToggleSection.classList.add('hidden');
            }
        }
        
    } catch (e) {
        console.error('Error checking MFA status:', e);
    }
}

async function toggleUserMFA() {
    const checkbox = document.getElementById('mfa-user-enabled');
    const newState = checkbox.checked;
    
    try {
        const res = await fetch('/api/security/mfa/user-toggle', {
            method: 'POST',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: newState })
        });
        
        if (res.ok) {
            showToast(newState ? 'MFA enabled for your account' : 'MFA disabled for your account', 'success');
            checkMfaStatus();
        } else {
            const data = await res.json();
            showToast(data.detail || 'Failed to update MFA', 'error');
            checkbox.checked = !newState;
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
        checkbox.checked = !newState;
    }
}

function showInviteModal() {
    // Load groups for selection
    const groupsHtml = allGroups.map(g => `
        <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-700 cursor-pointer">
            <input type="checkbox" class="invite-group accent-purple-500" value="${g.id}">
            <span>ðŸ‘¥ ${g.name}</span>
        </label>
    `).join('') || '<p class="text-gray-500 text-sm p-2">No groups yet. Create groups in the Groups tab.</p>';
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[9999]';
    modal.id = 'invite-modal';
    modal.innerHTML = `
        <div class="card rounded-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">ðŸ“¨ Invite User</h3>
            <div class="space-y-4">
                <!-- Email -->
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Email Address *</label>
                    <input type="email" id="invite-email" placeholder="user@company.com" class="input-field w-full px-4 py-2 rounded-lg">
                </div>
                
                <!-- Portal Access -->
                <div>
                    <label class="block text-sm text-gray-400 mb-2">ðŸŽ« Portal Access</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-600 hover:border-purple-500 cursor-pointer transition" onclick="togglePortalAccess('admin')">
                            <input type="checkbox" id="invite-admin-access" class="accent-purple-500 w-5 h-5" onchange="updateInviteUI()">
                            <div>
                                <div class="font-medium">ðŸ–¥ï¸ Admin Portal</div>
                                <div class="text-xs text-gray-400">Manage platform</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-600 hover:border-purple-500 cursor-pointer transition" onclick="togglePortalAccess('enduser')">
                            <input type="checkbox" id="invite-enduser-access" class="accent-purple-500 w-5 h-5" onchange="updateInviteUI()" checked>
                            <div>
                                <div class="font-medium">ðŸ’¬ End User Portal</div>
                                <div class="text-xs text-gray-400">Use AI agents</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Admin Role (shown when admin portal selected) -->
                <div id="invite-admin-section" class="hidden">
                    <label class="block text-sm text-gray-400 mb-1">ðŸŽ­ Admin Role</label>
                    <select id="invite-role" class="input-field w-full px-4 py-2 rounded-lg">
                        ${securityRoles.filter(r => !r.name.toLowerCase().includes('end user')).map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                    </select>
                </div>
                
                <!-- User Groups (shown when end user portal selected) -->
                <div id="invite-groups-section">
                    <label class="block text-sm text-gray-400 mb-2">ðŸ‘¥ User Groups</label>
                    <p class="text-xs text-gray-500 mb-2">Groups determine which AI agents this user can access</p>
                    <div class="max-h-40 overflow-y-auto rounded-lg border border-gray-700 p-2 space-y-1">
                        ${groupsHtml}
                    </div>
                </div>
                
                <div class="flex gap-2 pt-4">
                    <button onclick="document.getElementById('invite-modal').remove()" class="btn-secondary px-4 py-2 rounded-lg flex-1">Cancel</button>
                    <button onclick="sendInvite()" class="btn-primary px-4 py-2 rounded-lg flex-1">ðŸ“§ Send Invite</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Initialize UI state
    updateInviteUI();
}

function togglePortalAccess(type) {
    // Allow the checkbox to toggle naturally
}

function updateInviteUI() {
    const adminAccess = document.getElementById('invite-admin-access')?.checked;
    const endUserAccess = document.getElementById('invite-enduser-access')?.checked;
    
    const adminSection = document.getElementById('invite-admin-section');
    const groupsSection = document.getElementById('invite-groups-section');
    
    if (adminSection) {
        adminSection.classList.toggle('hidden', !adminAccess);
    }
    if (groupsSection) {
        groupsSection.classList.toggle('hidden', !endUserAccess);
    }
}

// Send invite
async function sendInvite() {
    const email = document.getElementById('invite-email')?.value;
    const adminAccess = document.getElementById('invite-admin-access')?.checked;
    const endUserAccess = document.getElementById('invite-enduser-access')?.checked;
    const role = document.getElementById('invite-role')?.value;
    const selectedGroups = Array.from(document.querySelectorAll('.invite-group:checked')).map(cb => cb.value);
    
    if (!email) {
        showToast('Please enter an email', 'error');
        return;
    }
    
    if (!adminAccess && !endUserAccess) {
        showToast('Please select at least one portal access', 'error');
        return;
    }
    
    try {
        const inviteData = { 
            email, 
            role_ids: adminAccess && role ? [role] : [],
            group_ids: selectedGroups,
            has_admin_access: adminAccess,
            has_enduser_access: endUserAccess
        };
        
        const res = await fetch('/api/security/users/invite', {
            method: 'POST',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify(inviteData)
        });
        
        if (res.ok) {
            showToast('Invitation sent!', 'success');
            document.getElementById('invite-modal')?.remove();
            loadSecurityUsers();
            loadSecurityStats();
        } else {
            const data = await res.json();
            console.log("Invite response:", data);
            showToast(data.detail || 'Failed to send invite', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}


// Load security settings into form
async function loadSecuritySettings() {
    try {
        const res = await fetch('/api/security/settings', { headers: getAuthHeaders() });
        if (!res.ok) return;
        
        const settings = await res.json();
        
        // Populate select fields
        const mfaEnforcement = document.getElementById('sec-setting-mfa_enforcement');
        if (mfaEnforcement) mfaEnforcement.value = settings.mfa_enforcement || 'off';
        
        const lockoutAttempts = document.getElementById('sec-setting-lockout_attempts');
        if (lockoutAttempts) lockoutAttempts.value = settings.account_lockout_attempts || 5;
        
        const lockoutDuration = document.getElementById('sec-setting-lockout_duration');
        if (lockoutDuration) lockoutDuration.value = settings.account_lockout_duration_minutes || 30;
        
        // Populate checkboxes
        const mfaOptout = document.getElementById('sec-setting-mfa_allow_user_optout');
        if (mfaOptout) mfaOptout.checked = settings.mfa_allow_user_optout || false;
        
    } catch (e) {
        console.error('Error loading security settings:', e);
    }
}

// Save security settings
async function saveSecuritySettings() {
    const form = document.getElementById('security-settings-form');
    const formData = new FormData(form);
    const settings = {};
    
    for (const [key, value] of formData.entries()) {
        settings[key] = value;
    }
    
    // Handle checkboxes
    form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        settings[cb.name] = cb.checked;
    });
    
    try {
        const res = await fetch('/api/security/settings', {
            method: 'PUT',
            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        if (res.ok) {
            showToast('Settings saved!', 'success');
        } else {
            showToast('Failed to save settings', 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
    }
}

// Toast notification - uses global NotificationSystem (defined earlier)
// showToast function is already defined in the NotificationSystem section

// Update navigate function to include security
const originalNavigate = navigate;
navigate = function(p, updateHash = true) {
    // DEBUG: Log only create navigation
    if (p === 'create') {
        console.log('ðŸŽ¯ [CREATE] navigate override called', { hasAuth: !!authToken, hasPerm: hasPermission('agents:create') });
    }
    
    // Check auth for protected pages
    if (!authToken && p !== 'login') {
        showLoginPage();
        return;
    }
    
    // Hide login if showing app
    if (authToken && p !== 'login') {
        document.getElementById('page-login')?.classList.add('hidden');
        document.getElementById('app')?.classList.remove('hidden');
    }
    
    // Check permissions for protected pages
    const requiredPerm = MENU_PERMISSIONS[p];
    if (requiredPerm && !hasPermission(requiredPerm)) {
        if (p === 'create') console.log('ðŸŽ¯ [CREATE] Permission denied!');
        showToast(`You don't have permission to access ${p}`, 'error');
        return;
    }
    
    // Call original navigate
    originalNavigate(p, updateHash);
    
    // Initialize security page
    if (p === 'security') initSecurityPage();
};

// Handle reset password page
function showSpecialPage() {
    document.getElementById('loading-screen')?.classList.add('hidden');
    document.getElementById('page-login').classList.add('visible');
    document.getElementById('app').classList.add('hidden');
}

function showResetPasswordPage(token) {
    showSpecialPage();
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
            <p class="text-gray-400">Create new password</p>
        </div>
        <div class="card rounded-2xl p-8">
            <h2 class="text-xl font-bold mb-6">Reset Password</h2>
            
            <form onsubmit="handleResetPassword(event, '${token}')">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">New Password</label>
                        <div class="relative">
                            <input type="password" id="reset-password" required minlength="8"
                                   class="input-field w-full px-4 py-3 pr-12 rounded-lg"
                                   placeholder="Min 8 characters"
                                   oninput="checkPasswordStrength(this.value)">
                            <button type="button" onclick="togglePassword('reset-password', this)" 
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1">
                                <span class="eye-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>
                            </button>
                        </div>
                        <div class="mt-2">
                            <div class="flex gap-1 mb-1">
                                <div id="str-1" class="h-1 flex-1 rounded bg-gray-600"></div>
                                <div id="str-2" class="h-1 flex-1 rounded bg-gray-600"></div>
                                <div id="str-3" class="h-1 flex-1 rounded bg-gray-600"></div>
                                <div id="str-4" class="h-1 flex-1 rounded bg-gray-600"></div>
                            </div>
                            <p id="str-text" class="text-xs text-gray-500"></p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Confirm Password</label>
                        <div class="relative">
                            <input type="password" id="reset-password2" required
                                   class="input-field w-full px-4 py-3 pr-12 rounded-lg"
                                   placeholder="Repeat password">
                            <button type="button" onclick="togglePassword('reset-password2', this)" 
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1">
                                <span class="eye-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg></span>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" id="reset-btn"
                            class="btn-primary w-full py-3 rounded-lg font-semibold">
                        Reset Password
                    </button>
                </div>
            </form>
        </div>
    `;
}

// Handle reset password submit
async function handleResetPassword(event, token) {
    event.preventDefault();
    
    const password = document.getElementById('reset-password').value;
    const password2 = document.getElementById('reset-password2').value;
    
    if (password !== password2) {
        showToast('Passwords do not match', 'error');
        return;
    }
    
    if (password.length < 8) {
        showToast('Password must be at least 8 characters', 'error');
        return;
    }
    
    const btn = document.getElementById('reset-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin inline-block">â³</span> Resetting...';
    
    try {
        const res = await fetch('/api/security/auth/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, new_password: password })
        });
        
        const data = await res.json();
        console.log("Login response:", data);
        
        if (res.ok) {
            showResetPasswordSuccess();
        } else {
            showToast(data.detail || 'Reset failed. Link may have expired.', 'error');
            btn.disabled = false;
            btn.textContent = 'Reset Password';
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Reset Password';
    }
}

// Show reset password success
function showResetPasswordSuccess() {
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
        </div>
        <div class="card rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h2 class="text-xl font-bold mb-2">Password Reset!</h2>
            <p class="text-gray-400 mb-6">
                Your password has been reset successfully.<br>
                You can now sign in with your new password.
            </p>
            <button onclick="window.location.href='/ui/'" class="btn-primary w-full py-3 rounded-lg font-semibold">
                Sign In Now
            </button>
        </div>
    `;
}

// Handle email verification page
function showVerifyEmailPage(token) {
    showSpecialPage();
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
        </div>
        <div class="card rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="animate-spin text-2xl">â³</span>
            </div>
            <h2 class="text-xl font-bold mb-2">Verifying Email...</h2>
            <p class="text-gray-400">Please wait while we verify your email.</p>
        </div>
    `;
    
    // Call verify API
    verifyEmail(token);
}

// Verify email API call
async function verifyEmail(token) {
    try {
        const res = await fetch('/api/security/auth/verify-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
        });
        
        if (res.ok) {
            showVerifyEmailSuccess();
        } else {
            const data = await res.json();
        console.log("Login response:", data);
            showVerifyEmailError(data.detail || 'Verification failed');
        }
    } catch (e) {
        showVerifyEmailError('Error verifying email');
    }
}

// Show verification success
function showVerifyEmailSuccess() {
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
        </div>
        <div class="card rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h2 class="text-xl font-bold mb-2">Email Verified!</h2>
            <p class="text-gray-400 mb-6">
                Your email has been verified successfully.<br>
                You can now sign in to your account.
            </p>
            <button onclick="window.location.href='/ui/'" class="btn-primary w-full py-3 rounded-lg font-semibold">
                Sign In Now
            </button>
        </div>
    `;
}

// Show verification error
function showVerifyEmailError(message) {
    document.getElementById('auth-container').innerHTML = `
        <div class="text-center mb-8">
            <div class="inline-flex items-center gap-3 mb-4">
                <img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">
                <h1 class="text-3xl font-bold gradient-text">AgentForge</h1>
            </div>
        </div>
        <div class="card rounded-2xl p-8 text-center">
            <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </div>
            <h2 class="text-xl font-bold mb-2">Verification Failed</h2>
            <p class="text-gray-400 mb-6">${message}</p>
            <button onclick="location.reload()" class="btn-primary w-full py-3 rounded-lg font-semibold">
                Back to Sign In
            </button>
        </div>
    `;
}


// Show invitation register form
function showInvitationRegister(token) {
    showSpecialPage();
    document.getElementById('page-login').classList.remove('hidden');
    document.getElementById('app').classList.add('hidden');
    
    var eyeIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/></svg>';
    
    document.getElementById('auth-container').innerHTML = 
        '<div class="text-center mb-8">' +
            '<div class="inline-flex items-center gap-3 mb-4">' +
                '<img src="/AgentForge_Logo.png" alt="AgentForge" class="w-16 h-16 rounded-xl">' +
                '<h1 class="text-3xl font-bold gradient-text">AgentForge</h1>' +
            '</div>' +
            '<p class="text-gray-400">Complete your registration</p>' +
        '</div>' +
        '<div class="card rounded-2xl p-8">' +
            '<h2 class="text-xl font-bold mb-6">Accept Invitation</h2>' +
            '<form onsubmit="handleInvitationRegister(event, \'' + token + '\')">' +
                '<div class="space-y-4">' +
                    '<div class="grid grid-cols-2 gap-4">' +
                        '<div><label class="block text-sm text-gray-400 mb-2">First Name</label>' +
                        '<input type="text" id="inv-firstname" required class="input-field w-full px-4 py-3 rounded-lg" placeholder="John"></div>' +
                        '<div><label class="block text-sm text-gray-400 mb-2">Last Name</label>' +
                        '<input type="text" id="inv-lastname" required class="input-field w-full px-4 py-3 rounded-lg" placeholder="Doe"></div>' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-sm text-gray-400 mb-2">Password</label>' +
                        '<div class="relative">' +
                            '<input type="password" id="inv-password" required minlength="8" class="input-field w-full px-4 py-3 pr-12 rounded-lg" placeholder="Min 8 characters" oninput="checkPasswordStrength(this.value)">' +
                            '<button type="button" onclick="togglePassword(\'inv-password\', this)" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1"><span class="eye-icon">' + eyeIcon + '</span></button>' +
                        '</div>' +
                        '<div class="mt-2"><div class="flex gap-1 mb-1"><div id="str-1" class="h-1 flex-1 rounded bg-gray-600"></div><div id="str-2" class="h-1 flex-1 rounded bg-gray-600"></div><div id="str-3" class="h-1 flex-1 rounded bg-gray-600"></div><div id="str-4" class="h-1 flex-1 rounded bg-gray-600"></div></div><p id="str-text" class="text-xs text-gray-500"></p></div>' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-sm text-gray-400 mb-2">Confirm Password</label>' +
                        '<div class="relative">' +
                            '<input type="password" id="inv-confirm-password" required minlength="8" class="input-field w-full px-4 py-3 pr-12 rounded-lg" placeholder="Confirm password">' +
                            '<button type="button" onclick="togglePassword(\'inv-confirm-password\', this)" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white p-1"><span class="eye-icon">' + eyeIcon + '</span></button>' +
                        '</div>' +
                    '</div>' +
                    '<div id="inv-error" class="hidden bg-red-500/20 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg text-sm"></div>' +
                    '<button type="submit" id="inv-submit-btn" class="w-full py-3 rounded-lg font-semibold text-white" style="background: var(--accent-gradient);">Create Account</button>' +
                '</div>' +
            '</form>' +
        '</div>';
}

// Handle invitation register
async function handleInvitationRegister(event, token) {
    event.preventDefault();
    var firstName = document.getElementById('inv-firstname').value;
    var lastName = document.getElementById('inv-lastname').value;
    var password = document.getElementById('inv-password').value;
    var confirmPassword = document.getElementById('inv-confirm-password').value;
    var errorDiv = document.getElementById('inv-error');
    var btn = document.getElementById('inv-submit-btn');
    errorDiv.classList.add('hidden');
    if (password !== confirmPassword) { 
        errorDiv.textContent = 'Passwords do not match'; 
        errorDiv.classList.remove('hidden'); 
        return; 
    }
    btn.disabled = true; 
    btn.textContent = 'Creating account...';
    try {
        var res = await fetch('/api/security/auth/accept-invitation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                token: token,
                first_name: firstName, 
                last_name: lastName, 
                password: password 
            })
        });
        var data = await res.json();
        if (!res.ok) { 
            errorDiv.textContent = data.detail || 'Registration failed'; 
            errorDiv.classList.remove('hidden'); 
            btn.disabled = false; 
            btn.textContent = 'Create Account'; 
            return; 
        }
        showToast('Account created! Please sign in.', 'success');
        window.location.hash = '';
        location.reload();
    } catch (e) { 
        errorDiv.textContent = 'Error: ' + e.message; 
        errorDiv.classList.remove('hidden'); 
    }
    btn.disabled = false; 
    btn.textContent = 'Create Account';
}

// ============================================================================
// Profile Page Functions
// ============================================================================

let currentUserProfile = null;

async function loadProfileInfo() {
    try {
        const res = await fetch(API + '/api/security/auth/me', {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (!res.ok) {
            throw new Error('Failed to load profile');
        }
        
        const data = await res.json();
        currentUserProfile = data;
        
        // Update profile info display
        const emailEl = document.getElementById('profile-email');
        if (emailEl) emailEl.value = data.email || '';
        
        const roleEl = document.getElementById('profile-role');
        if (roleEl) roleEl.textContent = data.roles?.map(r => r.name).join(', ') || 'User';
        
        // Format created date
        const createdEl = document.getElementById('profile-created');
        if (createdEl) {
            if (data.profile?.created_at) {
                const date = new Date(data.profile.created_at);
                createdEl.textContent = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            } else {
                createdEl.textContent = 'N/A';
            }
        }
        
        // Populate edit form
        document.getElementById('update-first-name').value = data.profile?.first_name || '';
        document.getElementById('update-last-name').value = data.profile?.last_name || '';
        document.getElementById('update-display-name').value = data.profile?.display_name || '';
        
        // Update MFA status
        updateMFAStatus(data);
        
    } catch (error) {
        console.error('Error loading profile:', error);
        showToast('Failed to load profile information', 'error');
    }
}

function updateMFAStatus(userData) {
    // Support both formats: mfa.method (singular) and mfa_methods (array) for backward compatibility
    const mfaEnabled = userData.mfa?.enabled || userData.mfa_enabled || false;
    let mfaMethod = userData.mfa?.method || 'none';
    
    // If mfa.method is not available, try to get from mfa_methods array
    if (mfaMethod === 'none' && userData.mfa_methods && userData.mfa_methods.length > 0) {
        mfaMethod = userData.mfa_methods[0];
    }
    // Also check mfa.methods array (nested)
    if (mfaMethod === 'none' && userData.mfa?.methods && userData.mfa.methods.length > 0) {
        mfaMethod = userData.mfa.methods[0];
    }
    
    const statusText = document.getElementById('mfa-status-text');
    const toggle = document.getElementById('mfa-toggle');
    const toggleDot = document.getElementById('mfa-toggle-dot');
    
    if (mfaEnabled) {
        statusText.textContent = `Enabled (${mfaMethod.toUpperCase()})`;
        // Toggle ON - green background, dot to the right
        if (toggle) {
            toggle.classList.remove('bg-red-500');
            toggle.classList.add('bg-green-500');
            toggle.dataset.enabled = 'true';
        }
        if (toggleDot) {
            toggleDot.classList.remove('translate-x-1');
            toggleDot.classList.add('translate-x-8');
        }
    } else {
        statusText.textContent = 'Disabled';
        // Toggle OFF - red background, dot to the left
        if (toggle) {
            toggle.classList.remove('bg-green-500');
            toggle.classList.add('bg-red-500');
            toggle.dataset.enabled = 'false';
        }
        if (toggleDot) {
            toggleDot.classList.remove('translate-x-8');
            toggleDot.classList.add('translate-x-1');
        }
    }
}

function toggleMFA() {
    const toggle = document.getElementById('mfa-toggle');
    const isEnabled = toggle?.dataset.enabled === 'true';
    
    if (isEnabled) {
        // Currently enabled, user wants to disable
        showDisableMFAModal();
    } else {
        // Currently disabled, user wants to enable
        showMFASetupModal();
    }
}

// Update Profile Form Handler - Wrapped for safety
function initProfileFormHandler() {
    const form = document.getElementById('update-profile-form');
    console.log('ðŸ”§ Profile form element:', form);
    
    if (!form) {
        console.error('âŒ Profile form not found!');
        return;
    }
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const firstNameInput = document.getElementById('update-first-name');
        const lastNameInput = document.getElementById('update-last-name');
        const displayNameInput = document.getElementById('update-display-name');
        
        console.log('ðŸ“ Profile Update Debug:');
        console.log('   First Name Input:', firstNameInput, '=', firstNameInput?.value);
        console.log('   Last Name Input:', lastNameInput, '=', lastNameInput?.value);
        console.log('   Display Name Input:', displayNameInput, '=', displayNameInput?.value);
        
        const firstName = firstNameInput?.value?.trim() || '';
        const lastName = lastNameInput?.value?.trim() || '';
        const displayName = displayNameInput?.value?.trim() || '';
        
        // IMPORTANT: Send empty string as is, not null, so it can update to empty
        const requestBody = {
            first_name: firstName,
            last_name: lastName,
            display_name: displayName || null
        };
        
        console.log('   Request Body:', JSON.stringify(requestBody));
        console.log('   User ID:', currentUserProfile?.id);
        
        try {
            const res = await fetch(API + `/api/security/users/${currentUserProfile.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(requestBody)
            });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Failed to update profile');
        }
        
            showToast('Profile updated successfully', 'success');
            await loadProfileInfo();
            await fetchCurrentUser(); // Refresh user info in sidebar
            
        } catch (error) {
            console.error('Error updating profile:', error);
            showToast(error.message || 'Failed to update profile', 'error');
        }
    });
}

// Initialize profile form on load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initProfileFormHandler);
} else {
    initProfileFormHandler();
}

// Change Password Form Handler
document.getElementById('change-password-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    const errorDiv = document.getElementById('password-error');
    
    // Validate passwords match
    if (newPassword !== confirmPassword) {
        if (errorDiv) {
            errorDiv.textContent = 'New passwords do not match';
            errorDiv.classList.remove('hidden');
        }
        return;
    }
    
    // Validate password strength
    if (newPassword.length < 8) {
        if (errorDiv) {
            errorDiv.textContent = 'Password must be at least 8 characters long';
            errorDiv.classList.remove('hidden');
        }
        return;
    }
    
    try {
        const res = await fetch(API + '/api/security/auth/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Failed to change password');
        }
        
        showToast('Password changed successfully', 'success');
        
        // Clear form and close modal
        document.getElementById('change-password-form').reset();
        hideChangePasswordModal();
        
    } catch (error) {
        console.error('Error changing password:', error);
        if (errorDiv) {
            errorDiv.textContent = error.message || 'Failed to change password';
            errorDiv.classList.remove('hidden');
        }
    }
});

// MFA Functions
async function startMFASetup() {
    const selectedType = document.querySelector('input[name="mfa-type"]:checked').value;
    
    try {
        const res = await fetch(API + '/api/security/mfa/enable', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                method: selectedType
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Failed to start MFA setup');
        }
        
        const data = await res.json();
        
        if (selectedType === 'totp') {
            showTOTPSetup(data);
        } else if (selectedType === 'email') {
            showEmailSetup();
        }
        
    } catch (error) {
        console.error('Error starting MFA setup:', error);
        showToast(error.message || 'Failed to start MFA setup', 'error');
    }
}

function showTOTPSetup(data) {
    // Show modal with TOTP setup
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">Setup Authenticator App</h3>
            <div class="text-center mb-4">
                <p class="text-sm text-gray-400 mb-4">Scan this QR code with your authenticator app</p>
                <div id="modal-qr-code" class="flex justify-center mb-4 bg-white p-4 rounded-lg"></div>
                <p class="text-xs text-gray-500 mb-2">Or enter this key manually:</p>
                <code class="bg-gray-700 px-3 py-1 rounded text-sm block">${data.secret}</code>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">Verification Code</label>
                <input type="text" id="modal-totp-code" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center text-lg tracking-wider" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
            </div>
            <div class="flex gap-3">
                <button onclick="closeMFAModal()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                <button onclick="verifyTOTPSetupModal('${data.secret}')" class="btn-primary flex-1 py-2 rounded-lg">Verify & Enable</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.id = 'mfa-setup-modal';
    
    // Generate QR code
    if (data.qr_code) {
        document.getElementById('modal-qr-code').innerHTML = `<img src="${data.qr_code}" alt="QR Code" class="w-48 h-48">`;
    }
}

function showEmailSetup() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">Verify Email MFA</h3>
            <div class="text-center mb-4">
                <p class="text-sm text-gray-400 mb-4">A verification code has been sent to your email</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">Verification Code</label>
                <input type="text" id="modal-email-code" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center text-lg tracking-wider" placeholder="000000" maxlength="6" pattern="[0-9]{6}">
            </div>
            <div class="flex gap-3">
                <button onclick="closeMFAModal()" class="btn-secondary flex-1 py-2 rounded-lg">Cancel</button>
                <button onclick="verifyEmailSetupModal()" class="btn-primary flex-1 py-2 rounded-lg">Verify & Enable</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.id = 'mfa-setup-modal';
}

function closeMFAModal() {
    const modal = document.getElementById('mfa-setup-modal');
    if (modal) {
        modal.remove();
    }
}

async function verifyTOTPSetupModal(secret) {
    const code = document.getElementById('modal-totp-code').value;
    
    if (!code || code.length !== 6) {
        showToast('Please enter a 6-digit code', 'error');
        return;
    }
    
    try {
        const res = await fetch(API + '/api/security/mfa/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                code: code,
                method: 'totp'
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Invalid verification code');
        }
        
        showToast('MFA enabled successfully!', 'success');
        closeMFAModal();
        await loadProfileInfo();
        
    } catch (error) {
        console.error('Error verifying TOTP:', error);
        showToast(error.message || 'Failed to verify code', 'error');
    }
}

async function verifyEmailSetupModal() {
    const code = document.getElementById('modal-email-code').value;
    
    if (!code || code.length !== 6) {
        showToast('Please enter a 6-digit code', 'error');
        return;
    }
    
    try {
        const res = await fetch(API + '/api/security/mfa/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                code: code,
                method: 'email'
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Invalid verification code');
        }
        
        showToast('Email MFA enabled successfully!', 'success');
        closeMFAModal();
        await loadProfileInfo();
        
    } catch (error) {
        console.error('Error verifying email code:', error);
        showToast(error.message || 'Failed to verify code', 'error');
    }
}

// Toggle password visibility
function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(inputId + '-icon');
    
    if (input.type === 'password') {
        input.type = 'text';
        // Eye open icon (showing password)
        icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        </svg>`;
    } else {
        input.type = 'password';
        // Eye closed icon (hiding password)
        icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
        </svg>`;
    }
}

function showChangePasswordModal() {
    const modal = document.getElementById('change-password-modal');
    if (modal) {
        ensureModalInBody('change-password-modal');
        modal.classList.remove('hidden');
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        document.getElementById('password-error')?.classList.add('hidden');
        document.getElementById('current-password').focus();
    }
}

function hideChangePasswordModal() {
    const modal = document.getElementById('change-password-modal');
    if (modal) modal.classList.add('hidden');
}

function showMFASetupModal() {
    // Show the MFA setup options in a modal-like way
    startMFASetup();
}

function showDisableMFAModal() {
    ensureModalInBody('disable-mfa-modal');
    const modal = document.getElementById('disable-mfa-modal');
    const input = document.getElementById('disable-mfa-password');
    const errorDiv = document.getElementById('disable-mfa-error');
    
    // Reset
    input.value = '';
    input.type = 'password';
    errorDiv.classList.add('hidden');
    
    modal.classList.remove('hidden');
    input.focus();
}

function hideDisableMFAModal() {
    document.getElementById('disable-mfa-modal').classList.add('hidden');
}

async function confirmDisableMFA() {
    const password = document.getElementById('disable-mfa-password').value;
    const errorDiv = document.getElementById('disable-mfa-error');
    
    if (!password) {
        errorDiv.textContent = 'Please enter your password';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    try {
        const res = await fetch(API + '/api/security/mfa/disable', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                password: password
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Failed to disable MFA');
        }
        
        hideDisableMFAModal();
        showToast('MFA disabled successfully', 'success');
        await loadProfileInfo();
        
    } catch (error) {
        console.error('Error disabling MFA:', error);
        errorDiv.textContent = error.message || 'Failed to disable MFA';
        errorDiv.classList.remove('hidden');
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    
    // Get token from localStorage FIRST
    authToken = localStorage.getItem('agentforge_token');
    const savedUser = localStorage.getItem('agentforge_user');
    if (savedUser) {
        try { currentUser = JSON.parse(savedUser); } catch(e) {}
    }
    
    // Fallback to sessionStorage
    if (!authToken) {
        authToken = sessionStorage.getItem('agentforge_token');
        const sessionUser = sessionStorage.getItem('agentforge_user');
        if (sessionUser) {
            try { currentUser = JSON.parse(sessionUser); } catch(e) {}
        }
    }
    
    // Handle special PUBLIC pages (no auth required)
    if (hash) {
        // Reset password page
        if (hash.includes('reset-password')) {
            const params = new URLSearchParams(hash.split('?')[1]);
            const token = params.get('token');
            if (token) {
                showResetPasswordPage(token);
                return;
            }
        }
        
        // Invitation register page
        if (hash.includes('register')) {
            const params = new URLSearchParams(hash.split('?')[1]);
            const token = params.get('token');
            if (token) {
                showInvitationRegister(token);
                return;
            }
        }
        
        // Verify email page
        if (hash.includes('verify-email')) {
            const params = new URLSearchParams(hash.split('?')[1]);
            const token = params.get('token');
            if (token) {
                showVerifyEmailPage(token);
                return;
            }
        }
        
        // MFA verification page (from OAuth callback)
        if (hash.includes('mfa-verify')) {
            console.log("ðŸ” [FRONTEND] Detected #mfa-verify in URL hash");
            const params = new URLSearchParams(hash.split('?')[1]);
            const sessionId = params.get('session_id');
            const email = params.get('email');
            const provider = params.get('provider');
            
            console.log("   Session ID:", sessionId);
            console.log("   Email:", email);
            console.log("   Provider:", provider);
            
            if (sessionId && email) {
                console.log("âœ… [FRONTEND] Showing MFA verification modal for OAuth login");
                // Store session info for MFA verification
                window.pendingMfaSessionId = sessionId;
                window.pendingMfaEmail = email;
                window.pendingMfaProvider = provider || 'google';
                
                // Show MFA modal with email method (default for OAuth)
                showLoginMfaModal(['email']);
                return;
            } else {
                console.error("âŒ [FRONTEND] Missing session_id or email in mfa-verify hash");
            }
        }
    }
    
    // Initialize wizard access control
    initWizardAccessControl();
    
    // Normal auth flow
    checkAuth();
});

    </script>

<!-- Tool Edit Slide-over Panel -->
<div id="tool-edit-panel" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/60" onclick="closeToolEditPanel()"></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-2xl bg-gray-900 shadow-2xl transform transition-transform duration-300 translate-x-full" id="tool-edit-slider">
        <div class="flex flex-col h-full">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <span id="edit-panel-icon" class="text-2xl">ðŸ”§</span>
                    <div>
                        <h2 class="font-bold text-lg">Edit Tool</h2>
                        <p id="edit-panel-type" class="text-xs text-gray-400">KNOWLEDGE BASE</p>
                    </div>
                </div>
                <button onclick="closeToolEditPanel()" class="p-2 hover:bg-gray-700 rounded-lg text-gray-400 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b border-gray-700">
                <button onclick="switchEditTab('basic')" class="edit-tab active flex-1 px-4 py-3 text-sm font-medium border-b-2 border-purple-500 text-purple-400" data-tab="basic">Basic Info</button>
                <button onclick="switchEditTab('config')" class="edit-tab flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="config">Configuration</button>
                <button onclick="switchEditTab('sources')" class="edit-tab flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="sources">Sources</button>
                <button onclick="switchEditTab('access')" class="edit-tab flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white" data-tab="access">ðŸ” Access</button>
            </div>
            
            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4">
                <input type="hidden" id="edit-tool-id">
                <input type="hidden" id="edit-tool-type">
                
                <!-- Basic Info Tab -->
                <div id="edit-tab-basic" class="edit-tab-content space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Name *</label>
                        <input type="text" id="edit-tool-name" class="input-field w-full px-4 py-2 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Description</label>
                        <textarea id="edit-tool-desc" rows="3" class="input-field w-full px-4 py-2 rounded-lg"></textarea>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="edit-tool-active" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-700 peer-focus:ring-2 peer-focus:ring-purple-500 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                        <span class="text-sm">Active</span>
                    </div>
                </div>
                
                <!-- Configuration Tab -->
                <div id="edit-tab-config" class="edit-tab-content hidden space-y-4">
                    <div id="edit-config-content">
                        <!-- Dynamic config fields will be inserted here -->
                    </div>
                </div>
                
                <!-- Sources Tab -->
                <div id="edit-tab-sources" class="edit-tab-content hidden space-y-4">
                    <div id="edit-sources-content">
                        <!-- Dynamic sources will be shown here -->
                    </div>
                </div>
                
                <!-- Access Control Tab -->
                <div id="edit-tab-access" class="edit-tab-content hidden space-y-4">
                    <!-- Current Permissions Summary -->
                    <div id="edit-access-summary" class="rounded-xl p-4" style="background: #f3f4f6; border: 1px solid #e5e7eb;">
                        <h5 class="font-semibold mb-3" style="color: #1f2937;">ðŸ” Current Access Control</h5>
                        <div id="edit-access-type-display" class="p-3 rounded-lg mb-3" style="background: #ffffff; border: 1px solid #d1d5db;">
                            <!-- Will be populated by JS -->
                        </div>
                        
                        <!-- Selected Users/Groups -->
                        <div id="edit-access-entities" class="hidden">
                            <h6 class="text-sm font-medium mb-2" style="color: #374151;">ðŸ‘¥ Allowed Users & Groups:</h6>
                            <div id="edit-access-chips-display" class="flex flex-wrap gap-2 p-3 rounded-lg mb-3" style="background: #ffffff; border: 1px solid #d1d5db; min-height: 50px;">
                                <!-- Chips will be populated by JS -->
                            </div>
                            
                            <!-- Granular Permissions Display -->
                            <div id="edit-granular-perms" class="space-y-2 mt-3">
                                <div id="edit-perm-edit" class="hidden">
                                    <span class="text-xs font-medium" style="color: #374151;">âœï¸ Can Edit:</span>
                                    <span id="edit-perm-edit-list" class="text-xs" style="color: #5b21b6;"></span>
                                </div>
                                <div id="edit-perm-delete" class="hidden">
                                    <span class="text-xs font-medium" style="color: #374151;">ðŸ—‘ï¸ Can Delete:</span>
                                    <span id="edit-perm-delete-list" class="text-xs" style="color: #dc2626;"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Owner-only: Full Edit UI -->
                    <div id="edit-access-owner-controls" class="hidden space-y-4">
                        <div class="rounded-xl p-4" style="background: #f3f4f6; border: 1px solid #e5e7eb;">
                            <h5 class="font-semibold mb-4" style="color: #1f2937;">âš™ï¸ Modify Access Control</h5>
                            
                            <!-- Access Type Selection -->
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div class="edit-access-card tool-access-card cursor-pointer p-3 rounded-lg border-2 transition-all" 
                                     data-access="owner_only" style="background: #ffffff; border-color: #d1d5db;"
                                     onclick="selectEditAccessType('owner_only')">
                                    <div class="flex items-center gap-2">
                                        <span>ðŸ‘¤</span>
                                        <span class="font-medium" style="color: #1f2937;">Only Me</span>
                                    </div>
                                    <div class="tool-access-check hidden mt-1 text-purple-500 text-xs">âœ“</div>
                                </div>
                                <div class="edit-access-card tool-access-card cursor-pointer p-3 rounded-lg border-2 transition-all"
                                     data-access="authenticated" style="background: #ffffff; border-color: #d1d5db;"
                                     onclick="selectEditAccessType('authenticated')">
                                    <div class="flex items-center gap-2">
                                        <span>ðŸ¢</span>
                                        <span class="font-medium" style="color: #1f2937;">All Logged In</span>
                                    </div>
                                    <div class="tool-access-check hidden mt-1 text-blue-500 text-xs">âœ“</div>
                                </div>
                                <div class="edit-access-card tool-access-card cursor-pointer p-3 rounded-lg border-2 transition-all"
                                     data-access="specific_users" style="background: #ffffff; border-color: #d1d5db;"
                                     onclick="selectEditAccessType('specific_users')">
                                    <div class="flex items-center gap-2">
                                        <span>ðŸ‘¥</span>
                                        <span class="font-medium" style="color: #1f2937;">Specific Users</span>
                                    </div>
                                    <div class="tool-access-check hidden mt-1 text-yellow-500 text-xs">âœ“</div>
                                </div>
                                <div class="edit-access-card tool-access-card cursor-pointer p-3 rounded-lg border-2 transition-all"
                                     data-access="public" style="background: #ffffff; border-color: #d1d5db;"
                                     onclick="selectEditAccessType('public')">
                                    <div class="flex items-center gap-2">
                                        <span>ðŸŒ</span>
                                        <span class="font-medium" style="color: #1f2937;">Public</span>
                                    </div>
                                    <div class="tool-access-check hidden mt-1 text-green-500 text-xs">âœ“</div>
                                </div>
                            </div>
                            
                            <!-- Specific Users Config -->
                            <div id="edit-specific-config" class="hidden space-y-3 pt-3 border-t" style="border-color: #e5e7eb;">
                                <!-- Search -->
                                <div>
                                    <label class="text-sm mb-2 block" style="color: #374151; font-weight: 500;">ðŸ” Search Users & Groups</label>
                                    <input type="text" id="edit-access-search" 
                                           class="w-full rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500" 
                                           style="background: #ffffff; color: #1f2937; border: 1px solid #d1d5db;"
                                           placeholder="Type to search..."
                                           oninput="filterEditAccessSearch(this.value)"
                                           onfocus="showEditAccessResults()"
                                           autocomplete="off">
                                </div>
                                
                                <!-- Search Results -->
                                <div id="edit-access-results" class="hidden rounded-xl overflow-hidden max-h-40 overflow-y-auto shadow-lg" style="background: #ffffff; border: 1px solid #d1d5db;"></div>
                                
                                <!-- Selected Chips -->
                                <div>
                                    <label class="text-sm mb-2 block" style="color: #374151; font-weight: 500;">
                                        ðŸ‘¥ Selected <span id="edit-selected-count" class="text-xs px-2 py-0.5 rounded-full" style="background: #7c3aed; color: white;">0</span>
                                    </label>
                                    <div id="edit-selected-chips" class="flex flex-wrap gap-2 min-h-[50px] p-3 rounded-xl" style="background: #ffffff; border: 1px dashed #d1d5db;">
                                        <span class="text-sm italic" style="color: #9ca3af;">No users or groups selected</span>
                                    </div>
                                </div>
                                
                                <!-- Granular Permissions -->
                                <div class="rounded-lg p-3" style="background: #e5e7eb;">
                                    <h6 class="text-sm font-medium mb-2" style="color: #1f2937;">ðŸ” Granular Permissions</h6>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="text-xs mb-1 block" style="color: #374151;">âœï¸ Can Edit</label>
                                            <div id="edit-can-edit-chips" class="flex flex-wrap gap-1 min-h-[30px] p-2 rounded" style="background: #ffffff; border: 1px solid #d1d5db;"></div>
                                            <select id="edit-can-edit-select" class="w-full rounded px-2 py-1 text-sm mt-1" style="background: #ffffff; border: 1px solid #d1d5db; color: #1f2937;" onchange="addEditPermChip('edit', this)">
                                                <option value="">+ Add</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs mb-1 block" style="color: #374151;">ðŸ—‘ï¸ Can Delete</label>
                                            <div id="edit-can-delete-chips" class="flex flex-wrap gap-1 min-h-[30px] p-2 rounded" style="background: #ffffff; border: 1px solid #d1d5db;"></div>
                                            <select id="edit-can-delete-select" class="w-full rounded px-2 py-1 text-sm mt-1" style="background: #ffffff; border: 1px solid #d1d5db; color: #1f2937;" onchange="addEditPermChip('delete', this)">
                                                <option value="">+ Add</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Non-owner message -->
                    <div id="edit-access-readonly-msg" class="hidden text-center p-4 rounded-xl" style="background: #fef3c7; border: 1px solid #f59e0b;">
                        <p class="text-sm" style="color: #92400e;">ðŸ”’ Only the tool owner can modify access control settings.</p>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="flex items-center justify-end gap-3 p-4 border-t border-gray-700">
                <button onclick="closeToolEditPanel()" class="btn-secondary px-6 py-2 rounded-lg">Cancel</button>
                <button onclick="saveToolChanges()" class="btn-primary px-6 py-2 rounded-lg">Save Changes</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>

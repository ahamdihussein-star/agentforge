<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentForge - Workflow Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --canvas-bg: #0f1419;
            --grid-color: rgba(255,255,255,0.03);
            --node-bg: #1a1f2e;
            --node-border: #2d3748;
            --connection-color: #6366f1;
            --trigger-color: #22c55e;
            --action-color: #3b82f6;
            --condition-color: #f59e0b;
            --approval-color: #ef4444;
            --loop-color: #8b5cf6;
            --end-color: #6b7280;
        }
        
        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0d12;
            color: white;
            overflow: hidden;
        }
        
        /* Canvas */
        #canvas-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 60px);
            overflow: hidden;
            background: var(--canvas-bg);
            background-image: 
                radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        #canvas {
            position: absolute;
            transform-origin: 0 0;
            min-width: 3000px;
            min-height: 2000px;
        }
        
        /* Nodes */
        .workflow-node {
            position: absolute;
            width: 280px;
            background: var(--node-bg);
            border: 2px solid var(--node-border);
            border-radius: 12px;
            cursor: move;
            user-select: none;
            transition: box-shadow 0.2s, border-color 0.2s;
            z-index: 10;
        }
        
        .workflow-node:hover {
            border-color: #4f46e5;
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.3);
        }
        
        .workflow-node.selected {
            border-color: #6366f1;
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.4);
        }
        
        .workflow-node.dragging {
            opacity: 0.8;
            z-index: 100;
        }
        
        .node-header {
            padding: 12px 16px;
            border-radius: 10px 10px 0 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .node-header.trigger { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .node-header.action { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .node-header.condition { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .node-header.approval { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .node-header.loop { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .node-header.delay { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .node-header.end { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .node-header.tool { background: linear-gradient(135deg, #ec4899, #db2777); }
        
        .node-icon {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .node-title {
            flex: 1;
            font-weight: 600;
            font-size: 14px;
        }
        
        .node-menu-btn {
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .node-menu-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .node-body {
            padding: 16px;
        }
        
        .node-description {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 12px;
        }
        
        .node-config-preview {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 11px;
            color: #d1d5db;
        }
        
        .node-config-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .node-config-item:last-child { margin-bottom: 0; }
        
        .config-label {
            color: #6b7280;
            min-width: 60px;
        }
        
        .config-value {
            color: #a5b4fc;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Connection Ports */
        .port {
            position: absolute;
            width: 14px;
            height: 14px;
            background: #374151;
            border: 2px solid #6b7280;
            border-radius: 50%;
            cursor: crosshair;
            transition: all 0.2s;
            z-index: 20;
        }
        
        .port:hover {
            transform: scale(1.3);
            background: #6366f1;
            border-color: #818cf8;
        }
        
        .port.input {
            top: -7px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .port.output {
            bottom: -7px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .port.output-yes {
            bottom: -7px;
            left: 30%;
            transform: translateX(-50%);
        }
        
        .port.output-no {
            bottom: -7px;
            left: 70%;
            transform: translateX(-50%);
        }
        
        .port-label {
            position: absolute;
            font-size: 9px;
            color: #9ca3af;
            white-space: nowrap;
        }
        
        .port.output-yes + .port-label { bottom: -22px; left: 30%; transform: translateX(-50%); color: #22c55e; }
        .port.output-no ~ .port-label.no { bottom: -22px; left: 70%; transform: translateX(-50%); color: #ef4444; }
        
        /* Connections SVG */
        #connections-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        
        .connection-path {
            fill: none;
            stroke: #6366f1;
            stroke-width: 2;
            stroke-linecap: round;
        }
        
        .connection-path.yes { stroke: #22c55e; }
        .connection-path.no { stroke: #ef4444; }
        
        .connection-path:hover {
            stroke-width: 3;
            cursor: pointer;
        }
        
        /* Toolbar */
        #top-toolbar {
            height: 60px;
            background: #111827;
            border-bottom: 1px solid #1f2937;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 16px;
        }
        
        .toolbar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 20px;
            border-right: 1px solid #374151;
        }
        
        .toolbar-logo img {
            height: 32px;
        }
        
        .toolbar-title {
            font-weight: 600;
            font-size: 16px;
        }
        
        .workflow-name-input {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            min-width: 200px;
        }
        
        .workflow-name-input:hover {
            border-color: #374151;
        }
        
        .workflow-name-input:focus {
            outline: none;
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }
        
        .toolbar-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }
        
        .toolbar-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-secondary {
            background: #1f2937;
            border: 1px solid #374151;
            color: #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #374151;
            border-color: #4b5563;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            border: none;
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #818cf8, #6366f1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: white;
        }
        
        .btn-success:hover {
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
        }
        
        /* Left Panel - Node Palette */
        #node-palette {
            position: absolute;
            left: 20px;
            top: 80px;
            width: 260px;
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 12px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
            z-index: 50;
        }
        
        .palette-section {
            padding: 16px;
            border-bottom: 1px solid #1f2937;
        }
        
        .palette-section:last-child { border-bottom: none; }
        
        .palette-title {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .palette-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: #1a1f2e;
            border: 1px solid #2d3748;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s;
        }
        
        .palette-item:hover {
            border-color: #4f46e5;
            background: rgba(79, 70, 229, 0.1);
            transform: translateX(4px);
        }
        
        .palette-item:active {
            cursor: grabbing;
        }
        
        .palette-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .palette-icon.trigger { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .palette-icon.action { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .palette-icon.condition { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .palette-icon.approval { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .palette-icon.loop { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .palette-icon.delay { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .palette-icon.end { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .palette-icon.tool { background: linear-gradient(135deg, #ec4899, #db2777); }
        
        .palette-info {
            flex: 1;
        }
        
        .palette-name {
            font-size: 13px;
            font-weight: 500;
            color: #e5e7eb;
        }
        
        .palette-desc {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }
        
        /* Right Panel - Properties */
        #properties-panel {
            position: absolute;
            right: 20px;
            top: 80px;
            width: 320px;
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 12px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
            z-index: 50;
            display: none;
        }
        
        #properties-panel.active { display: block; }
        
        .properties-header {
            padding: 16px;
            border-bottom: 1px solid #1f2937;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .properties-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .properties-title {
            flex: 1;
        }
        
        .properties-title h3 {
            font-size: 15px;
            font-weight: 600;
            margin: 0;
        }
        
        .properties-title span {
            font-size: 11px;
            color: #6b7280;
        }
        
        .properties-close {
            width: 28px;
            height: 28px;
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 18px;
        }
        
        .properties-close:hover { color: white; }
        
        .properties-body {
            padding: 16px;
        }
        
        .property-group {
            margin-bottom: 20px;
        }
        
        .property-label {
            font-size: 12px;
            font-weight: 500;
            color: #9ca3af;
            margin-bottom: 8px;
            display: block;
        }
        
        .property-input {
            width: 100%;
            padding: 10px 12px;
            background: #1a1f2e;
            border: 1px solid #2d3748;
            border-radius: 8px;
            color: white;
            font-size: 13px;
        }
        
        .property-input:focus {
            outline: none;
            border-color: #6366f1;
        }
        
        .property-select {
            width: 100%;
            padding: 10px 12px;
            background: #1a1f2e;
            border: 1px solid #2d3748;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }
        
        .property-textarea {
            width: 100%;
            padding: 10px 12px;
            background: #1a1f2e;
            border: 1px solid #2d3748;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            min-height: 80px;
            resize: vertical;
        }
        
        /* Tool Selector */
        .tool-selector {
            background: #1a1f2e;
            border: 1px solid #2d3748;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .tool-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .tool-option:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .tool-option.selected {
            background: rgba(99, 102, 241, 0.2);
            border-left: 3px solid #6366f1;
        }
        
        .tool-option-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #ec4899, #db2777);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tool-option-info {
            flex: 1;
        }
        
        .tool-option-name {
            font-size: 13px;
            font-weight: 500;
        }
        
        .tool-option-type {
            font-size: 11px;
            color: #6b7280;
        }
        
        /* Zoom Controls */
        #zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 4px;
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 8px;
            padding: 4px;
            z-index: 50;
        }
        
        .zoom-btn {
            width: 36px;
            height: 36px;
            background: none;
            border: none;
            color: #9ca3af;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn:hover {
            background: #1f2937;
            color: white;
        }
        
        .zoom-level {
            padding: 0 12px;
            font-size: 12px;
            color: #6b7280;
            display: flex;
            align-items: center;
        }
        
        /* Minimap */
        #minimap {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 160px;
            height: 100px;
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 8px;
            overflow: hidden;
            z-index: 50;
        }
        
        #minimap-canvas {
            width: 100%;
            height: 100%;
        }
        
        .minimap-viewport {
            position: absolute;
            border: 2px solid #6366f1;
            background: rgba(99, 102, 241, 0.1);
            pointer-events: none;
        }
        
        /* Empty State */
        #empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #6b7280;
            z-index: 5;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: #9ca3af;
            margin-bottom: 8px;
        }
        
        .empty-desc {
            font-size: 14px;
            max-width: 300px;
            line-height: 1.5;
        }
        
        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .connecting .port.output {
            animation: pulse 1s infinite;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <!-- Top Toolbar -->
    <div id="top-toolbar">
        <div class="toolbar-logo">
            <img src="/AgentForge_Logo.png" alt="AgentForge" onerror="this.style.display='none'">
            <span class="toolbar-title">Workflow Builder</span>
        </div>
        
        <input type="text" id="workflow-name" class="workflow-name-input" value="My Workflow" placeholder="Workflow Name">
        
        <div class="toolbar-actions">
            <button class="toolbar-btn btn-secondary" onclick="undoAction()">
                <span>‚Ü∂</span> Undo
            </button>
            <button class="toolbar-btn btn-secondary" onclick="redoAction()">
                <span>‚Ü∑</span> Redo
            </button>
            <button class="toolbar-btn btn-secondary" onclick="testWorkflow()">
                <span>‚ñ∂</span> Test
            </button>
            <button class="toolbar-btn btn-primary" onclick="saveWorkflow()">
                <span>üíæ</span> Save
            </button>
            <button class="toolbar-btn btn-success" onclick="publishWorkflow()">
                <span>üöÄ</span> Publish
            </button>
        </div>
    </div>
    
    <!-- Canvas Container -->
    <div id="canvas-container">
        <!-- SVG for connections -->
        <svg id="connections-svg"></svg>
        
        <!-- Canvas for nodes -->
        <div id="canvas">
            <!-- Nodes will be added here -->
        </div>
        
        <!-- Empty State -->
        <div id="empty-state">
            <div class="empty-icon">üîÑ</div>
            <div class="empty-title">Start Building Your Workflow</div>
            <div class="empty-desc">Drag components from the left panel onto the canvas to create your automation flow</div>
        </div>
    </div>
    
    <!-- Node Palette (Left Panel) -->
    <div id="node-palette">
        <div class="palette-section">
            <div class="palette-title">Triggers</div>
            <div class="palette-item" draggable="true" data-type="trigger">
                <div class="palette-icon trigger">üéØ</div>
                <div class="palette-info">
                    <div class="palette-name">Start Trigger</div>
                    <div class="palette-desc">When workflow begins</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="schedule">
                <div class="palette-icon trigger">‚è∞</div>
                <div class="palette-info">
                    <div class="palette-name">Schedule</div>
                    <div class="palette-desc">Run on a schedule</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="webhook">
                <div class="palette-icon trigger">üîó</div>
                <div class="palette-info">
                    <div class="palette-name">Webhook</div>
                    <div class="palette-desc">Triggered by API call</div>
                </div>
            </div>
        </div>
        
        <div class="palette-section">
            <div class="palette-title">Logic</div>
            <div class="palette-item" draggable="true" data-type="condition">
                <div class="palette-icon condition">üîÄ</div>
                <div class="palette-info">
                    <div class="palette-name">Condition</div>
                    <div class="palette-desc">If/else branching</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="loop">
                <div class="palette-icon loop">üîÅ</div>
                <div class="palette-info">
                    <div class="palette-name">Loop</div>
                    <div class="palette-desc">Repeat for each item</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="delay">
                <div class="palette-icon delay">‚è≥</div>
                <div class="palette-info">
                    <div class="palette-name">Delay</div>
                    <div class="palette-desc">Wait before continuing</div>
                </div>
            </div>
        </div>
        
        <div class="palette-section">
            <div class="palette-title">Actions</div>
            <div class="palette-item" draggable="true" data-type="action">
                <div class="palette-icon action">‚ö°</div>
                <div class="palette-info">
                    <div class="palette-name">Action</div>
                    <div class="palette-desc">Perform an operation</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="tool">
                <div class="palette-icon tool">üîß</div>
                <div class="palette-info">
                    <div class="palette-name">Use Tool</div>
                    <div class="palette-desc">Call a platform tool</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="ai">
                <div class="palette-icon action">ü§ñ</div>
                <div class="palette-info">
                    <div class="palette-name">AI Action</div>
                    <div class="palette-desc">AI-powered task</div>
                </div>
            </div>
        </div>
        
        <div class="palette-section">
            <div class="palette-title">Human Tasks</div>
            <div class="palette-item" draggable="true" data-type="approval">
                <div class="palette-icon approval">‚úÖ</div>
                <div class="palette-info">
                    <div class="palette-name">Approval</div>
                    <div class="palette-desc">Wait for approval</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="form">
                <div class="palette-icon approval">üìù</div>
                <div class="palette-info">
                    <div class="palette-name">Form Input</div>
                    <div class="palette-desc">Collect user input</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="notification">
                <div class="palette-icon action">üìß</div>
                <div class="palette-info">
                    <div class="palette-name">Notification</div>
                    <div class="palette-desc">Send a message</div>
                </div>
            </div>
        </div>
        
        <div class="palette-section">
            <div class="palette-title">Flow Control</div>
            <div class="palette-item" draggable="true" data-type="end">
                <div class="palette-icon end">üèÅ</div>
                <div class="palette-info">
                    <div class="palette-name">End</div>
                    <div class="palette-desc">Complete workflow</div>
                </div>
            </div>
        </div>
        
        <div class="palette-section" id="tools-section">
            <div class="palette-title">Your Tools</div>
            <div id="platform-tools-list">
                <!-- Loaded dynamically -->
                <div style="font-size: 11px; color: #6b7280; padding: 8px;">Loading tools...</div>
            </div>
        </div>
    </div>
    
    <!-- Properties Panel (Right) -->
    <div id="properties-panel">
        <div class="properties-header">
            <div class="properties-icon action" id="prop-icon">‚ö°</div>
            <div class="properties-title">
                <h3 id="prop-title">Node Properties</h3>
                <span id="prop-type">Action</span>
            </div>
            <button class="properties-close" onclick="closeProperties()">√ó</button>
        </div>
        <div class="properties-body" id="prop-body">
            <!-- Dynamic content -->
        </div>
    </div>
    
    <!-- Zoom Controls -->
    <div id="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
        <span class="zoom-level" id="zoom-level">100%</span>
        <button class="zoom-btn" onclick="zoomIn()">+</button>
        <button class="zoom-btn" onclick="zoomReset()">‚äô</button>
    </div>
    
    <!-- Minimap -->
    <div id="minimap">
        <canvas id="minimap-canvas"></canvas>
    </div>

    <script>
        // ===== STATE =====
        const state = {
            nodes: [],
            connections: [],
            selectedNode: null,
            zoom: 1,
            panX: 0,
            panY: 0,
            isDragging: false,
            isConnecting: false,
            connectionStart: null,
            tools: [],
            agentId: null,
            undoStack: [],
            redoStack: []
        };
        
        // Node ID counter
        let nodeIdCounter = 1;
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            initCanvas();
            initPalette();
            loadTools();
            loadWorkflowFromUrl();
        });
        
        function initCanvas() {
            const container = document.getElementById('canvas-container');
            const canvas = document.getElementById('canvas');
            
            // Pan with middle mouse or space+drag
            let isPanning = false;
            let startX, startY;
            
            container.addEventListener('mousedown', (e) => {
                if (e.button === 1 || (e.button === 0 && e.target === container)) {
                    isPanning = true;
                    startX = e.clientX - state.panX;
                    startY = e.clientY - state.panY;
                    container.style.cursor = 'grabbing';
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isPanning) {
                    state.panX = e.clientX - startX;
                    state.panY = e.clientY - startY;
                    updateCanvasTransform();
                }
            });
            
            document.addEventListener('mouseup', () => {
                isPanning = false;
                container.style.cursor = '';
            });
            
            // Zoom with scroll
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                const newZoom = Math.min(Math.max(state.zoom * delta, 0.25), 2);
                state.zoom = newZoom;
                updateCanvasTransform();
                document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%';
            });
            
            // Click on canvas to deselect
            container.addEventListener('click', (e) => {
                if (e.target === container || e.target.id === 'canvas') {
                    deselectAll();
                }
            });
        }
        
        function updateCanvasTransform() {
            const canvas = document.getElementById('canvas');
            const svg = document.getElementById('connections-svg');
            canvas.style.transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.zoom})`;
            svg.style.transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.zoom})`;
        }
        
        function initPalette() {
            const items = document.querySelectorAll('.palette-item[draggable="true"]');
            const canvas = document.getElementById('canvas');
            const container = document.getElementById('canvas-container');
            
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('nodeType', item.dataset.type);
                    e.dataTransfer.setData('toolId', item.dataset.toolId || '');
                });
            });
            
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const type = e.dataTransfer.getData('nodeType');
                const toolId = e.dataTransfer.getData('toolId');
                
                if (type) {
                    const rect = container.getBoundingClientRect();
                    const x = (e.clientX - rect.left - state.panX) / state.zoom;
                    const y = (e.clientY - rect.top - state.panY) / state.zoom;
                    
                    createNode(type, x, y, toolId);
                }
            });
        }
        
        // ===== NODE MANAGEMENT =====
        function createNode(type, x, y, toolId = null) {
            const id = 'node_' + nodeIdCounter++;
            
            const nodeConfig = getNodeConfig(type, toolId);
            
            const node = {
                id,
                type,
                name: nodeConfig.name,
                x: Math.round(x / 20) * 20, // Snap to grid
                y: Math.round(y / 20) * 20,
                config: nodeConfig.config,
                toolId
            };
            
            state.nodes.push(node);
            renderNode(node);
            saveToUndo();
            updateEmptyState();
            
            // Select the new node
            selectNode(id);
            
            return node;
        }
        
        function getNodeConfig(type, toolId = null) {
            const configs = {
                trigger: { name: 'Start', config: { triggerType: 'manual' } },
                schedule: { name: 'Schedule', config: { cron: '0 9 * * *', timezone: 'UTC' } },
                webhook: { name: 'Webhook', config: { method: 'POST', path: '/trigger' } },
                action: { name: 'Action', config: { description: '' } },
                condition: { name: 'Condition', config: { field: '', operator: 'equals', value: '' } },
                loop: { name: 'For Each', config: { collection: '', itemVar: 'item' } },
                delay: { name: 'Wait', config: { duration: 5, unit: 'minutes' } },
                approval: { name: 'Approval', config: { approvers: [], message: '' } },
                form: { name: 'Form', config: { fields: [] } },
                notification: { name: 'Send Notification', config: { channel: 'email', template: '' } },
                tool: { name: 'Use Tool', config: { toolId: toolId || '', params: {} } },
                ai: { name: 'AI Task', config: { prompt: '', model: 'gpt-4o' } },
                end: { name: 'End', config: { output: '' } }
            };
            
            // If it's a tool node with toolId, get tool name
            if (type === 'tool' && toolId) {
                const tool = state.tools.find(t => t.id === toolId);
                if (tool) {
                    return { name: tool.name, config: { toolId, params: {} } };
                }
            }
            
            return configs[type] || { name: type, config: {} };
        }
        
        function renderNode(node) {
            const canvas = document.getElementById('canvas');
            
            const nodeEl = document.createElement('div');
            nodeEl.className = 'workflow-node';
            nodeEl.id = node.id;
            nodeEl.style.left = node.x + 'px';
            nodeEl.style.top = node.y + 'px';
            
            const typeClass = getTypeClass(node.type);
            const icon = getTypeIcon(node.type);
            
            nodeEl.innerHTML = `
                <div class="port input"></div>
                <div class="node-header ${typeClass}">
                    <div class="node-icon">${icon}</div>
                    <div class="node-title">${node.name}</div>
                    <button class="node-menu-btn" onclick="event.stopPropagation(); showNodeMenu('${node.id}')">‚ãÆ</button>
                </div>
                <div class="node-body">
                    <div class="node-description">${getNodeDescription(node)}</div>
                    <div class="node-config-preview">${getConfigPreview(node)}</div>
                </div>
                ${node.type === 'condition' ? `
                    <div class="port output-yes"></div>
                    <span class="port-label" style="bottom:-22px;left:30%;transform:translateX(-50%);color:#22c55e;">Yes</span>
                    <div class="port output-no"></div>
                    <span class="port-label no" style="bottom:-22px;left:70%;transform:translateX(-50%);color:#ef4444;">No</span>
                ` : node.type !== 'end' ? `
                    <div class="port output"></div>
                ` : ''}
            `;
            
            // Make draggable
            makeDraggable(nodeEl, node);
            
            // Click to select
            nodeEl.addEventListener('click', (e) => {
                e.stopPropagation();
                selectNode(node.id);
            });
            
            // Double click to edit
            nodeEl.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                showProperties(node);
            });
            
            // Setup port connections
            setupPorts(nodeEl, node);
            
            canvas.appendChild(nodeEl);
        }
        
        function getTypeClass(type) {
            const classes = {
                trigger: 'trigger', schedule: 'trigger', webhook: 'trigger',
                action: 'action', tool: 'tool', ai: 'action', notification: 'action',
                condition: 'condition',
                loop: 'loop',
                delay: 'delay',
                approval: 'approval', form: 'approval',
                end: 'end'
            };
            return classes[type] || 'action';
        }
        
        function getTypeIcon(type) {
            const icons = {
                trigger: 'üéØ', schedule: '‚è∞', webhook: 'üîó',
                action: '‚ö°', tool: 'üîß', ai: 'ü§ñ', notification: 'üìß',
                condition: 'üîÄ',
                loop: 'üîÅ',
                delay: '‚è≥',
                approval: '‚úÖ', form: 'üìù',
                end: 'üèÅ'
            };
            return icons[type] || 'üì¶';
        }
        
        function getNodeDescription(node) {
            const descs = {
                trigger: 'Workflow starts here',
                schedule: 'Runs on schedule',
                webhook: 'Triggered by API',
                action: 'Performs an operation',
                tool: 'Executes a platform tool',
                ai: 'AI-powered processing',
                condition: 'Branch based on condition',
                loop: 'Iterate over collection',
                delay: 'Wait before continuing',
                approval: 'Wait for approval',
                form: 'Collect user input',
                notification: 'Send notification',
                end: 'Workflow ends here'
            };
            return descs[node.type] || '';
        }
        
        function getConfigPreview(node) {
            const cfg = node.config || {};
            let html = '';
            
            switch (node.type) {
                case 'condition':
                    html = `<div class="node-config-item"><span class="config-label">If</span><span class="config-value">${cfg.field || 'field'} ${cfg.operator || '='} ${cfg.value || 'value'}</span></div>`;
                    break;
                case 'delay':
                    html = `<div class="node-config-item"><span class="config-label">Wait</span><span class="config-value">${cfg.duration || 5} ${cfg.unit || 'minutes'}</span></div>`;
                    break;
                case 'approval':
                    html = `<div class="node-config-item"><span class="config-label">Approvers</span><span class="config-value">${(cfg.approvers || []).length || 'Not set'}</span></div>`;
                    break;
                case 'tool':
                    const tool = state.tools.find(t => t.id === cfg.toolId);
                    html = `<div class="node-config-item"><span class="config-label">Tool</span><span class="config-value">${tool ? tool.name : 'Select tool...'}</span></div>`;
                    break;
                case 'notification':
                    html = `<div class="node-config-item"><span class="config-label">Channel</span><span class="config-value">${cfg.channel || 'email'}</span></div>`;
                    break;
                case 'form':
                case 'trigger':
                    const fieldCount = (cfg.fields || []).length;
                    html = `<div class="node-config-item"><span class="config-label">Fields</span><span class="config-value">${fieldCount} input${fieldCount !== 1 ? 's' : ''}</span></div>`;
                    break;
                default:
                    html = '<div class="node-config-item"><span class="config-value" style="color:#6b7280;">Click to configure</span></div>';
            }
            
            return html;
        }
        
        function makeDraggable(nodeEl, node) {
            let startX, startY, nodeStartX, nodeStartY;
            
            nodeEl.addEventListener('mousedown', (e) => {
                if (e.target.closest('.port') || e.target.closest('.node-menu-btn')) return;
                
                state.isDragging = true;
                nodeEl.classList.add('dragging');
                
                startX = e.clientX;
                startY = e.clientY;
                nodeStartX = node.x;
                nodeStartY = node.y;
                
                const onMove = (e) => {
                    if (!state.isDragging) return;
                    
                    const dx = (e.clientX - startX) / state.zoom;
                    const dy = (e.clientY - startY) / state.zoom;
                    
                    node.x = Math.round((nodeStartX + dx) / 20) * 20;
                    node.y = Math.round((nodeStartY + dy) / 20) * 20;
                    
                    nodeEl.style.left = node.x + 'px';
                    nodeEl.style.top = node.y + 'px';
                    
                    renderConnections();
                };
                
                const onUp = () => {
                    state.isDragging = false;
                    nodeEl.classList.remove('dragging');
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    saveToUndo();
                };
                
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
        }
        
        function setupPorts(nodeEl, node) {
            const ports = nodeEl.querySelectorAll('.port.output, .port.output-yes, .port.output-no');
            
            ports.forEach(port => {
                port.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    state.isConnecting = true;
                    state.connectionStart = {
                        nodeId: node.id,
                        portType: port.classList.contains('output-yes') ? 'yes' : 
                                  port.classList.contains('output-no') ? 'no' : 'default'
                    };
                    document.body.classList.add('connecting');
                });
            });
            
            const inputPort = nodeEl.querySelector('.port.input');
            if (inputPort) {
                inputPort.addEventListener('mouseup', (e) => {
                    if (state.isConnecting && state.connectionStart) {
                        // Create connection
                        const conn = {
                            from: state.connectionStart.nodeId,
                            to: node.id,
                            type: state.connectionStart.portType
                        };
                        
                        // Don't connect to self
                        if (conn.from !== conn.to) {
                            // Remove existing connection from same output
                            state.connections = state.connections.filter(c => 
                                !(c.from === conn.from && c.type === conn.type)
                            );
                            state.connections.push(conn);
                            renderConnections();
                            saveToUndo();
                        }
                    }
                    
                    state.isConnecting = false;
                    state.connectionStart = null;
                    document.body.classList.remove('connecting');
                });
            }
        }
        
        // ===== CONNECTIONS =====
        function renderConnections() {
            const svg = document.getElementById('connections-svg');
            svg.innerHTML = '';
            
            state.connections.forEach(conn => {
                const fromNode = document.getElementById(conn.from);
                const toNode = document.getElementById(conn.to);
                
                if (!fromNode || !toNode) return;
                
                let fromPort;
                if (conn.type === 'yes') {
                    fromPort = fromNode.querySelector('.port.output-yes');
                } else if (conn.type === 'no') {
                    fromPort = fromNode.querySelector('.port.output-no');
                } else {
                    fromPort = fromNode.querySelector('.port.output');
                }
                
                const toPort = toNode.querySelector('.port.input');
                
                if (!fromPort || !toPort) return;
                
                const fromRect = fromPort.getBoundingClientRect();
                const toRect = toPort.getBoundingClientRect();
                const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                
                const x1 = (fromRect.left + fromRect.width/2 - canvasRect.left) / state.zoom;
                const y1 = (fromRect.top + fromRect.height/2 - canvasRect.top) / state.zoom;
                const x2 = (toRect.left + toRect.width/2 - canvasRect.left) / state.zoom;
                const y2 = (toRect.top + toRect.height/2 - canvasRect.top) / state.zoom;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('class', `connection-path ${conn.type}`);
                
                // Bezier curve
                const midY = (y1 + y2) / 2;
                const d = `M ${x1} ${y1} C ${x1} ${midY}, ${x2} ${midY}, ${x2} ${y2}`;
                path.setAttribute('d', d);
                
                svg.appendChild(path);
            });
        }
        
        // ===== SELECTION =====
        function selectNode(id) {
            deselectAll();
            const node = state.nodes.find(n => n.id === id);
            if (node) {
                state.selectedNode = node;
                document.getElementById(id).classList.add('selected');
                showProperties(node);
            }
        }
        
        function deselectAll() {
            state.selectedNode = null;
            document.querySelectorAll('.workflow-node').forEach(n => n.classList.remove('selected'));
            closeProperties();
        }
        
        // ===== PROPERTIES PANEL =====
        function showProperties(node) {
            const panel = document.getElementById('properties-panel');
            const icon = document.getElementById('prop-icon');
            const title = document.getElementById('prop-title');
            const type = document.getElementById('prop-type');
            const body = document.getElementById('prop-body');
            
            icon.className = 'properties-icon ' + getTypeClass(node.type);
            icon.textContent = getTypeIcon(node.type);
            title.textContent = node.name;
            type.textContent = node.type.charAt(0).toUpperCase() + node.type.slice(1);
            
            body.innerHTML = generatePropertiesForm(node);
            panel.classList.add('active');
        }
        
        function generatePropertiesForm(node) {
            let html = `
                <div class="property-group">
                    <label class="property-label">Name</label>
                    <input type="text" class="property-input" value="${node.name}" 
                           onchange="updateNodeProperty('${node.id}', 'name', this.value)">
                </div>
            `;
            
            switch (node.type) {
                case 'condition':
                    html += `
                        <div class="property-group">
                            <label class="property-label">Field to Check</label>
                            <input type="text" class="property-input" placeholder="e.g., amount, status" 
                                   value="${node.config.field || ''}"
                                   onchange="updateNodeConfig('${node.id}', 'field', this.value)">
                        </div>
                        <div class="property-group">
                            <label class="property-label">Operator</label>
                            <select class="property-select" onchange="updateNodeConfig('${node.id}', 'operator', this.value)">
                                <option value="equals" ${node.config.operator === 'equals' ? 'selected' : ''}>Equals</option>
                                <option value="not_equals" ${node.config.operator === 'not_equals' ? 'selected' : ''}>Not Equals</option>
                                <option value="greater_than" ${node.config.operator === 'greater_than' ? 'selected' : ''}>Greater Than</option>
                                <option value="less_than" ${node.config.operator === 'less_than' ? 'selected' : ''}>Less Than</option>
                                <option value="contains" ${node.config.operator === 'contains' ? 'selected' : ''}>Contains</option>
                                <option value="is_empty" ${node.config.operator === 'is_empty' ? 'selected' : ''}>Is Empty</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label class="property-label">Value</label>
                            <input type="text" class="property-input" placeholder="Compare value" 
                                   value="${node.config.value || ''}"
                                   onchange="updateNodeConfig('${node.id}', 'value', this.value)">
                        </div>
                    `;
                    break;
                    
                case 'delay':
                    html += `
                        <div class="property-group">
                            <label class="property-label">Wait Duration</label>
                            <div style="display:flex;gap:8px;">
                                <input type="number" class="property-input" style="width:100px;" 
                                       value="${node.config.duration || 5}"
                                       onchange="updateNodeConfig('${node.id}', 'duration', parseInt(this.value))">
                                <select class="property-select" onchange="updateNodeConfig('${node.id}', 'unit', this.value)">
                                    <option value="seconds" ${node.config.unit === 'seconds' ? 'selected' : ''}>Seconds</option>
                                    <option value="minutes" ${node.config.unit === 'minutes' ? 'selected' : ''}>Minutes</option>
                                    <option value="hours" ${node.config.unit === 'hours' ? 'selected' : ''}>Hours</option>
                                    <option value="days" ${node.config.unit === 'days' ? 'selected' : ''}>Days</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'tool':
                    html += `
                        <div class="property-group">
                            <label class="property-label">Select Tool</label>
                            <div class="tool-selector">
                                ${state.tools.map(t => `
                                    <div class="tool-option ${node.config.toolId === t.id ? 'selected' : ''}" 
                                         onclick="selectTool('${node.id}', '${t.id}')">
                                        <div class="tool-option-icon">${getToolIcon(t.type)}</div>
                                        <div class="tool-option-info">
                                            <div class="tool-option-name">${t.name}</div>
                                            <div class="tool-option-type">${t.type}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'approval':
                    html += `
                        <div class="property-group">
                            <label class="property-label">Approval Message</label>
                            <textarea class="property-textarea" placeholder="Message to show approvers..."
                                      onchange="updateNodeConfig('${node.id}', 'message', this.value)">${node.config.message || ''}</textarea>
                        </div>
                        <div class="property-group">
                            <label class="property-label">Timeout (hours)</label>
                            <input type="number" class="property-input" value="${node.config.timeout || 24}"
                                   onchange="updateNodeConfig('${node.id}', 'timeout', parseInt(this.value))">
                        </div>
                    `;
                    break;
                    
                case 'notification':
                    html += `
                        <div class="property-group">
                            <label class="property-label">Channel</label>
                            <select class="property-select" onchange="updateNodeConfig('${node.id}', 'channel', this.value)">
                                <option value="email" ${node.config.channel === 'email' ? 'selected' : ''}>Email</option>
                                <option value="slack" ${node.config.channel === 'slack' ? 'selected' : ''}>Slack</option>
                                <option value="teams" ${node.config.channel === 'teams' ? 'selected' : ''}>Microsoft Teams</option>
                                <option value="sms" ${node.config.channel === 'sms' ? 'selected' : ''}>SMS</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label class="property-label">Message Template</label>
                            <textarea class="property-textarea" placeholder="Enter message template..."
                                      onchange="updateNodeConfig('${node.id}', 'template', this.value)">${node.config.template || ''}</textarea>
                        </div>
                    `;
                    break;
                    
                case 'ai':
                    html += `
                        <div class="property-group">
                            <label class="property-label">AI Prompt</label>
                            <textarea class="property-textarea" style="min-height:120px;" 
                                      placeholder="Describe what the AI should do..."
                                      onchange="updateNodeConfig('${node.id}', 'prompt', this.value)">${node.config.prompt || ''}</textarea>
                        </div>
                        <div class="property-group">
                            <label class="property-label">AI Model</label>
                            <select class="property-select" onchange="updateNodeConfig('${node.id}', 'model', this.value)">
                                <option value="gpt-4o" ${node.config.model === 'gpt-4o' ? 'selected' : ''}>GPT-4o (Fast)</option>
                                <option value="gpt-4o-mini" ${node.config.model === 'gpt-4o-mini' ? 'selected' : ''}>GPT-4o Mini</option>
                                <option value="claude-sonnet-4-20250514" ${node.config.model === 'claude-sonnet-4-20250514' ? 'selected' : ''}>Claude Sonnet</option>
                            </select>
                        </div>
                    `;
                    break;
                
                case 'form':
                case 'trigger':
                    // Form fields editor
                    const fields = node.config.fields || [];
                    html += `
                        <div class="property-group">
                            <label class="property-label">Form Title</label>
                            <input type="text" class="property-input" placeholder="e.g., Submit Expense Report" 
                                   value="${node.config.title || ''}"
                                   onchange="updateNodeConfig('${node.id}', 'title', this.value)">
                        </div>
                        <div class="property-group">
                            <label class="property-label">Input Fields</label>
                            <div id="form-fields-list" style="margin-bottom:12px;">
                                ${fields.length === 0 ? '<div style="color:#6b7280;font-size:12px;padding:8px;">No fields yet. Add some below.</div>' : ''}
                                ${fields.map((f, idx) => `
                                    <div class="form-field-item" style="display:flex;gap:8px;align-items:center;margin-bottom:8px;padding:8px;background:#1a1f2e;border-radius:6px;">
                                        <input type="text" class="property-input" style="flex:1;margin:0;" placeholder="Field name"
                                               value="${f.name || ''}"
                                               onchange="updateFormField('${node.id}', ${idx}, 'name', this.value)">
                                        <select class="property-select" style="width:100px;margin:0;"
                                                onchange="updateFormField('${node.id}', ${idx}, 'type', this.value)">
                                            <option value="text" ${f.type === 'text' ? 'selected' : ''}>Text</option>
                                            <option value="number" ${f.type === 'number' ? 'selected' : ''}>Number</option>
                                            <option value="email" ${f.type === 'email' ? 'selected' : ''}>Email</option>
                                            <option value="date" ${f.type === 'date' ? 'selected' : ''}>Date</option>
                                            <option value="textarea" ${f.type === 'textarea' ? 'selected' : ''}>Long Text</option>
                                            <option value="select" ${f.type === 'select' ? 'selected' : ''}>Dropdown</option>
                                            <option value="file" ${f.type === 'file' ? 'selected' : ''}>File</option>
                                        </select>
                                        <label style="display:flex;align-items:center;gap:4px;font-size:11px;color:#9ca3af;">
                                            <input type="checkbox" ${f.required ? 'checked' : ''} 
                                                   onchange="updateFormField('${node.id}', ${idx}, 'required', this.checked)">
                                            Req
                                        </label>
                                        <button onclick="removeFormField('${node.id}', ${idx})" 
                                                style="background:#ef4444;border:none;color:white;width:24px;height:24px;border-radius:4px;cursor:pointer;">√ó</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="addFormField('${node.id}')" 
                                    style="width:100%;padding:10px;background:#22c55e;border:none;border-radius:8px;color:white;cursor:pointer;font-size:13px;">
                                + Add Input Field
                            </button>
                        </div>
                        <div class="property-group">
                            <label class="property-label">Submit Button Text</label>
                            <input type="text" class="property-input" placeholder="Submit" 
                                   value="${node.config.submitText || 'Submit'}"
                                   onchange="updateNodeConfig('${node.id}', 'submitText', this.value)">
                        </div>
                    `;
                    break;
                    
                default:
                    html += `
                        <div class="property-group">
                            <label class="property-label">Description</label>
                            <textarea class="property-textarea" placeholder="What does this step do?"
                                      onchange="updateNodeConfig('${node.id}', 'description', this.value)">${node.config.description || ''}</textarea>
                        </div>
                    `;
            }
            
            // Delete button
            html += `
                <div style="margin-top:24px; padding-top:16px; border-top:1px solid #2d3748;">
                    <button onclick="deleteNode('${node.id}')" 
                            style="width:100%; padding:10px; background:#ef4444; border:none; border-radius:8px; color:white; cursor:pointer;">
                        üóëÔ∏è Delete Node
                    </button>
                </div>
            `;
            
            return html;
        }
        
        function closeProperties() {
            document.getElementById('properties-panel').classList.remove('active');
        }
        
        function updateNodeProperty(nodeId, prop, value) {
            const node = state.nodes.find(n => n.id === nodeId);
            if (node) {
                node[prop] = value;
                refreshNode(node);
                saveToUndo();
            }
        }
        
        function updateNodeConfig(nodeId, key, value) {
            const node = state.nodes.find(n => n.id === nodeId);
            if (node) {
                node.config[key] = value;
                refreshNode(node);
                saveToUndo();
            }
        }
        
        function selectTool(nodeId, toolId) {
            const node = state.nodes.find(n => n.id === nodeId);
            if (node) {
                const tool = state.tools.find(t => t.id === toolId);
                node.config.toolId = toolId;
                if (tool) node.name = tool.name;
                refreshNode(node);
                showProperties(node); // Refresh panel
                saveToUndo();
            }
        }
        
        // Form field management functions
        function addFormField(nodeId) {
            const node = state.nodes.find(n => n.id === nodeId);
            if (node) {
                if (!node.config.fields) node.config.fields = [];
                node.config.fields.push({
                    name: '',
                    type: 'text',
                    required: false,
                    placeholder: ''
                });
                refreshNode(node);
                showProperties(node);
                saveToUndo();
            }
        }
        
        function updateFormField(nodeId, fieldIndex, key, value) {
            const node = state.nodes.find(n => n.id === nodeId);
            if (node && node.config.fields && node.config.fields[fieldIndex]) {
                node.config.fields[fieldIndex][key] = value;
                refreshNode(node);
                saveToUndo();
            }
        }
        
        function removeFormField(nodeId, fieldIndex) {
            const node = state.nodes.find(n => n.id === nodeId);
            if (node && node.config.fields) {
                node.config.fields.splice(fieldIndex, 1);
                refreshNode(node);
                showProperties(node);
                saveToUndo();
            }
        }
        
        function refreshNode(node) {
            const oldEl = document.getElementById(node.id);
            if (oldEl) {
                oldEl.remove();
                renderNode(node);
                if (state.selectedNode && state.selectedNode.id === node.id) {
                    document.getElementById(node.id).classList.add('selected');
                }
                renderConnections();
            }
        }
        
        function deleteNode(nodeId) {
            if (!confirm('Delete this node?')) return;
            
            // Remove connections
            state.connections = state.connections.filter(c => c.from !== nodeId && c.to !== nodeId);
            
            // Remove node
            state.nodes = state.nodes.filter(n => n.id !== nodeId);
            
            // Remove element
            document.getElementById(nodeId)?.remove();
            
            closeProperties();
            renderConnections();
            updateEmptyState();
            saveToUndo();
        }
        
        function showNodeMenu(nodeId) {
            // Simple delete for now
            if (confirm('Delete this node?')) {
                deleteNode(nodeId);
            }
        }
        
        // ===== TOOLS =====
        function loadTools() {
            const token = localStorage.getItem('agentforge_token');
            fetch('/api/tools', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(r => r.json())
            .then(data => {
                state.tools = data.tools || [];
                renderToolsPalette();
            })
            .catch(e => {
                console.error('Failed to load tools:', e);
            });
        }
        
        function renderToolsPalette() {
            const container = document.getElementById('platform-tools-list');
            
            if (!state.tools.length) {
                container.innerHTML = '<div style="font-size:11px;color:#6b7280;padding:8px;">No tools available</div>';
                return;
            }
            
            container.innerHTML = state.tools.map(t => `
                <div class="palette-item" draggable="true" data-type="tool" data-tool-id="${t.id}">
                    <div class="palette-icon tool">${getToolIcon(t.type)}</div>
                    <div class="palette-info">
                        <div class="palette-name">${t.name}</div>
                        <div class="palette-desc">${t.type}</div>
                    </div>
                </div>
            `).join('');
            
            // Make draggable
            container.querySelectorAll('.palette-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('nodeType', 'tool');
                    e.dataTransfer.setData('toolId', item.dataset.toolId);
                });
            });
        }
        
        function getToolIcon(type) {
            const icons = {
                api: 'üåê',
                database: 'üóÑÔ∏è',
                knowledge_base: 'üìö',
                email: 'üìß',
                website: 'üîó'
            };
            return icons[type] || 'üîß';
        }
        
        // ===== ZOOM =====
        function zoomIn() {
            state.zoom = Math.min(state.zoom * 1.2, 2);
            updateCanvasTransform();
            document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%';
        }
        
        function zoomOut() {
            state.zoom = Math.max(state.zoom * 0.8, 0.25);
            updateCanvasTransform();
            document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%';
        }
        
        function zoomReset() {
            state.zoom = 1;
            state.panX = 0;
            state.panY = 0;
            updateCanvasTransform();
            document.getElementById('zoom-level').textContent = '100%';
        }
        
        // ===== UNDO/REDO =====
        function saveToUndo() {
            state.undoStack.push(JSON.stringify({ nodes: state.nodes, connections: state.connections }));
            state.redoStack = [];
        }
        
        function undoAction() {
            if (state.undoStack.length > 1) {
                state.redoStack.push(state.undoStack.pop());
                const prev = JSON.parse(state.undoStack[state.undoStack.length - 1]);
                restoreState(prev);
            }
        }
        
        function redoAction() {
            if (state.redoStack.length > 0) {
                const next = JSON.parse(state.redoStack.pop());
                state.undoStack.push(JSON.stringify(next));
                restoreState(next);
            }
        }
        
        function restoreState(data) {
            state.nodes = data.nodes;
            state.connections = data.connections;
            
            // Clear and re-render
            document.getElementById('canvas').innerHTML = '';
            state.nodes.forEach(n => renderNode(n));
            renderConnections();
            updateEmptyState();
        }
        
        // ===== SAVE/LOAD =====
        function loadWorkflowFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const agentId = params.get('agent');
            
            if (agentId) {
                state.agentId = agentId;
                loadWorkflow(agentId);
            } else {
                // New workflow - add start node
                createNode('trigger', 400, 100);
            }
        }
        
        async function loadWorkflow(agentId) {
            try {
                const token = localStorage.getItem('agentforge_token');
                const response = await fetch('/api/agents/' + agentId, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!response.ok) throw new Error('Failed to load');
                
                const agent = await response.json();
                document.getElementById('workflow-name').value = agent.name || 'My Workflow';
                
                if (agent.process_definition) {
                    const def = agent.process_definition;
                    state.nodes = def.nodes || [];
                    state.connections = def.edges || [];
                    
                    // Render
                    state.nodes.forEach(n => renderNode(n));
                    renderConnections();
                    updateEmptyState();
                }
            } catch (e) {
                console.error('Load error:', e);
                alert('Could not load workflow');
            }
        }
        
        async function saveWorkflow() {
            const name = document.getElementById('workflow-name').value;
            const def = {
                nodes: state.nodes,
                edges: state.connections
            };
            
            try {
                const token = localStorage.getItem('agentforge_token');
                const method = state.agentId ? 'PUT' : 'POST';
                const url = state.agentId ? '/api/agents/' + state.agentId : '/api/agents';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        name,
                        goal: 'Workflow automation',
                        agent_type: 'process',
                        process_definition: def,
                        status: 'draft'
                    })
                });
                
                if (!response.ok) throw new Error('Save failed');
                
                const data = await response.json();
                if (!state.agentId) {
                    state.agentId = data.agent_id || data.id;
                    window.history.replaceState({}, '', '?agent=' + state.agentId);
                }
                
                alert('‚úÖ Workflow saved!');
            } catch (e) {
                console.error('Save error:', e);
                alert('‚ùå Could not save workflow');
            }
        }
        
        async function publishWorkflow() {
            await saveWorkflow();
            
            try {
                const token = localStorage.getItem('agentforge_token');
                const response = await fetch('/api/agents/' + state.agentId, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ status: 'published' })
                });
                
                if (!response.ok) throw new Error('Publish failed');
                
                alert('üöÄ Workflow published!');
            } catch (e) {
                console.error('Publish error:', e);
                alert('‚ùå Could not publish workflow');
            }
        }
        
        function testWorkflow() {
            if (state.agentId) {
                window.open('/ui/#agents', '_blank');
            } else {
                alert('Please save the workflow first');
            }
        }
        
        function updateEmptyState() {
            const empty = document.getElementById('empty-state');
            empty.style.display = state.nodes.length === 0 ? 'block' : 'none';
        }
    </script>
</body>
</html>

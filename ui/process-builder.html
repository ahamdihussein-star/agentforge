<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AgentForge - Workflow Builder</title>
    <link rel="stylesheet" href="/ui/theme.css?v=20260223c">
    <link rel="stylesheet" href="/ui/process-builder.css?v=20260218h">

    <script src="/ui/theme.js?v=20260211f"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
</head>
<body>
    <!-- Top Toolbar -->
    <div id="top-toolbar">
        <div class="toolbar-logo">
            <img src="/AgentForge_Logo.png" alt="AgentForge" onerror="this.style.display='none'">
            <span class="toolbar-title">Workflow Builder</span>
        </div>
        
        <input type="text" id="workflow-name" class="workflow-name-input" value="My Workflow" placeholder="Workflow Name">
        
        <div class="toolbar-actions">
            <span class="toolbar-label">Flow:</span>
            <button type="button" class="toolbar-btn btn-secondary flow-btn" id="flow-vertical" title="Vertical: ŸÖŸÜ ÿ£ÿπŸÑŸâ ŸÑÿ£ÿ≥ŸÅŸÑ (Top ‚Üí Bottom)" onclick="setFlowDirection('vertical')">
                <span>‚Üï</span> Vertical
            </button>
            <button type="button" class="toolbar-btn btn-secondary flow-btn" id="flow-horizontal" title="Horizontal: ŸÖŸÜ Ÿäÿ≥ÿßÿ± ŸÑŸäŸÖŸäŸÜ (Left ‚Üí Right)" onclick="setFlowDirection('horizontal')">
                <span>‚Üî</span> Horizontal
            </button>
            <button type="button" class="toolbar-btn btn-secondary" title="Arrange process in best alignment" onclick="alignProcess()">
                <span>‚äü</span> Align
            </button>
            <span class="toolbar-label" style="margin-left:8px;">Labels:</span>
            <button type="button" class="toolbar-btn btn-secondary" title="Smaller label font" onclick="setLabelFontSize(-1)">
                <span>A‚àí</span>
            </button>
            <button type="button" class="toolbar-btn btn-secondary" title="Larger label font" onclick="setLabelFontSize(1)">
                <span>A+</span>
            </button>
            <span id="label-font-size-display" style="font-size:11px;color:var(--pb-muted);min-width:2.5em;">11px</span>
            <button class="toolbar-btn btn-secondary" title="Undo (Ctrl+Z)" onclick="undoAction()">
                <span>‚Ü∂</span> Undo
            </button>
            <button class="toolbar-btn btn-secondary" title="Redo (Ctrl+Shift+Z)" onclick="redoAction()">
                <span>‚Ü∑</span> Redo
            </button>
            <button class="toolbar-btn btn-secondary" onclick="testWorkflow()">
                <span>‚ñ∂</span> Test
            </button>
            <button class="toolbar-btn btn-primary" onclick="saveWorkflow()">
                <span>üíæ</span> Save
            </button>
            <button class="toolbar-btn btn-success" onclick="publishWorkflow()">
                <span>üöÄ</span> Publish
            </button>
        </div>
    </div>
    
    <!-- Canvas Container -->
    <div id="canvas-container">
        <div id="selection-box" style="display:none;position:absolute;border:2px dashed rgba(99,102,241,0.9);background:rgba(99,102,241,0.08);pointer-events:none;z-index:20;border-radius:4px;"></div>
        <div id="build-cursor" aria-hidden="true"></div>
        <!-- SVG for connection paths only (behind nodes) -->
        <svg id="connections-svg"></svg>
        <!-- SVG for handles + Yes/No labels only (on top, clickable) -->
        <svg id="connections-interactive-svg"></svg>
        <!-- Canvas for nodes -->
        <div id="canvas">
            <!-- Nodes will be added here -->
        </div>
        
        <!-- Empty State -->
        <div id="empty-state">
            <div class="empty-icon">üîÑ</div>
            <div class="empty-title">Start building your workflow</div>
            <div class="empty-desc">Drag a step from the left panel and drop it here. Connect steps to define the flow.</div>
        </div>
    </div>
    
    <!-- Node Palette (Left Panel) -->
    <div id="node-palette">
        <div class="palette-section">
            <div class="palette-title">Start & End</div>
            <div class="palette-item" draggable="true" data-type="trigger">
                <div class="palette-icon trigger">üéØ</div>
                <div class="palette-info">
                    <div class="palette-name">Start</div>
                    <div class="palette-desc">How the process begins</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="end">
                <div class="palette-icon end">üèÅ</div>
                <div class="palette-info">
                    <div class="palette-name">Finish</div>
                    <div class="palette-desc">Process complete</div>
                </div>
            </div>
        </div>

        <div class="palette-section">
            <div class="palette-title">Intelligence</div>
            <div class="palette-item" draggable="true" data-type="ai">
                <div class="palette-icon action">ü§ñ</div>
                <div class="palette-info">
                    <div class="palette-name">AI Step</div>
                    <div class="palette-desc">Extract from files, analyze, generate documents, classify</div>
                </div>
            </div>
        </div>

        <div class="palette-section">
            <div class="palette-title">People</div>
            <div class="palette-item" draggable="true" data-type="notification">
                <div class="palette-icon action">üìß</div>
                <div class="palette-info">
                    <div class="palette-name">Send Message</div>
                    <div class="palette-desc">Send an email, Slack, or Teams message</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="approval">
                <div class="palette-icon approval">‚úÖ</div>
                <div class="palette-info">
                    <div class="palette-name">Request Approval</div>
                    <div class="palette-desc">Ask someone to approve or reject</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="form">
                <div class="palette-icon approval">üìù</div>
                <div class="palette-info">
                    <div class="palette-name">Collect Information</div>
                    <div class="palette-desc">Ask someone to fill in a form</div>
                </div>
            </div>
        </div>

        <div class="palette-section">
            <div class="palette-title">Logic</div>
            <div class="palette-item" draggable="true" data-type="condition">
                <div class="palette-icon condition">üîÄ</div>
                <div class="palette-info">
                    <div class="palette-name">Decision</div>
                    <div class="palette-desc">Yes/No branching based on a condition</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="parallel">
                <div class="palette-icon condition">‚ö°</div>
                <div class="palette-info">
                    <div class="palette-name">Run in Parallel</div>
                    <div class="palette-desc">Run the next steps at the same time</div>
                </div>
            </div>
            <div class="palette-item" draggable="true" data-type="call_process">
                <div class="palette-icon action">üìã</div>
                <div class="palette-info">
                    <div class="palette-name">Call Process</div>
                    <div class="palette-desc">Run another published process as a sub-step</div>
                </div>
            </div>
        </div>

        <div class="palette-section" id="tools-section">
            <div class="palette-title">Integration</div>
            <p class="palette-desc" style="margin: 0 0 8px 0; padding: 0 8px; font-size: 11px; color: var(--pb-muted);">Connect to external systems and platform tools.</p>
            <div id="platform-tools-list">
                <!-- Loaded dynamically -->
                <div style="font-size: 11px; color: var(--pb-muted); padding: 8px;">Loading tools...</div>
            </div>
        </div>
    </div>
    
    <!-- Properties Panel (Right) -->
    <div id="properties-panel">
        <div class="properties-header">
            <div class="properties-icon action" id="prop-icon">‚ö°</div>
            <div class="properties-title">
                <h3 id="prop-title">Node Properties</h3>
                <span id="prop-type">Action</span>
            </div>
            <button class="properties-close" onclick="closeProperties()">√ó</button>
        </div>
        <div class="properties-body" id="prop-body">
            <!-- Dynamic content -->
        </div>
    </div>
    
    <!-- Build overlay (shows animated progress while workflow appears) -->
    <div id="build-overlay" aria-live="polite">
        <div class="build-card">
            <div class="build-top">
                <div>
                    <div class="build-title">Building your workflow</div>
                    <div class="build-subtitle" id="build-subtitle">Preparing‚Ä¶</div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <span id="build-step-counter" style="font-size:12px;color:var(--pb-muted);white-space:nowrap;"></span>
                </div>
            </div>
            <div class="build-progress">
                <div class="build-progress-bar" id="build-progress-bar"></div>
            </div>
        </div>
    </div>
    
    <!-- Approval step config modal -->
    <div id="approval-config-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:100;" onclick="if(event.target===this)closeApprovalConfigModal()">
        <div class="card rounded-xl w-full max-w-lg mx-4 p-6" style="background:#1f2937;border-radius:12px;" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold mb-4">Who should approve?</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Find the approver by</label>
                    <select id="approval-config-source" onchange="onApprovalConfigSourceChange()" class="property-select w-full rounded-lg px-4 py-2" style="width:100%;background:#111827;color:#fff;border:1px solid #374151;">
                        <option value="user_directory">Automatically from organization</option>
                        <option value="platform_user">A specific person</option>
                        <option value="platform_role">Anyone with a specific role</option>
                        <option value="platform_group">Anyone in a specific group</option>
                        <option value="tool">Via external system</option>
                    </select>
                </div>
                <div id="approval-config-platform-user-wrap" class="hidden">
                    <label class="block text-sm text-gray-400 mb-1">Select person(s)</label>
                    <select id="approval-config-user-list" multiple class="property-input w-full rounded-lg px-4 py-2" style="height:120px;width:100%;background:#111827;color:#fff;"></select>
                </div>
                <div id="approval-config-platform-role-wrap" class="hidden">
                    <label class="block text-sm text-gray-400 mb-1">Select role(s)</label>
                    <select id="approval-config-role-list" multiple class="property-input w-full rounded-lg px-4 py-2" style="height:120px;width:100%;background:#111827;color:#fff;"></select>
                </div>
                <div id="approval-config-platform-group-wrap" class="hidden">
                    <label class="block text-sm text-gray-400 mb-1">Select group(s)</label>
                    <select id="approval-config-group-list" multiple class="property-input w-full rounded-lg px-4 py-2" style="height:120px;width:100%;background:#111827;color:#fff;"></select>
                </div>
                <div id="approval-config-user-directory-wrap" class="hidden">
                    <label class="block text-sm text-gray-400 mb-1">Who from the organization?</label>
                    <select id="approval-config-directory-type" class="property-select w-full rounded-lg px-4 py-2" style="width:100%;background:#111827;color:#fff;border:1px solid #374151;">
                        <option value="dynamic_manager">Their direct manager</option>
                        <option value="department_manager">Department head</option>
                        <option value="management_chain">Higher management (skip level)</option>
                    </select>
                    <div id="approval-config-mgmt-level-wrap" class="hidden mt-3">
                        <label class="block text-sm text-gray-400 mb-1">How many levels up?</label>
                        <input type="number" id="approval-config-mgmt-level" min="1" max="10" value="2" class="property-input w-full rounded-lg px-4 py-2" style="width:100%;background:#111827;color:#fff;" placeholder="e.g. 2 = manager's manager">
                    </div>
                    <p class="text-xs text-gray-500 mt-2">The approver is automatically resolved from your organization's identity source (Org Chart, LDAP, or HR System).</p>
                </div>
                <div id="approval-config-tool-wrap" class="hidden">
                    <label class="block text-sm text-gray-400 mb-1">Select system</label>
                    <select id="approval-config-tool" class="property-select w-full rounded-lg px-4 py-2" style="width:100%;background:#111827;color:#fff;">
                        <option value="">-- Select --</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeApprovalConfigModal()" class="flex-1 py-2 rounded-lg" style="background:#374151;color:#fff;">Cancel</button>
                <button type="button" onclick="saveApprovalConfig()" class="flex-1 py-2 rounded-lg" style="background:#6366f1;color:#fff;">Done</button>
            </div>
        </div>
    </div>
    
    <!-- Organization Data Picker Modal -->
    <div id="org-data-picker-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:110;" onclick="if(event.target===this)closeOrgDataPicker()">
        <div class="card rounded-xl w-full max-w-2xl mx-4" style="background:#1f2937;border-radius:14px;max-height:80vh;display:flex;flex-direction:column;" onclick="event.stopPropagation()">
            <div style="padding:20px 24px 0;flex-shrink:0;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h3 style="font-size:16px;font-weight:700;color:#f3f4f6;">Browse Organization Data</h3>
                    <button onclick="closeOrgDataPicker()" style="background:none;border:none;color:#9ca3af;font-size:20px;cursor:pointer;">&times;</button>
                </div>
                <input id="org-data-search" type="text" placeholder="Search fields..." style="width:100%;padding:8px 12px;border-radius:8px;border:1px solid #374151;background:#111827;color:#f3f4f6;font-size:13px;outline:none;margin-bottom:12px;" oninput="filterOrgDataPicker(this.value)">
                <div style="display:flex;gap:4px;border-bottom:1px solid #374151;padding-bottom:0;">
                    <button class="org-picker-tab active" data-tab="profile" onclick="switchOrgPickerTab('profile')">User Profile</button>
                    <button class="org-picker-tab" data-tab="hierarchy" onclick="switchOrgPickerTab('hierarchy')">Management Chain</button>
                    <button class="org-picker-tab" data-tab="departments" onclick="switchOrgPickerTab('departments')">Departments</button>
                </div>
            </div>
            <div id="org-data-picker-body" style="overflow-y:auto;padding:16px 24px 20px;flex:1;">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
    <style>
        #org-data-picker-modal{display:none;}
        #org-data-picker-modal.show{display:flex;}
        .org-picker-tab{background:none;border:none;color:#9ca3af;font-size:13px;font-weight:500;padding:8px 14px;cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;}
        .org-picker-tab:hover{color:#e5e7eb;}
        .org-picker-tab.active{color:#818cf8;border-bottom-color:#818cf8;}
        .org-pick-group{margin-bottom:16px;}
        .org-pick-group-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:#6b7280;margin-bottom:6px;padding:0 4px;}
        .org-pick-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:8px;cursor:pointer;transition:background .12s;gap:8px;}
        .org-pick-item:hover{background:#374151;}
        .org-pick-item-left{display:flex;align-items:center;gap:10px;min-width:0;flex:1;}
        .org-pick-item-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
        .org-pick-item-info{min-width:0;flex:1;}
        .org-pick-item-label{font-size:13px;font-weight:500;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .org-pick-item-meta{font-size:11px;color:#6b7280;}
        .org-pick-item-btn{font-size:11px;padding:4px 12px;border-radius:6px;border:1px solid #4b5563;background:transparent;color:#a5b4fc;cursor:pointer;white-space:nowrap;transition:all .12s;}
        .org-pick-item-btn:hover{background:#4338ca;color:#fff;border-color:#4338ca;}
        .org-pick-empty{text-align:center;padding:32px 16px;color:#6b7280;font-size:13px;}
    </style>

    <!-- Zoom Controls -->
    <div id="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
        <span class="zoom-level" id="zoom-level">100%</span>
        <button class="zoom-btn" onclick="zoomIn()">+</button>
        <button class="zoom-btn" onclick="zoomReset()" title="Reset zoom">‚äô</button>
        <button class="zoom-btn" onclick="zoomFit()" title="Fit all steps in view">‚ä°</button>
    </div>
    
        <script src="/ui/dialogs.js?v=20260223c" defer></script>
        <script src="/ui/process-builder.js?v=20260223c" defer></script>
</body>
</html>

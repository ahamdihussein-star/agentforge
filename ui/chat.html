<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentForge - AI Assistant</title>
    <link rel="icon" type="image/png" href="/AgentForge_Logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Shared platform theme (same as Admin + Process Builder) -->
    <link rel="stylesheet" href="/ui/theme.css">
    <script src="/ui/theme.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            /* Compatibility aliases for this portal (mapped to shared theme.css vars) */
            --primary: var(--accent-primary);
            --primary-dark: var(--accent-secondary);
            --primary-light: var(--accent-primary);
            --bg-dark: var(--bg-primary);
            --bg-hover: var(--bg-input);
            --border: var(--border-color);
            --error: var(--danger);
            --gradient-1: var(--accent-gradient);
            --gradient-2: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-card) 100%);
            --shadow-lg: var(--shadow-md);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .new-chat-btn {
            width: 100%;
            margin-top: 16px;
            padding: 12px 16px;
            background: var(--gradient-1);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px color-mix(in srgb, var(--primary) 35%, transparent);
        }

        /* Portal Navigation */
        .portal-nav {
            padding: 12px 12px 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .nav-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .nav-group-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            cursor: pointer;
            color: var(--text-secondary);
            user-select: none;
            transition: all 0.15s;
            border: 1px solid transparent;
        }

        .nav-group-header:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-group-chevron {
            width: 16px;
            height: 16px;
            opacity: 0.8;
            transition: transform 0.15s;
        }

        .nav-subitems {
            display: none;
            flex-direction: column;
            gap: 6px;
            padding-left: 10px;
            margin-top: -2px;
            margin-bottom: 6px;
        }

        .nav-subitems.open {
            display: flex;
        }

        .nav-item.nav-sub {
            padding: 9px 12px;
            border-radius: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            cursor: pointer;
            color: var(--text-secondary);
            user-select: none;
            transition: all 0.15s;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--sidebar-active);
            color: var(--text-primary);
            border-color: color-mix(in srgb, var(--primary) 45%, transparent);
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .nav-label {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 650;
            line-height: 1;
        }

        .nav-badge {
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            border-radius: 999px;
            background: var(--error);
            color: #fff;
            font-size: 0.75rem;
            font-weight: 700;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .nav-badge.show {
            display: inline-flex;
        }

        /* =========== HOME DASHBOARD =========== */
        .home-view { overflow-y: auto; }
        .home-banner {
            padding: 36px 32px 28px;
            background: var(--gradient-1);
            position: relative;
            overflow: hidden;
        }
        .home-banner::after {
            content: '';
            position: absolute; inset: 0;
            background: radial-gradient(circle at 80% 30%, rgba(255,255,255,0.12) 0%, transparent 60%);
            pointer-events: none;
        }
        .home-banner-inner { max-width: 1080px; margin: 0 auto; position: relative; z-index: 1; }
        .home-greeting { font-size: 1.85rem; font-weight: 850; color: #fff; letter-spacing: -0.02em; }
        .home-tagline { margin-top: 6px; font-size: 1rem; color: rgba(255,255,255,0.82); }
        .home-stats {
            display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;
        }
        .home-stat {
            background: rgba(255,255,255,0.14);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.18);
            border-radius: 14px; padding: 14px 20px;
            display: flex; flex-direction: column; gap: 2px;
            min-width: 130px;
        }
        .home-stat-value { font-size: 1.4rem; font-weight: 850; color: #fff; }
        .home-stat-label { font-size: 0.78rem; color: rgba(255,255,255,0.72); text-transform: uppercase; letter-spacing: 0.04em; font-weight: 600; }
        .home-body { max-width: 1080px; margin: 0 auto; padding: 24px 32px 40px; }
        .home-section-title { font-size: 0.82rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 14px; }
        .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 28px; }
        .home-card {
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: 18px;
            padding: 22px;
            cursor: pointer;
            transition: transform 0.18s, border-color 0.18s, box-shadow 0.18s;
            position: relative;
            overflow: hidden;
        }
        .home-card::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: var(--gradient-1);
            opacity: 0;
            transition: opacity 0.18s;
        }
        .home-card:hover {
            transform: translateY(-2px);
            border-color: color-mix(in srgb, var(--primary) 50%, var(--border));
            box-shadow: 0 8px 28px color-mix(in srgb, var(--primary) 16%, transparent);
        }
        .home-card:hover::before { opacity: 1; }
        .home-card-header { display: flex; align-items: center; gap: 14px; margin-bottom: 10px; }
        .home-card-icon {
            width: 48px; height: 48px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.35rem; flex-shrink: 0;
        }
        .home-card-icon.chat { background: linear-gradient(135deg, #6D5EF7 0%, #00D4FF 100%); color: #fff; }
        .home-card-icon.process { background: linear-gradient(135deg, #10B981 0%, #06B6D4 100%); color: #fff; }
        .home-card-title { font-weight: 800; font-size: 1.1rem; letter-spacing: -0.01em; }
        .home-card-count { font-size: 0.78rem; color: var(--text-muted); margin-top: 2px; }
        .home-card-desc { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.4; margin-bottom: 14px; }
        .home-card-footer { display: flex; align-items: center; justify-content: space-between; }
        .home-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 999px;
            font-size: 0.78rem; font-weight: 600;
            border: 1px solid var(--border);
            color: var(--text-muted);
            background: color-mix(in srgb, var(--bg-card) 80%, var(--bg-primary));
        }
        .home-card-arrow {
            width: 36px; height: 36px; border-radius: 12px;
            display: inline-flex; align-items: center; justify-content: center;
            background: color-mix(in srgb, var(--primary) 14%, transparent);
            border: 1px solid color-mix(in srgb, var(--primary) 30%, transparent);
            color: var(--text-primary); font-size: 1.1rem;
            transition: transform 0.15s;
        }
        .home-card:hover .home-card-arrow { transform: translateX(2px); }
        .home-recent { display: flex; flex-direction: column; gap: 8px; }
        .home-recent-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 14px; border-radius: 12px;
            background: var(--bg-card); border: 1px solid var(--border);
            transition: border-color 0.12s; cursor: pointer;
        }
        .home-recent-item:hover { border-color: color-mix(in srgb, var(--primary) 40%, var(--border)); }
        .home-recent-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
        .home-recent-icon.chat-type { background: color-mix(in srgb, #6D5EF7 14%, transparent); }
        .home-recent-icon.process-type { background: color-mix(in srgb, #10B981 14%, transparent); }
        .home-recent-info { flex: 1; min-width: 0; }
        .home-recent-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .home-recent-meta { font-size: 0.78rem; color: var(--text-muted); }
        .home-empty { color: var(--text-muted); font-size: 0.9rem; padding: 18px; border: 1px dashed var(--border); border-radius: 14px; text-align: center; }

        /* Branding file upload */
        .brand-upload-zone {
            border: 2px dashed var(--border); border-radius: 14px; padding: 18px;
            text-align: center; cursor: pointer; transition: border-color 0.15s, background 0.15s;
            position: relative;
        }
        .brand-upload-zone:hover { border-color: var(--primary); background: color-mix(in srgb, var(--primary) 6%, transparent); }
        .brand-upload-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .brand-upload-zone .upload-label { font-size: 0.85rem; color: var(--text-muted); }
        .brand-upload-zone .upload-label strong { color: var(--primary); }
        .brand-preview { margin-top: 8px; max-height: 48px; border-radius: 8px; }

        @media (max-width: 820px) {
            .home-grid { grid-template-columns: 1fr; }
            .home-banner { padding: 24px 18px 20px; }
            .home-body { padding: 18px 16px 32px; }
        }

        /* =========== SKELETON LOADER =========== */
        @keyframes skeletonShimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, color-mix(in srgb, var(--border) 60%, transparent) 25%, color-mix(in srgb, var(--border) 30%, transparent) 50%, color-mix(in srgb, var(--border) 60%, transparent) 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s ease-in-out infinite;
            border-radius: 8px;
        }
        .skeleton-card {
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .skeleton-line { height: 14px; border-radius: 6px; }
        .skeleton-line.w-40 { width: 40%; }
        .skeleton-line.w-60 { width: 60%; }
        .skeleton-line.w-80 { width: 80%; }
        .skeleton-circle { width: 46px; height: 46px; border-radius: 14px; }

        /* =========== EMPTY STATES =========== */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 48px 24px;
            gap: 14px;
        }
        .empty-state-icon {
            width: 72px; height: 72px;
            border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem;
            background: color-mix(in srgb, var(--primary) 10%, transparent);
            border: 1px solid color-mix(in srgb, var(--primary) 20%, transparent);
        }
        .empty-state-title { font-size: 1.05rem; font-weight: 750; }
        .empty-state-desc { font-size: 0.9rem; color: var(--text-muted); max-width: 340px; line-height: 1.45; }
        .empty-state-action {
            margin-top: 6px;
            padding: 10px 20px;
            border-radius: 12px;
            background: var(--gradient-1);
            color: #fff;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .empty-state-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 14px color-mix(in srgb, var(--primary) 30%, transparent);
        }

        /* =========== MICRO INTERACTIONS =========== */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in { animation: fadeInUp 0.35s ease-out both; }
        .animate-in-delay-1 { animation-delay: 0.08s; }
        .animate-in-delay-2 { animation-delay: 0.16s; }
        .animate-in-delay-3 { animation-delay: 0.24s; }

        /* Button loading state */
        .portal-btn.loading {
            pointer-events: none;
            opacity: 0.7;
            position: relative;
        }
        .portal-btn.loading::after {
            content: '';
            width: 14px; height: 14px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: inline-block;
            margin-left: 6px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* View transition */
        .portal-view { animation: fadeInUp 0.25s ease-out; }
        .portal-view.hidden { animation: none; }

        /* Agent Selector */
        .agent-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .section-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .agent-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .agent-card {
            padding: 12px;
            background: var(--bg-hover);
            border: 1px solid transparent;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.18s;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .agent-card:hover {
            border-color: color-mix(in srgb, var(--primary) 50%, transparent);
            background: color-mix(in srgb, var(--primary) 10%, transparent);
            transform: translateX(2px);
        }

        .agent-card.active {
            border-color: var(--primary);
            background: color-mix(in srgb, var(--primary) 16%, transparent);
            box-shadow: 0 2px 8px color-mix(in srgb, var(--primary) 16%, transparent);
        }

        .agent-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .agent-info {
            flex: 1;
            min-width: 0;
        }

        .agent-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .agent-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Conversation History */
        .history-section {
            flex: 1;
            padding: 16px 20px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-item:hover {
            background: var(--bg-hover);
        }

        .history-item.active {
            background: var(--bg-hover);
        }
        
        .history-item.selected {
            background: color-mix(in srgb, var(--error) 14%, transparent);
            border: 1px solid color-mix(in srgb, var(--error) 32%, transparent);
        }
        
        .history-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }
        
        .history-checkbox:hover {
            border-color: var(--primary);
        }
        
        .history-checkbox.checked {
            background: var(--error);
            border-color: var(--error);
        }
        
        .history-checkbox.checked::after {
            content: 'âœ“';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .history-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .history-actions.hidden {
            display: none;
        }
        
        .select-all-btn {
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s;
        }
        
        .select-all-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .delete-selected-btn {
            font-size: 0.8rem;
            color: var(--error);
            cursor: pointer;
            padding: 4px 12px;
            border-radius: 4px;
            background: color-mix(in srgb, var(--error) 12%, transparent);
            border: 1px solid color-mix(in srgb, var(--error) 32%, transparent);
            transition: all 0.15s;
        }
        
        .delete-selected-btn:hover {
            background: var(--error);
            color: white;
        }
        
        .delete-selected-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .history-icon {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .history-title {
            flex: 1;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* User Section */
        .user-section {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: auto;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            /* overflow: hidden removed - was clipping the dropdown menu */
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            min-width: 32px;
            flex-shrink: 0;
            border-radius: 50%;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .user-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 160px;
        }

        .user-email {
            font-size: 0.65rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 160px;
        }

        .user-profile-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            padding: 6px;
            margin: -6px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.15s;
            min-width: 0;
            overflow: hidden;
        }

        .user-profile-trigger:hover {
            background: var(--bg-hover);
        }

        .user-chevron {
            color: var(--text-muted);
            transition: transform 0.2s;
            flex-shrink: 0;
            margin-left: auto;
        }

        .user-section:has(.user-menu.open) .user-chevron {
            transform: rotate(180deg);
        }

        /* Main Chat Area */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
            height: 100%;
            min-height: 0; /* Important for flex children to respect overflow */
            overflow: hidden;
        }

        /* Portal views (Chat / Workflows / My Requests / Inbox) */
        .portal-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .portal-header {
            padding: 18px 28px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-card);
            gap: 16px;
        }

        .portal-header-left {
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-width: 0;
        }

        .portal-title {
            font-size: 1.2rem;
            font-weight: 850;
            letter-spacing: -0.01em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .portal-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .portal-content {
            flex: 1;
            overflow: auto;
            padding: 24px;
            min-height: 0;
        }

        .portal-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-input {
            height: 40px;
            padding: 0 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-primary);
            min-width: 260px;
            outline: none;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .search-input:focus {
            border-color: color-mix(in srgb, var(--primary) 65%, var(--border));
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent);
        }

        .chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 14px;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.82rem;
            font-weight: 650;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s;
        }

        .chip:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .chip.active {
            background: color-mix(in srgb, var(--primary) 18%, transparent);
            border-color: color-mix(in srgb, var(--primary) 55%, var(--border));
            color: var(--text-primary);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
            margin-top: 18px;
        }

        .wf-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 170px;
            position: relative;
            overflow: hidden;
        }

        .wf-card::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, #10B981 0%, #06B6D4 100%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .wf-card:hover {
            transform: translateY(-3px);
            border-color: color-mix(in srgb, var(--primary) 50%, var(--border));
            box-shadow: 0 12px 32px color-mix(in srgb, var(--primary) 12%, transparent);
        }

        .wf-card:hover::before { opacity: 1; }

        .wf-card-top {
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }

        .wf-card-icon {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            background: linear-gradient(135deg, #10B981 0%, #06B6D4 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
        }

        .wf-card-title {
            font-size: 1.05rem;
            font-weight: 800;
            line-height: 1.15;
            margin-top: 2px;
        }

        .wf-card-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 6px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .wf-card-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-top: auto;
            padding-top: 8px;
            border-top: 1px solid color-mix(in srgb, var(--border) 60%, transparent);
        }

        .portal-btn {
            height: 38px;
            padding: 0 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-primary);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
        }

        .portal-btn:hover {
            background: var(--bg-hover);
        }

        .portal-btn-primary {
            border: none;
            background: var(--gradient-1);
            color: #fff;
        }

        .portal-btn-primary:hover {
            filter: brightness(1.05);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.78rem;
            font-weight: 750;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            background: color-mix(in srgb, var(--bg-card) 70%, transparent);
            max-width: 100%;
        }

        .status-pill .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-pill.success .dot { background: var(--success); }
        .status-pill.warning .dot { background: var(--warning); }
        .status-pill.danger .dot { background: var(--error); }
        .status-pill.muted .dot { background: var(--text-muted); }

        .split-layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 16px;
            min-height: 0;
        }

        @media (max-width: 1024px) {
            .split-layout {
                grid-template-columns: 1fr;
            }
        }

        .list-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 18px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
            box-shadow: var(--shadow-sm);
        }

        .list-panel-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            background: color-mix(in srgb, var(--bg-card) 92%, var(--bg-primary));
        }

        .list-panel-body {
            overflow: auto;
            min-height: 0;
        }

        .list-item {
            padding: 14px 16px;
            border-bottom: 1px solid color-mix(in srgb, var(--border) 45%, transparent);
            cursor: pointer;
            transition: background 0.15s, border-left 0.15s;
            border-left: 3px solid transparent;
        }

        .list-item:hover {
            background: var(--bg-hover);
        }

        .list-item.active {
            background: color-mix(in srgb, var(--primary) 10%, transparent);
            border-left-color: var(--primary);
        }

        .list-item-title {
            font-weight: 750;
            font-size: 0.92rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .list-item-meta {
            font-size: 0.78rem;
            color: var(--text-muted);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .detail-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 18px;
            overflow: hidden;
            min-height: 0;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-sm);
        }

        .detail-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            background: color-mix(in srgb, var(--bg-card) 92%, var(--bg-primary));
        }

        .detail-body {
            padding: 20px;
            overflow: auto;
            min-height: 0;
        }

        .kv-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 1024px) {
            .kv-grid { grid-template-columns: 1fr; }
        }

        .kv {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
            background: color-mix(in srgb, var(--bg-card) 82%, var(--bg-dark));
        }

        .kv .k {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 700;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }

        .kv .v {
            font-size: 0.9rem;
            color: var(--text-primary);
            word-break: break-word;
        }

        /* Chat Header */
        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-card);
        }

        .chat-agent-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-agent-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .chat-agent-details h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .chat-agent-details p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .chat-agent-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-actions {
            display: flex;
            gap: 8px;
        }

        .chat-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .chat-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Messages Area */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            min-height: 0; /* Critical for flex scroll */
            scroll-behavior: smooth;
        }
        
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .messages-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.1rem;
        }

        .message.assistant .message-avatar {
            background: var(--gradient-1);
        }

        .message.user .message-avatar {
            background: var(--bg-hover);
        }

        .message-content {
            padding: 14px 18px;
            border-radius: 16px;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        /* Table styling (same as main app) */
        .message-content .table-container {
            overflow-x: auto;
            margin: 0.75rem 0;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }
        .message-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            min-width: max-content;
            background: var(--bg-card);
        }
        .message-content th {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 0.625rem 0.75rem;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            border: none;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.025em;
        }
        .message-content td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            vertical-align: top;
            word-break: break-word;
        }
        .message-content tr:last-child td {
            border-bottom: none;
        }
        .message-content tbody tr {
            transition: background 0.15s ease;
        }
        .message-content tbody tr:nth-child(even) {
            background: color-mix(in srgb, var(--primary) 6%, transparent);
        }
        .message-content tbody tr:hover {
            background: color-mix(in srgb, var(--primary) 10%, transparent);
        }
        
        /* Code styling */
        .message-content code {
            background: color-mix(in srgb, var(--primary) 14%, transparent);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85em;
        }
        .message-content pre {
            background: var(--bg-dark);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message.assistant .message-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 6px;
            text-align: right;
        }

        .message.user .message-time {
            text-align: left;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        /* Thinking/Reasoning Display - Like ChatGPT/Cursor */
        .thinking-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 8px;
            animation: fadeIn 0.3s ease;
        }

        .thinking-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            user-select: none;
        }

        .thinking-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            animation: pulse 2s infinite;
        }

        .thinking-icon.done {
            background: var(--success);
            animation: none;
        }

        .thinking-icon.error {
            background: var(--error);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(0.95); }
        }

        .thinking-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary-light);
            flex: 1;
        }

        .thinking-title.done {
            color: var(--success);
        }

        .thinking-toggle {
            color: var(--text-muted);
            font-size: 0.8rem;
            transition: transform 0.2s;
        }

        .thinking-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .thinking-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .thinking-steps.collapsed {
            display: none;
        }

        .thinking-step {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-hover);
            border-radius: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            animation: slideInStep 0.3s ease;
        }

        @keyframes slideInStep {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .step-icon {
            font-size: 1rem;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .step-icon.thinking { color: var(--primary-light); }
        .step-icon.tool { color: var(--warning); }
        .step-icon.success { color: var(--success); }
        .step-icon.error { color: var(--error); }
        .step-icon.source { color: #06b6d4; }

        .step-content {
            flex: 1;
            line-height: 1.5;
        }

        .step-content code {
            background: var(--bg-dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
        }

        .thinking-steps::-webkit-scrollbar {
            width: 4px;
        }

        .thinking-steps::-webkit-scrollbar-track {
            background: transparent;
        }

        .thinking-steps::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        /* Tool call badge */
        .tool-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 6px;
            font-size: 0.75rem;
            color: var(--warning);
            margin-left: 8px;
        }

        /* Sources section */
        .sources-section {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .sources-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .sources-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .source-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 6px;
            font-size: 0.75rem;
            color: #06b6d4;
        }

        .source-chip .relevance {
            background: rgba(6, 182, 212, 0.2);
            padding: 1px 5px;
            border-radius: 4px;
            font-size: 0.65rem;
        }

        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            border-radius: 24px;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px color-mix(in srgb, var(--primary) 28%, transparent);
        }

        .welcome-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .welcome-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            max-width: 400px;
            line-height: 1.6;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 32px;
            max-width: 600px;
        }

        .suggestion-chip {
            padding: 12px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            border-color: var(--primary);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        /* Input Area */
        .input-area {
            padding: 20px 24px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px 16px;
            transition: border-color 0.2s;
        }

        .input-container:focus-within {
            border-color: var(--primary);
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            min-height: 24px;
        }

        .message-input::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .input-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .input-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .send-btn {
            background: var(--gradient-1);
            color: white;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-2);
            padding: 20px;
        }

        .login-card {
            width: 100%;
            max-width: 420px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo {
            width: 64px;
            height: 64px;
            background: var(--gradient-1);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--gradient-1);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px color-mix(in srgb, var(--primary) 35%, transparent);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 24px 0;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .login-divider::before,
        .login-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .social-login {
            display: flex;
            gap: 12px;
        }

        .social-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-btn:hover {
            border-color: var(--primary);
            background: var(--bg-hover);
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                overflow: hidden;
            }
            
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                z-index: 100;
                transition: left 0.3s;
                width: 280px;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 99;
            }

            .sidebar-overlay.open {
                display: block;
            }

            .main-chat {
                width: 100%;
            }
            
            .chat-header {
                padding: 12px 16px;
            }
            
            .chat-agent-icon {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }
            
            .chat-agent-details h2 {
                font-size: 0.95rem;
            }
            
            .messages-container {
                padding: 16px;
            }

            .message {
                max-width: 90%;
            }
            
            .message-content {
                padding: 10px 14px;
                font-size: 0.9rem;
            }
            
            .input-area {
                padding: 12px 16px;
            }
            
            .input-container {
                padding: 10px 12px;
            }
            
            .welcome-screen h1 {
                font-size: 1.5rem;
            }
            
            .welcome-screen p {
                font-size: 0.9rem;
            }
            
            .modal {
                max-width: 95%;
                margin: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .chat-actions {
                gap: 4px;
            }
            
            .chat-action-btn {
                width: 36px;
                height: 36px;
            }
            
            .input-actions {
                gap: 4px;
            }
            
            .send-btn {
                width: 38px;
                height: 38px;
            }
        }

        /* User Menu Dropdown */
        .user-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            margin-bottom: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px;
            display: none;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
        }

        .user-menu.open {
            display: block;
        }

        .user-menu-item {
            padding: 10px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: all 0.15s;
        }

        .user-menu-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .user-menu-item.danger {
            color: var(--error);
        }

        .user-menu-item.danger:hover {
            background: color-mix(in srgb, var(--error) 12%, transparent);
        }

        /* Hidden */
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.2s;
        }

        .modal-overlay.open .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }

        .modal-section {
            margin-bottom: 24px;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 16px;
        }

        .profile-avatar-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
        }

        .profile-avatar-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn-secondary {
            padding: 10px 16px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-secondary:hover {
            border-color: var(--primary);
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .setting-info h4 {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .setting-info p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 28px;
            background: var(--bg-hover);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-switch.active {
            background: var(--primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        .theme-options {
            display: flex;
            gap: 12px;
        }

        .theme-option {
            flex: 1;
            padding: 16px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
        }

        .theme-option:hover {
            border-color: var(--primary-light);
        }

        .theme-option.active {
            border-color: var(--primary);
            background: color-mix(in srgb, var(--primary) 12%, transparent);
        }

        .theme-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .theme-label {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .btn-primary {
            padding: 12px 20px;
            background: var(--gradient-1);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px color-mix(in srgb, var(--primary) 35%, transparent);
        }

        .btn-danger {
            background: var(--error);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 12px color-mix(in srgb, var(--error) 35%, transparent);
        }

        /* Organization Banner (thin top bar; not part of flex layout) */
        :root { --org-banner-height: 0px; }
        .org-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 34px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.82rem;
            font-weight: 650;
            letter-spacing: 0.01em;
            z-index: 100000;
            box-shadow: 0 10px 24px rgba(0,0,0,0.18);
            border-bottom: 1px solid color-mix(in srgb, var(--border) 45%, transparent);
            user-select: none;
        }
        .org-banner a { color: inherit; text-decoration: underline; }
        .org-banner strong { font-weight: 800; }

        /* Offset app surfaces when banner is enabled */
        #login-screen,
        #chat-interface {
            padding-top: var(--org-banner-height);
        }

        .org-banner-logo {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            object-fit: contain;
        }

        .hidden {
            display: none !important;
        }

        /* Additional Modal Styles for Profile/Settings */
        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .modal-section {
            margin-bottom: 24px;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 16px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
        }

        .profile-info h3 {
            font-size: 1.25rem;
            margin-bottom: 4px;
        }

        .profile-info p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 0.95rem;
        }

        .setting-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--bg-hover);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle.active {
            background: var(--primary);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left 0.2s;
        }

        .toggle.active::after {
            left: 25px;
        }

        /* Theme Selector */
        .theme-options {
            display: flex;
            gap: 12px;
        }

        .theme-option {
            flex: 1;
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .theme-option:hover {
            border-color: var(--primary-light);
        }

        .theme-option.active {
            border-color: var(--primary);
            background: color-mix(in srgb, var(--primary) 12%, transparent);
        }

        .theme-icon {
            font-size: 1.5rem;
            margin-bottom: 6px;
        }

        .theme-name {
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Form in Modal */
        .modal-form-group {
            margin-bottom: 16px;
        }

        .modal-form-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .modal-form-input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
        }

        .modal-form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-wrapper .modal-form-input {
            padding-right: 48px;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.15s;
        }

        .password-toggle:hover {
            color: var(--text-primary);
        }

        .password-toggle.active {
            color: var(--primary);
        }

        .modal-btn {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .modal-btn-primary {
            background: var(--gradient-1);
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px color-mix(in srgb, var(--primary) 30%, transparent);
        }

        .modal-btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-btn-secondary:hover {
            background: var(--border);
        }

        .modal-btn-danger {
            background: color-mix(in srgb, var(--error) 16%, transparent);
            color: var(--error);
        }

        .modal-btn-danger:hover {
            background: var(--error);
            color: white;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* MFA Badge */
        .mfa-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .mfa-badge.enabled {
            background: color-mix(in srgb, var(--success) 18%, transparent);
            color: var(--success);
        }

        .mfa-badge.disabled {
            background: color-mix(in srgb, var(--error) 18%, transparent);
            color: var(--error);
        }

        /* Organization Banner (legacy duplicate; keep aligned with main definition) */
        .org-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 34px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.82rem;
            font-weight: 650;
            letter-spacing: 0.01em;
            z-index: 100000;
            box-shadow: 0 10px 24px rgba(0,0,0,0.18);
            border-bottom: 1px solid color-mix(in srgb, var(--border) 45%, transparent);
            user-select: none;
        }

    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <img src="/AgentForge_Logo.png" alt="AgentForge" style="width: 60px; height: 60px; object-fit: contain; border-radius: 12px;">
                </div>
                <h1 class="login-title">Welcome Back</h1>
                <p class="login-subtitle">Sign in to continue to your AI Assistant</p>
            </div>
            
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="login-email" class="form-input" placeholder="you@example.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="login-password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                
                <button type="submit" class="login-btn" id="login-btn">
                    Sign In
                </button>
            </form>
            
            <div class="login-divider">or continue with</div>
            
            <div class="social-login">
                <button class="social-btn" onclick="handleGoogleLogin()" title="Google">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                </button>
                <button class="social-btn" onclick="handleMicrosoftLogin()" title="Microsoft">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.4 24H0V12.6h11.4V24z" fill="#00A4EF"/>
                        <path d="M24 24H12.6V12.6H24V24z" fill="#FFB900"/>
                        <path d="M11.4 11.4H0V0h11.4v11.4z" fill="#F25022"/>
                        <path d="M24 11.4H12.6V0H24v11.4z" fill="#7FBA00"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chat-interface" class="hidden" style="display: none; width: 100%; height: calc(100vh - var(--org-banner-height, 0px));">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="/AgentForge_Logo.png" alt="AgentForge" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">
                    </div>
                    <span>AgentForge</span>
                </div>
                <button class="new-chat-btn" id="new-chat-btn" onclick="startNewChat()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Chat
                </button>
            </div>

            <!-- Portal Navigation -->
            <div class="portal-nav" id="portal-nav">
                <div class="nav-item active" data-view="home" onclick="switchView('home')">
                    <span class="nav-icon">ðŸ </span>
                    <span class="nav-label">Home</span>
                </div>
                <div class="nav-item" data-view="chat" onclick="switchView('chat')">
                    <span class="nav-icon">ðŸ’¬</span>
                    <span class="nav-label">Assistants</span>
                </div>

                <div class="nav-group" id="nav-group-processes">
                    <div class="nav-group-header" onclick="toggleNavGroup('processes')" title="Processes and automation">
                        <span class="nav-icon">ðŸ§©</span>
                        <span class="nav-label">Processes</span>
                        <svg class="nav-group-chevron" id="nav-chevron-processes" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="nav-subitems open" id="nav-subitems-processes" data-group="processes">
                        <div class="nav-item nav-sub" data-view="workflows" onclick="switchView('workflows')">
                            <span class="nav-icon">ðŸ§©</span>
                            <span class="nav-label">Browse</span>
                        </div>
                        <div class="nav-item nav-sub" data-view="requests" onclick="switchView('requests')">
                            <span class="nav-icon">ðŸ“„</span>
                            <span class="nav-label">Runs</span>
                        </div>
                        <div class="nav-item nav-sub" data-view="inbox" onclick="switchView('inbox')">
                            <span class="nav-icon">âœ…</span>
                            <span class="nav-label">Inbox</span>
                            <span class="nav-badge" id="nav-inbox-badge"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chat-sidebar-panels">
                <!-- Agent Selector -->
                <div class="agent-section">
                    <div class="section-label">Assistants</div>
                    <div class="agent-selector" id="agent-list">
                        <!-- Conversational agents loaded dynamically -->
                    </div>
                </div>

                <!-- Conversation History -->
                <div class="history-section">
                    <div class="section-label" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Recent Chats</span>
                        <span id="edit-chats-btn" onclick="toggleSelectionMode()" style="font-size: 0.75rem; color: var(--primary); cursor: pointer;">Edit</span>
                    </div>
                    <div id="history-actions" class="history-actions hidden">
                        <span class="select-all-btn" onclick="toggleSelectAll()">
                            <span id="select-all-text">Select All</span>
                        </span>
                        <button id="delete-selected-btn" class="delete-selected-btn" onclick="deleteSelectedChats()" disabled>
                            Delete (0)
                        </button>
                    </div>
                    <div id="history-list">
                        <!-- History loaded dynamically -->
                    </div>
                </div>
            </div>

            <!-- User Section -->
            <div class="user-section" style="position: relative;">
                <div class="user-profile-trigger" onclick="toggleUserMenu(event)">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="user-name">User</div>
                        <div class="user-email" id="user-email">user@example.com</div>
                    </div>
                    <svg class="user-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
                
                <div class="user-menu" id="user-menu">
                    <div class="user-menu-item" onclick="showProfile()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Profile
                    </div>
                    <div class="user-menu-item" onclick="showSettings()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        Settings
                    </div>
                    <div class="user-menu-item danger" onclick="handleLogout()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Sign Out
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

        <!-- Main Chat -->
        <div class="main-chat">
            <!-- Home View -->
            <div id="view-home" class="portal-view home-view hidden">
                <div class="home-banner" id="home-banner">
                    <div class="home-banner-inner">
                        <div class="home-greeting" id="home-greeting">Welcome</div>
                        <div class="home-tagline" id="home-tagline">Your AI workspace â€” chat with assistants or run business processes.</div>
                        <div class="home-stats" id="home-stats">
                            <div class="home-stat">
                                <div class="home-stat-value" id="home-stat-assistants">0</div>
                                <div class="home-stat-label">Assistants</div>
                            </div>
                            <div class="home-stat">
                                <div class="home-stat-value" id="home-stat-processes">0</div>
                                <div class="home-stat-label">Processes</div>
                            </div>
                            <div class="home-stat">
                                <div class="home-stat-value" id="home-stat-inbox">0</div>
                                <div class="home-stat-label">Pending</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="home-body">
                    <div class="home-section-title">Get Started</div>
                    <div class="home-grid">
                        <div class="home-card" onclick="switchView('chat')">
                            <div class="home-card-header">
                                <div class="home-card-icon chat">ðŸ’¬</div>
                                <div>
                                    <div class="home-card-title">AI Assistants</div>
                                    <div class="home-card-count" id="home-assistants-label">Conversational AI</div>
                                </div>
                            </div>
                            <div class="home-card-desc">Ask questions, draft content, analyze documents, and collaborate with your AI assistants in real time.</div>
                            <div class="home-card-footer">
                                <span class="home-badge">Chat &bull; Real-time</span>
                                <span class="home-card-arrow">&rarr;</span>
                            </div>
                        </div>
                        <div class="home-card" onclick="switchView('workflows')">
                            <div class="home-card-header">
                                <div class="home-card-icon process">ðŸ§©</div>
                                <div>
                                    <div class="home-card-title">Processes</div>
                                    <div class="home-card-count" id="home-processes-label">Workflows &amp; Automation</div>
                                </div>
                            </div>
                            <div class="home-card-desc">Start guided workflows, submit forms, track execution progress, and manage approvals â€” all in one place.</div>
                            <div class="home-card-footer">
                                <span class="home-badge">Forms &bull; Approvals &bull; Automation</span>
                                <span class="home-card-arrow">&rarr;</span>
                            </div>
                        </div>
                    </div>

                    <div class="home-section-title">Quick Access</div>
                    <div class="home-recent" id="home-recent">
                        <div class="home-empty">Your recent activity will appear here once you start chatting or running processes.</div>
                    </div>
                </div>
            </div>

            <!-- Chat View -->
            <div id="view-chat" class="portal-view">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-agent-info">
                        <button class="chat-action-btn" onclick="toggleSidebar()" style="display: none;" id="mobile-menu-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="3" y1="12" x2="21" y2="12"></line>
                                <line x1="3" y1="6" x2="21" y2="6"></line>
                                <line x1="3" y1="18" x2="21" y2="18"></line>
                            </svg>
                        </button>
                        <div class="chat-agent-icon" id="current-agent-icon">ðŸ¤–</div>
                        <div class="chat-agent-details">
                            <h2 id="current-agent-name">Select an Assistant</h2>
                            <div class="chat-agent-status">
                                <span class="status-dot"></span>
                                <span>Online</span>
                            </div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="clearCurrentChat()" title="Clear Chat">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="messages-container" id="messages-container">
                    <!-- Welcome Screen -->
                    <div class="welcome-screen" id="welcome-screen">
                        <div class="welcome-icon" style="animation: fadeInUp 0.4s ease-out both;">ðŸ’¬</div>
                        <h1 class="welcome-title" style="animation: fadeInUp 0.4s ease-out 0.1s both;">How can I help you today?</h1>
                        <p class="welcome-subtitle" style="animation: fadeInUp 0.4s ease-out 0.18s both;">Pick an assistant from the sidebar, then ask anything. I'm ready when you are.</p>
                        <div class="suggestions" id="suggestions" style="animation: fadeInUp 0.4s ease-out 0.26s both;">
                            <div class="suggestion-chip" onclick="sendSuggestion(this)">What can you help me with?</div>
                            <div class="suggestion-chip" onclick="sendSuggestion(this)">Summarize a document for me</div>
                            <div class="suggestion-chip" onclick="sendSuggestion(this)">How do I get started?</div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-container">
                        <textarea 
                            id="message-input" 
                            class="message-input" 
                            placeholder="Type your message..." 
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                        ></textarea>
                        <div class="input-actions">
                            <button class="input-action-btn" onclick="attachFile()" title="Attach File">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                </svg>
                            </button>
                            <button class="input-action-btn send-btn" id="send-btn" onclick="sendMessage()" title="Send">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflows View -->
            <div id="view-workflows" class="portal-view hidden">
                <div class="portal-header">
                    <div class="portal-header-left">
                        <div class="portal-title">ðŸ§© Processes</div>
                        <div class="portal-subtitle">Browse, start, and manage business processes and automations.</div>
                    </div>
                    <div class="portal-toolbar">
                        <input id="workflow-search" class="search-input" placeholder="Search processesâ€¦" oninput="renderWorkflows()">
                        <button class="portal-btn" onclick="refreshWorkflows()">Refresh</button>
                    </div>
                </div>
                <div class="portal-content">
                    <div class="chip-row" id="workflow-category-chips"></div>
                    <div class="card-grid" id="workflow-cards"></div>
                </div>
            </div>

            <!-- My Requests View -->
            <div id="view-requests" class="portal-view hidden">
                <div class="portal-header">
                    <div class="portal-header-left">
                        <div class="portal-title">ðŸ“„ Runs</div>
                        <div class="portal-subtitle">Track process executions, view step details, and monitor outcomes.</div>
                    </div>
                    <div class="portal-toolbar">
                        <input id="requests-search" class="search-input" placeholder="Search requestsâ€¦" oninput="renderRequests()">
                        <button class="portal-btn" onclick="refreshRequests()">Refresh</button>
                    </div>
                </div>
                <div class="portal-content">
                    <div class="chip-row" id="requests-scope-chips"></div>
                    <div class="chip-row" id="requests-filter-chips"></div>
                    <div class="split-layout">
                        <div class="list-panel">
                            <div class="list-panel-header">
                                <span style="font-weight: 750;">Runs</span>
                                <span style="margin-left:auto; color: var(--text-muted); font-size: 0.8rem;" id="requests-count"></span>
                            </div>
                            <div class="list-panel-body" id="requests-list"></div>
                        </div>
                        <div class="detail-panel">
                            <div class="detail-header">
                                <div>
                                    <div style="font-weight: 800; font-size: 1rem;" id="request-detail-title">Select a request</div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem;" id="request-detail-subtitle">Youâ€™ll see status, inputs, and step-by-step progress here.</div>
                                </div>
                                <div class="portal-toolbar">
                                    <button class="portal-btn" onclick="refreshSelectedRequest()" id="request-refresh-btn" disabled>Refresh</button>
                                </div>
                            </div>
                            <div class="detail-body" id="request-detail-body"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inbox View -->
            <div id="view-inbox" class="portal-view hidden">
                <div class="portal-header">
                    <div class="portal-header-left">
                        <div class="portal-title">âœ… Inbox</div>
                        <div class="portal-subtitle">Review and respond to pending approvals and tasks assigned to you.</div>
                    </div>
                    <div class="portal-toolbar">
                        <input id="inbox-search" class="search-input" placeholder="Search inboxâ€¦" oninput="renderInbox()">
                        <button class="portal-btn" onclick="refreshInbox()">Refresh</button>
                    </div>
                </div>
                <div class="portal-content">
                    <div class="split-layout">
                        <div class="list-panel">
                            <div class="list-panel-header">
                                <span style="font-weight: 750;">Pending approvals</span>
                                <span style="margin-left:auto; color: var(--text-muted); font-size: 0.8rem;" id="inbox-count"></span>
                            </div>
                            <div class="list-panel-body" id="inbox-list"></div>
                        </div>
                        <div class="detail-panel">
                            <div class="detail-header">
                                <div>
                                    <div style="font-weight: 800; font-size: 1rem;" id="inbox-detail-title">Select an item</div>
                                    <div style="color: var(--text-muted); font-size: 0.85rem;" id="inbox-detail-subtitle">Review details and approve/reject.</div>
                                </div>
                                <div class="portal-toolbar">
                                    <button class="portal-btn" onclick="refreshSelectedApproval()" id="inbox-refresh-btn" disabled>Refresh</button>
                                </div>
                            </div>
                            <div class="detail-body" id="inbox-detail-body"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentUser = null;
        let currentAgent = null;
        let currentConversation = null;
        // Accessible agents split by type
        let allAccessibleAgents = [];
        let agents = []; // conversational agents (chat)
        let workflowAgents = []; // process agents (workflows)
        let conversations = [];
        
        // Portal view state
        let currentView = 'home';
        let workflowCategoryFilter = 'All';
        let currentWorkflowAgent = null;
        let workflowRunInputs = [];
        let myRequests = []; // workflow runs list (UI label: Runs)
        let myApprovals = [];
        let requestsScope = 'mine'; // mine | org
        let requestsWorkflowFilterId = null; // workflow id filter for runs
        let selectedExecutionId = null;
        let selectedApprovalId = null;
        let currentBranding = null; // org branding payload (if available)
        const API = '';

        // Helper function to get auth token from either storage
        // NOTE: The platform standard is `agentforge_token` (admin portal + process builder).
        // We still read legacy `token` for backward compatibility and migrate it forward.
        function getToken() {
            const primary =
                localStorage.getItem('agentforge_token') ||
                sessionStorage.getItem('agentforge_token');
            if (primary) return primary;

            const legacy =
                localStorage.getItem('token') ||
                sessionStorage.getItem('token');

            // Migrate legacy key â†’ standard key (best effort)
            if (legacy) {
                try {
                    if (!localStorage.getItem('agentforge_token')) {
                        localStorage.setItem('agentforge_token', legacy);
                    }
                } catch (_) { /* ignore */ }
            }
            return legacy;
        }
        
        // Helper function to get auth headers
        function getAuthHeaders() {
            const token = getToken();
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = (str == null) ? '' : String(str);
            return div.innerHTML;
        }

        function humanizeFieldLabel(id) {
            const raw = String(id || '').trim();
            if (!raw) return '';
            // Map well-known technical keys to business-friendly labels
            const knownLabels = {
                'trigger_input': 'Submitted Information',
                'requested_by': 'Requested By',
                'requester_email': 'Requester Email',
                'requester_name': 'Requester Name',
                'requester_id': 'Requester',
                'manager_id': 'Manager',
                'manager_name': 'Manager Name',
                'manager_email': 'Manager Email',
                'department_id': 'Department',
                'department_name': 'Department',
                'employee_id': 'Employee ID',
                'job_title': 'Job Title',
                'org_id': 'Organization',
                'user_id': 'User',
                'created_at': 'Submitted On',
                'updated_at': 'Last Updated',
                'start_date': 'Start Date',
                'end_date': 'End Date',
                'due_date': 'Due Date',
                'total_amount': 'Total Amount',
                'is_manager': 'Is Manager',
                'group_ids': 'Groups',
                'role_ids': 'Roles',
                '_user_context': null, // Hide internal context
            };
            const lower = raw.toLowerCase();
            if (lower in knownLabels) {
                return knownLabels[lower] === null ? '' : knownLabels[lower];
            }
            return raw
                .replace(/[_-]+/g, ' ')
                .replace(/([a-z])([A-Z])/g, '$1 $2')
                .replace(/\s+/g, ' ')
                .trim()
                .split(' ')
                .map(w => w ? (w[0].toUpperCase() + w.slice(1)) : '')
                .join(' ');
        }

        /** Map technical node/step types to business-friendly labels */
        function humanizeNodeType(type) {
            const map = {
                'human_task': 'Task',
                'approval': 'Approval',
                'condition': 'Decision',
                'notification': 'Notification',
                'email': 'Email',
                'trigger': 'Start',
                'form': 'Form',
                'start': 'Start',
                'end': 'Complete',
                'tool': 'Automated Action',
                'script': 'Automated Action',
                'api_call': 'Integration',
                'webhook': 'Integration',
                'delay': 'Wait',
                'timer': 'Scheduled',
                'parallel': 'Parallel Steps',
                'loop': 'Repeated Step',
                'subprocess': 'Sub-Process',
            };
            const key = String(type || '').toLowerCase().trim();
            return map[key] || humanizeFieldLabel(key) || 'Step';
        }

        /** Map technical urgency values to business-friendly labels */
        function humanizeUrgency(urgency) {
            const map = {
                'high': 'Urgent',
                'critical': 'Critical',
                'normal': 'Normal',
                'medium': 'Normal',
                'low': 'Low Priority',
            };
            const key = String(urgency || '').toLowerCase().trim();
            return map[key] || urgency || 'Normal';
        }

        /** Sanitize error messages â€” hide technical details from business users */
        function friendlyErrorMessage(rawMsg, fallback) {
            const msg = String(rawMsg || '').trim();
            const fb = fallback || 'Something went wrong. Please try again.';
            if (!msg) return fb;
            // Hide internal/technical error patterns
            if (/traceback|stack trace|internal server/i.test(msg)) return fb;
            if (/sqlalchemy|database|sql|connection refused|errno/i.test(msg)) return 'A system error occurred. Please try again or contact support.';
            if (/500|502|503|504/.test(msg) && msg.length < 20) return fb;
            if (/keyerror|typeerror|attributeerror|valueerror|importerror/i.test(msg)) return fb;
            if (/null|undefined|NoneType/i.test(msg) && msg.length < 50) return fb;
            // Let through business-friendly messages
            return msg;
        }

        // Check authentication on load
        document.addEventListener('DOMContentLoaded', () => {
            const token = getToken();
            if (token) {
                validateToken(token);
            } else {
                // Stay on this page and show the built-in login screen (do NOT redirect to admin portal)
                showLoginScreen();
            }
            setupMobileMenu();
        });

        async function validateToken(token) {
            try {
                const response = await fetch(`${API}/api/security/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    currentUser = await response.json();
                    showChatInterface();
                    loadAgents();
                    refreshInboxBadge();
                    return;
                }
                
                // Invalid/expired token â†’ clear and show login screen (no redirects)
                try {
                    localStorage.removeItem('agentforge_token');
                    sessionStorage.removeItem('agentforge_token');
                    localStorage.removeItem('token'); // legacy
                    sessionStorage.removeItem('token'); // legacy
                } catch (_) { /* ignore */ }
                currentUser = null;
                showLoginScreen();
            } catch (e) {
                console.error('Token validation failed:', e);
                // If we cannot validate, keep the login screen visible
                try { showLoginScreen(); } catch (_) {}
            }
        }

        // MFA Login State (same pattern as admin portal)
        window.pendingLoginEmail = null;
        window.pendingLoginPassword = null;
        window.pendingMfaMethods = [];

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            
            btn.disabled = true;
            btn.textContent = 'Signing in...';
            
            try {
                const response = await fetch(`${API}/api/security/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (!response.ok && !data.requires_mfa && !data.mfa_required) {
                    showToast(data.detail || 'Login failed', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Sign In';
                    return;
                }
                
                // Check if MFA is required (same robust check as admin portal)
                const isMfaRequired = data.requires_mfa === true || 
                                     data.mfa_required === true || 
                                     data.requires_mfa === "true" || 
                                     data.mfa_required === "true" ||
                                     String(data.requires_mfa).toLowerCase() === "true" ||
                                     String(data.mfa_required).toLowerCase() === "true";
                
                if (isMfaRequired) {
                    btn.disabled = false;
                    btn.textContent = 'Sign In';
                    
                    // Store credentials temporarily for MFA verification
                    window.pendingLoginEmail = email;
                    window.pendingLoginPassword = password;
                    window.pendingMfaMethods = data.mfa_methods || [];
                    
                    showLoginMfaModal(window.pendingMfaMethods);
                    return;
                }
                
                // Success - complete login
                try {
                    localStorage.setItem('agentforge_token', data.access_token);
                    sessionStorage.setItem('agentforge_token', data.access_token);
                    // Remove legacy key to avoid confusion
                    localStorage.removeItem('token');
                    sessionStorage.removeItem('token');
                } catch (_) { /* ignore */ }
                currentUser = data.user;
                showChatInterface();
                loadAgents();
                showToast('Welcome back!', 'success');
                
            } catch (e) {
                showToast('Connection error. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        }

        function showLoginMfaModal(methods) {
            // Remove existing modal if present (same as admin portal)
            const existingModal = document.getElementById('login-mfa-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Mask email for privacy (same as admin portal)
            const email = window.pendingLoginEmail || 'your email';
            const maskEmail = (email) => {
                if (!email || email === 'your email') return email;
                const [local, domain] = email.split('@');
                if (local.length <= 2) return email;
                const visible = local.substring(0, 2);
                const masked = '*'.repeat(Math.min(local.length - 2, 4));
                return `${visible}${masked}@${domain}`;
            };
            const displayEmail = maskEmail(email);
            
            const modal = document.createElement('div');
            modal.id = 'login-mfa-modal';
            modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;';
            modal.onclick = (e) => { if (e.target === modal) closeLoginMfaModal(); };
            
            // Same HTML structure as admin portal
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 16px; padding: 24px; width: 100%; max-width: 400px; margin: 16px;">
                    <div style="text-align: center; margin-bottom: 24px;">
                        <div style="font-size: 3rem; margin-bottom: 12px;">ðŸ”</div>
                        <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 8px; color: var(--text-primary);">Two-Factor Authentication</h3>
                        <p style="color: var(--text-muted); font-size: 0.875rem;">Enter the 6-digit code sent to</p>
                        <p style="color: var(--accent); font-weight: 600; font-size: 0.875rem; margin-top: 4px;" title="${email}">${displayEmail}</p>
                    </div>
                    
                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; background: rgba(34, 197, 94, 0.2); display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 1.25rem; color: #22c55e;">âœ“</span>
                            </div>
                            <div style="flex: 1;">
                                <p style="color: #22c55e; font-weight: 500; font-size: 0.875rem;">Code sent successfully!</p>
                                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">Please check your email inbox</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Verification Code</label>
                        <input 
                            type="text" 
                            id="login-mfa-code" 
                            style="width: 100%; padding: 16px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; text-align: center; font-size: 1.875rem; letter-spacing: 0.5em; font-family: monospace; font-weight: 600; color: var(--text-primary); outline: none; transition: all 0.2s;"
                            placeholder="000000" 
                            maxlength="6" 
                            pattern="[0-9]{6}"
                            inputmode="numeric"
                            autocomplete="one-time-code"
                            onfocus="this.style.borderColor='var(--accent)'; this.style.boxShadow='0 0 0 3px rgba(139, 92, 246, 0.2)';"
                            onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none';"
                            onkeydown="if(event.key==='Enter')verifyLoginMfa()"
                        >
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; text-align: center;">Enter the 6-digit code from your email</p>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button onclick="closeLoginMfaModal()" style="flex: 1; padding: 12px; background: var(--bg-hover); border: none; border-radius: 8px; color: var(--text-primary); font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-active)'" onmouseout="this.style.background='var(--bg-hover)'">Cancel</button>
                        <button onclick="verifyLoginMfa()" id="login-mfa-verify-btn" style="flex: 1; padding: 12px; background: var(--accent); border: none; border-radius: 8px; color: white; font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                            <span id="verify-btn-text">Verify</span>
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">Didn't receive the code?</p>
                        <button onclick="resendMfaCode()" id="resend-mfa-btn" style="font-size: 0.875rem; color: var(--text-muted); background: none; border: none; cursor: pointer; padding: 8px 16px; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.color='var(--accent)'; this.style.background='var(--bg-hover)'" onmouseout="this.style.color='var(--text-muted)'; this.style.background='none'">
                            <span id="resend-text">Resend code</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus input after a short delay
            setTimeout(() => {
                const input = document.getElementById('login-mfa-code');
                if (input) input.focus();
            }, 100);
        }

        function closeLoginMfaModal() {
            const modal = document.getElementById('login-mfa-modal');
            if (modal) modal.remove();
            window.pendingLoginEmail = null;
            window.pendingLoginPassword = null;
            window.pendingMfaMethods = [];
        }

        async function resendMfaCode() {
            if (!window.pendingLoginEmail || !window.pendingLoginPassword) {
                showToast('Session expired. Please login again.', 'error');
                closeLoginMfaModal();
                return;
            }
            
            try {
                const response = await fetch(`${API}/api/security/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: window.pendingLoginEmail, 
                        password: window.pendingLoginPassword 
                    })
                });
                
                if (response.ok) {
                    showToast('New code sent to your email', 'success');
                } else {
                    showToast('Failed to resend code', 'error');
                }
            } catch (e) {
                showToast('Failed to resend code', 'error');
            }
        }

        async function verifyLoginMfa() {
            const codeInput = document.getElementById('login-mfa-code');
            const code = codeInput?.value?.replace(/\D/g, '') || '';
            
            if (!code || code.length !== 6) {
                showToast('Please enter a valid 6-digit code', 'error');
                if (codeInput) {
                    codeInput.focus();
                    codeInput.select();
                }
                return;
            }
            
            const btn = document.getElementById('login-mfa-verify-btn');
            const btnText = document.getElementById('verify-btn-text');
            if (btn) {
                btn.disabled = true;
                if (btnText) btnText.textContent = 'Verifying...';
            }
            
            try {
                const response = await fetch(`${API}/api/security/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: window.pendingLoginEmail, 
                        password: window.pendingLoginPassword,
                        mfa_code: code
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    showToast(data.detail || 'Invalid code', 'error');
                    if (btn) {
                        btn.disabled = false;
                        if (btnText) btnText.textContent = 'Verify';
                    }
                    if (codeInput) {
                        codeInput.value = '';
                        codeInput.focus();
                    }
                    return;
                }
                
                // Success
                closeLoginMfaModal();
                try {
                    localStorage.setItem('agentforge_token', data.access_token);
                    sessionStorage.setItem('agentforge_token', data.access_token);
                    // Remove legacy key to avoid confusion
                    localStorage.removeItem('token');
                    sessionStorage.removeItem('token');
                } catch (_) { /* ignore */ }
                currentUser = data.user;
                showChatInterface();
                loadAgents();
                showToast('Welcome back!', 'success');
                
            } catch (e) {
                showToast('Verification failed. Please try again.', 'error');
                if (btn) {
                    btn.disabled = false;
                    if (btnText) btnText.textContent = 'Verify';
                }
            }
        }
        
        // ========== MODERN NOTIFICATION SYSTEM ==========
        const NotificationSystem = {
            container: null,
            notifications: [],
            maxVisible: 5,
            
            init() {
                if (this.container) return;
                this.container = document.createElement('div');
                this.container.id = 'notification-container';
                Object.assign(this.container.style, {
                    position: 'fixed', top: '16px', right: '16px', zIndex: '99999',
                    display: 'flex', flexDirection: 'column', gap: '10px',
                    maxWidth: '400px', width: '100%', pointerEvents: 'none',
                    maxHeight: 'calc(100vh - 2rem)', overflow: 'hidden'
                });
                document.body.appendChild(this.container);
            },
            
            getConfig(type) {
                const configs = {
                    success: {
                        icon: `<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`,
                        bg: 'linear-gradient(135deg, rgba(16,185,129,0.95), rgba(5,150,105,0.95))',
                        border: 'rgba(52,211,153,0.3)',
                        iconBg: 'rgba(52,211,153,0.2)',
                        title: 'Success',
                        duration: 4000
                    },
                    error: {
                        icon: `<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`,
                        bg: 'linear-gradient(135deg, rgba(239,68,68,0.95), rgba(225,29,72,0.95))',
                        border: 'rgba(252,165,165,0.3)',
                        iconBg: 'rgba(252,165,165,0.2)',
                        title: 'Error',
                        duration: 8000
                    },
                    warning: {
                        icon: `<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`,
                        bg: 'linear-gradient(135deg, rgba(245,158,11,0.95), rgba(234,88,12,0.95))',
                        border: 'rgba(252,211,77,0.3)',
                        iconBg: 'rgba(252,211,77,0.2)',
                        title: 'Warning',
                        duration: 6000
                    },
                    info: {
                        icon: `<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                        bg: 'linear-gradient(135deg, rgba(59,130,246,0.95), rgba(79,70,229,0.95))',
                        border: 'rgba(147,197,253,0.3)',
                        iconBg: 'rgba(147,197,253,0.2)',
                        title: 'Info',
                        duration: 4000
                    }
                };
                return configs[type] || configs.info;
            },
            
            show(message, type = 'info', options = {}) {
                this.init();
                const config = this.getConfig(type);
                const id = 'notif-' + Date.now() + Math.random().toString(36).substr(2, 9);
                const duration = options.duration || config.duration;
                const showProgress = options.showProgress !== false;
                
                const cleanMessage = message.replace(/^[âœ…âŒâš ï¸â„¹ï¸âœ¨ðŸŽ‰ðŸ’¡ðŸ””]\s*/, '');
                
                const notification = document.createElement('div');
                notification.id = id;
                Object.assign(notification.style, {
                    background: config.bg,
                    border: `1px solid ${config.border}`,
                    backdropFilter: 'blur(12px)',
                    borderRadius: '14px',
                    boxShadow: '0 20px 40px -8px rgba(0,0,0,0.35)',
                    transform: 'translateX(110%)',
                    opacity: '0',
                    transition: 'all 0.3s cubic-bezier(0.4,0,0.2,1)',
                    pointerEvents: 'auto',
                    overflow: 'hidden',
                    color: '#fff'
                });
                
                notification.innerHTML = `
                    <div style="padding: 14px 16px; display: flex; align-items: flex-start; gap: 12px;">
                        <div style="background: ${config.iconBg}; border-radius: 50%; padding: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                            ${config.icon}
                        </div>
                        <div style="flex: 1; min-width: 0; padding-top: 2px;">
                            <div style="font-size: 0.85rem; font-weight: 700; color: rgba(255,255,255,0.95);">${config.title}</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.82); margin-top: 2px; word-break: break-word;">${this.escapeHtml(cleanMessage)}</div>
                        </div>
                        <button onclick="NotificationSystem.dismiss('${id}')" style="flex-shrink: 0; padding: 4px; border-radius: 8px; border: none; background: transparent; color: rgba(255,255,255,0.5); cursor: pointer; transition: color 0.15s;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    ${showProgress ? `<div style="height: 3px; background: rgba(255,255,255,0.15);"><div class="notif-progress" style="height: 100%; background: rgba(255,255,255,0.35); border-radius: 99px; width: 100%; transition: width ${duration}ms linear;"></div></div>` : ''}
                `;
                
                this.container.insertBefore(notification, this.container.firstChild);
                this.notifications.push({ id, element: notification, timeout: null });
                
                requestAnimationFrame(() => {
                    notification.style.transform = 'translateX(0)';
                    notification.style.opacity = '1';
                    
                    if (showProgress) {
                        const progressBar = notification.querySelector('.notif-progress');
                        if (progressBar) {
                            requestAnimationFrame(() => { progressBar.style.width = '0%'; });
                        }
                    }
                });
                
                const timeout = setTimeout(() => this.dismiss(id), duration);
                const notifRecord = this.notifications.find(n => n.id === id);
                if (notifRecord) notifRecord.timeout = timeout;
                
                this.enforceLimit();
                return id;
            },
            
            dismiss(id) {
                const index = this.notifications.findIndex(n => n.id === id);
                if (index === -1) return;
                
                const { element, timeout } = this.notifications[index];
                if (timeout) clearTimeout(timeout);
                
                element.style.transform = 'translateX(110%)';
                element.style.opacity = '0';
                element.style.marginTop = `-${element.offsetHeight + 10}px`;
                
                setTimeout(() => {
                    element.remove();
                    this.notifications.splice(index, 1);
                }, 300);
            },
            
            dismissAll() {
                [...this.notifications].forEach(n => this.dismiss(n.id));
            },
            
            enforceLimit() {
                while (this.notifications.length > this.maxVisible) {
                    const oldest = this.notifications[this.notifications.length - 1];
                    this.dismiss(oldest.id);
                }
            },
            
            escapeHtml(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            
            success(message, options = {}) { return this.show(message, 'success', options); },
            error(message, options = {}) { return this.show(message, 'error', options); },
            warning(message, options = {}) { return this.show(message, 'warning', options); },
            info(message, options = {}) { return this.show(message, 'info', options); }
        };
        
        // Global notify shorthand
        const notify = {
            success: (msg, opts) => NotificationSystem.success(msg, opts),
            error: (msg, opts) => NotificationSystem.error(msg, opts),
            warning: (msg, opts) => NotificationSystem.warning(msg, opts),
            info: (msg, opts) => NotificationSystem.info(msg, opts),
            dismiss: (id) => NotificationSystem.dismiss(id),
            dismissAll: () => NotificationSystem.dismissAll()
        };
        
        // Backward compatible showToast
        function showToast(message, type = 'info', options = {}) {
            return NotificationSystem.show(message, type, options);
        }

        // OAuth Login - same as admin portal
        async function handleGoogleLogin() {
            try {
                showToast('Redirecting to Google...', 'info');
                const response = await fetch(`${API}/api/security/oauth/google/login`);
                const data = await response.json();
                
                if (data.auth_url) {
                    window.location.href = data.auth_url;
                } else {
                    showToast(data.detail || 'Google OAuth not configured', 'error');
                }
            } catch (e) {
                showToast('OAuth error: ' + e.message, 'error');
            }
        }

        async function handleMicrosoftLogin() {
            try {
                showToast('Redirecting to Microsoft...', 'info');
                const response = await fetch(`${API}/api/security/oauth/microsoft/login`);
                const data = await response.json();
                
                if (data.auth_url) {
                    window.location.href = data.auth_url;
                } else {
                    showToast(data.detail || 'Microsoft OAuth not configured', 'error');
                }
            } catch (e) {
                showToast('OAuth error: ' + e.message, 'error');
            }
        }

        function showLoginScreen() {
            const login = document.getElementById('login-screen');
            const chat = document.getElementById('chat-interface');
            if (login) login.classList.remove('hidden');
            if (chat) {
                chat.classList.add('hidden');
                chat.style.display = 'none';
            }
        }

        function showChatInterface() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('chat-interface').classList.remove('hidden');
            document.getElementById('chat-interface').style.display = 'flex';
            
            // Update user info
            if (currentUser) {
                document.getElementById('user-name').textContent = currentUser.full_name || currentUser.email;
                document.getElementById('user-email').textContent = currentUser.email;
                document.getElementById('user-avatar').textContent = (currentUser.full_name || currentUser.email)[0].toUpperCase();
            }

            // Default landing is Home (better first impression than chat)
            try {
                const u = currentUser || {};
                const firstName = u.first_name || u.profile?.first_name || '';
                const lastName = u.last_name || u.profile?.last_name || '';
                const fullName = u.full_name || `${firstName} ${lastName}`.trim() || u.name || u.display_name || '';
                const displayName = fullName || (u.email ? u.email.split('@')[0] : '');
                const greeting = displayName ? `Welcome back, ${displayName.split(' ')[0]}` : 'Welcome';
                const el = document.getElementById('home-greeting');
                if (el) el.textContent = greeting;
            } catch (_) { /* ignore */ }
            switchView('home');
        }

        function _getAgentType(agent) {
            if (!agent || typeof agent !== 'object') return 'conversational';
            const raw = (agent.agent_type || agent.type || agent.kind || '').toString().trim().toLowerCase();
            if (raw) {
                if (raw === 'process' || raw === 'workflow' || raw === 'process_agent' || raw === 'process-agent') return 'process';
                if (raw === 'conversational' || raw === 'chat' || raw === 'assistant') return 'conversational';
            }
            // Reliable fallback: process agents carry a process definition (string or object)
            if (agent.process_definition) return 'process';
            // Additional heuristic: some backends might embed process metadata
            if (agent.extra_metadata && typeof agent.extra_metadata === 'object' && (agent.extra_metadata.process || agent.extra_metadata.workflow)) return 'process';
            return 'conversational';
        }

        function isPortalAdmin() {
            const perms = (currentUser && Array.isArray(currentUser.permissions)) ? currentUser.permissions : [];
            const set = new Set(perms.map(p => String(p || '').trim().toLowerCase()).filter(Boolean));
            return set.has('system:admin') || set.has('users:view') || set.has('users:edit');
        }

        function _setInboxBadge(count) {
            const el = document.getElementById('nav-inbox-badge');
            if (!el) return;
            const n = Math.max(0, parseInt(String(count || '0'), 10) || 0);
            el.textContent = n > 99 ? '99+' : String(n);
            el.classList.toggle('show', n > 0);
        }

        function toggleNavGroup(groupId) {
            const id = String(groupId || '').trim().toLowerCase();
            if (!id) return;
            const sub = document.getElementById(`nav-subitems-${id}`);
            const chev = document.getElementById(`nav-chevron-${id}`);
            if (!sub) return;
            const isOpen = sub.classList.toggle('open');
            if (chev) chev.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(-90deg)';
        }

        function openNavGroup(groupId) {
            const id = String(groupId || '').trim().toLowerCase();
            if (!id) return;
            const sub = document.getElementById(`nav-subitems-${id}`);
            const chev = document.getElementById(`nav-chevron-${id}`);
            if (!sub) return;
            sub.classList.add('open');
            if (chev) chev.style.transform = 'rotate(0deg)';
        }

        function switchView(view) {
            const v = String(view || 'home').trim().toLowerCase();
            currentView = v;

            // Nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === v);
            });

            // Show/hide view containers
            ['home', 'chat', 'workflows', 'requests', 'inbox'].forEach(name => {
                const el = document.getElementById(`view-${name}`);
                if (!el) return;
                el.classList.toggle('hidden', name !== v);
            });

            // Sidebar: hide chat-only panels when not in chat
            const panels = document.getElementById('chat-sidebar-panels');
            if (panels) panels.classList.toggle('hidden', v !== 'chat');
            const newChatBtn = document.getElementById('new-chat-btn');
            if (newChatBtn) newChatBtn.classList.toggle('hidden', v !== 'chat');

            // Close sidebar on mobile when navigating
            try { closeSidebar(); } catch (_) { /* ignore */ }

            // Lazy load data
            if (v === 'home') {
                renderHomeDashboard();
            } else if (v === 'workflows') {
                openNavGroup('processes');
                renderWorkflows();
            } else if (v === 'requests') {
                openNavGroup('processes');
                renderRequestsScopeAndFilterChips();
                refreshRequests();
            } else if (v === 'inbox') {
                openNavGroup('processes');
                refreshInbox();
            }
        }

        function renderHomeDashboard() {
            // Stats
            const aCount = Array.isArray(agents) ? agents.length : 0;
            const pCount = Array.isArray(workflowAgents) ? workflowAgents.length : 0;
            const iCount = Array.isArray(myApprovals) ? myApprovals.length : 0;
            const sA = document.getElementById('home-stat-assistants');
            const sP = document.getElementById('home-stat-processes');
            const sI = document.getElementById('home-stat-inbox');
            if (sA) sA.textContent = String(aCount);
            if (sP) sP.textContent = String(pCount);
            if (sI) sI.textContent = String(iCount);

            const aLabel = document.getElementById('home-assistants-label');
            const pLabel = document.getElementById('home-processes-label');
            if (aLabel) aLabel.textContent = aCount ? `${aCount} assistant${aCount > 1 ? 's' : ''} available` : 'Conversational AI';
            if (pLabel) pLabel.textContent = pCount ? `${pCount} process${pCount > 1 ? 'es' : ''} available` : 'Workflows & Automation';

            // Quick access: show recent conversational agents + process agents
            const container = document.getElementById('home-recent');
            if (!container) return;
            const items = [];
            // Recent conversational agents (up to 3)
            (agents || []).slice(0, 3).forEach(a => {
                items.push(`
                    <div class="home-recent-item" onclick="switchView('chat'); setTimeout(() => selectAgent('${a.id}'), 120);">
                        <div class="home-recent-icon chat-type">${a.icon || 'ðŸ’¬'}</div>
                        <div class="home-recent-info">
                            <div class="home-recent-name">${escapeHtml(a.name)}</div>
                            <div class="home-recent-meta">AI Assistant</div>
                        </div>
                    </div>
                `);
            });
            // Recent processes (up to 3)
            (workflowAgents || []).slice(0, 3).forEach(a => {
                items.push(`
                    <div class="home-recent-item" onclick="selectProcessAgent('${a.id}')">
                        <div class="home-recent-icon process-type">${a.icon || 'ðŸ§©'}</div>
                        <div class="home-recent-info">
                            <div class="home-recent-name">${escapeHtml(a.name)}</div>
                            <div class="home-recent-meta">Process</div>
                        </div>
                    </div>
                `);
            });
            if (items.length === 0) {
                container.innerHTML = '<div class="home-empty">Your recent activity will appear here once you start chatting or running processes.</div>';
            } else {
                container.innerHTML = items.join('');
            }
        }

        async function loadAgents() {
            
            try {
                // Use the accessible agents endpoint - returns only agents the user has access to
                const response = await fetch(`${API}/api/agents/accessible`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Failed to load agents:', response.status, errorText);
                    throw new Error('Failed to load agents');
                }
                
                const data = await response.json();
                console.log('ðŸ“¦ Raw agents data:', data);
                
                // Handle both array response and object with agents key
                allAccessibleAgents = Array.isArray(data) ? data : (data.agents || data.items || []);
                workflowAgents = (allAccessibleAgents || []).filter(a => _getAgentType(a) === 'process');
                agents = (allAccessibleAgents || []).filter(a => _getAgentType(a) !== 'process');
                renderAgents();
                renderWorkflows();
                renderHomeDashboard();
            } catch (e) {
                console.error('Failed to load agents:', e);
                allAccessibleAgents = [];
                workflowAgents = [];
                agents = [];
                renderAgents();
                renderWorkflows();
                renderHomeDashboard();
            }
        }

        function renderAgents() {
            const container = document.getElementById('agent-list');
            if (!container) return;
            if (agents.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem; padding: 12px; text-align: center; border: 1px dashed var(--border); border-radius: 12px;">No assistants available</div>';
                return;
            }
            
            container.innerHTML = agents.map((agent, i) => `
                <div class="agent-card animate-in ${currentAgent?.id === agent.id ? 'active' : ''}" style="animation-delay: ${i * 0.04}s;" onclick="selectAgent('${agent.id}')">
                    <div class="agent-icon">${agent.icon || 'ðŸ’¬'}</div>
                    <div class="agent-info">
                        <div class="agent-name">${escapeHtml(agent.name)}</div>
                        <div class="agent-desc">${escapeHtml(agent.description || agent.goal || 'AI Assistant')}</div>
                    </div>
                </div>
            `).join('');
        }

        /* switchAssistantTab and renderProcessAgents removed â€” processes live in their own Processes section now */

        function selectProcessAgent(agentId) {
            const agent = (workflowAgents || []).find(a => a.id === agentId);
            if (!agent) {
                showToast('Process not found', 'error');
                return;
            }
            const trig = _getWorkflowTriggerInfo(agent);
            // Manual (form) â†’ open modal with inputs
            if (trig.triggerType === 'manual') {
                openWorkflowRunModal(agentId);
                return;
            }
            // Schedule/webhook (automation) â†’ admins can run now; others go to Workflows/Runs
            if (trig.triggerType === 'schedule' || trig.triggerType === 'webhook') {
                if (isPortalAdmin()) {
                    runWorkflowDirectly(agentId);
                } else {
                    showToast('Automation workflows run on schedule. Use Workflows tab to view runs.', 'info');
                    switchView('workflows');
                }
                return;
            }
            openWorkflowRunModal(agentId);
        }

        async function runWorkflowDirectly(agentId) {
            const agent = (workflowAgents || []).find(a => a.id === agentId);
            if (!agent) {
                showToast('Process not found', 'error');
                return;
            }
            try {
                showToast('Starting workflowâ€¦', 'info', { duration: 1500 });
                const response = await fetch(`${API}/process/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        agent_id: agent.id,
                        trigger_input: {},
                        trigger_type: 'manual'
                    })
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok) {
                    const rawMsg = (data && (data.detail || data.message || data.error)) ? (data.detail || data.message || data.error) : '';
                    throw new Error(friendlyErrorMessage(rawMsg, 'Failed to start this process. Please try again.'));
                }
                const executionId = data?.id || data?.execution_id || data?.executionId;
                showToast('Workflow started', 'success');
                if (executionId) {
                    selectedExecutionId = String(executionId);
                    switchView('requests');
                }
            } catch (e) {
                console.error('runWorkflowDirectly error:', e);
                showToast(e?.message || 'Failed to start workflow', 'error');
            }
        }

        // =============================================================================
        // PORTAL: WORKFLOWS (PROCESS AGENTS)
        // =============================================================================

        function _getWorkflowCategory(agent) {
            const meta = (agent && agent.extra_metadata && typeof agent.extra_metadata === 'object') ? agent.extra_metadata : {};
            const raw = meta.category || meta.department || meta.domain || meta.team;
            const c = raw ? String(raw).trim() : '';
            return c || 'General';
        }

        function _parseProcessDefinition(agent) {
            let def = agent?.process_definition;
            if (typeof def === 'string') {
                try { def = def ? JSON.parse(def) : null; } catch (_) { def = null; }
            }
            if (!def || typeof def !== 'object') def = {};
            return def;
        }

        function _getWorkflowTriggerInfo(agent) {
            const def = _parseProcessDefinition(agent);
            const nodes = Array.isArray(def.nodes) ? def.nodes : [];
            const triggerNode =
                nodes.find(n => n && (n.type === 'trigger' || n.type === 'form' || n.type === 'start')) ||
                nodes.find(n => n && (n.type === 'schedule' || n.type === 'webhook'));

            let triggerType = 'manual';
            let cfg = {};
            if (triggerNode) {
                cfg = triggerNode.config || {};
                const typeCfg = cfg.type_config || cfg;
                if (triggerNode.type === 'schedule') triggerType = 'schedule';
                else if (triggerNode.type === 'webhook') triggerType = 'webhook';
                else triggerType = String(typeCfg.triggerType || cfg.triggerType || 'manual').trim().toLowerCase();
                cfg = { ...cfg, ...typeCfg };
            }
            if (!['manual', 'schedule', 'webhook'].includes(triggerType)) triggerType = 'manual';

            let label = 'Manual (Form)';
            let detail = '';
            if (triggerType === 'schedule') {
                label = 'Automation (Schedule)';
                const cron = cfg.cron || cfg.cron_expression || cfg.cronExpression || '';
                const tz = cfg.timezone || 'UTC';
                detail = cron ? `${cron} â€¢ ${tz}` : tz;
            } else if (triggerType === 'webhook') {
                label = 'Integration (Webhook)';
                const method = String(cfg.method || 'POST').toUpperCase();
                const path = cfg.path || '/trigger';
                detail = `${method} ${path}`;
            }
            return { triggerType, label, detail, raw: cfg };
        }

        function _getWorkflowApprovalInfo(agent) {
            const def = _parseProcessDefinition(agent);
            const nodes = Array.isArray(def.nodes) ? def.nodes : [];
            const types = nodes.map(n => String(n?.type || '').trim().toLowerCase()).filter(Boolean);
            const hasApproval = types.includes('approval');
            const hasHumanTask = types.includes('human_task') || types.includes('human-task') || types.includes('human');
            const label = hasApproval ? 'Approvals' : (hasHumanTask ? 'Human step' : 'No approvals');
            return { hasApproval, hasHumanTask, label };
        }

        function viewWorkflowRuns(agentId) {
            const id = String(agentId || '').trim();
            if (!id) return;
            requestsWorkflowFilterId = id;
            selectedExecutionId = null;

            const t = _getWorkflowTriggerInfo((workflowAgents || []).find(a => a.id === id));
            if (isPortalAdmin() && t && t.triggerType !== 'manual') {
                // Automations often run under system/service context â†’ default to org runs for admins.
                requestsScope = 'org';
            }

            try {
                const s = document.getElementById('requests-search');
                if (s) s.value = '';
            } catch (_) { /* ignore */ }
            switchView('requests');
        }

        function clearRequestsWorkflowFilter() {
            requestsWorkflowFilterId = null;
            selectedExecutionId = null;
            refreshRequests();
        }

        function setWorkflowCategoryFilter(category) {
            workflowCategoryFilter = category || 'All';
            renderWorkflows();
        }

        function refreshWorkflows() {
            showToast('Refreshing workflowsâ€¦', 'info', { duration: 1000 });
            loadAgents();
        }

        function renderWorkflows() {
            const chipsEl = document.getElementById('workflow-category-chips');
            const cardsEl = document.getElementById('workflow-cards');
            if (!chipsEl || !cardsEl) return;

            const q = String(document.getElementById('workflow-search')?.value || '').trim().toLowerCase();
            const items = Array.isArray(workflowAgents) ? workflowAgents.slice() : [];

            const catSet = new Set();
            items.forEach(a => catSet.add(_getWorkflowCategory(a)));
            const cats = Array.from(catSet).sort((a, b) => a.localeCompare(b));
            const allCats = ['All', ...cats];
            if (!allCats.includes(workflowCategoryFilter)) workflowCategoryFilter = 'All';

            // Chips
            chipsEl.innerHTML = '';
            allCats.forEach(cat => {
                const chip = document.createElement('div');
                chip.className = 'chip' + (cat === workflowCategoryFilter ? ' active' : '');
                chip.textContent = cat;
                chip.onclick = () => setWorkflowCategoryFilter(cat);
                chipsEl.appendChild(chip);
            });

            const filtered = items.filter(a => {
                const cat = _getWorkflowCategory(a);
                if (workflowCategoryFilter !== 'All' && cat !== workflowCategoryFilter) return false;
                if (!q) return true;
                const hay = `${a.name || ''} ${a.description || ''} ${a.goal || ''} ${cat}`.toLowerCase();
                return hay.includes(q);
            });

            if (!filtered.length) {
                cardsEl.innerHTML = `
                    <div style="grid-column: 1 / -1;">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ§©</div>
                            <div class="empty-state-title">No processes found</div>
                            <div class="empty-state-desc">There are no processes published yet, or you don't have access. Contact your admin to get started.</div>
                        </div>
                    </div>
                `;
                return;
            }

            cardsEl.innerHTML = filtered.map(a => {
                const icon = escapeHtml(a.icon || 'ðŸ§©');
                const name = escapeHtml(a.name || 'Workflow');
                const desc = escapeHtml(a.description || a.goal || '');
                const category = escapeHtml(_getWorkflowCategory(a));
                const trig = _getWorkflowTriggerInfo(a);
                const appr = _getWorkflowApprovalInfo(a);
                const triggerLabel = escapeHtml(trig.label);
                const triggerDetail = escapeHtml(trig.detail || '');
                const approvalLabel = escapeHtml(appr.label);
                const statusCls = (trig.triggerType === 'manual') ? 'muted' : 'warning';
                const canRunNow = (trig.triggerType === 'manual') || isPortalAdmin();
                const runNowLabel = (trig.triggerType === 'manual') ? 'Start' : 'Run now';
                return `
                    <div class="wf-card">
                        <div class="wf-card-top">
                            <div class="wf-card-icon">${icon}</div>
                            <div style="min-width:0; flex:1;">
                                <div class="wf-card-title">${name}</div>
                                <div class="wf-card-desc">${desc}</div>
                                <div style="margin-top: 10px;">
                                    <span class="chip" style="cursor: default; pointer-events: none;">${category}</span>
                                    <span class="chip" style="cursor: default; pointer-events: none;" title="${triggerDetail}">${triggerLabel}</span>
                                    <span class="chip" style="cursor: default; pointer-events: none;">${approvalLabel}</span>
                                </div>
                            </div>
                        </div>
                        <div class="wf-card-actions">
                            <span class="status-pill ${statusCls}"><span class="dot"></span>${triggerLabel}</span>
                            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                                <button class="portal-btn" onclick="viewWorkflowRuns('${a.id}')">View Runs</button>
                                ${canRunNow ? `<button class="portal-btn portal-btn-primary" onclick="openWorkflowRunModal('${a.id}')">${runNowLabel}</button>` : ``}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =============================================================================
        // PORTAL: WORKFLOW RUN MODAL (INPUTS + PREFILL + DERIVED)
        // =============================================================================

        function _wfElId(fieldId) {
            return 'wf-' + String(fieldId || '').trim().replace(/[^A-Za-z0-9_-]/g, '-');
        }

        function openWorkflowRunModal(agentId) {
            const agent = (workflowAgents || []).find(a => a.id === agentId);
            if (!agent) {
                showToast('Workflow not found', 'error');
                return;
            }

            currentWorkflowAgent = agent;
            workflowRunInputs = [];

            const modal = document.getElementById('workflow-run-modal');
            const titleEl = document.getElementById('workflow-run-title');
            const descEl = document.getElementById('workflow-run-desc');
            const statusEl = document.getElementById('workflow-run-status');
            const btn = document.getElementById('workflow-run-btn');

            if (titleEl) titleEl.textContent = agent.name || 'Run Workflow';
            if (descEl) descEl.textContent = agent.description || agent.goal || '';
            if (statusEl) statusEl.textContent = '';
            if (btn) { btn.disabled = false; btn.textContent = 'Start'; }

            buildWorkflowRunForm(agent);
            if (modal) modal.classList.add('open');
        }

        function closeWorkflowRunModal() {
            const modal = document.getElementById('workflow-run-modal');
            if (modal) modal.classList.remove('open');
            currentWorkflowAgent = null;
            workflowRunInputs = [];
            const form = document.getElementById('workflow-form-fields');
            if (form) form.innerHTML = '';
            const statusEl = document.getElementById('workflow-run-status');
            if (statusEl) statusEl.textContent = '';
        }

        function _splitArgs(argString) {
            const s = String(argString || '');
            const out = [];
            let cur = '';
            let q = '';
            for (let i = 0; i < s.length; i++) {
                const ch = s[i];
                if (q) {
                    if (ch === q) q = '';
                    cur += ch;
                    continue;
                }
                if (ch === '"' || ch === "'") { q = ch; cur += ch; continue; }
                if (ch === ',') { out.push(cur.trim()); cur = ''; continue; }
                cur += ch;
            }
            if (cur.trim()) out.push(cur.trim());
            return out;
        }

        function _resolveArgToken(token, values) {
            const t = String(token || '').trim();
            if (!t) return '';
            if ((t.startsWith('"') && t.endsWith('"')) || (t.startsWith("'") && t.endsWith("'"))) return t.slice(1, -1);
            if (/^-?\d+(\.\d+)?$/.test(t)) return parseFloat(t);
            const key = t.replace(/^\{\{/, '').replace(/\}\}$/, '').trim();
            return (values && key in values) ? values[key] : '';
        }

        function evaluateDerivedExpression(expression, values) {
            const expr = String(expression || '').trim();
            if (!expr) return '';
            if (/^[A-Za-z][A-Za-z0-9_]*$/.test(expr)) return (values && expr in values) ? values[expr] : '';
            const m = expr.match(/^([A-Za-z][A-Za-z0-9_]*)\s*\((.*)\)\s*$/);
            if (!m) return '';
            const fn = m[1];
            const args = _splitArgs(m[2]).map(a => _resolveArgToken(a, values));
            const toNum = (v) => {
                if (typeof v === 'number') return v;
                const n = parseFloat(String(v || '').trim());
                return Number.isFinite(n) ? n : 0;
            };
            const toStr = (v) => (v == null ? '' : String(v));
            const toDate = (v) => {
                const s = String(v || '').trim();
                if (!s) return null;
                const d = new Date(s);
                return isNaN(d.getTime()) ? null : d;
            };
            switch (fn) {
                case 'daysBetween': {
                    const d1 = toDate(args[0]);
                    const d2 = toDate(args[1]);
                    if (!d1 || !d2) return '';
                    const utc1 = Date.UTC(d1.getFullYear(), d1.getMonth(), d1.getDate());
                    const utc2 = Date.UTC(d2.getFullYear(), d2.getMonth(), d2.getDate());
                    return Math.floor((utc2 - utc1) / 86400000) + 1;
                }
                case 'concat':
                    return args.map(toStr).join('');
                case 'sum':
                    return args.reduce((acc, v) => acc + toNum(v), 0);
                case 'round': {
                    const n = toNum(args[0]);
                    const p = Math.max(0, Math.min(8, Math.floor(toNum(args[1] ?? 0))));
                    const f = Math.pow(10, p);
                    return Math.round(n * f) / f;
                }
                case 'toNumber':
                    return toNum(args[0]);
                default:
                    return '';
            }
        }

        function collectWorkflowFormValues(inputs) {
            const values = {};
            (inputs || []).forEach(input => {
                const el = document.getElementById(_wfElId(input.id));
                values[input.id] = el ? el.value : '';
            });
            return values;
        }

        function recomputeWorkflowDerivedFields(inputs) {
            const derivedInputs = (inputs || []).filter(i => i && i.derived && i.derived.expression);
            if (!derivedInputs.length) return;
            const values = collectWorkflowFormValues(inputs);
            derivedInputs.forEach(di => {
                const el = document.getElementById(_wfElId(di.id));
                if (!el) return;
                const v = evaluateDerivedExpression(di.derived.expression, values);
                const text = (v == null) ? '' : String(v);
                el.value = text;
                values[di.id] = text;
            });
        }

        /**
         * DYNAMIC user prefill resolver â€” works with ANY attribute.
         * Instead of a hardcoded list, this searches through:
         *   1. Direct properties on currentUser (from /auth/me)
         *   2. currentUser.profile (nested profile data)
         *   3. currentUser.custom_attributes (HR/LDAP custom fields)
         *   4. currentUser.department (nested department object)
         * Supports camelCase keys (from AI) mapped to snake_case data.
         * Arrays are auto-joined as comma-separated strings for display.
         */
        function getCurrentUserPrefillValue(key) {
            const k = String(key || '').trim();
            if (!currentUser) return '';

            // --- Convenience aliases for common keys ---
            const aliases = {
                'name': ['full_name', 'name', 'display_name'],
                'firstName': ['first_name'],
                'lastName': ['last_name'],
                'orgId': ['org_id'],
                'managerId': ['manager_id'],
                'managerName': ['manager_name'],
                'managerEmail': ['manager_email'],
                'departmentId': ['department_id'],
                'departmentName': ['department_name'],
                'jobTitle': ['job_title'],
                'employeeId': ['employee_id'],
                'isManager': ['is_manager'],
                'roleNames': ['role_names'],
                'groupNames': ['group_names'],
                'groupIds': ['group_ids'],
                'roleIds': ['role_ids'],
                'directReportCount': ['direct_report_count'],
                'hireDate': ['hire_date'],
                'officeLocation': ['office_location'],
                'costCenter': ['cost_center'],
                'nationalId': ['national_id'],
                'badgeNumber': ['badge_number'],
            };

            // Convert camelCase key to snake_case for data lookup
            const toSnake = s => s.replace(/([A-Z])/g, '_$1').toLowerCase();
            const snakeKey = toSnake(k);

            // Build a list of candidate keys to try
            const candidates = [k, snakeKey, ...(aliases[k] || [])];

            // --- Search layers (ordered by priority) ---
            const layers = [
                currentUser,                        // Direct props (email, manager_id, etc.)
                currentUser.profile || {},           // Nested profile
                currentUser.custom_attributes || {}, // HR/LDAP custom attributes
                currentUser.department || {},        // Department object
            ];

            for (const candidate of candidates) {
                for (const layer of layers) {
                    const val = layer[candidate];
                    if (val !== undefined && val !== null && val !== '') {
                        return _formatPrefillValue(val);
                    }
                }
            }

            // Special: for 'roles' / 'groups', handle the complex array-of-objects case
            if (k === 'roles' || k === 'roleNames') {
                const arr = currentUser.role_names || currentUser.roles;
                if (Array.isArray(arr)) return arr.map(r => r?.name || r?.id || r).filter(Boolean).join(', ');
            }
            if (k === 'groups' || k === 'groupNames') {
                const arr = currentUser.group_names || currentUser.groups;
                if (Array.isArray(arr)) return arr.map(g => g?.name || g?.id || g).filter(Boolean).join(', ');
            }

            return '';
        }

        /** Format a value for display in a form field */
        function _formatPrefillValue(val) {
            if (val === null || val === undefined) return '';
            if (typeof val === 'boolean') return String(val);
            if (typeof val === 'number') return String(val);
            if (Array.isArray(val)) return val.map(v => (typeof v === 'object' && v !== null) ? (v.name || v.label || v.id || JSON.stringify(v)) : String(v)).filter(Boolean).join(', ');
            if (typeof val === 'object') return val.name || val.label || val.id || JSON.stringify(val);
            return String(val);
        }

        function applyWorkflowPrefill(inputs) {
            (inputs || []).forEach(input => {
                if (!input || !input.prefill || input.prefill.source !== 'currentUser') return;
                const el = document.getElementById(_wfElId(input.id));
                if (!el) return;
                const v = getCurrentUserPrefillValue(input.prefill.key);
                if (v !== '') el.value = v;
            });
        }

        function setupWorkflowDerivedFields(inputs) {
            const derivedInputs = (inputs || []).filter(i => i && i.derived && i.derived.expression);
            if (!derivedInputs.length) return;

            const recompute = () => recomputeWorkflowDerivedFields(inputs);

            (inputs || []).forEach(input => {
                if (!input || (input.derived && input.derived.expression) || input.readOnly) return;
                const el = document.getElementById(_wfElId(input.id));
                if (!el) return;
                if (el.dataset && el.dataset.pbDerivedWired === '1') return;
                el.addEventListener('input', recompute);
                el.addEventListener('change', recompute);
                if (el.dataset) el.dataset.pbDerivedWired = '1';
            });

            recompute();
        }

        function buildWorkflowRunForm(agent) {
            const formContainer = document.getElementById('workflow-form-fields');
            if (!formContainer) return;

            let triggerInputs = [];
            let processDef = agent?.process_definition;
            if (typeof processDef === 'string') {
                try { processDef = processDef ? JSON.parse(processDef) : null; } catch (_) { processDef = null; }
            }
            if (!processDef || typeof processDef !== 'object') processDef = {};

            // Process Builder definition: start/trigger/form node config.fields
            if (processDef.nodes && Array.isArray(processDef.nodes)) {
                const triggerNode = processDef.nodes.find(n => (n.type === 'trigger' || n.type === 'form' || n.type === 'start'));
                if (triggerNode) {
                    const config = triggerNode.config || {};
                    const typeConfig = config.type_config || config;
                    const fields = typeConfig.fields || config.fields || [];
                    if (Array.isArray(fields) && fields.length) {
                        triggerInputs = fields
                            .filter(f => f && (f.name || f.id))
                            .map(f => {
                                const id = f.name || f.id;
                                const label = f.label || humanizeFieldLabel(id) || id;
                                const derived = (f.derived && f.derived.expression) ? { expression: String(f.derived.expression).trim() } : null;
                                const prefill = (f.prefill && f.prefill.source === 'currentUser' && f.prefill.key)
                                    ? { source: 'currentUser', key: String(f.prefill.key).trim() }
                                    : null;
                                const readOnly = !!f.readOnly || !!derived || !!prefill;
                                const required = !!f.required && !readOnly;
                                const options = Array.isArray(f.options) ? f.options : undefined;
                                const placeholder = f.placeholder || (label ? `Enter ${label}â€¦` : '');
                                return {
                                    id,
                                    label,
                                    type: f.type || 'text',
                                    required,
                                    placeholder,
                                    options,
                                    description: f.description,
                                    derived,
                                    prefill,
                                    readOnly
                                };
                            });
                    }
                }
            }

            // Legacy: processDef.trigger.inputs
            if (!triggerInputs.length && processDef && processDef.trigger && processDef.trigger.inputs) {
                triggerInputs = processDef.trigger.inputs;
            }

            // Fallback: minimal business-friendly form
            if (!triggerInputs.length) {
                triggerInputs = [
                    { id: 'details', label: 'Details', type: 'textarea', required: true, placeholder: 'Enter detailsâ€¦' }
                ];
            }

            workflowRunInputs = triggerInputs;

            formContainer.innerHTML = triggerInputs.map(input => {
                const required = input.required ? '<span style="color: var(--error);">*</span>' : '';
                const fieldId = _wfElId(input.id);
                const descHtml = input.description ? `<p class="text-xs mt-0.5 mb-1" style="color: var(--text-muted);">${escapeHtml(input.description)}</p>` : '';
                const readOnly = !!input.readOnly || (input.derived && input.derived.expression);
                const isPrefilled = !!input.prefill;
                const isDerived = !!(input.derived && input.derived.expression);
                const readOnlyStyle = readOnly ? 'style="opacity: 0.7; cursor: not-allowed; background: rgba(255,255,255,0.03);"' : '';

                let fieldHtml = '';
                switch (input.type) {
                    case 'textarea':
                        fieldHtml = `<textarea id="${fieldId}" class="modal-form-input" rows="3" placeholder="${escapeHtml(input.placeholder || '')}" ${input.required ? 'required' : ''} ${readOnly ? 'readonly' : ''} ${readOnlyStyle}></textarea>`;
                        break;
                    case 'select':
                        fieldHtml = `<select id="${fieldId}" class="modal-form-input" ${input.required ? 'required' : ''} ${readOnly ? 'disabled' : ''} ${readOnlyStyle}>
                            <option value="">Selectâ€¦</option>
                            ${(input.options || []).map(opt => `<option value="${escapeHtml(opt)}">${escapeHtml(opt)}</option>`).join('')}
                        </select>`;
                        break;
                    case 'file':
                        fieldHtml = `<input type="file" id="${fieldId}" class="modal-form-input" ${input.required ? 'required' : ''}>`;
                        break;
                    case 'number':
                        fieldHtml = `<input type="number" id="${fieldId}" class="modal-form-input" placeholder="${escapeHtml(input.placeholder || '')}" ${input.required ? 'required' : ''} ${readOnly ? 'readonly' : ''} ${readOnlyStyle}>`;
                        break;
                    case 'date':
                        fieldHtml = `<input type="date" id="${fieldId}" class="modal-form-input" ${input.required ? 'required' : ''} ${readOnly ? 'readonly' : ''} ${readOnlyStyle}>`;
                        break;
                    case 'email':
                        fieldHtml = `<input type="email" id="${fieldId}" class="modal-form-input" placeholder="${escapeHtml(input.placeholder || '')}" ${input.required ? 'required' : ''} ${readOnly ? 'readonly' : ''} ${readOnlyStyle}>`;
                        break;
                    default:
                        fieldHtml = `<input type="text" id="${fieldId}" class="modal-form-input" placeholder="${escapeHtml(input.placeholder || '')}" ${input.required ? 'required' : ''} ${readOnly ? 'readonly' : ''} ${readOnlyStyle}>`;
                }

                // Helper text for read-only fields
                let readOnlyHint = '';
                if (isPrefilled) {
                    readOnlyHint = `<span style="display:inline-flex; align-items:center; gap:4px; font-size:0.75rem; color:var(--text-muted); margin-top:3px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg> Auto-filled from your profile</span>`;
                } else if (isDerived) {
                    readOnlyHint = `<span style="display:inline-flex; align-items:center; gap:4px; font-size:0.75rem; color:var(--text-muted); margin-top:3px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg> Automatically calculated</span>`;
                }

                return `
                    <div class="modal-form-group" style="margin-bottom: 0;">
                        <label class="modal-form-label">${escapeHtml(input.label || input.id)} ${required}</label>
                        ${descHtml}
                        ${fieldHtml}
                        ${readOnlyHint}
                    </div>
                `;
            }).join('');

            applyWorkflowPrefill(triggerInputs);
            setupWorkflowDerivedFields(triggerInputs);
        }

        async function executeWorkflow() {
            if (!currentWorkflowAgent) {
                showToast('No workflow selected', 'error');
                return;
            }
            const btn = document.getElementById('workflow-run-btn');
            const statusEl = document.getElementById('workflow-run-status');

            try {
                if (btn) { btn.disabled = true; btn.textContent = 'Startingâ€¦'; }
                if (statusEl) statusEl.textContent = 'Starting workflowâ€¦';

                // Ensure derived fields are up to date before collecting values
                recomputeWorkflowDerivedFields(workflowRunInputs);

                const triggerData = {};
                for (const input of (workflowRunInputs || [])) {
                    const field = document.getElementById(_wfElId(input.id));
                    if (!field) continue;

                    if (input.type === 'file') {
                        const fileObj = field.files && field.files[0] ? field.files[0] : null;
                        if (input.required && !fileObj) {
                            showToast(`Please upload: ${input.label}`, 'error');
                            if (btn) { btn.disabled = false; btn.textContent = 'Start'; }
                            field.focus();
                            return;
                        }
                        if (fileObj) {
                            triggerData[input.id] = await uploadWorkflowRunFile(fileObj);
                        } else {
                            triggerData[input.id] = null;
                        }
                        continue;
                    }

                    const value = (field.value || '').trim();
                    if (input.required && !value) {
                        showToast(`Please fill in: ${input.label}`, 'error');
                        if (btn) { btn.disabled = false; btn.textContent = 'Start'; }
                        field.focus();
                        return;
                    }
                    triggerData[input.id] = input.type === 'number' ? (parseFloat(value) || 0) : value;
                }

                const response = await fetch(`${API}/process/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        agent_id: currentWorkflowAgent.id,
                        trigger_input: triggerData,
                        trigger_type: 'manual'
                    })
                });

                let data = null;
                try { data = await response.json(); } catch (_) { data = null; }

                if (!response.ok) {
                    const rawMsg = (data && (data.detail || data.message || data.error)) ? (data.detail || data.message || data.error) : '';
                    throw new Error(friendlyErrorMessage(rawMsg, 'Failed to start this process. Please try again.'));
                }

                const executionId = data?.id || data?.execution_id || data?.executionId;
                showToast('Workflow started', 'success');
                closeWorkflowRunModal();

                if (executionId) {
                    selectedExecutionId = String(executionId);
                    switchView('requests');
                }
            } catch (e) {
                console.error('executeWorkflow error:', e);
                showToast(e?.message || 'Failed to start workflow', 'error');
                if (statusEl) statusEl.textContent = '';
                if (btn) { btn.disabled = false; btn.textContent = 'Start'; }
            }
        }

        async function uploadWorkflowRunFile(fileObj) {
            const tokenHeaders = getAuthHeaders();
            if (!tokenHeaders || !tokenHeaders.Authorization) {
                throw new Error('You are not signed in.');
            }
            const fd = new FormData();
            fd.append('file', fileObj);
            const res = await fetch(`${API}/process/uploads`, {
                method: 'POST',
                headers: {
                    ...tokenHeaders
                },
                body: fd
            });
            let data = null;
            try { data = await res.json(); } catch (_) { data = null; }
            if (!res.ok) {
                const rawMsg = (data && (data.detail || data.message || data.error)) ? (data.detail || data.message || data.error) : '';
                throw new Error(friendlyErrorMessage(rawMsg, 'Failed to upload file. Please try again.'));
            }
            const f = (data && data.file) ? data.file : data;
            if (!f || !f.id) throw new Error('File upload failed.');
            return f;
        }

        // =============================================================================
        // PORTAL: MY REQUESTS (EXECUTION HISTORY)
        // =============================================================================

        function _executionAgentId(ex) {
            return ex?.agent_id || ex?.workflow_id || ex?.workflowId || ex?.workflow_id;
        }

        function _executionRunNumber(ex) {
            return ex?.execution_number ?? ex?.run_number ?? ex?.run_number ?? ex?.runNumber ?? ex?.run_number;
        }

        function _executionInputData(ex) {
            return ex?.input_data || ex?.trigger_input || ex?.inputData || {};
        }

        function _executionResult(ex) {
            return ex?.result ?? ex?.output ?? ex?.result_data ?? ex?.output_data;
        }

        function _formatDateTime(val) {
            if (!val) return '';
            try {
                const d = (val instanceof Date) ? val : new Date(val);
                if (isNaN(d.getTime())) return String(val);
                return d.toLocaleString();
            } catch (_) {
                return String(val);
            }
        }

        function _statusPillClass(status) {
            const s = String(status || '').toLowerCase();
            if (s === 'success') return 'success';
            if (s === 'warning') return 'warning';
            if (s === 'danger' || s === 'error') return 'danger';
            if (s === 'completed') return 'success';
            if (s === 'failed' || s === 'cancelled' || s === 'timed_out') return 'danger';
            if (s === 'waiting' || s === 'paused') return 'warning';
            if (s === 'running' || s === 'pending') return 'warning';
            return 'muted';
        }

        function _getWorkflowNameById(agentId) {
            const id = String(agentId || '').trim();
            if (!id) return 'Workflow';
            const a = (workflowAgents || []).find(x => x.id === id) || (allAccessibleAgents || []).find(x => x.id === id);
            return a?.name || 'Workflow';
        }

        async function refreshRequests() {
            const listEl = document.getElementById('requests-list');
            if (listEl) listEl.innerHTML = `<div style="padding: 14px; color: var(--text-muted);">Loadingâ€¦</div>`;
            try {
                const params = new URLSearchParams();
                params.set('scope', requestsScope || 'mine');
                params.set('limit', '100');
                params.set('offset', '0');
                if (requestsWorkflowFilterId) params.set('agent_id', String(requestsWorkflowFilterId));

                const res = await fetch(`${API}/process/executions?${params.toString()}`, {
                    headers: { ...getAuthHeaders() }
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error((data && (data.detail || data.message)) ? (data.detail || data.message) : 'Failed to load requests');
                myRequests = Array.isArray(data) ? data : (data.items || []);
                renderRequestsScopeAndFilterChips();
                renderRequests();
                if (selectedExecutionId) {
                    // Keep the detail pane in sync (e.g., after starting a workflow)
                    refreshSelectedRequest();
                }
                return myRequests;
            } catch (e) {
                console.error('refreshRequests error:', e);
                myRequests = [];
                renderRequestsScopeAndFilterChips();
                renderRequests();
                showToast(e?.message || 'Failed to load requests', 'error');
                return [];
            }
        }

        function renderRequestsScopeAndFilterChips() {
            // Scope chips
            const scopeEl = document.getElementById('requests-scope-chips');
            if (scopeEl) {
                const admin = isPortalAdmin();
                const scopes = admin ? [
                    { id: 'mine', label: 'My runs', hint: 'Runs you started' },
                    { id: 'org', label: 'Org runs', hint: 'All runs in your organization (admin)' }
                ] : [
                    { id: 'mine', label: 'My runs', hint: 'Runs you started' }
                ];
                scopeEl.innerHTML = '';
                scopes.forEach(s => {
                    const chip = document.createElement('div');
                    chip.className = 'chip' + ((requestsScope || 'mine') === s.id ? ' active' : '');
                    chip.textContent = s.label;
                    chip.title = s.hint || '';
                    chip.onclick = () => {
                        requestsScope = s.id;
                        selectedExecutionId = null;
                        refreshRequests();
                    };
                    scopeEl.appendChild(chip);
                });
            }

            // Filter chips
            const filterEl = document.getElementById('requests-filter-chips');
            if (filterEl) {
                filterEl.innerHTML = '';
                if (requestsWorkflowFilterId) {
                    const wfName = _getWorkflowNameById(requestsWorkflowFilterId);
                    const chip = document.createElement('div');
                    chip.className = 'chip active';
                    chip.textContent = `Filtered: ${wfName} âœ•`;
                    chip.title = 'Click to clear filter';
                    chip.onclick = () => clearRequestsWorkflowFilter();
                    filterEl.appendChild(chip);
                }
            }
        }

        function renderRequests() {
            const listEl = document.getElementById('requests-list');
            const countEl = document.getElementById('requests-count');
            if (!listEl) return;

            const q = String(document.getElementById('requests-search')?.value || '').trim().toLowerCase();
            const items = Array.isArray(myRequests) ? myRequests.slice() : [];

            const filtered = items.filter(ex => {
                if (requestsWorkflowFilterId) {
                    const aid = String(_executionAgentId(ex) || '').trim();
                    if (aid && aid !== String(requestsWorkflowFilterId)) return false;
                }
                const name = _getWorkflowNameById(_executionAgentId(ex));
                const statusLabel = ex?.status_info?.label || ex?.status || '';
                const hay = `${name} ${statusLabel} ${ex?.id || ''}`.toLowerCase();
                return !q || hay.includes(q);
            });

            if (countEl) countEl.textContent = filtered.length ? `${filtered.length}` : '';

            if (!filtered.length) {
                listEl.innerHTML = `<div style="padding: 14px; color: var(--text-muted);">No requests yet.</div>`;
                // Clear detail if nothing selected
                if (!items.length) {
                    selectedExecutionId = null;
                    const btn = document.getElementById('request-refresh-btn');
                    if (btn) btn.disabled = true;
                    const titleEl = document.getElementById('request-detail-title');
                    const subEl = document.getElementById('request-detail-subtitle');
                    const bodyEl = document.getElementById('request-detail-body');
                    if (titleEl) titleEl.textContent = 'Select a request';
                    if (subEl) subEl.textContent = 'Youâ€™ll see status, inputs, and step-by-step progress here.';
                    if (bodyEl) bodyEl.innerHTML = '';
                }
                return;
            }

            listEl.innerHTML = filtered.map(ex => {
                const id = String(ex.id || '');
                const agentId = _executionAgentId(ex);
                const name = escapeHtml(_getWorkflowNameById(agentId));
                const status = String(ex.status || '').toLowerCase();
                const pillCls = _statusPillClass(status);
                const label = escapeHtml(ex?.status_info?.label || (status ? status.charAt(0).toUpperCase() + status.slice(1) : 'Status'));
                const runNum = _executionRunNumber(ex);
                const created = _formatDateTime(ex.created_at);
                return `
                    <div class="list-item ${selectedExecutionId === id ? 'active' : ''}" onclick="selectRequest('${id}')">
                        <div class="list-item-title">
                            <span style="min-width:0; overflow:hidden; text-overflow: ellipsis; white-space: nowrap;">${name}</span>
                            <span class="status-pill ${pillCls}"><span class="dot"></span>${label}</span>
                        </div>
                        <div class="list-item-meta">
                            ${runNum != null ? `<span>#${escapeHtml(runNum)}</span>` : ''}
                            ${created ? `<span>${escapeHtml(created)}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Auto-select if we have a target execution id (e.g., after starting a workflow)
            if (selectedExecutionId && !filtered.some(x => String(x.id) === String(selectedExecutionId))) {
                // keep selection; detail refresh will handle not-found
            } else if (!selectedExecutionId && filtered.length) {
                // Do not auto-select unless user already picked (keep calm UX)
            }
        }

        async function selectRequest(executionId) {
            const id = String(executionId || '').trim();
            if (!id) return;
            selectedExecutionId = id;
            const btn = document.getElementById('request-refresh-btn');
            if (btn) btn.disabled = false;
            renderRequests();

            const titleEl = document.getElementById('request-detail-title');
            const subEl = document.getElementById('request-detail-subtitle');
            const bodyEl = document.getElementById('request-detail-body');
            if (titleEl) titleEl.textContent = 'Loadingâ€¦';
            if (subEl) subEl.textContent = 'Fetching latest run status and stepsâ€¦';
            if (bodyEl) bodyEl.innerHTML = '';

            await refreshSelectedRequest();
        }

        async function refreshSelectedRequest() {
            const id = String(selectedExecutionId || '').trim();
            if (!id) return;

            try {
                const [exRes, stepsRes] = await Promise.all([
                    fetch(`${API}/process/executions/${id}`, { headers: { ...getAuthHeaders() } }),
                    fetch(`${API}/process/executions/${id}/steps`, { headers: { ...getAuthHeaders() } })
                ]);

                const exData = await exRes.json().catch(() => ({}));
                const stepsData = await stepsRes.json().catch(() => ([]));

                if (!exRes.ok) {
                    const msg = (exData && (exData.detail || exData.message)) ? (exData.detail || exData.message) : 'Failed to load request';
                    throw new Error(String(msg));
                }

                // Update local cache
                const idx = (myRequests || []).findIndex(x => String(x.id) === id);
                if (idx >= 0) myRequests[idx] = exData;
                else myRequests = [exData].concat(myRequests || []);

                const steps = Array.isArray(stepsData) ? stepsData : (stepsData.items || stepsData.steps || []);
                _renderRequestDetail(exData, steps);
                renderRequests();
            } catch (e) {
                console.error('refreshSelectedRequest error:', e);
                const titleEl = document.getElementById('request-detail-title');
                const subEl = document.getElementById('request-detail-subtitle');
                const bodyEl = document.getElementById('request-detail-body');
                if (titleEl) titleEl.textContent = 'Unable to load request';
                if (subEl) subEl.textContent = e?.message || 'Please try again.';
                if (bodyEl) bodyEl.innerHTML = '';
                showToast(e?.message || 'Failed to load request', 'error');
            }
        }

        async function downloadUploadedProcessFile(fileId, filename) {
            const id = String(fileId || '').trim();
            if (!id) return;
            const name = String(filename || '').trim() || `upload-${id}`;
            try {
                const res = await fetch(`${API}/process/uploads/${encodeURIComponent(id)}/download`, {
                    headers: { ...getAuthHeaders() }
                });
                if (!res.ok) {
                    let rawMsg = '';
                    try {
                        const data = await res.json().catch(() => null);
                        if (data && (data.detail || data.message || data.error)) rawMsg = data.detail || data.message || data.error;
                    } catch (_) {}
                    showToast(friendlyErrorMessage(rawMsg, 'Failed to download file. Please try again.'), 'error');
                    return;
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => { try { URL.revokeObjectURL(url); } catch (_) {} }, 1500);
            } catch (e) {
                showToast('Unable to download file', 'error');
            }
        }

        function _renderPortalValue(v) {
            if (v == null) return `<span style="color: var(--text-muted);">â€”</span>`;
            if (typeof v === 'string') return v.trim() ? escapeHtml(v) : `<span style="color: var(--text-muted);">â€”</span>`;
            if (typeof v === 'number' || typeof v === 'boolean') return escapeHtml(String(v));
            if (typeof v === 'object') {
                try {
                    if (v.kind === 'uploadedFile' && (v.id || v.name)) {
                        const name = v.name || 'Uploaded file';
                        const typ = v.file_type ? String(v.file_type).toUpperCase() : '';
                        const size = (typeof v.size === 'number') ? `${Math.round(v.size / 1024)} KB` : '';
                        const meta = [typ, size].filter(Boolean).join(' Â· ');
                        const btn = v.id ? `
                            <button type="button" class="portal-btn"
                                style="padding:6px 10px; font-size:12px;"
                                data-upload-file-id="${escapeHtml(String(v.id))}"
                                data-upload-file-name="${escapeHtml(String(name))}"
                            >Download</button>
                        ` : '';
                        return `<div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap;">
                            <div style="text-align:right;">
                                <div style="font-weight:800;">${escapeHtml(name)}</div>
                                ${meta ? `<div style="color: var(--text-muted); font-size: 0.85rem;">${escapeHtml(meta)}</div>` : ''}
                            </div>
                            ${btn}
                        </div>`;
                    }
                } catch (_) {}
            }
            try {
                const s = JSON.stringify(v, null, 2);
                const t = s && s.length > 1600 ? (s.slice(0, 1600) + 'â€¦') : (s || '');
                return t ? `<pre style="margin:0;white-space:pre-wrap;word-break:break-word;color: var(--text-muted); font-size: 0.85rem; line-height: 1.35;">${escapeHtml(t)}</pre>` : `<span style="color: var(--text-muted);">â€”</span>`;
            } catch (_) {
                const s = String(v);
                const t = s.length > 1600 ? (s.slice(0, 1600) + 'â€¦') : s;
                return `<pre style="margin:0;white-space:pre-wrap;word-break:break-word;color: var(--text-muted); font-size: 0.85rem; line-height: 1.35;">${escapeHtml(t)}</pre>`;
            }
        }

        function _renderRequestDetail(ex, steps) {
            const titleEl = document.getElementById('request-detail-title');
            const subEl = document.getElementById('request-detail-subtitle');
            const bodyEl = document.getElementById('request-detail-body');
            if (!bodyEl) return;

            const agentId = _executionAgentId(ex);
            const wfName = _getWorkflowNameById(agentId);
            const status = String(ex?.status || '').toLowerCase();
            const pillCls = _statusPillClass(status);
            const label = ex?.status_info?.label || (status ? status.charAt(0).toUpperCase() + status.slice(1) : 'Status');
            const desc = ex?.status_info?.description || '';
            const runNum = _executionRunNumber(ex);
            const createdAt = _formatDateTime(ex?.created_at);
            const startedAt = _formatDateTime(ex?.started_at);
            const completedAt = _formatDateTime(ex?.completed_at);
            const duration = ex?.duration_display || '';

            if (titleEl) titleEl.textContent = wfName;
            if (subEl) subEl.textContent = desc || 'Run details';

            const inputData = _executionInputData(ex) || {};
            const result = _executionResult(ex);
            const inputsEntries = (inputData && typeof inputData === 'object') ? Object.entries(inputData) : [];

            const stepsArr = Array.isArray(steps) ? steps : [];
            const stepsHtml = stepsArr.length ? stepsArr.map(s => {
                const stLabel = s?.status?.label || s?.status?.description || s?.status || '';
                const stColor = s?.status?.color || '';
                const stCls = _statusPillClass(stColor || stLabel);
                return `
                    <div class="kv" style="margin-bottom: 10px;">
                        <div class="k">${escapeHtml(humanizeNodeType(s.step_type || s.node_type))} â€¢ Step ${escapeHtml(s.order ?? s.execution_order ?? '')}</div>
                        <div class="v" style="font-weight: 750;">${escapeHtml(s.step_name || s.node_name || 'Step')}</div>
                        <div style="margin-top: 8px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                            <span class="status-pill ${stCls}"><span class="dot"></span>${escapeHtml(stLabel || 'Status')}</span>
                            ${s.duration_display ? `<span style="color: var(--text-muted); font-size: 0.85rem;">${escapeHtml(s.duration_display)}</span>` : ''}
                            ${s.error ? `<span style="color: var(--error); font-size: 0.85rem;">${escapeHtml(friendlyErrorMessage(String(s.error), 'An error occurred at this step.'))}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('') : `<div style="color: var(--text-muted);">No step history yet.</div>`;

            const inputsHtml = inputsEntries.length ? `
                <div class="kv-grid" style="margin-top: 10px;">
                    ${inputsEntries.map(([k, v]) => `
                        <div class="kv">
                            <div class="k">${escapeHtml(humanizeFieldLabel(k) || k)}</div>
                            <div class="v">${_renderPortalValue(v)}</div>
                        </div>
                    `).join('')}
                </div>
            ` : `<div style="color: var(--text-muted); margin-top: 8px;">No input data recorded.</div>`;

            const resultHtml = (result != null) ? `
                <div class="kv" style="margin-top: 10px;">
                    <div class="k">Result</div>
                    <div class="v">${escapeHtml(typeof result === 'string' ? result : JSON.stringify(result, null, 2))}</div>
                </div>
            ` : '';

            bodyEl.innerHTML = `
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <span class="status-pill ${pillCls}"><span class="dot"></span>${escapeHtml(label)}</span>
                    ${runNum != null ? `<span class="status-pill muted"><span class="dot"></span>Run #${escapeHtml(runNum)}</span>` : ''}
                    ${duration ? `<span class="status-pill muted"><span class="dot"></span>${escapeHtml(duration)}</span>` : ''}
                </div>

                <div class="kv-grid" style="margin-top: 14px;">
                    ${createdAt ? `<div class="kv"><div class="k">Created</div><div class="v">${escapeHtml(createdAt)}</div></div>` : ''}
                    ${startedAt ? `<div class="kv"><div class="k">Started</div><div class="v">${escapeHtml(startedAt)}</div></div>` : ''}
                    ${completedAt ? `<div class="kv"><div class="k">Completed</div><div class="v">${escapeHtml(completedAt)}</div></div>` : ''}
                    ${ex?.reference_id || ex?.correlation_id ? `<div class="kv"><div class="k">Reference</div><div class="v">${escapeHtml(ex.reference_id || ex.correlation_id)}</div></div>` : ''}
                </div>

                <div style="margin-top: 18px;">
                    <div style="font-weight: 800; margin-bottom: 8px;">Inputs</div>
                    ${inputsHtml}
                </div>

                ${resultHtml ? `
                    <div style="margin-top: 18px;">
                        <div style="font-weight: 800; margin-bottom: 8px;">Outcome</div>
                        ${resultHtml}
                    </div>
                ` : ''}

                <div style="margin-top: 18px;">
                    <div style="font-weight: 800; margin-bottom: 8px;">Step-by-step</div>
                    ${stepsHtml}
                </div>
            `;

            // Wire up authenticated downloads for uploaded file buttons
            try {
                bodyEl.querySelectorAll('button[data-upload-file-id]').forEach(btn => {
                    btn.addEventListener('click', async (ev) => {
                        try { ev.preventDefault(); ev.stopPropagation(); } catch (_) {}
                        const id = btn.getAttribute('data-upload-file-id') || '';
                        const name = btn.getAttribute('data-upload-file-name') || '';
                        await downloadUploadedProcessFile(id, name);
                    });
                });
            } catch (_) {}
        }

        // =============================================================================
        // PORTAL: INBOX (APPROVALS)
        // =============================================================================

        async function refreshInboxBadge() {
            try {
                const res = await fetch(`${API}/process/approvals`, { headers: { ...getAuthHeaders() } });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) return;
                const items = Array.isArray(data) ? data : (data.items || []);
                _setInboxBadge(items.length);
            } catch (_) {
                // ignore
            }
        }

        async function refreshInbox() {
            const listEl = document.getElementById('inbox-list');
            if (listEl) listEl.innerHTML = `<div style="padding: 14px; color: var(--text-muted);">Loadingâ€¦</div>`;
            try {
                const res = await fetch(`${API}/process/approvals`, { headers: { ...getAuthHeaders() } });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error((data && (data.detail || data.message)) ? (data.detail || data.message) : 'Failed to load inbox');
                myApprovals = Array.isArray(data) ? data : (data.items || []);
                _setInboxBadge(myApprovals.length);
                renderInbox();
                if (selectedApprovalId) {
                    refreshSelectedApproval();
                }
                return myApprovals;
            } catch (e) {
                console.error('refreshInbox error:', e);
                myApprovals = [];
                _setInboxBadge(0);
                renderInbox();
                showToast(e?.message || 'Failed to load inbox', 'error');
                return [];
            }
        }

        function renderInbox() {
            const listEl = document.getElementById('inbox-list');
            const countEl = document.getElementById('inbox-count');
            if (!listEl) return;

            const q = String(document.getElementById('inbox-search')?.value || '').trim().toLowerCase();
            const items = Array.isArray(myApprovals) ? myApprovals.slice() : [];

            const filtered = items.filter(a => {
                const title = a?.title || '';
                const desc = a?.description || '';
                const hay = `${title} ${desc} ${a?.id || ''}`.toLowerCase();
                return !q || hay.includes(q);
            });

            if (countEl) countEl.textContent = filtered.length ? `${filtered.length}` : '';

            if (!filtered.length) {
                listEl.innerHTML = `<div style="padding: 14px; color: var(--text-muted);">No pending approvals.</div>`;
                if (!items.length) {
                    selectedApprovalId = null;
                    const btn = document.getElementById('inbox-refresh-btn');
                    if (btn) btn.disabled = true;
                    const titleEl = document.getElementById('inbox-detail-title');
                    const subEl = document.getElementById('inbox-detail-subtitle');
                    const bodyEl = document.getElementById('inbox-detail-body');
                    if (titleEl) titleEl.textContent = 'Select an item';
                    if (subEl) subEl.textContent = 'Review details and approve/reject.';
                    if (bodyEl) bodyEl.innerHTML = '';
                }
                return;
            }

            listEl.innerHTML = filtered.map(a => {
                const id = String(a.id || '');
                const title = escapeHtml(a.title || 'Approval');
                const urgency = escapeHtml(a.urgency || a.priority || 'normal');
                const dueBy = _formatDateTime(a.due_by || a.deadline_at);
                return `
                    <div class="list-item ${selectedApprovalId === id ? 'active' : ''}" onclick="selectApproval('${id}')">
                        <div class="list-item-title">
                            <span style="min-width:0; overflow:hidden; text-overflow: ellipsis; white-space: nowrap;">${title}</span>
                            <span class="status-pill warning"><span class="dot"></span>${urgency}</span>
                        </div>
                        <div class="list-item-meta">
                            ${dueBy ? `<span>Due: ${escapeHtml(dueBy)}</span>` : `<span>Pending</span>`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function selectApproval(approvalId) {
            const id = String(approvalId || '').trim();
            if (!id) return;
            selectedApprovalId = id;
            const btn = document.getElementById('inbox-refresh-btn');
            if (btn) btn.disabled = false;
            renderInbox();

            const titleEl = document.getElementById('inbox-detail-title');
            const subEl = document.getElementById('inbox-detail-subtitle');
            const bodyEl = document.getElementById('inbox-detail-body');
            if (titleEl) titleEl.textContent = 'Loadingâ€¦';
            if (subEl) subEl.textContent = 'Fetching approval detailsâ€¦';
            if (bodyEl) bodyEl.innerHTML = '';

            await refreshSelectedApproval();
        }

        async function refreshSelectedApproval() {
            const id = String(selectedApprovalId || '').trim();
            if (!id) return;
            try {
                const res = await fetch(`${API}/process/approvals/${id}`, { headers: { ...getAuthHeaders() } });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error((data && (data.detail || data.message)) ? (data.detail || data.message) : 'Failed to load approval');

                // Update cache
                const idx = (myApprovals || []).findIndex(x => String(x.id) === id);
                if (idx >= 0) myApprovals[idx] = data;
                else myApprovals = [data].concat(myApprovals || []);

                _renderApprovalDetail(data);
                renderInbox();
            } catch (e) {
                console.error('refreshSelectedApproval error:', e);
                const titleEl = document.getElementById('inbox-detail-title');
                const subEl = document.getElementById('inbox-detail-subtitle');
                const bodyEl = document.getElementById('inbox-detail-body');
                if (titleEl) titleEl.textContent = 'Unable to load approval';
                if (subEl) subEl.textContent = e?.message || 'Please try again.';
                if (bodyEl) bodyEl.innerHTML = '';
                showToast(e?.message || 'Failed to load approval', 'error');
            }
        }

        function _renderApprovalDetail(a) {
            const titleEl = document.getElementById('inbox-detail-title');
            const subEl = document.getElementById('inbox-detail-subtitle');
            const bodyEl = document.getElementById('inbox-detail-body');
            if (!bodyEl) return;

            const title = a?.title || 'Approval';
            const desc = a?.description || '';
            const urgency = a?.urgency || a?.priority || 'normal';
            const dueBy = _formatDateTime(a?.due_by || a?.deadline_at);
            const details = a?.details_to_review || a?.review_data || {};
            const detailEntries = (details && typeof details === 'object') ? Object.entries(details) : [];

            if (titleEl) titleEl.textContent = title;
            if (subEl) subEl.textContent = desc ? desc : 'Review details and approve/reject.';

            const detailsHtml = detailEntries.length ? `
                <div class="kv-grid" style="margin-top: 10px;">
                    ${detailEntries.filter(([k]) => {
                        const lk = k.toLowerCase();
                        return lk !== '_user_context' && !lk.startsWith('_');
                    }).map(([k, v]) => `
                        <div class="kv">
                            <div class="k">${escapeHtml(humanizeFieldLabel(k) || k)}</div>
                            <div class="v">${escapeHtml(typeof v === 'string' ? v : JSON.stringify(v))}</div>
                        </div>
                    `).join('')}
                </div>
            ` : `<div style="color: var(--text-muted); margin-top: 8px;">No additional details provided.</div>`;

            bodyEl.innerHTML = `
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <span class="status-pill warning"><span class="dot"></span>${escapeHtml(humanizeUrgency(urgency))}</span>
                    ${dueBy ? `<span class="status-pill muted"><span class="dot"></span>Due ${escapeHtml(dueBy)}</span>` : `<span class="status-pill muted"><span class="dot"></span>Pending</span>`}
                </div>

                ${desc ? `<div style="margin-top: 12px; color: var(--text-secondary); line-height: 1.4;">${escapeHtml(desc)}</div>` : ''}

                <div style="margin-top: 18px;">
                    <div style="font-weight: 800; margin-bottom: 8px;">Details to review</div>
                    ${detailsHtml}
                </div>

                <div style="margin-top: 18px;">
                    <div style="font-weight: 800; margin-bottom: 8px;">Your decision</div>
                    <div class="modal-form-group" style="margin-bottom: 0;">
                        <label class="modal-form-label">Comments (optional)</label>
                        <textarea id="approval-comments" class="modal-form-input" rows="3" placeholder="Add a noteâ€¦"></textarea>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;">
                        <button class="portal-btn portal-btn-primary" onclick="decideApproval('approved')">Approve</button>
                        <button class="portal-btn" style="border-color: color-mix(in srgb, var(--error) 60%, var(--border)); color: var(--error);" onclick="decideApproval('rejected')">Reject</button>
                    </div>
                    <div id="approval-action-status" style="margin-top: 10px; color: var(--text-muted); font-size: 0.85rem;"></div>
                </div>
            `;
        }

        async function decideApproval(decision) {
            const id = String(selectedApprovalId || '').trim();
            if (!id) return;
            const d = String(decision || '').trim().toLowerCase();
            if (d !== 'approved' && d !== 'rejected') return;

            const statusEl = document.getElementById('approval-action-status');
            const commentsEl = document.getElementById('approval-comments');
            const comments = commentsEl ? String(commentsEl.value || '').trim() : '';

            try {
                if (statusEl) statusEl.textContent = (d === 'approved') ? 'Approvingâ€¦' : 'Rejectingâ€¦';
                const res = await fetch(`${API}/process/approvals/${id}/decide`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ decision: d, comments })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    const msg = (data && (data.detail || data.message)) ? (data.detail || data.message) : 'Failed to submit decision';
                    throw new Error(String(msg));
                }
                showToast('Decision submitted', 'success');
                if (statusEl) statusEl.textContent = '';
                selectedApprovalId = null;
                await refreshInbox();
                await refreshRequests();
            } catch (e) {
                console.error('decideApproval error:', e);
                showToast(e?.message || 'Failed to submit decision', 'error');
                if (statusEl) statusEl.textContent = '';
            }
        }

        async function selectAgent(agentId) {
            currentAgent = agents.find(a => a.id === agentId);
            currentConversation = null;
            
            document.getElementById('current-agent-icon').textContent = currentAgent.icon || 'ðŸ¤–';
            document.getElementById('current-agent-name').textContent = currentAgent.name;
            
            renderAgents();
            await loadConversations();
            
            // If there are existing conversations, load the most recent one
            // Otherwise, start a new chat
            if (conversations.length > 0) {
                await loadConversation(conversations[0].id);
            } else {
                startNewChat();
            }
        }

        async function loadConversations() {
            if (!currentAgent) return;
            
            try {
                const response = await fetch(`${API}/api/agents/${currentAgent.id}/conversations`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const data = await response.json();
                conversations = data.conversations || [];
                renderHistory();
            } catch (e) {
                console.error('Failed to load conversations:', e);
            }
        }

        let selectionMode = false;
        let selectedChats = new Set();
        
        function renderHistory() {
            const container = document.getElementById('history-list');
            if (conversations.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem;">No recent chats</p>';
                document.getElementById('history-actions').classList.add('hidden');
                document.getElementById('edit-chats-btn').style.display = 'none';
                return;
            }
            
            document.getElementById('edit-chats-btn').style.display = 'inline';
            
            container.innerHTML = conversations.slice(0, 20).map(conv => `
                <div class="history-item ${currentConversation?.id === conv.id ? 'active' : ''} ${selectedChats.has(conv.id) ? 'selected' : ''}" 
                     onclick="${selectionMode ? `toggleChatSelection('${conv.id}')` : `loadConversation('${conv.id}')`}">
                    ${selectionMode ? `<div class="history-checkbox ${selectedChats.has(conv.id) ? 'checked' : ''}" onclick="event.stopPropagation(); toggleChatSelection('${conv.id}')"></div>` : ''}
                    <span class="history-icon">ðŸ’¬</span>
                    <span class="history-title">${conv.title || 'Untitled'}</span>
                </div>
            `).join('');
            
            updateDeleteButton();
        }
        
        function toggleSelectionMode() {
            selectionMode = !selectionMode;
            selectedChats.clear();
            
            const editBtn = document.getElementById('edit-chats-btn');
            const actionsBar = document.getElementById('history-actions');
            
            if (selectionMode) {
                editBtn.textContent = 'Done';
                editBtn.style.color = 'var(--success)';
                actionsBar.classList.remove('hidden');
            } else {
                editBtn.textContent = 'Edit';
                editBtn.style.color = 'var(--primary)';
                actionsBar.classList.add('hidden');
            }
            
            renderHistory();
        }
        
        function toggleChatSelection(convId) {
            if (selectedChats.has(convId)) {
                selectedChats.delete(convId);
            } else {
                selectedChats.add(convId);
            }
            renderHistory();
        }
        
        function toggleSelectAll() {
            const allIds = conversations.slice(0, 20).map(c => c.id);
            
            if (selectedChats.size === allIds.length) {
                // Deselect all
                selectedChats.clear();
                document.getElementById('select-all-text').textContent = 'Select All';
            } else {
                // Select all
                allIds.forEach(id => selectedChats.add(id));
                document.getElementById('select-all-text').textContent = 'Deselect All';
            }
            
            renderHistory();
        }
        
        function updateDeleteButton() {
            const btn = document.getElementById('delete-selected-btn');
            const count = selectedChats.size;
            btn.textContent = `Delete (${count})`;
            btn.disabled = count === 0;
        }
        
        async function deleteSelectedChats() {
            if (selectedChats.size === 0) return;
            
            const count = selectedChats.size;
            if (!confirm(`Are you sure you want to delete ${count} conversation${count > 1 ? 's' : ''}? This cannot be undone.`)) {
                return;
            }
            
            const btn = document.getElementById('delete-selected-btn');
            btn.textContent = 'Deleting...';
            btn.disabled = true;
            
            try {
                // Use bulk delete API
                const response = await fetch(`${API}/api/conversations/bulk`, {
                    method: 'DELETE',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}` 
                    },
                    body: JSON.stringify({
                        conversation_ids: Array.from(selectedChats)
                    })
                });
                
                const result = await response.json();
                
                // Check if current conversation was deleted
                if (currentConversation && selectedChats.has(currentConversation.id)) {
                    currentConversation = null;
                    document.getElementById('messages-container').innerHTML = '';
                    document.getElementById('welcome-screen').style.display = 'flex';
                }
                
                // Clear selection
                selectedChats.clear();
                
                // Reload conversations
                await loadConversations();
                
                // Exit selection mode
                toggleSelectionMode();
                
                // Show result
                if (result.deleted > 0) {
                    console.log(`âœ… Deleted ${result.deleted} conversation(s)`);
                }
                if (result.failed > 0) {
                    alert(`Failed to delete ${result.failed} conversation(s)`);
                }
                
            } catch (e) {
                console.error('Failed to delete conversations:', e);
                alert('Failed to delete conversations. Please try again.');
                updateDeleteButton();
            }
        }

        async function loadConversation(convId) {
            try {
                const response = await fetch(`${API}/api/conversations/${convId}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const conv = await response.json();
                currentConversation = conv;
                
                // Render messages
                const container = document.getElementById('messages-container');
                document.getElementById('welcome-screen').style.display = 'none';
                
                container.innerHTML = conv.messages.map(msg => createMessageHTML(msg.role, msg.content)).join('');
                container.scrollTop = container.scrollHeight;
                
                renderHistory();
            } catch (e) {
                console.error('Failed to load conversation:', e);
            }
        }

        async function startNewChat() {
            currentConversation = null;
            const container = document.getElementById('messages-container');
            
            // Show loading state
            container.innerHTML = `
                <div class="welcome-screen" id="welcome-screen">
                    <div class="welcome-icon">${currentAgent?.icon || 'â³'}</div>
                    <h1 class="welcome-title">Loading...</h1>
                </div>
            `;
            
            // Call start-chat to get personalized session
            
            try {
                const response = await fetch(`/api/agents/${currentAgent.id}/start-chat`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const session = await response.json();
                    
                    // Store conversation ID for later use
                    currentConversation = { id: session.conversation_id, messages: [] };
                    
                    // Build personalized welcome
                    const userName = session.user_name || 'there';
                    const hasRestrictions = session.denied_tasks && session.denied_tasks.length > 0;
                    
                    
                    let welcomeTitle = `Hi ${userName}! ðŸ‘‹`;
                    let welcomeSubtitle = session.message || `I'm ${currentAgent.name}. How can I help you today?`;
                    
                    // Show available tasks if user has restrictions
                    let tasksInfo = '';
                    if (hasRestrictions && session.accessible_tasks) {
                        tasksInfo = `
                            <div class="available-tasks" style="margin-top: 1rem; padding: 0.75rem; background: rgba(76,175,80,0.1); border-radius: 8px; text-align: left;">
                                <strong style="color: #4CAF50;">âœ… Available for you:</strong>
                                <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                                    ${session.accessible_tasks.map(t => `â€¢ ${t}`).join('<br>')}
                                </div>
                            </div>
                        `;
                    }
                    
                    container.innerHTML = `
                        <div class="welcome-screen" id="welcome-screen">
                            <div class="welcome-icon">${currentAgent?.icon || 'ðŸ‘‹'}</div>
                            <h1 class="welcome-title">${welcomeTitle}</h1>
                            <p class="welcome-subtitle">${welcomeSubtitle}</p>
                            ${tasksInfo}
                            <div class="suggestions">
                                <div class="suggestion-chip" onclick="sendSuggestion(this)">What can you help me with?</div>
                                <div class="suggestion-chip" onclick="sendSuggestion(this)">Tell me about your capabilities</div>
                            </div>
                        </div>
                    `;
                } else {
                    // Fallback to generic welcome
                    const errorText = await response.text();
                    container.innerHTML = `
                        <div class="welcome-screen" id="welcome-screen">
                            <div class="welcome-icon">${currentAgent?.icon || 'ðŸ‘‹'}</div>
                            <h1 class="welcome-title">How can I help you today?</h1>
                            <p class="welcome-subtitle">${currentAgent?.goal || 'Start a conversation with me!'}</p>
                            <div class="suggestions">
                                <div class="suggestion-chip" onclick="sendSuggestion(this)">What can you help me with?</div>
                                <div class="suggestion-chip" onclick="sendSuggestion(this)">Tell me about your capabilities</div>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                // Fallback to generic welcome
                container.innerHTML = `
                    <div class="welcome-screen" id="welcome-screen">
                        <div class="welcome-icon">${currentAgent?.icon || 'ðŸ‘‹'}</div>
                        <h1 class="welcome-title">How can I help you today?</h1>
                        <p class="welcome-subtitle">${currentAgent?.goal || 'Start a conversation with me!'}</p>
                        <div class="suggestions">
                            <div class="suggestion-chip" onclick="sendSuggestion(this)">What can you help me with?</div>
                            <div class="suggestion-chip" onclick="sendSuggestion(this)">Tell me about your capabilities</div>
                        </div>
                    </div>
                `;
            }
            
            renderHistory();
        }

        function createMessageHTML(role, content) {
            const isUser = role === 'user';
            const avatar = isUser ? (currentUser?.full_name?.[0] || 'U') : (currentAgent?.icon || 'ðŸ¤–');
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            return `
                <div class="message ${role}">
                    <div class="message-avatar">${avatar}</div>
                    <div>
                        <div class="message-content">${formatMessage(content)}</div>
                        <div class="message-time">${time}</div>
                    </div>
                </div>
            `;
        }

        function formatMessage(content) {
            // Full markdown formatting with table support (same as index.html)
            if (!content || typeof content !== 'string') return '';
            let text = String(content);
            
            // Convert LaTeX math symbols to readable format
            text = text.replace(/\\times/g, 'Ã—');
            text = text.replace(/\\div/g, 'Ã·');
            text = text.replace(/\\pm/g, 'Â±');
            text = text.replace(/\\leq/g, 'â‰¤');
            text = text.replace(/\\geq/g, 'â‰¥');
            text = text.replace(/\\neq/g, 'â‰ ');
            text = text.replace(/\\approx/g, 'â‰ˆ');
            text = text.replace(/\\cdot/g, 'Â·');
            text = text.replace(/\\text\{([^}]+)\}/g, '$1');
            text = text.replace(/\\\[/g, '');
            text = text.replace(/\\\]/g, '');
            text = text.replace(/\\\(/g, '');
            text = text.replace(/\\\)/g, '');
            
            if (typeof marked !== 'undefined') {
                marked.setOptions({ breaks: true, gfm: true });
                let html = marked.parse(text);
                // Wrap tables in responsive container
                html = html.replace(/<table>/g, '<div class="table-container"><table>');
                html = html.replace(/<\/table>/g, '</table></div>');
                return html;
            }
            
            // Fallback
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        function sendSuggestion(el) {
            document.getElementById('message-input').value = el.textContent;
            sendMessage();
        }

        async function sendMessage() {
            // Use the file-aware version
            return sendMessageWithFiles();
        }
        
        async function sendMessageOriginal() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message || !currentAgent) return;
            
            input.value = '';
            autoResize(input);
            
            // Hide welcome screen
            const welcome = document.getElementById('welcome-screen');
            if (welcome) welcome.style.display = 'none';
            
            // Add user message
            const container = document.getElementById('messages-container');
            container.innerHTML += createMessageHTML('user', message);
            
            // Add typing indicator
            container.innerHTML += `
                <div class="message assistant" id="typing-msg">
                    <div class="message-avatar">${currentAgent.icon || 'ðŸ¤–'}</div>
                    <div class="message-content">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
            
            try {
                const response = await fetch(`${API}/api/agents/${currentAgent.id}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        message,
                        conversation_id: currentConversation?.id
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                document.getElementById('typing-msg')?.remove();
                
                // Update conversation ID
                if (data.conversation_id) {
                    currentConversation = { id: data.conversation_id };
                }
                
                // Add assistant response
                container.innerHTML += createMessageHTML('assistant', data.response || data.content || 'I apologize, but I was unable to generate a response.');
                container.scrollTop = container.scrollHeight;
                playNotificationSound();
                
                // Reload conversations list
                loadConversations();
                
            } catch (e) {
                document.getElementById('typing-msg')?.remove();
                container.innerHTML += createMessageHTML('assistant', 'Sorry, something went wrong. Please try again.');
                container.scrollTop = container.scrollHeight;
            }
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        function toggleUserMenu(event) {
            if (event) event.stopPropagation();
            document.getElementById('user-menu').classList.toggle('open');
        }

        function handleLogout() {
            try {
                localStorage.removeItem('agentforge_token');
                sessionStorage.removeItem('agentforge_token');
                localStorage.removeItem('token'); // legacy
                sessionStorage.removeItem('token'); // legacy
            } catch (_) { /* ignore */ }
            currentUser = null;
            location.reload();
        }

        async function clearCurrentChat() {
            if (currentConversation && confirm('Clear this conversation?')) {
                try {
                    await fetch(`${API}/api/conversations/${currentConversation.id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    startNewChat();
                    loadConversations();
                } catch (e) {
                    console.error('Failed to clear chat:', e);
                }
            }
        }

        let selectedFiles = [];
        
        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = '.pdf,.doc,.docx,.txt,.csv,.json,.md';
            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                selectedFiles = [...selectedFiles, ...files];
                showSelectedFiles();
            };
            input.click();
        }
        
        function showSelectedFiles() {
            let container = document.getElementById('selected-files');
            if (!container) {
                const inputArea = document.querySelector('.input-area');
                container = document.createElement('div');
                container.id = 'selected-files';
                container.style.cssText = 'display: flex; gap: 8px; flex-wrap: wrap; padding: 8px 16px; border-bottom: 1px solid var(--border);';
                inputArea.insertBefore(container, inputArea.firstChild);
            }
            
            container.innerHTML = selectedFiles.map((file, idx) => `
                <div style="background: var(--bg-hover); padding: 6px 10px; border-radius: 8px; font-size: 0.8rem; display: flex; align-items: center; gap: 8px;">
                    <span>ðŸ“Ž ${file.name}</span>
                    <button onclick="removeFile(${idx})" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">âœ•</button>
                </div>
            `).join('');
            
            if (selectedFiles.length === 0) {
                container.remove();
            }
        }
        
        function removeFile(idx) {
            selectedFiles.splice(idx, 1);
            showSelectedFiles();
        }
        
        // ============================================================================
        // STREAMING CHAT - Real-time thinking/reasoning display (like ChatGPT/Cursor)
        // ============================================================================
        
        function createThinkingContainer() {
            return `
                <div class="thinking-inline" id="thinking-container" style="padding: 8px 0;">
                    <span style="display: inline-block; width: 8px; height: 8px; background: #a855f7; border-radius: 50%; animation: pulse 1s infinite; margin-right: 8px;"></span>
                    <span id="thinking-text" style="color: #a1a1aa; font-style: italic;">...</span>
                </div>
            `;
        }
        
        function addThinkingStep(type, content, extra = {}) {
            const textEl = document.getElementById('thinking-text');
            if (!textEl) return;
            
            // Just update the text - simple inline display
            textEl.textContent = content;
            
            // Keep for compatibility but simplified
            let icon = 'ðŸ’­';
            let iconClass = 'thinking';
            
            switch(type) {
                case 'thinking':
                    icon = 'ðŸ’­';
                    iconClass = 'thinking';
                    break;
                case 'tool_call':
                    icon = 'ðŸ”§';
                    iconClass = 'tool';
                    break;
                case 'tool_result':
                    icon = extra.success ? 'âœ…' : 'âŒ';
                    iconClass = extra.success ? 'success' : 'error';
                    break;
                case 'source':
                    icon = 'ðŸ“š';
                    iconClass = 'source';
                    break;
                case 'error':
                    icon = 'âš ï¸';
                    iconClass = 'error';
                    break;
            }
            
            const stepHTML = `
                <div class="thinking-step">
                    <span class="step-icon ${iconClass}">${icon}</span>
                    <span class="step-content">${content}${extra.tool ? `<span class="tool-badge">ðŸ”§ ${extra.tool}</span>` : ''}</span>
                </div>
            `;
            
            stepsContainer.innerHTML += stepHTML;
            stepsContainer.scrollTop = stepsContainer.scrollHeight;
            
            // Scroll main container too
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }
        
        function toggleThinkingSteps() {
            const steps = document.getElementById('thinking-steps');
            const toggle = document.getElementById('thinking-toggle');
            if (steps && toggle) {
                steps.classList.toggle('collapsed');
                toggle.classList.toggle('collapsed');
            }
        }
        
        function finishThinking(success = true) {
            // Simply hide/remove the thinking container
            const container = document.getElementById('thinking-container');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        async function sendMessageStreaming(message) {
            const container = document.getElementById('messages-container');
            
            // Add thinking container
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message assistant';
            thinkingDiv.id = 'streaming-msg';
            thinkingDiv.innerHTML = `
                <div class="message-avatar">${currentAgent.icon || 'ðŸ¤–'}</div>
                <div style="flex: 1;">
                    ${createThinkingContainer()}
                    <div class="message-content" id="streaming-content" style="display: none;"></div>
                </div>
            `;
            container.appendChild(thinkingDiv);
            container.scrollTop = container.scrollHeight;
            
            let fullContent = '';
            let sources = [];
            let buffer = ''; // Buffer for incomplete SSE data
            
            try {
                const response = await fetch(`${API}/api/agents/${currentAgent.id}/chat/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        message,
                        conversation_id: currentConversation?.id,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    })
                });
                
                if (!response.ok) {
                    if (response.status === 403) {
                        const data = await response.json();
                        const errorMessage = data.detail?.message || 'Access denied';
                        addThinkingStep('error', errorMessage);
                        finishThinking(false);
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    // Add to buffer and process complete lines
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.slice(6).trim();
                                if (!jsonStr) continue;
                                const data = JSON.parse(jsonStr);
                                
                                switch (data.type) {
                                    case 'thinking':
                                        addThinkingStep('thinking', data.content);
                                        break;
                                        
                                    case 'tool_call':
                                        addThinkingStep('tool_call', data.content, { tool: data.tool });
                                        break;
                                        
                                    case 'tool_result':
                                        addThinkingStep('tool_result', data.content, { 
                                            tool: data.tool, 
                                            success: data.success 
                                        });
                                        break;
                                        
                                    case 'conversation_id':
                                        currentConversation = { id: data.content };
                                        break;
                                        
                                    case 'content':
                                        fullContent += data.content;
                                        const contentDiv = document.getElementById('streaming-content');
                                        if (contentDiv) {
                                            contentDiv.style.display = 'block';
                                            contentDiv.innerHTML = formatMessage(fullContent);
                                        }
                                        container.scrollTop = container.scrollHeight;
                                        break;
                                        
                                    case 'sources':
                                        sources = data.content;
                                        break;
                                        
                                    case 'done':
                                        finishThinking(true);
                                        playNotificationSound();
                                        
                                        // Add sources if any
                                        if (sources && sources.length > 0) {
                                            const contentDiv = document.getElementById('streaming-content');
                                            if (contentDiv) {
                                                let sourcesHTML = `
                                                    <div class="sources-section">
                                                        <div class="sources-title">ðŸ“š Sources</div>
                                                        <div class="sources-list">
                                                `;
                                                sources.forEach(s => {
                                                    sourcesHTML += `
                                                        <span class="source-chip">
                                                            ${s.source}
                                                            <span class="relevance">${s.relevance}%</span>
                                                        </span>
                                                    `;
                                                });
                                                sourcesHTML += '</div></div>';
                                                contentDiv.innerHTML += sourcesHTML;
                                            }
                                        }
                                        
                                        // Reload conversations
                                        loadConversations();
                                        break;
                                        
                                    case 'error':
                                        addThinkingStep('error', data.content);
                                        finishThinking(false);
                                        break;
                                }
                            } catch (e) {
                                // Skip invalid JSON
                            }
                        }
                    }
                }
                
            } catch (e) {
                console.error('Streaming error:', e);
                addThinkingStep('error', `Connection error: ${e?.message || 'Unknown error'}. Please try again.`);
                finishThinking(false);
                // If streaming-content has no content, show error as a message
                const contentDiv = document.getElementById('streaming-content');
                if (contentDiv && !fullContent) {
                    contentDiv.style.display = 'block';
                    contentDiv.innerHTML = `<p style="color: var(--error);">Failed to get a response. Please try again.</p>`;
                }
            }
        }
        
        async function sendMessageWithFiles() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if ((!message && selectedFiles.length === 0) || !currentAgent) return;
            
            input.value = '';
            autoResize(input);
            
            // Hide welcome screen
            const welcome = document.getElementById('welcome-screen');
            if (welcome) welcome.style.display = 'none';
            
            // Show user message with file indicators
            const container = document.getElementById('messages-container');
            let fileIndicators = selectedFiles.map(f => `ðŸ“Ž ${f.name}`).join(', ');
            container.innerHTML += createMessageHTML('user', message + (fileIndicators ? `\n\n${fileIndicators}` : ''));
            
            // If files are attached, use the non-streaming endpoint
            if (selectedFiles.length > 0) {
                // Add typing indicator for file uploads
                container.innerHTML += `
                    <div class="message assistant" id="typing-msg">
                        <div class="message-avatar">${currentAgent.icon || 'ðŸ¤–'}</div>
                        <div class="message-content">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                `;
                container.scrollTop = container.scrollHeight;
                
                try {
                    const formData = new FormData();
                    formData.append('message', message);
                    if (currentConversation?.id) {
                        formData.append('conversation_id', currentConversation.id);
                    }
                    selectedFiles.forEach(file => formData.append('files', file));
                    
                    const response = await fetch(`${API}/api/agents/${currentAgent.id}/chat-with-files`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        },
                        body: formData
                    });
                    
                    // Clear selected files
                    selectedFiles = [];
                    showSelectedFiles();
                    
                    const data = await response.json();
                    document.getElementById('typing-msg')?.remove();
                    
                    if (response.status === 403) {
                        const errorMessage = data.detail?.message || data.message || 
                            'This assistant is not available for your account.';
                        container.innerHTML += createMessageHTML('assistant', `âš ï¸ ${errorMessage}`);
                        container.scrollTop = container.scrollHeight;
                        return;
                    }
                    
                    if (!response.ok) {
                        const errorMessage = data.detail?.message || data.message || 
                            'Sorry, I could not process that request.';
                        container.innerHTML += createMessageHTML('assistant', `Sorry, ${errorMessage}`);
                        container.scrollTop = container.scrollHeight;
                        return;
                    }
                    
                    if (data.conversation_id) {
                        currentConversation = { id: data.conversation_id };
                    }
                    
                    container.innerHTML += createMessageHTML('assistant', data.response || data.content || 'Sorry, I could not process that request.');
                    container.scrollTop = container.scrollHeight;
                    
                } catch (e) {
                    console.error('Failed to send message with files:', e);
                    document.getElementById('typing-msg')?.remove();
                    container.innerHTML += createMessageHTML('assistant', 'Sorry, we encountered an unexpected issue.');
                    container.scrollTop = container.scrollHeight;
                }
            } else {
                // Use streaming for regular messages (no files)
                await sendMessageStreaming(message);
            }
        }

        // Mobile menu
        function setupMobileMenu() {
            if (window.innerWidth <= 768) {
                document.getElementById('mobile-menu-btn').style.display = 'flex';
            }
            window.addEventListener('resize', () => {
                document.getElementById('mobile-menu-btn').style.display = window.innerWidth <= 768 ? 'flex' : 'none';
            });
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').classList.toggle('open');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('open');
        }

        // Close user menu on outside click
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('user-menu');
            const trigger = e.target.closest('.user-profile-trigger');
            if (!trigger && !e.target.closest('.user-menu')) {
                menu.classList.remove('open');
            }
        });

        // =============================================
        // PROFILE & SETTINGS MODALS
        // =============================================
        
        function showProfile() {
            toggleUserMenu();
            document.getElementById('profile-modal').classList.add('open');
            loadProfileData();
        }

        function hideProfile() {
            document.getElementById('profile-modal').classList.remove('open');
        }

        async function loadProfileData() {
            if (!currentUser) return;
            
            // Fetch fresh user data
            try {
                const response = await fetch(`${API}/api/security/auth/me`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (response.ok) {
                    const userData = await response.json();
                    currentUser = { ...currentUser, ...userData };
                }
            } catch (e) {
                console.log('Using cached user data');
            }
            
            const firstName = currentUser.profile?.first_name || currentUser.first_name || '';
            const lastName = currentUser.profile?.last_name || currentUser.last_name || '';
            const fullName = currentUser.full_name || `${firstName} ${lastName}`.trim() || currentUser.email;
            
            document.getElementById('profile-name-display').textContent = fullName;
            document.getElementById('profile-email-display').textContent = currentUser.email;
            document.getElementById('profile-avatar-display').textContent = fullName[0].toUpperCase();
            
            // Fill name fields
            document.getElementById('profile-first-name').value = firstName;
            document.getElementById('profile-last-name').value = lastName;
            
            // Load MFA status
            const mfaBadge = document.getElementById('mfa-status-badge');
            const mfaToggle = document.getElementById('mfa-toggle');
            const mfaInfo = currentUser.mfa || {};
            const isMfaEnabled = mfaInfo.enabled || currentUser.mfa_enabled || (currentUser.mfa_method && currentUser.mfa_method !== 'none');
            
            if (isMfaEnabled) {
                mfaBadge.textContent = 'âœ“ Enabled';
                mfaBadge.className = 'mfa-badge enabled';
                mfaToggle.classList.add('active');
            } else {
                mfaBadge.textContent = 'âœ— Disabled';
                mfaBadge.className = 'mfa-badge disabled';
                mfaToggle.classList.remove('active');
            }
        }

        async function updateProfile() {
            const firstName = document.getElementById('profile-first-name').value.trim();
            const lastName = document.getElementById('profile-last-name').value.trim();
            
            if (!currentUser || !currentUser.id) {
                alert('Please login again');
                return;
            }
            
            try {
                const response = await fetch(`${API}/api/security/users/${currentUser.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName
                    })
                });
                
                if (response.ok) {
                    // Update local state
                    currentUser.profile = { first_name: firstName, last_name: lastName };
                    currentUser.full_name = `${firstName} ${lastName}`.trim();
                    
                    // Update UI
                    document.getElementById('profile-name-display').textContent = currentUser.full_name || currentUser.email;
                    document.getElementById('profile-avatar-display').textContent = (currentUser.full_name || currentUser.email)[0].toUpperCase();
                    document.getElementById('user-name').textContent = currentUser.full_name || currentUser.email;
                    document.getElementById('user-avatar').textContent = (currentUser.full_name || currentUser.email)[0].toUpperCase();
                    
                    alert('Profile updated successfully!');
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Failed to update profile');
                }
            } catch (e) {
                console.error('Profile update error:', e);
                alert('Failed to update profile. Please try again.');
            }
        }

        function showSettings() {
            toggleUserMenu();
            document.getElementById('settings-modal').classList.add('open');
            loadThemeSettings();
            loadSoundSetting();
            loadBrandingSettingsUI();
        }

        function hideSettings() {
            document.getElementById('settings-modal').classList.remove('open');
        }

        function _getSavedTheme() {
            // Shared key across the platform
            const t = localStorage.getItem('agentforge-theme');
            if (t) return t;
            // Migrate legacy portal key (backward compatibility)
            const legacy = localStorage.getItem('enduser-theme');
            if (legacy) {
                const mapped = (legacy === 'system') ? 'dark' : legacy;
                localStorage.setItem('agentforge-theme', mapped);
                try { localStorage.removeItem('enduser-theme'); } catch (_) { /* ignore */ }
                return mapped;
            }
            return 'dark';
        }

        function loadThemeSettings() {
            const theme = _getSavedTheme();
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.theme === theme);
            });
        }

        function setTheme(theme) {
            const t = String(theme || 'dark').trim().toLowerCase();
            localStorage.setItem('agentforge-theme', t);
            applyTheme(t);
            loadThemeSettings();
        }

        function applyTheme(theme) {
            const t = String(theme || 'dark').trim().toLowerCase();
            if (!t || t === 'dark') document.documentElement.removeAttribute('data-theme');
            else document.documentElement.setAttribute('data-theme', t);
        }

        // =========== SOUND EFFECTS ===========
        let soundEnabled = localStorage.getItem('agentforge-sound') !== 'off';
        const _notifSoundCtx = { ctx: null, ready: false };

        function _ensureAudioCtx() {
            if (_notifSoundCtx.ctx) return _notifSoundCtx.ctx;
            try {
                const AC = window.AudioContext || window.webkitAudioContext;
                _notifSoundCtx.ctx = new AC();
                _notifSoundCtx.ready = true;
            } catch (_) { _notifSoundCtx.ready = false; }
            return _notifSoundCtx.ctx;
        }

        function playNotificationSound() {
            if (!soundEnabled) return;
            try {
                const ctx = _ensureAudioCtx();
                if (!ctx) return;
                // Simple pleasant two-tone chime
                const now = ctx.currentTime;
                [523.25, 659.25].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0, now + i * 0.12);
                    gain.gain.linearRampToValueAtTime(0.12, now + i * 0.12 + 0.04);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.12 + 0.35);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(now + i * 0.12);
                    osc.stop(now + i * 0.12 + 0.4);
                });
            } catch (_) { /* ignore */ }
        }

        function toggleSoundEffects() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('agentforge-sound', soundEnabled ? 'on' : 'off');
            const toggle = document.getElementById('sound-toggle');
            if (toggle) toggle.classList.toggle('active', soundEnabled);
            if (soundEnabled) playNotificationSound(); // Demo
        }

        function loadSoundSetting() {
            soundEnabled = localStorage.getItem('agentforge-sound') !== 'off';
            const toggle = document.getElementById('sound-toggle');
            if (toggle) toggle.classList.toggle('active', soundEnabled);
        }

        // Sync UI state on load (theme is applied early by theme.js)
        document.addEventListener('DOMContentLoaded', () => {
            loadThemeSettings();
            loadSoundSetting();
        });

        function _roleNames(u) {
            const roles = (u && Array.isArray(u.roles)) ? u.roles : [];
            return roles.map(r => {
                if (!r) return '';
                if (typeof r === 'string') return r;
                if (typeof r === 'object') return r.name || r.id || r.role || '';
                return String(r);
            }).map(s => String(s || '').trim().toLowerCase()).filter(Boolean);
        }

        function isOrgBrandingAdmin() {
            // Backend enforcement exists; this only controls UI visibility.
            if (!currentUser) return false;
            const roles = _roleNames(currentUser);
            if (roles.includes('super_admin') || roles.includes('admin') || roles.includes('org_admin')) return true;
            // Also check portal_access or is_admin flags from backend
            if (currentUser.portal_access === 'admin' || currentUser.is_admin === true) return true;
            return isPortalAdmin();
        }

        function _setValue(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            el.value = (value == null) ? '' : String(value);
        }

        function loadBrandingSettingsUI() {
            const section = document.getElementById('branding-settings-section');
            if (!section) return;
            if (!isOrgBrandingAdmin()) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            const b = (currentBranding && typeof currentBranding === 'object') ? currentBranding : {};
            _setValue('brand-org-name', b.name || '');
            _setValue('brand-logo-url', b.logo_url || '');
            _setValue('brand-favicon-url', b.favicon_url || '');
            _setValue('brand-primary', b.primary_color || '');
            _setValue('brand-secondary', b.secondary_color || '');
            _setValue('brand-banner-text', b.banner_text || '');
            _setValue('brand-banner-bg', b.banner_bg_color || '');
            _setValue('brand-banner-text-color', b.banner_text_color || '');
            _setValue('brand-chat-title', b.chat_welcome_title || '');
            _setValue('brand-chat-message', b.chat_welcome_message || '');
            _setValue('brand-custom-css', b.custom_css || '');

            // Sync color pickers with text inputs
            try {
                const pc = (b.primary_color || '').trim();
                const sc = (b.secondary_color || '').trim();
                if (pc && pc.startsWith('#')) document.getElementById('brand-primary-picker').value = pc;
                if (sc && sc.startsWith('#')) document.getElementById('brand-secondary-picker').value = sc;
                const bbg = (b.banner_bg_color || '').trim();
                const btc = (b.banner_text_color || '').trim();
                if (bbg && bbg.startsWith('#')) document.getElementById('brand-banner-bg-picker').value = bbg;
                if (btc && btc.startsWith('#')) document.getElementById('brand-banner-tc-picker').value = btc;
            } catch (_) { /* ignore */ }

            // Friendly defaults for banner colors
            try {
                const bannerEnabled = !!b.banner_enabled;
                const tcEl = document.getElementById('brand-banner-text-color');
                if (bannerEnabled && tcEl && !(tcEl.value || '').trim()) {
                    tcEl.value = '#FFFFFF';
                    const pick = document.getElementById('brand-banner-tc-picker');
                    if (pick) pick.value = '#FFFFFF';
                }
            } catch (_) { /* ignore */ }

            // Show logo/favicon previews
            _showBrandPreview('logo', b.logo_url || '');
            _showBrandPreview('favicon', b.favicon_url || '');

            const bannerToggle = document.getElementById('brand-banner-enabled');
            if (bannerToggle) bannerToggle.classList.toggle('active', !!b.banner_enabled);

            const status = document.getElementById('brand-save-status');
            if (status) status.textContent = '';
        }

        function _showBrandPreview(type, url) {
            const preview = document.getElementById(`brand-${type}-preview`);
            const label = document.getElementById(`brand-${type}-label`);
            if (!preview) return;
            if (url) {
                preview.src = url;
                preview.style.display = 'inline-block';
                if (label) label.innerHTML = '<strong>Uploaded</strong> â€” click to replace';
            } else {
                preview.style.display = 'none';
                if (label) label.innerHTML = `<strong>Click or drop</strong> to upload ${type}`;
            }
        }

        function handleBrandFileUpload(event, type) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) {
                showToast('File too large (max 2 MB)', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                const hiddenInput = document.getElementById(`brand-${type}-url`);
                if (hiddenInput) hiddenInput.value = dataUrl;
                _showBrandPreview(type, dataUrl);
            };
            reader.readAsDataURL(file);
        }

        function handleBrandCSSUpload(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            if (file.size > 500 * 1024) {
                showToast('CSS file too large (max 500 KB)', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const cssText = e.target.result;
                const el = document.getElementById('brand-custom-css');
                if (el) el.value = cssText;
                showToast('CSS file loaded', 'success');
            };
            reader.readAsText(file);
        }

        async function saveBrandingSettings() {
            if (!isOrgBrandingAdmin()) {
                showToast('Admin access required to update branding', 'error');
                return;
            }
            const status = document.getElementById('brand-save-status');
            if (status) status.textContent = 'Savingâ€¦';

            const payload = {
                name: (document.getElementById('brand-org-name')?.value || '').trim(),
                logo_url: (document.getElementById('brand-logo-url')?.value || '').trim(),
                favicon_url: (document.getElementById('brand-favicon-url')?.value || '').trim(),
                primary_color: (document.getElementById('brand-primary')?.value || '').trim(),
                secondary_color: (document.getElementById('brand-secondary')?.value || '').trim(),
                banner_enabled: document.getElementById('brand-banner-enabled')?.classList.contains('active') || false,
                banner_text: (document.getElementById('brand-banner-text')?.value || '').trim(),
                banner_bg_color: (document.getElementById('brand-banner-bg')?.value || '').trim(),
                banner_text_color: (document.getElementById('brand-banner-text-color')?.value || '').trim(),
                chat_welcome_title: (document.getElementById('brand-chat-title')?.value || '').trim(),
                chat_welcome_message: (document.getElementById('brand-chat-message')?.value || '').trim(),
                custom_css: (document.getElementById('brand-custom-css')?.value || '').trim()
            };

            // Normalize empty strings to null (backend stores only provided values)
            // Keep booleans as-is
            Object.keys(payload).forEach(k => {
                if (typeof payload[k] === 'boolean') return;
                if (payload[k] === '') payload[k] = null;
            });
            // If banner is enabled but text color is missing, default to white
            if (payload.banner_enabled && !payload.banner_text_color) payload.banner_text_color = '#FFFFFF';
            console.log('ðŸ“¦ Saving branding payload:', JSON.stringify(payload).substring(0, 500));

            try {
                const res = await fetch(`${API}/api/organization/branding`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(payload)
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    const msg = data?.detail || data?.message || 'Failed to update branding';
                    throw new Error(String(msg));
                }
                showToast('Branding updated', 'success');
                if (status) status.textContent = 'Saved.';
                await loadBranding();
                loadBrandingSettingsUI();
            } catch (e) {
                console.error('saveBrandingSettings error:', e);
                showToast(e?.message || 'Failed to update branding', 'error');
                if (status) status.textContent = '';
            }
        }

        async function resetBrandingSettings() {
            if (!isOrgBrandingAdmin()) return;
            try {
                if (!confirm('Reset branding to defaults for this organization?')) return;
            } catch (_) { /* ignore */ }
            const status = document.getElementById('brand-save-status');
            if (status) status.textContent = 'Resettingâ€¦';
            try {
                const res = await fetch(`${API}/api/organization/branding`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        logo_url: null,
                        favicon_url: null,
                        primary_color: null,
                        secondary_color: null,
                        banner_enabled: false,
                        banner_text: null,
                        banner_bg_color: null,
                        banner_text_color: null,
                        chat_welcome_title: null,
                        chat_welcome_message: null,
                        theme: null,
                        custom_css: null
                    })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    const msg = data?.detail || data?.message || 'Failed to reset branding';
                    throw new Error(String(msg));
                }
                showToast('Branding reset', 'success');
                if (status) status.textContent = '';
                await loadBranding();
                loadBrandingSettingsUI();
            } catch (e) {
                console.error('resetBrandingSettings error:', e);
                showToast(e?.message || 'Failed to reset branding', 'error');
                if (status) status.textContent = '';
            }
        }

        function showChangePassword() {
            document.getElementById('change-password-section').classList.remove('hidden');
        }

        function togglePasswordVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            const eyeIcon = btn.querySelector('.eye-icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                btn.classList.add('active');
                // Eye with slash (password visible)
                eyeIcon.innerHTML = `
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"></path>
                    <path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"></path>
                    <path d="M14.12 14.12a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                `;
            } else {
                input.type = 'password';
                btn.classList.remove('active');
                // Eye open (password hidden)
                eyeIcon.innerHTML = `
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                `;
            }
        }

        async function changePassword() {
            const currentPwd = document.getElementById('current-password').value;
            const newPwd = document.getElementById('new-password').value;
            const confirmPwd = document.getElementById('confirm-password').value;
            
            if (newPwd !== confirmPwd) {
                alert('New passwords do not match!');
                return;
            }
            
            if (newPwd.length < 8) {
                alert('Password must be at least 8 characters!');
                return;
            }
            
            try {
                const response = await fetch(`${API}/api/security/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        current_password: currentPwd,
                        new_password: newPwd
                    })
                });
                
                if (response.ok) {
                    alert('Password changed successfully!');
                    document.getElementById('change-password-section').classList.add('hidden');
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Failed to change password');
                }
            } catch (e) {
                alert('Failed to change password. Please try again.');
            }
        }

        async function toggleMFA() {
            const toggle = document.getElementById('mfa-toggle');
            const isEnabled = toggle.classList.contains('active');
            
            if (isEnabled) {
                // Disable MFA - need password and current MFA code
                showMFADisableModal();
            } else {
                // Enable MFA - show setup
                showMFASetup();
            }
        }

        function showMFADisableModal() {
            const content = document.getElementById('mfa-setup-content');
            document.getElementById('mfa-setup-modal').classList.add('open');
            content.innerHTML = `
                <p style="color: var(--text-secondary); margin-bottom: 16px;">
                    To disable MFA, please enter your password and current MFA code.
                </p>
                <div class="modal-form-group">
                    <label class="modal-form-label">Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="mfa-disable-password" class="modal-form-input" placeholder="Enter your password">
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('mfa-disable-password', this)">
                            <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="modal-form-group">
                    <label class="modal-form-label">Current MFA Code</label>
                    <input type="text" id="mfa-disable-code" class="modal-form-input" placeholder="Enter 6-digit code" maxlength="6">
                </div>
                <button class="modal-btn modal-btn-danger" onclick="disableMFA()">Disable MFA</button>
            `;
        }

        async function disableMFA() {
            const password = document.getElementById('mfa-disable-password').value;
            const code = document.getElementById('mfa-disable-code').value;
            
            if (!password || !code) {
                alert('Please enter both password and MFA code');
                return;
            }
            
            try {
                const response = await fetch(`${API}/api/security/mfa/disable`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({ password, code })
                });
                
                if (response.ok) {
                    alert('MFA disabled successfully');
                    hideMFASetup();
                    document.getElementById('mfa-toggle').classList.remove('active');
                    document.getElementById('mfa-status-badge').textContent = 'âœ— Disabled';
                    document.getElementById('mfa-status-badge').className = 'mfa-badge disabled';
                    currentUser.mfa_enabled = false;
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Failed to disable MFA. Check your password and code.');
                }
            } catch (e) {
                alert('Failed to disable MFA. Please try again.');
            }
        }

        function showMFASetup() {
            document.getElementById('mfa-setup-modal').classList.add('open');
            // Reset to method selection
            const content = document.getElementById('mfa-setup-content');
            content.innerHTML = `
                <p style="color: var(--text-secondary); margin-bottom: 16px;">
                    Select a method and click "Setup" to begin.
                </p>
                <button class="modal-btn modal-btn-primary" onclick="requestMFASetup()">Setup MFA</button>
            `;
        }

        function hideMFASetup() {
            document.getElementById('mfa-setup-modal').classList.remove('open');
        }

        async function requestMFASetup() {
            const method = document.getElementById('mfa-method-select').value;
            const setupContent = document.getElementById('mfa-setup-content');
            
            setupContent.innerHTML = '<p style="color: var(--text-muted);">Setting up MFA...</p>';
            
            try {
                const response = await fetch(`${API}/api/security/mfa/enable`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({ method })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    setupContent.innerHTML = `<p style="color: var(--error);">${data.detail || 'Failed to setup MFA'}</p>`;
                    return;
                }
                
                if (method === 'email') {
                    setupContent.innerHTML = `
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">
                            A verification code has been sent to your email: <strong>${currentUser.email}</strong>
                        </p>
                        <div class="modal-form-group">
                            <label class="modal-form-label">Enter Code</label>
                            <input type="text" id="mfa-verify-code" class="modal-form-input" placeholder="Enter 6-digit code" maxlength="6" style="text-align: center; font-size: 1.5rem; letter-spacing: 8px;">
                        </div>
                        <button class="modal-btn modal-btn-primary" onclick="verifyMFA()">Verify & Enable</button>
                    `;
                } else if (method === 'totp') {
                    const qrCode = data.qr_code || data.qr_uri;
                    if (qrCode) {
                        setupContent.innerHTML = `
                            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                                Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.):
                            </p>
                            <div style="background: white; padding: 16px; border-radius: 12px; width: fit-content; margin: 16px auto;">
                                <img src="${qrCode}" style="width: 180px; height: 180px; display: block;">
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 16px; text-align: center;">
                                Or enter this code manually: <code style="background: var(--bg-hover); padding: 4px 8px; border-radius: 4px;">${data.secret || ''}</code>
                            </p>
                            <div class="modal-form-group">
                                <label class="modal-form-label">Enter Code from App</label>
                                <input type="text" id="mfa-verify-code" class="modal-form-input" placeholder="Enter 6-digit code" maxlength="6" style="text-align: center; font-size: 1.5rem; letter-spacing: 8px;">
                            </div>
                            <button class="modal-btn modal-btn-primary" onclick="verifyMFA()">Verify & Enable</button>
                        `;
                    } else {
                        setupContent.innerHTML = `<p style="color: var(--error);">Failed to generate QR code. Please try again.</p>`;
                    }
                }
            } catch (e) {
                console.error('MFA setup error:', e);
                setupContent.innerHTML = '<p style="color: var(--error);">Failed to setup MFA. Please try again.</p>';
            }
        }

        async function verifyMFA() {
            const code = document.getElementById('mfa-verify-code').value.trim();
            
            if (!code || code.length !== 6 || !/^\d+$/.test(code)) {
                alert('Please enter a valid 6-digit code');
                return;
            }
            
            try {
                const response = await fetch(`${API}/api/security/mfa/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({ code })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show backup codes if provided
                    if (data.backup_codes && data.backup_codes.length > 0) {
                        const codesHtml = data.backup_codes.map(c => `<code style="display: block; padding: 4px; margin: 2px 0;">${c}</code>`).join('');
                        document.getElementById('mfa-setup-content').innerHTML = `
                            <div style="text-align: center; color: var(--success); margin-bottom: 16px;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 8px;">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                                <h3>MFA Enabled Successfully!</h3>
                            </div>
                            <div style="background: var(--bg-dark); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                                <p style="color: var(--warning); font-weight: 600; margin-bottom: 8px;">âš ï¸ Save these backup codes!</p>
                                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">
                                    Store these in a safe place. You can use them to access your account if you lose your authenticator.
                                </p>
                                <div style="font-family: monospace; font-size: 0.9rem;">${codesHtml}</div>
                            </div>
                            <button class="modal-btn modal-btn-primary" onclick="hideMFASetup()">Done</button>
                        `;
                    } else {
                        alert('MFA enabled successfully!');
                        hideMFASetup();
                    }
                    
                    document.getElementById('mfa-toggle').classList.add('active');
                    document.getElementById('mfa-status-badge').textContent = 'âœ“ Enabled';
                    document.getElementById('mfa-status-badge').className = 'mfa-badge enabled';
                    currentUser.mfa_enabled = true;
                } else {
                    alert(data.detail || 'Invalid code. Please try again.');
                }
            } catch (e) {
                console.error('MFA verification error:', e);
                alert('Verification failed. Please try again.');
            }
        }

        // Load organization branding
        async function loadBranding() {
            try {
                const response = await fetch(`${API}/api/organization/branding`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                if (response.ok) {
                    const branding = await response.json();
                    currentBranding = branding;
                    applyBranding(branding);
                }
            } catch (e) {
                console.log('No custom branding');
            }
        }

        function applyBranding(branding) {
            if (!branding || typeof branding !== 'object') return;

            const brandName = branding.name ? String(branding.name).trim() : '';
            const logoUrl = branding.logo_url ? String(branding.logo_url).trim() : '';
            const faviconUrl = branding.favicon_url ? String(branding.favicon_url).trim() : '';
            const theme = branding.theme ? String(branding.theme).trim().toLowerCase() : '';
            const primary = branding.primary_color ? String(branding.primary_color).trim() : '';
            const secondary = branding.secondary_color ? String(branding.secondary_color).trim() : '';
            const customCss = branding.custom_css ? String(branding.custom_css) : '';

            // Apply org name
            if (brandName) {
                const nameEl = document.querySelector('.logo span');
                if (nameEl) nameEl.textContent = brandName;
                try { document.title = `${brandName} - Portal`; } catch (_) { /* ignore */ }
            }

            // Apply favicon
            if (faviconUrl) {
                let iconLink = document.querySelector('link[rel="icon"]');
                if (!iconLink) {
                    iconLink = document.createElement('link');
                    iconLink.rel = 'icon';
                    document.head.appendChild(iconLink);
                }
                iconLink.href = faviconUrl;
            }

            // Apply logo (sidebar)
            if (logoUrl) {
                const logoIcon = document.querySelector('.logo-icon');
                if (logoIcon) {
                    logoIcon.innerHTML = `<img src="${logoUrl}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">`;
                }
            }

            // Apply theme (org-configurable)
            if (theme) {
                localStorage.setItem('agentforge-theme', theme);
                applyTheme(theme);
                loadThemeSettings();
            }

            // Apply colors (org-configurable)
            if (primary) {
                document.documentElement.style.setProperty('--accent-primary', primary);
                document.documentElement.style.setProperty('--primary', primary);
                document.documentElement.style.setProperty('--input-border-focus', primary);
            }
            if (secondary) {
                document.documentElement.style.setProperty('--accent-secondary', secondary);
            }
            if (primary || secondary) {
                const a = primary || getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim();
                const b = secondary || getComputedStyle(document.documentElement).getPropertyValue('--accent-secondary').trim() || a;
                if (a && b) document.documentElement.style.setProperty('--accent-gradient', `linear-gradient(135deg, ${a} 0%, ${b} 100%)`);
            }

            // Apply banner (thin top bar)
            // Remove existing banners to avoid duplicates when re-applying branding
            document.querySelectorAll('.org-banner').forEach(el => {
                try { el.remove(); } catch (_) { /* ignore */ }
            });
            // Default to no offset; enable only if banner is enabled
            try { document.documentElement.style.setProperty('--org-banner-height', '0px'); } catch (_) { /* ignore */ }

            if (branding.banner_enabled && branding.banner_text) {
                const banner = document.createElement('div');
                banner.className = 'org-banner';
                banner.style.background = branding.banner_bg_color || 'var(--gradient-1)';
                // Default text color to white if not provided
                banner.style.color = branding.banner_text_color || '#FFFFFF';
                banner.innerHTML = branding.banner_text;
                document.body.appendChild(banner);
                try { document.documentElement.style.setProperty('--org-banner-height', '34px'); } catch (_) { /* ignore */ }
            }

            // Apply custom CSS (org-configurable)
            if (customCss) {
                let styleEl = document.getElementById('org-custom-css');
                if (!styleEl) {
                    styleEl = document.createElement('style');
                    styleEl.id = 'org-custom-css';
                    document.head.appendChild(styleEl);
                }
                styleEl.textContent = customCss;
            }

            // Apply chat welcome copy (optional)
            if (branding.chat_welcome_title) {
                const titleEl = document.querySelector('.welcome-title');
                if (titleEl) titleEl.textContent = String(branding.chat_welcome_title);
            }
            if (branding.chat_welcome_message) {
                const subEl = document.querySelector('.welcome-subtitle');
                if (subEl) subEl.textContent = String(branding.chat_welcome_message);
            }

            // Apply Home dashboard branding
            if (brandName) {
                const homeTagline = document.getElementById('home-tagline');
                if (homeTagline) homeTagline.textContent = `Your ${brandName} AI workspace â€” chat with assistants or run business processes.`;
            }
        }

        // Load branding after login
        const originalShowChatInterface = showChatInterface;
        showChatInterface = function() {
            originalShowChatInterface();
            loadBranding();
        };
    </script>

    <!-- Workflow Run Modal -->
    <div id="workflow-run-modal" class="modal-overlay" onclick="if(event.target===this)closeWorkflowRunModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="workflow-run-title">Run Workflow</h2>
                <button class="modal-close" onclick="closeWorkflowRunModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="workflow-run-desc" style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 14px;"></div>
                <div id="workflow-form-fields" style="display: flex; flex-direction: column; gap: 12px;"></div>
                <div class="modal-actions">
                    <button class="modal-btn" onclick="closeWorkflowRunModal()">Cancel</button>
                    <button class="modal-btn modal-btn-primary" id="workflow-run-btn" onclick="executeWorkflow()">Start</button>
                </div>
                <div id="workflow-run-status" style="margin-top: 12px; color: var(--text-muted); font-size: 0.85rem;"></div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal-overlay" onclick="if(event.target===this)hideProfile()">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Profile</h2>
                <button class="modal-close" onclick="hideProfile()">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="profile-header">
                    <div class="profile-avatar-large" id="profile-avatar-display">U</div>
                    <div class="profile-info">
                        <h3 id="profile-name-display">User Name</h3>
                        <p id="profile-email-display">user@example.com</p>
                    </div>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Personal Information</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="modal-form-group" style="margin-bottom: 0;">
                            <label class="modal-form-label">First Name</label>
                            <input type="text" id="profile-first-name" class="modal-form-input" placeholder="First name">
                        </div>
                        <div class="modal-form-group" style="margin-bottom: 0;">
                            <label class="modal-form-label">Last Name</label>
                            <input type="text" id="profile-last-name" class="modal-form-input" placeholder="Last name">
                        </div>
                    </div>
                    <button class="modal-btn modal-btn-primary" style="margin-top: 16px;" onclick="updateProfile()">Save Changes</button>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Security</div>
                    
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Two-Factor Authentication</div>
                            <div class="setting-desc">Add an extra layer of security</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="mfa-status-badge" class="mfa-badge disabled">âœ— Disabled</span>
                            <div id="mfa-toggle" class="toggle" onclick="toggleMFA()"></div>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Password</div>
                            <div class="setting-desc">Change your account password</div>
                        </div>
                        <button class="modal-btn modal-btn-secondary" onclick="showChangePassword()">Change</button>
                    </div>
                </div>

                <div id="change-password-section" class="modal-section hidden">
                    <div class="modal-section-title">Change Password</div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Current Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="current-password" class="modal-form-input" placeholder="Enter current password">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('current-password', this)">
                                <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">New Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="new-password" class="modal-form-input" placeholder="Enter new password">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('new-password', this)">
                                <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Confirm New Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="confirm-password" class="modal-form-input" placeholder="Confirm new password">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirm-password', this)">
                                <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button class="modal-btn modal-btn-primary" onclick="changePassword()">Update Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay" onclick="if(event.target===this)hideSettings()">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" onclick="hideSettings()">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <div class="modal-section-title">Appearance</div>
                    <div class="theme-options">
                        <div class="theme-option" data-theme="dark" onclick="setTheme('dark')">
                            <div class="theme-icon">ðŸŒ™</div>
                            <div class="theme-name">Dark</div>
                        </div>
                        <div class="theme-option" data-theme="light" onclick="setTheme('light')">
                            <div class="theme-icon">â˜€ï¸</div>
                            <div class="theme-name">Light</div>
                        </div>
                        <div class="theme-option" data-theme="ocean" onclick="setTheme('ocean')">
                            <div class="theme-icon">ðŸŒŠ</div>
                            <div class="theme-name">Ocean</div>
                        </div>
                        <div class="theme-option" data-theme="sunset" onclick="setTheme('sunset')">
                            <div class="theme-icon">ðŸŒ…</div>
                            <div class="theme-name">Sunset</div>
                        </div>
                        <div class="theme-option" data-theme="forest" onclick="setTheme('forest')">
                            <div class="theme-icon">ðŸŒ²</div>
                            <div class="theme-name">Forest</div>
                        </div>
                    </div>
                </div>

                <div class="modal-section" id="branding-settings-section" style="display:none;">
                    <div class="modal-section-title">Branding (Organization)</div>
                    <div style="color: var(--text-muted); font-size: 0.9rem; margin-top: -6px; margin-bottom: 14px;">
                        Customize the portal appearance for your organization. Changes apply to all users.
                    </div>

                    <div class="modal-form-group">
                        <label class="modal-form-label">Organization Name</label>
                        <input type="text" id="brand-org-name" class="modal-form-input" placeholder="Company name">
                    </div>

                    <!-- Logo Upload -->
                    <div class="modal-form-group">
                        <label class="modal-form-label">Logo</label>
                        <div class="brand-upload-zone" id="brand-logo-zone">
                            <input type="file" accept="image/*" onchange="handleBrandFileUpload(event, 'logo')">
                            <div class="upload-label" id="brand-logo-label">
                                <strong>Click or drop</strong> to upload logo (PNG, SVG, JPG)
                            </div>
                            <img id="brand-logo-preview" class="brand-preview" style="display:none;">
                        </div>
                        <input type="hidden" id="brand-logo-url">
                    </div>

                    <!-- Favicon Upload -->
                    <div class="modal-form-group">
                        <label class="modal-form-label">Favicon</label>
                        <div class="brand-upload-zone" id="brand-favicon-zone">
                            <input type="file" accept="image/*" onchange="handleBrandFileUpload(event, 'favicon')">
                            <div class="upload-label" id="brand-favicon-label">
                                <strong>Click or drop</strong> to upload favicon (ICO, PNG, SVG)
                            </div>
                            <img id="brand-favicon-preview" class="brand-preview" style="display:none; max-height: 32px;">
                        </div>
                        <input type="hidden" id="brand-favicon-url">
                    </div>

                    <!-- Colors -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="modal-form-group" style="margin-bottom: 0;">
                            <label class="modal-form-label">Primary Color</label>
                            <div style="display:flex; gap: 8px; align-items: center;">
                                <input type="color" id="brand-primary-picker" value="#6D5EF7" style="width:36px; height:36px; border:none; background:none; cursor:pointer; padding:0;" onchange="document.getElementById('brand-primary').value=this.value">
                                <input type="text" id="brand-primary" class="modal-form-input" placeholder="#6D5EF7" style="flex:1;" oninput="try{document.getElementById('brand-primary-picker').value=this.value}catch(_){}">
                            </div>
                        </div>
                        <div class="modal-form-group" style="margin-bottom: 0;">
                            <label class="modal-form-label">Secondary Color</label>
                            <div style="display:flex; gap: 8px; align-items: center;">
                                <input type="color" id="brand-secondary-picker" value="#00D4FF" style="width:36px; height:36px; border:none; background:none; cursor:pointer; padding:0;" onchange="document.getElementById('brand-secondary').value=this.value">
                                <input type="text" id="brand-secondary" class="modal-form-input" placeholder="#00D4FF" style="flex:1;" oninput="try{document.getElementById('brand-secondary-picker').value=this.value}catch(_){}">
                            </div>
                        </div>
                    </div>

                    <!-- Banner -->
                    <div class="modal-form-group" style="margin-top: 14px;">
                        <label class="modal-form-label">Portal Banner</label>
                        <div class="setting-item" style="margin-top: 8px;">
                            <div>
                                <div class="setting-label">Enable Banner</div>
                                <div class="setting-desc">Announcement banner at the top of the portal</div>
                            </div>
                            <div class="toggle" id="brand-banner-enabled" onclick="this.classList.toggle('active')"></div>
                        </div>
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Banner Text (HTML supported)</label>
                        <input type="text" id="brand-banner-text" class="modal-form-input" placeholder="e.g., Welcome to ACME Portal">
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="modal-form-group" style="margin-bottom: 0;">
                            <label class="modal-form-label">Banner Background</label>
                            <div style="display:flex; gap: 8px; align-items: center;">
                                <input type="color" id="brand-banner-bg-picker" value="#111827" style="width:36px; height:36px; border:none; background:none; cursor:pointer; padding:0;" onchange="document.getElementById('brand-banner-bg').value=this.value">
                                <input type="text" id="brand-banner-bg" class="modal-form-input" placeholder="#111827 or gradient" style="flex:1;">
                            </div>
                        </div>
                        <div class="modal-form-group" style="margin-bottom: 0;">
                            <label class="modal-form-label">Banner Text Color</label>
                            <div style="display:flex; gap: 8px; align-items: center;">
                                <input type="color" id="brand-banner-tc-picker" value="#FFFFFF" style="width:36px; height:36px; border:none; background:none; cursor:pointer; padding:0;" onchange="document.getElementById('brand-banner-text-color').value=this.value">
                                <input type="text" id="brand-banner-text-color" class="modal-form-input" placeholder="#FFFFFF" style="flex:1;">
                            </div>
                        </div>
                    </div>

                    <!-- Welcome Copy -->
                    <div class="modal-form-group" style="margin-top: 14px;">
                        <label class="modal-form-label">Chat Welcome Title</label>
                        <input type="text" id="brand-chat-title" class="modal-form-input" placeholder="How can I help you today?">
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-form-label">Chat Welcome Message</label>
                        <input type="text" id="brand-chat-message" class="modal-form-input" placeholder="Select an assistant and start a conversation.">
                    </div>

                    <!-- CSS: paste or upload -->
                    <div class="modal-form-group">
                        <label class="modal-form-label">Custom CSS</label>
                        <div class="brand-upload-zone" style="margin-bottom:8px;">
                            <input type="file" accept=".css,text/css" onchange="handleBrandCSSUpload(event)">
                            <div class="upload-label"><strong>Upload a .css file</strong> or paste below</div>
                        </div>
                        <textarea id="brand-custom-css" class="modal-form-input" rows="4" placeholder="/* Custom CSS overrides */"></textarea>
                    </div>

                    <div class="modal-actions" style="margin-top: 14px;">
                        <button class="modal-btn" onclick="resetBrandingSettings()">Reset to Defaults</button>
                        <button class="modal-btn modal-btn-primary" onclick="saveBrandingSettings()">Save Branding</button>
                    </div>
                    <div id="brand-save-status" style="margin-top: 10px; color: var(--text-muted); font-size: 0.85rem;"></div>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Notifications</div>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Sound Effects</div>
                            <div class="setting-desc">Play a subtle sound when new messages arrive</div>
                        </div>
                        <div class="toggle" id="sound-toggle" onclick="toggleSoundEffects()"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MFA Setup Modal -->
    <div id="mfa-setup-modal" class="modal-overlay" onclick="if(event.target===this)hideMFASetup()">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Enable Two-Factor Authentication</h2>
                <button class="modal-close" onclick="hideMFASetup()">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="modal-form-group">
                    <label class="modal-form-label">Authentication Method</label>
                    <select id="mfa-method-select" class="modal-form-input" onchange="requestMFASetup()">
                        <option value="email">Email Code</option>
                        <option value="totp">Authenticator App</option>
                    </select>
                </div>
                <div id="mfa-setup-content">
                    <!-- Dynamic content loaded here -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>


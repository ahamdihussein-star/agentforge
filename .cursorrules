# AgentForge AI Development Rules

## üö® CRITICAL - DATABASE RULES (READ FIRST!)

### Before Creating/Modifying Database Models:

1. **ALWAYS read `database/COMMON_ISSUES.md` FIRST!**
2. **NEVER use these reserved SQLAlchemy words as column names:**
   - `metadata` ‚ùå (use `extra_metadata`, `user_metadata`, or `custom_data`)
   - `registry` ‚ùå
   - `__tablename__` ‚ùå (already used)
   - `__mapper__` ‚ùå
   - `__table__` ‚ùå

3. **Search before adding:**
   ```bash
   # Check if 'metadata' exists
   grep -r "metadata = Column" database/models/
   
   # Check for ForeignKey issues
   grep -r "ForeignKey(" database/models/
   ```

4. **ForeignKey Rules:**
   - If circular dependency exists, use `use_alter=True`
   - OR temporarily remove ForeignKey constraints
   - Always check import order (dependencies first)

5. **Test locally before commit:**
   ```bash
   python database/init_db.py
   ```

## üè¢ ENTERPRISE BEST PRACTICES (MANDATORY!)

### Database-Agnostic Design:
- ‚ùå NEVER use PostgreSQL-specific types (UUID(as_uuid=True), JSONB, ARRAY, INET)
- ‚úÖ ALWAYS use database-agnostic types from `database/types.py`
- ‚úÖ Import: `from ..types import UUID, JSON, JSONArray`
- ‚úÖ Keep alias for compatibility: `JSONB = JSON`
- ‚úÖ Test imports: `python -c "from database.models import *"` before commit

### Enum Management:
- ‚ùå NEVER define enums in individual model files
- ‚úÖ ALWAYS use centralized `database/enums.py`
- ‚úÖ ALWAYS provide `.from_legacy()` method for backward compatibility
- ‚úÖ ALWAYS include 'CUSTOM' or 'OTHER' catch-all value
- ‚úÖ ALWAYS use Alembic migrations for enum changes (not direct model edits)

### Schema Changes:
- ‚ùå NEVER modify production database models directly
- ‚úÖ ALWAYS use Alembic migrations:
  ```bash
  alembic revision -m "description"
  alembic upgrade head
  ```
- ‚úÖ ALWAYS test migrations locally first
- ‚úÖ ALWAYS provide rollback path (downgrade)

### Code Organization:
- ‚úÖ Single Source of Truth: One place for business logic
- ‚úÖ DRY Principle: Don't repeat enum definitions
- ‚úÖ Type Safety: Use centralized validators
- ‚úÖ Reusability: Share enums across models, APIs, migrations

## General Development Rules

### Code Style
- Follow PEP 8
- Use type hints
- Add docstrings for all functions/classes
- Keep functions under 50 lines when possible

### Database
- Always use UTC timestamps: `datetime.utcnow()`
- Use UUID for primary keys: `UUID(as_uuid=True)`
- Add indexes for frequently queried columns
- Use `JSONB` for flexible data, not `JSON`

### Security
- Never commit API keys or secrets
- Always encrypt sensitive data
- Log all security events
- Validate all user inputs

### Testing
- Test database changes locally first
- Verify migrations don't break existing data
- Check for SQL injection vulnerabilities

## Documentation
- Update `database/COMMON_ISSUES.md` when you encounter new issues
- Keep `MASTER_DOCUMENTATION_UPDATED.md` in sync with changes
- Document breaking changes

## Git Commit Messages
- Use conventional commits format
- Reference issues when applicable
- Be descriptive but concise

